var vJ=Object.defineProperty;var UJ=(J,Z)=>{for(var Q in Z)vJ(J,Q,{get:Z[Q],enumerable:!0,configurable:!0,set:(Y)=>Z[Q]=()=>Y})};class J1{constructor(){this.packLookup={},this.packData={},this.packProcessing=!1}get defaultCompendia(){return[...game.packs.keys()].filter((J)=>J.startsWith("pf1.")||J.startsWith("pf1e-archetypes")||J.startsWith("pf-content")||J.startsWith("pf1-statblock-converter"))}async registerDefaultCompendia(){W.log("Registering default compendia..."),await this.processCompendiums(this.defaultCompendia,{bypassLock:!0})}async processCompendiums(J=[],{reset:Z=!1,bypassLock:Q=!1}={}){if(this.packProcessing&&!Q)return;if(!Array.isArray(J))J=[J];if(J.length===0)return;if(this.packProcessing=!0,this.packData&&Z)this.packData={},this.packLookup={},await this.registerDefaultCompendia();for(let Y of J){let X=await game.packs.get(Y);if(X){await X.getIndex(),X.fuzzyIndex=W.sortArrayByName([...X.index]),this.packData[Y]=X;for(let H of X.fuzzyIndex){let G=H.type,_=H.system?.subType??null;if(G==="feat"&&!_)_="feat";let z={name:H.name,uuid:H.uuid,classes:H.system?.associations?.classes??[],tags:H.system?.tags??[],subType:_};if(!this.packLookup[Y])this.packLookup[Y]={};if(!this.packLookup[Y][G])this.packLookup[Y][G]={items:[]};if(this.packLookup[Y][G].items.push(z),_){if(!(_ in this.packLookup[Y][G]))this.packLookup[Y][G][_]=[];this.packLookup[Y][G][_].push(z)}}}}this.packProcessing=!1}isKnownCompendium(J){return!!this.packLookup[J]||!1}uniquePermutations(J){let Z=new Set;if(J.length>7)return console.warn("Array too large. Not attempting.",J),!1;for(let Q=0;Q<J.length;Q=Q+1){let Y=this.uniquePermutations(J.slice(0,Q).concat(J.slice(Q+1)));if(!Y.length)Z.add([J[Q]]);else for(let X=0;X<Y.length;X=X+1)Z.add([J[Q]].concat(Y[X]))}return[...Z]}async findInCompendia(J,Z){if(!J)return;let Q;if(Z?.packs&&Z.packs.length)Q=Z.packs.flatMap((z)=>game.packs.get(z)??[]);else Q=game.packs.filter((z)=>!Z?.type||z.metadata.type==Z.type);J=J.toLocaleLowerCase();let Y,X,H=Z.itemTypes,G=[];for(let z of Q){let K=z.metadata.id,q=this.packData[K];if(!q)W.log(`Pack ${K} not found in cache. Processing...`),await this.processCompendiums(K),q=this.packData[K];for(let j of H){if(!this.packLookup[K]?.[j])continue;let F=Z.itemSubTypes??Object.keys(this.packLookup[K][j]);for(let L of F){let B=this.packLookup[K][j][L]??[];B=B.filter((O)=>{let E=O.classes?.length>0?Z.classes?.length!==void 0?O.classes.some((P)=>{try{return Z.classes.includes(pf1.utils.createTag(P))}catch(M){return console.log(`There was an error in creating a class tag for "${P}".`),console.error(M),!1}}):!0:!0,N=O.tags?.length>0&&j==="feat"&&O.subType==="racial"?Z?.race?.length>0?O.tags.some((P)=>pf1.utils.createTag(P)===Z.race):!1:!0;return E&&N}),G=G.concat(B)}}}if(G=W.sortArrayByName(G),G.length>0){if(Y=pf1.utils.binarySearch(G,J,(z,K)=>{return z.localeCompare(K.name,void 0,{ignorePunctuation:!0})}),Y>-1)X=G[Y].uuid}if(X)return X;let _=this.uniquePermutations(J.split(/[ _-]/));if(_)_=_.map((z)=>z.join(" "));else _=[null],_.push(J.split(/[ _-]/).reverse().join(" ")),_.push(J.split(/[,;] ?/).reverse().flatMap((z)=>z.split(" ")).join(" "));for(let z=1;z<_.length;z++)if(Y=pf1.utils.binarySearch(G,_[z],(K,q)=>K.localeCompare(q.name,void 0,{ignorePunctuation:!0})),Y>-1)X=G[Y].uuid;if(X)return X;return null}async searchCompendia(J,Z={}){if(!J)return null;let Q,Y={};if(Z=Object.assign({packs:[],type:"Item",itemTypes:[],itemSubTypes:null,classes:void 0},Z),!J.search)J.search=new Set;else if(typeof J.search==="string")J.search=new Set([J.search]);else if(Array.isArray(J.search))J.search=new Set(J.search);let X=J.search;if(X.add(J.name).add(J.shortName).add(J.altName).add(J.altName2),X=[...X].filter((_)=>!!_),J.item==="Scribe Scroll")console.log(Z);for(let _ of X)if(W.log(`Searching compendium for "${_}" (item: ${J.item}) in packs:`,Z.packs),Q=await this.findInCompendia(_,Z),Q)break;if(W.log(`Search Result for "${J.item}": `,Q||"<none>"),!Q)return null;Y=await fromUuid(Q);let H=Y.toObject();return H.flags.core={sourceId:Q},new Item.implementation(H)}async findEntityInCompendia(J,Z={}){if(Z.itemType)Z.itemTypes=Array.isArray(Z.itemType)?Z.itemType:[Z.itemType],delete Z.itemType;if(Z.itemSubType)Z.itemSubTypes=Array.isArray(Z.itemSubType)?Z.itemSubType:[Z.itemSubType],delete Z.itemSubType;let Q=Object.values(this.packData),Y=new Set,X=new Set,H=new Set;Q.forEach((z)=>{switch(z.metadata.package){case"pf1":Y.add(z.metadata.id);break;case"pf1e-archetypes":case"pf-content":case"pf1-statblock-converter":X.add(z.metadata.id);break;default:H.add(z.metadata.id);break}});let G=game.settings.get(window.SBC.config.modData.mod,"customCompendiums")?.split(/[,;]/g).filter((z)=>!this.packData[z])??[];return await this.processCompendiums(G),(await Promise.all([await this.searchCompendia(J,foundry.utils.mergeObject(Z,{packs:H})),await this.searchCompendia(J,foundry.utils.mergeObject(Z,{packs:X})),await this.searchCompendia(J,foundry.utils.mergeObject(Z,{packs:Y}))])).reduce((z,K)=>z||K,null)}}class u{static flagKey="ckl-roll-bonuses";static allTargets=["armorFocus","improvedArmorFocus","elementalFocus","greaterElementalFocus","mythicElementalFocus","furiousFocus","martialFocus","snakeSidewind","spellFocus","greaterSpellFocus","mythicSpellFocus","spellSpecialization","vitalStrike","improvedVitalStrike","greaterVitalStrike","weaponFocus","weaponSpecialization","greaterWeaponFocus","greaterWeaponSpecialization","mythicWeaponFocus","fighterWeaponTraining","versatilePerformance","improvedCritical","ammunition"];static flagSetup={armorFocus:{boolean:"armor-focus",module:"armor-focus"},improvedArmorFocus:{boolean:"armor-focus-improved",module:"armor-focus-improved"},weaponFocus:{boolean:"weapon-focus",module:"weapon-focus"},greaterWeaponFocus:{boolean:"weapon-focus-greater",module:"weapon-focus-greater"},mythicWeaponFocus:{boolean:"weapon-focus-mythic",module:"weapon-focus-mythic"},weaponSpecialization:{boolean:"weapon-specialization",module:"weapon-specialization"},greaterWeaponSpecialization:{boolean:"weapon-specialization-greater",module:"weapon-specialization-greater"},martialFocus:{boolean:"martial-focus",module:"martial-focus"},elementalFocus:{boolean:"elemental-focus",module:"elemental-focus"},spellFocus:{boolean:"spell-focus",module:"spell-focus"},greaterSpellFocus:{boolean:"spell-focus-greater",module:"spell-focus-greater"},mythicSpellFocus:{boolean:"spell-focus-mythic",module:"spell-focus-mythic"},spellSpecialization:{boolean:"spell-specialization",module:"spell-specialization"},furiousFocus:{boolean:"furious-focus",module:"furious-focus"},snakeSidewind:{boolean:"snake-sidewind",module:"snake-sidewind"},vitalStrike:{boolean:"vital-strike",module:"vital-strike"},improvedVitalStrike:{boolean:"vital-strike-improved",module:"vital-strike-improved"},greaterVitalStrike:{boolean:"vital-strike-greater",module:"vital-strike-greater"},mythicVitalStrike:{boolean:"vital-strike-mythic",module:"vital-strike-mythic"},devastatingStrike:{boolean:"devastating-strike",module:"devastating-strike"},improvedDevastatingStrike:{boolean:"devastating-strike-improved",module:"devastating-strike-improved"},versatilePerformance:{boolean:"versatile-performance",module:"versatile-performance"}};static targets=[];static addTarget(J){if(!u.targets.includes(J))u.targets.push(J)}static versatilePerformanceOptions={act:["blf","dis"],comedy:["blf","int"],dance:["acr","fly"],keyboard:["dip","int"],oratory:["blf","sen"],percussion:["han","int"],sing:["blf","sen"],string:["blf","dip"],wind:["dip","han"]};static favoredEnemyPlurals={aberrations:"aberration",animals:"animal",constructs:"construct",dragons:"dragon",humanoids:"humanoid","magical beasts":"magical beast","monstrous humanoids":"monstrous humanoid",oozes:"ooze",outsiders:"outsider",plants:"plant",dwarves:"dwarf",elves:"elf",giants:"giant",goblinoids:"goblinoid",gnolls:"gnoll",gnomes:"gnome",halfings:"halfling",humans:"human",orcs:"orc",reptilians:"reptilian"};static async processTargets(J){for(let Z of J)if(Z.subType==="feat"){let Q=W.parseSubtext(Z.name)[1];if(Z.name.match(/^(?!.*Greater|Mythic).*Weapon Focus/i))await u.addSpecificBonus(Z,"weaponFocus",Q);else if(Z.name.match(/^(?!.*Greater).*Weapon Focus/i))await u.addSpecificBonus(Z,"mythicWeaponFocus",Q);else if(Z.name.match(/Weapon Focus/i))await u.addSpecificBonus(Z,"greaterWeaponFocus",Q);else if(Z.name.match(/^(?!.*Greater).*Weapon Specialization/i))await u.addSpecificBonus(Z,"weaponSpecialization",Q);else if(Z.name.match(/Weapon Specialization/i))await u.addSpecificBonus(Z,"greaterWeaponSpecialization",Q);else if(Z.name.match(/^(?!.*Improved).*Armor Focus/i))await u.addSpecificBonus(Z,"armorFocus",Q);else if(Z.name.match(/Armor Focus/i))await u.addSpecificBonus(Z,"improvedArmorFocus",Q);else if(Z.name.match(/^(?!.*Greater|Mythic).*Elemental Focus/i))await u.addSpecificBonus(Z,"elementalFocus",Q);else if(Z.name.match(/^(?!.*Greater).*Elemental Focus/i))await u.addSpecificBonus(Z,"mythicElementalFocus",Q);else if(Z.name.match(/Elemental Focus/i))await u.addSpecificBonus(Z,"greaterElementalFocus",Q);else if(Z.name.match(/Martial Focus/i))await u.addSpecificBonus(Z,"martialFocus",Q);else if(Z.name.match(/^(?!.*Greater|Mythic).*Spell Focus/i))await u.addSpecificBonus(Z,"spellFocus",Q);else if(Z.name.match(/^(?!.*Greater).*Spell Focus/i))await u.addSpecificBonus(Z,"mythicSpellFocus",Q);else if(Z.name.match(/Spell Focus/i))await u.addSpecificBonus(Z,"greaterSpellFocus",Q);else if(Z.name.match(/^(?!.*Greater).*Spell Specialization/i))await u.addSpecificBonus(Z,"spellSpecialization",Q);else if(Z.name.match(/Furious Focus/i))await u.addSpecificBoolean(Z,"furiousFocus");else if(Z.name.match(/Snake Sidewind/i))await u.addSpecificBoolean(Z,"snakeSidewind");else if(Z.name.match(/Improved Critical/i))await u.addImprovedCritical(Z,Q);else if(Z.name.match(/^(?!.*Greater|Improved|Mythic).*Vital Strike/i))await u.addSpecificBoolean(Z,"vitalStrike");else if(Z.name.match(/^(?!.*Greater|Mythic).*Vital Strike/i))await u.addSpecificBoolean(Z,"improvedVitalStrike");else if(Z.name.match(/^(?!.*Mythic).*Vital Strike/i))await u.addSpecificBoolean(Z,"greaterVitalStrike");else if(Z.name.match(/Vital Strike/i))await u.addSpecificBoolean(Z,"mythicVitalStrike");else if(Z.name.match(/^(?!.*Improved).*Devastating Strike/i))await u.addSpecificBoolean(Z,"devastatingStrike");else if(Z.name.match(/Devastating Strike/i))await u.addSpecificBoolean(Z,"improvedDevastatingStrike")}else if(Z.subType==="classFeat"){let Q=W.parseSubtext(Z.name)[1];if(Z.name.match(/Versatile Performance/i)&&Q)await u.addVersatilePerformance(Z,Q.toLowerCase());else if(Z.name.match(/Weapon Training/i)&&Q)await u.addWeaponTraining(Z,Q);else if(Z.name.match(/Favored Enemy/i)&&Q)await u.addFavoredEnemy(Z,Q);else if(Z.name.match(/Favored Terrain/i)&&Q);}else if(Z.system.subType==="ammo")await u.addAmmoProperties(Z)}static async addAmmoProperties(J){let Z={},Q=J.name.toLowerCase(),[Y,X]=W.extractCreatureTypeInfo(Q),H=[];if(J.name.match(/bane/i))Object.assign(Z,{"ammo-bane-creature-type":[Y],"ammo-bane-creature-subtype":X?[X]:[]});let _=Q.match(/\+[12345]/)?.[0]||0;if(_)Object.assign(Z,{"ammo-enhancement":`${_.replace("+","")}`});if(Q.match(/flaming/i)){if(H.push({formula:"1d6[Flaming]",types:["fire"],crit:"nonCrit"}),Q.match(/flaming burst/i))H.push({formula:"1d10[Flaming Burst]",types:["fire"],crit:"crit"})}if(Q.match(/frost/i)){if(H.push({formula:"1d6[Frost]",types:["cold"],crit:"nonCrit"}),Q.match(/icy burst/i))H.push({formula:"1d10[Icy Burst]",types:["cold"],crit:"crit"})}if(Q.match(/shock/i)){if(H.push({formula:"1d6[Shock]",types:["electricit"],crit:"nonCrit"}),Q.match(/shocking burst/i))H.push({formula:"1d10[Shocking Burst]",types:["electricit"],crit:"crit"})}if(Q.match(/corrosive/i)){if(H.push({formula:"1d6[Corrosive]",types:["acid"],crit:"nonCrit"}),Q.match(/corrosive burst/i))H.push({formula:"1d10[Corrosive Burst]",types:["acid"],crit:"crit"})}if(H.length>0)Object.assign(Z,{"ammo-damage":H});await J.update({flags:{[u.flagKey]:Z}})}static async addSpecificBonus(J,Z,Q){try{if(u.allTargets.includes(Z)){if(!Q){console.warn(`SBC: ${Z} doesn not have a valid target.`);return}await J.addItemBooleanFlag(u.flagSetup[Z].boolean),await J.setFlag(u.flagKey,u.flagSetup[Z].module,Q)}else console.warn(`SBC: ${Z} is not a valid bonus.`)}catch(Y){console.log(Y)}}static async addSpecificBoolean(J,Z){if(u.allTargets.includes(Z))await J.addItemBooleanFlag(u.flagSetup[Z].boolean);else console.warn(`SBC: ${Z} is not a valid bonus.`)}static async addImprovedCritical(J,Z){if(!Z){console.warn("SBC: Improved Critical doesn not have a valid target.");return}await J.update({system:{flags:{boolean:{bonus_crit:!0,"target_weapon-type":!0}}},flags:{[u.flagKey]:{"bonus_crit-keen":!0,"target_weapon-type":[Z]}}})}static async addVersatilePerformance(J,Z){if(!Z){console.warn("SBC: Versatile Performance doesn not have a valid target.");return}let Q=u.versatilePerformanceOptions[Z];if(Q){let Y=J.actor,X=Y.allSkills.find((H)=>H.startsWith("prf.")&&Y.getSkillInfo(H).name.toLowerCase()===Z.toLowerCase());if(!X){console.warn(`SBC: Perform (${Z}) skill could not be found.`);return}await J.addItemBooleanFlag(u.flagSetup.versatilePerformance.boolean),await J.setFlag(u.flagKey,u.flagSetup.versatilePerformance.module,[{base:X,choice1:Q[0],choice2:Q[1],expanded:""}])}}static async addWeaponTraining(J,Z){if(!Z){console.warn("SBC: Weapon Training doesn not have a valid target.");return}let Q=Z.match(/\+(\d+)/)[1],Y=Z.match(/(.*)\s\+\d+/)[1].toLowerCase().replace("heavy blades","bladesHeavy").replace("light blades","bladesLight");await J.update({system:{flags:{boolean:{bonus_attack:!0,bonus_damage:!0,"target_weapon-group":!0}}},flags:{[u.flagKey]:{bonus_attack:Q,"bonus_attack-type":"untyped",bonus_damage:[],"bonus_damage-change":[{formula:Q,type:"untyped"}],"target_weapon-group":[Y]}}})}static async addFavoredEnemy(J,Z){if(!Z){console.warn("SBC: Weapon Training doesn not have a valid target.");return}let[Q,Y]=Z.split("+").map((G)=>G.trim());Q=Q.toLowerCase();for(let[G,_]of Object.entries(u.favoredEnemyPlurals))if(Q.includes(G)){Q=Q.replace(G,_);break}let[X,H]=W.extractCreatureTypeInfo(Q);await J.update({system:{flags:{boolean:{bonus_attack:!0,bonus_damage:!0,"target_creature-type":!0,"target_creature-subtype":!0}}},flags:{[u.flagKey]:{bonus_attack:Y,"bonus_attack-type":"untyped",bonus_damage:[],"bonus_damage-change":[{formula:Y,type:"untyped"}],"target_creature-type":[X],"target_creature-subtype":H?[H]:[],target_toggle:"all"}}})}}class f{static ERRORLEVELS=Object.freeze({FATAL:Symbol("0"),ERROR:Symbol("1"),WARNING:Symbol("2"),INFO:Symbol("3")});static levels={[f.ERRORLEVELS.FATAL]:"FATAL",[f.ERRORLEVELS.ERROR]:"ERROR",[f.ERRORLEVELS.WARNING]:"WARNING",[f.ERRORLEVELS.INFO]:"INFO"};constructor(J=f.ERRORLEVELS.FATAL,Z="Default Error Keyword",Q="Default Error Message",Y=-1,X=void 0){this.level=J,this.keyword=Z,this.message=Q,this.line=Y,this.value=X}get errorLabel(){return f.levels[this.level]}}var SJ={hooves:{img:"systems/pf1/icons/items/inventory/monster-hoof.jpg",isPrimaryAttack:!1,damageTypes:"B"},tail:{img:"systems/pf1/icons/items/inventory/monster-tail.jpg",isPrimaryAttack:!1,damageTypes:"B"},other:{img:"systems/pf1/icons/items/inventory/monster-cat.jpg",isPrimaryAttack:!1,damageTypes:"P, B or S"}},B0=SJ;var xJ=["Jotund Troll","Troll"],O1=xJ;var wJ={"Agent of the Grave":{hd:8,bab:"low",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["blf","hea","int","kar","khi","kre","lin","spl","umd"],img:"systems/pf1/icons/skills/affliction_08.jpg",offset:"@classes.agentOfTheGrave.level - 1"},"Aldori Swordlord":{hd:10,bab:"high",fort:"low",ref:"high",will:"low",skillsPerLevel:2,classSkills:["acr","blf","dip","int","kno","prf","sen"],img:"systems/pf1/icons/skills/weapon_25.jpg"},"Arcane Archer":{hd:10,bab:"high",fort:"high",ref:"high",will:"low",skillsPerLevel:4,classSkills:["per","rid","ste","sur"],img:"systems/pf1/icons/skills/weapon_03.jpg",offset:"@classes.arcaneArcher.level - ceil(@classes.arcaneArcher.level / 4)",castingType:["arcane"]},"Arcane Trickster":{hd:6,bab:"low",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","blf","clm","dip","dev","dis","esc","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","per","sen","slt","spl","ste","swm"],img:"systems/pf1/icons/skills/violet_28.jpg",offset:"@classes.arcaneTrickster.level",castingType:["arcane"]},"Arclord of Nex":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["dip","lin","sen","umd"],img:"systems/pf1/icons/skills/red_09.jpg",offset:"@classes.arclordOfNex.level",castingType:["arcane"]},"Argent Dramaturge":{hd:6,bab:"low",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["blf","dip","esc","fly","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","prf","per","sen","spl","umd"],img:"systems/pf1/icons/items/inventory/lute.jpg",offset:"@classes.argentDramaturge.level"},Asavir:{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["blf","crf","han","int","kna","kre","per","rid","sen","sur"],img:"systems/pf1/icons/feats/ride-by-attack.jpg"},"Ashavic Dancer":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","dip","fly","kpl","kre","per","prf","sen","spl","sur"],img:"systems/pf1/icons/spells/wind-grasp-magenta-2.jpg",offset:"@classes.ashavicDancer.level - 1"},"Aspis Agent":{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:4,classSkills:["blf","dis","kar","khi","sen","slt","umd"],img:"systems/pf1/icons/skills/yellow_41.jpg"},Assassin:{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","blf","clm","dev","dip","dis","esc","int","lin","per","sen","slt","ste","swm","umd"],img:"systems/pf1/icons/skills/weapon_43.jpg"},"Battle Herald":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["blf","crf","dip","han","hea","int","ken","khi","klo","kno","per","prf","rid","sen"],img:"systems/pf1/icons/skills/red_05.jpg"},"Bellflower Tiller":{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:6,classSkills:["acr","blf","dip","dis","esc","hea","int","kge","klo","per","sen","slt","ste","sur"],img:"systems/pf1/icons/skills/red_06.jpg"},"Blackfire Adept":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.blackfireAdept.level - ceil(@classes.blackfireAdept.level / 4)"},Bloatmage:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.bloatmage.level",castingType:["arcane"]},Brewkeeper:{hd:8,bab:"med",fort:"high",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.brewkeeper.level - 1",castingType:["alchemy"]},"Brother of the Seal":{hd:8,bab:"med",fort:"high",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Champion of Irori":{hd:8,bab:"high",fort:"high",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Chernasardo Warden":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Crimson Templar":{hd:10,bab:"high",fort:"high",ref:"high",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Cyphermage:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.cyphermage.level",castingType:["arcane"]},"Daggermark Poisoner":{hd:8,bab:"med",fort:"high",ref:"low",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Daivrat:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.daivrat.level - 1",castingType:["arcane"]},Darechaser:{hd:10,bab:"high",fort:"high",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Dawnflower Anchorite":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.dawnflowerAnchorite.level - 1"},"Dawnflower Dissident":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.dawnflowerDissident.level",castingType:["divine"]},"Death Slayer":{hd:8,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.deathSlayer.level - ceil(@classes.deathSlayer.level / 5)"},Demoniac:{hd:8,bab:"med",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.demoniac.level - 1"},"Devoted Muse":{hd:10,bab:"high",fort:"low",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Diabolist:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.diabolist.level - 1"},"Divine Scion":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.divineScion.level",castingType:["divine"]},"Dragon Disciple":{hd:12,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.dragonDisciple.level - ceil(@classes.dragonDisciple.level / 4)",castingType:["arcane"]},Duelist:{hd:10,bab:"high",fort:"low",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Eldritch Knight":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.eldritchKnight.level - 1",castingType:["arcane"]},"Enchanting Courtesan":{hd:6,bab:"low",fort:"high",ref:"low",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.enchantingCourtesan.level - 1"},"Envoy of Balance":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.envoyOfBalance.level"},"Esoteric Knight":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"floor(@classes.esotericKnight.level / 2)",castingType:["psychic"]},Evangelist:{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Exalted:{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.exalted.level",castingType:["divine"]},Feysworn:{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.feysworn.level - 1"},"Genie Binder":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"floor(@classes.genieBinder.level / 2) + floor(@classes.genieBinder.level / 5)"},"Golden Legionnaire":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Gray Corsair":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Gray Gardener":{hd:8,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.grayGardener.level - ceil(@classes.grayGardener.level / 4)",castingType:["divine"]},"Green Faith Acolyte":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.greenFaithAcolyte.level",castingType:["divine"]},"Halfling Opportunist":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Harrower:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.harrower.level"},"Hellknight Signifer":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.hellknightSignifer.level"},Hellknight:{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Heritor Knight":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Hinterlander:{hd:10,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.hinterlander.level - 1"},"Holy Vindicator":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.holyVindicator.level - ceil(@classes.holyVindicator.level / 4)",castingType:["divine"]},"Horizon Walker":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Inheritor's Crusader":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:1,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.inheritorsCrusader.level",castingClass:["cleric","paladin"]},"Inner Sea Pirate":{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Knight of Ozem":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Lantern Bearer":{hd:10,bab:"high",fort:"high",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Lion Blade":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Living Monolith":{hd:8,bab:"med",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Loremaster:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.loremaster.level"},"Low Templar":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Magaambyan Arcanist":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.magaambyanArcanist.level",castingType:["arcane"]},"Mammoth Rider":{hd:12,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Master Chymist":{hd:10,bab:"high",fort:"high",ref:"high",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.masterChymist.level - floor(@classes.masterChymist.level / 4) - 1",castingType:["alchemy"]},"Master Spy":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Mortal Usher":{hd:8,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Mystery Cultist":{hd:8,bab:"med",fort:"low",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.mysteryCultist.level - 1"},"Mystic Theurge":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.mysticTheurge.level",castingType:["arcane","divine"]},"Nature Warden":{hd:8,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.natureWarden.level - ceil(@classes.natureWarden.level / 4)",castingType:["divine"]},"Noble Scion":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Pain Taster":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Pathfinder Chronicler":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:8,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Pathfinder Delver":{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:8,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Pathfinder Field Agent":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Pathfinder Savant":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.pathfinderSavant.level - 1"},"Pit Fighter":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Proctor:{hd:8,bab:"med",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.proctor.level - 1"},"Prophet of Kalistrade":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Pure Legion Enforcer":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Rage Prophet":{hd:10,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.rageProphet.level - (floor((@classes.rageProphet.level + 3) / 8) + floor(@classes.rageProphet.level / 8) + 1)"},"Razmiran Priest":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.razmiranPriest.level - ceil(@classes.razmiranPriest.level / 4)",castingType:["arcane"]},"Red Mantis Assassin":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Riftwarden:{hd:8,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.riftwarden.level - ceil(@classes.riftwarden.level / 4)"},Ritualist:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.ritualist.level"},"Rivethun Emissary":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.rivethunEmissary.level - ceil(@classes.rivethunEmissary.level / 4)"},"Rose Warden":{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Runeguard:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.runeguard.level - 1"},"Sacred Sentinel":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Sanguine Angel":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Scar Seeker":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"floor(@classes.scarSeeker.level / 2)"},Sentinel:{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Shadowdancer:{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Shieldmarshal:{hd:10,bab:"high",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Skyseeker:{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.skyseeker.level - ceil(@classes.skyseeker.level / 4)",castingType:["divine"]},"Sleepless Detective":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Soul Warden":{hd:8,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.soulWarden.level"},Souldrinker:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.souldrinker.level - ceil(@classes.souldrinker.level / 5)"},"Sphere Singer":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.sphereSinger.level - floor((@classes.sphereSinger.level + 7) / 8)"},"Stalwart Defender":{hd:12,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Stargazer:{hd:6,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.stargazer.level"},"Steel Falcon":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Storm Kindler":{hd:8,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.stormKindler.level - ceil(@classes.stormKindler.level / 4)"},"Student of Perfection":{hd:10,bab:"high",fort:"high",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Student of War":{hd:10,bab:"high",fort:"low",ref:"low",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Tattooed Mystic":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.tattooedMystic.level - ceil(@classes.tattooedMystic.level / 4)"},Technomancer:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.technomancer.level - 1",castingType:["arcane"]},"Thuvian Alchemist":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.thuvianAlchemist.level",castingType:["arcane"]},"Twilight Talon":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Ulfen Guard":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Umbral Court Agent":{hd:8,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.umbralCourtAgent.level - ceil(@classes.umbralCourtAgent.level / 4)"},"Veiled Illusionist":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.veiledIllusionist.level"},"Westcrown Devil":{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Winter Witch":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.winterWitch.level - 1",castingClass:["witch"]}},Q1=wJ;var IJ=["all-around vision","carrion sense","deepsight","deathwatch","dragon senses","greensight","lifesense","minesight","water sense"],P1=IJ;var fJ=["Abjurer","Conjurer","Diviner","Enchanter","Evoker","Illusionist","Necromancer","Transmuter","Universalist"],Z1=fJ;var TJ=["Apocalyptic","Aquatic","Ascendant","Authoritative","Benthic","Blissful","Bouncing","Brackish","Brisk","Burning","Centered","Cherry Blossom","Coaxing","Concussive","Conditional","Consecrate","Contagious","Contingent","Crypt","Dazing","Delayed","Disruptive","Echoing","Eclipsed","Ectoplasmic","Elemental","Empower","Empowered","Encouraging","Enlarge","Enlarged","Extend","Extended","Familiar","Fearsome","Flaring","Fleeting","Focused","Furious","Heighten","Heightened","Intensified","Intuitive","Jinxed","Latent Curse","Lingering","Logical","Maximize","Maximized","Merciful","Murky","Persistent","Piercing","Quicken","Quickened","Reach","Rime","Scarring","Scouting Summons","Seeking","Selective","Shadow Grasp","Sickening","Silent","Snuffing","Solar","Solid Shadows","Stable","Steam","Still","Stilled","Studied","Stygian","Stylized","Tenacious","Tenebrous","Thanatopic","Threatening Illusion","Threnodic","Thundering","Toppling","Toxic","Traumatic","Trick","Tumultuous","Umbral","Ursurping","Vast","Verdant","Widen","Widened","Yai-Mimic"],O0=TJ;var CJ=["Black","Blue","Brown","Gray","Green","Orange","Prismatic","Red","White"],E1=CJ;var $1={};UJ($1,{Prefixes:()=>AJ,Auras:()=>V,Abilities:()=>hJ});var V=Object.freeze({Abjuration:"abj",Conjuration:"con",Divination:"div",Enchantment:"enc",Evocation:"evo",Illusion:"ill",Necromancy:"nec",Transmutation:"trs",Universal:"uni"}),AJ=["Normal","Lesser","Improved","Greater","Light","Moderate","Heavy"],hJ={Concealed:{staticCost:7500,cl:10,available:{lightWeapon:!0,oneHanded:!0},aura:V.Transmutation},Dueling:{staticCost:14000,cl:5,available:{melee:!0},aura:V.Transmutation},LesserConcealed:{staticCost:3000,cl:5,available:{lightWeapon:!0,oneHanded:!0},aura:V.Transmutation},Prehensile:{staticCost:2500,cl:7,available:{specific:"whip"},aura:V.Enchantment},Shrinking:{staticCost:1000,cl:5,available:{melee:!0},aura:V.Transmutation},Sneaky:{staticCost:5000,cl:7,available:{melee:!0},aura:V.Necromancy},Transformative:{staticCost:1e4,cl:10,available:{melee:!0},aura:V.Transmutation},Agile:{bonus:1,cl:7,available:{melee:!0},aura:V.Transmutation},Answering:{bonus:1,cl:7,available:{melee:!0},aura:V.Enchantment},BloodSong:{bonus:1,cl:6,available:{melee:!0,damageTypes:["slashing","piercing"]},aura:V.Transmutation},Countering:{bonus:1,cl:5,available:{melee:!0},aura:V.Transmutation},Courageous:{bonus:1,cl:3,available:{melee:!0},aura:V.Enchantment},DazzlingRadiance:{bonus:1,cl:7,available:{melee:!0},aura:"misc"},Deadly:{bonus:1,cl:5,available:{melee:!0,damage:["nonlethal"]},aura:V.Necromancy},Defending:{bonus:1,cl:8,available:{melee:!0},aura:V.Abjuration},Disjoining:{bonus:1,cl:7,available:{melee:!0},aura:V.Necromancy},FateStealing:{bonus:1,cl:5,available:{melee:!0},aura:V.Necromancy},Flamboyant:{bonus:1,cl:8,available:{lightWeapon:!0,oneHanded:!0,damageTypes:["piercing"]},aura:V.Transmutation},Fortuitous:{bonus:1,cl:8,available:{melee:!0},aura:V.Transmutation},Furious:{bonus:1,cl:8,available:{melee:!0},aura:V.Enchantment},GrayFlame:{bonus:1,cl:6,available:{melee:!0},aura:V.Transmutation},Grounding:{bonus:1,cl:5,available:{melee:!0},aura:V.Transmutation},Growing:{bonus:1,cl:6,available:{melee:!0},aura:V.Transmutation},Guardian:{bonus:1,cl:8,available:{melee:!0},aura:V.Abjuration},Guided:{bonus:1,cl:7,available:{weapon:!0},aura:V.Evocation},HeartSeeker:{bonus:1,cl:7,available:{melee:!0},aura:V.Necromancy},Injecting:{bonus:1,cl:5,available:{melee:!0},aura:V.Conjuration},Keen:{bonus:1,cl:10,available:{melee:!0,damage:["piercing","slashing"]},aura:V.Transmutation},KiFocus:{bonus:1,cl:8,available:{melee:!0},aura:V.Transmutation},Leveraging:{bonus:1,cl:6,available:{melee:!0},aura:V.Transmutation},Menacing:{bonus:1,cl:10,available:{melee:!0},aura:"misc"},MightyCleaving:{bonus:1,cl:8,available:{melee:!0},aura:V.Evocation},Mimetic:{bonus:1,cl:5,available:{melee:!0},aura:V.Abjuration},Neutralizing:{bonus:1,cl:5,available:{melee:!0},aura:V.Transmutation},Ominous:{bonus:1,cl:5,available:{melee:!0},aura:V.Evocation},Pitfall:{bonus:1,cl:5,available:{melee:!0},aura:V.Transmutation},Quenching:{bonus:1,cl:5,available:{melee:!0},aura:V.Transmutation},Sapping:{bonus:1,cl:5,available:{weapon:!0,damage:["nonlethal"]},aura:V.Enchantment},Seaborne:{bonus:1,cl:7,available:{melee:!0},aura:V.Transmutation},Skewering:{bonus:1,cl:5,available:{lightWeapon:!0,oneHanded:!0,damageTypes:["piercing"]},aura:V.Divination},Slithering:{bonus:1,cl:11,available:{melee:!0},aura:V.Transmutation},Smashing:{bonus:1,cl:10,available:{melee:!0,damage:["bludgeoning"]},aura:V.Conjuration},Sticky:{bonus:1,cl:8,available:{melee:!0,special:["reach"]},aura:V.Transmutation},Thawing:{bonus:1,cl:5,available:{melee:!0},aura:V.Transmutation},Throwing:{bonus:1,cl:5,available:{melee:!0},aura:V.Transmutation},Underwater:{bonus:1,cl:5,available:{melee:!0,damage:["bludgeoning","slashing"]},aura:V.Divination},Valiant:{bonus:1,cl:5,available:{melee:!0},aura:V.Divination},Vampiric:{bonus:1,cl:5,available:{melee:!0,damage:["slashing","piercing"]},aura:V.Necromancy},Vicious:{bonus:1,cl:9,available:{melee:!0},aura:V.Necromancy},Culling:{bonus:2,cl:8,available:{melee:!0,damage:["slashing"]},aura:V.Evocation},Disruption:{bonus:2,cl:14,available:{melee:!0,damage:["bludgeoning"]},aura:V.Conjuration},Furyborn:{bonus:2,cl:7,available:{melee:!0},aura:V.Enchantment},Glorious:{bonus:2,cl:5,available:{melee:!0},aura:V.Evocation},GreaterVampiric:{bonus:2,cl:8,available:{weapon:!0},aura:V.Necromancy},Harvesting:{bonus:2,cl:9,available:{melee:!0},aura:V.Necromancy},Impact:{bonus:2,cl:9,available:{oneHanded:!0,twoHanded:!0},aura:V.Transmutation},Invigorating:{bonus:2,cl:5,available:{melee:!0},aura:V.Enchantment},KiIntensifying:{bonus:2,cl:12,available:{melee:!0},aura:V.Transmutation},LegBreaker:{bonus:2,cl:7,available:{melee:!0,damage:["bludgeoning"]},aura:V.Transmutation},Liberating:{bonus:2,cl:12,available:{melee:!0},aura:V.Abjuration},LifeSurge:{bonus:2,cl:8,available:{melee:!0},aura:V.Conjuration},Negating:{bonus:2,cl:5,available:{melee:!0},aura:V.Abjuration},Obliviating:{bonus:2,cl:10,available:{melee:!0,damageTypes:["bludgeoning"]},aura:V.Enchantment},Quaking:{bonus:2,cl:6,available:{melee:!0,damageTypes:["bludgeoning"]},aura:V.Evocation},Truthful:{bonus:2,cl:11,available:{melee:!0},aura:V.Abjuration},Unseen:{bonus:2,cl:7,available:{melee:!0},aura:"misc"},Wounding:{bonus:2,cl:10,available:{melee:!0},aura:V.Evocation},Exhausting:{bonus:3,cl:12,available:{melee:!0},aura:V.Necromancy},GreaterFlamboyant:{bonus:3,cl:5,available:{lightWeapon:!0,oneHanded:!0,damageTypes:["piercing"]},aura:V.Transmutation},Nullifying:{bonus:3,cl:12,available:{melee:!0},aura:V.Abjuration},Repositioning:{bonus:3,cl:10,available:{melee:!0},aura:V.Enchantment},SpellStealing:{bonus:3,cl:13,available:{melee:!0},aura:V.Divination},Umbral:{bonus:3,cl:9,available:{melee:!0},aura:V.Evocation},Dancing:{bonus:4,cl:15,available:{melee:!0},aura:V.Transmutation},Flying:{bonus:5,cl:16,available:{melee:!0},aura:V.Transmutation},SpellSiphon:{bonus:5,cl:15,available:{melee:!0},aura:V.Transmutation},Vorpal:{bonus:5,cl:18,available:{melee:!0,damageTypes:["slashing"]},aura:"misc"},Adaptive:{staticCost:1000,cl:1,available:{specific:"composite bow"},aura:V.Transmutation},GreaterTransformative:{staticCost:15000,cl:15,available:{weapon:!0},aura:V.Transmutation},LiberatingWMH:{staticCost:7000,cl:10,available:{weapon:!0},aura:V.Abjuration},Resizing:{staticCost:4000,cl:5,available:{weapon:!0},aura:V.Transmutation},Sacrosanct:{staticCost:5000,cl:8,available:{weapon:!0},aura:V.Evocation},GreaterSniping:{staticCost:16875,cl:15,available:{ranged:!0},aura:"misc"},ImprovedSniping:{staticCost:7500,cl:10,available:{ranged:!0},aura:"misc"},NormalSniping:{staticCost:1875,cl:5,available:{ranged:!0},aura:"misc"},Ambushing:{bonus:1,cl:7,available:{ranged:!0},aura:V.Transmutation},Beaming:{bonus:1,cl:10,available:{ranged:!0},aura:V.Evocation},Conserving:{bonus:1,cl:7,available:{firearm:!0},aura:V.Conjuration},Distance:{bonus:1,cl:6,available:{ranged:!0},aura:V.Divination},Driving:{bonus:1,cl:10,available:{ranged:!0},aura:V.Evocation},Huntsman:{bonus:1,cl:7,available:{ranged:!0},aura:V.Divination},Inspired:{bonus:1,cl:7,available:{simple:!0,specific:["hand crossbow","rapier","shortbow","short sword","sword cane"]},aura:V.Enchantment},Jurist:{bonus:1,cl:4,available:{weapon:!0},aura:V.Transmutation},Lucky:{bonus:1,cl:8,available:{firearm:!0},aura:V.Transmutation},Plummeting:{bonus:1,cl:7,available:{ranged:!0},aura:V.Transmutation},Reliable:{bonus:1,cl:8,available:{firearm:!0},aura:V.Transmutation},Returning:{bonus:1,cl:7,available:{thrown:!0},aura:V.Transmutation},Sacred:{bonus:1,cl:16,available:{weapon:!0},aura:V.Transmutation},Seeking:{bonus:1,cl:12,available:{ranged:!0},aura:V.Divination},ShadowShooting:{bonus:1,cl:8,available:{ranged:!0},aura:V.Conjuration},SpellHurling:{bonus:1,cl:8,available:{thrown:!0},aura:V.Evocation},Training:{bonus:1,cl:3,available:{weapon:!0},aura:V.Transmutation},Unaligned:{bonus:1,cl:5,available:{weapon:!0},aura:V.Abjuration},Veering:{bonus:1,cl:5,available:{ranged:!0},aura:V.Evocation},Anchoring:{bonus:2,cl:10,available:{melee:!0,thrown:!0},aura:V.Transmutation},EndlessAmmunition:{bonus:2,cl:9,available:{bow:!0,crossbow:!0},aura:V.Conjuration},GlitterWake:{bonus:2,cl:12,available:{ranged:!0},aura:V.Conjuration},Potent:{bonus:2,cl:12,available:{weapon:!0},aura:V.Transmutation},Sharding:{bonus:2,cl:10,available:{melee:!0,thrown:!0},aura:V.Conjuration},Sniping:{bonus:2,cl:7,available:{ranged:!0},aura:V.Transmutation},Stalking:{bonus:2,cl:10,available:{weapon:!0},aura:V.Divination},GreaterLucky:{bonus:3,cl:12,available:{firearm:!0},aura:V.Enchantment},GreaterReliable:{bonus:3,cl:12,available:{firearm:!0},aura:V.Enchantment},Speed:{bonus:3,cl:7,available:{weapon:!0},aura:V.Transmutation},Tailwind:{bonus:3,cl:12,available:{ranged:!0},aura:V.Evocation},NimbleShot:{bonus:4,cl:11,available:{ranged:!0},aura:V.Abjuration},SecondChance:{bonus:4,cl:11,available:{bow:!0},aura:V.Abjuration},HeartPiercing:{bonus:5,cl:10,available:{ranged:!0,damageTypes:["piercing"]},aura:V.Evocation},Interfering:{bonus:5,cl:18,available:{ranged:!0},aura:V.Transmutation},DryLoad:{staticCost:1500,cl:3,available:{firearm:!0},aura:V.Abjuration},Exclusionary:{staticCost:3750,cl:1,available:{weapon:!0},aura:V.Necromancy},PhantomAmmunition:{staticCost:2000,cl:7,available:{ammunition:!0},aura:V.Transmutation},Allying:{bonus:1,cl:5,available:{weapon:!0},aura:V.Transmutation},Bane:{bonus:1,cl:8,hasSpecialTerm:!0,available:{weapon:!0},aura:V.Conjuration},Bewildering:{bonus:1,cl:7,available:{weapon:!0},aura:V.Transmutation},BloodHunting:{bonus:1,cl:8,available:{weapon:!0},aura:V.Conjuration},Breaking:{bonus:1,cl:5,available:{weapon:!0},aura:V.Evocation},Called:{bonus:1,cl:9,available:{weapon:!0},aura:V.Conjuration},Catalytic:{bonus:1,cl:12,available:{weapon:!0},aura:V.Evocation},ClusterShot:{bonus:1,cl:5,available:{ranged:!0},aura:V.Transmutation},Compassionate:{bonus:1,cl:7,available:{weapon:!0},aura:V.Conjuration},Conductive:{bonus:1,cl:8,available:{weapon:!0},aura:V.Necromancy},Confounding:{bonus:1,cl:5,available:{weapon:!0},aura:V.Transmutation},Corrosive:{bonus:1,cl:10,available:{weapon:!0},aura:V.Evocation},Cruel:{bonus:1,cl:5,available:{weapon:!0},aura:V.Necromancy},Cunning:{bonus:1,cl:6,available:{weapon:!0},aura:V.Divination},Debilitating:{bonus:1,cl:7,available:{weapon:!0},aura:V.Necromancy},Deceptive:{bonus:1,cl:9,available:{weapon:!0},aura:"misc"},Dispelling:{bonus:1,cl:10,available:{weapon:!0},aura:V.Abjuration},Distracting:{bonus:1,cl:5,available:{weapon:!0},aura:V.Enchantment},DrowScourge:{bonus:1,cl:8,available:{weapon:!0},aura:V.Conjuration},DuelingPSFG:{bonus:1,cl:7,available:{weapon:!0},aura:V.Transmutation},Fervent:{bonus:1,cl:8,available:{weapon:!0},aura:V.Conjuration},Flaming:{bonus:1,cl:10,available:{weapon:!0},aura:V.Evocation},Frost:{bonus:1,cl:8,available:{weapon:!0},aura:V.Evocation},HealersSorrow:{bonus:1,cl:5,available:{weapon:!0},aura:V.Necromancy},KinSlayer:{bonus:1,cl:8,available:{weapon:!0},aura:V.Conjuration},Limning:{bonus:1,cl:5,available:{weapon:!0},aura:V.Evocation},Merciful:{bonus:1,cl:5,available:{weapon:!0},aura:V.Conjuration},Miserable:{bonus:1,cl:8,hasSpecialTerm:!0,available:{weapon:!0},aura:V.Conjuration},MythicBane:{bonus:1,cl:8,available:{weapon:!0},aura:V.Evocation},Patriotic:{bonus:1,cl:10,available:{weapon:!0},aura:V.Conjuration},Planar:{bonus:1,cl:9,available:{weapon:!0},aura:V.Conjuration},Rusting:{bonus:1,cl:7,available:{weapon:!0},aura:V.Transmutation},Shock:{bonus:1,cl:8,available:{weapon:!0},aura:V.Evocation},SparkflyCrystalArrow:{bonus:1,cl:3,available:{ammunition:!0},aura:V.Evocation},SpiritHunting:{bonus:1,cl:8,available:{weapon:!0},aura:V.Conjuration},SummonBane:{bonus:1,cl:8,available:{weapon:!0},aura:V.Conjuration},Thundering:{bonus:1,cl:5,available:{weapon:!0},aura:V.Necromancy},Virulent:{bonus:1,cl:5,available:{weapon:!0},aura:V.Necromancy},Anarchic:{bonus:2,cl:7,available:{weapon:!0},aura:V.Evocation},Axiomatic:{bonus:2,cl:7,available:{weapon:!0},aura:V.Evocation},Burning:{bonus:2,cl:12,available:{weapon:!0},aura:V.Evocation},CorrosiveBurst:{bonus:2,cl:12,available:{weapon:!0},aura:V.Evocation},Cyclonic:{bonus:2,cl:12,available:{ranged:!0},aura:V.Conjuration},Dazzling:{bonus:2,cl:8,available:{firearm:!0},aura:V.Evocation},LesserDesignating:{bonus:2,cl:7,available:{ranged:!0},aura:V.Enchantment},DispellingBurst:{bonus:2,cl:12,available:{weapon:!0},aura:V.Abjuration},FlamingBurst:{bonus:2,cl:12,available:{weapon:!0},aura:V.Evocation},GreaterDistracting:{bonus:2,cl:8,available:{weapon:!0},aura:V.Enchantment},Heretical:{bonus:2,cl:9,available:{weapon:!0},aura:V.Evocation},Holy:{bonus:2,cl:7,available:{weapon:!0},aura:V.Evocation},IcyBurst:{bonus:2,cl:10,available:{weapon:!0},aura:V.Evocation},Igniting:{bonus:2,cl:12,available:{weapon:!0},aura:V.Evocation},Peaceful:{bonus:2,cl:8,available:{weapon:!0},aura:V.Enchantment},Penetrating:{bonus:2,cl:9,available:{ammunition:!0},aura:V.Evocation},PhaseLocking:{bonus:2,cl:7,available:{weapon:!0},aura:V.Abjuration},Planestriking:{bonus:2,cl:9,available:{weapon:!0},aura:V.Abjuration},RuneForged:{bonus:2,cl:13,available:{weapon:!0},aura:"misc"},Shattering:{bonus:2,cl:8,available:{weapon:!0},aura:V.Evocation},ShockingBurst:{bonus:2,cl:10,available:{weapon:!0},aura:V.Evocation},Silencing:{bonus:2,cl:8,available:{weapon:!0},aura:"misc"},Toxic:{bonus:2,cl:7,available:{weapon:!0},aura:V.Transmutation},Treasonous:{bonus:2,cl:12,available:{weapon:!0},aura:V.Conjuration},Unholy:{bonus:2,cl:7,available:{weapon:!0},aura:V.Evocation},Gory:{bonus:3,cl:15,available:{weapon:!0},aura:V.Necromancy},Redeemed:{bonus:3,cl:12,available:{weapon:!0},aura:"misc"},SonicBoom:{bonus:3,cl:8,available:{firearm:!0},aura:V.Evocation},BrilliantEnergy:{bonus:4,cl:16,available:{weapon:!0},aura:V.Transmutation},GreaterDesignating:{bonus:4,cl:12,available:{ranged:!0},aura:V.Enchantment},Adhesive:{staticCost:7000,cl:10,available:{armor:!0},aura:V.Transmutation},Amorphous:{staticCost:4500,cl:8,available:{armor:!0},aura:V.Transmutation},AquaDynamic:{staticCost:3750,cl:5,available:{armor:!0},aura:"misc"},BuoyantLight:{staticCost:1000,cl:5,available:{lightArmor:!0},aura:V.Transmutation},BuoyantMediumHeavy:{staticCost:2000,cl:5,available:{mediumArmor:!0,heavyArmor:!0},aura:V.Transmutation},Burdenless:{staticCost:4000,cl:5,available:{armor:!0},aura:V.Transmutation},Cloudburst:{staticCost:5000,cl:5,available:{armor:!0},aura:"misc"},Comfort:{staticCost:5000,cl:5,available:{armor:!0},aura:V.Transmutation},Corsair:{staticCost:5000,cl:5,available:{armor:!0},aura:V.Transmutation},Creeping:{staticCost:5000,cl:7,available:{armor:!0},aura:"misc"},Cushioned:{staticCost:1000,cl:1,available:{armor:!0},aura:V.Transmutation},Deceiving:{staticCost:5000,cl:7,available:{armor:!0},aura:V.Evocation},Delving:{staticCost:1e4,cl:5,available:{armor:!0},aura:V.Transmutation},Etherealness:{staticCost:49000,cl:13,available:{armor:!0},aura:V.Transmutation},Expeditious:{staticCost:4000,cl:5,available:{armor:!0},aura:V.Transmutation},Fitting:{staticCost:2000,cl:5,available:{armor:!0,shield:!0},aura:V.Transmutation},Glamered:{staticCost:2700,cl:10,available:{armor:!0},aura:"misc"},GreaterAquaDynamic:{staticCost:33750,cl:5,available:{armor:!0},aura:"misc"},GreaterShadow:{staticCost:33750,cl:15,available:{armor:!0},aura:"misc"},GreaterSlick:{staticCost:33750,cl:15,available:{armor:!0},aura:V.Conjuration},Harmonizing:{staticCost:15000,cl:7,available:{armor:!0},aura:"misc"},ImprovedAquaDynamic:{staticCost:15000,cl:5,available:{armor:!0},aura:"misc"},ImprovedShadow:{staticCost:15000,cl:10,available:{armor:!0},aura:"misc"},ImprovedSlick:{staticCost:15000,cl:10,available:{armor:!0},aura:V.Conjuration},Jousting:{staticCost:3750,cl:5,available:{armor:!0},aura:V.Transmutation},Locksmith:{staticCost:6500,cl:3,available:{lightArmor:!0},aura:V.Transmutation},Malevolent:{staticCost:5000,cl:7,available:{armor:!0},aura:V.Evocation},Martyring:{staticCost:18000,cl:9,available:{armor:!0},aura:V.Conjuration},MentalFocus:{staticCost:3000,cl:5,available:{armor:!0},aura:V.Evocation},PhaseLurching:{staticCost:9100,cl:13,available:{lightArmor:!0},aura:V.Conjuration},Putrid:{staticCost:1e4,cl:5,available:{armor:!0},aura:V.Conjuration},RadiantFlight:{staticCost:15000,cl:10,available:{heavyArmor:!0},aura:V.Transmutation},Restful:{staticCost:4500,cl:5,available:{armor:!0},aura:V.Necromancy},Righteous:{staticCost:27000,cl:10,available:{armor:!0},aura:V.Transmutation},Shadow:{staticCost:3750,cl:5,available:{armor:!0},aura:"misc"},Slick:{staticCost:3750,cl:4,available:{armor:!0},aura:V.Conjuration},SpiritBonded:{staticCost:6000,cl:9,available:{mediumArmor:!0},aura:V.Conjuration},Spiteful:{staticCost:7000,cl:7,available:{armor:!0},aura:V.Enchantment},Trackless:{staticCost:7500,cl:5,available:{armor:!0},aura:V.Transmutation},Unbound:{staticCost:27000,cl:10,available:{armor:!0},aura:V.Transmutation},Unrighteous:{staticCost:27000,cl:10,available:{armor:!0},aura:V.Transmutation},VenomEating:{staticCost:15000,cl:5,available:{armor:!0},aura:V.Transmutation},Vigilant:{staticCost:27000,cl:10,available:{armor:!0},aura:V.Transmutation},Advancing:{bonus:1,cl:5,available:{heavyArmor:!0},aura:V.Necromancy},Balanced:{bonus:1,cl:3,available:{mediumArmor:!0},aura:V.Evocation},Benevolent:{bonus:1,cl:5,available:{armor:!0},aura:V.Enchantment},Billowing:{bonus:1,cl:3,available:{armor:!0},aura:V.Conjuration},Bitter:{bonus:1,cl:5,available:{armor:!0},aura:V.Transmutation},Bolstering:{bonus:1,cl:5,available:{mediumArmor:!0,heavyArmor:!0,shield:!0},aura:V.Enchantment},Calming:{bonus:1,cl:5,available:{armor:!0},aura:V.Enchantment},Champion:{bonus:1,cl:5,available:{armor:!0},aura:V.Abjuration},Cocooning:{bonus:1,cl:9,available:{armor:!0},aura:V.Transmutation},Crusading:{bonus:1,cl:5,available:{armor:!0},aura:V.Abjuration},Dastard:{bonus:1,cl:5,available:{armor:!0},aura:V.Abjuration},Deathless:{bonus:1,cl:7,available:{armor:!0},aura:V.Abjuration},Evolving:{bonus:1,cl:7,available:{armor:!0},aura:V.Transmutation},Poisoning:{bonus:1,cl:7,available:{armor:!0},aura:V.Necromancy},Resonating:{bonus:1,cl:7,available:{armor:!0},aura:V.Abjuration},SpellStoring:{bonus:1,cl:12,available:{armor:!0},aura:V.Evocation},SpellSink:{bonus:1,cl:6,available:{armor:!0,shield:!0},aura:V.Abjuration},Stanching:{bonus:1,cl:7,available:{armor:!0},aura:V.Transmutation},TerrainStriding:{bonus:1,cl:13,available:{armor:!0},aura:V.Enchantment},TrapWarding:{bonus:1,cl:5,available:{armor:!0},aura:V.Transmutation},VouchSafing:{bonus:1,cl:9,available:{armor:!0},aura:V.Abjuration},Warding:{bonus:1,cl:12,available:{armor:!0},aura:V.Abjuration},Withstanding:{bonus:1,cl:10,available:{armor:!0},aura:V.Enchantment},Adamant:{bonus:2,cl:9,available:{heavyArmor:!0},aura:V.Conjuration},Bloodthirsty:{bonus:2,cl:7,available:{lightArmor:!0,mediumArmor:!0},aura:V.Enchantment},Frosted:{bonus:2,cl:3,available:{armor:!0,shield:!0},aura:V.Transmutation},GhostSpike:{bonus:2,cl:10,available:{armor:!0},aura:V.Evocation},Jarring:{bonus:2,cl:6,available:{armor:!0,shield:!0},aura:V.Evocation},MindButtressing:{bonus:2,cl:12,available:{mediumArmor:!0,heavyArmor:!0},aura:V.Abjuration},Phantasmal:{bonus:2,cl:7,available:{lightArmor:!0},aura:"misc"},Rampaging:{bonus:2,cl:3,available:{heavyArmor:!0},aura:"misc"},ShadowBlending:{bonus:2,cl:11,available:{armor:!0},aura:"misc"},SpellDodging:{bonus:2,cl:4,available:{armor:!0},aura:V.Abjuration},Steaming:{bonus:2,cl:3,available:{mediumArmor:!0,heavyArmor:!0},aura:V.Evocation},Volcanic:{bonus:2,cl:14,available:{heavyArmor:!0},aura:V.Evocation},ArrowCollecting:{bonus:3,cl:11,available:{mediumArmor:!0},aura:"misc"},Brawling:{bonus:3,cl:5,available:{lightArmor:!0},aura:V.Transmutation},Cotraveling:{bonus:3,cl:14,available:{armor:!0},aura:V.Conjuration},Invulnerability:{bonus:3,cl:18,available:{armor:!0},aura:"misc"},Sensing:{bonus:3,cl:14,available:{armor:!0},aura:V.Divination},Titanic:{bonus:3,cl:7,available:{armor:!0},aura:V.Transmutation},Denying:{bonus:4,cl:13,available:{armor:!0},aura:V.Abjuration},DreadWing:{bonus:5,cl:15,available:{armor:!0,specific:["full plate","hellknight plate"]},aura:V.Transmutation},Unbowed:{bonus:5,cl:9,available:{armor:!0},aura:"misc"},BuoyantShield:{staticCost:1000,cl:5,available:{shield:!0},aura:V.Transmutation},Channeling:{staticCost:18000,cl:8,available:{shield:!0},aura:V.Conjuration},Determination:{staticCost:30000,cl:10,available:{shield:!0,armor:!0},aura:V.Conjuration},EnergyResistance:{staticCost:18000,cl:3,available:{shield:!0,armor:!0},aura:V.Abjuration},GreaterEnergyResistance:{staticCost:66000,cl:11,available:{shield:!0,armor:!0},aura:V.Abjuration},Hosteling:{staticCost:7500,cl:9,available:{shield:!0,armor:!0},aura:V.Conjuration},ImprovedEnergyResistance:{staticCost:42000,cl:7,available:{shield:!0,armor:!0},aura:V.Abjuration},PoisonResistant:{staticCost:2250,cl:7,available:{shield:!0,armor:!0},aura:V.Conjuration},Radiant:{staticCost:7500,cl:6,available:{shield:!0,armor:!0},aura:V.Evocation},Rallying:{staticCost:5000,cl:5,available:{shield:!0,armor:!0},aura:V.Abjuration},UndeadControlling:{staticCost:49000,cl:13,available:{shield:!0,armor:!0},aura:V.Necromancy},WyrmsBreath:{staticCost:5000,cl:5,available:{shield:!0},aura:V.Evocation},ArrowCatching:{bonus:1,cl:8,available:{shield:!0},aura:V.Abjuration},Assiduous:{bonus:1,cl:1,available:{shield:!0},aura:"misc"},Bashing:{bonus:1,cl:8,available:{shield:!0},aura:V.Transmutation},Blinding:{bonus:1,cl:7,available:{shield:!0},aura:V.Evocation},Clangorous:{bonus:1,cl:7,available:{shield:!0,armor:!0},aura:V.Evocation},Defiant:{bonus:1,cl:8,hasSpecialTerm:!0,available:{shield:!0,armor:!0},aura:V.Conjuration},Folding:{bonus:1,cl:13,available:{shield:!0},aura:"misc"},LightFortification:{bonus:1,cl:13,available:{shield:!0,armor:!0},aura:V.Abjuration},Grinding:{bonus:1,cl:5,available:{shield:!0,armor:!0},aura:V.Transmutation},Guarding:{bonus:1,cl:8,available:{shield:!0},aura:V.Abjuration},Heraldric:{bonus:1,cl:13,available:{shield:!0},aura:V.Enchantment},Impervious:{bonus:1,cl:7,available:{shield:!0,armor:!0},aura:V.Transmutation},Mirrored:{bonus:1,cl:8,available:{shield:!0,armor:!0},aura:V.Abjuration},Ramming:{bonus:1,cl:5,available:{shield:!0},aura:V.Evocation},Rebounding:{bonus:1,cl:5,available:{shield:!0},aura:V.Abjuration},Singing:{bonus:1,cl:10,available:{shield:!0},aura:V.Evocation},Spellrending:{bonus:1,cl:9,available:{shield:!0},aura:V.Abjuration},Animated:{bonus:2,cl:12,available:{shield:!0},aura:V.Transmutation},ArrowDeflection:{bonus:2,cl:5,available:{shield:!0},aura:V.Abjuration},GreaterGuarding:{bonus:2,cl:12,available:{shield:!0},aura:V.Abjuration},Jawbreaker:{bonus:2,cl:9,available:{shield:!0},aura:V.Necromancy},Mastering:{bonus:2,cl:13,available:{shield:!0},aura:"misc"},Merging:{bonus:2,cl:10,available:{shield:!0},aura:V.Transmutation},SpellResistance13:{bonus:2,cl:15,available:{armor:!0,shield:!0},aura:V.Abjuration},Weeping:{bonus:2,cl:10,available:{shield:!0},aura:V.Enchantment},Deflecting:{bonus:3,cl:13,available:{shield:!0},aura:V.Abjuration},ModerateFortification:{bonus:3,cl:13,available:{armor:!0,shield:!0},aura:V.Abjuration},GhostTouch_:{bonus:1,cl:9,available:{weapon:!0},aura:V.Conjuration},GhostTouch:{bonus:3,cl:15,available:{armor:!0,shield:!0},aura:V.Transmutation},SpellResistance15:{bonus:3,cl:15,available:{armor:!0,shield:!0},aura:V.Abjuration},Wild:{bonus:3,cl:9,available:{armor:!0},aura:V.Transmutation},Bastion:{bonus:4,cl:15,available:{shield:!0},aura:V.Abjuration},SpellResistance17:{bonus:4,cl:15,available:{armor:!0,shield:!0},aura:V.Abjuration},HeavyFortification:{bonus:5,cl:13,available:{armor:!0,shield:!0},aura:V.Abjuration},Reflecting:{bonus:5,cl:14,available:{shield:!0},aura:V.Abjuration},SpellResistance19:{bonus:5,cl:15,available:{armor:!0,shield:!0},aura:V.Abjuration}};var gJ=["A(?:[AM]|A2|SoL|[CPR]G)","AP:?(?:CC|CoT|CotCT|JR|K|LoF|RotR|S[DS])","BotD[123]","BM","C(?:o[GS]|RB|C[TH]R|EoD)","D(?:E|ou?)G","D(?:HB|DR)","EoG","F[FG]","G(?:aM|MG|n?oG|ttRK)","H(?:uo?G|otJ|[AH])","IS(?:WG|[MPBGCR])","L(?:otLK|CoG)","M:?(?:AoS|CH?|CoGD|CotED?|CotRS|FoR|FStS|G?H|GoD|Mot(?:LG|FF)|M[MR]?|RotFQ|RPT|TotIM|WBG|WL)","NPCG","O(?:oG|LoP|[AO])","P(?:A|otIS|&P|FSG)","QGttE","R(?:G|oF)","S(?:tLC|D|oS)","T(?:EoG|G)","U(?:[CEMRIW]|SH)","(!STATISTICS)CS"],B1=gJ;var DJ=["aberration","animal","construct","dragon","fey","magical beast","monstrous humanoid","humanoid","ooze","outsider","plant","undead","vermin"],N1=DJ;var yJ=["adlet","aeon","aether","agathion","air","android","angel","aquatic","archon","astomoi","asura","augmented","azata","behemoth","blight","catfolk","changeling","chaotic","clockwork","cold","colossus","daemon","darkfolk","deepone","demodand","demon","derro","devil","div","dwarf","earth","elemental","elf","evil","extraplanar","fire","giant","gnome","goblinoid","good","gray","greatoldone","grippli","halfling","hive","human","incorporeal","inevitable","kaiju","kami","kasatha","kitsune","kyton","lawful","leshy","manasaputra","mortic","munavri","mythic","native","nightshade","oni","orc","phantom","protean","psychopomp","qlippoth","rakshasa","ratfolk","reptilian","robot","sahkil","samsaran","sasquatch","shapechanger","skinwalker","spawnofrovagug","swarm","troop","vanara","vishkanya","water","wayang","wildhunt"],M1=yJ;var dJ=["Brutally weighted","Dual-balanced","Jagged hooks?","Razor-Sharp","Serrated Edge","Tactically Adapted","Verstaille Design","Burnished","Deflecting","Double-plated","Jarring","Nimble","Razored","Slumbering","Throwing Shield","Vitalguard","With Armor Spikes?","Spiked(?! Chain(?:\b|$)| Gauntlet)"],R1=dJ;var bJ={construct:{damage:["nonlethal"],conditions:["mindAffecting","bleed","disease","deathEffects","paralyze","poison","sleep","stun","fatigue","exhausted","energyDrain"],custom:["Necromancy Effects","Effects that require a Fort. save","Ability Damage","Ability Drain","Massive Damage"]},dragon:{conditions:["paralyze","sleep"]},ooze:{damage:["precision"],condition:["mindAffecting","poison","sleep","paralyze","polymorph","stun"],custom:["Gaze Attacks","Visual Effects","Illusions","Attack forms that rely on sight","Flanking","Critical Hits"]},plant:{condition:["mindAffecting","paralyze","polymorph","poison","sleep","stun"]},undead:{damage:["nonlethal"],condition:["mindAffecting","bleed","deathEffects","disease","paralyze","poison","sleep","stun","exhausted","fatigue"],custom:["Ability Drain","Energy Drain","Damage to phys. Ability Scores","Effects that require a Fort. save","Massive Damage","Raise Dead","Reincarnate"]},vermin:{condition:["mindAffecting"]}},v1=bJ;var kJ={"sandals of elvenkind":"Boots of Elvenkind","sawtooth sabre":"Sawtoothed Sabre","resist (?:fire|cold|acid|electric(?:ity)?|sonic)":"Resist Energy","^backpack$":"Backpack, common","pale lavender ioun stone":"pale lavender ellipsoid ioun stone","robes of the archmagi":"robe of the archmagi","^ambrosia$":"Ambrosia (Vial)","^Rations \\((\\d+) days\\)$":"Trail Rations","Winter Blanket":"Blanket","spherewalker staff":"Spherewalker's Staff","coat of resistance":"Cloak of Resistance"},U1=kJ;function J0(J,Z={}){if(Z=Object.assign({pluralize:!1,matchStart:!1,matchEnd:!1,wordBoundary:!0,capture:!0,escape:!0,append:"",prepend:"",flags:"gi",appendMatch:""},Z),!Array.isArray(J))J=Object.values(J);return J=J.filter((Q,Y,X)=>X.indexOf(Q)===Y).sort((Q,Y)=>Y.length-Q.length).map((Q)=>Z.escape?Q0(Q):Q).map((Q)=>Z.appendMatch?Q+Z.appendMatch:Q).filter((Q)=>Q.length>0),new RegExp((Z.matchStart?"^":"")+Z.prepend+(Z.wordBoundary?"\\b":"")+(Z.capture?typeof Z.capture==="string"?`(?<${Z.capture}>`:"(":"(?:")+(J.length?J.join(Z.pluralize?"s?|":"|"):"_")+(Z.pluralize?"s?":"")+")"+(Z.wordBoundary?"\\b":"")+Z.append+(Z.matchEnd?"$":""),Z.flags)}function Q0(J){return J.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")}function N0(J=!0){let Z=window.SBC.config.classes.concat(window.SBC.config.prestigeClasses).concat(window.SBC.config.mythicPaths).concat(Z1);return J0(Z,{capture:"class",prepend:J?"(?<exClass>Ex-)?":"",append:J?"(\\s+of\\s+(?<deity>[a-z- ]+))?\\s*(?: \\((?<archetype>.*)\\))?\\s+(?<level>\\d+)":""})}function k1(){return J0(window.SBC.config.classes)}function m1(){return J0(window.SBC.config.prestigeClasses)}function I0(){return J0(Z1)}function u1(){return J0(window.SBC.config.mythicPaths)}function p1(){return J0(window.SBC.config.armorBonusTypes)}function Y0(J=!1){let Z=Object.values(pf1.registry.damageTypes.getLabels()).concat(Object.values(pf1.registry.materials.getLabels())).concat(Object.values(pf1.config.damageResistances));return J0(Z,J?{matchStart:!0,matchEnd:!0}:{})}function Y1(){return J0(pf1.config.conditionTypes)}function o1(){return J0(pf1.registry.conditions.getLabels())}function X1(){let J=window.SBC.config.naturalAttacks.concat(Object.keys(B0));return J0(J,{pluralize:!0,wordBoundary:!1})}function l1(){return J0(pf1.registry.materials.contents.filter((J)=>J.addon===!1).map((J)=>J.name))}function c1(){return J0(pf1.registry.materials.contents.filter((J)=>J.basic).map((J)=>J.name))}function f0(){return J0(pf1.registry.materials.contents.filter((J)=>J.addon===!1&&J.basic===!1).map((J)=>J.name))}function M0(){return J0(pf1.registry.materials.contents.filter((J)=>J.addon===!0).map((J)=>J.name))}function S1(){return J0(pf1.config.skills,{wordBoundary:!1})}function i1(){return J0(pf1.config.skills,{capture:"name",prepend:"\\+?(?<value>-?\\d*)\\s*",append:"(?<context>.*)",flags:"i",wordBoundary:!1})}function r1(){return/\d+d\d+|\d+\s?(?:hp|damage|minutes?)|[AD]C\s?\d+|\d+\s*(?:rounds)?\/(?:day|week|month|year)|at[ -]will|constant|\d+-ft|\d+\s*natural|(lesser|greater|minor|major)|[-+]?\d/i}function P0(){return/(?<uses>\d+(?!\d*,\s*))\s*(?<useTerm>.*?)?\/(?<period>day|week|month|year)/i}function n1(){let J=Object.values(pf1.config.languages).map((Z)=>Z.toLowerCase());return J0(J)}function H1(){return/(potion|wand|scroll|oil)s?\s+of\s+(.+)/i}function G1(){return J0(window.SBC.config.techColors,{append:"(?!\\s+Powder)"})}function s1(){return J0(window.SBC.config.techTiers,{escape:!1})}function a1(){return/^(Vial|Keg|Dose|Cup)s? of (.*)$/gi}function x1(){let J=Object.keys(window.SBC.config.magicalAbilities.Abilities).map((Q)=>{return Q.replace("_","").replace(/([A-Z])/g," $1").trim().replaceAll(" ","[ -]?")}),Z=window.SBC.config.magicalAbilities.Prefixes;return J0(J,{escape:!1,capture:"ability",prepend:`(?<prefix>(?:${Z.join("|")})\\s+)?`,append:`(?<postfix>(?:\\s+\\(|,\\s+)(?:${Z.join("|")})\\)?)?`})}function e1(){return J0(window.SBC.config.itemModifications,{escape:!1})}function t1(){return/(?:(?<pp>\d+)\s*pp)?\s*(?:(?<gp>\d+)\s*gp)?\s*(?:(?<sp>\d+)\s*sp)?\s*(?:(?<cp>\d+)\s*cp)?/i}function JJ(){return/\((--|S[UP]|EX)\)/i}function QJ(){return/^(?<name>.+?)\s*\((?<type>--|S[UP]|EX)\)\s*(?<description>.+?)$/i}function ZJ(){return/(?<type>Fort|Ref|Will)\s*(?<value>[+-]?\d+)/i}function R0(){return J0(pf1.config.actorSizes)}function w1(){return/\b(?:fe)?male\b/i}function _1(){return/^(Any Alignment|\\*A|[LNC][GE]|[LC]?N)\b/i}function $J(){return J0(window.SBC.config.creatureTypes)}function I1(){return new RegExp("\\b(?:"+Object.values(pf1.config.actorSizes).join("|")+")\\b\\s*\\b("+Object.values(window.SBC.config.creatureTypes).join(".*|")+")\\b","i")}function W1(){return/(?<type>Fortitude|Reflex|Will)?\s*DC\s*(?<dc>\d+)?\s*(?<effect>.*)?/i}function z1(){return/(?<formula>\d+d\d+\s*\+?\s*\d*)\s*(?<type>.*damage?)?\s*(?<effect>.*)/i}function K1(){return/(?<range>\d+).*?ft.*\s*(?<type>cone|ray|radius|diameter)/i}function YJ(){return J0(["battered","ragged and torn","tattered"],{matchStart:!0,wordBoundary:!1})}class g{constructor(J){this.app=J}get parserGroup(){return"Parser"}get parserType(){return"base"}async _parse(J,Z,Q){return!0}throwError(J,Z,Q,Y,...X){J&&window.SBC.settings.getSetting("debug")&&console.error(J);let H=W.translate(Z,{value:Q,line:Y,...X}),G=new f(f.ERRORLEVELS.ERROR,this.parserGroup,H,Y,Q);this.app.processData.errors.push(G)}logInfo(J,Z,Q,Y){let X=W.translate(J,{value:Z,line:Q,...Y}),H=new f(f.ERRORLEVELS.INFO,this.parserGroup,X,Q,Z);this.app.processData.errors.push(H)}throwParseError(J,Z,Q,Y){this.throwError(J,`parser.${this.parserType}.error`,Z,Q,Y)}async parse(J,Z,Q=void 0){try{return W.log(W.translate(`parser.${this.parserType}.status`,{value:J,line:Z,type:Q})),await this._parse(J,Z,Q)}catch(Y){return this.throwParseError(Y,J,Z,Q),!1}}splitText(J,Z=!0){let Q=[],Y=J.replace(/(\d)(,)(\d)/g,"$1$3").trim();if(Y.search(/[,;]/g)===-1)Q=Y.replace(/\)\s/,");").split(/;/);else if(Y.match(/([^,;]+\([^(]+?[,;][^(]+?\))+?/gi)===null)Q=Y.split(/[,;]/g);else{let X=Y.match(/([^,;]+\([^(]+?[,;][^(]+?\)[^,]*)+?/gi),H=Object.keys(X);for(let _=0;_<H.length;_++){let z=H[_],K=X[z].trim();if(Z){let j=/^(?<name>.*?)(?:\s\((?<parens>.*)\)(?<bonus>.*))?$/g.exec(K),{name:F,parens:L,bonus:B}=j.groups;if(["change shape","witch's familiar","hex","hexes","bardic performances","rogue talents"].includes(F.toLowerCase()))Q.push(K);else{let O=L.split(", "),E=0;for(let N=1;N<O.length;N++){let P=O[N].trim();if(!r1().test(P)){E=0;continue}let M=(O[N-++E]+`, ${P}`).replace(/,\s*,/g,",");O[N-E]=M,O[N]=""}O=O.filter((N)=>N!==""),O.forEach((N)=>{N=N.trim(),N=`${F} (${N})${B}`,Q.push(N)})}}else Q.push(K);let q=new RegExp(Q0(K),"i");Y=Y.replace(q,"").replace(/,\s*,/,",").replace(/^,/,"").trim()}let G=[];if(Y!=="")G=Y.replace(/,\s*,/,",").replace(/[;,]\s*$/,"").split(/[,;]/g);if(G.length>0){for(let _=0;_<G.length;_++)G[_]=G[_].trim();Q=G.concat(...Q)}}return Q.map((X)=>X.trim())}fixSplitGroup(J){let Z=J.reverse();return Z.map((Q,Y)=>{if(Y>0&&Z[Y-1].startsWith("+"))return`${Q} ${Z[Y-1]}`;if(!Q.startsWith("+"))return Q}).filter((Q)=>!!Q).reverse()}}class v0 extends g{async parse(J,Z,Q,Y=null,X=null,H=!0){let _=window.SBC.compendiumSearch;W.log(W.translate("parser.entity.status",{value:J,pack:Q}));let z=[];try{let K=[];if(typeof Q==="string")K.push("pf1."+Q);else Q.forEach((j)=>{K.push("pf1."+j)});let q=this.splitText(J,H);q=this.fixSplitGroup(q);for(let j=0;j<q.length;j++){let F=q[j].trim().replaceAll(/\*/g,"").trim(),L=P0().exec(F);if(L)if(F=F.replace(` ${L[0]}`,""),F.indexOf("("))F=F.replace("(",`(${L[0]}, `).replace(/,\s\)/g,")");else F+=` (${L[0]})`;if(/(?!\()\)$/.test(F))F=F.replace(/\)$/,"");if(/\((?!\))/.test(F))F+=")";if(F=F.replace(/\[/g,"(").replace(/]/g,")").replaceAll(/,\s+,/g,","),/sneak attack \+\d+d\d+ plus \d+ bleed/i.test(F))F=F.replace(/ plus \d+ bleed/i,"");let B=F.split(/\s/);if(console.log(`Looking at ${F}.`),/\+?\d+(d\d+)?/.test(B[B.length-1]))B.splice(B.length-1,1);if(Y==="feat")if(F.replace(/B$/,""),F.endsWith("M")){F=F.substring(0,F.length-1);let I=`${F} (Mythic)`;if(!q.find((r)=>r===I))q.push(I);if(q.slice(0,Math.max(0,j-1)).find((r)=>r===F))continue}else{let I=F.match(/(.*)M \((.*)\)/);if(I){F=`${I[1]} (${I[2]})`;let r=`${I[1]} (Mythic) (${I[2]})`;if(!q.find((o)=>o===r))q.push(r);if(q.slice(0,Math.max(0,j-1)).find((o)=>o===I[1]))continue}}let O=W.parseSubtext(`${F.replace(/\+*\d+$/g,"").trim()}`)[0].replace(/(\d+[ -]ft\.$)/i,"").trim(),E=`${B.join(" ").trim()}`,N=`${F.match(/\((.*)\)/)?F.match(/\((.*)\)/)[1]:""}`;if(L)E=E.replace(L[0],"").replace(/,\s*/,"").trim(),N=N.replace(L[0],"").replace(/,\s*/,"").trim();let P=N.replace(/(\+?\d+?)$/,"").trim().replace(/^(.*?action;)/i,"").trim();if(N.match(/^Mythic\) \(/i))O+=" (Mythic)";let M={search:new Set,type:Q,item:F};if(M.search=W.createSearchSet([P,N,E,F,O],!0),/channel\s*(positive|negative)\s*energy/i.test(F))M.search.add("channel energy");let R=null;if(typeof Y!=="string"){if(R=await _.findEntityInCompendia(M,{itemTypes:Y,itemSubTypes:Array.isArray(X)?X:[X],classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race}),!R)R=await _.findEntityInCompendia(M,{itemTypes:Y,itemSubTypes:["classFeat","misc"],classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race})}else R=await _.findEntityInCompendia(M,{itemType:Y,itemSubTypes:Array.isArray(X)?X:[X],classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race});let T=(R?.name||F).capitalize(),x=W.parseSubtext(F),h=x[0],w=x[1]?.replace(/^(.*?action;)/i,"").trim(),p=w?.replace(/(\+?\d+?)$/,"").trim(),d=x[1]?.match(/(?:^|,)\s*(\d+)\s*(?:,|$)/);if(d)d=d[1];else d=1;if(R!==null){if(!w)await R.updateSource({name:W.capitalize(F)});else if(w&&new RegExp(`(^${Q0(w)}|^${Q0(p)})`,"i").test(R.name)===!1||O==="weapon training")await R.updateSource({name:W.capitalize(h+(w?` (${w})`:""))});else if(w&&R.name!==W.capitalize(w)&&R.name!==W.capitalize(p))await R.updateSource({name:W.capitalize(F.trim())});if(/\*$/g.test(F))await R.updateSource({name:R.name+"*"});await W.addAssociatedClass(R,window.SBC.actor.itemTypes.class)}else{if(typeof Q==="object")switch(Q[0]){case"monster-abilities":Object.assign(M,{name:W.translate("parser.entity.placeholderSpecialAbilityName",{input:F}),type:"misc",desc:W.translate("parser.entity.placeholderSpecialAbilityDescription")});break;case"special-attacks":Object.assign(M,{name:W.translate("parser.entity.placeholderSpecialAttackName",{input:F}),type:"attack",desc:W.translate("parser.entity.placeholderSpecialAttackDescription")});break}if(M.type==="class-abilities"||M.type==="classFeat")M.type="misc";R=await W.generatePlaceholderEntity(M,Z)}if(d>1){let I=R.name;I=I.replace(/(?<![+-]\s*\d*\s*|DC\s*)\b(\d+)\b(?!\s*d\s*\d*\s*[+-])/i,"").replace(/\(\s*\)/,"").trim(),await R.updateSource({name:I})}let[a,C,e]=[null,null,T+(w?` (${w})`:"")];if(typeof Q==="string"&&(Q==="class-abilities"||Q==="monster-abilities")||typeof Q==="object"&&Q.length>0){let I=W.checkForDuplicateItem(window.SBC.actor,"feat","classFeat",e,R);if(!I)I=W.checkForDuplicateItem(window.SBC.actor,"feat",null,e,R);if(I&&!Q.includes("special-attacks")){if(w&&new RegExp(`(^${Q0(w)}|^${Q0(p)})`,"i").test(I.name)===!1||!w&&new RegExp(`(^${Q0(h)})`,"i").test(I.name)===!1)await I.update({name:W.capitalize(F)});else if(w&&w!==p&&I.name.toLowerCase()===p.toLowerCase())await I.update({name:W.capitalize(w)});C=I}else if([a,C]=await D(R),d>1)for(let r=1;r<d;r++)await D(R)}else{let I=W.checkForDuplicateItem(window.SBC.actor,Y,X,e,R);if(!I){if([a,C]=await D(R),d>1)for(let r=1;r<d;r++)await D(R)}else C=I}if(C){let I=W.parseSubtext(F);if(new RegExp(`(^${Q0(C.name)})`,"i").test(F)===!1)I[0]=C.name.replace(/^Special (.*?):/,"").trim(),I[1]="",await C.update({name:I[0]+(I[1]?` (${I[1]})`:"")});if(d>1){let U=I[1];U=U.replace(/(?<![+-]\s*\d*\s*|DC\s*)\b(\d+)\b(?!\s*d\s*\d*\s*[+-])[,)]?/i,"").replace(/\(\s*\)/,"").trim(),I[1]=U}let b=I[1],v=b?.split(/[;,]\s?/);if(v){let U={attack:null,damageFormula:null,damageType:null,damageEffect:[],saveDC:null,saveType:null,saveEffect:null,templateRange:null,templateType:null,uses:null,usesPeriod:null},S=null;if(v.forEach((k)=>{if((S=k.match(z1()))!==null&&U.damageFormula===null)U.damageFormula=S.groups.formula,U.damageType=S.groups.type?.replace(" damage","").trim(),U.damageEffect.push(S.groups.effect),b=b.replace(S[0],"").trim();else if(/([+|-]\d+)/.test(k))U.attack=k.match(/([+|-]\d+)/)[0].replace("+","");else if((S=k.match(W1()))!==null&&U.saveDC===null)U.saveDC=S.groups.dc,U.saveType=S.groups.type,U.saveEffect=S.groups.effect,b=b.replace(S[0],"").trim();else if((S=k.match(P0()))!==null)U.uses=S.groups.uses,U.usesPeriod=S.groups.period,b=b.replace(S[0],"").trim();else if((S=k.match(K1()))!==null)U.templateRange=S.groups.range,U.templateType=S.groups.type,b=b.replace(S[0],"").trim();else if(k.match(/useable/i))U.damageEffect.push(k),b=b.replace(k,"").trim()}),b=b.replace(/^\s*,|,\s*$/g,"").trim(),v=b?.split(/[;,]\s?/),v.length>0&&v[0]!=="")v=v.map((k)=>W.capitalize(k));else v=null;let t=[];if(Object.keys(U).length>0&&C.actions.size>0)await W.runParallelOps(C.actions.contents,async(k,l,c)=>{let m=C.actions.get(k.id),y={};if(U.damageEffect.length>0){let i=m.notes.effect??[];i=i.concat(U.damageEffect),y["notes.effect"]=i,b=b.replace(U.damageEffect.join(""),"").trim()}if(U.damageFormula&&m.damage.parts.length>0){let i=m.damage.parts[0].types;if(pf1.registry.damageTypes.get(U.damageType)===void 0)i.values=[],i.custom=U.damageType??"";else i.values=[U.damageType],i.custom="";if((await W.processFormula(m.damage.parts[0].formula,window.SBC.actor,C)).formula!==U.damageFormula)y["damage.parts"]=[{formula:U.damageFormula,type:i}]}if(U.attack&&["spellsave","save","heal","other"].includes(m.actionType)===!1)y.attackBonus=U.attack;if(m.save.dc){if(U.saveDC){let i=(await W.processFormula(m.save.dc,window.SBC.actor,C)).total;if(i!==U.saveDC){let $0=U.saveDC-i;if(+$0>0)y["save.dc"]=m.save.dc+` + ${+$0}`}}if(U.saveType)switch(U.saveType){case"Fortitude":y["save.type"]="fort";break;case"Reflex":y["save.type"]="ref";break;case"Will":y["save.type"]="will";break;default:y["save.type"]=null;break}if(U.saveEffect)y["save.description"]=(U.saveType?`${U.saveType} `:"")+U.saveEffect}if(U.templateRange)y["measureTemplate.size"]=U.templateRange;if(U.templateType)switch(U.templateType){case"cone":y["measureTemplate.type"]="cone";break;case"ray":y["measureTemplate.type"]="ray";break;default:y["measureTemplate.type"]="circle";break}if(Object.keys(y).length>0)await m.update(y),c.push(m)},[t]);if(await C.update({"system.actions":t}),U.uses){let k=C.system.uses.maxFormula?(await W.processFormula(C.system.uses.maxFormula,window.SBC.actor,C)).total:0;if(k!==U.uses){let l=C.system.uses.maxFormula,c=(U.uses-k).toString(),m=C.system.uses.per?C.system.uses.per:"charges";switch(m){case"round":m="round";break;case"hour":m="hour";break;case"day":m="day";break;case"week":m="week";break;default:break}let y={"system.uses.maxFormula":l?+c>0?l+` + ${+c}`:l:c,"system.uses.per":m,"system.uses.value":C.system.uses.value+ +c};if(C.actions.size===0){let $0={...new pf1.components.ItemAction().toObject(void 0,!1),name:game.i18n.localize("PF1.Use")};y["system.actions"]=[$0]}if(await C.update(y),b=b.replace(/(\d+)\/(day|week|month|year)/i,"").trim().replace(/^,|,$/g,"").trim(),v=b?.split(/[;,]\s?/)??[],v.length>0&&v[0]!=="")v=v.map((i)=>W.capitalize(i));else v=null;await C.update({name:W.capitalize(I[0])+(v?.length>0?` (${v.join(", ")})`:"")})}}}if(N.match(/^Mythic\) \(/i)){let U=N.indexOf("("),S=N.substring(U+1).replace(")","");v?.push(S)}if(d>1)if(v)v.unshift(d);else v=[d];z.push({name:I[0],kind:C.system.abilityType,description:C.system.description.value,subParts:v})}if(F.toLowerCase()==="weapon finesse"&&Q==="feats")this.app.processData.flags.hasWeaponFinesse=!0}return[!0,z]}catch(K){return this.throwError(K,"parser.entity.error",J,Z,{type:Y}),[!1,[]]}}}class X0 extends g{constructor(J,Z){super(J);if(!Z)throw Error(W.translate("parser.errors.missingArgument",{arg:"targetField"}));this.targetField=Z}async parse(J,Z){if(J===void 0)throw Error(W.translate("parser.errors.missingArgument",{arg:"value"}));if(Z===void 0)throw Error(W.translate("parser.errors.missingArgument",{arg:"line"}));W.log(W.translate("parser.notes.status",{value:J,targetField:this.targetField})),this.app.processData.notes[J]=J;try{for(let Q of this.targetField)await XJ(this.app.processData.notes,Q,J);return!0}catch(Q){return this.throwError(Q,"parser.notes.error",J,Z,{targetField:this.targetField}),!1}}}class s extends g{constructor(J,Z,Q){super(J);if(!Z)throw new Error(W.translate("parser.simple.missingArgument",{arg:"targetFields"}));if(this.targetFields=Z,!Q)throw new Error(W.translate("parser.simple.missingArgument",{arg:"supportedType"}));if(!["number","string"].includes(Q))throw new Error(W.translate("parser.simple.invalidArgumentType"));this.supportedType=Q}async parse(J,Z,Q=void 0){if(J===void 0)throw new Error(W.translate("parser.simple.missingArgument",{arg:"value"}));if(Z===void 0)throw new Error(W.translate("parser.simple.missingArgument",{arg:"line"}));if(J==="")return!1;if(W.log(W.translate("parser.simple.status",{value:J,targetFields:this.targetFields.join(", ")})),typeof J===this.supportedType||J==="NaN")try{for(let Y of this.targetFields)await F0(window.SBC.actor,Y,J==="NaN"?null:J);return!0}catch(Y){return this.throwError(Y,"parser.simple.error",J,Z,{targetFields:this.targetFields.join(", ")}),!1}else return this.throwError(void 0,"parser.simple.inputNotOfSupportedType",J,Z,{supportedType:this.supportedType}),!1}}class U0 extends g{async parse(J,Z,Q,Y=null,X=null,H=!0){let _=window.SBC.compendiumSearch;W.log(W.translate("parser.entity.status",{value:J,pack:Q}));let z=[];try{let K=[];if(typeof Q==="string")K.push("pf1."+Q);else Q.forEach((j)=>{K.push("pf1."+j)});let q=this.splitText(J,H);q=this.fixSplitGroup(q),this.processForChoices(q);for(let j=0;j<q.length;j++){let F=q[j].trim().replaceAll(/\*/g,"").trim(),L=P0().exec(F);if(L)if(F=F.replace(` ${L[0]}`,""),F.indexOf("("))F=F.replace("(",`(${L[0]}, `).replace(/,\s\)/g,")");else F+=` (${L[0]})`;if(/(?!\()\)$/.test(F))F=F.replace(/\)$/,"");if(/\((?!\))/.test(F))F+=")";if(F=F.replace(/\[/g,"(").replace(/]/g,")").replaceAll(/,\s+,/g,","),/sneak attack \+\d+d\d+ plus \d+ bleed/i.test(F))F=F.replace(/ plus \d+ bleed/i,"");let B=F.split(/\s/);if(console.log(`Looking at ${F}.`),/\+?\d+(d\d+)?/.test(B[B.length-1]))B.splice(B.length-1,1);if(Y==="feat")if(F.replace(/B$/,""),F.endsWith("M")){F=F.substring(0,F.length-1);let I=`${F} (Mythic)`;if(!q.find((r)=>r===I))q.push(I);if(q.slice(0,Math.max(0,j-1)).find((r)=>r===F))continue}else{let I=F.match(/(.*)M \((.*)\)/);if(I){F=`${I[1]} (${I[2]})`;let r=`${I[1]} (Mythic) (${I[2]})`;if(!q.find((o)=>o===r))q.push(r);if(q.slice(0,Math.max(0,j-1)).find((o)=>o===I[1]))continue}}let O=W.parseSubtext(`${F.replace(/\+*\d+$/g,"").trim()}`)[0].replace(/(\d+[ -]ft\.$)/i,"").trim(),E=`${B.join(" ").trim()}`,N=`${F.match(/\((.*)\)/)?F.match(/\((.*)\)/)[1]:""}`;if(L)E=E.replace(L[0],"").replace(/,\s*/,"").trim(),N=N.replace(L[0],"").replace(/,\s*/,"").trim();let P=N.replace(/(\+?\d+?)$/,"").trim().replace(/^(.*?action;)/i,"").trim();if(N.match(/^Mythic\) \(/i))O+=" (Mythic)";let M={search:new Set,type:Q,item:F};if(M.search=W.createSearchSet([P,N,E,F,O],!0),/channel\s*(positive|negative)\s*energy/i.test(F))M.search.add("channel energy");let R=null;if(typeof Y!=="string"){if(R=await _.findEntityInCompendia(M,{itemTypes:Y,itemSubTypes:Array.isArray(X)?X:[X],classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race}),!R)R=await _.findEntityInCompendia(M,{itemTypes:Y,itemSubTypes:["classFeat","misc"],classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race})}else R=await _.findEntityInCompendia(M,{itemType:Y,itemSubTypes:Array.isArray(X)?X:[X],classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race});let T=(R?.name||F).capitalize(),x=W.parseSubtext(F),h=x[0],w=x[1]?.replace(/^(.*?action;)/i,"").trim(),p=w?.replace(/(\+?\d+?)$/,"").trim(),d=x[1]?.match(/(?:^|,)\s*(\d+)\s*(?:,|$)/);if(d)d=d[1];else d=1;if(R!==null){if(!w)await R.updateSource({name:W.capitalize(F)});else if(w&&new RegExp(`(^${Q0(w)}|^${Q0(p)})`,"i").test(R.name)===!1||O==="weapon training")await R.updateSource({name:W.capitalize(h+(w?` (${w})`:""))});else if(w&&R.name!==W.capitalize(w)&&R.name!==W.capitalize(p))await R.updateSource({name:W.capitalize(F.trim())});if(/\*$/g.test(F))await R.updateSource({name:R.name+"*"});await W.addAssociatedClass(R,window.SBC.actor.itemTypes.class)}else{if(typeof Q==="object")switch(Q[0]){case"monster-abilities":Object.assign(M,{name:W.translate("parser.entity.placeholderSpecialAbilityName",{input:F}),type:"misc",desc:W.translate("parser.entity.placeholderSpecialAbilityDescription")});break;case"special-attacks":Object.assign(M,{name:W.translate("parser.entity.placeholderSpecialAttackName",{input:F}),type:"attack",desc:W.translate("parser.entity.placeholderSpecialAttackDescription")});break}if(M.type==="class-abilities"||M.type==="classFeat")M.type="misc";R=await W.generatePlaceholderEntity(M,Z)}if(d>1){let I=R.name;I=I.replace(/(?<![+-]\s*\d*\s*|DC\s*)\b(\d+)\b(?!\s*d\s*\d*\s*[+-])/i,"").replace(/\(\s*\)/,"").trim(),await R.updateSource({name:I})}let[a,C,e]=[null,null,T+(w?` (${w})`:"")];if(typeof Q==="string"&&(Q==="class-abilities"||Q==="monster-abilities")||typeof Q==="object"&&Q.length>0){let I=W.checkForDuplicateItem(window.SBC.actor,"feat","classFeat",e,R);if(!I)I=W.checkForDuplicateItem(window.SBC.actor,"feat",null,e,R);if(I&&!Q.includes("special-attacks")){if(w&&new RegExp(`(^${Q0(w)}|^${Q0(p)})`,"i").test(I.name)===!1||!w&&new RegExp(`(^${Q0(h)})`,"i").test(I.name)===!1)await I.update({name:W.capitalize(F)});else if(w&&w!==p&&I.name.toLowerCase()===p.toLowerCase())await I.update({name:W.capitalize(w)});C=I}else if([a,C]=await D(R),d>1)for(let r=1;r<d;r++)await D(R)}else{let I=W.checkForDuplicateItem(window.SBC.actor,Y,X,e,R);if(!I){if([a,C]=await D(R),d>1)for(let r=1;r<d;r++)await D(R)}else C=I}if(C){let I=W.parseSubtext(F);if(new RegExp(`(^${Q0(C.name)})`,"i").test(F)===!1)I[0]=C.name.replace(/^Special (.*?):/,"").trim(),I[1]="",await C.update({name:I[0]+(I[1]?` (${I[1]})`:"")});if(d>1){let U=I[1];U=U.replace(/(?<![+-]\s*\d*\s*|DC\s*)\b(\d+)\b(?!\s*d\s*\d*\s*[+-])[,)]?/i,"").replace(/\(\s*\)/,"").trim(),I[1]=U}let b=I[1],v=b?.split(/[;,]\s?/);if(v){let U={attack:null,damageFormula:null,damageType:null,damageEffect:[],saveDC:null,saveType:null,saveEffect:null,templateRange:null,templateType:null,uses:null,usesPeriod:null},S=null;if(v.forEach((k)=>{if((S=k.match(z1()))!==null&&U.damageFormula===null)U.damageFormula=S.groups.formula,U.damageType=S.groups.type?.replace(" damage","").trim(),U.damageEffect.push(S.groups.effect),b=b.replace(S[0],"").trim();else if(/([+|-]\d+)/.test(k))U.attack=k.match(/([+|-]\d+)/)[0].replace("+","");else if((S=k.match(W1()))!==null&&U.saveDC===null)U.saveDC=S.groups.dc,U.saveType=S.groups.type,U.saveEffect=S.groups.effect,b=b.replace(S[0],"").trim();else if((S=k.match(P0()))!==null)U.uses=S.groups.uses,U.usesPeriod=S.groups.period,b=b.replace(S[0],"").trim();else if((S=k.match(K1()))!==null)U.templateRange=S.groups.range,U.templateType=S.groups.type,b=b.replace(S[0],"").trim();else if(k.match(/useable/i))U.damageEffect.push(k),b=b.replace(k,"").trim()}),b=b.replace(/^\s*,|,\s*$/g,"").trim(),v=b?.split(/[;,]\s?/),v.length>0&&v[0]!=="")v=v.map((k)=>W.capitalize(k));else v=null;let t=[];if(Object.keys(U).length>0&&C.actions.size>0)await W.runParallelOps(C.actions.contents,async(k,l,c)=>{let m=C.actions.get(k.id),y={};if(U.damageEffect.length>0){let i=m.notes.effect??[];i=i.concat(U.damageEffect),y["notes.effect"]=i,b=b.replace(U.damageEffect.join(""),"").trim()}if(U.damageFormula&&m.damage.parts.length>0){let i=m.damage.parts[0].types;if(pf1.registry.damageTypes.get(U.damageType)===void 0)i.values=[],i.custom=U.damageType??"";else i.values=[U.damageType],i.custom="";if((await W.processFormula(m.damage.parts[0].formula,window.SBC.actor,C)).formula!==U.damageFormula)y["damage.parts"]=[{formula:U.damageFormula,type:i}]}if(U.attack&&["spellsave","save","heal","other"].includes(m.actionType)===!1)y.attackBonus=U.attack;if(m.save.dc){if(U.saveDC){let i=(await W.processFormula(m.save.dc,window.SBC.actor,C)).total;if(i!==U.saveDC){let $0=U.saveDC-i;if(+$0>0)y["save.dc"]=m.save.dc+` + ${+$0}`}}if(U.saveType)switch(U.saveType){case"Fortitude":y["save.type"]="fort";break;case"Reflex":y["save.type"]="ref";break;case"Will":y["save.type"]="will";break;default:y["save.type"]=null;break}if(U.saveEffect)y["save.description"]=(U.saveType?`${U.saveType} `:"")+U.saveEffect}if(U.templateRange)y["measureTemplate.size"]=U.templateRange;if(U.templateType)switch(U.templateType){case"cone":y["measureTemplate.type"]="cone";break;case"ray":y["measureTemplate.type"]="ray";break;default:y["measureTemplate.type"]="circle";break}if(Object.keys(y).length>0)await m.update(y),c.push(m)},[t]);if(await C.update({"system.actions":t}),U.uses){let k=C.system.uses.maxFormula?(await W.processFormula(C.system.uses.maxFormula,window.SBC.actor,C)).total:0;if(k!==U.uses){let l=C.system.uses.maxFormula,c=(U.uses-k).toString(),m=C.system.uses.per?C.system.uses.per:"charges";switch(m){case"round":m="round";break;case"hour":m="hour";break;case"day":m="day";break;case"week":m="week";break;default:break}let y={"system.uses.maxFormula":l?+c>0?l+` + ${+c}`:l:c,"system.uses.per":m,"system.uses.value":C.system.uses.value+ +c};if(C.actions.size===0){let $0={...new pf1.components.ItemAction().toObject(void 0,!1),name:game.i18n.localize("PF1.Use")};y["system.actions"]=[$0]}if(await C.update(y),b=b.replace(/(\d+)\/(day|week|month|year)/i,"").trim().replace(/^,|,$/g,"").trim(),v=b?.split(/[;,]\s?/)??[],v.length>0&&v[0]!=="")v=v.map((i)=>W.capitalize(i));else v=null;await C.update({name:W.capitalize(I[0])+(v?.length>0?` (${v.join(", ")})`:"")})}}}if(N.match(/^Mythic\) \(/i)){let U=N.indexOf("("),S=N.substring(U+1).replace(")","");v?.push(S)}if(d>1)if(v)v.unshift(d);else v=[d];z.push({name:I[0],kind:C.system.abilityType,description:C.system.description.value,subParts:v})}if(F.toLowerCase()==="weapon finesse"&&Q==="feats")this.app.processData.flags.hasWeaponFinesse=!0}return[!0,z]}catch(K){return this.throwError(K,"parser.entity.error",J,Z,{type:Y}),[!1,[]]}}processForChoices(J){let Z=["bardic performance","versatile performance","rogue talent","hexes","rage power","ki power","discoveries","exploit","deed","investigator talent","infusion","mesmerist trick","ninja trick","investigator talent","magus arcana","revelation","mercies","cruelties","slayer talent","vigilante trick","weapon training","favored terrain","favored enemy"];J.forEach((Q)=>{let Y=[],X=null;if(Z.find((H)=>{if(Q.toLowerCase().startsWith(H))return X=H,!0;return!1})){let H=W.parseSubtext(Q),G=P0().exec(H[0])?.[0];if(G)H[0]=H[0].replace(G,"").replace(/\s{2,}/,"").trim();if(H[1])H[1]=H[1].replaceAll("[","(").replaceAll("]",")"),this.splitText(H[1],!0).forEach((z)=>{if(["favored enemy","favored terrain","versatile performance","weapon training"].includes(X))Y.push(`${H[0]} (${z})`);else Y.push(`${z}`)});if(Y.length>0){if(Y[0].toLowerCase().includes("action")){let _=Y[0].replace(`${H[0]} `,"").trim();if(G)H[0]=`${H[0]} ${G}`;H[0]+=` (${_})`,Y.shift()}switch(X){case"hexes":H[0]=H[0].replace(/hexes/i,"Hex");break;case"discoveries":H[0]=H[0].replace(/discoveries/i,"Discovery");break;case"cruelties":H[0]=H[0].replace(/cruelties/i,"Cruelty");break;case"mercies":H[0]=H[0].replace(/mercies/i,"Mercy");break;default:break}if(J[J.indexOf(Q)]=H[0],Y.length>0)J.push(...Y)}}})}}class T0 extends g{get parserGroup(){return"Parser/Base"}get parserType(){return"aura"}async _parse(J,Z,Q=void 0){let Y=window.SBC,X=Y.compendiumSearch;this.app.processData.notes.aura=[],await F0(window.SBC.actor,"system.traits.aura.custom",J);let H=this.splitText(J,!1);console.log(W.translate("parser.aura.parseInfo",{value:J}),H);let G=0;for(let _ of H){if(_===""||_===",")continue;let z=_.replace(/(\(.*\)|\d.*)/,"").trim(),K=z.toLowerCase(),q=W.translate("parser.aura.testName",{value:K}).toLowerCase(),j=window.SBC.actor.itemTypes.feat.find((x)=>x.name.toLowerCase()===K||x.name.toLowerCase()===q),F={raw:_,name:z},L=_.match(/([^(,;a-zA-Z]+)ft./i),B=0;if(L){B=parseInt(L[1].trim());let x=pf1.utils.convertDistance(B);F.range=`${x[0]} ${x[1]}`}let O="",E="",N="",P=null;if(/\bDC\b/.test(_)){if(E=_.match(/DC\s*(\d+)/)[1],P="save",F.dc=E,/DC\s*\d+\s*([^)(,;0-9]+)/.test(_))N=_.match(/DC\s*\d+\s*([^)(,;0-9]+)/)[1],F.dcNotes=N;if(/\s+([^)(,;]+)DC\s*\d+/.test(_))O=_.match(/\s+([^)(,;]+)DC\s*\d+/)[1].trim().toLowerCase(),F.saveType=W.translate(`preview.${O.capitalize()}`)}let M="(\\b"+[z,B,O,E,N,"DC"].filter((x)=>!!x).join("\\b|\\b")+"\\b|ft\\.|[(),])",R=new RegExp(M,"gi"),T=_.replace(R,"").trim();if(F.effect=T,j)this.app.processData.notes.aura.push(F);else{let x={search:new Set([z,`Aura of ${z}`]),item:_},h=await X.findEntityInCompendia(x,{itemType:"feat",classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race});if(h)await W.addAssociatedClass(h,Y.actor.itemTypes.class),await D(h),this.app.processData.notes.aura.push(F);else{let w=W.makeValueRollable(T),d={...new pf1.components.ItemAction().toObject(void 0,!1),actionType:P,activation:{cost:null,type:"passive",unchained:{cost:null,type:"passive"}},duration:{units:"perm"},effectNotes:w,measureTemplate:{type:"circle",size:B},name:W.translate("parser.aura.placeholderActionName"),range:{value:B,units:"ft"},save:{dc:E,type:O,description:N},target:{value:W.translate("parser.aura.placeholderTarget")}},a=new Item.implementation({name:W.translate("parser.aura.placeholderName",{value:z.capitalize()}),type:"feat",system:{abilityType:"na",actions:[d],subType:"racial",tag:`aura${G}`},img:"systems/pf1/icons/spells/runes-blue-3.jpg"});await D(a),this.app.processData.notes.aura.push(F),G++}}}return this.app.processData.notes.aura=this.app.processData.notes.aura.sort((_,z)=>_.name.localeCompare(z.name)),!0}}var S0=Object.freeze({PrestigeClass:"PrestigeClass",WizardClass:"WizardClass",SupportedClass:"SupportedClass",MythicPath:"MythicPath"});class C0 extends g{get parserGroup(){return"Parser/Base"}get parserType(){return"class"}async _parse(J,Z,Q=void 0){let Y=window.SBC,X=Y.compendiumSearch;this.app.processData.notes.base.classes=[],J=J.replaceAll(/\sArchetype|\sPrestige Class/gi,"");let H=J.split(/\//).map((G)=>G.trim());for(let G of H){let _=N0().exec(G).groups,z=!!_.exClass,K=null;if(G.match(m1()))K=S0.PrestigeClass;else if(G.match(k1()))K=S0.SupportedClass;else if(G.match(I0()))K=S0.WizardClass;else if(G.match(u1()))K=S0.MythicPath;if(!K){this.throwError(void 0,"parser.class.failedToCreate",{class:G});continue}W.log(W.translate("parser.class.parseInfo",{classType:K}));let q=W.parseSubtext(G.trim());if(q.length>2)q[0]+=" "+q[2][0];let j={name:K===S0.WizardClass?"wizard":_.class,deity:_.deity,wizardClass:K===S0.WizardClass?_.class:"",archetype:_.archetype?.match(/\d+/)?"":_.archetype||"",level:parseInt(_.level),item:q[0].replaceAll(/[0-9]/g,"").trim()};console.log(j);let F=await X.findEntityInCompendia(j,{itemType:"class",classes:this.app.processData.characterData.classes});if(!F){W.log(W.translate("parser.class.notFound",{className:j.name}));continue}if(F&&F.system.subType!=="racial"&&j.level===0)continue;let L=j.name,B={};if(j.deity)j.name+=` of ${j.deity}`,await window.SBC.actor.update({"system.details.deity":j.deity});if(j.archetype){let M=this.splitText(j.archetype,!1).map((R)=>R.trim().capitalize()).filter((R)=>R!=="");await W.runParallelOps(M,async(R)=>{let T=`${j.name.capitalize()} (${R})`,x=await X.findEntityInCompendia({name:T,item:T},{itemType:"feat",itemSubType:"misc"});if(x)await D(x)}),L=j.name.capitalize()+" ("+M.join(", ")+")",Y.app.processData.characterData.archetypes.push(...M)}else if(j.wizardClass)L=W.translate(`wizardSchools.${j.wizardClass.toLowerCase()}`),Object.assign(B,{"system.tag":"wizard","system.useCustomTag":!0});else L=j.name.capitalize();let O=F.system.subType;if(O!=="mythic"){let M=this.app.processData.characterData.hdMaximized,R=W.getDiceAverage(+F.system.hd);if(j.hp=!M&&O==="base"?+F.system.hd+ +Math.floor(R*(j.level-1)):R*j.level,!M&&O==="base")this.app.processData.characterData.hdMaximized=!0}else j.hp=+F.system.hd*j.level;Object.assign(B,{name:(z?"Ex-":"")+L,"system.level":j.level,"system.hp":j.hp});let E=[];if(F.system.links?.classAssociations&&!window.SBC.settings.getSetting("createAssociations"))E=F.system.links.classAssociations,Object.assign(B,{"system.links.-=classAssociations":null});await F.updateSource(B);let[N,P]=await D(F);if(this.app.processData.notes.base.classes.push(`${z?"Ex-":""}${L} ${j.level}`),P.name.match(/\bExpert\b/i))Y.app.processData.characterData.isExpert=!0,Y.app.processData.characterData.expertSkills=Object.keys(P.system.classSkills).filter((M)=>P.system.classSkills[M]),Y.app.processData.characterData.expertId=P._id;if(!this.app.processData.characterData.classes.includes(P.system.tag))this.app.processData.characterData.classes.push(P.system.tag);if(E.length>0)await P.update({"system.links.classAssociations":E})}return!0}}class A0 extends g{get parserGroup(){return"Parser/Base"}get parserType(){return"creatureType"}async _parse(J,Z,Q=void 0){let Y=window.SBC,X=Y.compendiumSearch,H=HJ(J),G=!Y.actor.race,_={name:H[0],type:"racial",subTypes:"",item:H[0]};if(H.length>1)_.subTypes=H[1];let z=await X.findEntityInCompendia(_,{itemType:"class"});if(G){let F={name:z.name,img:z.img,type:"race",creatureTypes:[z.system.tag],creatureSubtypes:this.splitText(W.capitalize(_.subTypes)).map((B)=>pf1.utils.createTag(B)),desc:z.system.description.value,sources:z.system.sources,size:Y.actor.system.traits.size.base},L=await W.generatePlaceholderEntity(F,Z);await D(L)}else{let F=Y.actor.race,L=new Set,B=new Set;F.system.creatureTypes.base.forEach((O)=>{L.add(O)}),F.system.creatureSubtypes.base.forEach((O)=>{B.add(O)}),L.add(z.system.tag),this.splitText(W.capitalize(_.subTypes)).forEach((O)=>B.add(pf1.utils.createTag(O))),await F.update({"system.creatureTypes":Array.from(L),"system.creatureSubtypes":Array.from(B)})}let K={system:{level:0}};switch(_.name.toLowerCase()){case"undead":this.app.processData.flags.isUndead=!0,await f1(this.app.processData,"isUndead");break;case"construct":this.app.processData.flags.isConstruct=!0;break;default:break}if(_.subTypes!=="");await z.updateSource(K),this.app.processData.notes.creatureType={type:W.translate(`types.${W.camelize(H[0])}`),subTypes:_.subTypes.split(",").map((F)=>{F=F.trim();let L=W.haystackSearch(window.SBC.config.creatureSubTypes,F);if(L)return W.translate(`subTypes.${W.camelize(L)}`);return F.capitalize()})};let[q,j]=await D(z);if(j.name.match(/\bOutsider\b/i))Y.app.processData.characterData.isOutsider=!0,Y.app.processData.characterData.outsiderSkills=Object.keys(j.system.classSkills).filter((F)=>j.system.classSkills[F]),Y.app.processData.characterData.outsiderId=j._id;if(!this.app.processData.characterData.race)this.app.processData.characterData.race=z.system.tag;return!0}}class h0 extends g{get parserGroup(){return"Parser/Base"}get parserType(){return"race"}async _parse(J,Z,Q=void 0){let X=window.SBC.compendiumSearch,H={name:J.toLowerCase(),item:J};this.app.processData.notes.base.race=H.name.capitalize();let G=await X.findEntityInCompendia(H,{itemType:"race"});if(!G){let _={name:J,type:"race"};G=await W.generatePlaceholderEntity(_,Z)}if(!this.app.processData.characterData.race)this.app.processData.characterData.race=pf1.utils.createTag(G.name);return await D(G),!0}}var GJ={blindsight:"system.traits.senses.bs.value",blindsense:"system.traits.senses.bse.value",darkvision:"system.traits.senses.dv.value",tremorsense:"system.traits.senses.ts.value",scent:"system.traits.senses.sc.value",truesight:"system.traits.senses.tr.value","true seeing":"system.traits.senses.tr.value","see in darkness":"system.traits.senses.sid","see invisibility":"system.traits.senses.si","low-light":"system.traits.senses.ll.enabled"},_J={blindsight:"PF1.Sense.blindsight",blindsense:"PF1.Sense.blindsense",darkvision:"PF1.Sense.darkvision",tremorsense:"PF1.Sense.tremorsense",scent:"PF1.Sense.scent","see in darkness":"PF1.Sense.seeInDark",truesight:"PF1.Sense.trueseeing","true seeing":"PF1.Sense.trueseeing","see invisibility":"PF1.Sense.seeInvis","low-light":"PF1.Sense.lowlight"};class g0 extends g{get parserGroup(){return"Parser/Base"}get parserType(){return"sense"}async _parse(J,Z,Q=void 0){let X=Object.values(pf1.config.senses).map((G)=>G.toLowerCase()).concat(P1),H=[];this.app.processData.notes.base.senses=[];for(let G of X){if(J.search(G)===-1)continue;switch(G){case"scent":case"truesight":case"true seeing":case"blindsight":case"blindsense":case"darkvision":case"tremorsense":{let _=new RegExp(G+"\\s(\\d+)",""),z=J.match(_)?.[1]??(["truesight","true seeing"].includes(G)?120:0);await window.SBC.actor.update({[GJ[G]]:+z});let[K,q]=pf1.utils.convertDistance(+z),j=_J[G]||null;this.app.processData.notes.base.senses.push((j?game.i18n.localize(j):G.capitalize())+` ${K} ${q}`);break}case"see in darkness":case"see invisibility":case"low-light":{await window.SBC.actor.update({[GJ[G]]:!0});let _=_J[G]||null;this.app.processData.notes.base.senses.push(_?game.i18n.localize(_):G.capitalize());break}default:H.push(G.capitalize()),this.app.processData.notes.base.senses.push(G.capitalize());break}}if(!this.app.processData.notes.base.senses.length)delete this.app.processData.notes.base.senses;if(H.length)await window.SBC.actor.update({"system.traits.senses.custom":H.join(";")});return!0}}class D0 extends g{get parserGroup(){return"Parser/Base"}get parserType(){return"mythic"}async _parse(J,Z,Q=void 0){let X=window.SBC.compendiumSearch;if(J=parseInt(J)||0,J===0)return!0;this.app.processData.notes.base.mr=J,W.log(W.translate("parser.mr.parseInfo",{value:J}));let H={name:"Mythic Rank",item:"Mythic Rank"},G=await X.findEntityInCompendia(H,{itemType:"class",classes:this.app.processData.characterData.classes}),_=window.SBC.actor.itemTypes.class.find((O)=>O.system.subType==="racial"),z=Math.min(10,+_?.system?.hd),[K,q]=await D(G),j=[{_id:q.id,"system.level":J,"system.hp":z*J,"system.hd":z}],F=window.SBC.actor.itemTypes.feat.find((O)=>O.system.subType==="misc"&&O.system.tag==="surgeMythic"),L=window.SBC.actor.itemTypes.feat.find((O)=>O.system.subType==="misc"&&O.system.tag==="mythicPowerMythic"),B=0;while((!F||!L)&&B<10)await new Promise((O)=>{B++,setTimeout(O,1000)}),F=window.SBC.actor.itemTypes.feat.find((O)=>O.system.subType==="misc"&&O.system.tag==="surgeMythic"),L=window.SBC.actor.itemTypes.feat.find((O)=>O.system.subType==="misc"&&O.system.tag==="mythicPowerMythic");if(F){let O=6+2*Math.floor((J-1)/3);await F.actions.get(F.actions.contents[0].id).update({effectNotes:[`+[[1d${O}]] Surge`]})}if(L)j.push({_id:L.id,"system.uses.maxFormula":`${J}`,"system.uses.value":+J});return await window.SBC.actor.updateEmbeddedDocuments("Item",j),F?.prepareData(),await L?.recharge({value:+J,maximize:!0,commit:!0,period:"any"}),await L?.createItemLink("charges",F),await F0(window.SBC.actor,"system.details.cr.base",window.SBC.actor.system.details.cr.base-Math.floor(J/2)),!0}}class y0 extends g{get parserGroup(){return"Parser/Defense"}get parserType(){return"armorClass"}async _parse(J,Z,Q=void 0){let Y=J.split(";");if(Y.length>1)this.app.processData.miscNotes.acNotes.push(Y[1].trim());let X=Y[0].split(",");this.app.processData.notes.defense.acTypes=[];for(let H of X){let G=H.match(p1())?.[0]?.toLowerCase(),_=parseInt(H.match(/[+-]\d+/)?.[0])??0,z=_;switch(console.log(W.translate("parser.armorClass.parseInfo",{type:G,value:_})),G){case"natural":if(_-=await W.getTotalFromChanges(window.SBC.actor,"nac"),_!==0)this.app.processData.miscNotes.naturalAC=_;break;case"size":case"dex":break;case"armor":case"shield":case"base":case"enhancement":case"dodge":case"inherent":case"deflection":case"morale":case"luck":case"sacred":case"insight":case"resistance":case"profane":case"trait":case"racial":case"competence":case"circumstance":case"alchemical":case"penalty":case"rage":case"monk":case"wis":case"untyped":case"untypedPerm":if(_-=await W.getTotalFromChanges(window.SBC.actor,"ac",G),_!==0)this.app.processData.characterData.conversionValidation.attributes[G]=_;break;default:break}this.app.processData.notes.defense.acTypes.push({type:W.translate(`armorTypes.${G}`),value:z>=0?`+${z}`:z})}return!0}}class d0 extends g{get parserGroup(){return"Parser/Defense"}get parserType(){return"damageReduction"}async _parse(J,Z,Q=void 0){let Y=J.replace(/(^[,;\s]*|[,;\s]*$)/g,""),X=this.splitText(Y);this.app.processData.notes.defense.dr=[];let H=window.SBC.actor.system.traits.dr.value,G=window.SBC.actor.system.traits.dr.custom;for(let _ of X){_=_.replace(/Effects/gi,"").trim();let z=/^(?<amount>\d+)\s*\/\s*(?<type1>.+?)(?:\s*(?<operator>or|and)\s*(?<type2>.+?))?$/g.exec(_),{amount:K,type1:q,operator:j,type2:F}=z.groups;if(console.log(W.translate("parser.damageReduction.parseInfo"),K,q,j,F,q?.search(Y0()),F?.search(Y0())),q&&q.match(Y0())||F&&F.match(Y0())){q=q?.match(Y0())?.[0],F=F?.match(Y0())?.[0];let L=[q,F].filter((B)=>!!B).map((B)=>pf1.utils.createTag(B));H.push({amount:K,types:L,operator:j==="or"}),this.app.processData.notes.defense.dr.push([K,"/",this.getDamageTypePhrase(L[0]),...L[1]?[" ",W.translate(j)," ",this.getDamageTypePhrase(L[1])]:[]].join(""))}else G+=`${_.capitalize()};`,this.app.processData.notes.defense.dr.push(_.capitalize())}return await window.SBC.actor.update({"system.traits.dr.value":H,"system.traits.dr.custom":G.replace(/;$/,"")}),!0}getDamageTypePhrase(J){if(pf1.config.damageResistances[J])return pf1.config.damageResistances[J];let Z=pf1.registry.materials.getLabels();if(Z[J])return Z[J];let Q=pf1.registry.damageTypes.getLabels();if(Q[J])return Q[J];return""}}class b0 extends g{get parserGroup(){return"Parser/Defense"}get parserType(){return"hitPoints"}async _parse(J,Z,Q=void 0){let Y=window.SBC.actor.itemTypes.class,X=!1,[H,G,_,z,K]=this.processHPString(J);W.log(`HP: ${_} and Bonus: ${z}`);let q=0,j=0,F=_.reduce((x,h)=>{let[w,p]=h.split("d").map((d)=>parseInt(d));return q+=w,x+w*W.getDiceAverage(p)},0)+z;j=q-Y.reduce((x,h)=>x+(h.system.subType==="mythic"?0:h.system.level),0);let L=Y.find((x)=>x.system.subType==="racial");if(L)await L.update({"system.level":j,"system.hp":j*W.getDiceAverage(L.system.hd)});let B=window.SBC.actor.system.attributes.hp.value,O=F-B,E=Y.find((x)=>x.system.subType==="base"||x.system.subType==="npc");if(E){if(E.system.subType==="base"){if(!X){X=!0,W.log(`Maximizing first HD for ${E.name} - ${E.system.hd} - ${W.getDiceAverage(E.system.hd)}`);let x=E.system.hd-W.getDiceAverage(E.system.hd);F+=x,O+=x}}if(O===E.system.level)await E.update({"system.fc.hp.value":E.system.level}),O-=E.system.level,B+=E.system.level}let N=await mJ(window.SBC.actor,Y);W.log(`HP Data: Statblock: ${F}, Actor: ${B}, System: ${N}`),W.log(`HP Difference between Statblock and Actor: ${O}`);let P=N-B;W.log(`HP Difference between System and Actor: ${P}`);let M=F-N;W.log(`HP Difference between Statblock and System: ${M}`);let R=T1(F+(H-F+P));if(this.app.processData.characterData.conversionValidation.attributes.hpTotal=R,this.app.processData.notes.defense.hpTotal=R,this.app.processData.notes.defense.hdTotal=q,this.app.processData.notes.defense.hdPool=G,await this.resetRacialClassesWithNoLevels(),!K.trim().length)return!0;let T=await pJ(this.splitText(K,!1),Z);return this.app.processData.notes.defense.hdAbilities=T.join(", "),!0}processHPString(J){if(!J)return[0,"",[],0,""];if(J.match(/\);\s*(regeneration|fast[ -]healing)/i))J=J.replace(/\);(\s*regeneration|fast[ -]healing)/i,"), $1");let Z=this.splitText(J,!1),[Q,Y]=W.parseSubtext(Z[0]),X=Y.match(/(\d+d\d+)/g),G=Y.match(/(\b[^d+\s]*\d+[^\sd+]*\b)(?!\s*HD)/gi)?.reduce((_,z)=>_+parseInt(z),0)??0;return[Q,Y,X,G,Z[1]||""]}async resetRacialClassesWithNoLevels(){let J=[];if(window.SBC.actor.itemTypes.class.filter((Z)=>Z.system.level===0).forEach(async(Z)=>{if(Z.system.subType==="racial")J.push(Z);else await Z.update({"system.savingThrows":{fort:{value:"",base:0,good:Z.system.savingThrows.fort.good},ref:{value:"",base:0,good:Z.system.savingThrows.ref.good},will:{value:"",base:0,good:Z.system.savingThrows.will.good}}})}),J.length){if(!window.SBC.actor.itemTypes.race.length){let Q=J[0],Y=W.parseSubtext(Q.name),X={name:Y[0],creatureType:Y[0].toLowerCase(),desc:Q.system.description.value,img:Q.img,size:window.SBC.actor.system.traits.size.base,subTypes:Y.length>1?Y[1].replace(/\s/g,"").split(","):"",type:"race"};await D(await W.generatePlaceholderEntity(X))}window.SBC.actor.deleteEmbeddedDocuments("Item",J.map((Q)=>Q.id))}}}async function mJ(J,Z){let Q=0,Y=game.settings.get("pf1","healthConfig"),X={continuous:Y.continuous,maximized:Y.maximized,rounding:Y.rounding,maximizedProgress:0},H=window.SBC,G=H.settings.getSetting(`${H.config.const.actorType[H.actorType]}health`);if(G)X.continuous=G==="continuous";for(let K of Z){let q=K.system.subType,j=game.settings.get("pf1","healthConfig").getClassHD(K);switch(q){case"base":case"prestige":case"npc":case"racial":{let F=K.system.level,L=0;if(j.maximized&&X.maximizedProgress<j.maximized)L=Math.min(X.maximized-X.maximizedProgress,F),F-=L,X.maximizedProgress+=L;let B=uJ(X,j,K.system.hd,F,L);Q+=B+K.system.fc.hp.value,await K.update({"system.hp":B});break}case"mythic":Q+=K.system.hp;break;default:break}}let _=J.system.attributes.hd.total,z=J.system.attributes.hpAbility;return Q+=_*J.system.abilities[z].mod,Q+=await W.getTotalFromChanges(J,"mhp"),Q}function uJ(J,Z,Q,Y,X){let H=0,G=W.getDiceAverage(Q,Z.rate);if(!J.continuous)for(let z=0;z<Y;z++)H+=T1(G);else H=T1(G*Y);return H+=X*Q,H}function T1(J){switch(game.settings.get("pf1","healthConfig").rounding){case"up":J=Math.ceil(J);break;case"down":J=Math.floor(J);break;case"nearest":J=Math.round(J);break;default:break}return J}async function pJ(J,Z){let Q=[],Y=new RegExp("\\b(regeneration|fast[ -]healing)\\b","gi");for(let X of J){if(X=X.trim(),X.length===0)continue;if(X.search(Y)===-1){let G={name:X,type:"misc"};Q.push(G.name);let _=await W.generatePlaceholderEntity(G,Z);await D(_);continue}switch(X.match(Y)[0].toLowerCase()){case"regeneration":{await A.map.defense.regeneration.parse(X,Z);break}case"fast healing":case"fast-healing":{await A.map.defense.fastHealing.parse(X,Z);break}default:break}Q.push(X)}return Q}class k0 extends g{get parserGroup(){return"Parser/Defense"}get parserType(){return"immunity"}async _parse(J,Z,Q=void 0){let Y=J.replace(/(^[,;\s]*|[,;\s]*$)/g,""),X=this.splitText(Y);this.app.processData.notes.defense.immune=[];let H={ci:window.SBC.actor.system.traits.ci.base,di:window.SBC.actor.system.traits.di.base};for(let G of X){G=this.sanitizeInput(G.replace(/(?<!Death )Effects/gi,"").trim());let _=G.toLowerCase().includes("fatigue");if(_||G.search(Y1())!==-1){if(_)G="fatigued";let z=W.getKeyByValue(pf1.config.conditionTypes,G);H.ci.push(W.camelize(z)),this.app.processData.notes.defense.immune.push(pf1.config.conditionTypes[z])}else if(G.replace(/(\s*energy)/i,"").search(Y0(!0))!==-1){let z=W.getKeyByValue(pf1.registry.damageTypes.getLabels(),G.replace(/(\s*energy)/i,""));H.di.push(W.camelize(z)),this.app.processData.notes.defense.immune.push(pf1.registry.damageTypes.getLabels()[z]+(G.match(/ energy/)?" Energy":""))}else if(G.search(o1())!==-1){let z=W.getKeyByValue(pf1.registry.conditions.getLabels(),G);H.ci.push(W.camelize(z)),this.app.processData.notes.defense.immune.push(pf1.registry.conditions.getLabels()[z])}else if(G.search($J())!==-1){let z=W.haystackSearch(window.SBC.config.creatureTypes,G),K=window.SBC.config.immunities[z]||{};if(K.condition)H.ci.push(...K.condition);if(K.damage)H.di.push(...K.damage);if(K.custom)H.ci.push(...K.custom);this.app.processData.notes.defense.immune.push(G.capitalize())}else H.ci.push(G.capitalize()),this.app.processData.notes.defense.immune.push(G.capitalize())}return await window.SBC.actor.update({"system.traits.ci":H.ci,"system.traits.di":H.di}),!0}sanitizeInput(J){let Z={fatigue:"fatigued",paralysis:"paralyzed",confusion:"confused",petrification:"petrified",stunning:"stunned"};for(let Q of Object.keys(Z))J=J.replace(new RegExp(Q,"gi"),Z[Q]);return J.trim()}}class m0 extends g{get parserGroup(){return"Parser/Defense"}get parserType(){return"resistance"}async _parse(J,Z,Q=void 0){let Y=J.replace(/(^[,;\s]*|[,;\s]*$)/g,"").replace("electricity","electric").replaceAll(" energy",""),X=this.splitText(Y);this.app.processData.notes.defense.resist=[];let H=window.SBC,G=H.compendiumSearch,_=H.actor.system.traits.eres.value,z=H.actor.system.traits.eres.custom,K=H.actor.system.traits.cres;for(let q=0;q<X.length;q++){let j=X[q].replace(/Effects/gi,"").trim();if(j.match(Y1()))K+=`${j.capitalize()};`,this.app.processData.notes.defense.resist.push(K);else{let F=/^(?<type1>\S+)(?:\s*(?<operator>or|and)\s*(?<type2>\S+))?\s*(?<amount>\d+)$/g.exec(j);if(!F){let L={search:new Set,type:"feats",item:j};L.search=W.createSearchSet([W.capitalize(j)],!0);let B=await G.findEntityInCompendia(L,{itemTypes:["feat"],itemSubTypes:["classFeat","misc"],classes:this.app.processData.characterData.classes});if(!B)L.itemTypes="misc",B=await W.generatePlaceholderEntity(L);let O=W.checkForDuplicateItem(H.actor,"feat","classFeat",j,B);if(!O)O=W.checkForDuplicateItem(H.actor,"feat",null,j,B);if(!O)await D(B)}else{let{amount:L,type1:B,operator:O,type2:E}=F.groups;if(console.log(W.translate("parser.resistance.parseInfo"),L,B,O,E,B?.search(Y0()),E?.search(Y0())),B&&B.match(Y0())||E&&E.match(Y0())){B=B?.match(Y0())?.[0],E=E?.match(Y0())?.[0];let N=[B,E].filter((P)=>!!P).map((P)=>pf1.utils.createTag(P));_.push({amount:L,types:N,operator:O==="or"}),this.app.processData.notes.defense.resist.push([this.getDamageTypePhrase(N[0]),...N[1]?[" ",W.translate(O)," ",this.getDamageTypePhrase(N[1])]:[]," ",L].join(""))}else z+=`${j.capitalize()};`,this.app.processData.notes.defense.resist.push(j.capitalize())}}}return await H.actor.update({"system.traits.cres":K.replace(/;$/,""),"system.traits.eres.value":_,"system.traits.eres.custom":z.replace(/;$/,"")}),!0}getDamageTypePhrase(J){if(pf1.config.damageResistances[J])return pf1.config.damageResistances[J];let Z=pf1.registry.materials.getLabels();if(Z[J])return Z[J];let Q=pf1.registry.damageTypes.getLabels();if(Q[J])return Q[J];return""}}var zQ=Object.freeze({Fort:Symbol("fort"),Ref:Symbol("ref"),Will:Symbol("will")});class u0 extends g{get parserGroup(){return"Parser/Defense"}get parserType(){return"save"}async _parse(J,Z,Q=void 0){let Y=J,X="";if(/;(?![^(]*\))/.test(Y))[Y,X]=Y.split(/;(?![^(]*\))/);let H=this.splitText(Y).map(W.parseSubtext);for(let G=0;G<H.length;G++){let _=H[G][0],{type:z,value:K}=_.match(ZJ()).groups;if(z=z.toLowerCase(),!z){this.throwError(void 0,"parser.save.error",H[G].join(""),_);continue}if(this.app.processData.characterData.conversionValidation.attributes[z]=K,this.app.processData.notes.defense[z+"Save"]=K,H[G][1])X+=(X?`
`:"")+z.capitalize()+": "+H[G][1]}if(X)this.app.processData.miscNotes.saveNotes=X.trim(),this.app.processData.notes.defense.saveNotes=X.trim();return!0}}class p0 extends g{get parserGroup(){return"Parser/Defense"}get parserType(){return"spellResistance"}async _parse(J,Z,Q=void 0){let Y=J.replace(/(^[,;\s]*|[,;\s]*$)/g,""),X=W.parseSubtext(Y),H=X[0],G="",_="";if(X[1])G=X[1],_=G;else if(/\s*([-+]?\d+)\s+(.*)/.test(H))[H,G]=H.split(/\s*([-+]?\d+)\s+(.*)/).slice(1),_=G;return this.app.processData.miscNotes.srNotes=_,this.app.processData.miscNotes.sr=H.toString(),this.app.processData.notes.defense.srNotes=_,this.app.processData.notes.defense.sr=H.toString(),!0}}class o0 extends g{get parserGroup(){return"Parser/Defense"}get parserType(){return"weakness"}async _parse(J,Z,Q=void 0){let Y=J.replace(/(^[,;\s]*|[,;\s]*$)/g,""),X=this.splitText(Y);this.app.processData.notes.defense.weakness=Y;let H=window.SBC,G=H.actor.system.traits.dv.base;console.log(X);for(let _=0;_<X.length;_++){let z=X[_].replace(/Effects/gi,"").trim(),K=z.match(Y0());if(K)G.push(K[0]);else if(!H.actor.itemTypes.feat.find((q)=>q.system.subType==="misc"&&q.name.toLowerCase()===z.toLowerCase()))G.push(z.capitalize())}return await window.SBC.actor.update({"system.traits.dv":G}),!0}}class l0 extends g{get parserGroup(){return"Parser/Misc"}get parserType(){return"ecology"}async _parse(J,Z,Q=void 0){W.log(W.translate("parser.ecology.status",J));let Y=`<div><strong>${J.name}</strong>: ${J.entry}</div>`,X=window.SBC.actor.items.contents.find((H)=>H.name==="Ecology");if(X){let H=X.system.description.value;await X.update({"system.description.value":H+Y})}else{let H={name:"Ecology",type:"misc",desc:Y,img:"icons/environment/wilderness/tree-oak.webp"},G=await W.generatePlaceholderEntity(H,Z);await D(G)}return!0}}class c0 extends g{constructor(J){super(J);this.specialAbilityCount=0}get parserGroup(){return"Parser/Misc"}get parserType(){return"specialAbility"}async _parse(J,Z,Q=void 0){let{type:Y,name:X,description:H}=this.checkAbilityData(J,Z),G={name:X||"Special Ability",specialAbilityType:Y.toLowerCase(),type:"misc",desc:`<p>${H.replaceAll(`

`,"</p><p>")}</p>`},_=await W.generatePlaceholderEntity(G,Z),z=window.SBC.actor.itemTypes.feat.find((K)=>K.name===`Aura: ${_.name}`&&K.system.subType==="racial");if(z)await z.update({"system.description.value":G.desc});else await D(_);return this.app.processData.notes.specialAbilities.push({name:X,type:Y,typeName:pf1.config.abilityTypes[Y].short,description:W.convertStringUnits(H)}),!0}checkAbilityData(J,Z){if(J.search(JJ())!==-1){let{description:H,name:G,type:_}=QJ().exec(J).groups;if(_=_.toLowerCase().replace(/[()]*/g,""),_==="--")_="na";return{description:H.capitalize(),name:W.capitalize(G),type:_}}let Q=W.translate("parser.specialAbility.placeholderName",{value:++this.specialAbilityCount}),Y=J.trim(),X="na";return this.throwError(void 0,"parser.specialAbility.matchError"),{name:Q,description:Y,type:X}}}class i0 extends g{get parserGroup(){return"Parser/Misc"}get parserType(){return"tactics"}async parse(J,Z,Q=void 0){W.log(W.translate("parser.tactics.status",J));let Y=`<div><strong>${J.name}</strong>: ${J.entry}</div>`,X=window.SBC.actor.items.contents.find((H)=>H.name==="Tactics");if(X){let H=X.system.description.value;await X.update({"system.description.value":H+Y})}else{let H={name:W.translate("parser.tactics.placeholderName"),type:"misc",desc:Y,img:"icons/skills/targeting/crosshair-pointed-orange.webp"},G=await W.generatePlaceholderEntity(H,Z);await D(G)}return!0}}class r0 extends g{get parserGroup(){return"Parser/Offense"}get parserType(){return"attack"}async _parse(J,Z,Q){if(!J)return!1;let X=J.replace(/, or/g," or").replace(/, \band\b /g," and ").replace(/\band\b (?![^(]*\)|\()/g,",").split(/\bor\b/g),H=Object.keys(X),G=window.SBC.actor.itemTypes.feat.find((j)=>j.name==="Multiattack"||j.system.tag==="multiAttack"),_=window.SBC.actor.itemTypes.class.find((j)=>{return j.system.tag==="monkUnchained"||j.flags.core?.sourceId==="Compendium.pf1.classes.Item.5mQIOIw4hDhlREPo"}),z=window.SBC.actor.itemTypes.class.find((j)=>{return j.system.tag==="monk"||j.flags.core?.sourceId==="Compendium.pf1.classes.Item.W8dxwZ1CZiwLKsqr"}),K=_?!0:!1,q=_?_:z;console.log("FS| Unchained Monk",_,z,K,q);for(let j=0;j<H.length;j++){let F=this.fixSplitGroup(this.splitText(X[j]));console.log("FS| Attack Group",F,this.splitText(X[j]));for(let L=0;L<F.length;L++)console.log(F[L],L,Z,Q),await this._processAttack(F[L].trim(),L,Z,Q,G,K,q)}return!0}fixSplitGroup(J){let Z=J.reverse();return Z.map((Q,Y)=>{if(Y>0&&Z[Y-1].startsWith("+"))return`${Q} ${Z[Y-1]}`;if(!/^[\d+-]+\//.test(Q))return Q}).filter((Q)=>!!Q).reverse()}async _processAttack(J,Z,Q,Y,X,H,G){console.log("FS| Processing Attack",J,Z,Q,Y,X,H,G);let _=window.SBC.actor,z={attackName:"",formattedAttackName:"",actions:[],img:"",subType:"weapon",attackNotes:"",effectNotes:[],specialEffects:"",isMasterwork:!1,enhancementBonus:null,isPrimaryAttack:!0,held:"normal",isTouch:!1,isNonlethal:!1,isNatural:!1,isBroken:!1,baseTypes:[],weaponGroups:{value:[],custom:""},material:null,addons:{}},K={numberOfAttacks:1,numberOfIterativeAttacks:0,iterativeFormula:"",attackParts:[],formulaicAttacksCountFormula:"",formulaicAttacksBonusFormula:"",inputAttackModifier:0,calculatedAttackBonus:0,attackAbilityType:"",attackAbilityModifier:0,defaultAttackAbility:"",damage:"",damageAbilityType:"",numberOfDamageDice:0,damageDie:0,damageBonus:0,damageModifier:0,damageParts:[],nonCritParts:[],defaultDamageType:"",damageTypes:new Set,specialDamageType:"",hasSpecialDamageType:!1,weaponSpecial:"-",critRange:20,critMult:2,damageMult:1,attackRangeUnits:"",attackRangeIncrement:"",useOriginalDamage:!1,featAttackBonus:0,featDamageBonus:0,featAttackBonusString:"",featDamageBonusString:"",hasMultiattack:X,isUnchainedMonk:H,flurryClass:G,isFlurryOfBlows:!1,flurryOfBlowsType:null},q,j,F,L={attackName:"",weaponGroups:{value:[],custom:""},isMasterwork:!1,attackAbilityType:"",attackAbilityModifier:0,damageAbilityType:"",damageAbilityMax:null,damageBonus:0,damageMult:1,critRange:20,critMult:2,iterativeFormula:"",damageFormula:"",originalDamageFormula:"",featAttackBonus:0,featDamageBonus:0,featAttackBonusString:"",featDamageBonusString:"",baseMaterial:null,material:null,addons:[]},B={statblockIterativeFormula:"",statblockDamageFormula:"",statblockDamageBonus:0,statblockFullFormula:"",statblockEnhancementBonus:0,itemExists:!1,itemIterativeFormula:"",itemDamageFormula:"",itemDamageBonus:0,itemFullFormula:"",itemEnhancementBonus:0};if(console.log("FS| Input Attack",J),J=this._processFlurryOfBlows(J,z),J=this._processAttackProperties(J,z,Z),this._processEnhancementBonus(J,z,B),[q,j,F]=this._processMaterialsAndAddons(J,z),!F)F="steel",z.baseMaterial="steel";this._processAttackName(J,z,q,j,F,Q);let O=await this._acquireWeapon(z,q);console.log("FS| Weapon",O);let E=null;if(O){if(!z.isNatural){let M=pf1.documents.item.ItemAttackPF.fromItem(O);E=(await _.createEmbeddedDocuments("Item",[M]))[0]}else E=(await D(O))[1];z.attackName=O.name;let P=null;if((P=O.name.match(new RegExp("\\b"+pf1.config.actorSizes[window.SBC.actor.system.traits.size.base]+"\\b")))!==null)z.attackName=O.name.replace(P[0],"").trim();z.formattedAttackName=z.attackName}console.log("FS| New Attack",E);let N=z.isNatural;if(E)Y=await this._processWeaponDetails(B,z,L,O,E,Y);if(console.log("FS| Weapon Attack Details",L),this._processAttackModifier(J,K,z,Q),this._processNumberOfIterativeAttacks(J,K,z,B),this._processAttackDamage(J,z,K,B),B.itemExists){if(W.log(`FS| Comparing statblock data to attack item:
Iterative Formula: ${B.statblockIterativeFormula} vs ${B.itemIterativeFormula}
Damage Formula: ${B.statblockDamageFormula} vs ${B.itemDamageFormula}
Damage Bonus: ${B.statblockDamageBonus} vs ${B.itemDamageBonus}
Enhancement Bonus: ${B.statblockEnhancementBonus} vs ${B.itemEnhancementBonus}
Full Formula: ${B.statblockFullFormula} vs ${B.itemFullFormula}
`),B.statblockIterativeFormula===B.itemIterativeFormula&&B.statblockDamageFormula===B.itemDamageFormula&&B.statblockDamageBonus===B.itemDamageBonus&&B.statblockEnhancementBonus===B.itemEnhancementBonus&&B.statblockFullFormula===B.itemFullFormula)N=!0}if(B.itemExists&&N&&!z.isNatural){if(!window.SBC.settings.getSetting("createAttacks"))console.log("FS| Attack already exists and is identical to the statblock. Skipping creation."),await window.SBC.actor.deleteEmbeddedDocuments("Item",[E?.id].filter((P)=>!!P))}else{if(B.itemExists)Object.assign(K,{attackAbilityType:L.attackAbilityType,attackAbilityModifier:L.attackAbilityModifier,damageAbilityType:L.damageAbilityType,featAttackBonus:L.featAttackBonus,featDamageBonus:L.featDamageBonus,featAttackBonusString:L.featAttackBonusString,featDamageBonusString:L.featDamageBonusString,useOriginalDamage:B.statblockDamageFormula===B.itemDamageFormula});switch(Y){case"mwak":this._processMeleeAttackData(E,K,z);break;case"rwak":this._processRangedAttackData(E,K,z,J);break;case"twak":this._processThrownAttackData(E,K,z,J);break;default:if(z.isNatural)this._processNaturalAttackData(E,K,z);break}if(z.attackName.search(/\bSwarm\b/i)!==-1)Y="other";if(J.match(/^\d+/)!==null)K.numberOfAttacks=parseInt(J.match(/(^\d+)/)[1]),z.attackNotes=K.numberOfAttacks+" "+z.attackNotes;if(this._processBaseTypes(E,z,K),!B.itemExists)await this._processFeatBonuses(z,K);this._calculateAttackBonus(K,z);let P=this._calculateDamageBonus(K,z,L);this._processDamageTypes(E,O,z,K),K.damageParts.push({formula:P,types:K.damageTypes});for(let h=1;h<K.numberOfAttacks;h++){let w=h+1+window.SBC.config.const.suffixMultiples[Math.min(3,h)];K.attackParts.push({formula:"",name:w+" "+z.attackName.replace(/e?s$/,"").capitalize()})}let M=null,R=null;[M,R]=this._prepareNewAttackData(E,M,z,K,Y,R),console.log("FS| New Attack Data",M),console.log("FS| Attack Updates",R);let T=null;T=await this._prepareNewAction(E,T,K,z,Y),console.log("FS| New Action Data",T);let x=await this._createFinalAttack(E,M,T,z,R,Y);if(O&&O.isOwned)console.log(x),O.createItemLink("children",x)}}_processFlurryOfBlows(J,Z){let Q=J.match(/flurry of blows\s*\((.*?)\)/i);if(Q)console.log("FS| Flurry of Blows 0",J),J=J.replace(/flurry of blows\s*\((.*?)\)/i,Q[1]).trim(),Z.isFlurryOfBlows=!0,console.log("FS| Flurry of Blows 1",Q,J);else if(J.search(/flurry of blows/i)!==-1)J=J.replace(/flurry of blows/i,"unarmed strike"),Z.isFlurryOfBlows=!0;return J}_processAttackProperties(J,Z,Q){if(J.search(/\d+\s*.*((?:ranged|melee|\+\d+)?\s+touch)\b\s+\(/i)!==-1){if(Z.isTouch=!0,J=J.replace(/((?:ranged|melee|(\+\d+))?\s+touch)\b/i,"$2"),!/[a-z](?![^(]*\))/i.test(J))Z.attackName="Attack "+(Q+1)}if(J.search(/\d+\s*((?:(?:ranged|melee)\s*)?nonlethal)/i)!==-1){if(Z.isNonlethal=!0,J=J.replace(/((?:(?:ranged|melee)\s*)?nonlethal)/i,""),!/[a-z](?![^(]*\))/i.test(J))Z.attackName="Attack "+(Q+1)}if(J.search(/\bbroken\b/i)!==-1){if(Z.isBroken=!0,!/[a-z](?![^(]*\))/i.test(J))Z.attackName="Attack "+(Q+1)}return J}_processEnhancementBonus(J,Z,Q){let Y=J.match(/(?:\W\+|^\+)(\d+)\s+(?!\(|(?:ranged |melee )?touch)/);if(Y)Z.enhancementBonus=parseInt(Y[1]),Z.attackNotes="+"+Z.enhancementBonus+" "+Z.attackNotes,Q.statblockEnhancementBonus=+Z.enhancementBonus;if(J.match(/\bmwk\b/i)!==null)Z.isMasterwork=!0,Z.attackNotes="mwk "+Z.attackNotes}_processMaterialsAndAddons(J,Z){let Q=[],Y="",X="",H=J.match(c1());if(H)Z.baseMaterial=H[0],X=Z.baseMaterial;let G=J.match(f0());if(G)Z.material=G[0],Y=Z.material,Z.material=pf1.registry.materials.contents.find((z)=>z.name===Z.material.capitalize()||z.id===Z.material)?.id??null;let _=J.match(M0());if(_)Q=_,Q.forEach((z,K)=>{Q[K]=pf1.registry.materials.contents.find((q)=>q.name===z.capitalize()||q.id===z.toLowerCase().replace(/\s/,""))?.id??null}),Q=Q.filter((z)=>!!z),Z.addons={},Q.forEach((z)=>{z=z.toLowerCase().replace(/\s/,""),Z.addons[z]=z});return[Q,Y,X]}_processAttackName(J,Z,Q,Y,X,H){if(/((?:[+1-5a-zA-Z']| (?=[+1-5a-zA-Z'])|\*)+)[ +0-9(/]+\(*/.test(J)&&!Z.attackName){if(console.log("FS| Attack Name 1",J),Z.attackName=J.match(/((?:[+1-5a-zA-Z'-]| (?=[+1-5a-zA-Z'-])|\*)+)[ +0-9(/]+\(*/)[1].replace(/^ | $|\bmwk\b |\*|\+$/gi,"").replace(/\+[1-5]$/,"").replace(/^\d+/,"").trim().replace(/(^\+[1-5])|(\+[1-5]+$)/g,"").trim().replace(new RegExp(`(?<!Magic\\s)${Y}`,"i"),"").replace(new RegExp(`(?<!Magic\\s)${X}`,"i"),"").replace(new RegExp(`\\b(${Q.join("|")})\\b`),""),(Y.toLowerCase()==="stone"||X.toLowerCase()==="stone")&&Q.includes("magic"))Z.attackName=Z.attackName.replace(/stone/i,"Magic Stone").trim();Z.attackNotes+=Z.attackName+" "}Z.attackName=Z.attackName.trim(),Z.formattedAttackName=Z.attackNotes.trim()}async _acquireWeapon(J,Z){let Y=window.SBC.compendiumSearch,X=window.SBC.actor.itemTypes.weapon.find((H)=>{let G=H.name.replace(`+${H.system.enh}`,"").replace(pf1.registry.materials.get(H.system.material.normal.value)?.name??"","").replace(/\s{2,}/g," ").replace("Masterwork ","").trim().toLowerCase(),_=J.attackName.toLowerCase(),z=W.stringSimilarity(_,G);if(console.log("Comparing weapon:",G,"item:",_,"similarity:",z),z<0.65){let K=G.replace(`${pf1.config.actorSizes[window.SBC.actor.system.traits.size.base].toLowerCase()} `,"");if(W.stringSimilarity(_,K)<0.65)return!1}if(console.log("Comparing weapon properties..."),J.isMasterwork&&!H.system.masterwork)return console.log("Masterwork status did not match."),!1;if(J.isBroken&&!H.system.broken)return console.log("Broken status did not match."),!1;if(J.enhancementBonus&&+J.enhancementBonus!==H.system.enh)return console.log("Enhancement bonus did not match."),!1;if(Z.length>0){let K=H.system.material.addon;for(let q of Z)if(!K.includes(q))return console.log("Addon did not match."),!1}return!0});if(!X){if(X1().test(J.attackName)){J.isNatural=!0,J.subType="natural";let H="";H=J.attackName.match(X1())[0].split(" ").map((_)=>_.capitalize()).join(" ");let G=H.replace(/s$/,"");if(Object.values(window.SBC.config.naturalAttacks).find((_)=>_===H||_===G))X=await Y.findEntityInCompendia({name:H,altName:H.replace(/s$/,""),item:H},{itemType:"attack"})}}return X}async _processWeaponDetails(J,Z,Q,Y,X,H){if(J.itemExists=!0,Q.attackName=X.name,Q.weaponGroups=Y.system.weaponGroups,!Z.isBroken&&Y.system.broken)Q.isBroken=!0;if(Y.system.material)Q.material=Y.system.material.normal.value,Q.addons=Y.system.material.addon;for(let N of Q.weaponGroups.value)if(this.app.processData.characterData.weaponGroups[N])Q.featAttackBonus=this.app.processData.characterData.weaponGroups[N],Q.featDamageBonus=this.app.processData.characterData.weaponGroups[N],Q.featAttackBonusString=`${Q.featAttackBonus}[${W.translate("feat.weaponTrainingBonus",{bonus:N})}]`,Q.featDamageBonusString=`${Q.featDamageBonus}[${W.translate("feat.weaponTrainingBonus",{bonus:N})}]`;for(let N of Y.system.baseTypes??[]){N=N.toLowerCase();let P=this._parseWeaponBonuses("attack",N),M=this._parseWeaponBonuses("damage",N);if(P[0])Q.featAttackBonus+=+P[0],Q.featAttackBonusString+=Q.featAttackBonusString.length===0?P[1]:` + ${P[1]}`;if(M[0])Q.featDamageBonus+=+M[0],Q.featDamageBonusString+=Q.featDamageBonusString.length===0?M[1]:` + ${M[1]}`}let G=X.actionTypes.indexOf(H);if(G===-1&&H==="rwak")if(G=X.actionTypes.indexOf("twak"),G!==-1)H="twak";else G=0;else G=0;let _=X.actions.contents[G];Q.attackAbilityType=_.ability.attack,Q.attackAbilityModifier=+W.getModifier(this.app.processData.notes.statistics[Q.attackAbilityType]),Q.damageAbilityType=_.ability.damage,Q.damageAbilityMax=_.ability.max??-100,Q.damageBonus=Q.damageAbilityMax>=0?Math.min(Q.damageAbilityMax,+W.getModifier(this.app.processData.notes.statistics[Q.damageAbilityType])):+W.getModifier(this.app.processData.notes.statistics[Q.damageAbilityType]),Q.damageMult=_.ability.damageMult,Q.critMult=_.ability?.critMult,Q.critRange=_.ability?.critRange;let z=_.getAttacks().map((N)=>N.bonus),K="";z.forEach((N,P)=>{if(isNaN(N))N=0;if(Y.system.masterwork)N++;if(Y.system.masterwork&&Y.system.enh)N--;if(N>-1)K+="+";if(K+=N,P!==z.length-1)K+="/"}),Q.iterativeFormula=K,J.itemIterativeFormula=K;let q=X.getAllDamageSources(_.id),j=Math.floor(Q.damageBonus*Q.damageMult),F="";if(Q.critRange!==20)F+=`/${Q.critRange}-20`;if(Q.critMult!==2)F+=`/x${Q.critMult}`;q.forEach((N)=>{if(N.modifier==="enh")j+=N.value,J.itemEnhancementBonus=N.value;else if(N.flavor==="Broken")j+=N.value;else F+=` plus ${N.formula}`}),J.itemDamageBonus=+j;let L=_.damage.parts[0]?.formula,B=null,O=null,E=window.SBC.actor.system.traits.size.base;if(L){let N=L.match(/sizeRoll\((?<num>\d+),\s?(?<size>\d+),?.*\)/);if(N){B=N.groups.num,O=N.groups.size,E=Object.keys(pf1.config.sizeChart).indexOf(E);let P=pf1.utils.roll.sizeRoll(+B,+O,+E),M=Roll.fromTerms(P).formula;console.log(`Results for ${X.name}: `,"Real Formula: ",L,"Results: ",N,"Processed Roll: ",P,"Formula: ",M),J.itemDamageFormula=M;let R=j>-1?"+":"";F=`${M} ${R}${j}${F}`,J.itemFullFormula=F,Q.originalDamageFormula=L}}return delete X.img,delete X.subType,delete X.held,H}_processAttackDamage(J,Z,Q,Y){let X=J.match(/\(([^)]*)\)(?=[^(]*$)/);if(X!==null){let H=X[1].match(/(\d+)d(\d+)/);if(H!==null)Q.numberOfDamageDice=parseInt(H[1]),Q.damageDie=parseInt(H[2]),Z.attackNotes+=" ("+Q.numberOfDamageDice+"d"+Q.damageDie,Y.statblockDamageFormula=`${Q.numberOfDamageDice}d${Q.damageDie}`;else if((H=X[1].match(/^(\d+)/))!==null)Q.numberOfDamageDice=1,Q.damageDie=parseInt(H[1]),Z.attackNotes+=" ("+Q.damageDie,Y.statblockDamageFormula=`${Q.damageDie}`;else Q.numberOfDamageDice=0,Q.damageDie=0;let G=J.match(/d\d+(\+\d+|-\d+)/);if(G!==null)Q.damageBonus=parseInt(G[1]),Z.attackNotes+=`${Q.damageBonus>=0?"+":"-"}${Q.damageBonus}`,Y.statblockDamageBonus=+Q.damageBonus;else Q.damageAbilityType="";let _=J.match(/\/(\d+)-\d+/);if(_!==null)Q.critRange=parseInt(_[1]),Z.attackNotes+="/"+Q.critRange+"-20";let z=J.match(/\/x(\d+)/);if(z!==null)Q.critMult=parseInt(z[1]),Z.attackNotes+="/x"+Q.critMult;let K=H?X[0].match(/\(\d+d\d+[+\d/\-x\s]*([^)\n]*)(?:$|\))/):[null,X[1]];if(K!==null){let F=K[1];if(Z.specialEffects=F,F=F.replace(/(\s+\b(?:and|plus)\b\s+)/gi,",").replace(/(^,|,$)/g,"").split(","),F.length>0){for(let L=0;L<F.length;L++){let B=F[L];if(B!=="")Z.effectNotes.push(B)}if(Z.effectNotes.length>0&&Q.damageDie>0)Z.attackNotes+=(Q.damageDie>0?" plus ":"")+Z.effectNotes.join(", ")}}if(Q.damageDie>0)Z.attackNotes+=")";let q="";if(Q.critRange!==20)q+=`/${Q.critRange}-20`;if(Q.critMult!==2)q+=`/x${Q.critMult}`;if(Z.specialEffects)q+=` ${Z.specialEffects}`;let j=Y.statblockDamageBonus>-1?"+":"";Y.statblockFullFormula=`${Y.statblockDamageFormula} ${j}${Y.statblockDamageBonus}${q}`}else if(J.match(/\(([^)]*)\)/)!==null){let H=J.replace(/\s+/g," ").match(/\(([^)]*)\)/)[1];Z.attackNotes+=" ("+H+")",Z.effectNotes.push(H)}else W.log("Kind of embarrassing, but this should never happen.")}_processNumberOfIterativeAttacks(J,Z,Q,Y){let X=J.match(/(\/\+\d+)/);if(X!==null){Z.numberOfIterativeAttacks=X.length;for(let H=Z.numberOfIterativeAttacks;H>1;H--){let G=+Z.numberOfIterativeAttacks+1-H,_=+Z.inputAttackModifier-5*G>-1?`/+${+Z.inputAttackModifier-5*G}`:`/${+Z.inputAttackModifier-5*G}`;Z.iterativeFormula+=_,Q.attackNotes+=_}}Y.statblockIterativeFormula=Z.iterativeFormula}_processAttackModifier(J,Z,Q,Y){if(J.match(/(\+\d+|-\d+)[+0-9/ ]*\(*/)!==null){if(J.match(/(?!^)(\+\d+|-\d+)[+0-9/ ]*\(+/)!==null)Z.inputAttackModifier=parseInt(J.match(/(?!^)(\+\d+|-\d+)[+0-9/ ]*\(+/)[1]);else if(J.match(/(?!^)(\+\d+|-\d+)[+0-9/ ]*/)!==null)Z.inputAttackModifier=parseInt(J.match(/(?!^)(\+\d+|-\d+)[+0-9/ ]*/)[1]);else{let X="Failed to find a usable attack modifier",H=new f(f.ERRORLEVELS.ERROR,"Parse/Offense",X,Y);this.app.processData.errors.push(H)}Z.iterativeFormula=`${Z.inputAttackModifier>0?"+":""}`+Z.inputAttackModifier,Q.attackNotes+=Z.inputAttackModifier}}_processMeleeAttackData(J,Z,Q){if(!J)Q.img="systems/pf1/icons/items/weapons/elven-curve-blade.PNG",Z.damageAbilityType="str",Z.attackRangeUnits="melee";if(!this.app.processData.flags.noStr){if(Z.attackAbilityModifier=+W.getModifier(this.app.processData.notes.statistics.str),!J)Z.attackAbilityType=window.SBC.actor.system.attributes?.attack?.meleeAbility||"str"}else if(!J)Z.attackAbilityType="dex",Z.attackAbilityModifier=+W.getModifier(this.app.processData.notes.statistics.dex);if(this.app.processData.flags.hasWeaponFinesse)Z.attackAbilityModifier=+W.getModifier(this.app.processData.notes.statistics.dex),Z.attackAbilityType="dex"}_processRangedAttackData(J,Z,Q,Y){if(!J)Q.img="systems/pf1/icons/items/weapons/thorn-bow.PNG";if(!this.app.processData.flags.noDex){if(Z.attackAbilityModifier=+W.getModifier(this.app.processData.notes.statistics.dex),Z.attackAbilityType=window.SBC.actor.system.attributes?.attack?.rangedAbility||"dex",!J){if(Y.search(/(bow\b)/i)!==-1&&Y.search(/\bcomposite\b/i)===-1)Z.damageAbilityType="";else Z.damageAbilityType="str";Z.attackRangeUnits="ft",Z.attackRangeIncrement="5"}}}_processThrownAttackData(J,Z,Q,Y){if(!J)Q.img="systems/pf1/icons/items/weapons/thorn-bow.PNG";if(!this.app.processData.flags.noDex){if(Z.attackAbilityModifier=+W.getModifier(this.app.processData.notes.statistics.dex),Z.attackAbilityType=window.SBC.actor.system.attributes?.attack?.rangedAbility||"dex",Z.damageAbilityType="str",Z.damageMult=1,!J){if(Y.search(/(bow\b)/i)!==-1&&Y.search(/\bcomposite\b/i)===-1)Z.damageAbilityType="";else Z.damageAbilityType="str";Z.attackRangeUnits="ft",Z.attackRangeIncrement="5"}}}_processNaturalAttackData(J,Z,Q){let Y=Q.attackName.match(X1())[0];if(Object.keys(B0).find((X)=>X===Y)){let X=B0[Y.replace(/s$/,"").toLowerCase()];Q.subType="natural",Q.isPrimaryAttack=X.isPrimaryAttack,Q.img=X.img}}_processBaseTypes(J,Z,Q){if(J&&J.type!=="attack")Z.baseTypes=J.system.baseTypes;else Z.baseTypes=[Z.formattedAttackName.replace(/(^\+[1-5])|(\+[1-5]$)/g,"").trim()];if(Z.isNatural)Z.baseTypes.push("natural")}async _processFeatBonuses(J,Z){for(let Q of J.weaponGroups.value)if(this.app.processData.characterData.weaponGroups[Q])Z.featAttackBonus=this.app.processData.characterData.weaponGroups[Q],Z.featDamageBonus=this.app.processData.characterData.weaponGroups[Q],Z.featAttackBonusString=`${Z.featAttackBonus}[${W.translate("feat.weaponTrainingBonus",{bonus:Q})}]`,Z.featDamageBonusString=`${Z.featDamageBonus}[${W.translate("feat.weaponTrainingBonus",{bonus:Q})}]`;for(let Q of J.baseTypes??[]){let Y=this._parseWeaponBonuses("attack",Q.toLowerCase()),X=this._parseWeaponBonuses("damage",Q.toLowerCase());if(Y[0])Z.featAttackBonus+=Y[0],Z.featAttackBonusString+=Y[1];if(X[0])Z.featDamageBonus+=X[0],Z.featDamageBonusString+=X[1]}}_calculateAttackBonus(J,Z){let Q=+this.app.processData.characterData.conversionValidation.attributes.bab;if(Z.isFlurryOfBlows)if(Q+=+J.flurryClass.system.level-+J.flurryClass.system.babBase,J.isUnchainedMonk)J.flurryOfBlowsType="unflurry";else J.flurryOfBlowsType="flurry",Q-=2;let Y=Q+ +pf1.config.sizeMods[window.SBC.actor.system.traits.size.base]+ +J.attackAbilityModifier+ +J.featAttackBonus+(Z.isBroken?-2:0);if(Z.isMasterwork)Y++;else if(Z.enhancementBonus>0)Y+=+Z.enhancementBonus;let X=J.hasMultiattack?2:5;if(Z.isNatural&&Y-J.inputAttackModifier===X)Z.isPrimaryAttack=!1;if(!Z.isPrimaryAttack)Y-=5;if(+Y!==+J.inputAttackModifier)J.calculatedAttackBonus=+J.inputAttackModifier-+Y}_calculateDamageBonus(J,Z,Q){let Y=0;if(J.damageAbilityType==="str")Y=Q.damageAbilityMax>=0?Math.min(Q.damageAbilityMax,+W.getModifier(this.app.processData.notes.statistics.str)):+W.getModifier(this.app.processData.notes.statistics.str);let X=+Y+ +Z.enhancementBonus+ +J.featDamageBonus+(Z.isBroken?-2:0);if(+J.damageBonus-+X===Math.floor(Y/2)&&Y>0)X+=Math.floor(Y/2),J.damageMult=1.5,Z.held="2h";else if(+J.damageBonus-+X===-Math.ceil(Y/2)&&Y>0)X-=Math.ceil(Y/2),J.damageMult=0.5,Z.held="oh";J.damageModifier=+J.damageBonus-+X;let G;if(!J.useOriginalDamage){if(G=`sizeRoll(${J.numberOfDamageDice}, ${J.damageDie}, @size, ${window.SBC.actor.system.traits.size.value})`,J.featDamageBonusString&&!window.SBC.settings.getSetting("rollBonusesIntegration"))G+=" + "+J.featDamageBonusString}else if(G=Q.originalDamageFormula,Q.featDamageBonus&&!window.SBC.settings.getSetting("rollBonusesIntegration"))G+=" + "+Q.featDamageBonusString;if(J.damageModifier!==0)if(J.damageModifier>0)G+=" + "+J.damageModifier+"[adjusted by sbc]";else G+=+J.damageModifier+"[adjusted by sbc]";return G=G.replace(/\+ \+/g,"+ ").replace(/\s\s/," "),G}_processDamageTypes(J,Z,Q,Y){if(J){let X=J.actions.contents[0]?.damage?.parts[0]?.types;if(X?.first())X.forEach((G)=>{Y.damageTypes.add(G)});Object.keys(Z?.system.properties??{}).forEach((G)=>{if(Z?.system?.properties?.[G])Q.attackNotes+=`, ${pf1.config.weaponProperties[G]}`})}else{if(Q.isNonlethal)Y.damageTypes.add("nonlethal");Y.damageTypes.add("untyped")}for(let X=0;X<Q.effectNotes.length;X++){let H=Q.effectNotes[X].replaceAll(" energy","").trim(),G=Object.values(pf1.registry.damageTypes.getLabels()).map((z)=>z.toLowerCase()),_=new RegExp("\\b("+G.join("|")+")\\b","gi");if(H.match(/\d+d\d+/)===null){let z=H.match(_);if(z){let K=z[0].replace("electricity","electric").trim();Q.effectNotes.splice(X,1),Y.damageTypes=new Set(K)}}else{let z=H.match(/(\d+d\d+\s*\+*\s*\d*)/)[0],K=H.replace(z,"").replace("plus","").trim();if(K!==""){let q=H.match(_);if(q)K=q[0].replace("electricity","electric").trim()}else K="untyped";Y.nonCritParts.push({formula:z,types:new Set([K])}),Q.effectNotes.splice(X,1)}}}_prepareNewAttackData(J,Z,Q,Y,X,H){let G=Q.isFlurryOfBlows?Y.flurryClass.system.tag:null;if(!J)Z=new Item.implementation({name:W.capitalize(Q.formattedAttackName)||"Undefined",type:"attack",img:Q.img,system:{attackNotes:this.splitText(Q.attackNotes).slice(1),effectNotes:Q.effectNotes,masterwork:Q.isMasterwork||(Q.enhancementBonus??0)>0,broken:Q.isBroken,enh:+Q.enhancementBonus,proficient:!0,held:Q.held,showInQuickbar:!0,subType:Q.subType,identifiedName:W.capitalize(Q.formattedAttackName)||"Undefined",baseTypes:Q.baseTypes,material:{base:{value:Q.baseMaterial},normal:{value:Q.material},addon:Object.keys(Q.addons)},class:G}}),Z.prepareData();else H={_id:J.id,"system.enh":+Q.enhancementBonus,"system.masterwork":Q.isMasterwork||(Q.enhancementBonus??0)>0,"system.held":Q.held,"system.attackNotes":this.splitText(Q.attackNotes).slice(1),"system.effectNotes":Q.effectNotes,"system.broken":Q.isBroken,name:W.capitalize(Q.formattedAttackName)||"Undefined","system.material.base.value":Q.baseMaterial,"system.material.normal.value":Q.material,"system.material.addon":Object.keys(Q.addons),"system.class":G},Z=J;return[Z,H]}async _prepareNewAction(J,Z,Q,Y,X){let H=Q.calculatedAttackBonus!==0?Y.isNatural&&Q.hasMultiattack&&Q.calculatedAttackBonus===3?null:Q.calculatedAttackBonus.toString()+"[adjusted by sbc]":null;if(Q.featAttackBonusString&&!window.SBC.settings.getSetting("rollBonusesIntegration"))H=H?`${H} + ${Q.featAttackBonusString}`:Q.featAttackBonusString;if(H)H=H.replace(/\+(\s+\+)+/g,"+ ").replace(/\s+/g," ").replace(/^\+\s+/,"").replace(/\s+\+$/,"");let G=Y.isFlurryOfBlows?Q.flurryOfBlowsType:Q.attackParts.length>0&&Q.numberOfIterativeAttacks>0?"advanced":Q.numberOfIterativeAttacks>0&&Q.attackParts.length===0?"standard":"custom",_=Y.isFlurryOfBlows?Q.flurryOfBlowsType==="flurry"?(+this.app.processData.characterData.conversionValidation.attributes.bab+(Q.flurryClass.system.level-Q.flurryClass.system.babBase)).toString():null:null;if(!J)Z={...new pf1.components.ItemAction().toObject(void 0,!1),name:Y.attackName.capitalize(),img:Y.img,activation:{cost:1,type:"attack"},bab:_,unchainedAction:{activation:{cost:1,type:"attack"}},range:{value:Q.attackRangeIncrement,units:Q.attackRangeUnits,maxIncrements:1},attackName:Y.attackName.replace(/((?!Blows|blows)e?s)$/,"").capitalize(),actionType:X,attackBonus:H,critConfirmBonus:"",damage:{critParts:[],nonCritParts:Q.nonCritParts,parts:Q.damageParts},extraAttacks:{type:G,manual:Q.attackParts},formulaicAttacks:{count:{formula:Q.formulaicAttacksCountFormula},bonus:{formula:"@formulaicAttack * -5"}},ability:{attack:Q.attackAbilityType,damage:Q.damageAbilityType,damageMult:Q.damageMult,critRange:Q.critRange,critMult:Q.critMult},naturalAttack:{primaryAttack:Y.isPrimaryAttack,["secondary.attackBonus"]:Q.hasMultiattack?"-2":"-5",["secondary.damageMult"]:Q.damageMult&&Y.isNatural?Q.damageMult:0.5},nonlethal:Y.isNonlethal,touch:Y.isTouch};else{let z=J.actionTypes.indexOf(X);if(z===-1&&X==="rwak")if(z=J.actionTypes.indexOf("twak"),z!==-1)X="twak";else z=0;else z=0;let K=J.actions.get(J.actions.contents[z].id),q={attackBonus:H,damage:{critParts:[],nonCritParts:Q.nonCritParts,parts:Q.damageParts},["extraAttacks.type"]:G,["extraAttacks.manual"]:Q.attackParts,["ability.attack"]:Q.attackAbilityType,["ability.critRange"]:Q.critRange,["ability.critMult"]:Q.critMult,["ability.damageMult"]:Q.damageMult,nonlethal:Y.isNonlethal,touch:Y.isTouch,bab:_,actionType:X};if(J.system.subType==="natural")q["naturalAttack.primaryAttack"]=Y.isPrimaryAttack,q["naturalAttack.secondary.attackBonus"]=Q.hasMultiattack?"-2":"-5",q["naturalAttack.secondary.damageMult"]=Q.damageMult&&Y.isNatural?Q.damageMult:0.5;await K.update(q)}return Z}async _createFinalAttack(J,Z,Q,Y,X,H){let G=(J?J.name:Z.name).toLowerCase(),_=J?J.id:Z.id;console.log(`Looking for existing attack with name ${G} and id ${_}`);let z=window.SBC.actor.itemTypes.attack.find((q)=>q.name.toLowerCase()===G&&q.id!==_),K=z;if(z){let q={enh:J?X["system.enh"]??J.system.enh:Y.enhancementBonus,masterwork:J?X["system.masterwork"]??J.system.masterwork:Y.isMasterwork,broken:J?X["system.broken"]??J.system.broken:Y.isBroken};if(!q.enh)q.enh=0;if(z.system.enh===q.enh&&z.system.masterwork===q.masterwork&&z.system.broken===q.broken){let j=new Set(z.system.attackNotes.concat(this.splitText(Y.attackNotes).slice(1))),F=new Set(z.system.effectNotes.concat(Y.effectNotes));await window.SBC.actor.updateEmbeddedDocuments("Item",[{_id:z.id,"system.attackNotes":Array.from(j),"system.effectNotes":Array.from(F)}]);let L=z.actionTypes.indexOf(H);if(L===-1&&H==="rwak"){if(L=z.actionTypes.indexOf("twak"),L!==-1)H="twak"}let B=J?J.actions.contents[0]:Q,O=pf1.utils.deepClone(B);if(O){if(Y.isFlurryOfBlows)O.name="Flurry of Blows";if(!Y.isPrimaryAttack&&Y.isNatural)O.name+=" (Secondary)";else if(O.name!=="Attack"){if(H==="mwak")O.name="Melee";else if(H==="rwak")O.name="Ranged";else if(H==="twak")O.name="Thrown"}else if(H==="mwak")O.name+=" (Melee)";else if(H==="rwak")O.name+=" (Ranged)";else if(H==="twak")O.name+=" (Thrown)";delete O._id}else{if(Y.isFlurryOfBlows)O.name="Flurry of Blows";if(!Y.isPrimaryAttack&&Y.isNatural)O.name+=" (Secondary)";else if(O.name!=="Attack"){if(H==="mwak")O.name="Melee";else if(H==="rwak")O.name="Ranged";else if(H==="twak")O.name="Thrown"}else if(H==="mwak")O.name+=" (Melee)";else if(H==="rwak")O.name+=" (Ranged)";else if(H==="twak")O.name+=" (Thrown)";delete O._id}await pf1.components.ItemAction.create([O],{parent:z});let E=[],N=z.toObject().system.actions;for(let P=0;P<N.length;P++)if(P!==L)E.push(N[P]);if(await z.update({"system.actions":E}),X?.["system.class"])await z.update({"system.class":X["system.class"]});if(J)await window.SBC.actor.deleteEmbeddedDocuments("Item",[J.id])}}else if(!J)await Z.updateSource({"system.actions":[Q]}),Z.prepareData(),K=(await D(Z))[1];else await window.SBC.actor.updateEmbeddedDocuments("Item",[X]),Z.prepareData(),K=Z;return K}_parseWeaponBonuses(J,Z){let Q=0,Y="",X=this.app.processData.characterData;switch(J){case"attack":if(X.weaponFocus.includes(Z))Q++,Y+=`+ 1[${W.translate("feat.weaponFocus")}]`;if(X.weaponFocusGreater.includes(Z))Q++,Y+=`+ 1[${W.translate("feat.greaterWeaponFocus")}]`;if(Object.values(X.weaponGroups).includes(Z))Q+=X.weaponGroups[Z],Y+=`+ 1[${W.translate("feat.weaponTrainingBonus",{bonus:Z})}]`;break;case"damage":if(X.weaponSpecialization.includes(Z))Q+=2,Y+=`+ 2[${W.translate("feat.weaponSpecialization")}]`;if(X.weaponSpecializationGreater.includes(Z))Q+=2,Y+=`+ 2[${W.translate("feat.greaterWeaponSpecialization")}]`;if(Object.values(X.weaponGroups).includes(Z))Q+=X.weaponGroups[Z],Y+=`+ 1[${W.translate("feat.weaponTrainingBonus",{bonus:Z})}]`;break;default:break}return[Q,Y]}}class n0 extends g{get parserGroup(){return"Parser/Offense"}get parserType(){return"speed"}async _parse(J,Z,Q){if(J.length<=0)return!0;let Y=J.replace(/(^[,;\s]*|[,;\s]*$)/g,""),X=W.parseSubtext(Y),H=X[0].match(/(\d+)\s(ft\.|feet)/)?.[1],G="";if(H==null)return this.throwParseError(void 0,J,Z,Q),!1;let _=pf1.utils.convertDistance(+H),z=game.i18n.localize(`PF1.Movement.Mode.${Q.toLowerCase()}`)+` ${_[0]} ${_[1]}`;switch(H-=await W.getTotalFromChanges(window.SBC.actor,`${Q}Speed`),H-=await W.getTotalFromChanges(window.SBC.actor,"allSpeeds"),this.app.processData.characterData.conversionValidation.attributes[Q]=+H,await window.SBC.actor.update({[`system.attributes.speed.${Q}.base`]:+H}),Q){case"fly":{if(X.length>1){let K=W.haystackSearch(Object.keys(pf1.config.flyManeuverabilities),X[1]);if(K)await window.SBC.actor.update({["system.attributes.speed.fly.maneuverability"]:K}),z+=` (${game.i18n.localize(`PF1.Movement.FlyManeuverability.Quality.${K.toLowerCase()}`)})`;if(X[2])G=X[2]}break}default:if(X.length>1)G=X[1];break}return this.app.processData.notes.offense.speed.push(z),!0}}var z0=Object.freeze({Constant:"constant",Weekly:"weekly",Monthly:"monthly",Yearly:"yearly",AtWill:"atWill",Daily:"daily"}),_0={};class H0 extends g{get parserGroup(){return"Parser/Offense"}get parserType(){return"spellBook"}async _parse(J,Z,Q=void 0){W.log("Trying to parse the following Spell Book.",J);let{spellCastingType:Y,spells:X,spellBookType:H}=J,G=Y==="prepared"?"Prepared":Y==="points"?"Psychic":"Known";H=await this.setupSpellbook(Y,H,J.spellCastingClass,J.isAlchemist?"extracts":"spells",G,+J.casterLevel,+J.concentrationBonus,J.isSpellLike,J.firstLine,J.spellBookName),_0[H]={},[0,1,2,3,4,5,6,7,8,9].forEach((P)=>{_0[H][P]={},_0[H][P].base=0,_0[H][P].max=0});let _=window.SBC.actor.system.attributes.spells.spellbooks[H],z=[],K=null,q=null,j=_.name,F=H0.getClassPostfixFromSpellbookName(j),L=window.SBC.actor.itemTypes.class.filter((P)=>P.system.casting);L=L.map((P)=>P.system.tag.substring(0,3).toUpperCase()).concat(L.map((P)=>`${P.system.tag[0]}${P.system.tag[2]}${P.system.tag[3]}`.toUpperCase()));let B=J.spellCastingClass.match(I0());if(B)switch(B[0]){case"Abjurer":q="abj",K="Abjuration";break;case"Conjurer":q="con",K="Conjuration";break;case"Diviner":q="div",K="Divination";break;case"Enchanter":q="enc",K="Enchantment";break;case"Evoker":q="evo",K="Evocation";break;case"Illusionist":q="ill",K="Illusion";break;case"Necromancer":q="nec",K="Necromancy";break;case"Transmuter":q="trs",K="Transmuation";break;case"Universalist":default:q="",K="Universalist";break}else if(_.class==="wizard"||j&&j.toLowerCase().includes("wizard"))q="",K="Universalist";if(K==="Universalist")await window.SBC.actor.update({[`system.attributes.spells.spellbooks.${H}.domainSlotValue`]:0});let O=0;for(let P=0;P<X.length;P++)O+=this.splitText(X[P].replace(/(^[^-]*-)/,""),!1).length;let E="";for(let P=0;P<X.length;P++){if(X[P]==="")continue;let M=X[P],R={spellLevel:-1,spellsPerX:"",spellsPerXTotal:-1,isAtWill:!1,frequency:null,isSpellRow:!1,spellRowIsInitialized:!1,wizardSchool:q,isSpellLike:J.isSpellLike};if(this.processSpellRow(M,H,R),this.processFrequencies(M,R),R.isSpellRow){let x={frequency:R.spellLevel===-1?{type:W.translate(`spellFrequencyNoun.${R.frequency}`),amount:R.spellsPerXTotal!==-1?+R.spellsPerXTotal:0}:null,level:+R.spellLevel,levelEnum:W.translate(`spellLevelEnum.${R.spellLevel}`),spells:[]},h=this.splitText(M.replace(/(^[^-]*-)/,""),!1),w=!1,p=0;if(J.isSpellLike)for(let d of h){d=d.replaceAll(/\*/g,"").trim();let[a,C]=H0.processSpellName(d);if(a==="")continue;let e={search:new Set([a,C]),type:"spell",item:a};e.search=W.createSearchSet([a,C],!0,F.concat(L));let[I,r]=await this.findSpellEntities(e),o=await W.generatePlaceholderEntity(e,Z),b=W.checkForDuplicateItem(window.SBC.actor,"feat","misc",a,o);if(!(!I&&r)&&!(r&&O===1)&&!(!r&&b))p++}w=J.isSpellLike?p===0:!1,await W.runParallelOps(h,async(d)=>{if(w)O--;await this.processSpell(d.replaceAll(/\*/g,"").trim(),R,H,Y,F,L,Z,x,w)}),z.push(x)}else E=await this.parseSpellbookSpecials(M,Z,H);let T={};[0,1,2,3,4,5,6,7,8,9].forEach((x)=>{T[`system.attributes.spells.spellbooks.${H}.spells.spell${x}.base`]=_0[H][x].base,T[`system.attributes.spells.spellbooks.${H}.spells.spell${x}.max`]=_0[H][x].max}),await window.SBC.actor.update(T)}if(K){let M=window.SBC.compendiumSearch,R={search:new Set([`${K} School`,K]),type:"feat",item:K},T={itemType:"feat",itemSubType:"classFeat",classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race},x=window.SBC.actor,h=await M.findEntityInCompendia(R,T),w=x.itemTypes.feat.filter((p)=>p.system.subType==="classFeat").find((p)=>p.name===p.name===h?.name);if(R.search.clear(),h){if(!w||w&&h.flags.core?.sourceId!==w.flags.core?.sourceId)await W.addAssociatedClass(h,x.itemTypes.class),await D(h)}}let N=window.SBC.actor.system.attributes.spells.spellbooks[H];if(W.log(N),!O)await window.SBC.actor.update({[`system.attributes.spells.spellbooks.${H}`]:H0.getDefaultSpellbookData()});return this.app.processData.notes.offense.spellBooks.push({name:J.firstLine.split("(")[0].trim(),cl:+J.casterLevel,asf:N.arcaneSpellFailure?window.SBC.actor.spellFailure:0,concentration:(+J.concentrationBonus>=0?"+":"")+ +J.concentrationBonus,spellRows:z,specialRow:E}),W.log(z),[!0,H,O!==0]}async setupSpellbook(J,Z,Q,Y,X,H,G,_,z,K){let q=0,j=!1,F=!0,L={domainSlotValue:q,psychic:j,spellPreparationMode:J,inUse:!0},B=window.SBC.actor;if(!B.system.attributes.spells.spellbooks[Z])L=foundry.utils.mergeObject(H0.getDefaultSpellbookData(),L);let O=Q.match(I0())?"wizard":Q;if(_){let E=+H===B.system.attributes.hd.total;L=foundry.utils.mergeObject(L,{ability:"cha",autoSpellLevelCalculation:!1,class:E?"_hd":"","cl.formula":E?"":`${H}`,arcaneSpellFailure:!1,name:W.capitalize(z.match(/^(.*?)\(/)[1].trim()),kind:"arcane",hasCantrips:F})}else if(J==="points"){let E=B.system.abilities;L=foundry.utils.mergeObject(L,{arcaneSpellFailure:!1,autoSpellLevelCalculation:!1,class:"_hd",name:W.translate("spellbookName.psychicMagic"),kind:"psychic",hasCantrips:!0,isPsychic:!0,spellPreparationMode:"spontaneous",spellPoints:{useSystem:!0,maxFormula:"0",max:0},ability:E.int.total>=E.cha.total?"int":"cha"})}else L=foundry.utils.mergeObject(L,{class:O.toLowerCase(),name:Q.capitalize()+" "+W.translate(`spellbookName.${Y}`)+" "+X});if(["hd","_hd"].includes(Q)===!1){let E=B.itemTypes.class.filter((N)=>N.name.toLowerCase()===Q.toLowerCase()||N.system.tag===Q.toLowerCase())[0]??null;if(E){H=E.system.level+(isNaN(E.system.casting.offset)?0:E.system.casting.offset),Q=E.system.tag;let N=H0.getHighestSpellLevelFreeSlots(Q,E.system.level);if(delete L.name,L=foundry.utils.mergeObject(L,{class:Q,kind:E.system.casting.spells,ability:E.system.casting.ability,arcaneSpellFailure:E.system.casting.spells==="arcane",domainSlotValue:E.system.casting.domain,casterType:E.system.casting.progression,hasCantrips:E.system.casting.cantrips,autoSpellLevelCalculation:!0,"cl.-=autoSpellLevelCalculationFormula":"",psychic:E.system.casting.spells==="psychic",spellPreparationMode:E.system.casting.type,spells:N,inUse:!0}),!_){let P=B.itemTypes.class.filter((M)=>M.system.subType==="prestige"&&M.system.tag!==E.system.tag&&!this.app.processData.characterData.prestigeClassCasting.has(M.system.tag));if(P.length>0)for(let M of P){let R=Object.keys(Q1).find((x)=>x.toLowerCase()===M.name.toLowerCase()),T=Q1[`${R}`];if(T?.offset){if(T.castingType){if(T.castingType.includes(L.kind)===!1)continue}if(T.castingClass){if(T.castingClass.includes(L.class)===!1)continue}delete L["cl.-=autoSpellLevelCalculationFormula"],L=foundry.utils.mergeObject(L,{"cl.autoSpellLevelCalculationFormula":T.offset});let x=await W.processFormula(T.offset,B);H+=x.total,this.app.processData.characterData.prestigeClassCasting.set(M.system.tag,Z)}}}}}else if(Q==="hd")L=foundry.utils.mergeObject(L,{class:"_hd",ability:"cha"});if(K)L.name=K;return this.app.processData.characterData.conversionValidation.spellBooks[Z]={casterLevel:+H,concentrationBonus:+G},await B.update({[`system.attributes.spells.spellbooks.${Z}`]:L}),Z}async processSpellRow(J,Z,Q){let Y;if((Y=J.match(/^(\d+)\s*\bPE\b/))!==null){let X=Y[1];await window.SBC.actor.update({[`system.attributes.spells.spellbooks.${Z}.spellPoints`]:{maxFormula:X,value:+X}}),Q.isSpellRow=!0}else if((Y=J.match(/(\d+)\s*(?!rounds)?\/(?:day|week|month|year)/i))!==null)Q.spellsPerXTotal=Y[1],Q.isSpellRow=!0;else if((Y=J.match(/(^\d)/))!==null)Q.spellLevel=Y[1],Q.isSpellRow=!0;else if((Y=J.match(/\d+\/([a-zA-Z]*)\)*-/))!==null)Q.spellsPerX=Y[1]}processFrequencies(J,Z){switch(!0){case/Constant/i.test(J):Z.isSpellRow=!0,Z.frequency=z0.Constant,Z.isAtWill=!0;break;case/At[- ]will/i.test(J):Z.isSpellRow=!0,Z.frequency=z0.AtWill,Z.isAtWill=!0;break;case/\d+\s*(?:rounds)?\/day/i.test(J):Z.frequency=z0.Daily;break;case/\d+\s*(?:rounds)?\/week/i.test(J):Z.frequency=z0.Weekly;break;case/\d+\s*(?:rounds)?\/month/i.test(J):Z.frequency=z0.Monthly;break;case/\d+\s*(?:rounds)?\/year/i.test(J):Z.frequency=z0.Yearly;break;default:}}async processSpell(J,Z,Q,Y,X,H,G,_,z){let[K,q,j,F,L]=H0.processSpellName(J);if(K==="")return;let[B,O]=[null,null],E={search:new Set([K,q]),type:"spell",item:K};E.search=W.createSearchSet([K,q],!0,X.concat(H));let[N,P]=await this.findSpellEntities(E),M=z||!N?P:N;if(M===null)if(!z)M=await W.generatePlaceholderEntity(E,G);else E.type="classFeat",M=await W.generatePlaceholderEntity(E,G);let R=W.checkForDuplicateItem(window.SBC.actor,"feat","classFeat",K,M);if(!R)R=W.checkForDuplicateItem(window.SBC.actor,"feat","misc",K,M);let T=-1,x=j.match(/\bDC\b\s*(\d+)(?:,\s)?/);if(x)T=x[1],j=j.replace(x[0],"").trim();let h=j.match(/(?<![+-]\s*\d*\s*|level\s*)\b(\d+)\b(?!\s*d\s*\d*\s*[+-]|\s*lbs|\s*kg|\s*%|\s*rounds)[,)]?/i),w=1;if(h)w=parseInt(h[1]),j=j.replace(h[1],"").replace(/[,;]\s*$/,"").trim();if(j!=="")J=W.capitalize(K)+" ("+j+")";else J=W.capitalize(K);if(M.type==="feat"||R){if(!R)await W.addAssociatedClass(M,window.SBC.actor.itemTypes.class),M.name=J,[B,O]=await D(M);else O=R;await H0.setFeatureUses(O,w,Z.frequency),await O.update({name:J}),_.spells.push({name:O.name,prepCount:1,dc:-1,domain:!1});return}if(Z.wizardSchool&&Z.wizardSchool===M.system.school)F=!0;let p={name:J,"system.spellbook":Q};if(L)p.name+=" (Mythic)";if(Z.spellLevel!==-1)p["system.level"]=+Z.spellLevel;let d=J.match(/(\d+)\s*PE/);if(d!==null)p["spellPoints.cost"]=`${d[1]}`;switch(await this.processSpellSlots(Z,M,p,Q,Y,w,F),p["system.atWill"]=Z.isAtWill&&(M.system.level>0||Z.isSpellLike),Z.frequency){case z0.Constant:case z0.Weekly:case z0.Monthly:case z0.Yearly:p.name=W.translate(`spellFrequency.${Z.frequency}`)+": "+M.name;break;default:break}if(F)Object.assign(p,{"system.domain":!0,"system.slotCost":1});await M.updateSource(p),W.log("Spell Updates",p);try{[B,O]=await D(M)}catch(a){console.error(a)}await O.update(p),await this.processSpellDC(O,T,Q),_.spells.push({name:O.name,prepCount:w,dc:T,domain:!M.system?.school?F:!1})}async processSpellSlots(J,Z,Q,Y,X,H,G){let _=window.SBC.actor;if(!J.spellRowIsInitialized)await _.update({[`system.attributes.spells.spellbooks.${Y}.spells.spell${Z.system.level}.base`]:0}),J.spellRowIsInitialized=!0;if(!J.isAtWill&&!J.isConstant){if(J.spellsPerXTotal!==-1&&J.isSpellLike){if(Object.assign(Q,{"system.uses.max":+J.spellsPerXTotal,"system.uses.value":+J.spellsPerXTotal,"system.uses.per":J.spellsPerX,"system.preparation.max":+J.spellsPerXTotal,"system.preparation.value":+J.spellsPerXTotal}),Z.system.level===0)Object.assign(Q,{"system.uses.autoDeductChargesCost":"1"});_0[Y][`${Z.system.level}`].base+=+J.spellsPerXTotal,_0[Y][`${Z.system.level}`].max+=+J.spellsPerXTotal}else if(J.spellsPerXTotal!==-1&&X==="spontaneous"&&!J.isSpellLike)_0[Y][`${Z.system.level}`].base=+J.spellsPerXTotal,_0[Y][`${Z.system.level}`].max=+J.spellsPerXTotal;else if(X==="prepared"&&J.spellsPerXTotal===-1)Object.assign(Q,{"system.preparation.max":H,"system.preparation.value":H}),_0[Y][`${Z.system.level}`].base+=H,_0[Y][`${Z.system.level}`].max+=H;if(G)_0[Y][`${Z.system.level}`].base-=1,_0[Y][`${Z.system.level}`].max-=1}else if(Z.system.level===0&&X==="prepared")Object.assign(Q,{"system.preparation.max":H,"system.preparation.value":H})}async processSpellDC(J,Z,Q){let Y,X=window.SBC.actor.system.attributes.spells.spellbooks[Q].ability,H=window.SBC.actor.system.abilities[X].mod,G=10+ +J.system.level+ +H;if(Y=+Z-+G,Z!==-1&&J.system.actions.length>0){let _=J.system.actions,z=J.actions.get(J.actions.contents[0].id);if(z)await z.update({"save.dc":Y}),_[0]=z,await J.update({"system.actions":_})}}async parseSpellbookSpecials(J,Z,Q){let Y=null,X="",H="",G,_=0,K=window.SBC.compendiumSearch,q={search:new Set,type:"feat"},j={itemType:"feat",itemSubType:"classFeat",classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race},F=window.SBC.actor;do{if((G=J.match(/(?!Domain spell)Domains?\s*(.*?)(?:;|$)/i))!==null||(G=J.match(/Domain\s*spells*\s*\((.*?)\)\s*(?:;|$)/i))!==null){X=W.translate("spellFeature.domain")+": ",Y={label:X.replace(":",""),value:G[1]};for(let L of G[1].split(",")){L=W.parseSubtext(L)[0];let B=L.match(/\((.*) subdomain\)/i);if(B)q.search.add(`${B[1].capitalize()} Subdomain`),q.search.add(B[1].capitalize());else q.search.add(`${L.capitalize()} Domain`),q.search.add(`${L.capitalize()} Subdomain`),q.search.add(L.capitalize());q.item=L;let O=await K.findEntityInCompendia(q,j);if(q.search.clear(),O)await W.addAssociatedClass(O,F.itemTypes.class),await D(O);else X+=`${L}, `,_++}X=_>0?X.slice(0,-2):"",H="domains";break}if((G=J.match(/Myster[y|ies]\s*(.*?)(?:;|$)/i))!==null){X=W.translate("spellFeature.mystery")+": ",Y={label:X.replace(":",""),value:G[1]};for(let L of G[1].split(",")){L=W.parseSubtext(L)[0],q.search.add(`${L.capitalize()} Mystery`),q.search.add(L.capitalize()),q.item=L;let B=await K.findEntityInCompendia(q,j);if(q.search.clear(),B)await W.addAssociatedClass(B,F.itemTypes.class),await D(B);else X+=`${L}, `,_++}X=_>0?X.slice(0,-2):"",H="mysteries";break}if((G=J.match(/(?!Spirit magic spell)Spirits?\s*(.*?)(?:;|$)/i))!==null){X=W.translate("spellFeature.spirit")+": ",Y={label:X.replace(":",""),value:G[1]};for(let L of G[1].split(",")){L=W.parseSubtext(L)[0],q.search.add(`${L.capitalize()} Spirit`),q.search.add(L.capitalize()),q.item=L;let B=await K.findEntityInCompendia(q,j);if(q.search.clear(),B)await W.addAssociatedClass(B,F.itemTypes.class),await D(B);else X+=`${L}, `,_++}X=_>0?X.slice(0,-2):"",H="spirits";break}if((G=J.match(/Bloodlines?\s*(.*?)(?:;|$)/i))!==null){X=W.translate("spellFeature.bloodline")+": ",Y={label:X.replace(":",""),value:G[1]};for(let L of G[1].split(",")){L=W.parseSubtext(L)[0],q.search.add(`${L.capitalize()} Bloodline`),q.search.add(L.capitalize()),q.item=L;let B=await K.findEntityInCompendia(q,j);if(q.search.clear(),B)await W.addAssociatedClass(B,F.itemTypes.class),await D(B);else X+=`${L}, `,_++}X=_>0?X.slice(0,-2):"",H="bloodlines";break}if((G=J.match(/Patrons?\s*(.*?)(?:;|$)/i))!==null){X=W.translate("spellFeature.patron")+": ",Y={label:X.replace(":",""),value:G[1]};for(let L of G[1].split(",")){L=W.parseSubtext(L)[0],q.search.add(`${L.capitalize()} Patron`),q.search.add(L.capitalize()),q.item=L;let B=await K.findEntityInCompendia(q,j);if(q.search.clear(),B)await W.addAssociatedClass(B,F.itemTypes.class),await D(B);else X+=`${L}, `,_++}X=_>0?X.slice(0,-2):"",H="patrons";break}if((G=J.match(/(Opposition|Prohibited) Schools\s(.*?)(?:;|$)/i))!==null){let[L,B,O]=G;X=W.translate(`spellFeature.${B.toLowerCase()}`)+": "+O,H="oppositions"}if((G=J.match(/Thassilonian Specialization\s*(.*?)(?:;|$)/i))!==null){if(X=W.translate("spellFeature.thassilonianSpecialist")+": ",G[1])await F.update({[`system.attributes.spells.spellbooks.${Q}.domainSlotValue`]:2});Y={label:X.replace(":",""),value:G[1]};for(let L of G[1].split(",")){L=W.parseSubtext(L)[0],q.search.add(`${L.capitalize()} School`),q.search.add(L.capitalize()),q.item=L;let B=await K.findEntityInCompendia(q,j);if(q.search.clear(),B)await W.addAssociatedClass(B,F.itemTypes.class),await D(B);else X+=`${L}, `,_++}X=_>0?X.slice(0,-2):"",H="thassilonianSpecialist";break}if((G=J.match(/Inquisitions?\s*(.*?)(?:;|$)/i))!==null){X=W.translate("spellFeature.inquisition")+": ",Y={label:X.replace(":",""),value:G[1]};for(let L of G[1].split(",")){L=W.parseSubtext(L)[0],q.search.add(`${L.capitalize()} Inquisition`),q.search.add(L.capitalize()),q.item=L;let B=await K.findEntityInCompendia(q,j);if(q.search.clear(),B)await W.addAssociatedClass(B,F.itemTypes.class),await D(B);else X+=`${L}, `,_++}X=_>0?X.slice(0,-2):"",H="inquisition";break}}while(!1);if(X!==""){let L=await W.generatePlaceholderEntity({name:X,type:H},Z);await D(L)}return Y}static processSpellName(J){let Z=!1,Q=!1,Y=W.parseSubtext(J),X=Y[0].trim(),H=Y[1]?.trim()??"",G=J.replace(new RegExp(`(${Q0(X)}\\s|\\(${Q0(H)}\\))`,"g"),"").trim(),_=X;if(X==="")return[X,_,H,Z,Q];if(X.endsWith("D"))Z=!0,X=X.substring(0,X.length-1);else if(H.endsWith("D"))Z=!0,H=H.substring(0,H.length-1);else if(G.endsWith("D"))Z=!0;if(X.endsWith("M"))Q=!0,X=X.substring(0,X.length-1);else if(H.endsWith("M"))Q=!0,H=H.substring(0,H.length-1);else if(G.endsWith("M"))Q=!0;let z=X.match(new RegExp(`(${O0.join("\\b|\\b")})`,"gi"));if(z)_=X.replace(new RegExp(`(${z.join("\\b|\\b")})`,"gi"),"").trim();return[X,_,H,Z,Q]}async findSpellEntities(J,Z="both"){let Y=window.SBC.compendiumSearch,[X,H]=[null,null];if(Z==="both"||Z==="spell")X=await Y.findEntityInCompendia(J,{itemTypes:["spell"]});if(Z==="both"||Z==="classFeat")H=await Y.findEntityInCompendia(J,{itemTypes:["feat"],itemSubTypes:["classFeat","misc"],race:this.app.processData.characterData.race});return[X,H]}static getDefaultSpellbookData(){return{name:"",inUse:!1,castPerDayAllOffsetFormula:"",preparedAllOffsetFormula:"",casterType:"high",class:"",cl:{formula:"",total:0},concentrationFormula:"",concentrationNotes:"",clNotes:"",ability:"int",autoSpellLevelCalculation:!0,autoSpellLevels:!0,psychic:!1,arcaneSpellFailure:!0,hasCantrips:!0,spellPreparationMode:"spontaneous",baseDCFormula:"10 + @sl + @ablMod",spellPoints:{useSystem:!1,value:0,maxFormula:"",restoreFormula:""},spells:{spell0:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell1:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell2:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell3:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell4:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell5:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell6:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell7:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell8:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell9:{castPerDayOffsetFormula:"",preparedOffsetFormula:""}},spellSlotAbilityBonusFormula:"",domainSlotValue:1,concentration:{total:0},isSchool:!0}}static getClassPostfixFromSpellbookName(J){if(!J)return[];if(J=J.toLowerCase(),J.includes("domain"))return["CLE","DRU","INQ"];else if(J.includes("bloodline"))return["SOR","BLO"];else if(J.includes("school"))return["WIZ"];else if(J.includes("mystery"))return["ORA"];else if(J.includes("patron"))return["WIT"];else if(J.includes("spirit"))return["SHA"];else return[]}static getHighestSpellLevelFreeSlots(J,Z){let Q=0;switch(J){case"bloodrager":Q=Math.max(0,Math.ceil((Z-6)/3));break;case"sorcerer":Q=Math.max(0,Math.ceil(Z-2)/2);break;case"oracle":Q=Math.max(0,Math.floor(Z/2));break;case"psychic":Q=Math.max(1,Math.floor(Z/2));break;default:break}let Y={};if(Q>0)for(let X=1;X<=Q;X++)Y[`spell${X}.preparedOffsetFormula`]="1";return Y}static async setFeatureUses(J,Z,Q){let Y={"system.uses.value":Z,"system.uses.max":Z};if(!J.system.uses.maxFormula)Y["system.uses.maxFormula"]=`${Z}`;switch(Q){case z0.Weekly:Y["system.uses.per"]="week";break;default:Y["system.uses.per"]="day";break}await J.update(Y)}}class q0 extends g{constructor(J,Z,Q,Y){super(J);this.targetValueFields=Z,this.targetModFields=Q,this.supportedType=Y}async parse(J,Z){if(W.log(W.translate("parser.ability.status",{value:J,fields:this.targetValueFields.join(", ")})),typeof J===this.supportedType)try{for(let Q of this.targetValueFields)await F0(window.SBC.actor,Q,J);return!0}catch(Q){return this.throwError(Q,"parser.ability.error",J,Z,{fields:this.targetValueFields.join(", "),modValue:W.getModifier(J),modFields:this.targetModFields.join(", ")}),!1}else return this.throwError(void 0,"parser.ability.typeError",J,Z,{type:this.supportedType}),!1}}class s0 extends g{get parserGroup(){return"Parser/Statistics"}get parserType(){return"gear"}async _parse(J,Z,Q=void 0){let X=window.SBC.compendiumSearch;if(J==="none")return!0;J=J.replace(/\b(?:and|with)\s*(\d+)/gi,", $1").replace(/ioun stones \([^)]+\)/i,(K)=>K.substring(K.indexOf("(")+1,K.length-1).split(",").map((q)=>{return q.split("[")[0].trim()+" Ioun Stone"}).join(", ")).replace(/(scrolls \([^)]+\))/gi,(K)=>{return K.substring(9,K.length-1).split(/,? and |, /g).map((q)=>"scroll of "+q).join(", ")}).replace(/implanted ioun stones? \(((?:[^,)]+,?)+)\)/gi,(K)=>K.substring(0,K.length-1).split("(")[1].split(",").map((q)=>{let j=q.match(/(\d+)/)?.[1]||1;return`Ioun Stone ${q.replace(/\d+/,"").trim().replace(/s$/,"")} (${j}, Implanted)`}).join(", "));let H={pp:0,gp:0,sp:0,cp:0},G=this.splitText(J,!1),_=[],z=["consumable","equipment","loot","weapon","container","implant"];if(await W.runParallelOps(G,async(K)=>{let q=!1,j=null;if(K=K.trim().replaceAll("*","").replaceAll("[","(").replaceAll("]",")").replace(/(\d+)\s*doses(?! of)/i,"$1").replace(/^pair of /i,"2 ").replace(/\(as\s+(?:an?\s+)?/i,"(").replace(/^And\s/i,""),/^\d+\s/.test(K)&&!W.getMoneyFromString(K))K=K.replace(/^(\d+)(.*)/,"$2 ($1)").trim();let F=0,L=!1;if(K.match(/\d+\s+[pscg]p\s+in\b/i)){let v;[v,K]=K.split(/\bin\b/i),K=`${K} worth ${v}`}if(K.match(/\bworth\b/i)){let v;[K,v]=K.split(/\bworth\b/i);let{worth:U,rest:S}=/(?<worth>(?:\s*\d+\s*[pgsc]p\s*){1,4})(?:each|for the pair|total|in all)?(?<rest>.*)/g.exec(v).groups;L=U.match(/for the pair|total|in all/i)!==null,K=(K+S).replace(/,\s*,\s*/g,", ").replace(/\(\s*,\s*/g,"(").replace(/\s*,\s*\)/g,")").replace(/\s{2,}/," ").replace(/\(\s*\)/g,"").trim().trim(),F=W.convertMoneyToGold(W.getMoneyFromString(U))}let B=0;if(/\+?\d+ Str\b/i.test(K))B=+K.match(/(\d+) Str\b/i)[1].trim(),K=K.replace(/\s*\(\+?\d+ Str\)/i,"").trim();let O=W.parseSubtext(K),E=O[0],N=O[1],P=new Set([K,E,N].filter((v)=>v));if(P.add(E.replace(/(^\d+|masterwork|mwk)/g,"").trim()),j=K?.match(/(?:\b|\()(?:focus\s+)?for\b/)){q=!0;let v=K.split(j[0])[0].trim();P.add(v)}let M=1,R="",T="",x=[],h=0,w={},p=window.SBC.actor.system.traits.size.base||"med",d="",a=null;[...P].forEach((v)=>{P.add(v.replace(/s of\b/i," of"))});let C=window.SBC.config.sillyGear,e=Object.keys(C);if([...P].forEach((v)=>{let U=W.haystackRegexSearch(e,v);if(U){let S=new RegExp(U,"i");P.add(v.replace(S,C[U])),q=!0}}),[...P].forEach((v)=>{if(j=v.match(/(\d+) charges?/i))a=+j[1],P.add(v.replace(j[0],"").replace(/\(\s*,\s*/,"(").replace(/\(\s*\)/,"").trim())}),[...P].forEach((v)=>{if((j=v.match(R0()))!==null)p=W.getKeyByValue(pf1.config.actorSizes,j[0])||"med",P.add(v.replace(j[0],"").trim())}),[...P].forEach((v)=>{if((j=v.match(YJ()))!==null)P.add(v.replace(j[0],"").trim()),d=j[0]}),N?.length){let v=K.match(/\((\d+)\s*(?:\)\s*$|,\s*)/);if(v)M=+v[1],P.add(N.replace(new RegExp(`^${v[1]}`),"").replace(/^\s*,\s*/,"").trim()),P.add(K.replace(new RegExp(`\\(\\s*${v[1]}`),"(").replace(/\(\s*,\s*/,"(").replace("()","").trim())}if([...P].forEach((v)=>{if(v.toLowerCase().includes("rod")&&v.toLowerCase().includes("metamagic")){let U=v.match(/(lesser|normal|greater)/i)?.[0]||"";if(v=v.replace(/rod(?: of)?/i,"").replace(/metamagic/i,"").replace(U,"").trim(),v.toLowerCase().includes("elemental"))v="Elemental",q=!0;v=`${v} Metamagic Rod, ${W.capitalize(U)}`,P.add(v)}}),[...P].forEach((v)=>{let U;if(U=v.toLowerCase(),U.includes("holy symbol")){let S=U.match(/\b(?:wood|silver|gold|iron|platinum|flask|tattoo)/gi)?.[0]||"wood";if(U.startsWith(S.toLowerCase()))U=U.split(" ").slice(1).join(" ");if(U.includes("unholy"))q=!0;if(!U.split(" ")[0].includes("holy"))q=!0,S="iron";if(U.includes(" of "))q=!0;P.add(`Holy Symbol (${S.capitalize()})`)}}),[...P].forEach((v)=>{if((j=v.match(G1()))!==null)P.add(v.replace(G1(),"").trim()),P.add(v.replace(G1(),"").trim()+` (${j[0]})`)}),[...P].forEach((v)=>{if((j=v.match(s1()))!==null)P.add(v.replace(j[0],"").trim()+` (${j[0]})`),P.add(v.replace(j[0],"").trim()+` ${j[0]}`)}),[...P].forEach((v)=>{if((j=a1().exec(v))!==null)P.add(`${j[2]} (${j[1]})`),P.add(j[2])}),[...P].forEach((v)=>{if(v.search(l1())!==-1){let U=v.match(f0());R=U?U[0]:R,R=pf1.registry.materials.contents.find((S)=>S.name===W.capitalize(R??"")||S.id===R)?.id??null,P.add(v.replace(f0(),"").replace(/\s{2,}/," ").trim())}}),K.match(/amulet of mighty fist/i)){h=+K.match(/\+[12345]/)?.[1]||0;let v=x1();while((j=v.exec(K))!==null){let U=j.groups,S=W.getMagicAbility(U.ability,U.prefix||U.postfix||void 0);w[S.name]=S}q=!0,P.add("Amulet of Mighty Fists"+(h?` +${h}`:"+1")),F=this.calculateItemPrice({name:"",type:"weapon",system:{price:0}},{material:null,addons:[],enhancementValue:h,enhancementTypes:Object.values(w)})*2}else[...P].forEach((v)=>{if(v.match(/\+[12345]/)&&!v.match(/\d$/))h=+v.match(/[12345]/)[0].trim(),v=v.replace(/\+[12345]/,"").trim(),P.add(v);if(h){let U=x1(),S=v;while((j=U.exec(S))!==null){let t=j.groups,k=W.getMagicAbility(t.ability,t.prefix||t.postfix||void 0);if(k.hasSpecialTerm)if(t.ability.toLowerCase()==="bane"){let[l,c]=W.extractCreatureTypeInfo(v);v=v.replace(l,"").replace(c,"").replace(`-${t.ability}`,"").trim(),k.specialTerm=`${l} ${c}`}else{let l=v.match(new RegExp("\\b(?:([a-z-]+)[- ])?"+k.name+"(?: \\(([^)]+)\\))?","i")),c=l[1]||l[2];if(c)k.specialTerm=c;v=v.replace(l[0],"")}else v=v.replace(j[0],"");P.add(v.replace(/\s{2,}/g," ").trim()),w[k.name]=k}}});[...P].forEach((v)=>{if((j=e1().exec(v))!==null)P.add(v),P.add(v.replace(j[0],"").trim()),q=!0}),[...P].forEach((v)=>{P.add(v.replace(/\W?(Integrated|Implanted|Timeworn)\W?/gi,""))}),[...P].forEach((v)=>{if(v.includes("ironwood"))P.add(v.replace(/\bironwood\b\s+/i,"")),T="iron",q=!0}),this.handleSpecialCases(P,N),[...P].forEach((v)=>{if(v.search(/\b(?:physical might|mental prowess)\b/i)!==-1)v=v.replace(/Intelligence/i,"Int").replace(/Wisdom/i,"Wis").replace(/Charisma/i,"Cha").replace(/Strength/i,"Str").replace(/Dexterity/i,"Dex").replace(/Constitution/i,"Con"),P.add(v.replace(/(Str|Dex|Con|Int|Wis|Cha),\s*(Dex|Con|Wis|Cha)/i,"$1 & $2")),q=!0}),[...P].forEach((v)=>{if(v.search(M0())!==-1)x=v.match(M0()).map((S)=>{let t=S[0]+S.slice(1).replace(/\s/,"");return pf1.registry.materials.find((k)=>k.id===t||k.name.toLowerCase()===S.toLowerCase())?.id??null}).filter((S)=>!!S),P.add(v.replace(M0(),""))});let I={type:"loot",name:E.replace(/^([\d+]+|\b(?:masterwork|mwk|broken|timeworn)\b)/gi,"").trim(),rawName:M>1?this.stripQuantity(W.singularize(K)):K,subtext:N,price:L?F/M:F,value:0,size:p,fluffTerm:d,enhancementValue:h,enhancementTypes:Object.values(w),maxStrength:B,charges:a,mwk:/\bmasterwork\b|\bmwk\b/i.test(E)||h>0,quantity:M,timeworn:/\btimeworn\b/i.test(E),broken:/\bbroken\b/i.test(E),material:R,baseMaterial:T,addons:x,implanted:null};[...P].forEach((v)=>{P.add(v?.replace(/ies\s*$/gi,"y")),P.add(v.replace(/ives/gi,"ife")),P.add(v?.replace(/(?!Charges)s\s*$/gi,""))}),console.log(K,P);let r=Object.keys(I),o={},b=W.getMoneyFromString(E);if(b){H.pp+=b.pp,H.gp+=b.gp,H.sp+=b.sp,H.cp+=b.cp;return}else if(H1().test(E)){H1().lastIndex=0,I.type="consumable";let v=E.match(H1()),U=this.getConsumableType(v[1]?.toLowerCase()),S=v[2].replace(/\+\d+/,"").trim(),t=v[2].match(/\+(\d+)/)?.[1]??0,k=parseInt(N?.match(/(\d+) charges/i)?.[1]??(/wand/i.test(U)?50:1)),l=N?.match(/CL\s*(\d+)/i)?.[1]??-1,c=null;if(o=await X.findEntityInCompendia({search:new Set([`${U} of ${S}`]),item:`${U} of ${S}`},{itemType:"consumable"}),!o){if(o=await X.findEntityInCompendia({search:new Set([S,W.singularize(S)]),item:S},{itemType:"spell"}),o){let m=o.toObject();if(t){let y=await X.findEntityInCompendia({search:m.name,item:m.name},{itemType:"buff"});if(y){let i=y.system.changes[0].formula;for(let $0=1;$0<=20;$0++)if((await new pf1.dice.RollPF(i,{item:{level:$0}}).evaluate()).total===+t){m.cl=$0;break}}}c=await CONFIG.Item.documentClasses.spell.toConsumable(m,U==="oil"?"potion":U)}}else c=o;if(c){if(U==="wand")I.charges=k;if(l>0)c.system.cl=parseInt(l);if(t)c.name+=` +${t}`,I.enhancementValue=0;if(U==="oil")c.name=c.name.replace("Potion","Oil"),c.system.unidentified.name=c.system.unidentified.name.replace("Potion","Oil");o=new Item.implementation(c)}}else if(o=await X.findEntityInCompendia({search:P,item:K},{itemTypes:z}),o?.type==="implant")I.implanted=!0;if(N&&o?.name?.toLowerCase()===N.toLowerCase())q=!0;if(o&&Object.keys(o).length!==0){let v=q?W.capitalize(I.rawName):this.buildItemName(o,I),U=this.calculateItemPrice(o,I);if(o.system.price!==U)I.price=U;let S={name:v,"system.identifiedName":v};for(let t=0;t<r.length;t++){let k=r[t],l=I[k];if(!l||Array.isArray(l)&&!l.length)continue;switch(k){case"implanted":if(J!==null)S["system.implanted"]=l;break;case"charges":if(o.system?.uses?.per==="charges")S["system.uses.value"]=l;break;case"material":{let c=pf1.registry.materials.get(l)||null;if(!c)break;let m=Array.isArray(c.baseMaterial)?c.baseMaterial:[c.baseMaterial],y=I.baseMaterial||o.system?.material?.base?.value||o.system?.armor?.material?.base?.value;switch(y=m.includes(y)?y:m[0],o.type){case"weapon":S["system.material.normal.value"]=l,S["system.material.base.value"]=y;break;case"equipment":if(["armor","shield"].includes(o.system.subType))S["system.armor.material.normal.value"]=l,S["system.armor.material.base.value"]=y;break}Object.assign(S,this.applyMaterialInfo(o,I,I.material));break}case"size":S["system.size"]=l;break;case"maxStrength":if(o.type==="weapon"){let c=o.toObject().system.actions??[];c.forEach((m)=>setProperty(m,"ability.max",l)),S["system.actions"]=c}break;case"addons":{switch(o.type){case"weapon":S["system.material.addon"]=l;break;case"equipment":if(["armor","shield"].includes(o.system.subType))S["system.armor.material.addon"]=l;break}l.forEach((c)=>Object.assign(S,this.applyMaterialInfo(o,I,c)));break}case"enhancementTypes":{let c=o.system.description.value,m=+(I.enhancementValue||0)*3,y=[];if(l.forEach((i)=>{m=Math.max(m,i.cl),y.push(i.aura),c+=`
<h3>`+W.translate(`specialAbilities.${i.name}.name`)+`</h3>
`+W.translate(`specialAbilities.${i.name}.description`)}),S["system.description.value"]=c,S["system.cl"]=m,y=y.filter((i,$0)=>y.indexOf(i)===$0),y.length===1)S["system.aura.school"]=y[0];else S["system.aura.custom"]=!0,S["system.aura.school"]=y.map((i)=>W.translate(`auras.${i}`)).join(", ");break}case"enhancementValue":switch(o.type){case"weapon":S["system.enh"]=+l,S["system.masterwork"]=!0,S["system.aura.school"]="evo";break;case"equipment":S["system.armor.enh"]=+l,S["system.masterwork"]=!0,S["system.aura.school"]="abj";break}S["system.hardness"]=o.system.hardness+l*2,S["system.hp.max"]=o.system.hp.max+l*10,S["system.hp.value"]=o.system.hp.value+l*10,S["system.cl"]=+l*3;break;case"price":S["system.price"]=+l;break;case"mwk":S["system.masterwork"]=l;break;case"value":S["system.price"]=+l;break;case"quantity":S["system.quantity"]=+l;break;case"timeworn":S["system.timeworn"]=l;break;case"broken":S["system.broken"]=l;break;default:break}}if(Object.keys(S).length)console.log(W.translate("parser.gear.parseInfo"),S),await o.updateSource(S);await D(o)}else{I.name=K;let v=await W.generatePlaceholderEntity(I,Z);await D(v),_.push(I.name)}}),H.pp||H.gp||H.sp||H.cp){let K=((H.pp?W.translate("money.pp",{value:H.pp}):"")+" "+(H.gp?W.translate("money.gp",{value:H.gp}):"")+" "+(H.sp?W.translate("money.sp",{value:H.sp}):"")+" "+(H.cp?W.translate("money.cp",{value:H.cp}):"")).replace(/\s{2,}/," ").trim(),q={type:"container",name:W.translate("moneyPouch",{money:K}),currency:H},j=await W.generatePlaceholderEntity(q,Z);await D(j)}if(_.length>0)this.logInfo("parser.gear.generatedPlaceholders",_[0],Z,{items:_.join(", ")});return this.app.processData.notes.statistics.gear=this.getItemNotes(),!0}applyMaterialInfo(J,Z,Q){let Y={},X=pf1.registry.materials.get(Q)||null;if(!X)return Y;if(X.hardness)Y["system.hardness"]=X.hardness+Z.enhancementValue*2;if(X.healthMultiplier)Y["system.hp.max"]=Math.max(1,Math.floor(J.system.hp.max*X.healthMultiplier)+Z.enhancementValue*10),Y["system.hp.value"]=Math.max(1,Math.floor(J.system.hp.value*X.healthMultiplier)+Z.enhancementValue*10);if(X.masterwork)Y["system.masterwork"]=!0;if(X.weight.multiplier!==1)Y["system.weight.value"]=J.system.weight*X.weight.multiplier;if(X.weight.bonusPerPound)Y["system.weight.value"]=J.system.weight*(1+X.weight.bonusPerPound);if(J.type==="equipment"){let H=X[J.system.subType]||{acp:0,maxDex:0,asf:0};if(H.acp)Y["system.armor.acp"]=Math.max(0,J.system.armor.acp-H.acp);if(H.maxDex&&J.system.armor.dex)Y["system.armor.dex"]=J.system.armor.dex+H.maxDex;if(H.asf)Y["system.spellFailure"]=Math.max(0,J.system.spellFailure+H.asf)}return Y}buildItemName(J,Z){let Q=[J.name];if(Z.maxStrength)Q.unshift(`(+${Z.maxStrength} ${W.translate("str")})`);if(Z.addons.forEach((Y)=>{let X=pf1.registry.materials.get(Y);if(X)Q.push(X.name)}),Z.material&&!Z.name.match(/\bwand\b/i)){let Y=pf1.registry.materials.get(Z.material);if(Y&&!J.name.includes(Y.name))Q.push(Y.name);else Z.material=null}if(Z.enhancementTypes.forEach((Y)=>{Q.push((Y.hasSpecialTerm?W.capitalize(Y.specialTerm)+"-":"")+W.translate(`specialAbilities.${Y.name}.name`))}),Z.timeworn)Q.push(W.translate("timeworn"));if(Z.broken)Q.push(W.translate("broken"));if(Z.enhancementValue&&!J.name.match(new RegExp(`\\+${Z.enhancementValue}`)))Q.push("+"+Z.enhancementValue);else if(Z.mwk)Q.push(W.translate("masterwork"));if(Z.fluffTerm)Q.push(W.capitalize(Z.fluffTerm));if(Z.size&&Z.size!=="med")Q.push(pf1.config.actorSizes[Z.size]);return Q.reverse().join(" ")}calculateItemPrice(J,Z){if(Z.price)return Z.price;let Q=J.system.price||0;if(Q+=this.calculateMaterialPrice(J,Z,Z.material),Z.addons.forEach((X)=>Q+=this.calculateMaterialPrice(J,Z,X)),Z.mwk)if(J.system.subType==="ammo"||Z.name.toLowerCase()==="shuriken"||Z.name.toLowerCase()==="crystal chakram")Q+=6;else Q+=J.type==="weapon"?300:150;let Y=Z.enhancementValue;if(Z.enhancementTypes.forEach((X)=>{if(X.bonus)Y+=X.bonus;if(X.staticCost)Q+=X.staticCost}),Y){let X=J.type==="weapon"?2000:J.type==="equipment"?1000:40;if(J.name.toLowerCase()==="shuriken"||J.name.toLowerCase()==="crystal chakram")X=40;Q+=Math.pow(Y,2)*X}if(Z.maxStrength){let X=Z.rawName.match(/longbow/i);Q+=Z.maxStrength*(X?100:75)}return Q}calculateMaterialPrice(J,Z,Q){let Y=parseFloat(J.system.price)||0,X=Y,H=pf1.registry.materials.get(Q);if(!H)return 0;switch(J.type){case"equipment":{if(J.system.subType!=="armor"&&J.system.subType!=="shield")break;if(H)switch(Y*=H.price.multiplier||1,J.system.subType){case"shield":Y+=H.price.shield||0;break;case"armor":switch(J.system.equipmentSubtype){case"lightArmor":Y+=H.price.lightArmor||0;break;case"mediumArmor":Y+=H.price.mediumArmor||0;break;case"heavyArmor":Y+=H.price.heavyArmor||0;break}break;default:Y+=H.price.perPound*J.system.weight.value;break}if(Z.mwk&&H?.masterwork)Y-=150;break}case"weapon":{if(H)Y*=H.price.multiplier||1;if(J.name.toLowerCase()==="shuriken"||J.name.toLowerCase()==="crystal chakram"){if(Y+=H.price.ammunition||0,Z.mwk&&H?.masterwork)Y-=6}else{switch(J.system.weaponSubtype){case"light":Y+=H.price.lightWeapon||0;break;case"1h":Y+=H.price.oneHandWeapon||0;break;case"2h":Y+=H.price.twoHandWeapon||0;break;case"ranged":Y+=H.price.rangedTwoHandWeapon||0;break;default:Y+=H.price.perPound*J.system.weight.value;break}if(Z.mwk&&H?.masterwork)Y-=300}break}case"loot":{if(J.system.subType!=="ammo")break;if(H)if(Y*=H.price.multiplier||1,H.price.ammunition)Y+=H.price.ammunition;else Y+=H.price.perPound*J.system.weight.value;if(Z.mwk&&!H?.masterwork)Y+=6;break}}if(Z.enhancementValue)Y+=H.enhancement?.weapon||0;return Y-X}getItemNotes(){let J=[],Z=window.SBC.actor,Q=["weapon","equipment","consumable","loot","container"];for(let Y of Q)Z.itemTypes[Y].forEach((X)=>{J.push({name:X.name,quantity:X.system.quantity||1,charges:X.system.uses?.per==="charges"?X.system.uses.value:null})});return J}getConsumableType(J){switch(!0){case J.search(/^(?:potion|oil)s?/i)!==-1:return"potion";case J.search(/^wands?/i)!==-1:return"wand";case J.search(/scrolls?/i)!==-1:return"scroll";default:return}}stripQuantity(J){return J.replace(/\(\d+\s*[,)]\s*/,"(").replace("()","").trim()}handleSpecialCases(J,Z){[...J].forEach((Q)=>{if(Q.search(/grenades?$/gi)!==-1)J.add(`Grenade (${Q.replace(/s$/,"")})`)}),[...J].forEach((Q)=>{if(Q.search(/black powder horn/i)!==-1)J.add(Q.replace(/black powder horn/i,"Powder Horn"))}),[...J].forEach((Q)=>{if(Q.includes("flail")&&(!Q.includes("light")||!Q.includes("heavy")))J.add(Q.replace(/flail/i,"Light Flail"))}),[...J].forEach((Q)=>{if(Q.search(/studded leather(?!\s*armor)/i)!==-1)J.add(Q.replace(/studded leather/i,"Studded Leather Armor"))}),[...J].forEach((Q)=>{if(Q.search(/lamellar\s*armor/i)!==-1)J.add(Q.replace(/lamellar armor/i,"Lamellar"))}),[...J].forEach((Q)=>{if(Q.toLowerCase().includes("pearl of power")){let Y=+Q.match(/(\d+)/)?.[1];if(Y){let X=["st","nd","rd"][Y-1]??"th";J.add(`Pearl of Power, ${Y}${X} Level Spell`)}}}),[...J].forEach((Q)=>{if(Q.match(/tool/i)&&Q.match(/artisan|thieves/i)){let Y=Q.includes("artisan")?"Artisan's":"Thieves'";J.add(Y+" Tools, "+(Q.match(/\b(?:mwk|masterwork)\b/i)?"Masterwork":"Common"))}}),[...J].forEach((Q)=>{if(Q.toLowerCase().includes("bullet"))J.add(Q.replace(/bullet/i,"Firearm Bullet"))}),[...J].forEach((Q)=>{if(Q.toLowerCase().includes("bolt"))J.delete(Q),J.add(Q.replace(/bolt/i,"Crossbow Bolt"))}),[...J].forEach((Q)=>{if(Q.toLowerCase().includes("alchemical")&&Q.toLowerCase().includes("cartridge")){Q=Q.replace(/alchemical(.*)cartridges?/gi,"$1 Alchemical Cartridge").replace(/\s{2,}/," ").trim();let Y=Q.toLowerCase().split("alchemical cartridge")[0].trim();J.add("Alchemical Cartridge ("+Y+(Z.includes("bullet")||Y==="paper"?", bullet or pellet":"")+")")}})}}class a0 extends g{get parserGroup(){return"Parser/Statistics"}get parserType(){return"language"}async _parse(J,Z,Q=void 0){let Y=J.split(/[,;]/g),X=[],H=[],G="";this.app.processData.notes.statistics.languages=[];for(let _=0;_<Y.length;_++){let z=Y[_].trim(),K=W.parseSubtext(z);if(K.length>1){z=K[0],G=K[1],X.push(`${z} (${G})`);continue}if(z.search(n1())!==-1){let q=W.getKeyByValue(pf1.config.languages,z);H.push(q)}else X.push(z)}return await window.SBC.actor.update({"system.traits.languages":H.concat(X).concat(window.SBC.actor.system.traits.languages.base)}),this.app.processData.notes.statistics.languages.push(...H,...X),!0}}class e0 extends g{get parserGroup(){return"Parser/Statistics"}get parserType(){return"skill"}versatilePerformanceSkillOverrides={};versatilePerformanceSkillDisablers={};async _parse(J,Z,Q=void 0){let[Y,X]=J.split(/racial (?:modifiers?|bonus)/i);Y=this.splitText(Y),X=X?this.splitText(X):[],this.app.processData.notes.statistics.skills=[];let H=window.SBC,G=H.actor.system.attributes.hd.total,_=[],z={},K={},q={},j=H.actor.items.contents;await W.runParallelOps(j,async(O)=>{let E=Object.keys(O.system.classSkills??{});for(let N=0;N<E.length;N++){let P=E[N];if(O.system.classSkills[P]===!0){if(!_.includes(P))_.push(P)}}await this.updateSkillChanges(O,K)});let F=0,L={art:1,crf:1,lor:1,prf:1,pro:1},B=(O)=>O.replace(/\bEnter Choice\b/gim,"any one").replace(/Arcane/gim,"Arcana").replace(/\bPer\./gim,"Perception").replace(/S\. Motive/gim,"Sense Motive").replace(/\bLing\./gim,"Linguistics");for(let O of X){let N=B(O).match(i1());if(!N)continue;let P=parseInt(N.groups.value),M=Object.keys(K).find((R)=>K[R].name===N.groups.name);if(M&&K[M].racial&&N.groups.context)z[N.groups.name.toLowerCase()]={name:N.groups.name,number:P,prefixedValue:W.prefixNumber(P),context:N.groups.context??""}}this.app.processData.notes.statistics.racialSkillModifiers=Object.keys(z).length?Object.values(z):null;for(let O=0;O<Y.length;O++){if(!Y[O])continue;let E=B(Y[O]);if(E.match(/[+-]?\s*\d+(?![^(]*\))/g)?.length>1){let M=E.split(/(?<=[-+]\d+) /);E=M.splice(0,1)[0],Y.push(...M)}let N=null,P=["Arcana","Dungeoneering","Engineering","Geography","History","Local","Nature","Nobility","Planes","Religion"];if(E.search(/knowledge|perform|craft|profession|lore|artistry/i)!==-1&&E.search(/,|\band\b|&/g)!==-1){let M=W.parseSubtext(E),R=M[0],T=M[2][0],x=M[1].split(/,|\band\b|&/g);for(let h=0;h<x.length;h++){let w=x[h].trim(),p=R+" ("+w+") "+T;Y.push(p)}continue}if(E.match(/\bknowledge\b/i)&&E.match(/\bany\b/i)){let M=W.parseSubtext(E),R=M[0],T=M[2][0],x=M[1].match(/\bany\b (.*)/i)[1],h=["one","two","three","four","five","six","even","eight","nine"].indexOf(x)+1,w="";for(let p=0;p<h;p++){let d=Math.floor(Math.random()*10),a=new RegExp(P[d],"i");if(w.search(a)===-1&&!Y.includes(a)){let C=P[d],e=R+" ("+C+") "+T;Y.push(e),w+=e}else p--}continue}if(E.match(/\bknowledge\b/i)&&E.match(/\ball\b/i)){let M=W.parseSubtext(E),R=M[0],T=M[2][0];for(let x=0;x<P.length;x++){let h=P[x].trim(),w=R+" ("+h+") "+T;Y.push(w)}continue}N=W.parseSubtext(E);try{let M=N[0].replace(/[+-]?\s*\d+/g,"").trim(),R=N[0].replace(M,"").replace(/\s/g,""),T="",x="";if(N[1])if(N[1].startsWith("+"))x=N[1];else T=N[1];if(N[2]){if(R===""&&N[2][1])x=N[2][1];R=N[2][0]}let h=M+" ("+T+")",w="";if(M.match(S1()))w=W.getKeyByValue(pf1.config.skills,M);else if(h.match(S1()))M=h,w=W.getKeyByValue(pf1.config.skills,h);else w="skill";let p=H.actor.system.traits.size.base,d=0;if(w!=="skill"){let a=H.actor.system.skills[w].ability,C=H.actor.system.abilities[a].mod;switch(w){case"fly":d=pf1.config.sizeFlyMods[p];break;case"ste":d=pf1.config.sizeStealthMods[p];break;default:break}let e={name:M,key:w,total:+R,abilityMod:+C,classSkill:_.includes(w),sizeMod:+d,racialModifiers:z,changes:K,acp:H.actor.system.skills[w].acp,acpTotal:H.actor.system.attributes.acp.total,maxRanks:G,speedBonus:["swm","clm"].includes(w)?H.actor.system.attributes.speed[w==="swm"?"swim":"climb"].base>0?8:0:0,isOutsider:H.app.processData.characterData.isOutsider,outsiderSkillPicks:H.app.processData.characterData.outsiderSkillPicks,outsiderSkills:H.app.processData.characterData.outsiderSkills,isExpert:H.app.processData.characterData.isExpert,expertSkillPicks:H.app.processData.characterData.expertSkillPicks,expertSkills:H.app.processData.characterData.expertSkills},[I,r,o]=this.calculateSkillRanks(e);if(r){if(o==="outsider")H.app.processData.characterData.outsiderSkillPicks-=1,H.app.processData.characterData.outsiderSkills.push(w);else H.app.processData.characterData.expertSkillPicks-=1,H.app.processData.characterData.expertSkills.push(w);e.classSkill=!0}let b=z[M.toLowerCase()]?.context.length?`${x?"; ":""}${z[M.toLowerCase()].prefixedValue}${z[M.toLowerCase()].context}`:"";if(w.search(/(art|crf|lor|prf|pro)/)===-1)await H.actor.update({[`system.skills.${w}.rank`]:I}),q[w]={},await W.runParallelOps(j,async(v)=>{await this.updateSkillChanges(v,q)}).then(async()=>{let v=Object.assign({},e,{skillChanges:q}),[U,S,t]=this.calculateSkillRanks(v);if(S){if(t==="outsider")H.app.processData.characterData.outsiderSkillPicks-=1,H.app.processData.characterData.outsiderSkills.push(w);else H.app.processData.characterData.expertSkillPicks-=1,H.app.processData.characterData.expertSkills.push(w);e.classSkill=!0}if(I!==U)await H.actor.update({[`system.skills.${w}.rank`]:U})}),this.app.processData.characterData.conversionValidation.skills[w]={total:+R,context:x.replace(/\+?(-?\d+)/g,(v)=>W.prefixNumber(+v-+R))+b},this.app.processData.notes.statistics.skills.push({name:pf1.config.skills[w]||M,prefixedValue:R>=0?"+"+ +R:R,context:x});else{let v=w+ +L[w],U=Object.assign({},e,{key:v,skillChanges:q});await H.actor.update({[`system.skills.${w}.subSkills.${v}`]:{ability:H.actor.system.skills[w].ability,acp:H.actor.system.skills[w].acp,cs:H.actor.system.skills[w].cs,name:T.capitalize(),rank:I,rt:H.actor.system.skills[w].rt}}),q[w]={},await W.runParallelOps(j,async(S)=>{await this.updateSkillChanges(S,q)}).then(async()=>{let[S,t,k]=this.calculateSkillRanks(U);if(I!==S)await H.actor.update({[`system.skills.${w}.subSkills.${v}`]:{ability:H.actor.system.skills[w].ability,acp:H.actor.system.skills[w].acp,cs:H.actor.system.skills[w].cs,name:T.capitalize(),rank:S,rt:H.actor.system.skills[w].rt}})}),this.app.processData.characterData.conversionValidation.skills[v]={name:T.capitalize(),total:+R,context:x.replace(/\d+/g,(S)=>+S-+R)},this.app.processData.notes.statistics.skills.push({name:pf1.config.skills[w]+` (${T.capitalize()})`,prefixedValue:R>=0?"+"+ +R:R,context:x}),L[w]++}}else{let a="skill";if(F>0)a="skill"+(+F+1);let C=H.actor.system.abilities.int.mod,e=+R-+C;if(K[a]!==null&&K[a]!==void 0)e-=K[a];await H.actor.update({[`system.skills.${a}`]:{ability:"int",acp:!1,background:!1,cs:!1,custom:!0,name:M,rank:e,rt:!1}}),this.app.processData.characterData.conversionValidation.skills[a]={name:M,total:+R,context:x.replace(/\d+/g,(I)=>+I-+R)},this.app.processData.notes.statistics.skills.push({name:M,prefixedValue:R>=0?"+"+ +R:R,context:x}),F++}if(M.toLowerCase()==="perception")this.app.processData.notes.base.perception=R>=0?"+"+ +R:R}catch(M){return this.throwError(void 0,"parser.skill.failedToParse",{value:N}),!1}}return!0}async updateSkillChanges(J,Z){if(!J.system.changes)return;await W.runParallelOps(J.system.changes,async(Q)=>{let Y="";if(/skill\.(...)\.subSkills/i.test(Q.target))Y=Q.target.match(/skill\....\.subSkills\.(.*)/i)[1];else if(/skill\./i.test(Q.target))Y=Q.target.match(/skill\.(.*)/i)[1];if(Y!==""){let H=(await Roll.fromTerms(Roll.parse(Q.formula,J.getRollData())).evaluate())?.total??+Q.formula;if(Z[Y]||={total:0,skillFocus:!1,racial:!1},Z[Y].total+=H,J.name.match(/Skill Focus/i))Z[Y].skillFocus=!0;else Z[Y].skillFocus=!1;Z[Y].racial=Z[Y].racial||Q.type==="racial",Z[Y].name=pf1.config.skills[Y]}})}calculateSkillRanks({name:J,key:Z,total:Q=0,abilityMod:Y=0,classSkill:X=!1,sizeMod:H=0,racialModifiers:G={},changes:_={},acp:z=!1,acpTotal:K=0,maxRanks:q=0,speedBonus:j=0,isOutsider:F=!1,outsiderSkills:L=[],outsiderSkillPicks:B=4,isExpert:O=!1,expertSkills:E=[],expertSkillPicks:N=10}={}){if(Object.keys(this.versatilePerformanceSkillOverrides).includes(Z))return[0,!1,""];let P=+Q-+Y-(X?pf1.config.classSkillBonus:0)-+H-+j,M=!1,R="";if(z&&K)P+=K;if(Z==="fly")P-=pf1.config.flyManeuverabilityValues[window.SBC.actor.system.attributes.speed.fly.maneuverability];if(G[J.toLowerCase()]&&G[J.toLowerCase()].context.length===0)P-=G[J.toLowerCase()].number;if(_[Z]!==null&&_[Z]!==void 0)P-=_[Z].total;if((_[Z]?.skillFocus?P-q-3===3||P-q===3:P-q===3||P-q===3||P>q)&&F&&B>0&&!L.includes(Z)&&!X){if(M=!0,R="outsider",_[Z]?.skillFocus&&P-q-3===3)P-=3;P-=pf1.config.classSkillBonus}else if((_[Z]?.skillFocus?P-q-3===3||P-q===3:P-q===3||P>q)&&O&&N>0&&!E.includes(Z)&&!X){if(M=!0,R="expert",_[Z]?.skillFocus&&P-q-3===3)P-=3;P-=pf1.config.classSkillBonus}return W.log(`Skill: ${J} | Total: ${Q} | Ability: ${Y} | Class: ${X} | Size: ${H} | Racial: ${G[J.toLowerCase()]?.number??0} | Change: ${_[Z]?.total??0} | Ranks: ${P}`),[Math.clamp(P,0,q),M,R]}}class q1 extends g{get parserGroup(){return"Parser/Base"}get parserType(){return"age"}async _parse(J,Z,Q=void 0){let Y,X={phys:0,ment:0};switch(J){case"Venerable":Y="SBCPF1.parser.age.venerable",J="venerable",X.phys=-6,X.ment=3;break;case"Old":Y="SBCPF1.parser.age.old",J="old",X.phys=-3,X.ment=2;break;case"Middle[- ]Aged?":Y="SBCPF1.parser.age.middleAged",J="middleAge",X.phys=-1,X.ment=1;break;case"Young":Y="SBCPF1.parser.age.young",J="young";break;default:Y="SBCPF1.parser.age.adult",J="adult"}return Y=game.i18n.localize(Y),await window.SBC.actor.update({"system.details.age":Y,"system.traits.ageCategory":J}),this.app.processData.notes.age=Y,!0}getAbilityChange(J){let Z=["str","dex","con"].includes(J);switch(window.SBC.actor.system.traits.ageCategory.base){case"venerable":return Z?-6:3;case"old":return Z?-3:2;case"middleAge":return Z?-1:1;case"young":switch(J){case"con":case"str":case"wis":return-2;case"dex":return 2;default:return 0}default:return 0}}}class A{static map={};static initMapping(J){A.map={types:{npc:["base","defense","offense","tactics","statistics","ecology","special abilities","description"],character:["base","defense","offense","tactics","statistics","ecology","special abilities","description"],vehicle:["vehicleBase","vehicleDefense","vehicleOffense","vehicleDescription"],trap:["trap"],haunt:["hauntBase"]},trap:{name:new s(J,["name","prototypeToken.name"],"string"),cr:new s(J,["system.details.cr.base","system.details.cr.total"],"number"),type:new s(J,["system.details.type"],"string"),perception:new s(J,["system.attributes.perception.total"],"number"),disableDevice:new s(J,["system.attributes.disableDevice.total"],"number"),trigger:new X0(J,["base.trigger"]),reset:new X0(J,["base.reset"]),effect:new X0(J,["base.effect"]),source:new X0(J,["base.source"]),description:new X0(J,["description.long"],"string")},haunt:{name:new s(J,["name","prototypeToken.name"],"string"),cr:new s(J,["system.details.cr.base","system.details.cr.total"],"number"),alignment:new s(J,["system.details.alignment"],"string"),source:new X0(J,["base.source"]),description:new X0(J,["description.long"],"string")},base:{name:new s(J,["name","prototypeToken.name"],"string"),cr:new s(J,["system.details.cr.base","system.details.cr.total"],"number"),mr:new D0(J),level:new X0(J,["system.details.level.value"]),xp:new X0(J,["system.details.xp.value"]),gender:new s(J,["system.details.gender"],"string"),age:new q1(J),race:new h0(J),classes:new C0(J),source:new X0(J,["base.source"]),alignment:new s(J,["system.details.alignment"],"string"),size:new s(J,["system.traits.size"],"string"),space:new s(J,["prototypeToken.height","prototypeToken.width"],"number"),scale:new s(J,["prototypeToken.texture.scaleX","prototypeToken.texture.scaleY"],"number"),creatureType:new A0(J),init:new s(J,["system.attributes.init.total"],"number"),senses:new g0(J),aura:new T0(J)},defense:{acNormal:new s(J,["system.attributes.ac.normal.total"],"number"),acFlatFooted:new s(J,["system.attributes.ac.flatFooted.total"],"number"),acTouch:new s(J,["system.attributes.ac.touch.total"],"number"),acTypes:new y0(J),hp:new b0(J),regeneration:new s(J,["system.traits.regen"],"string"),fastHealing:new s(J,["system.traits.fastHealing"],"string"),saves:new u0(J),immune:new k0(J),resist:new m0(J),weakness:new o0(J),defensiveAbilities:new v0(J),dr:new d0(J),sr:new p0(J)},offense:{speed:new n0(J),attacks:new r0(J),specialAttacks:new U0(J),space:new s(J,["prototypeToken.height","prototypeToken.width"],"number"),stature:new s(J,["system.traits.stature"],"string"),spellBooks:new H0(J)},tactics:new i0(J),statistics:{str:new q0(J,["system.abilities.str.value"],["system.abilities.str.mod"],"number"),dex:new q0(J,["system.abilities.dex.value"],["system.abilities.dex.mod"],"number"),con:new q0(J,["system.abilities.con.value"],["system.abilities.con.mod"],"number"),int:new q0(J,["system.abilities.int.value"],["system.abilities.int.mod"],"number"),wis:new q0(J,["system.abilities.wis.value"],["system.abilities.wis.mod"],"number"),cha:new q0(J,["system.abilities.cha.value"],["system.abilities.cha.mod"],"number"),bab:new s(J,["system.attributes.bab.total"],"number"),cmb:new s(J,["system.attributes.cmb.total"],"number"),cmd:new s(J,["system.attributes.cmd.total"],"number"),feats:new v0(J),skills:new e0(J),languages:new a0(J),sq:new U0(J),gear:new s0(J)},ecology:new l0(J),specialAbilities:new c0(J),description:new X0(J,["description.long"],"string")}}static getNeededCategories(J){switch(J){case"character":case"npc":return["defense","offense","statistics"];case"vehicle":return["vehicleDefense","vehicleOffense"];case"trap":case"haunt":return[]}}}class C1{static async buildChanges(J,Z=null){let Q=window.SBC.actor,Y=null,X=[];if(Z!==null)Y=Q.items.get(Z),X=[Y];if(Y===null)X=Q.items;let H=Q.getRollData(),G={};X.forEach((_)=>{let z=_.changes;if(!foundry.utils.isEmpty(z))z.map(async(K)=>{let{target:q,formula:j,type:F}=K;if(G[q]==null)G[q]={};let L=await Roll.fromTerms(Roll.parse(j,H)).evaluate();if(L=L?.total??+j,G[q][F]==null)G[q][F]=L;else G[q][F]+=L})}),J.changes=G}static async getValueFromChanges(J,Z=null,Q=null){let Y=0;if(Z==null&&Q==null)return Y;else if(Z!=="all"){if(J.changes[Z]==null)return 0;for(let X in Object.keys(J.changes[Z]))if(Q&&X===Q||Q==null)Y+=J.changes[Z][X];return Y}else return Object.keys(J.changes).map((X)=>{W.log(`Checking subtarget ${X}:`),Object.keys(J.changes[X]).map((H)=>{if(W.log(`type k is ${H} = ${J.changes[X][H]}`),Q&&H===Q||Q==null)Y+=+J.changes[X][H]})}),Y}static async conversionValidation(J){let Z=window.SBC;if(!Z.settings.getSetting("createBuff"))return;Z.settings.getSetting("debug").debug&&console.groupCollapsed("sbc-pf1 | Conversion Validation"),console.log(J);let Q=Z.actor,Y=J.characterData.conversionValidation;try{await this.buildChanges(J);let X=[],H=[],G=[],_=0,z=Object.keys(Y.spellBooks),K={};for(let O=0;O<z.length;O++){let E=z[O],N=Y.spellBooks[E].casterLevel,P=Y.spellBooks[E].concentrationBonus,M=Q.system.attributes.spells.spellbooks[E].cl.total;console.log(E,N,M);let R=Q.system.attributes.spells.spellbooks[E].concentration.total,T=+N-+M,x=+P-R-T;if(J.miscNotes.spellbookNotes[O]={key:E},T!==0)J.miscNotes.spellbookNotes[O].casterLevel=`sbc | Total in statblock was CL ${N}, adjust as needed.`,K[`data.attributes.spells.spellbooks.${E}`]={cl:{formula:T.toString()}};if(x!==0)J.miscNotes.spellbookNotes[O].concentrationBonus=`sbc | Total in statblock was +${P}, adjust as needed.`,K[`data.attributes.spells.spellbooks.${E}.concentrationFormula`]=x.toString()}if(!foundry.utils.isEmpty(K))await Q.update(K),await oJ(Q,J.miscNotes.spellbookNotes);let q=["str","dex","con","int","wis","cha"];for(let O of q){let E=Q.system.abilities[O].total,N=Y.attributes[O.capitalize()]??E,P=+N-+E;if(P===0)continue;console.log(N,E);let M=Object.assign({},new pf1.components.ItemChange().toObject(void 0,!1),{formula:P.toString(),type:"untypedPerm",target:O,value:+P});X.push(M),delete Y.attributes[O.capitalize()]}if(X.length){let O={name:"sbc | Conversion Buff (Ability Scores)",type:"buff",system:{description:{value:`<h2>sbc | Conversion Buff (Ability Scores)</h2>
                            This Buff was created by <strong>sbc</strong> to compensate for differences between the statblock input and FoundryVTTs automatically calculated values.
                            <br><br>
                            As differences in ability scores can have cascading effects, these get handled first and in a separate conversion buff.`},active:!0,subType:"perm",changes:X,hideFromToken:!0,level:0,tag:"sbcConversionBuff1",useCustomTag:!0},img:"systems/pf1/icons/skills/yellow_36.jpg"};await Q.createEmbeddedDocuments("Item",[O])}let j=Object.keys(Y.attributes);if(j.splice(j.indexOf("acNormal"),1),j.splice(j.indexOf("acTouch"),1),j.splice(j.indexOf("acFlatFooted"),1),j.push("acNormal","acTouch","acFlatFooted"),J.characterData.isOutsider){let O=Q.itemTypes.class.find((E)=>E.id===J.characterData.outsiderId);if(O){let E={fort:0,ref:0,will:0},N={fort:O.system.savingThrows.fort.value,ref:O.system.savingThrows.ref.value,will:O.system.savingThrows.will.value,changed:!1};for(let P of["fort","ref","will"]){let M=Y.attributes[P],R=Q.system.attributes.savingThrows[P].total??0;E[P]=+M-+R}if(E.fort!==0&&E.ref!==0&&E.fort+E.ref===0)N.fort=O.system.savingThrows.ref.value,N.ref=O.system.savingThrows.fort.value,N.changed=!0;else if(E.fort!==0&&E.will!==0&&E.fort+E.will===0)N.fort=O.system.savingThrows.will.value,N.will=O.system.savingThrows.fort.value,N.changed=!0;else if(E.ref!==0&&E.will!==0&&E.ref+E.will===0)N.ref=O.system.savingThrows.will.value,N.will=O.system.savingThrows.ref.value,N.changed=!0;if(N.changed)await O.update({"system.savingThrows.fort.value":N.fort,"system.savingThrows.ref.value":N.ref,"system.savingThrows.will.value":N.will})}}for(let O=0;O<j.length;O++){let E=j[O],N="",P="",M=Y.attributes[E],R=0,T=0,x=0;if(isNaN(M))continue;switch(E.toLowerCase()){case"cmd":case"cmb":case"init":if(R=Q.system.attributes[E].total,N="untypedPerm",P=E,W.log(`Attribute: ${E} | Total in Actor: ${R} | Total in Statblock: ${M}`),R!==M)x=+M-+R;break;case"hpbonus":N="untypedPerm",P="mhp",x=+M;break;case"hptotal":R=Q.system.attributes.hp.max,N="untypedPerm",P="mhp",x=+M-+R;break;case"acnormal":R=Q.system.attributes.ac.normal.total,N="untypedPerm",P="aac",x=+M-+R-+_;break;case"base":case"enhancement":case"dodge":case"inherent":case"deflection":case"morale":case"luck":case"sacred":case"insight":case"resistance":case"profane":case"trait":case"racial":case"competence":case"circumstance":case"alchemical":case"penalty":T=await this.getValueFromChanges(J,"all",E.toLowerCase()),N=E,P="aac",x=+M-+T,_+=+x;break;case"rage":N="untypedPerm",P="ac",x=+M;break;case"fort":case"ref":case"will":N="untypedPerm",P=E,R=Q.system.attributes.savingThrows[E].total??0,x=+M-+R;break;default:break}if(x!==0){let h=Object.assign({},new pf1.components.ItemChange().toObject(void 0,!1),{formula:x.toString(),type:N,target:P,value:+x});H.push(h)}}let F=Object.keys(Y.context);for(let O=0;O<F.length;O++){let E=F[O],N=Y.context[E];if(N!==""){let P={subTarget:E,target:"misc",text:N};G.push(P)}}let L=Object.keys(Y.skills);for(let O=0;O<L.length;O++){let E=L[O];if(Object.keys(A.map.statistics.skills.versatilePerformanceSkillOverrides).includes(E))continue;let N=E.replace(/(\d+)/,""),P=Y.skills[E],M=0,R=Object.keys(Q.system.skills[N]),T="";if(!R.includes("subSkills"))M=Q.getSkillInfo(E).mod??0,T=`skill.${E}`;else M=Q.getSkillInfo(`${N}.${E}`).mod??0,T=`skill.${N}.${E}`;if(P.context!==""){let x=P.context,h={target:T,text:x};G.push(h)}if(+P.total!==+M){let x=+P.total-+M;if(x!==0){let h=await new pf1.components.ItemChange({formula:x.toString(),type:"untypedPerm",target:T,value:+x});H.push(h.toObject())}}}let B={name:"sbc | Conversion Buff",type:"buff",system:{description:{value:`<h2>sbc | Conversion Buff</h2>
                        This Buff was created by <strong>sbc</strong> to compensate for differences between the input and the values FoundryVTT calculates automatically.
                        <br><br>
                        Especially when the pathfinder system gets upgraded, entries in compendiums get updated or foundry changes in some way, this buff may become outdated.
                        <br><br>
                        For most mooks the conversion should more or less work, but for important NPCs or creatures it is adviced to double check the conversion manually.`},active:!0,subType:"perm",changes:H,contextNotes:G,hideFromToken:!0,level:0,tag:"sbcConversionBuff2",useCustomTag:!0},img:"systems/pf1/icons/skills/yellow_36.jpg"};if(H.length>0||G.length>0)await Q.createEmbeddedDocuments("Item",[B]);Hooks.callAll("sbc.validated",Q)}catch(X){Z.settings.getSetting("debug").debug&&console.error(X);let H="Failed to validate the conversion and create a conversion buff",G=new f(f.ERRORLEVELS.ERROR,"Validation",H);throw J.errors.push(G),console.error(X),X}Z.settings.getSetting("debug").debug&&console.groupEnd()}}async function oJ(J,Z){let Q=[],Y="";for(let H of Z){let G=J.system.attributes.spells.spellbooks[H.key];if(H.casterLevel||H.concentration){if(Y+=`<p><strong>${G.name||G.label}</strong>:</p>`,H.casterLevel)Q.push({target:`cl.book.${H.key}`,text:H.casterLevel}),Y+=`<p>Caster Level: ${H.casterLevel}</p>`;if(H.concentration)Q.push({target:`concn.${H.key}`,text:H.concentration}),Y+=`<p>Concentration Bonus: ${H.concentration}</p>`}}let X=J.itemTypes.feat.find((H)=>H.name==="Miscellaneous Notes");if(X)Y=X.system.description.value+Y,await X.update({"system.contextNotes":X.system.contextNotes.concat(Q),"system.description.value":Y});else Y=`<p>This feature was created by <strong>SBC</strong> to collect any notes that don't have a source on the actor,
                such as saving throw details or a bonus to CMD from extra legs. It may also be used to record a natural armor bonus,
                spell resistance bonus, or spellcasting notes.</p>${Y}`,await J.createEmbeddedDocuments("Item",[{name:"Miscellaneous Notes",type:"feat",system:{contextNotes:Q,description:{value:Y},subType:"misc",tag:"miscellaneousNotes"},img:"systems/pf1/icons/skills/yellow_36.jpg"}])}var t0={content:"",line:0};async function WJ(J,Z,Q){window.SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING BASE DATA");let Y=[];J.notes.base={},t0={content:"",line:0};let X=null,H=null;for(let G=0;G<Z.length;G++)try{let _=Z[G].trim();if(_==="")continue;if(!Y.name){if([Y.name,_]=await lJ(_,G),_==="")continue}if(!Y.cr&&_.match(/\bCR\b/i)!==null){if([Y.cr,_]=await cJ(J,_,G),_==="")continue}if(!Y.mr){if(_.match(/\bMR\b/i)!==null)X=G,H=_;if(Y.classes&&H)[Y.mr,H]=await iJ(J,H,X)}if(G!==0){if(!Y.source&&_.toLowerCase().startsWith("source")){if([Y.source,_]=await rJ(_,G),_==="")continue}if(!Y.xp&&_.toLowerCase().startsWith("xp")){if([Y.xp,_]=await nJ(J,_,G),_==="")continue}if(!Y.gender&&w1().test(_)){if([Y.gender,_]=await sJ(_,G),_==="")continue}if(!Y.race){if([Y.race,_]=await aJ(_,G),_==="")continue}if(!Y.classes){let z=_.match(_1()),K=_.toLowerCase().startsWith("source");if(!Y.age&&W.haystackRegexSearch(["Middle[- ]Aged?","Old","Venerable"],_)){if([Y.age,_]=await eJ(_,G),_==="")continue}if(!z&&!K){if(Y.classes=await tJ(_,G),_==="")continue}}if(!Y.alignment&&_1().test(_)){if([Y.alignment,_]=await J5(J,_,G),_==="")continue;if(Y.alignment===!0)Y.classes=!0}if(!Y.size&&R0().test(_)){if(Y.size=await Q5(J,_,G),_==="")continue}if(!Y.creatureType&&I1().test(_)&&R0().test(_)){if([Y.creatureType,_]=await Z5(_,G),_==="")continue}if(!Y.init&&_.toLowerCase().match(/^init\b/i)){if([Y.init,_]=await $5(J,_,G),_==="")continue}if(!Y.senses&&_.match(/\bSenses\b/i)!==null){if([Y.senses,_]=await Y5(_,G),_==="")continue}if(!Y.aura&&_.match(/\bAura\b/i)!==null)t0={content:_,line:G},Y.aura=!0}}catch(_){window.SBC.settings.getSetting("debug")&&console.error(_);let z="Parsing the base data failed at the highlighted line",K=new f(f.ERRORLEVELS.ERROR,"Parse/Base",z,Q+G+1);return J.errors.push(K),J.input.prepared.success=!1,window.SBC.settings.getSetting("debug")&&console.groupEnd(),!1}if(!Y.cr&&window.SBC.actorType===0){let G=new f(f.ERRORLEVELS.WARNING,"Parse/Base","No CR for this NPC detected, please check the highlighted line",0);J.errors.push(G)}if(!Y.creatureType){let G=new f(f.ERRORLEVELS.ERROR,"Parse/Base","No creature type found!");J.errors.push(G)}return W.log("RESULT OF PARSING BASE DATA (TRUE = PARSED SUCCESSFULLY)"),W.log(Y),window.SBC.settings.getSetting("debug")&&console.groupEnd(),!0}async function lJ(J,Z){let Q=A.map.base.name,Y=J.replace(/\bCR\b.*$/i,"").replace(/\($/,"").trim(),X=await Q.parse(Y.trim().capitalize(),Z);if(X)J=W.cleanLine(Y,J);return[X,J]}async function cJ(J,Z,Q){let Y=A.map.base.cr,X=Z.match(/\bCR\b\s(-|\d*\.\d+|\d+(?:\/\d+)?)/i),H=X[1];if(H.includes("/"))J.notes.base.cr=H;else for(let[_,z]in Object.entries(window.SBC.config.const.crFractions))if(+H===z){J.notes.base.cr=_;break}let G=await Y.parse(parseFloat(window.SBC.config.const.crFractions[H]||H),Q);if(G)Z=W.cleanLine(X[0],Z);return[G,Z]}async function iJ(J,Z,Q){let Y=A.map.base.mr,H=Z.match(/\bMR\b\s(\d+)/i)[1];J.notes.base.mr=H;let G=await Y.parse(H,Q);if(G)Z=W.cleanLine(H,Z);return[G,Z]}async function rJ(J,Z){let Q=A.map.base.source,Y=J.match(/^Source\s+(.*)/)[1].trim(),X=await Q.parse(Y,Z);if(X)J=W.cleanLine(Y,J);return[X,J]}async function nJ(J,Z,Q){let Y=A.map.base.xp,X=Z.match(/^XP\s+([\d,.]*)/)?.[1].replace(/\.,/g,"").trim()??"0";J.notes.base.xp=X;let H=await Y.parse(X,Q);if(H===!0)Z=W.cleanLine(Z.match(/^(XP\s+[\d,.]*)/)[1],Z);return[H,Z]}async function sJ(J,Z){let Q=J.match(w1())[0],X=await A.map.base.gender.parse(Q,Z);if(X)J=W.cleanLine(Q,J);return[X,J]}async function aJ(J,Z){let Q=A.map.base.race,Y=W.haystackRegexSearch(window.SBC.config.races.map((X)=>X+="\\b"),J)?.replace("\\b","")||W.haystackRegexSearch(O1.map((X)=>X+="\\b"),J)?.replace("\\b","")||!1;if(!Y)return[!1,J];if(new RegExp(`\\(${Y.toLowerCase()}|,\\s*${Y.toLowerCase()}\\s*,|${Y.toLowerCase()}\\)`).test(J.toLowerCase()))return[!1,J];return[await Q.parse(Y,Z),W.cleanLine(Y,J)]}async function eJ(J,Z){let Q=W.haystackRegexSearch(["Middle[- ]Aged?","Old","Venerable"],J)||"",X=await A.map.base.age.parse(Q,Z);if(X)J=W.cleanLine(Q,J);return[X,J]}async function tJ(J,Z){let Q=J.match(N0());if(Q){let Y=J.slice(J.indexOf(Q[0]));return await A.map.base.classes.parse(Y,Z)}return!0}async function J5(J,Z,Q){let Y=A.map.base.alignment,X=Z.match(_1())[1].trim();J.notes.base.alignment=X;let H=await Y.parse(X.replace(/\bN\b/,"TN").toLowerCase(),Q);if(H)Z=W.cleanLine(X,Z);return[H,Z]}async function Q5(J,Z,Q){let Y=A.map.base.size,X=Z.match(R0())[0].trim();J.notes.base.size=X;let H=W.getKeyByValue(pf1.config.actorSizes,X),G=A.map.base.space,_=A.map.base.scale,z=pf1.config.tokenSizes[H].w,K=pf1.config.tokenSizes[H].scale;switch(H){case"dim":case"fine":case"tiny":await window.SBC.actor.update({"system.skills.swm.ability":"dex","system.skills.clm.ability":"dex","system.attributes.cmbAbility":"dex"});break;default:break}return{size:await Y.parse(H,Q),space:await G.parse(z,Q),scale:await _.parse(K,Q)}}async function Z5(J,Z){let Q=J.match(I1())[1],X=await A.map.base.creatureType.parse(Q,Z);if(X)J=W.cleanLine(Q,J);return[X,J]}async function $5(J,Z,Q){let Y=A.map.base.init,X=Z.match(/Init\s*([+-]?\d+)/)[1].trim();J.characterData.conversionValidation.attributes.init=+X;let H=await Y.parse(+X,Q);if(H)Z=W.cleanLine(X,Z);return[H,Z]}async function Y5(J,Z){let Q=A.map.base.senses,Y=J.match(/\bSenses\b\s*(.*?)(?:\n|$|\s*Aura)/gim)[0].replace(/\bSenses\b\s*|\s*Aura\b/g,""),X=await Q.parse(Y,Z);if(X)J=W.cleanLine(Y,J);return[X,J]}async function zJ(){if(!t0.content)return!0;let J=A.map.base.aura,Z=t0.content.match(/\bAura\b\s*(.*)/gim)[0].replace(/\s*Aura\b/g,"");return await J.parse(Z,t0.line)}async function KJ(J,Z,Q){window.SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING DEFENSE DATA");let Y=[];J.notes.defense={};for(let X=0;X<Z.length;X++)try{let H=Z[X];if(!Y.acNormal&&H.toLowerCase().startsWith("ac"))Y.acNormal=await A1("acNormal","AC",J,H,X+Q);if(!Y.acTouch&&H.match(/Touch/i))Y.acTouch=await A1("acTouch","Touch",J,H,X+Q);if(!Y.acFlatFooted&&H.match(/flat-footed/i))Y.acFlatFooted=await A1("acFlatFooted","flat-footed",J,H,X+Q);if(!Y.acTypes&&/AC.*?\((.*?)\)/i.test(H))Y.acTypes=await X5(J,H,X+Q);if(!Y.hp&&H.toLowerCase().startsWith("hp"))Y.hp=await H5(H,X+Q);if(!Y.saves&&H.toLowerCase().startsWith("fort "))Y.saves=await G5(H,X+Q);if(!Y.dr&&H.match(/\bDR\b/i))Y.dr=await _5(H,X+Q);if(!Y.immune&&H.match(/Immune\b/i))Y.immune=await W5(H,X+Q);if(!Y.resist&&H.match(/(?<!abilities\s*)\bResist\b/i))Y.resist=await K5(H,X+Q);if(!Y.weakness&&H.match(/\bWeaknesses\b/i))Y.weakness=await z5(H,X+Q);if(!Y.sr&&H.match(/\bSR\b/i))Y.sr=await q5(H,X+Q);if(!Y.defensiveAbilities&&H.match(/Defensive Abilities\b/i))Y.defensiveAbilities=await V5(J,H,X+Q)}catch(H){window.SBC.settings.getSetting("debug")&&console.error(H);let G=`Parsing the defense data failed at line ${Q+X+1}`,_=new f(f.ERRORLEVELS.ERROR,"Parse/Defense",G,X+Q);return J.errors.push(_),window.SBC.settings.getSetting("debug")&&console.groupEnd(),!1}return W.log("RESULT OF PARSING DEFENSE DATA (TRUE = PARSED SUCCESSFULLY)"),W.log(Y,window.SBC.actor.system),window.SBC.settings.getSetting("debug")&&console.groupEnd(),!0}async function A1(J,Z,Q,Y,X){let H=A.map.defense[J],G=new RegExp(`${Z}\\s*(-?\\d+)`,"i"),_=Y.match(G)[1].trim();return Q.notes.defense[J]=_,Q.characterData.conversionValidation.attributes[J]=+_,await H.parse(+_,X)}async function X5(J,Z,Q){let Y=A.map.defense.acTypes,X=Z.match(/AC.*?\((.*?)\)/i)[1].trim();return J.characterData.conversionValidation.attributes.acTypes=X,await Y.parse(X,Q)}async function H5(J,Z){let Q=A.map.defense.hp,Y=J.match(/^(?:HP)(.*)/i)[1].trim();return await Q.parse(Y,Z)}async function G5(J,Z){let Q=A.map.defense.saves,Y=J.match(/^(Fort.*)/i)[1].trim();return await Q.parse(Y,Z)}async function _5(J,Z){let Q=A.map.defense.dr,Y=J.match(/\bDR\b(.*?)(?=$|Immune|Resist|SR|Weakness)/i)[1].trim();return await Q.parse(Y,Z)}async function W5(J,Z){let Q=A.map.defense.immune,Y=J.match(/\bImmune\b(.*?)(?=$|Resist|SR|Weakness|DR)/i)[1].trim();return await Q.parse(Y,Z)}async function z5(J,Z){let Q=A.map.defense.weakness,Y=J.match(/\bWeakness(?:es)?\b(.*?)(?=$|\b(?:Resist|Immune|SR|Weakness|DR)\b)/i)[1].trim();return await Q.parse(Y,Z)}async function K5(J,Z){let Q=A.map.defense.resist,Y=J.match(/\bResist\b(.*?)(?=$|\b(?:Immune|SR|Weakness|DR)\b)/i)[1].trim();return await Q.parse(Y,Z)}async function q5(J,Z){let Q=A.map.defense.sr,Y=J.match(/\bSR\b(.*?)(?=$|\b(?:Immune|Resist|Weakness|DR)\b)/i)[1].trim();return await Q.parse(Y,Z)}async function V5(J,Z,Q){let Y=A.map.defense.defensiveAbilities,X=Z.match(/Defensive Abilities\b\s*(.*?)(?=$|\b(?:Immune|Resist|Weakness|DR|SR)\b)/i)[1].replace(/\s*[,;]+/g,",").replace(/(,\s*$)/,"").trim(),[H,G]=await Y.parse(X,Q,"class-abilities",["buff","consumable","equipment","feat","loot","weapon"]);return J.notes.defense.defensiveAbilities=G,H}async function qJ(J,Z,Q){window.SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING DESCRIPTION DATA"),J.notes.description={};let Y="";for(let H=0;H<Z.length;H++)try{let G=Z[H];switch(G.toLowerCase()){case"description":break;case"":Y=Y.concat(`
`);break;default:Y=Y.concat(G+`
`);break}}catch(G){window.SBC.settings.getSetting("debug")&&console.error(G);let _=`Parsing the description data failed at line ${Q+H+1}`,z=new f(f.ERRORLEVELS.WARNING,"Parse/Description",_,H+Q);return J.errors.push(z),J.input.prepared.success=!1,window.SBC.settings.getSetting("debug")&&console.groupEnd(),!1}return J.notes.description.long=Y,await A.map.description.parse(Y,Q),W.log("RESULT OF PARSING DESCRIPTION DATA (TRUE = PARSED SUCCESSFULLY)"),window.SBC.settings.getSetting("debug")&&console.groupEnd(),!0}async function VJ(J,Z,Q){window.SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING ECOLOGY DATA");let Y=[];J.notes.ecology={hasEcology:!0};for(let X=0;X<Z.length;X++)try{let H=Z[X],G=A.map.ecology;if(!Y.environment&&H.match(/Environment/i))Y.environment=await F5(G,J,H,Q+X);if(!Y.organization&&H.match(/Organization/i))Y.organization=await j5(G,J,H,Q+X);if(!Y.treasure&&H.match(/Treasure/i))Y.treasure=await L5(G,J,H,Q+X)}catch(H){window.SBC.settings.getSetting("debug")&&console.error(H);let G=`Parsing the ecology data failed at line ${Q+X+1} (non-critical)`,_=new f(f.ERRORLEVELS.WARNING,"Parse/Ecology",G,X+Q);throw J.errors.push(_),window.SBC.settings.getSetting("debug")&&console.groupEnd(),H}return W.log("RESULT OF PARSING ECOLOGY DATA (TRUE = PARSED SUCCESSFULLY)"),W.log(Y),window.SBC.settings.getSetting("debug")&&console.groupEnd(),!0}async function F5(J,Z,Q,Y){let X={name:"Environment",entry:Q.match(/^(?:Environment)([\s\S]*?)(?=$|Organization|Treasure)/i)[1]};return Z.notes.ecology.environment=X.entry,await J.parse(X,Y)}async function j5(J,Z,Q,Y){let X={name:"Organization",entry:Q.match(/(?:Organization)([\s\S]*?)(?=$|Treasure)/i)[1]};return Z.notes.ecology.organization=X.entry,await J.parse(X,Y)}async function L5(J,Z,Q,Y){let X={name:"Treasure",entry:Q.match(/(?:Treasure)([\s\S]*?)$/i)[1]};if(Q.match(/(NPC Gear)/i)){let G=Q.match(/(?:NPC Gear\s*\()([^)]*)/gi)[0].replace(/NPC Gear\s*\(/i,"");Z.treasureParsing.treasureToParse=G,Z.treasureParsing.lineToRemove=Y;let _=`
        This is treasure and will not be included as items in the actor. If you want to parse these as real items, press here:<br/>
        <input type="button" id="parseTreasureAsGearButton" value="Parse Treasure as Gear"></input>`,z=new f(f.ERRORLEVELS.WARNING,"Parse/Ecology",_,Y);Z.errors.push(z)}return Z.notes.ecology.treasure=X.entry,await J.parse(X,Y)}var L0={},W0=0,Z0=0,E0={0:"primary",1:"secondary",2:"tertiary",3:"spelllike",4:"quinary",5:"senary",6:"septenary",7:"octonary"},j0=[],j1=[];async function jJ(J,Z,Q){L0={},W0=0,Z0=0,j0=[],j1=[],window.SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING OFFENSE DATA");let Y=[];J.notes.offense={speed:[],spellBooks:[]};let X={text:"",line:0},H={text:"",line:0},G=Z.some((z)=>/^Special\s+Attacks\b\s*/i.test(z)),_={text:"",line:0};for(let z=0;z<Z.length;z++)try{let K=Z[z];if(/^Spe{0,2}d\s*/i.test(K)){if(!Y.landSpeed&&/^Spe{0,2}d\s*\d+/i.test(K))Y.landSpeed=await x0(K,"land","^Spe{0,2}d",z+Q);else Y.landSpeed=await x0("Speed 0 ft.","land","^Spe{0,2}d",z+Q);if(!Y.swimSpeed&&K.match(/\bSwim\s*/i))Y.swimSpeed=await x0(K,"swim","\\bSwim",z+Q);if(!Y.climbSpeed&&K.match(/\bClimb\s*/i))Y.climbSpeed=await x0(K,"climb","\\bClimb",z+Q);if(!Y.burrowSpeed&&K.match(/\bBurrow\s*/i))Y.burrowSpeed=await x0(K,"burrow","\\bBurrow",z+Q);if(!Y.flySpeed&&K.match(/\bFly\s*/i))Y.flySpeed=await x0(K,"fly","\\bFly",z+Q)}if(!Y.melee&&K.match(/^Melee\s*/i)){if(X=await FJ(K,"Melee",Z[z+1],z+Q),J.notes.offense.melee=X.text,!G)await F1(J),Y.melee=await V1(X,"mwak")}if(!Y.ranged&&K.match(/^Ranged\s*/i)){if(H=await FJ(K,"Ranged",Z[z+1],z+Q),J.notes.offense.ranged=H.text,!G)await F1(J),Y.ranged=await V1(H,"rwak")}if(!Y.specialAttacks&&K.match(/^Special\s+Attacks\b\s*/i))_.text=K,_.line=z+Q;if(!Y.spaceStature){if(/^Space\b.*\bReach\b/i.test(K)){let q=A.map.offense.stature,[j,F]=await P5(K,z+Q),[L,B]=await E5(K);J.notes.offense.space=pf1.utils.convertDistance(+F).join(" "),J.notes.offense.reach=pf1.utils.convertDistance(+L).join(" "),J.notes.offense.reachContext=W.convertStringUnits(B);let O=+L<+F?"long":"tall";Y.spaceReach={space:j,stature:await q.parse(O,z+Q)}}}if(!Y.spellLikeAbilities&&K.match(/Spell-Like\s+Abilities\b\s*/i))h1(J,K,z,!0,!1),W.log(`Spell-Like Abilities found: ${Z0}, ${j0[Z0]}`);if(!Y.psychicMagic&&K.match(/^Psychic\s+Magic\b\s*/i))h1(J,K,z,!1,!0),L0[W0].spells.push(Z[z+1]),z++;if(!Y.spellBooks&&/(?:Spells|Extracts) (?:Prepared|Known)\b\s*/i.test(K))h1(J,K,z,!1,!1),W.log(`Spellbook ${Z0}, ${j0[Z0]}`);if(W0!==0&&Z0<=W0&&+z>+j0[Z0]){if(/Spell-Like|Spells|Extracts (?:Prepared|Known)|Psychic Magic/gi.test(K)===!1)L0[Z0].spells.push(K)}if(z==Z.length-1){let q=window.SBC,j=0,F={};if(await W.runParallelOps(Object.values(L0),async(L,B)=>{let O=new H0(q.app);W.log(`Spellbook ${B} Processing: ${L.spellBookType}`,L);let[E,N,P]=await O.parse(L,j0[B]);if(P)F[N]=E0[j],j++;W.log(`Spellbook ${B} Results: ${E} - ${N} - ${P}`)}),j>0){let L={},B=window.SBC.actor.system.attributes.spells.spellbooks,O=new Set(Object.keys(B)),E=[],N=window.SBC.actor.itemTypes.spell;for(let[P,M]of Object.entries(F)){if(M===P){O.delete(M);continue}L[M]=pf1.utils.deepClone(B[P]),N.filter((R)=>R.system.spellbook===P).forEach((R)=>{E.push({_id:R._id,"system.spellbook":M})}),J.characterData.conversionValidation.spellBooks[M]=pf1.utils.deepClone(J.characterData.conversionValidation.spellBooks[P]),delete J.characterData.conversionValidation.spellBooks[P],O.delete(M)}O.forEach((P)=>{L[P]=H0.getDefaultSpellbookData()}),await window.SBC.actor.update({"system.attributes.spells.spellbooks":L}),await window.SBC.actor.updateEmbeddedDocuments("Item",E)}if(!G)await F1(J);else Y.specialAttacks=await O5(J,_.text,_.line),await F1(J),Y.melee=await V1(X,"mwak"),Y.ranged=await V1(H,"rwak")}}catch(K){window.SBC.settings.getSetting("debug")&&console.error(K);let q=`Parsing the offense data failed at line ${Q+z+1}`,j=new f(f.ERRORLEVELS.ERROR,"Parse/Offense",q,z+Q);return J.errors.push(j),window.SBC.settings.getSetting("debug")&&console.groupEnd(),!1}return W.log("RESULT OF PARSING OFFENSE DATA (TRUE = PARSED SUCCESSFULLY)"),W.log(Y),window.SBC.settings.getSetting("debug")&&console.groupEnd(),!0}async function x0(J,Z,Q,Y){let X=A.map.offense.speed,H=new RegExp(`${Q}\\s*($|[^,]*)`,"i"),G=J.match(H)[1].trim();return await X.parse(G,Y,Z)}function FJ(J,Z,Q,Y){let X=new RegExp(`^${Z}\\s*(.*)`,"i"),H=J.match(X)[1].trim();if(H.match(/(or|and)$/i))H+=" "+Q.trim();return{text:H,line:Y}}async function V1(J,Z){return await A.map.offense.attacks.parse(J.text,J.line,Z)}async function O5(J,Z,Q){let Y=A.map.offense.specialAttacks,X=Z.match(/^Special\s+Attacks?\s*(.*)/i)[1].trim(),[H,G]=await Y.parse(X,Q,["special-attacks","class-abilities"],["feat"],["classFeat"],!1);return J.notes.offense.specialAttacks=G,H}async function P5(J,Z){let Q=A.map.offense.space,Y=J.match(/^Space\s*(\S+)\s+/i)[1];Y=Y.replace(/(.)-(.)/g,"$1.$2");let X=Y.match(/(\d*)\.+(\d*)\/+(\d*)/);if(X?.length>0)Y=+X[1]+X[2]/X[3];let H=Math.round(Y/0.5)*0.5/5,G=await Q.parse(H,Z);return Promise.resolve([G,Y])}async function E5(J){let Z=W.parseSubtext(J.match(/Reach(.*)/i)[1]),Q="",Y="";if(Z[0]){Q=Z[0],Q=Q.replace(/(.)-(.)/g,"$1.$2");let X=Q.match(/(\d*)\.+(\d*)\/+(\d*)/);if(X?.length>1)Q=+X[1]+X[2]/X[3];Q=Q.replace(/(\d+\.?\d*)(.*)/g,"$1")}if(Z[1])Y=Z[1].replace(/[()]/g,"").trim();return Promise.resolve([Q,Y])}function B5(J){return J.match(/\bCL\b\s*(?<cl>\d+)/i)?.groups.cl??0}function N5(J){return J.match(/\b(Concentration\b|Conc\.)\s*\+(?<bonus>\d+)/i)?.groups?.bonus}function h1(J,Z,Q,Y,X){let H="_hd",G="prepared",_="spelllike",z=null,K=!1;if(!Y&&!X){G=Z.match(/Prepared/i)?"prepared":"spontaneous",H="hd",K=!!Z.match(/Extracts/i),_=null;let F=N0(!1).exec(Z)?.groups?.class;if(F){if(H=F,!window.SBC.actor.itemTypes.class.find((B)=>B.name.match(new RegExp(F,"i"))))H="hd",z=`${F} ${W.translate("spellbookName.spells"+(G==="prepared"?"Prepared":"Known"))}`}else{let L=window.SBC.actor.itemTypes.class.find((B)=>B.system.casting&&B.system.casting.type===G);H=L?L.name:"hd"}Z0=W0,W0++,W.log(`Current Spellbook: ${Z0}, Spellbooks found: ${W0}`),_=E0[Z0]}else if(X)Z0=W0,W0++,G="points",_=E0[Z0];else Z0=W0,W0++,_=E0[Z0];let q=B5(Z),j=N5(Z)??q;if(j1.includes(_)){let F=M5();L0[F]=duplicate(L0[Z0]),L0[F].spellBookType=E0[F],j0[F]=j0[Z0]}L0[Z0]={firstLine:Z,spells:[],spellCastingType:G,spellCastingClass:H,casterLevel:q,concentrationBonus:j,spellBookType:_,isSpellLike:Y,isAlchemist:K,spellBookName:z},j0[Z0]=Q,j1.push(_),console.log(`Current Spellbook: ${Z0}, Spellbooks found: ${W0}`)}async function F1(J){let Z=window.SBC.actor.itemTypes.feat.filter((Y)=>Y.system.subType==="classFeat"),Q=Object.values(window.SBC.config.weaponGroups);for(let Y of Z){let X=W.parseSubtext(Y.name.toLowerCase());X.shift();for(let H of X){let G=Q.find((_)=>H.includes(_));if(G){let _=parseInt(H.match(/\+(\d+)/)?.[1]??0);W.log(`Found Group ${G}, Found Bonus ${_}`);let z=Object.keys(window.SBC.config.weaponGroups)[Q.indexOf(G)];if(G&&_>0&&!Object.keys(J.characterData.weaponGroups).includes(z))J.characterData.weaponGroups[z]=_}}}W.log("Weapon Groups",J.characterData.weaponGroups)}function M5(){return parseInt(Object.keys(E0).find((J)=>!j1.includes(E0[J])))}async function LJ(J,Z,Q){window.SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING SPECIAL ABILITY DATA");let Y=[],X=0;J.notes.specialAbilities=[];let H=A.map.specialAbilities;for(let G=1;G<Z.length;G++)try{let _=Z[G],z=`specialAbility-${X}`;if(!Y[z])Y[z]=await H.parse(_,Q+G),X+=+!!Y[z]}catch(_){window.SBC.settings.getSetting("debug")&&console.error(_);let z=`Parsing the special abilities failed at line ${Q+G+1} (non-critical)`,K=new f(f.ERRORLEVELS.WARNING,"Parse/Special Abilities",z,G+Q);return J.errors.push(K),window.SBC.settings.getSetting("debug")&&console.groupEnd(),!1}return W.log("RESULT OF PARSING SPECIAL ABILITY DATA (TRUE = PARSED SUCCESSFULLY)"),W.log(Y),window.SBC.settings.getSetting("debug")&&console.groupEnd(),!0}var g1=!1,OJ=!1,L1="",D1=-1;async function PJ(J,Z,Q){window.SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING STATISTICS DATA");let Y=[];J.notes.statistics={},J.treasureParsing.statisticsStartLine=Q;let X=[],H=0,G="",_=0;g1=!1,OJ=Z.some((z)=>/\b((?:Combat |Other |^)Gear)\b/i.test(z)),L1="",D1=-1;for(let z of["consumable","equipment","loot","weapon","container"])await Promise.all(window.SBC.actor.itemTypes[z]?.map(async(K)=>await K.delete()));for(let z=0;z<Z.length;z++)try{let K=Z[z];if(!Y.bab&&K.match(/^Base Atk\b/i)){let q=K.match(/Base Atk\b\s*([+-]?\d+)/gi)[0].replace(/Base Atk\b\s*/i,"");J.characterData.conversionValidation.attributes.bab=+q}if(!Y.cmb&&K.match(/\bCMB\b/i))Y.cmb=await R5(J,K,Q+z);if(!Y.cmd&&K.match(/\bCMD\b/i))Y.cmd=await v5(J,K,Q+z);if(!Y.feats&&K.match(/^Feats\b/i))Y.feats=await U5(J,K,Q+z);if(!Y.languages&&K.match(/^Languages\b/i))Y.languages=await S5(J,K,Q+z);if(/((?:Combat |Other |^)Gear)\b/i.test(K))Y.gear=await w5(J,K,Q+z),g1=!0;if(!Y.abilities){if(/(Str|Dex|Con|Int|Wis|Cha)\s*(\d+|-)/i.test(K)&&!X.length)X=K.match(/((Str|Dex|Con|Int|Wis|Cha)\s*(\d+|-))/gi),H=z;if(f5(z,Z.length)&&X.length>0){for(let q=0;q<X.length;q++)await I5(X[q],J,H);Y.abilities=!0}}if(!Y.skills){if(K.match(/^Skills\b/i))L1=K.match(/Skills\b\s*(.*)/i)[1].replace(/\s*[,;]+/g,",").trim(),D1=Q+z,Y.skills=!0}if(!Y.sq){if(K.match(/^SQ\b/i))G=K,_=z;if(G&&Y.abilities)Y.sq=await x5(J,G,Q+_)}}catch(K){window.SBC.settings.getSetting("debug")&&console.error(K);let q="Parsing the statistics data failed at the highlighted line",j=new f(f.ERRORLEVELS.ERROR,"Parse/Statistics",q,Q+z+1);return J.errors.push(j),J.input.prepared.success=!1,window.SBC.settings.getSetting("debug")&&console.groupEnd(),!1}return W.log("RESULT OF PARSING STATISTICS DATA (TRUE = PARSED SUCCESSFULLY)"),W.log(Y),window.SBC.settings.getSetting("debug")&&console.groupEnd(),!0}async function R5(J,Z,Q){let Y=A.map.statistics.cmb,X=Z.match(/CMB\s+([+-]?(\d+)?\s*(\(.*\))?;?)/i)[1].trim().replace(";",""),H=X.match(/^([+-](\d+)?)/)?.[0]??null;J.flags.hasNoCMB=!H,H=H??0;let G=W.parseSubtext(X)[1];if(!J.flags.hasNoCMB)J.characterData.conversionValidation.attributes.cmb=+H;if(G){let _=G,z,K=/\+?(-?\d+)/g;while((z=K.exec(G))!==null){let q=+z[1],j=W.prefixNumber(q-+H),F=z[0].length;G=G.substring(0,z.index)+j+G.substring(z.index+F),K.lastIndex+=j.length}J.notes.statistics.cmbContext=" ("+_+")",J.miscNotes.cmbNotes=G??""}return await Y.parse(+H,Q)}async function v5(J,Z,Q){let Y=A.map.statistics.cmd,X=Z.match(/CMD\s+([+-]?(\d+)?\s*(\(.*\))?;?)/i)[1].trim().replace(";",""),H=X.match(/^[+-]?(\d+)?/)?.[0]??null;J.flags.hasNoCMD=!H,H=H??0;let G=W.parseSubtext(X)[1];if(!J.flags.hasNoCMD)J.characterData.conversionValidation.attributes.cmd=+H;if(G){let _=G,z,K=/\+?(-?\d+)/g;while((z=K.exec(G))!==null){let q=+z[1],j=W.prefixNumber(q-+H),F=z[0].length;G=G.substring(0,z.index)+j+G.substring(z.index+F),K.lastIndex+=j.length}J.notes.statistics.cmdContext=" ("+_+")",J.miscNotes.cmdNotes=G??""}return await Y.parse(+H,Q)}async function U5(J,Z,Q){let Y=window.SBC,X=A.map.statistics.feats,H=Z.match(/Feats\b\s*(.*)/i)[1].replace(/\s*[,;]+/g,",").trim(),[G,_]=await X.parse(H,Q,"feats","feat","feat");if(J.notes.statistics.feats=_,!Y.settings.getSetting("createAssociations")){let z=Y.compendiumSearch;if(Y.actor.getFeatCount().excess>0){let q={search:W.createSearchSet(["Bonus Feat","Bonus Feats","Bonus Combat Feats"],!0),item:"Bonus Feats"},j=await z.findEntityInCompendia(q,{itemType:"feat",itemSubType:"classFeat",classes:J.characterData.classes,race:J.characterData.race});if(j)await W.addAssociatedClass(j,Y.actor.itemTypes.class),await D(j)}}return await T5(J),G}async function S5(J,Z,Q){let Y=A.map.statistics.languages,X=Z.match(/Languages\b\s*(.*)/i)[1].replace(/\s*[,;]+/g,",").trim();return await Y.parse(X,Q)}async function x5(J,Z,Q){let Y=A.map.statistics.sq,X=Z.match(/SQ\b\s*(.*)/i)[1].replace(/\s*[,;]+\s*/g,", ").trim(),[H,G]=await Y.parse(X,Q,["monster-abilities","class-abilities"],["equipment","feat","weapon"],null,!1);return J.notes.statistics.sq=G,H}async function w5(J,Z,Q){let Y=A.map.statistics.gear,X=Z.replace(/(Combat Gear|Other Gear|Gear)/g,"").replace(/[,;]+/g,",").replace(/[,;]$/,"").trim();if(!J.notes.statistics.gear)J.notes.statistics.gear=[];return await Y.parse(X,Q)}async function I5(J,Z,Q){let Y=J.match(/(\w+)/)[1],X=J.match(/(\d+|-)/)[1];if(X==="-"||X===0||X==="0"){X=0;let K="no"+Y.capitalize();Z.flags[K]=!0}let H=await W.getTotalFromChanges(window.SBC.actor,Y),G=A.map.base.age.getAbilityChange(Y.toLowerCase()),_=+X-H-G;Z.characterData.conversionValidation.attributes[Y]=+X,Z.notes.statistics[Y.toLowerCase()]=+X,await A.map.statistics[Y.toLowerCase()].parse(+_,Q)}function f5(J,Z){if(!OJ)return!0;return g1||J===Z-1}async function T5(J){let Z=window.SBC.actor.itemTypes.feat.filter((Q)=>Q.system.subType==="feat");for(let Q of Z){let Y=Q.name.toLowerCase(),X=W.parseSubtext(Y)[1];if(!X)continue;if(/greater weapon focus/.test(Y))J.characterData.weaponFocusGreater.push(X);else if(/weapon focus/.test(Y))J.characterData.weaponFocus.push(X);else if(/greater weapon specialization/.test(Y))J.characterData.weaponSpecializationGreater.push(X);else if(/weapon specialization/.test(Y))J.characterData.weaponSpecialization.push(X)}W.log("Weapon Focus",J.characterData.weaponFocus),W.log("Weapon Focus Greater",J.characterData.weaponFocusGreater),W.log("Weapon Specialization",J.characterData.weaponSpecialization),W.log("Weapon Specialization Greater",J.characterData.weaponSpecializationGreater)}async function EJ(){let J={act:["blf","dis"],comedy:["blf","int"],dance:["acr","fly"],keyboard:["dip","int"],oratory:["blf","sen"],percussion:["han","int"],sing:["blf","sen"],string:["blf","dip"],wind:["dip","han"]},Z=window.SBC,Q=A.map.statistics.skills,Y=L1.split(/racial (?:modifiers?|bonus)/i)[0];Y=Q.splitText(Y);for(let H of Z.actor.itemTypes.feat.filter((G)=>G.system.subType==="classFeat"&&G.name.match(/Versatile Performance \(/i))){let G=W.parseSubtext(H.name)[1],_=J[G.toLowerCase()],z=Y.find((K)=>K.startsWith(`Perform (${G.toLowerCase()}`));if(_&&z){let K=z.match(/([+-]?\d+)/)[1];for(let q of _){let j=Z.actor.getSkillInfo(q).name,F=Y.find((L)=>L.startsWith(j));if(F)if(F.match(/([+-]?\d+)/)[1]===K)Q.versatilePerformanceSkillOverrides[q]={name:G.toLowerCase(),value:K};else if(Q.versatilePerformanceSkillDisablers[q])Q.versatilePerformanceSkillDisablers[q].push(G);else Q.versatilePerformanceSkillDisablers[q]=[G]}}}if(await Q.parse(L1,D1),Z.app.processData.characterData.isOutsider){let H=Z.actor.items.get(Z.app.processData.characterData.outsiderId);if(!H)return;let G={};Z.app.processData.characterData.outsiderSkills.forEach((_)=>G[`system.classSkills.${_}`]=!0),await H.update(G)}if(Z.app.processData.characterData.isExpert){let H=Z.actor.items.get(Z.app.processData.characterData.expertId);if(!H)return;let G={};Z.app.processData.characterData.expertSkills.forEach((_)=>G[`system.classSkills.${_}`]=!0),await H.update(G)}let X={};for(let H of Object.keys(Q.versatilePerformanceSkillDisablers))for(let G of Q.versatilePerformanceSkillDisablers[H]){let _=Z.actor.allSkills.find((z)=>Z.actor.getSkillInfo(z).name===G)?.replace("prf.","");if(_)X[`${_}_${H}`]=!0}if(Object.keys(X).length>0)await Z.actor.setFlag(Z.rollBonusOps.flagKey,"vp_disable_prf",X)}async function BJ(J,Z,Q){window.SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING TACTICS DATA");let Y=[];J.notes.tactics={hasTactics:!0};let X=A.map.tactics;for(let H=0;H<Z.length;H++)try{let G=Z[H];if(!Y.beforeCombat&&G.match(/Before Combat/i)!==null)Y.beforeCombat=await C5(X,J,G,Q+H);if(!Y.duringCombat&&G.match(/During Combat/i)!==null)Y.duringCombat=await A5(X,J,G,Q+H);if(!Y.morale&&G.match(/^Morale/i)!==null)Y.morale=await h5(X,J,G,Q+H);if(!Y.baseStatistics&&G.match(/^Base Statistics/i)!==null)Y.baseStatistics=await g5(X,J,G,Q+H)}catch(G){window.SBC.settings.getSetting("debug")&&console.error(G);let _=`Parsing the tactics data failed at line ${Q+H+1} (non-critical)`,z=new f(f.ERRORLEVELS.WARNING,"Parse/Tactics",_,H+Q);return J.errors.push(z),window.SBC.settings.getSetting("debug")&&console.groupEnd(),!1}return W.log("RESULT OF PARSING TACTICS DATA (TRUE = PARSED SUCCESSFULLY)"),W.log(Y),window.SBC.settings.getSetting("debug")&&console.groupEnd(),!0}async function C5(J,Z,Q,Y){let X={name:"Before Combat",entry:Q.match(/^(?:Before Combat)([\s\S]*?)(?=$|During Combat|Morale|Base Statistics)/i)[1]};return Z.notes.tactics.beforeCombat=X.entry,await J.parse(X,Y)}async function A5(J,Z,Q,Y){let X={name:"During Combat",entry:Q.match(/^(?:During Combat)([\s\S]*?)(?=$|Morale|Base Statistics)/i)[1]};return Z.notes.tactics.duringCombat=X.entry,await J.parse(X,Y)}async function h5(J,Z,Q,Y){let X={name:"Morale",entry:Q.match(/^(?:Morale)([\s\S]*?)(?=$|Base Statistics)/i)[1]};return Z.notes.tactics.morale=X.entry,await J.parse(X,Y)}async function g5(J,Z,Q,Y){let X={name:"Base Statistics",entry:Q.match(/^(?:Base Statistics)([\s\S]*?)$/i)[1]};return Z.notes.tactics.baseStatistics=X.entry,await J.parse(X,Y)}class G0{static async prepareInput(J){let Z=window.SBC;if(Z.isImporting=!0,window.SBC.settings.getSetting("debug")&&console.group("sbc-pf1 | PREPARING INPUT"),J.input.text==="")throw J.errors.push(new f(f.ERRORLEVELS.FATAL,"Prepare","Given input is empty.")),"Given input is empty.";try{if(game.modules.get("roll-bonuses-pf1")?.active)W.log("Roll Bonuses PF1 module is active"),J.flags.rollBonusesPF1=!0;$("#sbcProgressBar").css("width","5%");let Q=new RegExp("("+Z.config.sources.join("\\b|")+")","gm");J.input.prepared.data=J.input.text.replace(/[]/gm,"-").replaceAll("","x").replace(/,+/gm,",").replaceAll("","1/2").replaceAll("","1/3").replaceAll("","1/4").replaceAll("","1/5").replaceAll("","1/6").replaceAll("","1/8").replace(Q,"").replace(/([a-z])B\b/gm,"$1").replace(/([a-z])M\b,\s*MA/gm,"$1M").replaceAll("",'"').replaceAll("",'"').replaceAll("","'").replaceAll("","'").replaceAll("","fl").replaceAll("","fi").replaceAll("","ff").replaceAll("","ffi").replaceAll("","ffl").replaceAll("","st").replace(/^-{20}$/gm,"").replace(/\*, (D,?)/g,"$1").split(/\n/g),W.log("Before: ",J.input.prepared.data);let Y=[],X=new RegExp("^("+Z.config.lineCategories.join("|")+")","i"),H=new RegExp("^("+Z.config.lineStarts.join("|")+")(?!\\))","i");J.input.prepared.data.forEach((_,z)=>{if(X.test(_)){if(_.match(/Offenses|Defenses/i))_=_.replace("Offenses","Offense").replace("Defenses","Defense");console.log(_,X),_=_.toLowerCase().capitalize()}if(_&&Z.config.lineStarts.some((K)=>_.startsWith(K)))Y.push(_);else if(z>0&&H.test(Y[Y.length-1])&&!H.test(_)&&!/^Description/i.test(Y[Y.length-1]))Y[Y.length-1]+=" "+_;else Y.push(_)});let G=0;for(let _=0;_<Y.length;_++){let z=Y[_];if(z.toLowerCase().startsWith("ecology")){G=_;continue}if(G&&z.toLowerCase().match(/^Treasure\s+(?:NPC gear|standard|double|triple)\s*\(.*\)/i)){let K="Gear "+z.replace(/^Treasure\s+(?:NPC gear|standard|double|triple)\s*\((.*?)(?:,\s+other treasure)?\)\s*$/i,"$1").replaceAll("[","(").replaceAll("]",")");Y.splice(_,1),Y.splice(G,0,K);break}}Y=Y.filter((_)=>!_.startsWith("*")),J.input.prepared.data=Y,W.log("After: ",J.input.prepared.data),J.input.prepared.success=!0,J.input.text=J.input.prepared.data.join(`
`)}catch(Q){let Y=new f(f.ERRORLEVELS.FATAL,"Prepare",Q);throw J.errors.push(Y),J.input.prepared.success=!1,Q}window.SBC.settings.getSetting("debug")&&console.groupEnd()}static async parseInput(J){window.SBC.settings.getSetting("debug")&&console.group("sbc-pf1 | PARSING INPUT");let Z=J.characterData,Q=J.input.text;if(Z==null||!Q){if(Z==null)J.errors.push(new f(f.ERRORLEVELS.FATAL,"Input","No valid characterData found"));if(!J.input.text)J.errors.push(new f(f.ERRORLEVELS.FATAL,"Parse","Not enough input found to parse"));J.input.prepared.success=!1}if(J.input.prepared.success){let Y=window.SBC.actor.type;try{G0.updateProgressBar(J,"Preparation","Clean-up");let X=A.map.types[Y];console.log(X);let H={};for(let K=1;K<X.length;K++){let q=X[K],j=new RegExp("^\\b"+q+"\\b\\s*(?:\\r?\\n|$)","i");J.input.prepared.data.filter(function(F,L){if(j.test(F)&&H[q]==null)H[q]=L})}let G=Object.keys(H),_=G.join(", ").capitalize();G.unshift("base");let z={};if(J.foundCategories=G.length,console.log("Found Categories: ",G,G.length),G.length!==0){let K=A.getNeededCategories(Y);if(K.length?K.every((j)=>G.includes(j)):!0){let j={base:[],description:[]},F={base:0,description:0};if(["npc","character"].includes(Y))j=foundry.utils.mergeObject(j,{defense:[],offense:[],statistics:[],tactics:[],ecology:[],specialAbilities:[]}),F=foundry.utils.mergeObject(F,{defense:0,offense:0,statistics:0,tactics:0,ecology:0,specialAbilities:0});let L=0;for(let O=0;O<G.length;O++){let E=G[O],N=L;F[E]=N;let P=H[G[O+1]];if(O===G.length-1)j[E]=J.input.prepared.data.slice(N);else j[E]=J.input.prepared.data.slice(N,P);L=P}let B=G;if(["npc","character"].includes(Y)){if(B.splice(G.indexOf("statistics"),1),B.splice(1,0,"statistics"),G.includes("special abilities"))B.splice(G.indexOf("special abilities"),1),B.splice(0,0,"special abilities")}for(let O=0;O<B.length;O++){let E=B[O];G0.updateProgressBar(J,"Parsing",E,B.length,O+1),z[E]=await G0.parseCategories(J,E,j[E],F[E])}if(["npc","character"].includes(Y))G0.updateProgressBar(J,"Buffs","Looking for Auras and Buffs"),await zJ(),await D5(),G0.updateProgressBar(J,"Flags","Checking if Special Flags were set"),await f1(J),await d5(J),await window.SBC.rollBonusOps.processTargets(window.SBC.actor.allItems),await C1.conversionValidation(J);G0.updateProgressBar(J,"Preview","Generating Preview"),await y5(J),J.input.prepared.success=!0,G0.updateProgressBar(J,"Ready","Actor is ready")}else{let j=`Failed to find enough keywords to parse the input.<br>
                                        Found Keywords: ${_}<br>
                                        Needed Keywords: Defense, Offense, Statistics<br>
                                        Optional Keywords: Special Abilities, Ecology, Tactics, Description`,F=new f(f.ERRORLEVELS.FATAL,"Parse",j);J.errors.push(F),J.input.prepared.success=!1,G0.updateProgressBar(J,"Error","An Error occurred during parsing")}}else{console.log("No categories found");let K=`Failed to find any keywords to parse the input.<br>
                                        Needed Keywords: Defense, Offense, Statistics<br>
                                        Optional Keywords: Special Abilities, Ecology, Tactics, Description`,q=new f(f.ERRORLEVELS.FATAL,"Parse",K);J.errors.push(q),J.input.prepared.success=!1,G0.updateProgressBar(J,"Error","An Error occurred during parsing")}}catch(X){let H="parseInput() failed with an unspecified error. Sorry!",G=new f(f.ERRORLEVELS.FATAL,"Parse",H);throw J.errors.push(G),J.input.prepared.success=!1,G0.updateProgressBar(J,"Error","An Error occurred during parsing"),X}}else{let Y="parseInput() failed as the input could not be prepared successfully",X=new f(f.ERRORLEVELS.FATAL,"Parse",Y);J.errors.push(X),J.input.prepared.success=!1,G0.updateProgressBar(J,"Error","An Error occurred during parsing")}window.SBC.settings.getSetting("debug")&&console.groupEnd()}static async parseCategories(J,Z,Q,Y){switch(Z){case"base":await WJ(J,Q,Y);break;case"defense":await KJ(J,Q,Y);break;case"offense":await jJ(J,Q,Y),window.SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | >> PARSING SKILL DATA"),await EJ(),window.SBC.settings.getSetting("debug")&&console.groupEnd();break;case"statistics":await PJ(J,Q,Y);break;case"tactics":await BJ(J,Q,Y);break;case"ecology":await VJ(J,Q,Y);break;case"special abilities":await LJ(J,Q,Y);break;case"description":await qJ(J,Q,Y);break;default:J.errors.push(new f(f.ERRORLEVELS.ERROR,"Parse/Categories",`No Parser found for category: ${Z}`)),J.input.prepared.success=!1;return}J.parsedCategories++}static async updateProgressBar(J,Z="",Q="",Y=1,X=1){let H=0,G=Q,_=100/Y;switch(J.progressBar.class=Z.toLowerCase(),Z.toLowerCase()){case"preparation":H=10,G=Z+": "+Q;break;case"parsing":H=Math.floor(10+0.6*_*X),G=Z+": "+Q;break;case"buffs":H=90;break;case"flags":H=95;break;case"preview":H=99;break;case"actor":H=100;break;case"error":H=100;break;default:break}J.progressBar.width=H,J.progressBar.text=G,await window.SBC.app.render()}}var HJ=(J)=>{return W.parseSubtext(J)},XJ=async(J,Z,Q)=>{let Y=Z.split("."),X=J;for(let H=0;H<Y.length-1;H++)X=X[Y[H]]||{};X[Y[Y.length-1]]=Q},F0=async(J,Z,Q)=>{return J.update({[Z]:Q})};async function f1(J,Z="all"){W.log("Flags set during the conversion process"),W.log(J.flags);let Q=[],Y=Z==="all"?Object.keys(J.flags):[Z];for(let X of Y)if(J.flags[X]){let H=[],G=null,_="string",z=!1;switch(X){case"isUndead":if(H=["system.attributes.hpAbility","system.attributes.savingThrows.fort.ability"],J.flags[X]===!0)G="cha";else G="con";z=!0;break;case"noStr":H=["system.abilities.str.base","system.abilities.str.value","system.abilities.str.total"],z=!0,G="NaN";break;case"noDex":H=["system.abilities.dex.base","system.abilities.dex.value","system.abilities.dex.total"],z=!0,G="NaN";break;case"noCon":H=["system.abilities.con.base","system.abilities.con.value","system.abilities.con.total"],z=!0,G="NaN";break;case"noInt":H=["system.abilities.int.base","system.abilities.int.value","system.abilities.int.total"],z=!0,G="NaN";break;case"noWis":H=["system.abilities.wis.base","system.abilities.wis.value","system.abilities.wis.total"],z=!0,G="NaN";break;case"noCha":H=["system.abilities.cha.base","system.abilities.cha.value","system.abilities.cha.total"],z=!0,G="NaN";break;default:break}if(z){let K=window.SBC,q=new s(K.app,H,_);Q[X]=await q.parse(G,-1)}}}async function D(J){let Z=window.SBC;try{let Q=pf1.migrations.migrateItemData(J.toObject());if(!foundry.utils.isEmpty(Q))await J.updateSource(Q);return await J.updateSource({"system.links.supplements":[]}),[!0,(await Z.actor.createEmbeddedDocuments("Item",[J.toObject()]))[0]]}catch(Q){window.SBC.settings.getSetting("debug")&&console.error(Q);let Y=`Failed to create embedded item ${J.name}.`,X=new f(f.ERRORLEVELS.ERROR,"Parse",Y);return Z.app.processData.errors.push(X),Z.app.processData.input.prepared.success=!1,[!1,null]}}async function D5(){let J=window.SBC,Z=J.compendiumSearch;try{window.SBC.settings.getSetting("debug").debug&&console.groupCollapsed("sbc-pf1 | Finding Buffs");let Q=window.SBC.actor.items.filter((Y)=>["feat","consumable","spell"].includes(Y.type));for(let Y of Q){let X=Y.name,H=X.replace(/(constant|weekly|monthly|yearly):/gi,"").trim(),G=X.replace(/^(?:Potion|Wand) of\s+/gi,"").trim();console.log(`Checking ${X}`,Y);let _={search:new Set([X]),type:"buff",item:X},z=X.split(" ").slice(0,2).map((j)=>j.toLowerCase()),K=O0.find((j)=>{return j.split(" ").map((L)=>L.toLowerCase()).every((L)=>z.includes(L))});if(K)_.search.add(H.replace(new RegExp(`${K}`,"i"),"").trim()),_.search.add(G.replace(new RegExp(`${K}`,"i"),"").trim());else _.search.add(H),_.search.add(G);let q=await Z.findEntityInCompendia(_,{packs:["pf1.commonbuffs"],itemType:"buff",classes:J.app.processData.characterData.classes});if(!q)q=game.items.getName(_.name);if(!q)q=game.items.getName(_.altName);if(q){console.log(`Found ${X}.`,q);let j=0;switch(Y.type){case"spell":{let B=Y.system.spellbook;console.log(`Spellbook key for ${X}: ${B}`);let O=pf1.utils.deepClone(Y.spellbook);console.log(`Spellbook data for ${X}: `,O,O?.cl);let E=J.actor.system.attributes.spells.spellbooks[B]?.cl.total??-1;console.log(`Caster level for ${Y.name}: ${E}`)}break;case"consumable":j=Y.system.cl||0;break}if(j>0)q.updateSource({"system.level":j});console.log(`Creating buff for ${X}.`);let[F,L]=await D(q);if(/^Constant:/i.test(X))await L.update({"system.duration.value":""}),await L.setActive(!0)}}window.SBC.settings.getSetting("debug")&&console.groupEnd()}catch(Q){window.SBC.settings.getSetting("debug")&&console.error(Q)}}async function y5(J){let Z=await renderTemplate("modules/pf1-statblock-converter/templates/sbcPreview.hbs",{actor:window.SBC.actor||{},notes:J.notes,flags:J.flags}),Q=new Date,Y=await renderTemplate("modules/pf1-statblock-converter/templates/sbcNotes.hbs",{version:window.SBC.config.modData.version,date:Q.toLocaleString(game.settings?.get("core","language")||"en",{month:"long",day:"numeric",year:"numeric"}),preview:Z,rawInput:J.input.text});await window.SBC.actor?.update({"system.details.notes.value":Y})}async function d5(J){let Z=J.miscNotes,Q=window.SBC.actor,Y=[],X=[],H=`<p>This feature was created by <strong>SBC</strong> to collect any notes that don't have a source on the actor,
                such as saving throw details or a bonus to CMD from extra legs. It may also be used to record a natural armor bonus,
                spell resistance bonus, or spellcasting notes.</p>`,G=!1;if(Z.acNotes.length>0)G=!0,Y.push({target:"ac",text:Z.acNotes.join(", ")}),H+=`<p><strong>Armor Class Notes:</strong></p><p>${Z.acNotes.join(", ")}</p>`;if(Z.srNotes)G=!0,Y.push({target:"sr",text:Z.srNotes}),H+=`<p><strong>Spell Resistance Notes:</strong></p><p>${Z.srNotes}</p>`;if(Z.cmbNotes)G=!0,Y.push({target:"cmb",text:Z.cmbNotes}),H+=`<p><strong>CMB Notes:</strong></p><p>${Z.cmbNotes}</p>`;if(Z.cmdNotes)G=!0,Y.push({target:"cmd",text:Z.cmdNotes}),H+=`<p><strong>CMD Notes:</strong></p><p>${Z.cmdNotes}</p>`;if(Z.saveNotes)G=!0,Y.push({target:"allSavingThrows",text:Z.saveNotes}),H+=`<p><strong>Saving Throw Notes:</strong></p><p>${Z.saveNotes}</p>`;if(Z.sr>0)G=!0,X.push(await new pf1.components.ItemChange({formula:Z.sr.toString(),type:"untyped",target:"spellResist",value:+Z.sr}).toObject());if(Z.naturalAC>0)G=!0,X.push((await new pf1.components.ItemChange({formula:Z.naturalAC.toString(),type:"untyped",target:"nac",value:+Z.naturalAC})).toObject());if(!G)return;await Q.createEmbeddedDocuments("Item",[{name:"Miscellaneous Notes",type:"feat",system:{changes:X,contextNotes:Y,description:{value:H},subType:"misc",tag:"miscellaneousNotes"},img:"systems/pf1/icons/skills/yellow_36.jpg"}])}class w0{static get defaultData(){return{actorReady:!1,appData:{},characterData:{conversionValidation:{context:{},attributes:{},skills:{},spellBooks:{}},weaponFocus:[],weaponSpecialization:[],weaponFocusGreater:[],weaponSpecializationGreater:[],classes:[],archetypes:[],race:null,weaponGroups:{},hdMaximized:!1,prestigeClassCasting:new Map,isOutsider:!1,outsiderId:null,outsiderSkillPicks:4,outsiderSkills:[],isExpert:!1,expertId:null,expertSkillPicks:10,expertSkills:[],versatilePerformances:[]},changes:{},errors:[],flags:{hasNoCMB:!1,hasNoCMD:!1,noStr:!1,noDex:!1,noCon:!1,noInt:!1,noWis:!1,noCha:!1,isUndead:!1,isConstruct:!1,hasWeaponFinesse:!1},foundCategories:0,parsedCategories:1,imported:!1,input:{data:[],text:"",html:"",prepared:{data:[],success:!1},parsedSuccess:!1},miscNotes:{acNotes:[],cmdNotes:"",saveNotes:"",sr:0,srNotes:"",naturalAC:0,spellbookNotes:[]},notes:{},treasureParsing:{treasureToParse:"",lineToRemove:0,statisticsStartLine:0},progressBar:{class:"",text:"",width:0}}}}var{ApplicationV2:b5,HandlebarsApplicationMixin:k5}=foundry.applications.api;class y1 extends k5(b5){constructor(J,Z){super(Z);if(this.autoConvert=window.SBC.settings.getSetting("autoConvert"),this.processData=foundry.utils.mergeObject(w0.defaultData,{appData:J}),J.statblock){this.processData.input.text=J.statblock;let Q=this;setTimeout(async()=>{if(this.autoConvert)await Q.checkInput(document.getElementById("sbcInput"))},window.SBC.settings.getSetting("inputDelay"))}}static DEFAULT_OPTIONS={uniqueId:"sbcModal",id:"sbcModal",classes:["sbcModal"],position:{width:1024,height:768},window:{title:"SBCPF1.sbcTitle",resizable:!0}};get title(){return game.i18n.localize("SBCPF1.sbcTitle")}static PARTS={div:{scrollable:[".sbcInput",".sbcHighlights",".sbcPreview"],template:"modules/pf1-statblock-converter/templates/sbcModal.hbs"}};async close(J){if(!this.processData.imported&&window.SBC.actor?.id)await game.actors.get(window.SBC.actor.id)?.delete();window.SBC.app=null,super.close(J)}async _preparePartContext(J,Z,Q){let Y=window.SBC,X=await super._preparePartContext(J,Z,Q);X=foundry.utils.mergeObject(X,{input:this.processData.input.text,actorType:Y.actorType,choices:{0:"NPC",1:"PC"},errors:[],errorHighlights:[],preview:"",progressBar:{class:this.processData.progressBar.class,ready:this.processData.input?.prepared?.success||!1,text:this.processData.progressBar.text,width:this.processData.progressBar.width},autoConvert:this.autoConvert,badLanguage:game.settings.get("core","language")!=="en"}),this.processData.input.prepared.data.forEach((z,K)=>{X.errorHighlights.push({value:z,messageBefore:"",messageAfter:"",line:K,marked:!1})});let H=0,G="",_=0;if(this.processData.errors.forEach((z,K)=>{let q=z.errorLabel;if(z.level===f.ERRORLEVELS.ERROR||z.level===f.ERRORLEVELS.FATAL)q+=` >> ${z.keyword} failed `;if(q+=` >> ${z.message}`,q!==G){if(H=K,G=q,z.line!==-1&&z.value){let j=this.processData.input.prepared.data[z.line],F=z.value.trim(),[L,B]=j.split(F);X.errorHighlights[z.line]={value:F,messageBefore:L,messageAfter:B,line:z.line,marked:!0}}X.errors.push({message:q,duplicates:_})}else X.errors[H].duplicates=_,_++}),X.progressBar.ready)X.preview=await renderTemplate("modules/pf1-statblock-converter/templates/sbcPreview.hbs",{actor:window.SBC.actor,notes:this.processData.notes,flags:this.processData.flags});return X}_onRender(J,Z){super._onRender(J,Z);let Q=this.element.querySelector("#sbcInput"),Y=this.element.querySelectorAll(".actorTypeToggle"),X=this;for(let K=0;K<Y.length;K++)Y[K].addEventListener("click",this.toggleActorType.bind(this,Q));Q.addEventListener("keyup",m5(async()=>{if(X.autoConvert)await X.checkInput(Q)},window.SBC.settings.getSetting("inputDelay"))),Q.addEventListener("scroll",this.syncScrolls.bind(this)),this.element.querySelector("#sbcAutoConvertToggle").addEventListener("click",async(K)=>{let q=K.target.checked;if(X.autoConvert=q,W.log(`Auto Convert is now ${q?"enabled":"disabled"}`),q)await X.checkInput(Q);else await X.render(!0)}),this.element.querySelector("#sbcConvertButton").addEventListener("click",async()=>{let K=document.getElementById("sbcInput");await X.checkInput(K)}),this.element.querySelector("#sbcImportButton").addEventListener("click",this.import.bind(this)),this.element.querySelector("#sbcResetButton").addEventListener("click",this.resetSBC.bind(this))}syncScrolls(J){let Z=document.getElementById("sbcInput"),Q=document.getElementById("sbcBackdrop");Q.scrollTop=Z.scrollTop}async toggleActorType(J,Z){let Q=window.SBC.config;W.log(`Switching between ${Q.const.actorType[window.SBC.actorType]} and ${Q.const.actorType[+Z.target.value]} actor type.`),window.SBC.actorType=Z.target.value,window.SBC.configInitialized=!1,window.SBC.actor=await W.reinitActor(window.SBC.actor);let Y=this.processData.input.text,X=this.processData.appData;this.processData=foundry.utils.mergeObject(w0.defaultData,{appData:X}),this.processData.input.text=Y,J.value=Y,window.SBC.configInitialized=!0,J.dispatchEvent(new Event("keyup"))}async checkInput(J){if(!window.SBC.configInitialized)return;if(window.SBC.isImporting)return;let Z=this.processData.appData;if(this.processData=foundry.utils.mergeObject(w0.defaultData,{appData:Z}),this.processData.input.text=J.value.trim(),window.SBC.actor=await W.reinitActor(window.SBC.actor),this.processData.input.text){this.processData.actorReady=!1;try{await G0.prepareInput(this.processData)}catch(Q){console.error(Q)}try{await G0.parseInput(this.processData)}catch(Q){J.value=this.processData.input.prepared.data.join(`
`),window.SBC.isImporting=!1,await this.render()}if(J.value=this.processData.input.prepared.data.join(`
`),this.processData.input.prepared.success)window.SBC.isImporting=!1,this.processData.actorReady=!0,Hooks.callAll("sbc.inputParsed"),await this.render();else{window.SBC.isImporting=!1,console.error("Could not parse the input");let Q=new f(f.ERRORLEVELS.FATAL,"Parse","Could not parse the input");this.processData.errors.push(Q),await this.render()}}else await this.render()}async import(){if(window.SBC.isImporting)return;if(console.log("Importing..."),W.log("Finished parsing. Importing..."),!this.processData.input.text){let J=new f(f.ERRORLEVELS.FATAL,"Input","No Input found");this.processData.errors.push(J)}else if(!this.processData.actorReady){let J=new f(f.ERRORLEVELS.FATAL,"Import","Could not create an Actor");this.processData.errors.push(J)}else{let J=window.SBC.actor.toObject(),Z=pf1.migrations.migrateActorData(J,null,{actor:window.SBC.actor});Z.folder=window.SBC.folderId;let Q=window.SBC.actor.system.attributes.hp;if(Q.value!==Q.max)Z=foundry.utils.mergeObject(Z,{attributes:{hp:{value:Q.max}}});let Y=[];for(let X of Object.values(window.SBC.actor.itemTypes))Y=Y.concat(X.sort((H,G)=>H.name.localeCompare(G.name)).map((H,G)=>({_id:H.id,sort:112500+G*15})));await window.SBC.actor.updateEmbeddedDocuments("Item",Y),await window.SBC.actor.update(Z),await window.SBC.actor.performRest({restoreHealth:!1}),this.processData.imported=!0,await this.close();return}this.render(!0)}async resetSBC(){let J=this.processData.appData;this.processData=foundry.utils.mergeObject(w0.defaultData,{appData:J}),window.SBC.actor=await W.reinitActor(window.SBC.actor),this.render(!0)}}function m5(J,Z){let Q;return(...Y)=>{clearTimeout(Q),Q=setTimeout(function(){J.apply(this,Y)},Z)}}class W{static async createActor(){let J=await Actor.create({name:"sbc | Actor Template",type:window.SBC.config.const.actorType[window.SBC.actorType],folder:window.SBC.wipFolderId});return await this.setTokenData(J),J}static async reinitActor(J){if(J){if(game.actors.get(J.id))W.log(`Deleting actor ${J.name} with ID ${J.id}.`,void 0,"info"),await J.delete()}return await W.createActor()}static async setTokenData(J){let Z=J.type==="character"?"pc":"npc";return await J.update({prototypeToken:{displayName:window.SBC.settings.getSetting("displayName"),sight:{enabled:window.SBC.settings.getSetting(`${Z}sight`)},disposition:window.SBC.settings.getSetting("disposition"),displayBars:window.SBC.settings.getSetting("displayBars"),bar1:window.SBC.settings.getSetting("attributeBar1"),bar2:window.SBC.settings.getSetting("attributeBar2"),brightSight:0}})}static log(J,Z=null,Q="debug"){let Y=console[Q];if(Y==="debug"&&!window.SBC.settings.getSetting("debug"))return;let X=`
`+new Error().stack.split(`
`).slice(2,3).join(`
`);if(Z)Y("sbc-pf1 | "+J,Z,X);else Y("sbc-pf1 | "+J,X)}static async generatePlaceholderEntity(J,Z=-1){let Q={name:J.name?J.name:J.item?J.item:"undefined",type:J.type?J.type:null,changes:J.changes||[],creatureTypes:J.creatureTypes?J.creatureTypes:[],creatureSubtypes:J.creatureSubtypes?J.creatureSubtypes:[],img:J.img?J.img:"systems/pf1/icons/skills/yellow_36.jpg",size:J.size?J.size:"med",sources:J.sources?J.sources:[],subtext:J.subtext?J.subtext:null,currency:J.currency?J.currency:null,price:J.price||0,enhancement:J.enhancement?J.enhancement:null,mwk:J.mwk?J.mwk:null,quantity:J.quantity?J.quantity:null,wizardClass:J.wizardClass?J.wizardClass:null,suffix:J.suffix?J.suffix:null,archetype:J.archetype?J.archetype:null,level:J.level?J.level:null,specialAbilityType:J.specialAbilityType?J.specialAbilityType:"na",desc:J.desc?J.desc:"sbc | Placeholder"},Y=null;switch(J.type){case"container":Y=new Item.implementation({name:Q.name,type:"container",system:{description:{value:"sbc | All currency carried was put into this container."},currency:{pp:Q.currency.pp,gp:Q.currency.gp,sp:Q.currency.sp,cp:Q.currency.cp},weightReduction:100},img:"systems/pf1/icons/items/inventory/pouch-sealed.jpg"});break;case"feat":case"feats":Y=new Item.implementation({name:Q.name.capitalize(),type:"feat",system:{description:{value:"sbc | As "+Q.name+" could not be found in any compendium, a placeholder was generated."}},img:Q.img});break;case"race":Y=new Item.implementation({name:Q.name.capitalize(),type:"race",system:{creatureTypes:Q.creatureTypes,description:{value:Q.desc||"sbc | As no playable race was found a placeholder was generated."},size:Q.size,creatureSubtypes:Q.creatureSubtypes,sources:Q.sources},img:Q.img});break;case"misc":Y=new Item.implementation({name:Q.name.capitalize(),type:"feat",system:{abilityType:Q.specialAbilityType,description:{value:Q.desc},changes:Q.changes,subType:"misc"},img:Q.img});break;case"attack":Y=new Item.implementation({name:Q.name.capitalize(),type:"attack",system:{description:{value:Q.desc},subType:"misc"},img:Q.img});break;case"classFeat":case"class-abilities":if(Q.specialAbilityType!==null)Y=new Item.implementation({name:Q.name.capitalize(),type:"feat",system:{abilityType:Q.specialAbilityType,description:{value:Q.desc},subType:"classFeat"},img:Q.img});else Y=new Item.implementation({name:Q.name.capitalize(),type:"feat",system:{abilityType:"",description:{value:Q.desc},subType:"classFeat"},img:Q.img});break;case"domains":case"mysteries":case"oppositions":case"spirits":case"bloodlines":case"patrons":case"thassilonianSpecialist":case"inquisition":Y=new Item.implementation({name:Q.name.capitalize(),type:"feat",system:{description:{value:"sbc | As there is no dedicated field for "+Q.type+", this placeholder was created."},subType:"classFeat"},img:Q.img});break;case"loot":{Y=new Item.implementation({name:Q.quantity>1?this.singularize(Q.name):Q.name,type:Q.type,system:{quantity:Q.quantity,value:Q.value,price:Q.price,description:{value:"sbc | As "+Q.name+" could not be found in any compendium, a placeholder was generated."}},img:Q.img});break}default:Y=new Item.implementation({name:Q.name.capitalize(),type:Q.type,system:{description:{value:"sbc | As "+Q.name+" could not be found in any compendium, a placeholder was generated."}},img:Q.img});break}return Y}static cleanLine(J,Z){return Z.replace(J,"").trim()}static haystackSearch(J,Z){if(!Z)return null;J=J.sort((Q,Y)=>Y.length-Q.length),Z=Z.toLowerCase();for(let Q of J)if(Z.includes(Q.toLowerCase()))return Q;return null}static haystackRegexSearch(J,Z){if(!Z)return null;J=J.sort((Q,Y)=>Y.length-Q.length),Z=Z.toLowerCase();for(let Q of J)if(Z.match(new RegExp(Q,"i"))!==null)return console.log(Q),Q;return null}static haystackSearchAll(J,Z){if(!Z)return null;let Q=[];Z=Z.toLowerCase();for(let Y of J)if(Z.includes(Y.toLowerCase()))Q.push(Y);return Q}static parseSubtext(J){let Z=J.replace(/(^[,;.: ]*|[,;.: ]+$)/g,""),Q=Z.indexOf("("),Y=Z.indexOf(")");if(Y===-1)Z+=")",Y=Z.indexOf(")");if(Q>-1&&Y>Q){let X=Z.substring(0,Q).trim(),H=Z.substring(Q+1,Y).trim(),G=[];if(Y+1<Z.length){let _=Z.substring(Y+1).replace(/(^[,;.: ]*|[,;.: ]+$)/g,"").trim();G=this.parseSubtext(_)}if(!Array.isArray(G)||!G.length)return[X,H];else return[X,H,G]}else return[J]}static getKeyByValue(J,Z){return Object.keys(J).find((Q)=>J[Q].toLowerCase()===Z.toLowerCase())}static getModifier(J){return Math.floor((J-10)/2)}static getDiceAverage(J,Z=0.5){return(J+1)*Z}static async getTotalFromChanges(J,Z,Q=null){let Y=J.items.contents,X=0,H=J.getRollData();return await Promise.all(Y.map(async(G)=>{if(G.system.changes){let _=G.system.changes,z=G.getRollData(),K=_.find(function(q){if(q.target.toLowerCase()===Z.toLowerCase()&&(!Q||q.type===Q))return q});if(K){let q=null;if(/@class\.level/.test(K.formula))q=await Roll.fromTerms(Roll.parse(K.formula,z)).evaluate();else q=await Roll.fromTerms(Roll.parse(K.formula,H)).evaluate();X+=q?.total??+K.formula}}})),Promise.resolve(X)}static makeValueRollable(J){return J.replace(/(\d+d\d+)/g,"[[$1]]")}static camelize(J){if(!J)return J;return J.replace(/^([A-Z])|[\s-_]+(\w)/g,function(Z,Q,Y,X){if(Y)return Y.toUpperCase();return Q.toLowerCase()})}static translate(J,Z={}){return game.i18n.format(`SBCPF1.${J}`,Z)}static async runParallelOps(J,Z,Q=[]){if(Array.isArray(J)){let X=J.map(async(H,G)=>await Z(H,G,...Q));return await Promise.all(X)}let Y=Object.keys(J).map(async(X)=>await Z(J[X],X,...Q));return await Promise.all(Y)}static convertStringUnits(J){let Z=J.matchAll(/(\d+)-foot/g);for(let q of Z){let[j,F]=pf1.utils.convertDistance(+q[1]);J=J.replace(q[0],j+"-"+(F==="m"?"meter":"foot"))}let Q=J.matchAll(/(\d+)-mile/g);for(let q of Q){let[j,F]=pf1.utils.convertDistance(+q[1],"mi");J=J.replace(q[0],j+"-"+(F==="km"?"kilometer":"mile"))}let Y=J.matchAll(/(\d+) feet/g);for(let q of Y){let[j,F]=pf1.utils.convertDistance(+q[1]);J=J.replace(q[0],j+" "+(F==="m"?"meters":"feet"))}let X=J.matchAll(/(\d+) miles/g);for(let q of X){let[j,F]=pf1.utils.convertDistance(+q[1],"mi");J=J.replace(q[0],j+" "+(F==="km"?"kilometers":"miles"))}let H=J.matchAll(/(\d+) ft\./g);for(let q of H)J=J.replace(q[0],pf1.utils.convertDistance(+q[1]).join(" "));let G=J.matchAll(/(\d+) mi\b/g);for(let q of G)J=J.replace(q[0],pf1.utils.convertDistance(+q[1],"mi").join(" "));let _=pf1.utils.getWeightSystem(),z=J.matchAll(/(\d+) lbs?\./g);for(let q of z){let j=pf1.utils.convertWeight(+q[1]);J=J.replace(q[0],j+" "+(_==="metric"?"kg":j!==1?"lbs.":"lb."))}let K=J.matchAll(/(\d+) pounds?/g);for(let q of K){let j=pf1.utils.convertWeight(+q[1]);J=J.replace(q[0],pf1.utils.convertWeight(j)+" "+(_==="metric"?"kilogram":"pound")+(j!==1?"s":""))}return J}static singularize(J){return J.replace(/\(\d+\)/g,"").trim().replace(/ies$/,"y").replaceAll("doses of","dose of").replace(/s$/,"")}static capitalize(J){return(J||"").split(" ").map((Z)=>{if(["of","and","or","the","a","an"].includes(Z))return Z;if(Z.match(/^[^a-z]/i))return Z.charAt(0)+Z.charAt(1).toUpperCase()+Z.slice(2);return Z.charAt(0).toUpperCase()+Z.slice(1)}).join(" ")}static getMoneyFromString(J){let Z=t1().exec(J);if(!Z[0])return null;let Q=Z.groups;return{pp:+(Q.pp||0),gp:+(Q.gp||0),sp:+(Q.sp||0),cp:+(Q.cp||0)}}static convertMoneyToGold(J){return+(J.pp||0)*10+ +(J.gp||0)+ +(J.sp||0)/10+ +(J.cp||0)/100}static getMagicAbility(J,Z){let Q=Z?`${Z} ${J}`:J;Q=Q.toLowerCase().replace(/[- ]/g,"");for(let Y in window.SBC.config.magicalAbilities.Abilities)if(Y.toLowerCase()===Q)return{name:Y,...window.SBC.config.magicalAbilities.Abilities[Y]};return null}static async processFormula(J,Z,Q=null){let Y=Z.getRollData(),X=Q?.getRollData(),H=null;if(/@class\.level/.test(J)&&X)H=await Roll.fromTerms(Roll.parse(J,X)).evaluate(),W.log(`Processing ${J} and got results: `,[H,X,Roll.parse(J,X)]);else H=await Roll.fromTerms(Roll.parse(J,Y)).evaluate(),W.log(`Processing ${J} and got results: `,[H,Y,Roll.parse(J,Y)]);return{formula:H?.formula??+J,total:H?.total??+J}}static async addAssociatedClass(J,Z){if(J.system.subType==="classFeat"&&J.system.associations.classes?.length>0){let Q=J.system.associations.classes.map((X)=>X.toLowerCase());Z=Z.map((X)=>X.system.tag);let Y=Q.find((X)=>Z.includes(X));if(Y)await J.updateSource({"system.class":Y})}}static stringSimilarity(J,Z){return 1-this.levenshteinDistance(J,Z)/Math.max(J.length,Z.length)}static levenshteinDistance(J,Z){if(J===Z)return 0;if(J.length>Z.length)[J,Z]=[Z,J];let Q=(T,x,h,w,p)=>{return T<x||h<x?T>h?h+1:T+1:w===p?x:x+1},[Y,X]=[J.length,Z.length];while(Y>0&&J.charCodeAt(Y-1)===Z.charCodeAt(X-1))Y--,X--;let H=0;while(H<Y&&J.charCodeAt(H)===Z.charCodeAt(H))H++;if(Y-=H,X-=H,Y===0||X<3)return X;let G=0,_,z,K,q,j,F,L,B,O,E,N,P,M=[];for(_=0;_<Y;_++)M.push(_+1),M.push(J.charCodeAt(H+_));let R=M.length-1;for(;G<X-3;){O=Z.charCodeAt(H+(z=G)),E=Z.charCodeAt(H+(K=G+1)),N=Z.charCodeAt(H+(q=G+2)),P=Z.charCodeAt(H+(j=G+3)),F=G+=4;for(_=0;_<R;_+=2)L=M[_],B=M[_+1],z=Q(L,z,K,O,B),K=Q(z,K,q,E,B),q=Q(K,q,j,N,B),F=Q(q,j,F,P,B),M[_]=F,j=q,q=K,K=z,z=L}for(;G<X;){O=Z.charCodeAt(H+(z=G)),F=++G;for(_=0;_<R;_+=2)L=M[_],M[_]=F=Q(L,z,F,O,M[_+1]),z=L}return F}static checkForDuplicateItem(J,Z,Q,Y,X){let H=[];if(!Z||Z==="all")H=J.allItems;else H=J.itemTypes[Z];if(Q)H=H.filter((_)=>_.system.subType===Q);let G=new RegExp(`(^${Q0(Y.toLowerCase())})`,"i");return H.find((_)=>G.test(_.name.toLowerCase())||_.system.tag&&X.system.tag&&_.system.tag===X.system.tag||pf1.utils.createTag(_.name)===pf1.utils.createTag(X.name))}static prefixNumber(J){return("+"+J).replace(/\+([-+])/g,"$1")}static async openSBCDialog(J=null){let Z=window.SBC;if(!Z.configInitialized)return;if(await W.initializeSBC(),!Z.app)W.log(W.translate("log.inputDialogDoesNotYetExist")),Z.actor=await W.createActor(),Z.app=new y1({folderId:Z.folderId,wipFolderId:Z.wipFolderId,statblock:J}),A.initMapping(Z.app);W.log(W.translate("log.openingInputDialog")),Z.app.render(!0),Hooks.callAll("sbc.started")}static async initializeSBC(){let J=window.SBC;W.log("Initializing sbc v"+J.config.modData.version);let Z=window.SBC.settings.getSetting("importFolder"),Q="SBC_WIP",Y=await game.folders.find((H)=>H.name===Z&&H.type==="Actor"),X=await game.folders.find((H)=>H.name===Q&&H.type==="Actor");if(!Y){let H=await Folder.create({name:Z,type:"Actor",color:"#e76f51",parent:null}),G=W.translate("interfaceMessages.folderCreated");ui.notifications.info(G),W.log(G),Y=H}if(J.folderId=Y.id,!X){let H=await Folder.create({name:Q,type:"Actor",color:"#e76f51",parent:Y});J.wipFolderId=H.id}else J.wipFolderId=X.id,game.actors.filter((H)=>H.folder?.id===X.id).map(async(H)=>await H.delete());J.actorType=window.SBC.settings.getSetting("defaultActorType"),Hooks.callAll("sbc.reset")}static createSearchSet(J,Z=!1,Q=[]){let Y=new Set;for(let X of J){if(!X)continue;if(Y.add(X),Z){let H=Q.length?Q:window.SBC.actor.itemTypes.class.filter((_)=>_.system.subType!=="racial");if(!Q.length)H=H.map((_)=>_.system.tag.substring(0,3).toUpperCase()).concat(H.map((_)=>`${_.system.tag[0]}${_.system.tag[2]}${_.system.tag[3]}`.toUpperCase())).concat(window.SBC.app.processData.characterData.archetypes.map((_)=>W.capitalize(_)));let G=H.indexOf("FIG");if(G>-1)H.splice(G,1),H.push("FGT");for(let _ of H)Y.add(`${X} (${_})`)}}return Y}static sortArrayByName(J){J=foundry.utils.deepClone(J);for(let Z of J)Z.name=Z.name.toLocaleLowerCase();return pf1.utils.naturalSort(J,"name",{numeric:!0,ignorePunctuation:!0})}static extractCreatureTypeInfo(J){let Z=window.SBC,Q=Z.config.creatureTypes.find((X)=>J.match(new RegExp("\\b"+X+"\\b","i")))??"humanoid",Y=Z.config.creatureSubTypes.find((X)=>J.match(new RegExp("\\b"+X+"\\b","i")));return[Q,Y]}}var d1=["NONE","attributes.hp","spells.spellbooks.primary.spellPoints","spells.spellbooks.secondary.spellPoints","spells.spellbooks.tertiary.spellPoints","spells.spellbooks.spelllike.spellPoints","details.xp","attributes.ac.normal.total","attributes.ac.flatFooted.total","attributes.ac.touch.total","attributes.cmd.total","attributes.speed.land.total","attributes.speed.land.fly.total","attributes.speed.land.swim.total","attributes.speed.land.climb.total","attributes.speed.land.burrow.total","attributes.sr.total"];class V0{static async updateCustomCompendiums(J=!1){let Z=window.SBC;await Z.compendiumSearch.registerDefaultCompendia(),W.log("Updating custom compendiums");let Q=game.settings.get(Z.config.modData.mod,"customCompendiums").replace(/\s/g,"").split(/[,;]/g).filter((G)=>!!G);if(!Q.length)return;let Y=Array.from(game.packs.keys()),X=[],H=Q.filter((G)=>{if(Z.compendiumSearch.isKnownCompendium(G))return!1;if(!Y.includes(G))return X.push(G),!1;return!0});if(!J){if(X.length>0){let _="sbc-pf1 | Failed to add the following compendiums to sbc, please check for typos ("+X.toString()+")";ui.notifications.error(_),W.log(_)}if(!H.length)return;let G="sbc-pf1 | Added the following compendiums to sbc ("+H.toString()+")";ui.notifications.info(G),W.log(G)}await Z.compendiumSearch.processCompendiums(H)}static async updateImportFolder(){W.log("Updating custom import folder");let J=V0.getSetting("importFolder");if(J!==""){let Z=null;try{Z=await game.folders.find((Q)=>Q.data.name===J&&Q.data.type==="Actor")}catch(Q){let Y="sbc-pf1 | Something went wrong while searching for an existing import folder.";ui.notifications.info(Y),W.log(Y)}if(Z===null){let Q=await Folder.create({name:J,type:"Actor",color:"#e76f51",parent:null}),Y="Created a custom folder for imported statblocks.";return ui.notifications.info(Y),W.log(Y),Q.id}else return Z.id}}static getSetting(J){if(J.includes("attributeBar")){let Z=parseInt(J.replace("attributeBar",""));if(isNaN(Z))return{};let Q=game.settings.get(window.SBC.config.modData.mod,Z===1?"bar1":"bar2");if(Q==="0")return{};else return{attribute:d1[Q]}}return game.settings.get(window.SBC.config.modData.mod,J)}}var u5={debug:{default:!1,type:Boolean},defaultActorType:{default:0,type:String,choices:{0:"NPC",1:"PC"}},autoConvert:{default:!1,type:Boolean},inputDelay:{default:750,type:Number,range:{min:250,max:5000,step:10}},importFolder:{default:"sbc | Imported Statblocks",type:String,onChange:()=>V0.updateImportFolder()},customCompendiums:{default:"",type:String,onChange:async()=>await V0.updateCustomCompendiums()},createBuff:{default:!0,type:Boolean},createAttacks:{default:!1,type:Boolean},createAssociations:{default:!1,type:Boolean},rollBonusesIntegration:{default:!1,type:Boolean},pcsight:{default:!0,type:Boolean},npcsight:{default:!0,type:Boolean},pchealth:{default:"",type:String,choices:{"":"System default",discrete:"Discrete",continuous:"Continuous"}},npchealth:{default:"",type:String,choices:{"":"System default",discrete:"Discrete",continuous:"Continuous"}},disposition:{default:-1,type:String,choices:{"-1":"Hostile",0:"Neutral",1:"Friendly"}},displayName:{default:20,type:String,choices:{0:"None",10:"Control",20:"Owner Hover",30:"Hover",40:"Owner",50:"Always"}},displayBars:{default:20,type:String,choices:{0:"None",10:"Control",20:"Owner Hover",30:"Hover",40:"Owner",50:"Always"}},bar1:{default:"24",type:String,choices:d1},bar2:{default:"0",type:String,choices:d1}},NJ=function(){let J=window.SBC.config;Object.entries(u5).forEach(([Z,Q])=>{game.settings.register(J.modData.mod,Z,Object.assign({name:W.translate(`settings.${Z}.name`),hint:W.translate(`settings.${Z}.hint`),scope:"world",config:!0},Q))})};var K0={modData:{version:"5.5.0",mod:"pf1-statblock-converter",modName:"sbc | PF1 Statblock Converter"},const:{lineheight:20,crFractions:{"1/8":0.125,"1/6":0.1625,"1/4":0.25,"1/3":0.3375,"1/2":0.5},actorType:{0:"npc",1:"character"},suffixMultiples:["st","nd","rd","th"]},sources:B1,lineCategories:["Defense","Offense","Statistics","Special Abilities","Description","Tactics","Ecology","([a-z ]*)?Spells","([a-z ]*)?Extracts","([a-z ]*)?Spell-Like"],lineStarts:["Source","CR","XP","[LC][GNE]","N[GE]?","Init","Aura","Senses","Defense","AC","HP","Fort","Resist","Immun(?:e|ities)","DR","Offense","Speed","Spd","Melee","Ranged","Space","Special","^Spell-Like","^(.*) Spell-Like","^Spells","^(.*) Spells","^Extracts","^(.*) Extracts","Constant","At[- ]will","[456789]th","3rd","2nd","1st","Cantrips","Orisons","0","D\\s*domain spell","Domains?","Myster[y|ies]","S\\s*spirit magic spell","Spirits?","Bloodlines?","Thassilonian Specialization","Patrons?","Statistics","Str","Base","Feats","Skills","Languages?","Ecology","Environment","Organization","Treasure","S[QR]","(?:Other |Combat )?Gear","Gear","(?:M|Fem)ale","Tactics","(?:Before|During) Combat","Morale","(?:Opposition|Prohibited) School","Defensive Abilities","Immune","Weaknesses","Description","\\d+\\s*(?:rounds)?\\/(day|month|year)",".*\\((S[PU]|EX|\\-\\-)\\)","\\*"],armorBonusTypes:["touch","flat-footed","natural","size","dex","armor","shield","base","enhancement","dodge","inherent","deflection","morale","luck","sacred","insight","resistance","profane","trait","racial","competence","circumstance","alchemical","penalty","rage","monk","wis","untyped"],techColors:E1,techTiers:["Mark (?:I{1,3}|I?V)","Grade (?:I{1,3}|I?V)"],magicalAbilities:$1,itemModifications:R1,weaponGroups:{},metamagic:O0,creatureTypes:N1,creatureSubTypes:M1,immunities:v1,sillyGear:U1,races:[],classes:[],mythicPaths:[],racialClasses:[],prestigeClassNames:[],templates:[],naturalAttacks:[],initializeConfig:async function(){let J=window.SBC.compendiumSearch.defaultCompendia,Z=window.SBC.settings.getSetting("customCompendiums");if(Z!=="")Z=Z.replace(/\s/g,""),J=J.concat(Z.split(/[,;]/g));await p5(J),this.classes.sort(),this.mythicPaths.sort(),this.racialClasses.sort(),this.prestigeClassNames.sort();let Q=await game.packs.get("pf1.monster-abilities").index;for(let Y of Q)if(Y.name!=="")K0.naturalAttacks.push(Y.name);for(let[Y,X]of Object.entries(pf1.config.weaponGroups)){let H=X.toLowerCase().replace(/(.*), (.*)/,"$2 $1");if(!Object.values(K0.weaponGroups).includes(X))K0.weaponGroups[Y]=H}}};async function p5(J){let Z=new Set,Q=new Set,Y=new Set,X=new Set,H=new Set,G=new Set,_=J.map(async(z)=>{let K=await game.packs.get(z);if(!K)return;let q=K.index;await Promise.all(q.map(async(j)=>{if(j.name==="")return;switch(j.type){case"class":switch(j.system?.subType){case"prestige":Q.add(j.name);break;case"mythic":Y.add(j.name);break;case"racial":X.add(j.name);break;default:Z.add(j.name);break}break;case"race":H.add(j.name);break;case"feat":switch(j.system?.subType){case"template":G.add(j.name.split("(")[0].replace("Creature","").trim());break}}}))});await Promise.all(_),K0.classes=Array.from(Z).filter((z)=>!!z),K0.mythicPaths=Array.from(Y).filter((z)=>!!z),K0.racialClasses=Array.from(X).filter((z)=>!!z),K0.prestigeClasses=Array.from(Q).filter((z)=>!!z),K0.races=Array.from(H),K0.templates=Array.from(G)}window.SBC={app:null,actor:null,actorType:null,folderId:"",wipFolderId:"",config:K0,configInitialized:!1,compendiumSearch:new J1,isImporting:!1,settings:V0,rollBonusOps:u};Hooks.once("setup",async()=>{NJ()});Hooks.once("ready",async()=>{let J=window.SBC;await V0.updateCustomCompendiums(!0),await W.initializeSBC(),RJ(),Hooks.callAll("sbc.loadCustomCompendiums"),await J.config.initializeConfig(),console.log(W.translate("log.configInitialized")),J.configInitialized=!0,game.modules.get(J.config.modData.mod).api={openSBCDialog:W.openSBCDialog}});Hooks.on("renderActorDirectory",(J,Z,Q)=>{if(RJ(),!game.user.hasPermission("ACTOR_CREATE"))return;W.log(W.translate("log.renderingButton"));let Y=document.createElement("button");Y.id="startSBCButton",Y.classList.add("create-entity","sbcButton");let X=document.createElement("i");X.classList.add("fas","fa-file-import"),Y.appendChild(X);let H=document.createTextNode(W.translate("sbcButton"));Y.appendChild(H),Z[0].querySelector(".directory-footer").append(Y),Y.addEventListener("click",async()=>await W.openSBCDialog())});Hooks.on("sbc.reset",async function(){let J=[],Z=window.SBC.settings.getSetting("customCompendiums");if(Z!=="")Z=Z.replace(/\s/g,""),J.push(...Z.split(/[,;]/g)),console.log(J);await MJ(J)});Hooks.on("sbc.loadCustomCompendiums",async function(J){if(!J)return;let Z=window.SBC,Q=new Set,Y=window.SBC.settings.getSetting("customCompendiums");if(Y!=="")Y=Y.replace(/\s/g,""),Q=new Set(Y.split(/[,;]/g));J.forEach((X)=>{Q.add(X)}),await MJ(Array.from(Q)),Z.config.initializeConfig(),game.settings.set(Z.config.modData.mod,"customCompendiums",Array.from(Q).join(","))});Hooks.on("pf1RegisterMaterialTypes",(J)=>{let Z=J.get("alchemicalSilver");Z.addon=!1,Z.name="PF1.Materials.Types.Silver",J.register("pf1-statblock-converter","silver",Z)});async function MJ(J){await window.SBC.compendiumSearch.processCompendiums(J,{reset:!0})}function RJ(){let J=window.SBC;document.querySelector(`.folder[data-folder-id="${J.wipFolderId}"]`)?.remove()}

//# debugId=0F69A75B4B1C170264756E2164756E21
//# sourceMappingURL=sbc.js.map

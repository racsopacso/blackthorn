(()=>{var e={2705:e=>{var t;self,t=()=>{return e={7629:(e,t,i)=>{"use strict";const n=i(375),a=i(8571),s=i(9474),r=i(1687),o=i(8652),l=i(8160),c=i(3292),u=i(6354),m=i(8901),d=i(9708),h=i(6914),f=i(2294),p=i(6133),g=i(1152),y=i(8863),v=i(2036),b={Base:class{constructor(e){this.type=e,this.$_root=null,this._definition={},this._reset()}_reset(){this._ids=new f.Ids,this._preferences=null,this._refs=new p.Manager,this._cache=null,this._valids=null,this._invalids=null,this._flags={},this._rules=[],this._singleRules=new Map,this.$_terms={},this.$_temp={ruleset:null,whens:{}}}describe(){return n("function"==typeof d.describe,"Manifest functionality disabled"),d.describe(this)}allow(...e){return l.verifyFlat(e,"allow"),this._values(e,"_valids")}alter(e){n(e&&"object"==typeof e&&!Array.isArray(e),"Invalid targets argument"),n(!this._inRuleset(),"Cannot set alterations inside a ruleset");const t=this.clone();t.$_terms.alterations=t.$_terms.alterations||[];for(const i in e){const a=e[i];n("function"==typeof a,"Alteration adjuster for",i,"must be a function"),t.$_terms.alterations.push({target:i,adjuster:a})}return t.$_temp.ruleset=!1,t}artifact(e){return n(void 0!==e,"Artifact cannot be undefined"),n(!this._cache,"Cannot set an artifact with a rule cache"),this.$_setFlag("artifact",e)}cast(e){return n(!1===e||"string"==typeof e,"Invalid to value"),n(!1===e||this._definition.cast[e],"Type",this.type,"does not support casting to",e),this.$_setFlag("cast",!1===e?void 0:e)}default(e,t){return this._default("default",e,t)}description(e){return n(e&&"string"==typeof e,"Description must be a non-empty string"),this.$_setFlag("description",e)}empty(e){const t=this.clone();return void 0!==e&&(e=t.$_compile(e,{override:!1})),t.$_setFlag("empty",e,{clone:!1})}error(e){return n(e,"Missing error"),n(e instanceof Error||"function"==typeof e,"Must provide a valid Error object or a function"),this.$_setFlag("error",e)}example(e,t={}){return n(void 0!==e,"Missing example"),l.assertOptions(t,["override"]),this._inner("examples",e,{single:!0,override:t.override})}external(e,t){return"object"==typeof e&&(n(!t,"Cannot combine options with description"),t=e.description,e=e.method),n("function"==typeof e,"Method must be a function"),n(void 0===t||t&&"string"==typeof t,"Description must be a non-empty string"),this._inner("externals",{method:e,description:t},{single:!0})}failover(e,t){return this._default("failover",e,t)}forbidden(){return this.presence("forbidden")}id(e){return e?(n("string"==typeof e,"id must be a non-empty string"),n(/^[^\.]+$/.test(e),"id cannot contain period character"),this.$_setFlag("id",e)):this.$_setFlag("id",void 0)}invalid(...e){return this._values(e,"_invalids")}label(e){return n(e&&"string"==typeof e,"Label name must be a non-empty string"),this.$_setFlag("label",e)}meta(e){return n(void 0!==e,"Meta cannot be undefined"),this._inner("metas",e,{single:!0})}note(...e){n(e.length,"Missing notes");for(const t of e)n(t&&"string"==typeof t,"Notes must be non-empty strings");return this._inner("notes",e)}only(e=!0){return n("boolean"==typeof e,"Invalid mode:",e),this.$_setFlag("only",e)}optional(){return this.presence("optional")}prefs(e){n(e,"Missing preferences"),n(void 0===e.context,"Cannot override context"),n(void 0===e.externals,"Cannot override externals"),n(void 0===e.warnings,"Cannot override warnings"),n(void 0===e.debug,"Cannot override debug"),l.checkPreferences(e);const t=this.clone();return t._preferences=l.preferences(t._preferences,e),t}presence(e){return n(["optional","required","forbidden"].includes(e),"Unknown presence mode",e),this.$_setFlag("presence",e)}raw(e=!0){return this.$_setFlag("result",e?"raw":void 0)}result(e){return n(["raw","strip"].includes(e),"Unknown result mode",e),this.$_setFlag("result",e)}required(){return this.presence("required")}strict(e){const t=this.clone(),i=void 0!==e&&!e;return t._preferences=l.preferences(t._preferences,{convert:i}),t}strip(e=!0){return this.$_setFlag("result",e?"strip":void 0)}tag(...e){n(e.length,"Missing tags");for(const t of e)n(t&&"string"==typeof t,"Tags must be non-empty strings");return this._inner("tags",e)}unit(e){return n(e&&"string"==typeof e,"Unit name must be a non-empty string"),this.$_setFlag("unit",e)}valid(...e){l.verifyFlat(e,"valid");const t=this.allow(...e);return t.$_setFlag("only",!!t._valids,{clone:!1}),t}when(e,t){const i=this.clone();i.$_terms.whens||(i.$_terms.whens=[]);const a=c.when(i,e,t);if(!["any","link"].includes(i.type)){const e=a.is?[a]:a.switch;for(const t of e)n(!t.then||"any"===t.then.type||t.then.type===i.type,"Cannot combine",i.type,"with",t.then&&t.then.type),n(!t.otherwise||"any"===t.otherwise.type||t.otherwise.type===i.type,"Cannot combine",i.type,"with",t.otherwise&&t.otherwise.type)}return i.$_terms.whens.push(a),i.$_mutateRebuild()}cache(e){n(!this._inRuleset(),"Cannot set caching inside a ruleset"),n(!this._cache,"Cannot override schema cache"),n(void 0===this._flags.artifact,"Cannot cache a rule with an artifact");const t=this.clone();return t._cache=e||o.provider.provision(),t.$_temp.ruleset=!1,t}clone(){const e=Object.create(Object.getPrototypeOf(this));return this._assign(e)}concat(e){n(l.isSchema(e),"Invalid schema object"),n("any"===this.type||"any"===e.type||e.type===this.type,"Cannot merge type",this.type,"with another type:",e.type),n(!this._inRuleset(),"Cannot concatenate onto a schema with open ruleset"),n(!e._inRuleset(),"Cannot concatenate a schema with open ruleset");let t=this.clone();if("any"===this.type&&"any"!==e.type){const i=e.clone();for(const e of Object.keys(t))"type"!==e&&(i[e]=t[e]);t=i}t._ids.concat(e._ids),t._refs.register(e,p.toSibling),t._preferences=t._preferences?l.preferences(t._preferences,e._preferences):e._preferences,t._valids=v.merge(t._valids,e._valids,e._invalids),t._invalids=v.merge(t._invalids,e._invalids,e._valids);for(const i of e._singleRules.keys())t._singleRules.has(i)&&(t._rules=t._rules.filter((e=>e.keep||e.name!==i)),t._singleRules.delete(i));for(const i of e._rules)e._definition.rules[i.method].multi||t._singleRules.set(i.name,i),t._rules.push(i);if(t._flags.empty&&e._flags.empty){t._flags.empty=t._flags.empty.concat(e._flags.empty);const i=Object.assign({},e._flags);delete i.empty,r(t._flags,i)}else if(e._flags.empty){t._flags.empty=e._flags.empty;const i=Object.assign({},e._flags);delete i.empty,r(t._flags,i)}else r(t._flags,e._flags);for(const i in e.$_terms){const n=e.$_terms[i];n?t.$_terms[i]?t.$_terms[i]=t.$_terms[i].concat(n):t.$_terms[i]=n.slice():t.$_terms[i]||(t.$_terms[i]=n)}return this.$_root._tracer&&this.$_root._tracer._combine(t,[this,e]),t.$_mutateRebuild()}extend(e){return n(!e.base,"Cannot extend type with another base"),m.type(this,e)}extract(e){return e=Array.isArray(e)?e:e.split("."),this._ids.reach(e)}fork(e,t){n(!this._inRuleset(),"Cannot fork inside a ruleset");let i=this;for(let n of[].concat(e))n=Array.isArray(n)?n:n.split("."),i=i._ids.fork(n,t,i);return i.$_temp.ruleset=!1,i}rule(e){const t=this._definition;l.assertOptions(e,Object.keys(t.modifiers)),n(!1!==this.$_temp.ruleset,"Cannot apply rules to empty ruleset or the last rule added does not support rule properties");const i=null===this.$_temp.ruleset?this._rules.length-1:this.$_temp.ruleset;n(i>=0&&i<this._rules.length,"Cannot apply rules to empty ruleset");const s=this.clone();for(let r=i;r<s._rules.length;++r){const i=s._rules[r],o=a(i);for(const a in e)t.modifiers[a](o,e[a]),n(o.name===i.name,"Cannot change rule name");s._rules[r]=o,s._singleRules.get(o.name)===i&&s._singleRules.set(o.name,o)}return s.$_temp.ruleset=!1,s.$_mutateRebuild()}get ruleset(){n(!this._inRuleset(),"Cannot start a new ruleset without closing the previous one");const e=this.clone();return e.$_temp.ruleset=e._rules.length,e}get $(){return this.ruleset}tailor(e){e=[].concat(e),n(!this._inRuleset(),"Cannot tailor inside a ruleset");let t=this;if(this.$_terms.alterations)for(const{target:i,adjuster:a}of this.$_terms.alterations)e.includes(i)&&(t=a(t),n(l.isSchema(t),"Alteration adjuster for",i,"failed to return a schema object"));return t=t.$_modify({each:t=>t.tailor(e),ref:!1}),t.$_temp.ruleset=!1,t.$_mutateRebuild()}tracer(){return g.location?g.location(this):this}validate(e,t){return y.entry(e,this,t)}validateAsync(e,t){return y.entryAsync(e,this,t)}$_addRule(e){"string"==typeof e&&(e={name:e}),n(e&&"object"==typeof e,"Invalid options"),n(e.name&&"string"==typeof e.name,"Invalid rule name");for(const t in e)n("_"!==t[0],"Cannot set private rule properties");const t=Object.assign({},e);t._resolve=[],t.method=t.method||t.name;const i=this._definition.rules[t.method],a=t.args;n(i,"Unknown rule",t.method);const s=this.clone();if(a){n(1===Object.keys(a).length||Object.keys(a).length===this._definition.rules[t.name].args.length,"Invalid rule definition for",this.type,t.name);for(const e in a){let r=a[e];if(i.argsByName){const o=i.argsByName.get(e);if(o.ref&&l.isResolvable(r))t._resolve.push(e),s.$_mutateRegister(r);else if(o.normalize&&(r=o.normalize(r),a[e]=r),o.assert){const t=l.validateArg(r,e,o);n(!t,t,"or reference")}}void 0!==r?a[e]=r:delete a[e]}}return i.multi||(s._ruleRemove(t.name,{clone:!1}),s._singleRules.set(t.name,t)),!1===s.$_temp.ruleset&&(s.$_temp.ruleset=null),i.priority?s._rules.unshift(t):s._rules.push(t),s}$_compile(e,t){return c.schema(this.$_root,e,t)}$_createError(e,t,i,n,a,s={}){const r=!1!==s.flags?this._flags:{},o=s.messages?h.merge(this._definition.messages,s.messages):this._definition.messages;return new u.Report(e,t,i,r,o,n,a)}$_getFlag(e){return this._flags[e]}$_getRule(e){return this._singleRules.get(e)}$_mapLabels(e){return e=Array.isArray(e)?e:e.split("."),this._ids.labels(e)}$_match(e,t,i,n){(i=Object.assign({},i)).abortEarly=!0,i._externals=!1,t.snapshot();const a=!y.validate(e,this,t,i,n).errors;return t.restore(),a}$_modify(e){return l.assertOptions(e,["each","once","ref","schema"]),f.schema(this,e)||this}$_mutateRebuild(){return n(!this._inRuleset(),"Cannot add this rule inside a ruleset"),this._refs.reset(),this._ids.reset(),this.$_modify({each:(e,{source:t,name:i,path:n,key:a})=>{const s=this._definition[t][i]&&this._definition[t][i].register;!1!==s&&this.$_mutateRegister(e,{family:s,key:a})}}),this._definition.rebuild&&this._definition.rebuild(this),this.$_temp.ruleset=!1,this}$_mutateRegister(e,{family:t,key:i}={}){this._refs.register(e,t),this._ids.register(e,{key:i})}$_property(e){return this._definition.properties[e]}$_reach(e){return this._ids.reach(e)}$_rootReferences(){return this._refs.roots()}$_setFlag(e,t,i={}){n("_"===e[0]||!this._inRuleset(),"Cannot set flag inside a ruleset");const a=this._definition.flags[e]||{};if(s(t,a.default)&&(t=void 0),s(t,this._flags[e]))return this;const r=!1!==i.clone?this.clone():this;return void 0!==t?(r._flags[e]=t,r.$_mutateRegister(t)):delete r._flags[e],"_"!==e[0]&&(r.$_temp.ruleset=!1),r}$_parent(e,...t){return this[e][l.symbols.parent].call(this,...t)}$_validate(e,t,i){return y.validate(e,this,t,i)}_assign(e){e.type=this.type,e.$_root=this.$_root,e.$_temp=Object.assign({},this.$_temp),e.$_temp.whens={},e._ids=this._ids.clone(),e._preferences=this._preferences,e._valids=this._valids&&this._valids.clone(),e._invalids=this._invalids&&this._invalids.clone(),e._rules=this._rules.slice(),e._singleRules=a(this._singleRules,{shallow:!0}),e._refs=this._refs.clone(),e._flags=Object.assign({},this._flags),e._cache=null,e.$_terms={};for(const t in this.$_terms)e.$_terms[t]=this.$_terms[t]?this.$_terms[t].slice():null;e.$_super={};for(const t in this.$_super)e.$_super[t]=this._super[t].bind(e);return e}_bare(){const e=this.clone();e._reset();const t=e._definition.terms;for(const i in t){const n=t[i];e.$_terms[i]=n.init}return e.$_mutateRebuild()}_default(e,t,i={}){return l.assertOptions(i,"literal"),n(void 0!==t,"Missing",e,"value"),n("function"==typeof t||!i.literal,"Only function value supports literal option"),"function"==typeof t&&i.literal&&(t={[l.symbols.literal]:!0,literal:t}),this.$_setFlag(e,t)}_generate(e,t,i){if(!this.$_terms.whens)return{schema:this};const n=[],a=[];for(let s=0;s<this.$_terms.whens.length;++s){const r=this.$_terms.whens[s];if(r.concat){n.push(r.concat),a.push(`${s}.concat`);continue}const o=r.ref?r.ref.resolve(e,t,i):e,l=r.is?[r]:r.switch,c=a.length;for(let c=0;c<l.length;++c){const{is:u,then:m,otherwise:d}=l[c],h=`${s}${r.switch?"."+c:""}`;if(u.$_match(o,t.nest(u,`${h}.is`),i)){if(m){const s=t.localize([...t.path,`${h}.then`],t.ancestors,t.schemas),{schema:r,id:o}=m._generate(e,s,i);n.push(r),a.push(`${h}.then${o?`(${o})`:""}`);break}}else if(d){const s=t.localize([...t.path,`${h}.otherwise`],t.ancestors,t.schemas),{schema:r,id:o}=d._generate(e,s,i);n.push(r),a.push(`${h}.otherwise${o?`(${o})`:""}`);break}}if(r.break&&a.length>c)break}const s=a.join(", ");if(t.mainstay.tracer.debug(t,"rule","when",s),!s)return{schema:this};if(!t.mainstay.tracer.active&&this.$_temp.whens[s])return{schema:this.$_temp.whens[s],id:s};let r=this;this._definition.generate&&(r=this._definition.generate(this,e,t,i));for(const e of n)r=r.concat(e);return this.$_root._tracer&&this.$_root._tracer._combine(r,[this,...n]),this.$_temp.whens[s]=r,{schema:r,id:s}}_inner(e,t,i={}){n(!this._inRuleset(),`Cannot set ${e} inside a ruleset`);const a=this.clone();return a.$_terms[e]&&!i.override||(a.$_terms[e]=[]),i.single?a.$_terms[e].push(t):a.$_terms[e].push(...t),a.$_temp.ruleset=!1,a}_inRuleset(){return null!==this.$_temp.ruleset&&!1!==this.$_temp.ruleset}_ruleRemove(e,t={}){if(!this._singleRules.has(e))return this;const i=!1!==t.clone?this.clone():this;i._singleRules.delete(e);const n=[];for(let t=0;t<i._rules.length;++t){const a=i._rules[t];a.name!==e||a.keep?n.push(a):i._inRuleset()&&t<i.$_temp.ruleset&&--i.$_temp.ruleset}return i._rules=n,i}_values(e,t){l.verifyFlat(e,t.slice(1,-1));const i=this.clone(),a=e[0]===l.symbols.override;if(a&&(e=e.slice(1)),!i[t]&&e.length?i[t]=new v:a&&(i[t]=e.length?new v:null,i.$_mutateRebuild()),!i[t])return i;a&&i[t].override();for(const a of e){n(void 0!==a,"Cannot call allow/valid/invalid with undefined"),n(a!==l.symbols.override,"Override must be the first value");const e="_invalids"===t?"_valids":"_invalids";i[e]&&(i[e].remove(a),i[e].length||(n("_valids"===t||!i._flags.only,"Setting invalid value",a,"leaves schema rejecting all values due to previous valid rule"),i[e]=null)),i[t].add(a,i._refs)}return i}}};b.Base.prototype[l.symbols.any]={version:l.version,compile:c.compile,root:"$_root"},b.Base.prototype.isImmutable=!0,b.Base.prototype.deny=b.Base.prototype.invalid,b.Base.prototype.disallow=b.Base.prototype.invalid,b.Base.prototype.equal=b.Base.prototype.valid,b.Base.prototype.exist=b.Base.prototype.required,b.Base.prototype.not=b.Base.prototype.invalid,b.Base.prototype.options=b.Base.prototype.prefs,b.Base.prototype.preferences=b.Base.prototype.prefs,e.exports=new b.Base},8652:(e,t,i)=>{"use strict";const n=i(375),a=i(8571),s=i(8160),r={max:1e3,supported:new Set(["undefined","boolean","number","string"])};t.provider={provision:e=>new r.Cache(e)},r.Cache=class{constructor(e={}){s.assertOptions(e,["max"]),n(void 0===e.max||e.max&&e.max>0&&isFinite(e.max),"Invalid max cache size"),this._max=e.max||r.max,this._map=new Map,this._list=new r.List}get length(){return this._map.size}set(e,t){if(null!==e&&!r.supported.has(typeof e))return;let i=this._map.get(e);if(i)return i.value=t,void this._list.first(i);i=this._list.unshift({key:e,value:t}),this._map.set(e,i),this._compact()}get(e){const t=this._map.get(e);if(t)return this._list.first(t),a(t.value)}_compact(){if(this._map.size>this._max){const e=this._list.pop();this._map.delete(e.key)}}},r.List=class{constructor(){this.tail=null,this.head=null}unshift(e){return e.next=null,e.prev=this.head,this.head&&(this.head.next=e),this.head=e,this.tail||(this.tail=e),e}first(e){e!==this.head&&(this._remove(e),this.unshift(e))}pop(){return this._remove(this.tail)}_remove(e){const{next:t,prev:i}=e;return t.prev=i,i&&(i.next=t),e===this.tail&&(this.tail=t),e.prev=null,e.next=null,e}}},8160:(e,t,i)=>{"use strict";const n=i(375),a=i(7916),s=i(5934);let r,o;const l={isoDate:/^(?:[-+]\d{2})?(?:\d{4}(?!\d{2}\b))(?:(-?)(?:(?:0[1-9]|1[0-2])(?:\1(?:[12]\d|0[1-9]|3[01]))?|W(?:[0-4]\d|5[0-2])(?:-?[1-7])?|(?:00[1-9]|0[1-9]\d|[12]\d{2}|3(?:[0-5]\d|6[1-6])))(?![T]$|[T][\d]+Z$)(?:[T\s](?:(?:(?:[01]\d|2[0-3])(?:(:?)[0-5]\d)?|24\:?00)(?:[.,]\d+(?!:))?)(?:\2[0-5]\d(?:[.,]\d+)?)?(?:[Z]|(?:[+-])(?:[01]\d|2[0-3])(?::?[0-5]\d)?)?)?)?$/};t.version=s.version,t.defaults={abortEarly:!0,allowUnknown:!1,artifacts:!1,cache:!0,context:null,convert:!0,dateFormat:"iso",errors:{escapeHtml:!1,label:"path",language:null,render:!0,stack:!1,wrap:{label:'"',array:"[]"}},externals:!0,messages:{},nonEnumerables:!1,noDefaults:!1,presence:"optional",skipFunctions:!1,stripUnknown:!1,warnings:!1},t.symbols={any:Symbol.for("@hapi/joi/schema"),arraySingle:Symbol("arraySingle"),deepDefault:Symbol("deepDefault"),errors:Symbol("errors"),literal:Symbol("literal"),override:Symbol("override"),parent:Symbol("parent"),prefs:Symbol("prefs"),ref:Symbol("ref"),template:Symbol("template"),values:Symbol("values")},t.assertOptions=function(e,t,i="Options"){n(e&&"object"==typeof e&&!Array.isArray(e),"Options must be of type object");const a=Object.keys(e).filter((e=>!t.includes(e)));n(0===a.length,`${i} contain unknown keys: ${a}`)},t.checkPreferences=function(e){o=o||i(3378);const t=o.preferences.validate(e);if(t.error)throw new a([t.error.details[0].message])},t.compare=function(e,t,i){switch(i){case"=":return e===t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t}},t.default=function(e,t){return void 0===e?t:e},t.isIsoDate=function(e){return l.isoDate.test(e)},t.isNumber=function(e){return"number"==typeof e&&!isNaN(e)},t.isResolvable=function(e){return!!e&&(e[t.symbols.ref]||e[t.symbols.template])},t.isSchema=function(e,i={}){const a=e&&e[t.symbols.any];return!!a&&(n(i.legacy||a.version===t.version,"Cannot mix different versions of joi schemas"),!0)},t.isValues=function(e){return e[t.symbols.values]},t.limit=function(e){return Number.isSafeInteger(e)&&e>=0},t.preferences=function(e,n){r=r||i(6914),e=e||{},n=n||{};const a=Object.assign({},e,n);return n.errors&&e.errors&&(a.errors=Object.assign({},e.errors,n.errors),a.errors.wrap=Object.assign({},e.errors.wrap,n.errors.wrap)),n.messages&&(a.messages=r.compile(n.messages,e.messages)),delete a[t.symbols.prefs],a},t.tryWithPath=function(e,t,i={}){try{return e()}catch(e){throw void 0!==e.path?e.path=t+"."+e.path:e.path=t,i.append&&(e.message=`${e.message} (${e.path})`),e}},t.validateArg=function(e,i,{assert:n,message:a}){if(t.isSchema(n)){const t=n.validate(e);if(!t.error)return;return t.error.message}if(!n(e))return i?`${i} ${a}`:a},t.verifyFlat=function(e,t){for(const i of e)n(!Array.isArray(i),"Method no longer accepts array arguments:",t)}},3292:(e,t,i)=>{"use strict";const n=i(375),a=i(8160),s=i(6133),r={};t.schema=function(e,t,i={}){a.assertOptions(i,["appendPath","override"]);try{return r.schema(e,t,i)}catch(e){throw i.appendPath&&void 0!==e.path&&(e.message=`${e.message} (${e.path})`),e}},r.schema=function(e,t,i){n(void 0!==t,"Invalid undefined schema"),Array.isArray(t)&&(n(t.length,"Invalid empty array schema"),1===t.length&&(t=t[0]));const s=(t,...n)=>!1!==i.override?t.valid(e.override,...n):t.valid(...n);if(r.simple(t))return s(e,t);if("function"==typeof t)return e.custom(t);if(n("object"==typeof t,"Invalid schema content:",typeof t),a.isResolvable(t))return s(e,t);if(a.isSchema(t))return t;if(Array.isArray(t)){for(const i of t)if(!r.simple(i))return e.alternatives().try(...t);return s(e,...t)}return t instanceof RegExp?e.string().regex(t):t instanceof Date?s(e.date(),t):(n(Object.getPrototypeOf(t)===Object.getPrototypeOf({}),"Schema can only contain plain objects"),e.object().keys(t))},t.ref=function(e,t){return s.isRef(e)?e:s.create(e,t)},t.compile=function(e,i,s={}){a.assertOptions(s,["legacy"]);const o=i&&i[a.symbols.any];if(o)return n(s.legacy||o.version===a.version,"Cannot mix different versions of joi schemas:",o.version,a.version),i;if("object"!=typeof i||!s.legacy)return t.schema(e,i,{appendPath:!0});const l=r.walk(i);return l?l.compile(l.root,i):t.schema(e,i,{appendPath:!0})},r.walk=function(e){if("object"!=typeof e)return null;if(Array.isArray(e)){for(const t of e){const e=r.walk(t);if(e)return e}return null}const t=e[a.symbols.any];if(t)return{root:e[t.root],compile:t.compile};n(Object.getPrototypeOf(e)===Object.getPrototypeOf({}),"Schema can only contain plain objects");for(const t in e){const i=r.walk(e[t]);if(i)return i}return null},r.simple=function(e){return null===e||["boolean","string","number"].includes(typeof e)},t.when=function(e,i,o){if(void 0===o&&(n(i&&"object"==typeof i,"Missing options"),o=i,i=s.create(".")),Array.isArray(o)&&(o={switch:o}),a.assertOptions(o,["is","not","then","otherwise","switch","break"]),a.isSchema(i))return n(void 0===o.is,'"is" can not be used with a schema condition'),n(void 0===o.not,'"not" can not be used with a schema condition'),n(void 0===o.switch,'"switch" can not be used with a schema condition'),r.condition(e,{is:i,then:o.then,otherwise:o.otherwise,break:o.break});if(n(s.isRef(i)||"string"==typeof i,"Invalid condition:",i),n(void 0===o.not||void 0===o.is,'Cannot combine "is" with "not"'),void 0===o.switch){let l=o;void 0!==o.not&&(l={is:o.not,then:o.otherwise,otherwise:o.then,break:o.break});let c=void 0!==l.is?e.$_compile(l.is):e.$_root.invalid(null,!1,0,"").required();return n(void 0!==l.then||void 0!==l.otherwise,'options must have at least one of "then", "otherwise", or "switch"'),n(void 0===l.break||void 0===l.then||void 0===l.otherwise,"Cannot specify then, otherwise, and break all together"),void 0===o.is||s.isRef(o.is)||a.isSchema(o.is)||(c=c.required()),r.condition(e,{ref:t.ref(i),is:c,then:l.then,otherwise:l.otherwise,break:l.break})}n(Array.isArray(o.switch),'"switch" must be an array'),n(void 0===o.is,'Cannot combine "switch" with "is"'),n(void 0===o.not,'Cannot combine "switch" with "not"'),n(void 0===o.then,'Cannot combine "switch" with "then"');const l={ref:t.ref(i),switch:[],break:o.break};for(let t=0;t<o.switch.length;++t){const i=o.switch[t],r=t===o.switch.length-1;a.assertOptions(i,r?["is","then","otherwise"]:["is","then"]),n(void 0!==i.is,'Switch statement missing "is"'),n(void 0!==i.then,'Switch statement missing "then"');const c={is:e.$_compile(i.is),then:e.$_compile(i.then)};if(s.isRef(i.is)||a.isSchema(i.is)||(c.is=c.is.required()),r){n(void 0===o.otherwise||void 0===i.otherwise,'Cannot specify "otherwise" inside and outside a "switch"');const t=void 0!==o.otherwise?o.otherwise:i.otherwise;void 0!==t&&(n(void 0===l.break,"Cannot specify both otherwise and break"),c.otherwise=e.$_compile(t))}l.switch.push(c)}return l},r.condition=function(e,t){for(const i of["then","otherwise"])void 0===t[i]?delete t[i]:t[i]=e.$_compile(t[i]);return t}},6354:(e,t,i)=>{"use strict";const n=i(5688),a=i(8160),s=i(3328);t.Report=class{constructor(e,i,n,a,s,r,o){if(this.code=e,this.flags=a,this.messages=s,this.path=r.path,this.prefs=o,this.state=r,this.value=i,this.message=null,this.template=null,this.local=n||{},this.local.label=t.label(this.flags,this.state,this.prefs,this.messages),void 0===this.value||this.local.hasOwnProperty("value")||(this.local.value=this.value),this.path.length){const e=this.path[this.path.length-1];"object"!=typeof e&&(this.local.key=e)}}_setTemplate(e){if(this.template=e,!this.flags.label&&0===this.path.length){const e=this._template(this.template,"root");e&&(this.local.label=e)}}toString(){if(this.message)return this.message;const e=this.code;if(!this.prefs.errors.render)return this.code;const t=this._template(this.template)||this._template(this.prefs.messages)||this._template(this.messages);return void 0===t?`Error code "${e}" is not defined, your custom type is missing the correct messages definition`:(this.message=t.render(this.value,this.state,this.prefs,this.local,{errors:this.prefs.errors,messages:[this.prefs.messages,this.messages]}),this.prefs.errors.label||(this.message=this.message.replace(/^"" /,"").trim()),this.message)}_template(e,i){return t.template(this.value,e,i||this.code,this.state,this.prefs)}},t.path=function(e){let t="";for(const i of e)"object"!=typeof i&&("string"==typeof i?(t&&(t+="."),t+=i):t+=`[${i}]`);return t},t.template=function(e,t,i,n,r){if(!t)return;if(s.isTemplate(t))return"root"!==i?t:null;let o=r.errors.language;if(a.isResolvable(o)&&(o=o.resolve(e,n,r)),o&&t[o]){if(void 0!==t[o][i])return t[o][i];if(void 0!==t[o]["*"])return t[o]["*"]}return t[i]?t[i]:t["*"]},t.label=function(e,i,n,a){if(e.label)return e.label;if(!n.errors.label)return"";let s=i.path;return"key"===n.errors.label&&i.path.length>1&&(s=i.path.slice(-1)),t.path(s)||t.template(null,n.messages,"root",i,n)||a&&t.template(null,a,"root",i,n)||"value"},t.process=function(e,i,n){if(!e)return null;const{override:a,message:s,details:r}=t.details(e);if(a)return a;if(n.errors.stack)return new t.ValidationError(s,r,i);const o=Error.stackTraceLimit;Error.stackTraceLimit=0;const l=new t.ValidationError(s,r,i);return Error.stackTraceLimit=o,l},t.details=function(e,t={}){let i=[];const n=[];for(const a of e){if(a instanceof Error){if(!1!==t.override)return{override:a};const e=a.toString();i.push(e),n.push({message:e,type:"override",context:{error:a}});continue}const e=a.toString();i.push(e),n.push({message:e,path:a.path.filter((e=>"object"!=typeof e)),type:a.code,context:a.local})}return i.length>1&&(i=[...new Set(i)]),{message:i.join(". "),details:n}},t.ValidationError=class extends Error{constructor(e,t,i){super(e),this._original=i,this.details=t}static isError(e){return e instanceof t.ValidationError}},t.ValidationError.prototype.isJoi=!0,t.ValidationError.prototype.name="ValidationError",t.ValidationError.prototype.annotate=n.error},8901:(e,t,i)=>{"use strict";const n=i(375),a=i(8571),s=i(8160),r=i(6914),o={};t.type=function(e,t){const i=Object.getPrototypeOf(e),l=a(i),c=e._assign(Object.create(l)),u=Object.assign({},t);delete u.base,l._definition=u;const m=i._definition||{};u.messages=r.merge(m.messages,u.messages),u.properties=Object.assign({},m.properties,u.properties),c.type=u.type,u.flags=Object.assign({},m.flags,u.flags);const d=Object.assign({},m.terms);if(u.terms)for(const e in u.terms){const t=u.terms[e];n(void 0===c.$_terms[e],"Invalid term override for",u.type,e),c.$_terms[e]=t.init,d[e]=t}u.terms=d,u.args||(u.args=m.args),u.prepare=o.prepare(u.prepare,m.prepare),u.coerce&&("function"==typeof u.coerce&&(u.coerce={method:u.coerce}),u.coerce.from&&!Array.isArray(u.coerce.from)&&(u.coerce={method:u.coerce.method,from:[].concat(u.coerce.from)})),u.coerce=o.coerce(u.coerce,m.coerce),u.validate=o.validate(u.validate,m.validate);const h=Object.assign({},m.rules);if(u.rules)for(const e in u.rules){const t=u.rules[e];n("object"==typeof t,"Invalid rule definition for",u.type,e);let i=t.method;if(void 0===i&&(i=function(){return this.$_addRule(e)}),i&&(n(!l[e],"Rule conflict in",u.type,e),l[e]=i),n(!h[e],"Rule conflict in",u.type,e),h[e]=t,t.alias){const e=[].concat(t.alias);for(const i of e)l[i]=t.method}t.args&&(t.argsByName=new Map,t.args=t.args.map((e=>("string"==typeof e&&(e={name:e}),n(!t.argsByName.has(e.name),"Duplicated argument name",e.name),s.isSchema(e.assert)&&(e.assert=e.assert.strict().label(e.name)),t.argsByName.set(e.name,e),e))))}u.rules=h;const f=Object.assign({},m.modifiers);if(u.modifiers)for(const e in u.modifiers){n(!l[e],"Rule conflict in",u.type,e);const t=u.modifiers[e];n("function"==typeof t,"Invalid modifier definition for",u.type,e);const i=function(t){return this.rule({[e]:t})};l[e]=i,f[e]=t}if(u.modifiers=f,u.overrides){l._super=i,c.$_super={};for(const e in u.overrides)n(i[e],"Cannot override missing",e),u.overrides[e][s.symbols.parent]=i[e],c.$_super[e]=i[e].bind(c);Object.assign(l,u.overrides)}u.cast=Object.assign({},m.cast,u.cast);const p=Object.assign({},m.manifest,u.manifest);return p.build=o.build(u.manifest&&u.manifest.build,m.manifest&&m.manifest.build),u.manifest=p,u.rebuild=o.rebuild(u.rebuild,m.rebuild),c},o.build=function(e,t){return e&&t?function(i,n){return t(e(i,n),n)}:e||t},o.coerce=function(e,t){return e&&t?{from:e.from&&t.from?[...new Set([...e.from,...t.from])]:null,method(i,n){let a;if((!t.from||t.from.includes(typeof i))&&(a=t.method(i,n),a)){if(a.errors||void 0===a.value)return a;i=a.value}if(!e.from||e.from.includes(typeof i)){const t=e.method(i,n);if(t)return t}return a}}:e||t},o.prepare=function(e,t){return e&&t?function(i,n){const a=e(i,n);if(a){if(a.errors||void 0===a.value)return a;i=a.value}return t(i,n)||a}:e||t},o.rebuild=function(e,t){return e&&t?function(i){t(i),e(i)}:e||t},o.validate=function(e,t){return e&&t?function(i,n){const a=t(i,n);if(a){if(a.errors&&(!Array.isArray(a.errors)||a.errors.length))return a;i=a.value}return e(i,n)||a}:e||t}},5107:(e,t,i)=>{"use strict";const n=i(375),a=i(8571),s=i(8652),r=i(8160),o=i(3292),l=i(6354),c=i(8901),u=i(9708),m=i(6133),d=i(3328),h=i(1152);let f;const p={types:{alternatives:i(4946),any:i(8068),array:i(546),boolean:i(4937),date:i(7500),function:i(390),link:i(8785),number:i(3832),object:i(8966),string:i(7417),symbol:i(8826)},aliases:{alt:"alternatives",bool:"boolean",func:"function"},root:function(){const e={_types:new Set(Object.keys(p.types))};for(const t of e._types)e[t]=function(...e){return n(!e.length||["alternatives","link","object"].includes(t),"The",t,"type does not allow arguments"),p.generate(this,p.types[t],e)};for(const t of["allow","custom","disallow","equal","exist","forbidden","invalid","not","only","optional","options","prefs","preferences","required","strip","valid","when"])e[t]=function(...e){return this.any()[t](...e)};Object.assign(e,p.methods);for(const t in p.aliases){const i=p.aliases[t];e[t]=e[i]}return e.x=e.expression,h.setup&&h.setup(e),e}};p.methods={ValidationError:l.ValidationError,version:r.version,cache:s.provider,assert(e,t,...i){p.assert(e,t,!0,i)},attempt:(e,t,...i)=>p.assert(e,t,!1,i),build(e){return n("function"==typeof u.build,"Manifest functionality disabled"),u.build(this,e)},checkPreferences(e){r.checkPreferences(e)},compile(e,t){return o.compile(this,e,t)},defaults(e){n("function"==typeof e,"modifier must be a function");const t=Object.assign({},this);for(const i of t._types){const a=e(t[i]());n(r.isSchema(a),"modifier must return a valid schema object"),t[i]=function(...e){return p.generate(this,a,e)}}return t},expression:(...e)=>new d(...e),extend(...e){r.verifyFlat(e,"extend"),f=f||i(3378),n(e.length,"You need to provide at least one extension"),this.assert(e,f.extensions);const t=Object.assign({},this);t._types=new Set(t._types);for(let i of e){"function"==typeof i&&(i=i(t)),this.assert(i,f.extension);const e=p.expandExtension(i,t);for(const i of e){n(void 0===t[i.type]||t._types.has(i.type),"Cannot override name",i.type);const e=i.base||this.any(),a=c.type(e,i);t._types.add(i.type),t[i.type]=function(...e){return p.generate(this,a,e)}}}return t},isError:l.ValidationError.isError,isExpression:d.isTemplate,isRef:m.isRef,isSchema:r.isSchema,in:(...e)=>m.in(...e),override:r.symbols.override,ref:(...e)=>m.create(...e),types(){const e={};for(const t of this._types)e[t]=this[t]();for(const t in p.aliases)e[t]=this[t]();return e}},p.assert=function(e,t,i,n){const s=n[0]instanceof Error||"string"==typeof n[0]?n[0]:null,o=null!==s?n[1]:n[0],c=t.validate(e,r.preferences({errors:{stack:!0}},o||{}));let u=c.error;if(!u)return c.value;if(s instanceof Error)throw s;const m=i&&"function"==typeof u.annotate?u.annotate():u.message;throw u instanceof l.ValidationError==0&&(u=a(u)),u.message=s?`${s} ${m}`:m,u},p.generate=function(e,t,i){return n(e,"Must be invoked on a Joi instance."),t.$_root=e,t._definition.args&&i.length?t._definition.args(t,...i):t},p.expandExtension=function(e,t){if("string"==typeof e.type)return[e];const i=[];for(const n of t._types)if(e.type.test(n)){const a=Object.assign({},e);a.type=n,a.base=t[n](),i.push(a)}return i},e.exports=p.root()},6914:(e,t,i)=>{"use strict";const n=i(375),a=i(8571),s=i(3328);t.compile=function(e,t){if("string"==typeof e)return n(!t,"Cannot set single message string"),new s(e);if(s.isTemplate(e))return n(!t,"Cannot set single message template"),e;n("object"==typeof e&&!Array.isArray(e),"Invalid message options"),t=t?a(t):{};for(let i in e){const a=e[i];if("root"===i||s.isTemplate(a)){t[i]=a;continue}if("string"==typeof a){t[i]=new s(a);continue}n("object"==typeof a&&!Array.isArray(a),"Invalid message for",i);const r=i;for(i in t[r]=t[r]||{},a){const e=a[i];"root"===i||s.isTemplate(e)?t[r][i]=e:(n("string"==typeof e,"Invalid message for",i,"in",r),t[r][i]=new s(e))}}return t},t.decompile=function(e){const t={};for(let i in e){const n=e[i];if("root"===i){t.root=n;continue}if(s.isTemplate(n)){t[i]=n.describe({compact:!0});continue}const a=i;for(i in t[a]={},n){const e=n[i];"root"!==i?t[a][i]=e.describe({compact:!0}):t[a].root=e}}return t},t.merge=function(e,i){if(!e)return t.compile(i);if(!i)return e;if("string"==typeof i)return new s(i);if(s.isTemplate(i))return i;const r=a(e);for(let e in i){const t=i[e];if("root"===e||s.isTemplate(t)){r[e]=t;continue}if("string"==typeof t){r[e]=new s(t);continue}n("object"==typeof t&&!Array.isArray(t),"Invalid message for",e);const a=e;for(e in r[a]=r[a]||{},t){const i=t[e];"root"===e||s.isTemplate(i)?r[a][e]=i:(n("string"==typeof i,"Invalid message for",e,"in",a),r[a][e]=new s(i))}}return r}},2294:(e,t,i)=>{"use strict";const n=i(375),a=i(8160),s=i(6133),r={};t.Ids=r.Ids=class{constructor(){this._byId=new Map,this._byKey=new Map,this._schemaChain=!1}clone(){const e=new r.Ids;return e._byId=new Map(this._byId),e._byKey=new Map(this._byKey),e._schemaChain=this._schemaChain,e}concat(e){e._schemaChain&&(this._schemaChain=!0);for(const[t,i]of e._byId.entries())n(!this._byKey.has(t),"Schema id conflicts with existing key:",t),this._byId.set(t,i);for(const[t,i]of e._byKey.entries())n(!this._byId.has(t),"Schema key conflicts with existing id:",t),this._byKey.set(t,i)}fork(e,t,i){const s=this._collect(e);s.push({schema:i});const o=s.shift();let l={id:o.id,schema:t(o.schema)};n(a.isSchema(l.schema),"adjuster function failed to return a joi schema type");for(const e of s)l={id:e.id,schema:r.fork(e.schema,l.id,l.schema)};return l.schema}labels(e,t=[]){const i=e[0],n=this._get(i);if(!n)return[...t,...e].join(".");const a=e.slice(1);return t=[...t,n.schema._flags.label||i],a.length?n.schema._ids.labels(a,t):t.join(".")}reach(e,t=[]){const i=e[0],a=this._get(i);n(a,"Schema does not contain path",[...t,...e].join("."));const s=e.slice(1);return s.length?a.schema._ids.reach(s,[...t,i]):a.schema}register(e,{key:t}={}){if(!e||!a.isSchema(e))return;(e.$_property("schemaChain")||e._ids._schemaChain)&&(this._schemaChain=!0);const i=e._flags.id;if(i){const t=this._byId.get(i);n(!t||t.schema===e,"Cannot add different schemas with the same id:",i),n(!this._byKey.has(i),"Schema id conflicts with existing key:",i),this._byId.set(i,{schema:e,id:i})}t&&(n(!this._byKey.has(t),"Schema already contains key:",t),n(!this._byId.has(t),"Schema key conflicts with existing id:",t),this._byKey.set(t,{schema:e,id:t}))}reset(){this._byId=new Map,this._byKey=new Map,this._schemaChain=!1}_collect(e,t=[],i=[]){const a=e[0],s=this._get(a);n(s,"Schema does not contain path",[...t,...e].join(".")),i=[s,...i];const r=e.slice(1);return r.length?s.schema._ids._collect(r,[...t,a],i):i}_get(e){return this._byId.get(e)||this._byKey.get(e)}},r.fork=function(e,i,n){const a=t.schema(e,{each:(e,{key:t})=>{if(i===(e._flags.id||t))return n},ref:!1});return a?a.$_mutateRebuild():e},t.schema=function(e,t){let i;for(const n in e._flags){if("_"===n[0])continue;const a=r.scan(e._flags[n],{source:"flags",name:n},t);void 0!==a&&(i=i||e.clone(),i._flags[n]=a)}for(let n=0;n<e._rules.length;++n){const a=e._rules[n],s=r.scan(a.args,{source:"rules",name:a.name},t);if(void 0!==s){i=i||e.clone();const t=Object.assign({},a);t.args=s,i._rules[n]=t,i._singleRules.get(a.name)===a&&i._singleRules.set(a.name,t)}}for(const n in e.$_terms){if("_"===n[0])continue;const a=r.scan(e.$_terms[n],{source:"terms",name:n},t);void 0!==a&&(i=i||e.clone(),i.$_terms[n]=a)}return i},r.scan=function(e,t,i,n,o){const l=n||[];if(null===e||"object"!=typeof e)return;let c;if(Array.isArray(e)){for(let n=0;n<e.length;++n){const a="terms"===t.source&&"keys"===t.name&&e[n].key,s=r.scan(e[n],t,i,[n,...l],a);void 0!==s&&(c=c||e.slice(),c[n]=s)}return c}if(!1!==i.schema&&a.isSchema(e)||!1!==i.ref&&s.isRef(e)){const n=i.each(e,{...t,path:l,key:o});if(n===e)return;return n}for(const n in e){if("_"===n[0])continue;const a=r.scan(e[n],t,i,[n,...l],o);void 0!==a&&(c=c||Object.assign({},e),c[n]=a)}return c}},6133:(e,t,i)=>{"use strict";const n=i(375),a=i(8571),s=i(9621),r=i(8160);let o;const l={symbol:Symbol("ref"),defaults:{adjust:null,in:!1,iterables:null,map:null,separator:".",type:"value"}};t.create=function(e,t={}){n("string"==typeof e,"Invalid reference key:",e),r.assertOptions(t,["adjust","ancestor","in","iterables","map","prefix","render","separator"]),n(!t.prefix||"object"==typeof t.prefix,"options.prefix must be of type object");const i=Object.assign({},l.defaults,t);delete i.prefix;const a=i.separator,s=l.context(e,a,t.prefix);if(i.type=s.type,e=s.key,"value"===i.type)if(s.root&&(n(!a||e[0]!==a,"Cannot specify relative path with root prefix"),i.ancestor="root",e||(e=null)),a&&a===e)e=null,i.ancestor=0;else if(void 0!==i.ancestor)n(!a||!e||e[0]!==a,"Cannot combine prefix with ancestor option");else{const[t,n]=l.ancestor(e,a);n&&""===(e=e.slice(n))&&(e=null),i.ancestor=t}return i.path=a?null===e?[]:e.split(a):[e],new l.Ref(i)},t.in=function(e,i={}){return t.create(e,{...i,in:!0})},t.isRef=function(e){return!!e&&!!e[r.symbols.ref]},l.Ref=class{constructor(e){n("object"==typeof e,"Invalid reference construction"),r.assertOptions(e,["adjust","ancestor","in","iterables","map","path","render","separator","type","depth","key","root","display"]),n([!1,void 0].includes(e.separator)||"string"==typeof e.separator&&1===e.separator.length,"Invalid separator"),n(!e.adjust||"function"==typeof e.adjust,"options.adjust must be a function"),n(!e.map||Array.isArray(e.map),"options.map must be an array"),n(!e.map||!e.adjust,"Cannot set both map and adjust options"),Object.assign(this,l.defaults,e),n("value"===this.type||void 0===this.ancestor,"Non-value references cannot reference ancestors"),Array.isArray(this.map)&&(this.map=new Map(this.map)),this.depth=this.path.length,this.key=this.path.length?this.path.join(this.separator):null,this.root=this.path[0],this.updateDisplay()}resolve(e,t,i,a,s={}){return n(!this.in||s.in,"Invalid in() reference usage"),"global"===this.type?this._resolve(i.context,t,s):"local"===this.type?this._resolve(a,t,s):this.ancestor?"root"===this.ancestor?this._resolve(t.ancestors[t.ancestors.length-1],t,s):(n(this.ancestor<=t.ancestors.length,"Invalid reference exceeds the schema root:",this.display),this._resolve(t.ancestors[this.ancestor-1],t,s)):this._resolve(e,t,s)}_resolve(e,t,i){let n;if("value"===this.type&&t.mainstay.shadow&&!1!==i.shadow&&(n=t.mainstay.shadow.get(this.absolute(t))),void 0===n&&(n=s(e,this.path,{iterables:this.iterables,functions:!0})),this.adjust&&(n=this.adjust(n)),this.map){const e=this.map.get(n);void 0!==e&&(n=e)}return t.mainstay&&t.mainstay.tracer.resolve(t,this,n),n}toString(){return this.display}absolute(e){return[...e.path.slice(0,-this.ancestor),...this.path]}clone(){return new l.Ref(this)}describe(){const e={path:this.path};"value"!==this.type&&(e.type=this.type),"."!==this.separator&&(e.separator=this.separator),"value"===this.type&&1!==this.ancestor&&(e.ancestor=this.ancestor),this.map&&(e.map=[...this.map]);for(const t of["adjust","iterables","render"])null!==this[t]&&void 0!==this[t]&&(e[t]=this[t]);return!1!==this.in&&(e.in=!0),{ref:e}}updateDisplay(){const e=null!==this.key?this.key:"";if("value"!==this.type)return void(this.display=`ref:${this.type}:${e}`);if(!this.separator)return void(this.display=`ref:${e}`);if(!this.ancestor)return void(this.display=`ref:${this.separator}${e}`);if("root"===this.ancestor)return void(this.display=`ref:root:${e}`);if(1===this.ancestor)return void(this.display=`ref:${e||".."}`);const t=new Array(this.ancestor+1).fill(this.separator).join("");this.display=`ref:${t}${e||""}`}},l.Ref.prototype[r.symbols.ref]=!0,t.build=function(e){return"value"===(e=Object.assign({},l.defaults,e)).type&&void 0===e.ancestor&&(e.ancestor=1),new l.Ref(e)},l.context=function(e,t,i={}){if(e=e.trim(),i){const n=void 0===i.global?"$":i.global;if(n!==t&&e.startsWith(n))return{key:e.slice(n.length),type:"global"};const a=void 0===i.local?"#":i.local;if(a!==t&&e.startsWith(a))return{key:e.slice(a.length),type:"local"};const s=void 0===i.root?"/":i.root;if(s!==t&&e.startsWith(s))return{key:e.slice(s.length),type:"value",root:!0}}return{key:e,type:"value"}},l.ancestor=function(e,t){if(!t)return[1,0];if(e[0]!==t)return[1,0];if(e[1]!==t)return[0,1];let i=2;for(;e[i]===t;)++i;return[i-1,i]},t.toSibling=0,t.toParent=1,t.Manager=class{constructor(){this.refs=[]}register(e,n){if(e)if(n=void 0===n?t.toParent:n,Array.isArray(e))for(const t of e)this.register(t,n);else if(r.isSchema(e))for(const t of e._refs.refs)t.ancestor-n>=0&&this.refs.push({ancestor:t.ancestor-n,root:t.root});else t.isRef(e)&&"value"===e.type&&e.ancestor-n>=0&&this.refs.push({ancestor:e.ancestor-n,root:e.root}),o=o||i(3328),o.isTemplate(e)&&this.register(e.refs(),n)}get length(){return this.refs.length}clone(){const e=new t.Manager;return e.refs=a(this.refs),e}reset(){this.refs=[]}roots(){return this.refs.filter((e=>!e.ancestor)).map((e=>e.root))}}},3378:(e,t,i)=>{"use strict";const n=i(5107),a={};a.wrap=n.string().min(1).max(2).allow(!1),t.preferences=n.object({allowUnknown:n.boolean(),abortEarly:n.boolean(),artifacts:n.boolean(),cache:n.boolean(),context:n.object(),convert:n.boolean(),dateFormat:n.valid("date","iso","string","time","utc"),debug:n.boolean(),errors:{escapeHtml:n.boolean(),label:n.valid("path","key",!1),language:[n.string(),n.object().ref()],render:n.boolean(),stack:n.boolean(),wrap:{label:a.wrap,array:a.wrap,string:a.wrap}},externals:n.boolean(),messages:n.object(),noDefaults:n.boolean(),nonEnumerables:n.boolean(),presence:n.valid("required","optional","forbidden"),skipFunctions:n.boolean(),stripUnknown:n.object({arrays:n.boolean(),objects:n.boolean()}).or("arrays","objects").allow(!0,!1),warnings:n.boolean()}).strict(),a.nameRx=/^[a-zA-Z0-9]\w*$/,a.rule=n.object({alias:n.array().items(n.string().pattern(a.nameRx)).single(),args:n.array().items(n.string(),n.object({name:n.string().pattern(a.nameRx).required(),ref:n.boolean(),assert:n.alternatives([n.function(),n.object().schema()]).conditional("ref",{is:!0,then:n.required()}),normalize:n.function(),message:n.string().when("assert",{is:n.function(),then:n.required()})})),convert:n.boolean(),manifest:n.boolean(),method:n.function().allow(!1),multi:n.boolean(),validate:n.function()}),t.extension=n.object({type:n.alternatives([n.string(),n.object().regex()]).required(),args:n.function(),cast:n.object().pattern(a.nameRx,n.object({from:n.function().maxArity(1).required(),to:n.function().minArity(1).maxArity(2).required()})),base:n.object().schema().when("type",{is:n.object().regex(),then:n.forbidden()}),coerce:[n.function().maxArity(3),n.object({method:n.function().maxArity(3).required(),from:n.array().items(n.string()).single()})],flags:n.object().pattern(a.nameRx,n.object({setter:n.string(),default:n.any()})),manifest:{build:n.function().arity(2)},messages:[n.object(),n.string()],modifiers:n.object().pattern(a.nameRx,n.function().minArity(1).maxArity(2)),overrides:n.object().pattern(a.nameRx,n.function()),prepare:n.function().maxArity(3),rebuild:n.function().arity(1),rules:n.object().pattern(a.nameRx,a.rule),terms:n.object().pattern(a.nameRx,n.object({init:n.array().allow(null).required(),manifest:n.object().pattern(/.+/,[n.valid("schema","single"),n.object({mapped:n.object({from:n.string().required(),to:n.string().required()}).required()})])})),validate:n.function().maxArity(3)}).strict(),t.extensions=n.array().items(n.object(),n.function().arity(1)).strict(),a.desc={buffer:n.object({buffer:n.string()}),func:n.object({function:n.function().required(),options:{literal:!0}}),override:n.object({override:!0}),ref:n.object({ref:n.object({type:n.valid("value","global","local"),path:n.array().required(),separator:n.string().length(1).allow(!1),ancestor:n.number().min(0).integer().allow("root"),map:n.array().items(n.array().length(2)).min(1),adjust:n.function(),iterables:n.boolean(),in:n.boolean(),render:n.boolean()}).required()}),regex:n.object({regex:n.string().min(3)}),special:n.object({special:n.valid("deep").required()}),template:n.object({template:n.string().required(),options:n.object()}),value:n.object({value:n.alternatives([n.object(),n.array()]).required()})},a.desc.entity=n.alternatives([n.array().items(n.link("...")),n.boolean(),n.function(),n.number(),n.string(),a.desc.buffer,a.desc.func,a.desc.ref,a.desc.regex,a.desc.special,a.desc.template,a.desc.value,n.link("/")]),a.desc.values=n.array().items(null,n.boolean(),n.function(),n.number().allow(1/0,-1/0),n.string().allow(""),n.symbol(),a.desc.buffer,a.desc.func,a.desc.override,a.desc.ref,a.desc.regex,a.desc.template,a.desc.value),a.desc.messages=n.object().pattern(/.+/,[n.string(),a.desc.template,n.object().pattern(/.+/,[n.string(),a.desc.template])]),t.description=n.object({type:n.string().required(),flags:n.object({cast:n.string(),default:n.any(),description:n.string(),empty:n.link("/"),failover:a.desc.entity,id:n.string(),label:n.string(),only:!0,presence:["optional","required","forbidden"],result:["raw","strip"],strip:n.boolean(),unit:n.string()}).unknown(),preferences:{allowUnknown:n.boolean(),abortEarly:n.boolean(),artifacts:n.boolean(),cache:n.boolean(),convert:n.boolean(),dateFormat:["date","iso","string","time","utc"],errors:{escapeHtml:n.boolean(),label:["path","key"],language:[n.string(),a.desc.ref],wrap:{label:a.wrap,array:a.wrap}},externals:n.boolean(),messages:a.desc.messages,noDefaults:n.boolean(),nonEnumerables:n.boolean(),presence:["required","optional","forbidden"],skipFunctions:n.boolean(),stripUnknown:n.object({arrays:n.boolean(),objects:n.boolean()}).or("arrays","objects").allow(!0,!1),warnings:n.boolean()},allow:a.desc.values,invalid:a.desc.values,rules:n.array().min(1).items({name:n.string().required(),args:n.object().min(1),keep:n.boolean(),message:[n.string(),a.desc.messages],warn:n.boolean()}),keys:n.object().pattern(/.*/,n.link("/")),link:a.desc.ref}).pattern(/^[a-z]\w*$/,n.any())},493:(e,t,i)=>{"use strict";const n=i(8571),a=i(9621),s=i(8160),r={value:Symbol("value")};e.exports=r.State=class{constructor(e,t,i){this.path=e,this.ancestors=t,this.mainstay=i.mainstay,this.schemas=i.schemas,this.debug=null}localize(e,t=null,i=null){const n=new r.State(e,t,this);return i&&n.schemas&&(n.schemas=[r.schemas(i),...n.schemas]),n}nest(e,t){const i=new r.State(this.path,this.ancestors,this);return i.schemas=i.schemas&&[r.schemas(e),...i.schemas],i.debug=t,i}shadow(e,t){this.mainstay.shadow=this.mainstay.shadow||new r.Shadow,this.mainstay.shadow.set(this.path,e,t)}snapshot(){this.mainstay.shadow&&(this._snapshot=n(this.mainstay.shadow.node(this.path))),this.mainstay.snapshot()}restore(){this.mainstay.shadow&&(this.mainstay.shadow.override(this.path,this._snapshot),this._snapshot=void 0),this.mainstay.restore()}commit(){this.mainstay.shadow&&(this.mainstay.shadow.override(this.path,this._snapshot),this._snapshot=void 0),this.mainstay.commit()}},r.schemas=function(e){return s.isSchema(e)?{schema:e}:e},r.Shadow=class{constructor(){this._values=null}set(e,t,i){if(!e.length)return;if("strip"===i&&"number"==typeof e[e.length-1])return;this._values=this._values||new Map;let n=this._values;for(let t=0;t<e.length;++t){const i=e[t];let a=n.get(i);a||(a=new Map,n.set(i,a)),n=a}n[r.value]=t}get(e){const t=this.node(e);if(t)return t[r.value]}node(e){if(this._values)return a(this._values,e,{iterables:!0})}override(e,t){if(!this._values)return;const i=e.slice(0,-1),n=e[e.length-1],s=a(this._values,i,{iterables:!0});t?s.set(n,t):s&&s.delete(n)}}},3328:(e,t,i)=>{"use strict";const n=i(375),a=i(8571),s=i(5277),r=i(1447),o=i(8160),l=i(6354),c=i(6133),u={symbol:Symbol("template"),opens:new Array(1e3).join("\0"),closes:new Array(1e3).join(""),dateFormat:{date:Date.prototype.toDateString,iso:Date.prototype.toISOString,string:Date.prototype.toString,time:Date.prototype.toTimeString,utc:Date.prototype.toUTCString}};e.exports=u.Template=class{constructor(e,t){if(n("string"==typeof e,"Template source must be a string"),n(!e.includes("\0")&&!e.includes(""),"Template source cannot contain reserved control characters"),this.source=e,this.rendered=e,this._template=null,t){const{functions:e,...i}=t;this._settings=Object.keys(i).length?a(i):void 0,this._functions=e,this._functions&&(n(Object.keys(this._functions).every((e=>"string"==typeof e)),"Functions keys must be strings"),n(Object.values(this._functions).every((e=>"function"==typeof e)),"Functions values must be functions"))}else this._settings=void 0,this._functions=void 0;this._parse()}_parse(){if(!this.source.includes("{"))return;const e=u.encode(this.source),t=u.split(e);let i=!1;const n=[],a=t.shift();a&&n.push(a);for(const e of t){const t="{"!==e[0],a=t?"}":"}}",s=e.indexOf(a);if(-1===s||"{"===e[1]){n.push(`{${u.decode(e)}`);continue}let r=e.slice(t?0:1,s);const o=":"===r[0];o&&(r=r.slice(1));const l=this._ref(u.decode(r),{raw:t,wrapped:o});n.push(l),"string"!=typeof l&&(i=!0);const c=e.slice(s+a.length);c&&n.push(u.decode(c))}i?this._template=n:this.rendered=n.join("")}static date(e,t){return u.dateFormat[t.dateFormat].call(e)}describe(e={}){if(!this._settings&&e.compact)return this.source;const t={template:this.source};return this._settings&&(t.options=this._settings),this._functions&&(t.functions=this._functions),t}static build(e){return new u.Template(e.template,e.options||e.functions?{...e.options,functions:e.functions}:void 0)}isDynamic(){return!!this._template}static isTemplate(e){return!!e&&!!e[o.symbols.template]}refs(){if(!this._template)return;const e=[];for(const t of this._template)"string"!=typeof t&&e.push(...t.refs);return e}resolve(e,t,i,n){return this._template&&1===this._template.length?this._part(this._template[0],e,t,i,n,{}):this.render(e,t,i,n)}_part(e,...t){return e.ref?e.ref.resolve(...t):e.formula.evaluate(t)}render(e,t,i,n,a={}){if(!this.isDynamic())return this.rendered;const r=[];for(const o of this._template)if("string"==typeof o)r.push(o);else{const l=this._part(o,e,t,i,n,a),c=u.stringify(l,e,t,i,n,a);if(void 0!==c){const e=o.raw||!1===(a.errors&&a.errors.escapeHtml)?c:s(c);r.push(u.wrap(e,o.wrapped&&i.errors.wrap.label))}}return r.join("")}_ref(e,{raw:t,wrapped:i}){const n=[],a=e=>{const t=c.create(e,this._settings);return n.push(t),e=>{const i=t.resolve(...e);return void 0!==i?i:null}};try{const t=this._functions?{...u.functions,...this._functions}:u.functions;var s=new r.Parser(e,{reference:a,functions:t,constants:u.constants})}catch(t){throw t.message=`Invalid template variable "${e}" fails due to: ${t.message}`,t}if(s.single){if("reference"===s.single.type){const e=n[0];return{ref:e,raw:t,refs:n,wrapped:i||"local"===e.type&&"label"===e.key}}return u.stringify(s.single.value)}return{formula:s,raw:t,refs:n}}toString(){return this.source}},u.Template.prototype[o.symbols.template]=!0,u.Template.prototype.isImmutable=!0,u.encode=function(e){return e.replace(/\\(\{+)/g,((e,t)=>u.opens.slice(0,t.length))).replace(/\\(\}+)/g,((e,t)=>u.closes.slice(0,t.length)))},u.decode=function(e){return e.replace(/\u0000/g,"{").replace(/\u0001/g,"}")},u.split=function(e){const t=[];let i="";for(let n=0;n<e.length;++n){const a=e[n];if("{"===a){let a="";for(;n+1<e.length&&"{"===e[n+1];)a+="{",++n;t.push(i),i=a}else i+=a}return t.push(i),t},u.wrap=function(e,t){return t?1===t.length?`${t}${e}${t}`:`${t[0]}${e}${t[1]}`:e},u.stringify=function(e,t,i,n,a,s={}){const r=typeof e,o=n&&n.errors&&n.errors.wrap||{};let l=!1;if(c.isRef(e)&&e.render&&(l=e.in,e=e.resolve(t,i,n,a,{in:e.in,...s})),null===e)return"null";if("string"===r)return u.wrap(e,s.arrayItems&&o.string);if("number"===r||"function"===r||"symbol"===r)return e.toString();if("object"!==r)return JSON.stringify(e);if(e instanceof Date)return u.Template.date(e,n);if(e instanceof Map){const t=[];for(const[i,n]of e.entries())t.push(`${i.toString()} -> ${n.toString()}`);e=t}if(!Array.isArray(e))return e.toString();const m=[];for(const r of e)m.push(u.stringify(r,t,i,n,a,{arrayItems:!0,...s}));return u.wrap(m.join(", "),!l&&o.array)},u.constants={true:!0,false:!1,null:null,second:1e3,minute:6e4,hour:36e5,day:864e5},u.functions={if:(e,t,i)=>e?t:i,length:e=>"string"==typeof e?e.length:e&&"object"==typeof e?Array.isArray(e)?e.length:Object.keys(e).length:null,msg(e){const[t,i,n,a,s]=this,r=s.messages;if(!r)return"";const o=l.template(t,r[0],e,i,n)||l.template(t,r[1],e,i,n);return o?o.render(t,i,n,a,s):""},number:e=>"number"==typeof e?e:"string"==typeof e?parseFloat(e):"boolean"==typeof e?e?1:0:e instanceof Date?e.getTime():null}},4946:(e,t,i)=>{"use strict";const n=i(375),a=i(1687),s=i(8068),r=i(8160),o=i(3292),l=i(6354),c=i(6133),u={};e.exports=s.extend({type:"alternatives",flags:{match:{default:"any"}},terms:{matches:{init:[],register:c.toSibling}},args:(e,...t)=>1===t.length&&Array.isArray(t[0])?e.try(...t[0]):e.try(...t),validate(e,t){const{schema:i,error:n,state:s,prefs:r}=t;if(i._flags.match){const t=[],o=[];for(let n=0;n<i.$_terms.matches.length;++n){const a=i.$_terms.matches[n],l=s.nest(a.schema,`match.${n}`);l.snapshot();const c=a.schema.$_validate(e,l,r);c.errors?(o.push(c.errors),l.restore()):(t.push(c.value),l.commit())}if(0===t.length)return{errors:n("alternatives.any",{details:o.map((e=>l.details(e,{override:!1})))})};if("one"===i._flags.match)return 1===t.length?{value:t[0]}:{errors:n("alternatives.one")};if(t.length!==i.$_terms.matches.length)return{errors:n("alternatives.all",{details:o.map((e=>l.details(e,{override:!1})))})};const c=e=>e.$_terms.matches.some((e=>"object"===e.schema.type||"alternatives"===e.schema.type&&c(e.schema)));return c(i)?{value:t.reduce(((e,t)=>a(e,t,{mergeArrays:!1})))}:{value:t[t.length-1]}}const o=[];for(let t=0;t<i.$_terms.matches.length;++t){const n=i.$_terms.matches[t];if(n.schema){const i=s.nest(n.schema,`match.${t}`);i.snapshot();const a=n.schema.$_validate(e,i,r);if(!a.errors)return i.commit(),a;i.restore(),o.push({schema:n.schema,reports:a.errors});continue}const a=n.ref?n.ref.resolve(e,s,r):e,l=n.is?[n]:n.switch;for(let i=0;i<l.length;++i){const o=l[i],{is:c,then:u,otherwise:m}=o,d=`match.${t}${n.switch?"."+i:""}`;if(c.$_match(a,s.nest(c,`${d}.is`),r)){if(u)return u.$_validate(e,s.nest(u,`${d}.then`),r)}else if(m)return m.$_validate(e,s.nest(m,`${d}.otherwise`),r)}}return u.errors(o,t)},rules:{conditional:{method(e,t){n(!this._flags._endedSwitch,"Unreachable condition"),n(!this._flags.match,"Cannot combine match mode",this._flags.match,"with conditional rule"),n(void 0===t.break,"Cannot use break option with alternatives conditional");const i=this.clone(),a=o.when(i,e,t),s=a.is?[a]:a.switch;for(const e of s)if(e.then&&e.otherwise){i.$_setFlag("_endedSwitch",!0,{clone:!1});break}return i.$_terms.matches.push(a),i.$_mutateRebuild()}},match:{method(e){if(n(["any","one","all"].includes(e),"Invalid alternatives match mode",e),"any"!==e)for(const t of this.$_terms.matches)n(t.schema,"Cannot combine match mode",e,"with conditional rules");return this.$_setFlag("match",e)}},try:{method(...e){n(e.length,"Missing alternative schemas"),r.verifyFlat(e,"try"),n(!this._flags._endedSwitch,"Unreachable condition");const t=this.clone();for(const i of e)t.$_terms.matches.push({schema:t.$_compile(i)});return t.$_mutateRebuild()}}},overrides:{label(e){return this.$_parent("label",e).$_modify({each:(t,i)=>"is"!==i.path[0]&&"string"!=typeof t._flags.label?t.label(e):void 0,ref:!1})}},rebuild(e){e.$_modify({each:t=>{r.isSchema(t)&&"array"===t.type&&e.$_setFlag("_arrayItems",!0,{clone:!1})}})},manifest:{build(e,t){if(t.matches)for(const i of t.matches){const{schema:t,ref:n,is:a,not:s,then:r,otherwise:o}=i;e=t?e.try(t):n?e.conditional(n,{is:a,then:r,not:s,otherwise:o,switch:i.switch}):e.conditional(a,{then:r,otherwise:o})}return e}},messages:{"alternatives.all":"{{#label}} does not match all of the required types","alternatives.any":"{{#label}} does not match any of the allowed types","alternatives.match":"{{#label}} does not match any of the allowed types","alternatives.one":"{{#label}} matches more than one allowed type","alternatives.types":"{{#label}} must be one of {{#types}}"}}),u.errors=function(e,{error:t,state:i}){if(!e.length)return{errors:t("alternatives.any")};if(1===e.length)return{errors:e[0].reports};const n=new Set,a=[];for(const{reports:s,schema:r}of e){if(s.length>1)return u.unmatched(e,t);const o=s[0];if(o instanceof l.Report==0)return u.unmatched(e,t);if(o.state.path.length!==i.path.length){a.push({type:r.type,report:o});continue}if("any.only"===o.code){for(const e of o.local.valids)n.add(e);continue}const[c,m]=o.code.split(".");"base"===m?n.add(c):a.push({type:r.type,report:o})}return a.length?1===a.length?{errors:a[0].report}:u.unmatched(e,t):{errors:t("alternatives.types",{types:[...n]})}},u.unmatched=function(e,t){const i=[];for(const t of e)i.push(...t.reports);return{errors:t("alternatives.match",l.details(i,{override:!1}))}}},8068:(e,t,i)=>{"use strict";const n=i(375),a=i(7629),s=i(8160),r=i(6914);e.exports=a.extend({type:"any",flags:{only:{default:!1}},terms:{alterations:{init:null},examples:{init:null},externals:{init:null},metas:{init:[]},notes:{init:[]},shared:{init:null},tags:{init:[]},whens:{init:null}},rules:{custom:{method(e,t){return n("function"==typeof e,"Method must be a function"),n(void 0===t||t&&"string"==typeof t,"Description must be a non-empty string"),this.$_addRule({name:"custom",args:{method:e,description:t}})},validate(e,t,{method:i}){try{return i(e,t)}catch(e){return t.error("any.custom",{error:e})}},args:["method","description"],multi:!0},messages:{method(e){return this.prefs({messages:e})}},shared:{method(e){n(s.isSchema(e)&&e._flags.id,"Schema must be a schema with an id");const t=this.clone();return t.$_terms.shared=t.$_terms.shared||[],t.$_terms.shared.push(e),t.$_mutateRegister(e),t}},warning:{method(e,t){return n(e&&"string"==typeof e,"Invalid warning code"),this.$_addRule({name:"warning",args:{code:e,local:t},warn:!0})},validate:(e,t,{code:i,local:n})=>t.error(i,n),args:["code","local"],multi:!0}},modifiers:{keep(e,t=!0){e.keep=t},message(e,t){e.message=r.compile(t)},warn(e,t=!0){e.warn=t}},manifest:{build(e,t){for(const i in t){const n=t[i];if(["examples","externals","metas","notes","tags"].includes(i))for(const t of n)e=e[i.slice(0,-1)](t);else if("alterations"!==i)if("whens"!==i){if("shared"===i)for(const t of n)e=e.shared(t)}else for(const t of n){const{ref:i,is:n,not:a,then:s,otherwise:r,concat:o}=t;e=o?e.concat(o):i?e.when(i,{is:n,not:a,then:s,otherwise:r,switch:t.switch,break:t.break}):e.when(n,{then:s,otherwise:r,break:t.break})}else{const t={};for(const{target:e,adjuster:i}of n)t[e]=i;e=e.alter(t)}}return e}},messages:{"any.custom":"{{#label}} failed custom validation because {{#error.message}}","any.default":"{{#label}} threw an error when running default method","any.failover":"{{#label}} threw an error when running failover method","any.invalid":"{{#label}} contains an invalid value","any.only":'{{#label}} must be {if(#valids.length == 1, "", "one of ")}{{#valids}}',"any.ref":"{{#label}} {{#arg}} references {{:#ref}} which {{#reason}}","any.required":"{{#label}} is required","any.unknown":"{{#label}} is not allowed"}})},546:(e,t,i)=>{"use strict";const n=i(375),a=i(9474),s=i(9621),r=i(8068),o=i(8160),l=i(3292),c={};e.exports=r.extend({type:"array",flags:{single:{default:!1},sparse:{default:!1}},terms:{items:{init:[],manifest:"schema"},ordered:{init:[],manifest:"schema"},_exclusions:{init:[]},_inclusions:{init:[]},_requireds:{init:[]}},coerce:{from:"object",method(e,{schema:t,state:i,prefs:n}){if(!Array.isArray(e))return;const a=t.$_getRule("sort");return a?c.sort(t,e,a.args.options,i,n):void 0}},validate(e,{schema:t,error:i}){if(!Array.isArray(e)){if(t._flags.single){const t=[e];return t[o.symbols.arraySingle]=!0,{value:t}}return{errors:i("array.base")}}if(t.$_getRule("items")||t.$_terms.externals)return{value:e.slice()}},rules:{has:{method(e){e=this.$_compile(e,{appendPath:!0});const t=this.$_addRule({name:"has",args:{schema:e}});return t.$_mutateRegister(e),t},validate(e,{state:t,prefs:i,error:n},{schema:a}){const s=[e,...t.ancestors];for(let n=0;n<e.length;++n){const r=t.localize([...t.path,n],s,a);if(a.$_match(e[n],r,i))return e}const r=a._flags.label;return r?n("array.hasKnown",{patternLabel:r}):n("array.hasUnknown",null)},multi:!0},items:{method(...e){o.verifyFlat(e,"items");const t=this.$_addRule("items");for(let i=0;i<e.length;++i){const n=o.tryWithPath((()=>this.$_compile(e[i])),i,{append:!0});t.$_terms.items.push(n)}return t.$_mutateRebuild()},validate(e,{schema:t,error:i,state:n,prefs:a,errorsArray:s}){const r=t.$_terms._requireds.slice(),l=t.$_terms.ordered.slice(),u=[...t.$_terms._inclusions,...r],m=!e[o.symbols.arraySingle];delete e[o.symbols.arraySingle];const d=s();let h=e.length;for(let s=0;s<h;++s){const o=e[s];let f=!1,p=!1;const g=m?s:new Number(s),y=[...n.path,g];if(!t._flags.sparse&&void 0===o){if(d.push(i("array.sparse",{key:g,path:y,pos:s,value:void 0},n.localize(y))),a.abortEarly)return d;l.shift();continue}const v=[e,...n.ancestors];for(const e of t.$_terms._exclusions)if(e.$_match(o,n.localize(y,v,e),a,{presence:"ignore"})){if(d.push(i("array.excludes",{pos:s,value:o},n.localize(y))),a.abortEarly)return d;f=!0,l.shift();break}if(f)continue;if(t.$_terms.ordered.length){if(l.length){const r=l.shift(),u=r.$_validate(o,n.localize(y,v,r),a);if(u.errors){if(d.push(...u.errors),a.abortEarly)return d}else if("strip"===r._flags.result)c.fastSplice(e,s),--s,--h;else{if(!t._flags.sparse&&void 0===u.value){if(d.push(i("array.sparse",{key:g,path:y,pos:s,value:void 0},n.localize(y))),a.abortEarly)return d;continue}e[s]=u.value}continue}if(!t.$_terms.items.length){if(d.push(i("array.orderedLength",{pos:s,limit:t.$_terms.ordered.length})),a.abortEarly)return d;break}}const b=[];let k=r.length;for(let l=0;l<k;++l){const u=n.localize(y,v,r[l]);u.snapshot();const m=r[l].$_validate(o,u,a);if(b[l]=m,!m.errors){if(u.commit(),e[s]=m.value,p=!0,c.fastSplice(r,l),--l,--k,!t._flags.sparse&&void 0===m.value&&(d.push(i("array.sparse",{key:g,path:y,pos:s,value:void 0},n.localize(y))),a.abortEarly))return d;break}u.restore()}if(p)continue;const w=a.stripUnknown&&!!a.stripUnknown.arrays||!1;k=u.length;for(const l of u){let u;const m=r.indexOf(l);if(-1!==m)u=b[m];else{const r=n.localize(y,v,l);if(r.snapshot(),u=l.$_validate(o,r,a),!u.errors){r.commit(),"strip"===l._flags.result?(c.fastSplice(e,s),--s,--h):t._flags.sparse||void 0!==u.value?e[s]=u.value:(d.push(i("array.sparse",{key:g,path:y,pos:s,value:void 0},n.localize(y))),f=!0),p=!0;break}r.restore()}if(1===k){if(w){c.fastSplice(e,s),--s,--h,p=!0;break}if(d.push(...u.errors),a.abortEarly)return d;f=!0;break}}if(!f&&(t.$_terms._inclusions.length||t.$_terms._requireds.length)&&!p){if(w){c.fastSplice(e,s),--s,--h;continue}if(d.push(i("array.includes",{pos:s,value:o},n.localize(y))),a.abortEarly)return d}}return r.length&&c.fillMissedErrors(t,d,r,e,n,a),l.length&&(c.fillOrderedErrors(t,d,l,e,n,a),d.length||c.fillDefault(l,e,n,a)),d.length?d:e},priority:!0,manifest:!1},length:{method(e){return this.$_addRule({name:"length",args:{limit:e},operator:"="})},validate:(e,t,{limit:i},{name:n,operator:a,args:s})=>o.compare(e.length,i,a)?e:t.error("array."+n,{limit:s.limit,value:e}),args:[{name:"limit",ref:!0,assert:o.limit,message:"must be a positive integer"}]},max:{method(e){return this.$_addRule({name:"max",method:"length",args:{limit:e},operator:"<="})}},min:{method(e){return this.$_addRule({name:"min",method:"length",args:{limit:e},operator:">="})}},ordered:{method(...e){o.verifyFlat(e,"ordered");const t=this.$_addRule("items");for(let i=0;i<e.length;++i){const n=o.tryWithPath((()=>this.$_compile(e[i])),i,{append:!0});c.validateSingle(n,t),t.$_mutateRegister(n),t.$_terms.ordered.push(n)}return t.$_mutateRebuild()}},single:{method(e){const t=void 0===e||!!e;return n(!t||!this._flags._arrayItems,"Cannot specify single rule when array has array items"),this.$_setFlag("single",t)}},sort:{method(e={}){o.assertOptions(e,["by","order"]);const t={order:e.order||"ascending"};return e.by&&(t.by=l.ref(e.by,{ancestor:0}),n(!t.by.ancestor,"Cannot sort by ancestor")),this.$_addRule({name:"sort",args:{options:t}})},validate(e,{error:t,state:i,prefs:n,schema:a},{options:s}){const{value:r,errors:o}=c.sort(a,e,s,i,n);if(o)return o;for(let i=0;i<e.length;++i)if(e[i]!==r[i])return t("array.sort",{order:s.order,by:s.by?s.by.key:"value"});return e},convert:!0},sparse:{method(e){const t=void 0===e||!!e;return this._flags.sparse===t?this:(t?this.clone():this.$_addRule("items")).$_setFlag("sparse",t,{clone:!1})}},unique:{method(e,t={}){n(!e||"function"==typeof e||"string"==typeof e,"comparator must be a function or a string"),o.assertOptions(t,["ignoreUndefined","separator"]);const i={name:"unique",args:{options:t,comparator:e}};if(e)if("string"==typeof e){const n=o.default(t.separator,".");i.path=n?e.split(n):[e]}else i.comparator=e;return this.$_addRule(i)},validate(e,{state:t,error:i,schema:r},{comparator:o,options:l},{comparator:c,path:u}){const m={string:Object.create(null),number:Object.create(null),undefined:Object.create(null),boolean:Object.create(null),object:new Map,function:new Map,custom:new Map},d=c||a,h=l.ignoreUndefined;for(let a=0;a<e.length;++a){const r=u?s(e[a],u):e[a],l=c?m.custom:m[typeof r];if(n(l,"Failed to find unique map container for type",typeof r),l instanceof Map){const n=l.entries();let s;for(;!(s=n.next()).done;)if(d(s.value[0],r)){const n=t.localize([...t.path,a],[e,...t.ancestors]),r={pos:a,value:e[a],dupePos:s.value[1],dupeValue:e[s.value[1]]};return u&&(r.path=o),i("array.unique",r,n)}l.set(r,a)}else{if((!h||void 0!==r)&&void 0!==l[r]){const n={pos:a,value:e[a],dupePos:l[r],dupeValue:e[l[r]]};return u&&(n.path=o),i("array.unique",n,t.localize([...t.path,a],[e,...t.ancestors]))}l[r]=a}}return e},args:["comparator","options"],multi:!0}},cast:{set:{from:Array.isArray,to:(e,t)=>new Set(e)}},rebuild(e){e.$_terms._inclusions=[],e.$_terms._exclusions=[],e.$_terms._requireds=[];for(const t of e.$_terms.items)c.validateSingle(t,e),"required"===t._flags.presence?e.$_terms._requireds.push(t):"forbidden"===t._flags.presence?e.$_terms._exclusions.push(t):e.$_terms._inclusions.push(t);for(const t of e.$_terms.ordered)c.validateSingle(t,e)},manifest:{build:(e,t)=>(t.items&&(e=e.items(...t.items)),t.ordered&&(e=e.ordered(...t.ordered)),e)},messages:{"array.base":"{{#label}} must be an array","array.excludes":"{{#label}} contains an excluded value","array.hasKnown":"{{#label}} does not contain at least one required match for type {:#patternLabel}","array.hasUnknown":"{{#label}} does not contain at least one required match","array.includes":"{{#label}} does not match any of the allowed types","array.includesRequiredBoth":"{{#label}} does not contain {{#knownMisses}} and {{#unknownMisses}} other required value(s)","array.includesRequiredKnowns":"{{#label}} does not contain {{#knownMisses}}","array.includesRequiredUnknowns":"{{#label}} does not contain {{#unknownMisses}} required value(s)","array.length":"{{#label}} must contain {{#limit}} items","array.max":"{{#label}} must contain less than or equal to {{#limit}} items","array.min":"{{#label}} must contain at least {{#limit}} items","array.orderedLength":"{{#label}} must contain at most {{#limit}} items","array.sort":"{{#label}} must be sorted in {#order} order by {{#by}}","array.sort.mismatching":"{{#label}} cannot be sorted due to mismatching types","array.sort.unsupported":"{{#label}} cannot be sorted due to unsupported type {#type}","array.sparse":"{{#label}} must not be a sparse array item","array.unique":"{{#label}} contains a duplicate value"}}),c.fillMissedErrors=function(e,t,i,n,a,s){const r=[];let o=0;for(const e of i){const t=e._flags.label;t?r.push(t):++o}r.length?o?t.push(e.$_createError("array.includesRequiredBoth",n,{knownMisses:r,unknownMisses:o},a,s)):t.push(e.$_createError("array.includesRequiredKnowns",n,{knownMisses:r},a,s)):t.push(e.$_createError("array.includesRequiredUnknowns",n,{unknownMisses:o},a,s))},c.fillOrderedErrors=function(e,t,i,n,a,s){const r=[];for(const e of i)"required"===e._flags.presence&&r.push(e);r.length&&c.fillMissedErrors(e,t,r,n,a,s)},c.fillDefault=function(e,t,i,n){const a=[];let s=!0;for(let r=e.length-1;r>=0;--r){const o=e[r],l=[t,...i.ancestors],c=o.$_validate(void 0,i.localize(i.path,l,o),n).value;if(s){if(void 0===c)continue;s=!1}a.unshift(c)}a.length&&t.push(...a)},c.fastSplice=function(e,t){let i=t;for(;i<e.length;)e[i++]=e[i];--e.length},c.validateSingle=function(e,t){("array"===e.type||e._flags._arrayItems)&&(n(!t._flags.single,"Cannot specify array item with single rule enabled"),t.$_setFlag("_arrayItems",!0,{clone:!1}))},c.sort=function(e,t,i,n,a){const s="ascending"===i.order?1:-1,r=-1*s,o=s,l=(l,u)=>{let m=c.compare(l,u,r,o);if(null!==m)return m;if(i.by&&(l=i.by.resolve(l,n,a),u=i.by.resolve(u,n,a)),m=c.compare(l,u,r,o),null!==m)return m;const d=typeof l;if(d!==typeof u)throw e.$_createError("array.sort.mismatching",t,null,n,a);if("number"!==d&&"string"!==d)throw e.$_createError("array.sort.unsupported",t,{type:d},n,a);return"number"===d?(l-u)*s:l<u?r:o};try{return{value:t.slice().sort(l)}}catch(e){return{errors:e}}},c.compare=function(e,t,i,n){return e===t?0:void 0===e?1:void 0===t?-1:null===e?n:null===t?i:null}},4937:(e,t,i)=>{"use strict";const n=i(375),a=i(8068),s=i(8160),r=i(2036),o={isBool:function(e){return"boolean"==typeof e}};e.exports=a.extend({type:"boolean",flags:{sensitive:{default:!1}},terms:{falsy:{init:null,manifest:"values"},truthy:{init:null,manifest:"values"}},coerce(e,{schema:t}){if("boolean"!=typeof e){if("string"==typeof e){const i=t._flags.sensitive?e:e.toLowerCase();e="true"===i||"false"!==i&&e}return"boolean"!=typeof e&&(e=t.$_terms.truthy&&t.$_terms.truthy.has(e,null,null,!t._flags.sensitive)||(!t.$_terms.falsy||!t.$_terms.falsy.has(e,null,null,!t._flags.sensitive))&&e),{value:e}}},validate(e,{error:t}){if("boolean"!=typeof e)return{value:e,errors:t("boolean.base")}},rules:{truthy:{method(...e){s.verifyFlat(e,"truthy");const t=this.clone();t.$_terms.truthy=t.$_terms.truthy||new r;for(let i=0;i<e.length;++i){const a=e[i];n(void 0!==a,"Cannot call truthy with undefined"),t.$_terms.truthy.add(a)}return t}},falsy:{method(...e){s.verifyFlat(e,"falsy");const t=this.clone();t.$_terms.falsy=t.$_terms.falsy||new r;for(let i=0;i<e.length;++i){const a=e[i];n(void 0!==a,"Cannot call falsy with undefined"),t.$_terms.falsy.add(a)}return t}},sensitive:{method(e=!0){return this.$_setFlag("sensitive",e)}}},cast:{number:{from:o.isBool,to:(e,t)=>e?1:0},string:{from:o.isBool,to:(e,t)=>e?"true":"false"}},manifest:{build:(e,t)=>(t.truthy&&(e=e.truthy(...t.truthy)),t.falsy&&(e=e.falsy(...t.falsy)),e)},messages:{"boolean.base":"{{#label}} must be a boolean"}})},7500:(e,t,i)=>{"use strict";const n=i(375),a=i(8068),s=i(8160),r=i(3328),o={isDate:function(e){return e instanceof Date}};e.exports=a.extend({type:"date",coerce:{from:["number","string"],method:(e,{schema:t})=>({value:o.parse(e,t._flags.format)||e})},validate(e,{schema:t,error:i,prefs:n}){if(e instanceof Date&&!isNaN(e.getTime()))return;const a=t._flags.format;return n.convert&&a&&"string"==typeof e?{value:e,errors:i("date.format",{format:a})}:{value:e,errors:i("date.base")}},rules:{compare:{method:!1,validate(e,t,{date:i},{name:n,operator:a,args:r}){const o="now"===i?Date.now():i.getTime();return s.compare(e.getTime(),o,a)?e:t.error("date."+n,{limit:r.date,value:e})},args:[{name:"date",ref:!0,normalize:e=>"now"===e?e:o.parse(e),assert:e=>null!==e,message:"must have a valid date format"}]},format:{method(e){return n(["iso","javascript","unix"].includes(e),"Unknown date format",e),this.$_setFlag("format",e)}},greater:{method(e){return this.$_addRule({name:"greater",method:"compare",args:{date:e},operator:">"})}},iso:{method(){return this.format("iso")}},less:{method(e){return this.$_addRule({name:"less",method:"compare",args:{date:e},operator:"<"})}},max:{method(e){return this.$_addRule({name:"max",method:"compare",args:{date:e},operator:"<="})}},min:{method(e){return this.$_addRule({name:"min",method:"compare",args:{date:e},operator:">="})}},timestamp:{method(e="javascript"){return n(["javascript","unix"].includes(e),'"type" must be one of "javascript, unix"'),this.format(e)}}},cast:{number:{from:o.isDate,to:(e,t)=>e.getTime()},string:{from:o.isDate,to:(e,{prefs:t})=>r.date(e,t)}},messages:{"date.base":"{{#label}} must be a valid date","date.format":'{{#label}} must be in {msg("date.format." + #format) || #format} format',"date.greater":"{{#label}} must be greater than {{:#limit}}","date.less":"{{#label}} must be less than {{:#limit}}","date.max":"{{#label}} must be less than or equal to {{:#limit}}","date.min":"{{#label}} must be greater than or equal to {{:#limit}}","date.format.iso":"ISO 8601 date","date.format.javascript":"timestamp or number of milliseconds","date.format.unix":"timestamp or number of seconds"}}),o.parse=function(e,t){if(e instanceof Date)return e;if("string"!=typeof e&&(isNaN(e)||!isFinite(e)))return null;if(/^\s*$/.test(e))return null;if("iso"===t)return s.isIsoDate(e)?o.date(e.toString()):null;const i=e;if("string"==typeof e&&/^[+-]?\d+(\.\d+)?$/.test(e)&&(e=parseFloat(e)),t){if("javascript"===t)return o.date(1*e);if("unix"===t)return o.date(1e3*e);if("string"==typeof i)return null}return o.date(e)},o.date=function(e){const t=new Date(e);return isNaN(t.getTime())?null:t}},390:(e,t,i)=>{"use strict";const n=i(375),a=i(7824);e.exports=a.extend({type:"function",properties:{typeof:"function"},rules:{arity:{method(e){return n(Number.isSafeInteger(e)&&e>=0,"n must be a positive integer"),this.$_addRule({name:"arity",args:{n:e}})},validate:(e,t,{n:i})=>e.length===i?e:t.error("function.arity",{n:i})},class:{method(){return this.$_addRule("class")},validate:(e,t)=>/^\s*class\s/.test(e.toString())?e:t.error("function.class",{value:e})},minArity:{method(e){return n(Number.isSafeInteger(e)&&e>0,"n must be a strict positive integer"),this.$_addRule({name:"minArity",args:{n:e}})},validate:(e,t,{n:i})=>e.length>=i?e:t.error("function.minArity",{n:i})},maxArity:{method(e){return n(Number.isSafeInteger(e)&&e>=0,"n must be a positive integer"),this.$_addRule({name:"maxArity",args:{n:e}})},validate:(e,t,{n:i})=>e.length<=i?e:t.error("function.maxArity",{n:i})}},messages:{"function.arity":"{{#label}} must have an arity of {{#n}}","function.class":"{{#label}} must be a class","function.maxArity":"{{#label}} must have an arity lesser or equal to {{#n}}","function.minArity":"{{#label}} must have an arity greater or equal to {{#n}}"}})},7824:(e,t,i)=>{"use strict";const n=i(978),a=i(375),s=i(8571),r=i(3652),o=i(8068),l=i(8160),c=i(3292),u=i(6354),m=i(6133),d=i(3328),h={renameDefaults:{alias:!1,multiple:!1,override:!1}};e.exports=o.extend({type:"_keys",properties:{typeof:"object"},flags:{unknown:{default:!1}},terms:{dependencies:{init:null},keys:{init:null,manifest:{mapped:{from:"schema",to:"key"}}},patterns:{init:null},renames:{init:null}},args:(e,t)=>e.keys(t),validate(e,{schema:t,error:i,state:n,prefs:a}){if(!e||typeof e!==t.$_property("typeof")||Array.isArray(e))return{value:e,errors:i("object.base",{type:t.$_property("typeof")})};if(!(t.$_terms.renames||t.$_terms.dependencies||t.$_terms.keys||t.$_terms.patterns||t.$_terms.externals))return;e=h.clone(e,a);const s=[];if(t.$_terms.renames&&!h.rename(t,e,n,a,s))return{value:e,errors:s};if(!t.$_terms.keys&&!t.$_terms.patterns&&!t.$_terms.dependencies)return{value:e,errors:s};const r=new Set(Object.keys(e));if(t.$_terms.keys){const i=[e,...n.ancestors];for(const o of t.$_terms.keys){const t=o.key,l=e[t];r.delete(t);const c=n.localize([...n.path,t],i,o),u=o.schema.$_validate(l,c,a);if(u.errors){if(a.abortEarly)return{value:e,errors:u.errors};void 0!==u.value&&(e[t]=u.value),s.push(...u.errors)}else"strip"===o.schema._flags.result||void 0===u.value&&void 0!==l?delete e[t]:void 0!==u.value&&(e[t]=u.value)}}if(r.size||t._flags._hasPatternMatch){const i=h.unknown(t,e,r,s,n,a);if(i)return i}if(t.$_terms.dependencies)for(const i of t.$_terms.dependencies){if(null!==i.key&&!1===h.isPresent(i.options)(i.key.resolve(e,n,a,null,{shadow:!1})))continue;const r=h.dependencies[i.rel](t,i,e,n,a);if(r){const i=t.$_createError(r.code,e,r.context,n,a);if(a.abortEarly)return{value:e,errors:i};s.push(i)}}return{value:e,errors:s}},rules:{and:{method(...e){return l.verifyFlat(e,"and"),h.dependency(this,"and",null,e)}},append:{method(e){return null==e||0===Object.keys(e).length?this:this.keys(e)}},assert:{method(e,t,i){d.isTemplate(e)||(e=c.ref(e)),a(void 0===i||"string"==typeof i,"Message must be a string"),t=this.$_compile(t,{appendPath:!0});const n=this.$_addRule({name:"assert",args:{subject:e,schema:t,message:i}});return n.$_mutateRegister(e),n.$_mutateRegister(t),n},validate(e,{error:t,prefs:i,state:n},{subject:a,schema:s,message:r}){const o=a.resolve(e,n,i),l=m.isRef(a)?a.absolute(n):[];return s.$_match(o,n.localize(l,[e,...n.ancestors],s),i)?e:t("object.assert",{subject:a,message:r})},args:["subject","schema","message"],multi:!0},instance:{method(e,t){return a("function"==typeof e,"constructor must be a function"),t=t||e.name,this.$_addRule({name:"instance",args:{constructor:e,name:t}})},validate:(e,t,{constructor:i,name:n})=>e instanceof i?e:t.error("object.instance",{type:n,value:e}),args:["constructor","name"]},keys:{method(e){a(void 0===e||"object"==typeof e,"Object schema must be a valid object"),a(!l.isSchema(e),"Object schema cannot be a joi schema");const t=this.clone();if(e)if(Object.keys(e).length){t.$_terms.keys=t.$_terms.keys?t.$_terms.keys.filter((t=>!e.hasOwnProperty(t.key))):new h.Keys;for(const i in e)l.tryWithPath((()=>t.$_terms.keys.push({key:i,schema:this.$_compile(e[i])})),i)}else t.$_terms.keys=new h.Keys;else t.$_terms.keys=null;return t.$_mutateRebuild()}},length:{method(e){return this.$_addRule({name:"length",args:{limit:e},operator:"="})},validate:(e,t,{limit:i},{name:n,operator:a,args:s})=>l.compare(Object.keys(e).length,i,a)?e:t.error("object."+n,{limit:s.limit,value:e}),args:[{name:"limit",ref:!0,assert:l.limit,message:"must be a positive integer"}]},max:{method(e){return this.$_addRule({name:"max",method:"length",args:{limit:e},operator:"<="})}},min:{method(e){return this.$_addRule({name:"min",method:"length",args:{limit:e},operator:">="})}},nand:{method(...e){return l.verifyFlat(e,"nand"),h.dependency(this,"nand",null,e)}},or:{method(...e){return l.verifyFlat(e,"or"),h.dependency(this,"or",null,e)}},oxor:{method(...e){return h.dependency(this,"oxor",null,e)}},pattern:{method(e,t,i={}){const n=e instanceof RegExp;n||(e=this.$_compile(e,{appendPath:!0})),a(void 0!==t,"Invalid rule"),l.assertOptions(i,["fallthrough","matches"]),n&&a(!e.flags.includes("g")&&!e.flags.includes("y"),"pattern should not use global or sticky mode"),t=this.$_compile(t,{appendPath:!0});const s=this.clone();s.$_terms.patterns=s.$_terms.patterns||[];const r={[n?"regex":"schema"]:e,rule:t};return i.matches&&(r.matches=this.$_compile(i.matches),"array"!==r.matches.type&&(r.matches=r.matches.$_root.array().items(r.matches)),s.$_mutateRegister(r.matches),s.$_setFlag("_hasPatternMatch",!0,{clone:!1})),i.fallthrough&&(r.fallthrough=!0),s.$_terms.patterns.push(r),s.$_mutateRegister(t),s}},ref:{method(){return this.$_addRule("ref")},validate:(e,t)=>m.isRef(e)?e:t.error("object.refType",{value:e})},regex:{method(){return this.$_addRule("regex")},validate:(e,t)=>e instanceof RegExp?e:t.error("object.regex",{value:e})},rename:{method(e,t,i={}){a("string"==typeof e||e instanceof RegExp,"Rename missing the from argument"),a("string"==typeof t||t instanceof d,"Invalid rename to argument"),a(t!==e,"Cannot rename key to same name:",e),l.assertOptions(i,["alias","ignoreUndefined","override","multiple"]);const s=this.clone();s.$_terms.renames=s.$_terms.renames||[];for(const t of s.$_terms.renames)a(t.from!==e,"Cannot rename the same key multiple times");return t instanceof d&&s.$_mutateRegister(t),s.$_terms.renames.push({from:e,to:t,options:n(h.renameDefaults,i)}),s}},schema:{method(e="any"){return this.$_addRule({name:"schema",args:{type:e}})},validate:(e,t,{type:i})=>!l.isSchema(e)||"any"!==i&&e.type!==i?t.error("object.schema",{type:i}):e},unknown:{method(e){return this.$_setFlag("unknown",!1!==e)}},with:{method(e,t,i={}){return h.dependency(this,"with",e,t,i)}},without:{method(e,t,i={}){return h.dependency(this,"without",e,t,i)}},xor:{method(...e){return l.verifyFlat(e,"xor"),h.dependency(this,"xor",null,e)}}},overrides:{default(e,t){return void 0===e&&(e=l.symbols.deepDefault),this.$_parent("default",e,t)}},rebuild(e){if(e.$_terms.keys){const t=new r.Sorter;for(const i of e.$_terms.keys)l.tryWithPath((()=>t.add(i,{after:i.schema.$_rootReferences(),group:i.key})),i.key);e.$_terms.keys=new h.Keys(...t.nodes)}},manifest:{build(e,t){if(t.keys&&(e=e.keys(t.keys)),t.dependencies)for(const{rel:i,key:n=null,peers:a,options:s}of t.dependencies)e=h.dependency(e,i,n,a,s);if(t.patterns)for(const{regex:i,schema:n,rule:a,fallthrough:s,matches:r}of t.patterns)e=e.pattern(i||n,a,{fallthrough:s,matches:r});if(t.renames)for(const{from:i,to:n,options:a}of t.renames)e=e.rename(i,n,a);return e}},messages:{"object.and":"{{#label}} contains {{#presentWithLabels}} without its required peers {{#missingWithLabels}}","object.assert":'{{#label}} is invalid because {if(#subject.key, `"` + #subject.key + `" failed to ` + (#message || "pass the assertion test"), #message || "the assertion failed")}',"object.base":"{{#label}} must be of type {{#type}}","object.instance":"{{#label}} must be an instance of {{:#type}}","object.length":'{{#label}} must have {{#limit}} key{if(#limit == 1, "", "s")}',"object.max":'{{#label}} must have less than or equal to {{#limit}} key{if(#limit == 1, "", "s")}',"object.min":'{{#label}} must have at least {{#limit}} key{if(#limit == 1, "", "s")}',"object.missing":"{{#label}} must contain at least one of {{#peersWithLabels}}","object.nand":"{{:#mainWithLabel}} must not exist simultaneously with {{#peersWithLabels}}","object.oxor":"{{#label}} contains a conflict between optional exclusive peers {{#peersWithLabels}}","object.pattern.match":"{{#label}} keys failed to match pattern requirements","object.refType":"{{#label}} must be a Joi reference","object.regex":"{{#label}} must be a RegExp object","object.rename.multiple":"{{#label}} cannot rename {{:#from}} because multiple renames are disabled and another key was already renamed to {{:#to}}","object.rename.override":"{{#label}} cannot rename {{:#from}} because override is disabled and target {{:#to}} exists","object.schema":"{{#label}} must be a Joi schema of {{#type}} type","object.unknown":"{{#label}} is not allowed","object.with":"{{:#mainWithLabel}} missing required peer {{:#peerWithLabel}}","object.without":"{{:#mainWithLabel}} conflict with forbidden peer {{:#peerWithLabel}}","object.xor":"{{#label}} contains a conflict between exclusive peers {{#peersWithLabels}}"}}),h.clone=function(e,t){if("object"==typeof e){if(t.nonEnumerables)return s(e,{shallow:!0});const i=Object.create(Object.getPrototypeOf(e));return Object.assign(i,e),i}const i=function(...t){return e.apply(this,t)};return i.prototype=s(e.prototype),Object.defineProperty(i,"name",{value:e.name,writable:!1}),Object.defineProperty(i,"length",{value:e.length,writable:!1}),Object.assign(i,e),i},h.dependency=function(e,t,i,n,s){a(null===i||"string"==typeof i,t,"key must be a strings"),s||(s=n.length>1&&"object"==typeof n[n.length-1]?n.pop():{}),l.assertOptions(s,["separator","isPresent"]),n=[].concat(n);const r=l.default(s.separator,"."),o=[];for(const e of n)a("string"==typeof e,t,"peers must be strings"),o.push(c.ref(e,{separator:r,ancestor:0,prefix:!1}));null!==i&&(i=c.ref(i,{separator:r,ancestor:0,prefix:!1}));const u=e.clone();return u.$_terms.dependencies=u.$_terms.dependencies||[],u.$_terms.dependencies.push(new h.Dependency(t,i,o,n,s)),u},h.dependencies={and(e,t,i,n,a){const s=[],r=[],o=t.peers.length,l=h.isPresent(t.options);for(const e of t.peers)!1===l(e.resolve(i,n,a,null,{shadow:!1}))?s.push(e.key):r.push(e.key);if(s.length!==o&&r.length!==o)return{code:"object.and",context:{present:r,presentWithLabels:h.keysToLabels(e,r),missing:s,missingWithLabels:h.keysToLabels(e,s)}}},nand(e,t,i,n,a){const s=[],r=h.isPresent(t.options);for(const e of t.peers)r(e.resolve(i,n,a,null,{shadow:!1}))&&s.push(e.key);if(s.length!==t.peers.length)return;const o=t.paths[0],l=t.paths.slice(1);return{code:"object.nand",context:{main:o,mainWithLabel:h.keysToLabels(e,o),peers:l,peersWithLabels:h.keysToLabels(e,l)}}},or(e,t,i,n,a){const s=h.isPresent(t.options);for(const e of t.peers)if(s(e.resolve(i,n,a,null,{shadow:!1})))return;return{code:"object.missing",context:{peers:t.paths,peersWithLabels:h.keysToLabels(e,t.paths)}}},oxor(e,t,i,n,a){const s=[],r=h.isPresent(t.options);for(const e of t.peers)r(e.resolve(i,n,a,null,{shadow:!1}))&&s.push(e.key);if(!s.length||1===s.length)return;const o={peers:t.paths,peersWithLabels:h.keysToLabels(e,t.paths)};return o.present=s,o.presentWithLabels=h.keysToLabels(e,s),{code:"object.oxor",context:o}},with(e,t,i,n,a){const s=h.isPresent(t.options);for(const r of t.peers)if(!1===s(r.resolve(i,n,a,null,{shadow:!1})))return{code:"object.with",context:{main:t.key.key,mainWithLabel:h.keysToLabels(e,t.key.key),peer:r.key,peerWithLabel:h.keysToLabels(e,r.key)}}},without(e,t,i,n,a){const s=h.isPresent(t.options);for(const r of t.peers)if(s(r.resolve(i,n,a,null,{shadow:!1})))return{code:"object.without",context:{main:t.key.key,mainWithLabel:h.keysToLabels(e,t.key.key),peer:r.key,peerWithLabel:h.keysToLabels(e,r.key)}}},xor(e,t,i,n,a){const s=[],r=h.isPresent(t.options);for(const e of t.peers)r(e.resolve(i,n,a,null,{shadow:!1}))&&s.push(e.key);if(1===s.length)return;const o={peers:t.paths,peersWithLabels:h.keysToLabels(e,t.paths)};return 0===s.length?{code:"object.missing",context:o}:(o.present=s,o.presentWithLabels=h.keysToLabels(e,s),{code:"object.xor",context:o})}},h.keysToLabels=function(e,t){return Array.isArray(t)?t.map((t=>e.$_mapLabels(t))):e.$_mapLabels(t)},h.isPresent=function(e){return"function"==typeof e.isPresent?e.isPresent:e=>void 0!==e},h.rename=function(e,t,i,n,a){const s={};for(const r of e.$_terms.renames){const o=[],l="string"!=typeof r.from;if(l)for(const e in t){if(void 0===t[e]&&r.options.ignoreUndefined)continue;if(e===r.to)continue;const i=r.from.exec(e);i&&o.push({from:e,to:r.to,match:i})}else!Object.prototype.hasOwnProperty.call(t,r.from)||void 0===t[r.from]&&r.options.ignoreUndefined||o.push(r);for(const c of o){const o=c.from;let u=c.to;if(u instanceof d&&(u=u.render(t,i,n,c.match)),o!==u){if(!r.options.multiple&&s[u]&&(a.push(e.$_createError("object.rename.multiple",t,{from:o,to:u,pattern:l},i,n)),n.abortEarly))return!1;if(Object.prototype.hasOwnProperty.call(t,u)&&!r.options.override&&!s[u]&&(a.push(e.$_createError("object.rename.override",t,{from:o,to:u,pattern:l},i,n)),n.abortEarly))return!1;void 0===t[o]?delete t[u]:t[u]=t[o],s[u]=!0,r.options.alias||delete t[o]}}}return!0},h.unknown=function(e,t,i,n,a,s){if(e.$_terms.patterns){let r=!1;const o=e.$_terms.patterns.map((e=>{if(e.matches)return r=!0,[]})),l=[t,...a.ancestors];for(const r of i){const c=t[r],u=[...a.path,r];for(let m=0;m<e.$_terms.patterns.length;++m){const d=e.$_terms.patterns[m];if(d.regex){const e=d.regex.test(r);if(a.mainstay.tracer.debug(a,"rule",`pattern.${m}`,e?"pass":"error"),!e)continue}else if(!d.schema.$_match(r,a.nest(d.schema,`pattern.${m}`),s))continue;i.delete(r);const h=a.localize(u,l,{schema:d.rule,key:r}),f=d.rule.$_validate(c,h,s);if(f.errors){if(s.abortEarly)return{value:t,errors:f.errors};n.push(...f.errors)}if(d.matches&&o[m].push(r),t[r]=f.value,!d.fallthrough)break}}if(r)for(let i=0;i<o.length;++i){const r=o[i];if(!r)continue;const c=e.$_terms.patterns[i].matches,m=a.localize(a.path,l,c),d=c.$_validate(r,m,s);if(d.errors){const i=u.details(d.errors,{override:!1});i.matches=r;const o=e.$_createError("object.pattern.match",t,i,a,s);if(s.abortEarly)return{value:t,errors:o};n.push(o)}}}if(i.size&&(e.$_terms.keys||e.$_terms.patterns)){if(s.stripUnknown&&!e._flags.unknown||s.skipFunctions){const e=!(!s.stripUnknown||!0!==s.stripUnknown&&!s.stripUnknown.objects);for(const n of i)e?(delete t[n],i.delete(n)):"function"==typeof t[n]&&i.delete(n)}if(!l.default(e._flags.unknown,s.allowUnknown))for(const r of i){const i=a.localize([...a.path,r],[]),o=e.$_createError("object.unknown",t[r],{child:r},i,s,{flags:!1});if(s.abortEarly)return{value:t,errors:o};n.push(o)}}},h.Dependency=class{constructor(e,t,i,n,a){this.rel=e,this.key=t,this.peers=i,this.paths=n,this.options=a}describe(){const e={rel:this.rel,peers:this.paths};return null!==this.key&&(e.key=this.key.key),"."!==this.peers[0].separator&&(e.options={...e.options,separator:this.peers[0].separator}),this.options.isPresent&&(e.options={...e.options,isPresent:this.options.isPresent}),e}},h.Keys=class extends Array{concat(e){const t=this.slice(),i=new Map;for(let e=0;e<t.length;++e)i.set(t[e].key,e);for(const n of e){const e=n.key,a=i.get(e);void 0!==a?t[a]={key:e,schema:t[a].schema.concat(n.schema)}:t.push(n)}return t}}},8785:(e,t,i)=>{"use strict";const n=i(375),a=i(8068),s=i(8160),r=i(3292),o=i(6354),l={};e.exports=a.extend({type:"link",properties:{schemaChain:!0},terms:{link:{init:null,manifest:"single",register:!1}},args:(e,t)=>e.ref(t),validate(e,{schema:t,state:i,prefs:a}){n(t.$_terms.link,"Uninitialized link schema");const s=l.generate(t,e,i,a),r=t.$_terms.link[0].ref;return s.$_validate(e,i.nest(s,`link:${r.display}:${s.type}`),a)},generate:(e,t,i,n)=>l.generate(e,t,i,n),rules:{ref:{method(e){n(!this.$_terms.link,"Cannot reinitialize schema"),e=r.ref(e),n("value"===e.type||"local"===e.type,"Invalid reference type:",e.type),n("local"===e.type||"root"===e.ancestor||e.ancestor>0,"Link cannot reference itself");const t=this.clone();return t.$_terms.link=[{ref:e}],t}},relative:{method(e=!0){return this.$_setFlag("relative",e)}}},overrides:{concat(e){n(this.$_terms.link,"Uninitialized link schema"),n(s.isSchema(e),"Invalid schema object"),n("link"!==e.type,"Cannot merge type link with another link");const t=this.clone();return t.$_terms.whens||(t.$_terms.whens=[]),t.$_terms.whens.push({concat:e}),t.$_mutateRebuild()}},manifest:{build:(e,t)=>(n(t.link,"Invalid link description missing link"),e.ref(t.link))}}),l.generate=function(e,t,i,n){let a=i.mainstay.links.get(e);if(a)return a._generate(t,i,n).schema;const s=e.$_terms.link[0].ref,{perspective:r,path:o}=l.perspective(s,i);l.assert(r,"which is outside of schema boundaries",s,e,i,n);try{a=o.length?r.$_reach(o):r}catch(t){l.assert(!1,"to non-existing schema",s,e,i,n)}return l.assert("link"!==a.type,"which is another link",s,e,i,n),e._flags.relative||i.mainstay.links.set(e,a),a._generate(t,i,n).schema},l.perspective=function(e,t){if("local"===e.type){for(const{schema:i,key:n}of t.schemas){if((i._flags.id||n)===e.path[0])return{perspective:i,path:e.path.slice(1)};if(i.$_terms.shared)for(const t of i.$_terms.shared)if(t._flags.id===e.path[0])return{perspective:t,path:e.path.slice(1)}}return{perspective:null,path:null}}return"root"===e.ancestor?{perspective:t.schemas[t.schemas.length-1].schema,path:e.path}:{perspective:t.schemas[e.ancestor]&&t.schemas[e.ancestor].schema,path:e.path}},l.assert=function(e,t,i,a,s,r){e||n(!1,`"${o.label(a._flags,s,r)}" contains link reference "${i.display}" ${t}`)}},3832:(e,t,i)=>{"use strict";const n=i(375),a=i(8068),s=i(8160),r={numberRx:/^\s*[+-]?(?:(?:\d+(?:\.\d*)?)|(?:\.\d+))(?:e([+-]?\d+))?\s*$/i,precisionRx:/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/,exponentialPartRegex:/[eE][+-]?\d+$/,leadingSignAndZerosRegex:/^[+-]?(0*)?/,dotRegex:/\./,trailingZerosRegex:/0+$/,decimalPlaces(e){const t=e.toString(),i=t.indexOf("."),n=t.indexOf("e");return(i<0?0:(n<0?t.length:n)-i-1)+(n<0?0:Math.max(0,-parseInt(t.slice(n+1))))}};e.exports=a.extend({type:"number",flags:{unsafe:{default:!1}},coerce:{from:"string",method(e,{schema:t,error:i}){if(!e.match(r.numberRx))return;e=e.trim();const n={value:parseFloat(e)};if(0===n.value&&(n.value=0),!t._flags.unsafe)if(e.match(/e/i)){if(r.extractSignificantDigits(e)!==r.extractSignificantDigits(String(n.value)))return n.errors=i("number.unsafe"),n}else{const t=n.value.toString();if(t.match(/e/i))return n;if(t!==r.normalizeDecimal(e))return n.errors=i("number.unsafe"),n}return n}},validate(e,{schema:t,error:i,prefs:n}){if(e===1/0||e===-1/0)return{value:e,errors:i("number.infinity")};if(!s.isNumber(e))return{value:e,errors:i("number.base")};const a={value:e};if(n.convert){const e=t.$_getRule("precision");if(e){const t=Math.pow(10,e.args.limit);a.value=Math.round(a.value*t)/t}}return 0===a.value&&(a.value=0),!t._flags.unsafe&&(e>Number.MAX_SAFE_INTEGER||e<Number.MIN_SAFE_INTEGER)&&(a.errors=i("number.unsafe")),a},rules:{compare:{method:!1,validate:(e,t,{limit:i},{name:n,operator:a,args:r})=>s.compare(e,i,a)?e:t.error("number."+n,{limit:r.limit,value:e}),args:[{name:"limit",ref:!0,assert:s.isNumber,message:"must be a number"}]},greater:{method(e){return this.$_addRule({name:"greater",method:"compare",args:{limit:e},operator:">"})}},integer:{method(){return this.$_addRule("integer")},validate:(e,t)=>Math.trunc(e)-e==0?e:t.error("number.integer")},less:{method(e){return this.$_addRule({name:"less",method:"compare",args:{limit:e},operator:"<"})}},max:{method(e){return this.$_addRule({name:"max",method:"compare",args:{limit:e},operator:"<="})}},min:{method(e){return this.$_addRule({name:"min",method:"compare",args:{limit:e},operator:">="})}},multiple:{method(e){const t="number"==typeof e?r.decimalPlaces(e):null,i=Math.pow(10,t);return this.$_addRule({name:"multiple",args:{base:e,baseDecimalPlace:t,pfactor:i}})},validate:(e,t,{base:i,baseDecimalPlace:n,pfactor:a},s)=>r.decimalPlaces(e)>n?t.error("number.multiple",{multiple:s.args.base,value:e}):Math.round(a*e)%Math.round(a*i)==0?e:t.error("number.multiple",{multiple:s.args.base,value:e}),args:[{name:"base",ref:!0,assert:e=>"number"==typeof e&&isFinite(e)&&e>0,message:"must be a positive number"},"baseDecimalPlace","pfactor"],multi:!0},negative:{method(){return this.sign("negative")}},port:{method(){return this.$_addRule("port")},validate:(e,t)=>Number.isSafeInteger(e)&&e>=0&&e<=65535?e:t.error("number.port")},positive:{method(){return this.sign("positive")}},precision:{method(e){return n(Number.isSafeInteger(e),"limit must be an integer"),this.$_addRule({name:"precision",args:{limit:e}})},validate(e,t,{limit:i}){const n=e.toString().match(r.precisionRx);return Math.max((n[1]?n[1].length:0)-(n[2]?parseInt(n[2],10):0),0)<=i?e:t.error("number.precision",{limit:i,value:e})},convert:!0},sign:{method(e){return n(["negative","positive"].includes(e),"Invalid sign",e),this.$_addRule({name:"sign",args:{sign:e}})},validate:(e,t,{sign:i})=>"negative"===i&&e<0||"positive"===i&&e>0?e:t.error(`number.${i}`)},unsafe:{method(e=!0){return n("boolean"==typeof e,"enabled must be a boolean"),this.$_setFlag("unsafe",e)}}},cast:{string:{from:e=>"number"==typeof e,to:(e,t)=>e.toString()}},messages:{"number.base":"{{#label}} must be a number","number.greater":"{{#label}} must be greater than {{#limit}}","number.infinity":"{{#label}} cannot be infinity","number.integer":"{{#label}} must be an integer","number.less":"{{#label}} must be less than {{#limit}}","number.max":"{{#label}} must be less than or equal to {{#limit}}","number.min":"{{#label}} must be greater than or equal to {{#limit}}","number.multiple":"{{#label}} must be a multiple of {{#multiple}}","number.negative":"{{#label}} must be a negative number","number.port":"{{#label}} must be a valid port","number.positive":"{{#label}} must be a positive number","number.precision":"{{#label}} must have no more than {{#limit}} decimal places","number.unsafe":"{{#label}} must be a safe number"}}),r.extractSignificantDigits=function(e){return e.replace(r.exponentialPartRegex,"").replace(r.dotRegex,"").replace(r.trailingZerosRegex,"").replace(r.leadingSignAndZerosRegex,"")},r.normalizeDecimal=function(e){return(e=e.replace(/^\+/,"").replace(/\.0*$/,"").replace(/^(-?)\.([^\.]*)$/,"$10.$2").replace(/^(-?)0+([0-9])/,"$1$2")).includes(".")&&e.endsWith("0")&&(e=e.replace(/0+$/,"")),"-0"===e?"0":e}},8966:(e,t,i)=>{"use strict";const n=i(7824);e.exports=n.extend({type:"object",cast:{map:{from:e=>e&&"object"==typeof e,to:(e,t)=>new Map(Object.entries(e))}}})},7417:(e,t,i)=>{"use strict";const n=i(375),a=i(5380),s=i(1745),r=i(9959),o=i(6064),l=i(9926),c=i(5752),u=i(8068),m=i(8160),d={tlds:l instanceof Set&&{tlds:{allow:l,deny:null}},base64Regex:{true:{true:/^(?:[\w\-]{2}[\w\-]{2})*(?:[\w\-]{2}==|[\w\-]{3}=)?$/,false:/^(?:[A-Za-z0-9+\/]{2}[A-Za-z0-9+\/]{2})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/},false:{true:/^(?:[\w\-]{2}[\w\-]{2})*(?:[\w\-]{2}(==)?|[\w\-]{3}=?)?$/,false:/^(?:[A-Za-z0-9+\/]{2}[A-Za-z0-9+\/]{2})*(?:[A-Za-z0-9+\/]{2}(==)?|[A-Za-z0-9+\/]{3}=?)?$/}},dataUriRegex:/^data:[\w+.-]+\/[\w+.-]+;((charset=[\w-]+|base64),)?(.*)$/,hexRegex:{withPrefix:/^0x[0-9a-f]+$/i,withOptionalPrefix:/^(?:0x)?[0-9a-f]+$/i,withoutPrefix:/^[0-9a-f]+$/i},ipRegex:r.regex({cidr:"forbidden"}).regex,isoDurationRegex:/^P(?!$)(\d+Y)?(\d+M)?(\d+W)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+S)?)?$/,guidBrackets:{"{":"}","[":"]","(":")","":""},guidVersions:{uuidv1:"1",uuidv2:"2",uuidv3:"3",uuidv4:"4",uuidv5:"5",uuidv6:"6",uuidv7:"7",uuidv8:"8"},guidSeparators:new Set([void 0,!0,!1,"-",":"]),normalizationForms:["NFC","NFD","NFKC","NFKD"]};e.exports=u.extend({type:"string",flags:{insensitive:{default:!1},truncate:{default:!1}},terms:{replacements:{init:null}},coerce:{from:"string",method(e,{schema:t,state:i,prefs:n}){const a=t.$_getRule("normalize");a&&(e=e.normalize(a.args.form));const s=t.$_getRule("case");s&&(e="upper"===s.args.direction?e.toLocaleUpperCase():e.toLocaleLowerCase());const r=t.$_getRule("trim");if(r&&r.args.enabled&&(e=e.trim()),t.$_terms.replacements)for(const i of t.$_terms.replacements)e=e.replace(i.pattern,i.replacement);const o=t.$_getRule("hex");if(o&&o.args.options.byteAligned&&e.length%2!=0&&(e=`0${e}`),t.$_getRule("isoDate")){const t=d.isoDate(e);t&&(e=t)}if(t._flags.truncate){const a=t.$_getRule("max");if(a){let s=a.args.limit;if(m.isResolvable(s)&&(s=s.resolve(e,i,n),!m.limit(s)))return{value:e,errors:t.$_createError("any.ref",s,{ref:a.args.limit,arg:"limit",reason:"must be a positive integer"},i,n)};e=e.slice(0,s)}}return{value:e}}},validate(e,{schema:t,error:i}){if("string"!=typeof e)return{value:e,errors:i("string.base")};if(""===e){const n=t.$_getRule("min");if(n&&0===n.args.limit)return;return{value:e,errors:i("string.empty")}}},rules:{alphanum:{method(){return this.$_addRule("alphanum")},validate:(e,t)=>/^[a-zA-Z0-9]+$/.test(e)?e:t.error("string.alphanum")},base64:{method(e={}){return m.assertOptions(e,["paddingRequired","urlSafe"]),e={urlSafe:!1,paddingRequired:!0,...e},n("boolean"==typeof e.paddingRequired,"paddingRequired must be boolean"),n("boolean"==typeof e.urlSafe,"urlSafe must be boolean"),this.$_addRule({name:"base64",args:{options:e}})},validate:(e,t,{options:i})=>d.base64Regex[i.paddingRequired][i.urlSafe].test(e)?e:t.error("string.base64")},case:{method(e){return n(["lower","upper"].includes(e),"Invalid case:",e),this.$_addRule({name:"case",args:{direction:e}})},validate:(e,t,{direction:i})=>"lower"===i&&e===e.toLocaleLowerCase()||"upper"===i&&e===e.toLocaleUpperCase()?e:t.error(`string.${i}case`),convert:!0},creditCard:{method(){return this.$_addRule("creditCard")},validate(e,t){let i=e.length,n=0,a=1;for(;i--;){const t=e.charAt(i)*a;n+=t-9*(t>9),a^=3}return n>0&&n%10==0?e:t.error("string.creditCard")}},dataUri:{method(e={}){return m.assertOptions(e,["paddingRequired"]),e={paddingRequired:!0,...e},n("boolean"==typeof e.paddingRequired,"paddingRequired must be boolean"),this.$_addRule({name:"dataUri",args:{options:e}})},validate(e,t,{options:i}){const n=e.match(d.dataUriRegex);if(n){if(!n[2])return e;if("base64"!==n[2])return e;if(d.base64Regex[i.paddingRequired].false.test(n[3]))return e}return t.error("string.dataUri")}},domain:{method(e){e&&m.assertOptions(e,["allowFullyQualified","allowUnicode","maxDomainSegments","minDomainSegments","tlds"]);const t=d.addressOptions(e);return this.$_addRule({name:"domain",args:{options:e},address:t})},validate:(e,t,i,{address:n})=>a.isValid(e,n)?e:t.error("string.domain")},email:{method(e={}){m.assertOptions(e,["allowFullyQualified","allowUnicode","ignoreLength","maxDomainSegments","minDomainSegments","multiple","separator","tlds"]),n(void 0===e.multiple||"boolean"==typeof e.multiple,"multiple option must be an boolean");const t=d.addressOptions(e),i=new RegExp(`\\s*[${e.separator?o(e.separator):","}]\\s*`);return this.$_addRule({name:"email",args:{options:e},regex:i,address:t})},validate(e,t,{options:i},{regex:n,address:a}){const r=i.multiple?e.split(n):[e],o=[];for(const e of r)s.isValid(e,a)||o.push(e);return o.length?t.error("string.email",{value:e,invalids:o}):e}},guid:{alias:"uuid",method(e={}){m.assertOptions(e,["version","separator"]);let t="";if(e.version){const i=[].concat(e.version);n(i.length>=1,"version must have at least 1 valid version specified");const a=new Set;for(let e=0;e<i.length;++e){const s=i[e];n("string"==typeof s,"version at position "+e+" must be a string");const r=d.guidVersions[s.toLowerCase()];n(r,"version at position "+e+" must be one of "+Object.keys(d.guidVersions).join(", ")),n(!a.has(r),"version at position "+e+" must not be a duplicate"),t+=r,a.add(r)}}n(d.guidSeparators.has(e.separator),'separator must be one of true, false, "-", or ":"');const i=void 0===e.separator?"[:-]?":!0===e.separator?"[:-]":!1===e.separator?"[]?":`\\${e.separator}`,a=new RegExp(`^([\\[{\\(]?)[0-9A-F]{8}(${i})[0-9A-F]{4}\\2?[${t||"0-9A-F"}][0-9A-F]{3}\\2?[${t?"89AB":"0-9A-F"}][0-9A-F]{3}\\2?[0-9A-F]{12}([\\]}\\)]?)$`,"i");return this.$_addRule({name:"guid",args:{options:e},regex:a})},validate(e,t,i,{regex:n}){const a=n.exec(e);return a?d.guidBrackets[a[1]]!==a[a.length-1]?t.error("string.guid"):e:t.error("string.guid")}},hex:{method(e={}){return m.assertOptions(e,["byteAligned","prefix"]),e={byteAligned:!1,prefix:!1,...e},n("boolean"==typeof e.byteAligned,"byteAligned must be boolean"),n("boolean"==typeof e.prefix||"optional"===e.prefix,'prefix must be boolean or "optional"'),this.$_addRule({name:"hex",args:{options:e}})},validate:(e,t,{options:i})=>("optional"===i.prefix?d.hexRegex.withOptionalPrefix:!0===i.prefix?d.hexRegex.withPrefix:d.hexRegex.withoutPrefix).test(e)?i.byteAligned&&e.length%2!=0?t.error("string.hexAlign"):e:t.error("string.hex")},hostname:{method(){return this.$_addRule("hostname")},validate:(e,t)=>a.isValid(e,{minDomainSegments:1})||d.ipRegex.test(e)?e:t.error("string.hostname")},insensitive:{method(){return this.$_setFlag("insensitive",!0)}},ip:{method(e={}){m.assertOptions(e,["cidr","version"]);const{cidr:t,versions:i,regex:n}=r.regex(e),a=e.version?i:void 0;return this.$_addRule({name:"ip",args:{options:{cidr:t,version:a}},regex:n})},validate:(e,t,{options:i},{regex:n})=>n.test(e)?e:i.version?t.error("string.ipVersion",{value:e,cidr:i.cidr,version:i.version}):t.error("string.ip",{value:e,cidr:i.cidr})},isoDate:{method(){return this.$_addRule("isoDate")},validate:(e,{error:t})=>d.isoDate(e)?e:t("string.isoDate")},isoDuration:{method(){return this.$_addRule("isoDuration")},validate:(e,t)=>d.isoDurationRegex.test(e)?e:t.error("string.isoDuration")},length:{method(e,t){return d.length(this,"length",e,"=",t)},validate(e,t,{limit:i,encoding:n},{name:a,operator:s,args:r}){const o=!n&&e.length;return m.compare(o,i,s)?e:t.error("string."+a,{limit:r.limit,value:e,encoding:n})},args:[{name:"limit",ref:!0,assert:m.limit,message:"must be a positive integer"},"encoding"]},lowercase:{method(){return this.case("lower")}},max:{method(e,t){return d.length(this,"max",e,"<=",t)},args:["limit","encoding"]},min:{method(e,t){return d.length(this,"min",e,">=",t)},args:["limit","encoding"]},normalize:{method(e="NFC"){return n(d.normalizationForms.includes(e),"normalization form must be one of "+d.normalizationForms.join(", ")),this.$_addRule({name:"normalize",args:{form:e}})},validate:(e,{error:t},{form:i})=>e===e.normalize(i)?e:t("string.normalize",{value:e,form:i}),convert:!0},pattern:{alias:"regex",method(e,t={}){n(e instanceof RegExp,"regex must be a RegExp"),n(!e.flags.includes("g")&&!e.flags.includes("y"),"regex should not use global or sticky mode"),"string"==typeof t&&(t={name:t}),m.assertOptions(t,["invert","name"]);const i=["string.pattern",t.invert?".invert":"",t.name?".name":".base"].join("");return this.$_addRule({name:"pattern",args:{regex:e,options:t},errorCode:i})},validate:(e,t,{regex:i,options:n},{errorCode:a})=>i.test(e)^n.invert?e:t.error(a,{name:n.name,regex:i,value:e}),args:["regex","options"],multi:!0},replace:{method(e,t){"string"==typeof e&&(e=new RegExp(o(e),"g")),n(e instanceof RegExp,"pattern must be a RegExp"),n("string"==typeof t,"replacement must be a String");const i=this.clone();return i.$_terms.replacements||(i.$_terms.replacements=[]),i.$_terms.replacements.push({pattern:e,replacement:t}),i}},token:{method(){return this.$_addRule("token")},validate:(e,t)=>/^\w+$/.test(e)?e:t.error("string.token")},trim:{method(e=!0){return n("boolean"==typeof e,"enabled must be a boolean"),this.$_addRule({name:"trim",args:{enabled:e}})},validate:(e,t,{enabled:i})=>i&&e!==e.trim()?t.error("string.trim"):e,convert:!0},truncate:{method(e=!0){return n("boolean"==typeof e,"enabled must be a boolean"),this.$_setFlag("truncate",e)}},uppercase:{method(){return this.case("upper")}},uri:{method(e={}){m.assertOptions(e,["allowRelative","allowQuerySquareBrackets","domain","relativeOnly","scheme"]),e.domain&&m.assertOptions(e.domain,["allowFullyQualified","allowUnicode","maxDomainSegments","minDomainSegments","tlds"]);const{regex:t,scheme:i}=c.regex(e),n=e.domain?d.addressOptions(e.domain):null;return this.$_addRule({name:"uri",args:{options:e},regex:t,domain:n,scheme:i})},validate(e,t,{options:i},{regex:n,domain:s,scheme:r}){if(["http:/","https:/"].includes(e))return t.error("string.uri");const o=n.exec(e);if(o){const n=o[1]||o[2];return!s||i.allowRelative&&!n||a.isValid(n,s)?e:t.error("string.domain",{value:n})}return i.relativeOnly?t.error("string.uriRelativeOnly"):i.scheme?t.error("string.uriCustomScheme",{scheme:r,value:e}):t.error("string.uri")}}},manifest:{build(e,t){if(t.replacements)for(const{pattern:i,replacement:n}of t.replacements)e=e.replace(i,n);return e}},messages:{"string.alphanum":"{{#label}} must only contain alpha-numeric characters","string.base":"{{#label}} must be a string","string.base64":"{{#label}} must be a valid base64 string","string.creditCard":"{{#label}} must be a credit card","string.dataUri":"{{#label}} must be a valid dataUri string","string.domain":"{{#label}} must contain a valid domain name","string.email":"{{#label}} must be a valid email","string.empty":"{{#label}} is not allowed to be empty","string.guid":"{{#label}} must be a valid GUID","string.hex":"{{#label}} must only contain hexadecimal characters","string.hexAlign":"{{#label}} hex decoded representation must be byte aligned","string.hostname":"{{#label}} must be a valid hostname","string.ip":"{{#label}} must be a valid ip address with a {{#cidr}} CIDR","string.ipVersion":"{{#label}} must be a valid ip address of one of the following versions {{#version}} with a {{#cidr}} CIDR","string.isoDate":"{{#label}} must be in iso format","string.isoDuration":"{{#label}} must be a valid ISO 8601 duration","string.length":"{{#label}} length must be {{#limit}} characters long","string.lowercase":"{{#label}} must only contain lowercase characters","string.max":"{{#label}} length must be less than or equal to {{#limit}} characters long","string.min":"{{#label}} length must be at least {{#limit}} characters long","string.normalize":"{{#label}} must be unicode normalized in the {{#form}} form","string.token":"{{#label}} must only contain alpha-numeric and underscore characters","string.pattern.base":"{{#label}} with value {:[.]} fails to match the required pattern: {{#regex}}","string.pattern.name":"{{#label}} with value {:[.]} fails to match the {{#name}} pattern","string.pattern.invert.base":"{{#label}} with value {:[.]} matches the inverted pattern: {{#regex}}","string.pattern.invert.name":"{{#label}} with value {:[.]} matches the inverted {{#name}} pattern","string.trim":"{{#label}} must not have leading or trailing whitespace","string.uri":"{{#label}} must be a valid uri","string.uriCustomScheme":"{{#label}} must be a valid uri with a scheme matching the {{#scheme}} pattern","string.uriRelativeOnly":"{{#label}} must be a valid relative uri","string.uppercase":"{{#label}} must only contain uppercase characters"}}),d.addressOptions=function(e){if(!e)return e;if(n(void 0===e.minDomainSegments||Number.isSafeInteger(e.minDomainSegments)&&e.minDomainSegments>0,"minDomainSegments must be a positive integer"),n(void 0===e.maxDomainSegments||Number.isSafeInteger(e.maxDomainSegments)&&e.maxDomainSegments>0,"maxDomainSegments must be a positive integer"),!1===e.tlds)return e;if(!0===e.tlds||void 0===e.tlds)return n(d.tlds,"Built-in TLD list disabled"),Object.assign({},e,d.tlds);n("object"==typeof e.tlds,"tlds must be true, false, or an object");const t=e.tlds.deny;if(t)return Array.isArray(t)&&(e=Object.assign({},e,{tlds:{deny:new Set(t)}})),n(e.tlds.deny instanceof Set,"tlds.deny must be an array, Set, or boolean"),n(!e.tlds.allow,"Cannot specify both tlds.allow and tlds.deny lists"),d.validateTlds(e.tlds.deny,"tlds.deny"),e;const i=e.tlds.allow;return i?!0===i?(n(d.tlds,"Built-in TLD list disabled"),Object.assign({},e,d.tlds)):(Array.isArray(i)&&(e=Object.assign({},e,{tlds:{allow:new Set(i)}})),n(e.tlds.allow instanceof Set,"tlds.allow must be an array, Set, or boolean"),d.validateTlds(e.tlds.allow,"tlds.allow"),e):e},d.validateTlds=function(e,t){for(const i of e)n(a.isValid(i,{minDomainSegments:1,maxDomainSegments:1}),`${t} must contain valid top level domain names`)},d.isoDate=function(e){if(!m.isIsoDate(e))return null;/.*T.*[+-]\d\d$/.test(e)&&(e+="00");const t=new Date(e);return isNaN(t.getTime())?null:t.toISOString()},d.length=function(e,t,i,a,s){return n(!s||!1,"Invalid encoding:",s),e.$_addRule({name:t,method:"length",args:{limit:i,encoding:s},operator:a})}},8826:(e,t,i)=>{"use strict";const n=i(375),a=i(8068),s={};s.Map=class extends Map{slice(){return new s.Map(this)}},e.exports=a.extend({type:"symbol",terms:{map:{init:new s.Map}},coerce:{method(e,{schema:t,error:i}){const n=t.$_terms.map.get(e);return n&&(e=n),t._flags.only&&"symbol"!=typeof e?{value:e,errors:i("symbol.map",{map:t.$_terms.map})}:{value:e}}},validate(e,{error:t}){if("symbol"!=typeof e)return{value:e,errors:t("symbol.base")}},rules:{map:{method(e){e&&!e[Symbol.iterator]&&"object"==typeof e&&(e=Object.entries(e)),n(e&&e[Symbol.iterator],"Iterable must be an iterable or object");const t=this.clone(),i=[];for(const a of e){n(a&&a[Symbol.iterator],"Entry must be an iterable");const[e,s]=a;n("object"!=typeof e&&"function"!=typeof e&&"symbol"!=typeof e,"Key must not be of type object, function, or Symbol"),n("symbol"==typeof s,"Value must be a Symbol"),t.$_terms.map.set(e,s),i.push(s)}return t.valid(...i)}}},manifest:{build:(e,t)=>(t.map&&(e=e.map(t.map)),e)},messages:{"symbol.base":"{{#label}} must be a symbol","symbol.map":"{{#label}} must be one of {{#map}}"}})},8863:(e,t,i)=>{"use strict";const n=i(375),a=i(8571),s=i(738),r=i(9621),o=i(8160),l=i(6354),c=i(493),u={result:Symbol("result")};t.entry=function(e,t,i){let a=o.defaults;i&&(n(void 0===i.warnings,"Cannot override warnings preference in synchronous validation"),n(void 0===i.artifacts,"Cannot override artifacts preference in synchronous validation"),a=o.preferences(o.defaults,i));const s=u.entry(e,t,a);n(!s.mainstay.externals.length,"Schema with external rules must use validateAsync()");const r={value:s.value};return s.error&&(r.error=s.error),s.mainstay.warnings.length&&(r.warning=l.details(s.mainstay.warnings)),s.mainstay.debug&&(r.debug=s.mainstay.debug),s.mainstay.artifacts&&(r.artifacts=s.mainstay.artifacts),r},t.entryAsync=async function(e,t,i){let n=o.defaults;i&&(n=o.preferences(o.defaults,i));const a=u.entry(e,t,n),s=a.mainstay;if(a.error)throw s.debug&&(a.error.debug=s.debug),a.error;if(s.externals.length){let t=a.value;const c=[];for(const a of s.externals){const m=a.state.path,d="link"===a.schema.type?s.links.get(a.schema):null;let h,f,p=t;const g=m.length?[t]:[],y=m.length?r(e,m):e;if(m.length){h=m[m.length-1];let e=t;for(const t of m.slice(0,-1))e=e[t],g.unshift(e);f=g[0],p=f[h]}try{const e=(e,t)=>(d||a.schema).$_createError(e,p,t,a.state,n),r=await a.method(p,{schema:a.schema,linked:d,state:a.state,prefs:i,original:y,error:e,errorsArray:u.errorsArray,warn:(e,t)=>s.warnings.push((d||a.schema).$_createError(e,p,t,a.state,n)),message:(e,t)=>(d||a.schema).$_createError("external",p,t,a.state,n,{messages:e})});if(void 0===r||r===p)continue;if(r instanceof l.Report){if(s.tracer.log(a.schema,a.state,"rule","external","error"),c.push(r),n.abortEarly)break;continue}if(Array.isArray(r)&&r[o.symbols.errors]){if(s.tracer.log(a.schema,a.state,"rule","external","error"),c.push(...r),n.abortEarly)break;continue}f?(s.tracer.value(a.state,"rule",p,r,"external"),f[h]=r):(s.tracer.value(a.state,"rule",t,r,"external"),t=r)}catch(e){throw n.errors.label&&(e.message+=` (${a.label})`),e}}if(a.value=t,c.length)throw a.error=l.process(c,e,n),s.debug&&(a.error.debug=s.debug),a.error}if(!n.warnings&&!n.debug&&!n.artifacts)return a.value;const c={value:a.value};return s.warnings.length&&(c.warning=l.details(s.warnings)),s.debug&&(c.debug=s.debug),s.artifacts&&(c.artifacts=s.artifacts),c},u.Mainstay=class{constructor(e,t,i){this.externals=[],this.warnings=[],this.tracer=e,this.debug=t,this.links=i,this.shadow=null,this.artifacts=null,this._snapshots=[]}snapshot(){this._snapshots.push({externals:this.externals.slice(),warnings:this.warnings.slice()})}restore(){const e=this._snapshots.pop();this.externals=e.externals,this.warnings=e.warnings}commit(){this._snapshots.pop()}},u.entry=function(e,i,n){const{tracer:a,cleanup:s}=u.tracer(i,n),r=n.debug?[]:null,o=i._ids._schemaChain?new Map:null,m=new u.Mainstay(a,r,o),d=i._ids._schemaChain?[{schema:i}]:null,h=new c([],[],{mainstay:m,schemas:d}),f=t.validate(e,i,h,n);s&&i.$_root.untrace();const p=l.process(f.errors,e,n);return{value:f.value,error:p,mainstay:m}},u.tracer=function(e,t){return e.$_root._tracer?{tracer:e.$_root._tracer._register(e)}:t.debug?(n(e.$_root.trace,"Debug mode not supported"),{tracer:e.$_root.trace()._register(e),cleanup:!0}):{tracer:u.ignore}},t.validate=function(e,t,i,n,a={}){if(t.$_terms.whens&&(t=t._generate(e,i,n).schema),t._preferences&&(n=u.prefs(t,n)),t._cache&&n.cache){const n=t._cache.get(e);if(i.mainstay.tracer.debug(i,"validate","cached",!!n),n)return n}const s=(a,s,r)=>t.$_createError(a,e,s,r||i,n),r={original:e,prefs:n,schema:t,state:i,error:s,errorsArray:u.errorsArray,warn:(e,t,n)=>i.mainstay.warnings.push(s(e,t,n)),message:(a,s)=>t.$_createError("custom",e,s,i,n,{messages:a})};i.mainstay.tracer.entry(t,i);const l=t._definition;if(l.prepare&&void 0!==e&&n.convert){const t=l.prepare(e,r);if(t){if(i.mainstay.tracer.value(i,"prepare",e,t.value),t.errors)return u.finalize(t.value,[].concat(t.errors),r);e=t.value}}if(l.coerce&&void 0!==e&&n.convert&&(!l.coerce.from||l.coerce.from.includes(typeof e))){const t=l.coerce.method(e,r);if(t){if(i.mainstay.tracer.value(i,"coerced",e,t.value),t.errors)return u.finalize(t.value,[].concat(t.errors),r);e=t.value}}const c=t._flags.empty;c&&c.$_match(u.trim(e,t),i.nest(c),o.defaults)&&(i.mainstay.tracer.value(i,"empty",e,void 0),e=void 0);const m=a.presence||t._flags.presence||(t._flags._endedSwitch?null:n.presence);if(void 0===e){if("forbidden"===m)return u.finalize(e,null,r);if("required"===m)return u.finalize(e,[t.$_createError("any.required",e,null,i,n)],r);if("optional"===m){if(t._flags.default!==o.symbols.deepDefault)return u.finalize(e,null,r);i.mainstay.tracer.value(i,"default",e,{}),e={}}}else if("forbidden"===m)return u.finalize(e,[t.$_createError("any.unknown",e,null,i,n)],r);const d=[];if(t._valids){const a=t._valids.get(e,i,n,t._flags.insensitive);if(a)return n.convert&&(i.mainstay.tracer.value(i,"valids",e,a.value),e=a.value),i.mainstay.tracer.filter(t,i,"valid",a),u.finalize(e,null,r);if(t._flags.only){const a=t.$_createError("any.only",e,{valids:t._valids.values({display:!0})},i,n);if(n.abortEarly)return u.finalize(e,[a],r);d.push(a)}}if(t._invalids){const a=t._invalids.get(e,i,n,t._flags.insensitive);if(a){i.mainstay.tracer.filter(t,i,"invalid",a);const s=t.$_createError("any.invalid",e,{invalids:t._invalids.values({display:!0})},i,n);if(n.abortEarly)return u.finalize(e,[s],r);d.push(s)}}if(l.validate){const t=l.validate(e,r);if(t&&(i.mainstay.tracer.value(i,"base",e,t.value),e=t.value,t.errors)){if(!Array.isArray(t.errors))return d.push(t.errors),u.finalize(e,d,r);if(t.errors.length)return d.push(...t.errors),u.finalize(e,d,r)}}return t._rules.length?u.rules(e,d,r):u.finalize(e,d,r)},u.rules=function(e,t,i){const{schema:n,state:a,prefs:s}=i;for(const r of n._rules){const l=n._definition.rules[r.method];if(l.convert&&s.convert){a.mainstay.tracer.log(n,a,"rule",r.name,"full");continue}let c,m=r.args;if(r._resolve.length){m=Object.assign({},m);for(const t of r._resolve){const i=l.argsByName.get(t),r=m[t].resolve(e,a,s),u=i.normalize?i.normalize(r):r,d=o.validateArg(u,null,i);if(d){c=n.$_createError("any.ref",r,{arg:t,ref:m[t],reason:d},a,s);break}m[t]=u}}c=c||l.validate(e,i,m,r);const d=u.rule(c,r);if(d.errors){if(a.mainstay.tracer.log(n,a,"rule",r.name,"error"),r.warn){a.mainstay.warnings.push(...d.errors);continue}if(s.abortEarly)return u.finalize(e,d.errors,i);t.push(...d.errors)}else a.mainstay.tracer.log(n,a,"rule",r.name,"pass"),a.mainstay.tracer.value(a,"rule",e,d.value,r.name),e=d.value}return u.finalize(e,t,i)},u.rule=function(e,t){return e instanceof l.Report?(u.error(e,t),{errors:[e],value:null}):Array.isArray(e)&&e[o.symbols.errors]?(e.forEach((e=>u.error(e,t))),{errors:e,value:null}):{errors:null,value:e}},u.error=function(e,t){return t.message&&e._setTemplate(t.message),e},u.finalize=function(e,t,i){t=t||[];const{schema:a,state:s,prefs:r}=i;if(t.length){const n=u.default("failover",void 0,t,i);void 0!==n&&(s.mainstay.tracer.value(s,"failover",e,n),e=n,t=[])}if(t.length&&a._flags.error)if("function"==typeof a._flags.error){t=a._flags.error(t),Array.isArray(t)||(t=[t]);for(const e of t)n(e instanceof Error||e instanceof l.Report,"error() must return an Error object")}else t=[a._flags.error];if(void 0===e){const n=u.default("default",e,t,i);s.mainstay.tracer.value(s,"default",e,n),e=n}if(a._flags.cast&&void 0!==e){const t=a._definition.cast[a._flags.cast];if(t.from(e)){const n=t.to(e,i);s.mainstay.tracer.value(s,"cast",e,n,a._flags.cast),e=n}}if(a.$_terms.externals&&r.externals&&!1!==r._externals)for(const{method:e}of a.$_terms.externals)s.mainstay.externals.push({method:e,schema:a,state:s,label:l.label(a._flags,s,r)});const o={value:e,errors:t.length?t:null};return a._flags.result&&(o.value="strip"===a._flags.result?void 0:i.original,s.mainstay.tracer.value(s,a._flags.result,e,o.value),s.shadow(e,a._flags.result)),a._cache&&!1!==r.cache&&!a._refs.length&&a._cache.set(i.original,o),void 0===e||o.errors||void 0===a._flags.artifact||(s.mainstay.artifacts=s.mainstay.artifacts||new Map,s.mainstay.artifacts.has(a._flags.artifact)||s.mainstay.artifacts.set(a._flags.artifact,[]),s.mainstay.artifacts.get(a._flags.artifact).push(s.path)),o},u.prefs=function(e,t){const i=t===o.defaults;return i&&e._preferences[o.symbols.prefs]?e._preferences[o.symbols.prefs]:(t=o.preferences(t,e._preferences),i&&(e._preferences[o.symbols.prefs]=t),t)},u.default=function(e,t,i,n){const{schema:s,state:r,prefs:l}=n,c=s._flags[e];if(l.noDefaults||void 0===c)return t;if(r.mainstay.tracer.log(s,r,"rule",e,"full"),!c)return c;if("function"==typeof c){const o=c.length?[a(r.ancestors[0]),n]:[];try{return c(...o)}catch(t){return void i.push(s.$_createError(`any.${e}`,null,{error:t},r,l))}}return"object"!=typeof c?c:c[o.symbols.literal]?c.literal:o.isResolvable(c)?c.resolve(t,r,l):a(c)},u.trim=function(e,t){if("string"!=typeof e)return e;const i=t.$_getRule("trim");return i&&i.args.enabled?e.trim():e},u.ignore={active:!1,debug:s,entry:s,filter:s,log:s,resolve:s,value:s},u.errorsArray=function(){const e=[];return e[o.symbols.errors]=!0,e}},2036:(e,t,i)=>{"use strict";const n=i(375),a=i(9474),s=i(8160),r={};e.exports=r.Values=class{constructor(e,t){this._values=new Set(e),this._refs=new Set(t),this._lowercase=r.lowercases(e),this._override=!1}get length(){return this._values.size+this._refs.size}add(e,t){s.isResolvable(e)?this._refs.has(e)||(this._refs.add(e),t&&t.register(e)):this.has(e,null,null,!1)||(this._values.add(e),"string"==typeof e&&this._lowercase.set(e.toLowerCase(),e))}static merge(e,t,i){if(e=e||new r.Values,t){if(t._override)return t.clone();for(const i of[...t._values,...t._refs])e.add(i)}if(i)for(const t of[...i._values,...i._refs])e.remove(t);return e.length?e:null}remove(e){s.isResolvable(e)?this._refs.delete(e):(this._values.delete(e),"string"==typeof e&&this._lowercase.delete(e.toLowerCase()))}has(e,t,i,n){return!!this.get(e,t,i,n)}get(e,t,i,n){if(!this.length)return!1;if(this._values.has(e))return{value:e};if("string"==typeof e&&e&&n){const t=this._lowercase.get(e.toLowerCase());if(t)return{value:t}}if(!this._refs.size&&"object"!=typeof e)return!1;if("object"==typeof e)for(const t of this._values)if(a(t,e))return{value:t};if(t)for(const s of this._refs){const r=s.resolve(e,t,i,null,{in:!0});if(void 0===r)continue;const o=s.in&&"object"==typeof r?Array.isArray(r)?r:Object.keys(r):[r];for(const t of o)if(typeof t==typeof e)if(n&&e&&"string"==typeof e){if(t.toLowerCase()===e.toLowerCase())return{value:t,ref:s}}else if(a(t,e))return{value:t,ref:s}}return!1}override(){this._override=!0}values(e){if(e&&e.display){const e=[];for(const t of[...this._values,...this._refs])void 0!==t&&e.push(t);return e}return Array.from([...this._values,...this._refs])}clone(){const e=new r.Values(this._values,this._refs);return e._override=this._override,e}concat(e){n(!e._override,"Cannot concat override set of values");const t=new r.Values([...this._values,...e._values],[...this._refs,...e._refs]);return t._override=this._override,t}describe(){const e=[];this._override&&e.push({override:!0});for(const t of this._values.values())e.push(t&&"object"==typeof t?{value:t}:t);for(const t of this._refs.values())e.push(t.describe());return e}},r.Values.prototype[s.symbols.values]=!0,r.Values.prototype.slice=r.Values.prototype.clone,r.lowercases=function(e){const t=new Map;if(e)for(const i of e)"string"==typeof i&&t.set(i.toLowerCase(),i);return t}},978:(e,t,i)=>{"use strict";const n=i(375),a=i(8571),s=i(1687),r=i(9621),o={};e.exports=function(e,t,i={}){if(n(e&&"object"==typeof e,"Invalid defaults value: must be an object"),n(!t||!0===t||"object"==typeof t,"Invalid source value: must be true, falsy or an object"),n("object"==typeof i,"Invalid options: must be an object"),!t)return null;if(i.shallow)return o.applyToDefaultsWithShallow(e,t,i);const r=a(e);if(!0===t)return r;const l=void 0!==i.nullOverride&&i.nullOverride;return s(r,t,{nullOverride:l,mergeArrays:!1})},o.applyToDefaultsWithShallow=function(e,t,i){const l=i.shallow;n(Array.isArray(l),"Invalid keys");const c=new Map,u=!0===t?null:new Set;for(let i of l){i=Array.isArray(i)?i:i.split(".");const n=r(e,i);n&&"object"==typeof n?c.set(n,u&&r(t,i)||n):u&&u.add(i)}const m=a(e,{},c);if(!u)return m;for(const e of u)o.reachCopy(m,t,e);const d=void 0!==i.nullOverride&&i.nullOverride;return s(m,t,{nullOverride:d,mergeArrays:!1})},o.reachCopy=function(e,t,i){for(const e of i){if(!(e in t))return;const i=t[e];if("object"!=typeof i||null===i)return;t=i}const n=t;let a=e;for(let e=0;e<i.length-1;++e){const t=i[e];"object"!=typeof a[t]&&(a[t]={}),a=a[t]}a[i[i.length-1]]=n}},375:(e,t,i)=>{"use strict";const n=i(7916);e.exports=function(e,...t){if(!e){if(1===t.length&&t[0]instanceof Error)throw t[0];throw new n(t)}}},8571:(e,t,i)=>{"use strict";const n=i(9621),a=i(4277),s=i(7043),r={needsProtoHack:new Set([a.set,a.map,a.weakSet,a.weakMap])};e.exports=r.clone=function(e,t={},i=null){if("object"!=typeof e||null===e)return e;let n=r.clone,o=i;if(t.shallow){if(!0!==t.shallow)return r.cloneWithShallow(e,t);n=e=>e}else if(o){const t=o.get(e);if(t)return t}else o=new Map;const l=a.getInternalProto(e);if(l===a.buffer)return!1;if(l===a.date)return new Date(e.getTime());if(l===a.regex)return new RegExp(e);const c=r.base(e,l,t);if(c===e)return e;if(o&&o.set(e,c),l===a.set)for(const i of e)c.add(n(i,t,o));else if(l===a.map)for(const[i,a]of e)c.set(i,n(a,t,o));const u=s.keys(e,t);for(const i of u){if("__proto__"===i)continue;if(l===a.array&&"length"===i){c.length=e.length;continue}const s=Object.getOwnPropertyDescriptor(e,i);s?s.get||s.set?Object.defineProperty(c,i,s):s.enumerable?c[i]=n(e[i],t,o):Object.defineProperty(c,i,{enumerable:!1,writable:!0,configurable:!0,value:n(e[i],t,o)}):Object.defineProperty(c,i,{enumerable:!0,writable:!0,configurable:!0,value:n(e[i],t,o)})}return c},r.cloneWithShallow=function(e,t){const i=t.shallow;(t=Object.assign({},t)).shallow=!1;const a=new Map;for(const t of i){const i=n(e,t);"object"!=typeof i&&"function"!=typeof i||a.set(i,i)}return r.clone(e,t,a)},r.base=function(e,t,i){if(!1===i.prototype)return r.needsProtoHack.has(t)?new t.constructor:t===a.array?[]:{};const n=Object.getPrototypeOf(e);if(n&&n.isImmutable)return e;if(t===a.array){const e=[];return n!==t&&Object.setPrototypeOf(e,n),e}if(r.needsProtoHack.has(t)){const e=new n.constructor;return n!==t&&Object.setPrototypeOf(e,n),e}return Object.create(n)}},9474:(e,t,i)=>{"use strict";const n=i(4277),a={mismatched:null};e.exports=function(e,t,i){return i=Object.assign({prototype:!0},i),!!a.isDeepEqual(e,t,i,[])},a.isDeepEqual=function(e,t,i,s){if(e===t)return 0!==e||1/e==1/t;const r=typeof e;if(r!==typeof t)return!1;if(null===e||null===t)return!1;if("function"===r){if(!i.deepFunction||e.toString()!==t.toString())return!1}else if("object"!==r)return e!=e&&t!=t;const o=a.getSharedType(e,t,!!i.prototype);switch(o){case n.buffer:return!1;case n.promise:return e===t;case n.regex:return e.toString()===t.toString();case a.mismatched:return!1}for(let i=s.length-1;i>=0;--i)if(s[i].isSame(e,t))return!0;s.push(new a.SeenEntry(e,t));try{return!!a.isDeepEqualObj(o,e,t,i,s)}finally{s.pop()}},a.getSharedType=function(e,t,i){if(i)return Object.getPrototypeOf(e)!==Object.getPrototypeOf(t)?a.mismatched:n.getInternalProto(e);const s=n.getInternalProto(e);return s!==n.getInternalProto(t)?a.mismatched:s},a.valueOf=function(e){const t=e.valueOf;if(void 0===t)return e;try{return t.call(e)}catch(e){return e}},a.hasOwnEnumerableProperty=function(e,t){return Object.prototype.propertyIsEnumerable.call(e,t)},a.isSetSimpleEqual=function(e,t){for(const i of Set.prototype.values.call(e))if(!Set.prototype.has.call(t,i))return!1;return!0},a.isDeepEqualObj=function(e,t,i,s,r){const{isDeepEqual:o,valueOf:l,hasOwnEnumerableProperty:c}=a,{keys:u,getOwnPropertySymbols:m}=Object;if(e===n.array){if(!s.part){if(t.length!==i.length)return!1;for(let e=0;e<t.length;++e)if(!o(t[e],i[e],s,r))return!1;return!0}for(const e of t)for(const t of i)if(o(e,t,s,r))return!0}else if(e===n.set){if(t.size!==i.size)return!1;if(!a.isSetSimpleEqual(t,i)){const e=new Set(Set.prototype.values.call(i));for(const i of Set.prototype.values.call(t)){if(e.delete(i))continue;let t=!1;for(const n of e)if(o(i,n,s,r)){e.delete(n),t=!0;break}if(!t)return!1}}}else if(e===n.map){if(t.size!==i.size)return!1;for(const[e,n]of Map.prototype.entries.call(t)){if(void 0===n&&!Map.prototype.has.call(i,e))return!1;if(!o(n,Map.prototype.get.call(i,e),s,r))return!1}}else if(e===n.error&&(t.name!==i.name||t.message!==i.message))return!1;const d=l(t),h=l(i);if((t!==d||i!==h)&&!o(d,h,s,r))return!1;const f=u(t);if(!s.part&&f.length!==u(i).length&&!s.skip)return!1;let p=0;for(const e of f)if(s.skip&&s.skip.includes(e))void 0===i[e]&&++p;else{if(!c(i,e))return!1;if(!o(t[e],i[e],s,r))return!1}if(!s.part&&f.length-p!==u(i).length)return!1;if(!1!==s.symbols){const e=m(t),n=new Set(m(i));for(const a of e){if(!s.skip||!s.skip.includes(a))if(c(t,a)){if(!c(i,a))return!1;if(!o(t[a],i[a],s,r))return!1}else if(c(i,a))return!1;n.delete(a)}for(const e of n)if(c(i,e))return!1}return!0},a.SeenEntry=class{constructor(e,t){this.obj=e,this.ref=t}isSame(e,t){return this.obj===e&&this.ref===t}}},7916:(e,t,i)=>{"use strict";const n=i(8761);e.exports=class extends Error{constructor(e){super(e.filter((e=>""!==e)).map((e=>"string"==typeof e?e:e instanceof Error?e.message:n(e))).join(" ")||"Unknown error"),"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,t.assert)}}},5277:e=>{"use strict";const t={};e.exports=function(e){if(!e)return"";let i="";for(let n=0;n<e.length;++n){const a=e.charCodeAt(n);t.isSafe(a)?i+=e[n]:i+=t.escapeHtmlChar(a)}return i},t.escapeHtmlChar=function(e){return t.namedHtml.get(e)||(e>=256?"&#"+e+";":`&#x${e.toString(16).padStart(2,"0")};`)},t.isSafe=function(e){return t.safeCharCodes.has(e)},t.namedHtml=new Map([[38,"&amp;"],[60,"&lt;"],[62,"&gt;"],[34,"&quot;"],[160,"&nbsp;"],[162,"&cent;"],[163,"&pound;"],[164,"&curren;"],[169,"&copy;"],[174,"&reg;"]]),t.safeCharCodes=function(){const e=new Set;for(let t=32;t<123;++t)(t>=97||t>=65&&t<=90||t>=48&&t<=57||32===t||46===t||44===t||45===t||58===t||95===t)&&e.add(t);return e}()},6064:e=>{"use strict";e.exports=function(e){return e.replace(/[\^\$\.\*\+\-\?\=\!\:\|\\\/\(\)\[\]\{\}\,]/g,"\\$&")}},738:e=>{"use strict";e.exports=function(){}},1687:(e,t,i)=>{"use strict";const n=i(375),a=i(8571),s=i(7043),r={};e.exports=r.merge=function(e,t,i){if(n(e&&"object"==typeof e,"Invalid target value: must be an object"),n(null==t||"object"==typeof t,"Invalid source value: must be null, undefined, or an object"),!t)return e;if(i=Object.assign({nullOverride:!0,mergeArrays:!0},i),Array.isArray(t)){n(Array.isArray(e),"Cannot merge array onto an object"),i.mergeArrays||(e.length=0);for(let n=0;n<t.length;++n)e.push(a(t[n],{symbols:i.symbols}));return e}const o=s.keys(t,i);for(let n=0;n<o.length;++n){const s=o[n];if("__proto__"===s||!Object.prototype.propertyIsEnumerable.call(t,s))continue;const l=t[s];if(l&&"object"==typeof l){if(e[s]===l)continue;!e[s]||"object"!=typeof e[s]||Array.isArray(e[s])!==Array.isArray(l)||l instanceof Date||l instanceof RegExp?e[s]=a(l,{symbols:i.symbols}):r.merge(e[s],l,i)}else(null!=l||i.nullOverride)&&(e[s]=l)}return e}},9621:(e,t,i)=>{"use strict";const n=i(375),a={};e.exports=function(e,t,i){if(!1===t||null==t)return e;"string"==typeof(i=i||{})&&(i={separator:i});const s=Array.isArray(t);n(!s||!i.separator,"Separator option is not valid for array-based chain");const r=s?t:t.split(i.separator||".");let o=e;for(let e=0;e<r.length;++e){let s=r[e];const l=i.iterables&&a.iterables(o);if(Array.isArray(o)||"set"===l){const e=Number(s);Number.isInteger(e)&&(s=e<0?o.length+e:e)}if(!o||"function"==typeof o&&!1===i.functions||!l&&void 0===o[s]){n(!i.strict||e+1===r.length,"Missing segment",s,"in reach path ",t),n("object"==typeof o||!0===i.functions||"function"!=typeof o,"Invalid segment",s,"in reach path ",t),o=i.default;break}o=l?"set"===l?[...o][s]:o.get(s):o[s]}return o},a.iterables=function(e){return e instanceof Set?"set":e instanceof Map?"map":void 0}},8761:e=>{"use strict";e.exports=function(...e){try{return JSON.stringify(...e)}catch(e){return"[Cannot display object: "+e.message+"]"}}},4277:(e,t)=>{"use strict";const i={};t=e.exports={array:Array.prototype,buffer:!1,date:Date.prototype,error:Error.prototype,generic:Object.prototype,map:Map.prototype,promise:Promise.prototype,regex:RegExp.prototype,set:Set.prototype,weakMap:WeakMap.prototype,weakSet:WeakSet.prototype},i.typeMap=new Map([["[object Error]",t.error],["[object Map]",t.map],["[object Promise]",t.promise],["[object Set]",t.set],["[object WeakMap]",t.weakMap],["[object WeakSet]",t.weakSet]]),t.getInternalProto=function(e){if(Array.isArray(e))return t.array;if(e instanceof Date)return t.date;if(e instanceof RegExp)return t.regex;if(e instanceof Error)return t.error;const n=Object.prototype.toString.call(e);return i.typeMap.get(n)||t.generic}},7043:(e,t)=>{"use strict";t.keys=function(e,t={}){return!1!==t.symbols?Reflect.ownKeys(e):Object.getOwnPropertyNames(e)}},3652:(e,t,i)=>{"use strict";const n=i(375),a={};t.Sorter=class{constructor(){this._items=[],this.nodes=[]}add(e,t){const i=[].concat((t=t||{}).before||[]),a=[].concat(t.after||[]),s=t.group||"?",r=t.sort||0;n(!i.includes(s),`Item cannot come before itself: ${s}`),n(!i.includes("?"),"Item cannot come before unassociated items"),n(!a.includes(s),`Item cannot come after itself: ${s}`),n(!a.includes("?"),"Item cannot come after unassociated items"),Array.isArray(e)||(e=[e]);for(const t of e){const e={seq:this._items.length,sort:r,before:i,after:a,group:s,node:t};this._items.push(e)}if(!t.manual){const e=this._sort();n(e,"item","?"!==s?`added into group ${s}`:"","created a dependencies error")}return this.nodes}merge(e){Array.isArray(e)||(e=[e]);for(const t of e)if(t)for(const e of t._items)this._items.push(Object.assign({},e));this._items.sort(a.mergeSort);for(let e=0;e<this._items.length;++e)this._items[e].seq=e;const t=this._sort();return n(t,"merge created a dependencies error"),this.nodes}sort(){const e=this._sort();return n(e,"sort created a dependencies error"),this.nodes}_sort(){const e={},t=Object.create(null),i=Object.create(null);for(const n of this._items){const a=n.seq,s=n.group;i[s]=i[s]||[],i[s].push(a),e[a]=n.before;for(const e of n.after)t[e]=t[e]||[],t[e].push(a)}for(const t in e){const n=[];for(const a in e[t]){const s=e[t][a];i[s]=i[s]||[],n.push(...i[s])}e[t]=n}for(const n in t)if(i[n])for(const a of i[n])e[a].push(...t[n]);const n={};for(const t in e){const i=e[t];for(const e of i)n[e]=n[e]||[],n[e].push(t)}const a={},s=[];for(let e=0;e<this._items.length;++e){let t=e;if(n[e]){t=null;for(let e=0;e<this._items.length;++e){if(!0===a[e])continue;n[e]||(n[e]=[]);const i=n[e].length;let s=0;for(let t=0;t<i;++t)a[n[e][t]]&&++s;if(s===i){t=e;break}}}null!==t&&(a[t]=!0,s.push(t))}if(s.length!==this._items.length)return!1;const r={};for(const e of this._items)r[e.seq]=e;this._items=[],this.nodes=[];for(const e of s){const t=r[e];this.nodes.push(t.node),this._items.push(t)}return!0}},a.mergeSort=(e,t)=>e.sort===t.sort?0:e.sort<t.sort?-1:1},5380:(e,t,i)=>{"use strict";const n=i(443),a=i(2178),s={minDomainSegments:2,nonAsciiRx:/[^\x00-\x7f]/,domainControlRx:/[\x00-\x20@\:\/\\#!\$&\'\(\)\*\+,;=\?]/,tldSegmentRx:/^[a-zA-Z](?:[a-zA-Z0-9\-]*[a-zA-Z0-9])?$/,domainSegmentRx:/^[a-zA-Z0-9](?:[a-zA-Z0-9\-]*[a-zA-Z0-9])?$/,URL:n.URL||URL};t.analyze=function(e,t={}){if(!e)return a.code("DOMAIN_NON_EMPTY_STRING");if("string"!=typeof e)throw new Error("Invalid input: domain must be a string");if(e.length>256)return a.code("DOMAIN_TOO_LONG");if(s.nonAsciiRx.test(e)){if(!1===t.allowUnicode)return a.code("DOMAIN_INVALID_UNICODE_CHARS");e=e.normalize("NFC")}if(s.domainControlRx.test(e))return a.code("DOMAIN_INVALID_CHARS");e=s.punycode(e),t.allowFullyQualified&&"."===e[e.length-1]&&(e=e.slice(0,-1));const i=t.minDomainSegments||s.minDomainSegments,n=e.split(".");if(n.length<i)return a.code("DOMAIN_SEGMENTS_COUNT");if(t.maxDomainSegments&&n.length>t.maxDomainSegments)return a.code("DOMAIN_SEGMENTS_COUNT_MAX");const r=t.tlds;if(r){const e=n[n.length-1].toLowerCase();if(r.deny&&r.deny.has(e)||r.allow&&!r.allow.has(e))return a.code("DOMAIN_FORBIDDEN_TLDS")}for(let e=0;e<n.length;++e){const t=n[e];if(!t.length)return a.code("DOMAIN_EMPTY_SEGMENT");if(t.length>63)return a.code("DOMAIN_LONG_SEGMENT");if(e<n.length-1){if(!s.domainSegmentRx.test(t))return a.code("DOMAIN_INVALID_CHARS")}else if(!s.tldSegmentRx.test(t))return a.code("DOMAIN_INVALID_TLDS_CHARS")}return null},t.isValid=function(e,i){return!t.analyze(e,i)},s.punycode=function(e){e.includes("%")&&(e=e.replace(/%/g,"%25"));try{return new s.URL(`http://${e}`).host}catch(t){return e}}},1745:(e,t,i)=>{"use strict";const n=i(9848),a=i(5380),s=i(2178),r={nonAsciiRx:/[^\x00-\x7f]/,encoder:new(n.TextEncoder||TextEncoder)};t.analyze=function(e,t){return r.email(e,t)},t.isValid=function(e,t){return!r.email(e,t)},r.email=function(e,t={}){if("string"!=typeof e)throw new Error("Invalid input: email must be a string");if(!e)return s.code("EMPTY_STRING");const i=!r.nonAsciiRx.test(e);if(!i){if(!1===t.allowUnicode)return s.code("FORBIDDEN_UNICODE");e=e.normalize("NFC")}const n=e.split("@");if(2!==n.length)return n.length>2?s.code("MULTIPLE_AT_CHAR"):s.code("MISSING_AT_CHAR");const[o,l]=n;if(!o)return s.code("EMPTY_LOCAL");if(!t.ignoreLength){if(e.length>254)return s.code("ADDRESS_TOO_LONG");if(r.encoder.encode(o).length>64)return s.code("LOCAL_TOO_LONG")}return r.local(o,i)||a.analyze(l,t)},r.local=function(e,t){const i=e.split(".");for(const e of i){if(!e.length)return s.code("EMPTY_LOCAL_SEGMENT");if(t){if(!r.atextRx.test(e))return s.code("INVALID_LOCAL_CHARS")}else for(const t of e){if(r.atextRx.test(t))continue;const e=r.binary(t);if(!r.atomRx.test(e))return s.code("INVALID_LOCAL_CHARS")}}},r.binary=function(e){return Array.from(r.encoder.encode(e)).map((e=>String.fromCharCode(e))).join("")},r.atextRx=/^[\w!#\$%&'\*\+\-/=\?\^`\{\|\}~]+$/,r.atomRx=new RegExp(["(?:[\\xc2-\\xdf][\\x80-\\xbf])","(?:\\xe0[\\xa0-\\xbf][\\x80-\\xbf])|(?:[\\xe1-\\xec][\\x80-\\xbf]{2})|(?:\\xed[\\x80-\\x9f][\\x80-\\xbf])|(?:[\\xee-\\xef][\\x80-\\xbf]{2})","(?:\\xf0[\\x90-\\xbf][\\x80-\\xbf]{2})|(?:[\\xf1-\\xf3][\\x80-\\xbf]{3})|(?:\\xf4[\\x80-\\x8f][\\x80-\\xbf]{2})"].join("|"))},2178:(e,t)=>{"use strict";t.codes={EMPTY_STRING:"Address must be a non-empty string",FORBIDDEN_UNICODE:"Address contains forbidden Unicode characters",MULTIPLE_AT_CHAR:"Address cannot contain more than one @ character",MISSING_AT_CHAR:"Address must contain one @ character",EMPTY_LOCAL:"Address local part cannot be empty",ADDRESS_TOO_LONG:"Address too long",LOCAL_TOO_LONG:"Address local part too long",EMPTY_LOCAL_SEGMENT:"Address local part contains empty dot-separated segment",INVALID_LOCAL_CHARS:"Address local part contains invalid character",DOMAIN_NON_EMPTY_STRING:"Domain must be a non-empty string",DOMAIN_TOO_LONG:"Domain too long",DOMAIN_INVALID_UNICODE_CHARS:"Domain contains forbidden Unicode characters",DOMAIN_INVALID_CHARS:"Domain contains invalid character",DOMAIN_INVALID_TLDS_CHARS:"Domain contains invalid tld character",DOMAIN_SEGMENTS_COUNT:"Domain lacks the minimum required number of segments",DOMAIN_SEGMENTS_COUNT_MAX:"Domain contains too many segments",DOMAIN_FORBIDDEN_TLDS:"Domain uses forbidden TLD",DOMAIN_EMPTY_SEGMENT:"Domain contains empty dot-separated segment",DOMAIN_LONG_SEGMENT:"Domain contains dot-separated segment that is too long"},t.code=function(e){return{code:e,error:t.codes[e]}}},9959:(e,t,i)=>{"use strict";const n=i(375),a=i(5752);t.regex=function(e={}){n(void 0===e.cidr||"string"==typeof e.cidr,"options.cidr must be a string");const t=e.cidr?e.cidr.toLowerCase():"optional";n(["required","optional","forbidden"].includes(t),"options.cidr must be one of required, optional, forbidden"),n(void 0===e.version||"string"==typeof e.version||Array.isArray(e.version),"options.version must be a string or an array of string");let i=e.version||["ipv4","ipv6","ipvfuture"];Array.isArray(i)||(i=[i]),n(i.length>=1,"options.version must have at least 1 version specified");for(let e=0;e<i.length;++e)n("string"==typeof i[e],"options.version must only contain strings"),i[e]=i[e].toLowerCase(),n(["ipv4","ipv6","ipvfuture"].includes(i[e]),"options.version contains unknown version "+i[e]+" - must be one of ipv4, ipv6, ipvfuture");i=Array.from(new Set(i));const s=`(?:${i.map((e=>{if("forbidden"===t)return a.ip[e];const i=`\\/${"ipv4"===e?a.ip.v4Cidr:a.ip.v6Cidr}`;return"required"===t?`${a.ip[e]}${i}`:`${a.ip[e]}(?:${i})?`})).join("|")})`,r=new RegExp(`^${s}$`);return{cidr:t,versions:i,regex:r,raw:s}}},5752:(e,t,i)=>{"use strict";const n=i(375),a=i(6064),s={generate:function(){const e={},t="\\dA-Fa-f",i="["+t+"]",n="\\w-\\.~",a="!\\$&'\\(\\)\\*\\+,;=",s="%"+t,r=n+s+a+":@",o="["+r+"]",l="(?:0{0,2}\\d|0?[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5])";e.ipv4address="(?:"+l+"\\.){3}"+l;const c=i+"{1,4}",u="(?:"+c+":"+c+"|"+e.ipv4address+")",m="(?:"+c+":){6}"+u,d="::(?:"+c+":){5}"+u,h="(?:"+c+")?::(?:"+c+":){4}"+u,f="(?:(?:"+c+":){0,1}"+c+")?::(?:"+c+":){3}"+u,p="(?:(?:"+c+":){0,2}"+c+")?::(?:"+c+":){2}"+u,g="(?:(?:"+c+":){0,3}"+c+")?::"+c+":"+u,y="(?:(?:"+c+":){0,4}"+c+")?::"+u,v="(?:(?:"+c+":){0,5}"+c+")?::"+c,b="(?:(?:"+c+":){0,6}"+c+")?::";e.ipv4Cidr="(?:\\d|[1-2]\\d|3[0-2])",e.ipv6Cidr="(?:0{0,2}\\d|0?[1-9]\\d|1[01]\\d|12[0-8])",e.ipv6address="(?:"+m+"|"+d+"|"+h+"|"+f+"|"+p+"|"+g+"|"+y+"|"+v+"|"+b+")",e.ipvFuture="v"+i+"+\\.["+n+a+":]+",e.scheme="[a-zA-Z][a-zA-Z\\d+-\\.]*",e.schemeRegex=new RegExp(e.scheme);const k="["+n+s+a+":]*",w="["+n+s+a+"]{1,255}",S="(?:\\[(?:"+e.ipv6address+"|"+e.ipvFuture+")\\]|"+e.ipv4address+"|"+w+")",C="(?:"+k+"@)?"+S+"(?::\\d*)?",A="(?:"+k+"@)?("+S+")(?::\\d*)?",x=o+"*",R=o+"+",I="(?:\\/"+x+")*",D="\\/(?:"+R+I+")?",T=R+I,M="["+n+s+a+"@]+"+I,_="(?:\\/\\/\\/"+x+I+")";return e.hierPart="(?:(?:\\/\\/"+C+I+")|"+D+"|"+T+"|"+_+")",e.hierPartCapture="(?:(?:\\/\\/"+A+I+")|"+D+"|"+T+")",e.relativeRef="(?:(?:\\/\\/"+C+I+")|"+D+"|"+M+"|)",e.relativeRefCapture="(?:(?:\\/\\/"+A+I+")|"+D+"|"+M+"|)",e.query="["+r+"\\/\\?]*(?=#|$)",e.queryWithSquareBrackets="["+r+"\\[\\]\\/\\?]*(?=#|$)",e.fragment="["+r+"\\/\\?]*",e}};s.rfc3986=s.generate(),t.ip={v4Cidr:s.rfc3986.ipv4Cidr,v6Cidr:s.rfc3986.ipv6Cidr,ipv4:s.rfc3986.ipv4address,ipv6:s.rfc3986.ipv6address,ipvfuture:s.rfc3986.ipvFuture},s.createRegex=function(e){const t=s.rfc3986,i="(?:\\?"+(e.allowQuerySquareBrackets?t.queryWithSquareBrackets:t.query)+")?(?:#"+t.fragment+")?",r=e.domain?t.relativeRefCapture:t.relativeRef;if(e.relativeOnly)return s.wrap(r+i);let o="";if(e.scheme){n(e.scheme instanceof RegExp||"string"==typeof e.scheme||Array.isArray(e.scheme),"scheme must be a RegExp, String, or Array");const i=[].concat(e.scheme);n(i.length>=1,"scheme must have at least 1 scheme specified");const s=[];for(let e=0;e<i.length;++e){const r=i[e];n(r instanceof RegExp||"string"==typeof r,"scheme at position "+e+" must be a RegExp or String"),r instanceof RegExp?s.push(r.source.toString()):(n(t.schemeRegex.test(r),"scheme at position "+e+" must be a valid scheme"),s.push(a(r)))}o=s.join("|")}const l="(?:"+(o?"(?:"+o+")":t.scheme)+":"+(e.domain?t.hierPartCapture:t.hierPart)+")",c=e.allowRelative?"(?:"+l+"|"+r+")":l;return s.wrap(c+i,o)},s.wrap=function(e,t){return{raw:e=`(?=.)(?!https?:/(?:$|[^/]))(?!https?:///)(?!https?:[^/])${e}`,regex:new RegExp(`^${e}$`),scheme:t}},s.uriRegex=s.createRegex({}),t.regex=function(e={}){return e.scheme||e.allowRelative||e.relativeOnly||e.allowQuerySquareBrackets||e.domain?s.createRegex(e):s.uriRegex}},1447:(e,t)=>{"use strict";const i={operators:["!","^","*","/","%","+","-","<","<=",">",">=","==","!=","&&","||","??"],operatorCharacters:["!","^","*","/","%","+","-","<","=",">","&","|","?"],operatorsOrder:[["^"],["*","/","%"],["+","-"],["<","<=",">",">="],["==","!="],["&&"],["||","??"]],operatorsPrefix:["!","n"],literals:{'"':'"',"`":"`","'":"'","[":"]"},numberRx:/^(?:[0-9]*(\.[0-9]*)?){1}$/,tokenRx:/^[\w\$\#\.\@\:\{\}]+$/,symbol:Symbol("formula"),settings:Symbol("settings")};t.Parser=class{constructor(e,t={}){if(!t[i.settings]&&t.constants)for(const e in t.constants){const i=t.constants[e];if(null!==i&&!["boolean","number","string"].includes(typeof i))throw new Error(`Formula constant ${e} contains invalid ${typeof i} value type`)}this.settings=t[i.settings]?t:Object.assign({[i.settings]:!0,constants:{},functions:{}},t),this.single=null,this._parts=null,this._parse(e)}_parse(e){let n=[],a="",s=0,r=!1;const o=e=>{if(s)throw new Error("Formula missing closing parenthesis");const o=n.length?n[n.length-1]:null;if(r||a||e){if(o&&"reference"===o.type&&")"===e)return o.type="function",o.value=this._subFormula(a,o.value),void(a="");if(")"===e){const e=new t.Parser(a,this.settings);n.push({type:"segment",value:e})}else if(r){if("]"===r)return n.push({type:"reference",value:a}),void(a="");n.push({type:"literal",value:a})}else if(i.operatorCharacters.includes(a))o&&"operator"===o.type&&i.operators.includes(o.value+a)?o.value+=a:n.push({type:"operator",value:a});else if(a.match(i.numberRx))n.push({type:"constant",value:parseFloat(a)});else if(void 0!==this.settings.constants[a])n.push({type:"constant",value:this.settings.constants[a]});else{if(!a.match(i.tokenRx))throw new Error(`Formula contains invalid token: ${a}`);n.push({type:"reference",value:a})}a=""}};for(const t of e)r?t===r?(o(),r=!1):a+=t:s?"("===t?(a+=t,++s):")"===t?(--s,s?a+=t:o(t)):a+=t:t in i.literals?r=i.literals[t]:"("===t?(o(),++s):i.operatorCharacters.includes(t)?(o(),a=t,o()):" "!==t?a+=t:o();o(),n=n.map(((e,t)=>"operator"!==e.type||"-"!==e.value||t&&"operator"!==n[t-1].type?e:{type:"operator",value:"n"}));let l=!1;for(const e of n){if("operator"===e.type){if(i.operatorsPrefix.includes(e.value))continue;if(!l)throw new Error("Formula contains an operator in invalid position");if(!i.operators.includes(e.value))throw new Error(`Formula contains an unknown operator ${e.value}`)}else if(l)throw new Error("Formula missing expected operator");l=!l}if(!l)throw new Error("Formula contains invalid trailing operator");1===n.length&&["reference","literal","constant"].includes(n[0].type)&&(this.single={type:"reference"===n[0].type?"reference":"value",value:n[0].value}),this._parts=n.map((e=>{if("operator"===e.type)return i.operatorsPrefix.includes(e.value)?e:e.value;if("reference"!==e.type)return e.value;if(this.settings.tokenRx&&!this.settings.tokenRx.test(e.value))throw new Error(`Formula contains invalid reference ${e.value}`);return this.settings.reference?this.settings.reference(e.value):i.reference(e.value)}))}_subFormula(e,n){const a=this.settings.functions[n];if("function"!=typeof a)throw new Error(`Formula contains unknown function ${n}`);let s=[];if(e){let t="",a=0,r=!1;const o=()=>{if(!t)throw new Error(`Formula contains function ${n} with invalid arguments ${e}`);s.push(t),t=""};for(let n=0;n<e.length;++n){const s=e[n];r?(t+=s,s===r&&(r=!1)):s in i.literals&&!a?(t+=s,r=i.literals[s]):","!==s||a?(t+=s,"("===s?++a:")"===s&&--a):o()}o()}return s=s.map((e=>new t.Parser(e,this.settings))),function(e){const t=[];for(const i of s)t.push(i.evaluate(e));return a.call(e,...t)}}evaluate(e){const t=this._parts.slice();for(let n=t.length-2;n>=0;--n){const a=t[n];if(a&&"operator"===a.type){const s=t[n+1];t.splice(n+1,1);const r=i.evaluate(s,e);t[n]=i.single(a.value,r)}}return i.operatorsOrder.forEach((n=>{for(let a=1;a<t.length-1;)if(n.includes(t[a])){const n=t[a],s=i.evaluate(t[a-1],e),r=i.evaluate(t[a+1],e);t.splice(a,2);const o=i.calculate(n,s,r);t[a-1]=0===o?0:o}else a+=2})),i.evaluate(t[0],e)}},t.Parser.prototype[i.symbol]=!0,i.reference=function(e){return function(t){return t&&void 0!==t[e]?t[e]:null}},i.evaluate=function(e,t){return null===e?null:"function"==typeof e?e(t):e[i.symbol]?e.evaluate(t):e},i.single=function(e,t){if("!"===e)return!t;const i=-t;return 0===i?0:i},i.calculate=function(e,t,n){if("??"===e)return i.exists(t)?t:n;if("string"==typeof t||"string"==typeof n){if("+"===e)return(t=i.exists(t)?t:"")+(i.exists(n)?n:"")}else switch(e){case"^":return Math.pow(t,n);case"*":return t*n;case"/":return t/n;case"%":return t%n;case"+":return t+n;case"-":return t-n}switch(e){case"<":return t<n;case"<=":return t<=n;case">":return t>n;case">=":return t>=n;case"==":return t===n;case"!=":return t!==n;case"&&":return t&&n;case"||":return t||n}return null},i.exists=function(e){return null!=e}},9926:()=>{},5688:()=>{},9708:()=>{},1152:()=>{},443:()=>{},9848:()=>{},5934:e=>{"use strict";e.exports=JSON.parse('{"version":"17.12.0"}')}},t={},function i(n){var a=t[n];if(void 0!==a)return a.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,i),s.exports}(5107);var e,t},e.exports=t()},8565:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});class LuxonError extends Error{}class InvalidDateTimeError extends LuxonError{constructor(e){super(`Invalid DateTime: ${e.toMessage()}`)}}class InvalidIntervalError extends LuxonError{constructor(e){super(`Invalid Interval: ${e.toMessage()}`)}}class InvalidDurationError extends LuxonError{constructor(e){super(`Invalid Duration: ${e.toMessage()}`)}}class ConflictingSpecificationError extends LuxonError{}class InvalidUnitError extends LuxonError{constructor(e){super(`Invalid unit ${e}`)}}class InvalidArgumentError extends LuxonError{}class ZoneIsAbstractError extends LuxonError{constructor(){super("Zone is an abstract class")}}const i="numeric",n="short",a="long",s={year:i,month:i,day:i},r={year:i,month:n,day:i},o={year:i,month:n,day:i,weekday:n},l={year:i,month:a,day:i},c={year:i,month:a,day:i,weekday:a},u={hour:i,minute:i},m={hour:i,minute:i,second:i},d={hour:i,minute:i,second:i,timeZoneName:n},h={hour:i,minute:i,second:i,timeZoneName:a},f={hour:i,minute:i,hourCycle:"h23"},p={hour:i,minute:i,second:i,hourCycle:"h23"},g={hour:i,minute:i,second:i,hourCycle:"h23",timeZoneName:n},y={hour:i,minute:i,second:i,hourCycle:"h23",timeZoneName:a},v={year:i,month:i,day:i,hour:i,minute:i},b={year:i,month:i,day:i,hour:i,minute:i,second:i},k={year:i,month:n,day:i,hour:i,minute:i},w={year:i,month:n,day:i,hour:i,minute:i,second:i},S={year:i,month:n,day:i,weekday:n,hour:i,minute:i},C={year:i,month:a,day:i,hour:i,minute:i,timeZoneName:n},A={year:i,month:a,day:i,hour:i,minute:i,second:i,timeZoneName:n},x={year:i,month:a,day:i,weekday:a,hour:i,minute:i,timeZoneName:a},R={year:i,month:a,day:i,weekday:a,hour:i,minute:i,second:i,timeZoneName:a};class Zone{get type(){throw new ZoneIsAbstractError}get name(){throw new ZoneIsAbstractError}get ianaName(){return this.name}get isUniversal(){throw new ZoneIsAbstractError}offsetName(e,t){throw new ZoneIsAbstractError}formatOffset(e,t){throw new ZoneIsAbstractError}offset(e){throw new ZoneIsAbstractError}equals(e){throw new ZoneIsAbstractError}get isValid(){throw new ZoneIsAbstractError}}let I=null;class SystemZone extends Zone{static get instance(){return null===I&&(I=new SystemZone),I}get type(){return"system"}get name(){return(new Intl.DateTimeFormat).resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(e,{format:t,locale:i}){return _e(e,t,i)}formatOffset(e,t){return Le(this.offset(e),t)}offset(e){return-new Date(e).getTimezoneOffset()}equals(e){return"system"===e.type}get isValid(){return!0}}let D={};const T={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};let M={};class IANAZone extends Zone{static create(e){return M[e]||(M[e]=new IANAZone(e)),M[e]}static resetCache(){M={},D={}}static isValidSpecifier(e){return this.isValidZone(e)}static isValidZone(e){if(!e)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:e}).format(),!0}catch(e){return!1}}constructor(e){super(),this.zoneName=e,this.valid=IANAZone.isValidZone(e)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(e,{format:t,locale:i}){return _e(e,t,i,this.name)}formatOffset(e,t){return Le(this.offset(e),t)}offset(e){const t=new Date(e);if(isNaN(t))return NaN;const i=(n=this.name,D[n]||(D[n]=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:n,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"})),D[n]);var n;let[a,s,r,o,l,c,u]=i.formatToParts?function(e,t){const i=e.formatToParts(t),n=[];for(let e=0;e<i.length;e++){const{type:t,value:a}=i[e],s=T[t];"era"===t?n[s]=a:ue(s)||(n[s]=parseInt(a,10))}return n}(i,t):function(e,t){const i=e.format(t).replace(/\u200E/g,""),n=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(i),[,a,s,r,o,l,c,u]=n;return[r,a,s,o,l,c,u]}(i,t);"BC"===o&&(a=1-Math.abs(a));let m=+t;const d=m%1e3;return m-=d>=0?d:1e3+d,(Ie({year:a,month:s,day:r,hour:24===l?0:l,minute:c,second:u,millisecond:0})-m)/6e4}equals(e){return"iana"===e.type&&e.name===this.name}get isValid(){return this.valid}}let _={};let $={};function E(e,t={}){const i=JSON.stringify([e,t]);let n=$[i];return n||(n=new Intl.DateTimeFormat(e,t),$[i]=n),n}let O={};let L={};let P=null;let F={};function j(e,t,i,n){const a=e.listingMode();return"error"===a?null:"en"===a?i(t):n(t)}class PolyNumberFormatter{constructor(e,t,i){this.padTo=i.padTo||0,this.floor=i.floor||!1;const{padTo:n,floor:a,...s}=i;if(!t||Object.keys(s).length>0){const t={useGrouping:!1,...i};i.padTo>0&&(t.minimumIntegerDigits=i.padTo),this.inf=function(e,t={}){const i=JSON.stringify([e,t]);let n=O[i];return n||(n=new Intl.NumberFormat(e,t),O[i]=n),n}(e,t)}}format(e){if(this.inf){const t=this.floor?Math.floor(e):e;return this.inf.format(t)}return be(this.floor?Math.floor(e):Ce(e,3),this.padTo)}}class PolyDateFormatter{constructor(e,t,i){let n;if(this.opts=i,this.originalZone=void 0,this.opts.timeZone)this.dt=e;else if("fixed"===e.zone.type){const t=e.offset/60*-1,i=t>=0?`Etc/GMT+${t}`:`Etc/GMT${t}`;0!==e.offset&&IANAZone.create(i).valid?(n=i,this.dt=e):(n="UTC",this.dt=0===e.offset?e:e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone)}else"system"===e.zone.type?this.dt=e:"iana"===e.zone.type?(this.dt=e,n=e.zone.name):(n="UTC",this.dt=e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone);const a={...this.opts};a.timeZone=a.timeZone||n,this.dtf=E(t,a)}format(){return this.originalZone?this.formatToParts().map((({value:e})=>e)).join(""):this.dtf.format(this.dt.toJSDate())}formatToParts(){const e=this.dtf.formatToParts(this.dt.toJSDate());return this.originalZone?e.map((e=>{if("timeZoneName"===e.type){const t=this.originalZone.offsetName(this.dt.ts,{locale:this.dt.locale,format:this.opts.timeZoneName});return{...e,value:t}}return e})):e}resolvedOptions(){return this.dtf.resolvedOptions()}}class PolyRelFormatter{constructor(e,t,i){this.opts={style:"long",...i},!t&&he()&&(this.rtf=function(e,t={}){const{base:i,...n}=t,a=JSON.stringify([e,n]);let s=L[a];return s||(s=new Intl.RelativeTimeFormat(e,t),L[a]=s),s}(e,i))}format(e,t){return this.rtf?this.rtf.format(e,t):function(e,t,i="always",n=!1){const a={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},s=-1===["hours","minutes","seconds"].indexOf(e);if("auto"===i&&s){const i="days"===e;switch(t){case 1:return i?"tomorrow":`next ${a[e][0]}`;case-1:return i?"yesterday":`last ${a[e][0]}`;case 0:return i?"today":`this ${a[e][0]}`}}const r=Object.is(t,-0)||t<0,o=Math.abs(t),l=1===o,c=a[e],u=n?l?c[1]:c[2]||c[1]:l?a[e][0]:e;return r?`${o} ${u} ago`:`in ${o} ${u}`}(t,e,this.opts.numeric,"long"!==this.opts.style)}formatToParts(e,t){return this.rtf?this.rtf.formatToParts(e,t):[]}}const U={firstDay:1,minimalDays:4,weekend:[6,7]};class Locale{static fromOpts(e){return Locale.create(e.locale,e.numberingSystem,e.outputCalendar,e.weekSettings,e.defaultToEN)}static create(e,t,i,n,a=!1){const s=e||Settings.defaultLocale,r=s||(a?"en-US":P||(P=(new Intl.DateTimeFormat).resolvedOptions().locale,P)),o=t||Settings.defaultNumberingSystem,l=i||Settings.defaultOutputCalendar,c=ye(n)||Settings.defaultWeekSettings;return new Locale(r,o,l,c,s)}static resetCache(){P=null,$={},O={},L={}}static fromObject({locale:e,numberingSystem:t,outputCalendar:i,weekSettings:n}={}){return Locale.create(e,t,i,n)}constructor(e,t,i,n,a){const[s,r,o]=function(e){const t=e.indexOf("-x-");-1!==t&&(e=e.substring(0,t));const i=e.indexOf("-u-");if(-1===i)return[e];{let t,n;try{t=E(e).resolvedOptions(),n=e}catch(a){const s=e.substring(0,i);t=E(s).resolvedOptions(),n=s}const{numberingSystem:a,calendar:s}=t;return[n,a,s]}}(e);this.locale=s,this.numberingSystem=t||r||null,this.outputCalendar=i||o||null,this.weekSettings=n,this.intl=function(e,t,i){return i||t?(e.includes("-u-")||(e+="-u"),i&&(e+=`-ca-${i}`),t&&(e+=`-nu-${t}`),e):e}(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=a,this.fastNumbersCached=null}get fastNumbers(){var e;return null==this.fastNumbersCached&&(this.fastNumbersCached=(!(e=this).numberingSystem||"latn"===e.numberingSystem)&&("latn"===e.numberingSystem||!e.locale||e.locale.startsWith("en")||"latn"===new Intl.DateTimeFormat(e.intl).resolvedOptions().numberingSystem)),this.fastNumbersCached}listingMode(){const e=this.isEnglish(),t=!(null!==this.numberingSystem&&"latn"!==this.numberingSystem||null!==this.outputCalendar&&"gregory"!==this.outputCalendar);return e&&t?"en":"intl"}clone(e){return e&&0!==Object.getOwnPropertyNames(e).length?Locale.create(e.locale||this.specifiedLocale,e.numberingSystem||this.numberingSystem,e.outputCalendar||this.outputCalendar,ye(e.weekSettings)||this.weekSettings,e.defaultToEN||!1):this}redefaultToEN(e={}){return this.clone({...e,defaultToEN:!0})}redefaultToSystem(e={}){return this.clone({...e,defaultToEN:!1})}months(e,t=!1){return j(this,e,Ne,(()=>{const i=t?{month:e,day:"numeric"}:{month:e},n=t?"format":"standalone";return this.monthsCache[n][e]||(this.monthsCache[n][e]=function(e){const t=[];for(let i=1;i<=12;i++){const n=DateTime.utc(2009,i,1);t.push(e(n))}return t}((e=>this.extract(e,i,"month")))),this.monthsCache[n][e]}))}weekdays(e,t=!1){return j(this,e,Ke,(()=>{const i=t?{weekday:e,year:"numeric",month:"long",day:"numeric"}:{weekday:e},n=t?"format":"standalone";return this.weekdaysCache[n][e]||(this.weekdaysCache[n][e]=function(e){const t=[];for(let i=1;i<=7;i++){const n=DateTime.utc(2016,11,13+i);t.push(e(n))}return t}((e=>this.extract(e,i,"weekday")))),this.weekdaysCache[n][e]}))}meridiems(){return j(this,void 0,(()=>ze),(()=>{if(!this.meridiemCache){const e={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[DateTime.utc(2016,11,13,9),DateTime.utc(2016,11,13,19)].map((t=>this.extract(t,e,"dayperiod")))}return this.meridiemCache}))}eras(e){return j(this,e,Ge,(()=>{const t={era:e};return this.eraCache[e]||(this.eraCache[e]=[DateTime.utc(-40,1,1),DateTime.utc(2017,1,1)].map((e=>this.extract(e,t,"era")))),this.eraCache[e]}))}extract(e,t,i){const n=this.dtFormatter(e,t).formatToParts().find((e=>e.type.toLowerCase()===i));return n?n.value:null}numberFormatter(e={}){return new PolyNumberFormatter(this.intl,e.forceSimple||this.fastNumbers,e)}dtFormatter(e,t={}){return new PolyDateFormatter(e,this.intl,t)}relFormatter(e={}){return new PolyRelFormatter(this.intl,this.isEnglish(),e)}listFormatter(e={}){return function(e,t={}){const i=JSON.stringify([e,t]);let n=_[i];return n||(n=new Intl.ListFormat(e,t),_[i]=n),n}(this.intl,e)}isEnglish(){return"en"===this.locale||"en-us"===this.locale.toLowerCase()||new Intl.DateTimeFormat(this.intl).resolvedOptions().locale.startsWith("en-us")}getWeekSettings(){return this.weekSettings?this.weekSettings:fe()?function(e){let t=F[e];if(!t){const i=new Intl.Locale(e);t="getWeekInfo"in i?i.getWeekInfo():i.weekInfo,F[e]=t}return t}(this.locale):U}getStartOfWeek(){return this.getWeekSettings().firstDay}getMinDaysInFirstWeek(){return this.getWeekSettings().minimalDays}getWeekendDays(){return this.getWeekSettings().weekend}equals(e){return this.locale===e.locale&&this.numberingSystem===e.numberingSystem&&this.outputCalendar===e.outputCalendar}}let N=null;class FixedOffsetZone extends Zone{static get utcInstance(){return null===N&&(N=new FixedOffsetZone(0)),N}static instance(e){return 0===e?FixedOffsetZone.utcInstance:new FixedOffsetZone(e)}static parseSpecifier(e){if(e){const t=e.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(t)return new FixedOffsetZone($e(t[1],t[2]))}return null}constructor(e){super(),this.fixed=e}get type(){return"fixed"}get name(){return 0===this.fixed?"UTC":`UTC${Le(this.fixed,"narrow")}`}get ianaName(){return 0===this.fixed?"Etc/UTC":`Etc/GMT${Le(-this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(e,t){return Le(this.fixed,t)}get isUniversal(){return!0}offset(){return this.fixed}equals(e){return"fixed"===e.type&&e.fixed===this.fixed}get isValid(){return!0}}class InvalidZone extends Zone{constructor(e){super(),this.zoneName=e}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function B(e,t){if(ue(e)||null===e)return t;if(e instanceof Zone)return e;if("string"==typeof e){const i=e.toLowerCase();return"default"===i?t:"local"===i||"system"===i?SystemZone.instance:"utc"===i||"gmt"===i?FixedOffsetZone.utcInstance:FixedOffsetZone.parseSpecifier(i)||IANAZone.create(e)}return me(e)?FixedOffsetZone.instance(e):"object"==typeof e&&"offset"in e&&"function"==typeof e.offset?e:new InvalidZone(e)}let W,q=()=>Date.now(),K="system",z=null,H=null,Y=null,V=60,G=null;class Settings{static get now(){return q}static set now(e){q=e}static set defaultZone(e){K=e}static get defaultZone(){return B(K,SystemZone.instance)}static get defaultLocale(){return z}static set defaultLocale(e){z=e}static get defaultNumberingSystem(){return H}static set defaultNumberingSystem(e){H=e}static get defaultOutputCalendar(){return Y}static set defaultOutputCalendar(e){Y=e}static get defaultWeekSettings(){return G}static set defaultWeekSettings(e){G=ye(e)}static get twoDigitCutoffYear(){return V}static set twoDigitCutoffYear(e){V=e%100}static get throwOnInvalid(){return W}static set throwOnInvalid(e){W=e}static resetCaches(){Locale.resetCache(),IANAZone.resetCache()}}class Invalid{constructor(e,t){this.reason=e,this.explanation=t}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}const Z=[0,31,59,90,120,151,181,212,243,273,304,334],J=[0,31,60,91,121,152,182,213,244,274,305,335];function X(e,t){return new Invalid("unit out of range",`you specified ${t} (of type ${typeof t}) as a ${e}, which is invalid`)}function Q(e,t,i){const n=new Date(Date.UTC(e,t-1,i));e<100&&e>=0&&n.setUTCFullYear(n.getUTCFullYear()-1900);const a=n.getUTCDay();return 0===a?7:a}function ee(e,t,i){return i+(Ae(e)?J:Z)[t-1]}function te(e,t){const i=Ae(e)?J:Z,n=i.findIndex((e=>e<t));return{month:n+1,day:t-i[n]}}function ie(e,t){return(e-t+7)%7+1}function ne(e,t=4,i=1){const{year:n,month:a,day:s}=e,r=ee(n,a,s),o=ie(Q(n,a,s),i);let l,c=Math.floor((r-o+14-t)/7);return c<1?(l=n-1,c=Te(l,t,i)):c>Te(n,t,i)?(l=n+1,c=1):l=n,{weekYear:l,weekNumber:c,weekday:o,...Pe(e)}}function ae(e,t=4,i=1){const{weekYear:n,weekNumber:a,weekday:s}=e,r=ie(Q(n,1,t),i),o=xe(n);let l,c=7*a+s-r-7+t;c<1?(l=n-1,c+=xe(l)):c>o?(l=n+1,c-=xe(n)):l=n;const{month:u,day:m}=te(l,c);return{year:l,month:u,day:m,...Pe(e)}}function se(e){const{year:t,month:i,day:n}=e;return{year:t,ordinal:ee(t,i,n),...Pe(e)}}function re(e){const{year:t,ordinal:i}=e,{month:n,day:a}=te(t,i);return{year:t,month:n,day:a,...Pe(e)}}function oe(e,t){if(!ue(e.localWeekday)||!ue(e.localWeekNumber)||!ue(e.localWeekYear)){if(!ue(e.weekday)||!ue(e.weekNumber)||!ue(e.weekYear))throw new ConflictingSpecificationError("Cannot mix locale-based week fields with ISO-based week fields");return ue(e.localWeekday)||(e.weekday=e.localWeekday),ue(e.localWeekNumber)||(e.weekNumber=e.localWeekNumber),ue(e.localWeekYear)||(e.weekYear=e.localWeekYear),delete e.localWeekday,delete e.localWeekNumber,delete e.localWeekYear,{minDaysInFirstWeek:t.getMinDaysInFirstWeek(),startOfWeek:t.getStartOfWeek()}}return{minDaysInFirstWeek:4,startOfWeek:1}}function le(e){const t=de(e.year),i=ve(e.month,1,12),n=ve(e.day,1,Re(e.year,e.month));return t?i?!n&&X("day",e.day):X("month",e.month):X("year",e.year)}function ce(e){const{hour:t,minute:i,second:n,millisecond:a}=e,s=ve(t,0,23)||24===t&&0===i&&0===n&&0===a,r=ve(i,0,59),o=ve(n,0,59),l=ve(a,0,999);return s?r?o?!l&&X("millisecond",a):X("second",n):X("minute",i):X("hour",t)}function ue(e){return void 0===e}function me(e){return"number"==typeof e}function de(e){return"number"==typeof e&&e%1==0}function he(){try{return"undefined"!=typeof Intl&&!!Intl.RelativeTimeFormat}catch(e){return!1}}function fe(){try{return"undefined"!=typeof Intl&&!!Intl.Locale&&("weekInfo"in Intl.Locale.prototype||"getWeekInfo"in Intl.Locale.prototype)}catch(e){return!1}}function pe(e,t,i){if(0!==e.length)return e.reduce(((e,n)=>{const a=[t(n),n];return e&&i(e[0],a[0])===e[0]?e:a}),null)[1]}function ge(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function ye(e){if(null==e)return null;if("object"!=typeof e)throw new InvalidArgumentError("Week settings must be an object");if(!ve(e.firstDay,1,7)||!ve(e.minimalDays,1,7)||!Array.isArray(e.weekend)||e.weekend.some((e=>!ve(e,1,7))))throw new InvalidArgumentError("Invalid week settings");return{firstDay:e.firstDay,minimalDays:e.minimalDays,weekend:Array.from(e.weekend)}}function ve(e,t,i){return de(e)&&e>=t&&e<=i}function be(e,t=2){let i;return i=e<0?"-"+(""+-e).padStart(t,"0"):(""+e).padStart(t,"0"),i}function ke(e){return ue(e)||null===e||""===e?void 0:parseInt(e,10)}function we(e){return ue(e)||null===e||""===e?void 0:parseFloat(e)}function Se(e){if(!ue(e)&&null!==e&&""!==e){const t=1e3*parseFloat("0."+e);return Math.floor(t)}}function Ce(e,t,i=!1){const n=10**t;return(i?Math.trunc:Math.round)(e*n)/n}function Ae(e){return e%4==0&&(e%100!=0||e%400==0)}function xe(e){return Ae(e)?366:365}function Re(e,t){const i=function(e,t){return e-t*Math.floor(e/t)}(t-1,12)+1;return 2===i?Ae(e+(t-i)/12)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][i-1]}function Ie(e){let t=Date.UTC(e.year,e.month-1,e.day,e.hour,e.minute,e.second,e.millisecond);return e.year<100&&e.year>=0&&(t=new Date(t),t.setUTCFullYear(e.year,e.month-1,e.day)),+t}function De(e,t,i){return-ie(Q(e,1,t),i)+t-1}function Te(e,t=4,i=1){const n=De(e,t,i),a=De(e+1,t,i);return(xe(e)-n+a)/7}function Me(e){return e>99?e:e>Settings.twoDigitCutoffYear?1900+e:2e3+e}function _e(e,t,i,n=null){const a=new Date(e),s={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};n&&(s.timeZone=n);const r={timeZoneName:t,...s},o=new Intl.DateTimeFormat(i,r).formatToParts(a).find((e=>"timezonename"===e.type.toLowerCase()));return o?o.value:null}function $e(e,t){let i=parseInt(e,10);Number.isNaN(i)&&(i=0);const n=parseInt(t,10)||0;return 60*i+(i<0||Object.is(i,-0)?-n:n)}function Ee(e){const t=Number(e);if("boolean"==typeof e||""===e||Number.isNaN(t))throw new InvalidArgumentError(`Invalid unit value ${e}`);return t}function Oe(e,t){const i={};for(const n in e)if(ge(e,n)){const a=e[n];if(null==a)continue;i[t(n)]=Ee(a)}return i}function Le(e,t){const i=Math.trunc(Math.abs(e/60)),n=Math.trunc(Math.abs(e%60)),a=e>=0?"+":"-";switch(t){case"short":return`${a}${be(i,2)}:${be(n,2)}`;case"narrow":return`${a}${i}${n>0?`:${n}`:""}`;case"techie":return`${a}${be(i,2)}${be(n,2)}`;default:throw new RangeError(`Value format ${t} is out of range for property format`)}}function Pe(e){return function(e,t){return t.reduce(((t,i)=>(t[i]=e[i],t)),{})}(e,["hour","minute","second","millisecond"])}const Fe=["January","February","March","April","May","June","July","August","September","October","November","December"],je=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Ue=["J","F","M","A","M","J","J","A","S","O","N","D"];function Ne(e){switch(e){case"narrow":return[...Ue];case"short":return[...je];case"long":return[...Fe];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const Be=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],We=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],qe=["M","T","W","T","F","S","S"];function Ke(e){switch(e){case"narrow":return[...qe];case"short":return[...We];case"long":return[...Be];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const ze=["AM","PM"],He=["Before Christ","Anno Domini"],Ye=["BC","AD"],Ve=["B","A"];function Ge(e){switch(e){case"narrow":return[...Ve];case"short":return[...Ye];case"long":return[...He];default:return null}}function Ze(e,t){let i="";for(const n of e)n.literal?i+=n.val:i+=t(n.val);return i}const Je={D:s,DD:r,DDD:l,DDDD:c,t:u,tt:m,ttt:d,tttt:h,T:f,TT:p,TTT:g,TTTT:y,f:v,ff:k,fff:C,ffff:x,F:b,FF:w,FFF:A,FFFF:R};class Formatter{static create(e,t={}){return new Formatter(e,t)}static parseFormat(e){let t=null,i="",n=!1;const a=[];for(let s=0;s<e.length;s++){const r=e.charAt(s);"'"===r?(i.length>0&&a.push({literal:n||/^\s+$/.test(i),val:i}),t=null,i="",n=!n):n||r===t?i+=r:(i.length>0&&a.push({literal:/^\s+$/.test(i),val:i}),i=r,t=r)}return i.length>0&&a.push({literal:n||/^\s+$/.test(i),val:i}),a}static macroTokenToFormatOpts(e){return Je[e]}constructor(e,t){this.opts=t,this.loc=e,this.systemLoc=null}formatWithSystemDefault(e,t){null===this.systemLoc&&(this.systemLoc=this.loc.redefaultToSystem());return this.systemLoc.dtFormatter(e,{...this.opts,...t}).format()}dtFormatter(e,t={}){return this.loc.dtFormatter(e,{...this.opts,...t})}formatDateTime(e,t){return this.dtFormatter(e,t).format()}formatDateTimeParts(e,t){return this.dtFormatter(e,t).formatToParts()}formatInterval(e,t){return this.dtFormatter(e.start,t).dtf.formatRange(e.start.toJSDate(),e.end.toJSDate())}resolvedOptions(e,t){return this.dtFormatter(e,t).resolvedOptions()}num(e,t=0){if(this.opts.forceSimple)return be(e,t);const i={...this.opts};return t>0&&(i.padTo=t),this.loc.numberFormatter(i).format(e)}formatDateTimeFromString(e,t){const i="en"===this.loc.listingMode(),n=this.loc.outputCalendar&&"gregory"!==this.loc.outputCalendar,a=(t,i)=>this.loc.extract(e,t,i),s=t=>e.isOffsetFixed&&0===e.offset&&t.allowZ?"Z":e.isValid?e.zone.formatOffset(e.ts,t.format):"",r=()=>i?function(e){return ze[e.hour<12?0:1]}(e):a({hour:"numeric",hourCycle:"h12"},"dayperiod"),o=(t,n)=>i?function(e,t){return Ne(t)[e.month-1]}(e,t):a(n?{month:t}:{month:t,day:"numeric"},"month"),l=(t,n)=>i?function(e,t){return Ke(t)[e.weekday-1]}(e,t):a(n?{weekday:t}:{weekday:t,month:"long",day:"numeric"},"weekday"),c=t=>{const i=Formatter.macroTokenToFormatOpts(t);return i?this.formatWithSystemDefault(e,i):t},u=t=>i?function(e,t){return Ge(t)[e.year<0?0:1]}(e,t):a({era:t},"era");return Ze(Formatter.parseFormat(t),(t=>{switch(t){case"S":return this.num(e.millisecond);case"u":case"SSS":return this.num(e.millisecond,3);case"s":return this.num(e.second);case"ss":return this.num(e.second,2);case"uu":return this.num(Math.floor(e.millisecond/10),2);case"uuu":return this.num(Math.floor(e.millisecond/100));case"m":return this.num(e.minute);case"mm":return this.num(e.minute,2);case"h":return this.num(e.hour%12==0?12:e.hour%12);case"hh":return this.num(e.hour%12==0?12:e.hour%12,2);case"H":return this.num(e.hour);case"HH":return this.num(e.hour,2);case"Z":return s({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return s({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return s({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return e.zone.offsetName(e.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return e.zone.offsetName(e.ts,{format:"long",locale:this.loc.locale});case"z":return e.zoneName;case"a":return r();case"d":return n?a({day:"numeric"},"day"):this.num(e.day);case"dd":return n?a({day:"2-digit"},"day"):this.num(e.day,2);case"c":case"E":return this.num(e.weekday);case"ccc":return l("short",!0);case"cccc":return l("long",!0);case"ccccc":return l("narrow",!0);case"EEE":return l("short",!1);case"EEEE":return l("long",!1);case"EEEEE":return l("narrow",!1);case"L":return n?a({month:"numeric",day:"numeric"},"month"):this.num(e.month);case"LL":return n?a({month:"2-digit",day:"numeric"},"month"):this.num(e.month,2);case"LLL":return o("short",!0);case"LLLL":return o("long",!0);case"LLLLL":return o("narrow",!0);case"M":return n?a({month:"numeric"},"month"):this.num(e.month);case"MM":return n?a({month:"2-digit"},"month"):this.num(e.month,2);case"MMM":return o("short",!1);case"MMMM":return o("long",!1);case"MMMMM":return o("narrow",!1);case"y":return n?a({year:"numeric"},"year"):this.num(e.year);case"yy":return n?a({year:"2-digit"},"year"):this.num(e.year.toString().slice(-2),2);case"yyyy":return n?a({year:"numeric"},"year"):this.num(e.year,4);case"yyyyyy":return n?a({year:"numeric"},"year"):this.num(e.year,6);case"G":return u("short");case"GG":return u("long");case"GGGGG":return u("narrow");case"kk":return this.num(e.weekYear.toString().slice(-2),2);case"kkkk":return this.num(e.weekYear,4);case"W":return this.num(e.weekNumber);case"WW":return this.num(e.weekNumber,2);case"n":return this.num(e.localWeekNumber);case"nn":return this.num(e.localWeekNumber,2);case"ii":return this.num(e.localWeekYear.toString().slice(-2),2);case"iiii":return this.num(e.localWeekYear,4);case"o":return this.num(e.ordinal);case"ooo":return this.num(e.ordinal,3);case"q":return this.num(e.quarter);case"qq":return this.num(e.quarter,2);case"X":return this.num(Math.floor(e.ts/1e3));case"x":return this.num(e.ts);default:return c(t)}}))}formatDurationFromString(e,t){const i=e=>{switch(e[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"w":return"week";case"M":return"month";case"y":return"year";default:return null}},n=Formatter.parseFormat(t),a=n.reduce(((e,{literal:t,val:i})=>t?e:e.concat(i)),[]);return Ze(n,(e=>t=>{const n=i(t);return n?this.num(e.get(n),t.length):t})(e.shiftTo(...a.map(i).filter((e=>e)))))}}const Xe=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function Qe(...e){const t=e.reduce(((e,t)=>e+t.source),"");return RegExp(`^${t}$`)}function et(...e){return t=>e.reduce((([e,i,n],a)=>{const[s,r,o]=a(t,n);return[{...e,...s},r||i,o]}),[{},null,1]).slice(0,2)}function tt(e,...t){if(null==e)return[null,null];for(const[i,n]of t){const t=i.exec(e);if(t)return n(t)}return[null,null]}function it(...e){return(t,i)=>{const n={};let a;for(a=0;a<e.length;a++)n[e[a]]=ke(t[i+a]);return[n,null,i+a]}}const nt=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,at=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,st=RegExp(`${at.source}${`(?:${nt.source}?(?:\\[(${Xe.source})\\])?)?`}`),rt=RegExp(`(?:T${st.source})?`),ot=it("weekYear","weekNumber","weekDay"),lt=it("year","ordinal"),ct=RegExp(`${at.source} ?(?:${nt.source}|(${Xe.source}))?`),ut=RegExp(`(?: ${ct.source})?`);function mt(e,t,i){const n=e[t];return ue(n)?i:ke(n)}function dt(e,t){return[{hours:mt(e,t,0),minutes:mt(e,t+1,0),seconds:mt(e,t+2,0),milliseconds:Se(e[t+3])},null,t+4]}function ht(e,t){const i=!e[t]&&!e[t+1],n=$e(e[t+1],e[t+2]);return[{},i?null:FixedOffsetZone.instance(n),t+3]}function ft(e,t){return[{},e[t]?IANAZone.create(e[t]):null,t+1]}const pt=RegExp(`^T?${at.source}$`),gt=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function yt(e){const[t,i,n,a,s,r,o,l,c]=e,u="-"===t[0],m=l&&"-"===l[0],d=(e,t=!1)=>void 0!==e&&(t||e&&u)?-e:e;return[{years:d(we(i)),months:d(we(n)),weeks:d(we(a)),days:d(we(s)),hours:d(we(r)),minutes:d(we(o)),seconds:d(we(l),"-0"===l),milliseconds:d(Se(c),m)}]}const vt={GMT:0,EDT:-240,EST:-300,CDT:-300,CST:-360,MDT:-360,MST:-420,PDT:-420,PST:-480};function bt(e,t,i,n,a,s,r){const o={year:2===t.length?Me(ke(t)):ke(t),month:je.indexOf(i)+1,day:ke(n),hour:ke(a),minute:ke(s)};return r&&(o.second=ke(r)),e&&(o.weekday=e.length>3?Be.indexOf(e)+1:We.indexOf(e)+1),o}const kt=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function wt(e){const[,t,i,n,a,s,r,o,l,c,u,m]=e,d=bt(t,a,n,i,s,r,o);let h;return h=l?vt[l]:c?0:$e(u,m),[d,new FixedOffsetZone(h)]}const St=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,Ct=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,At=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function xt(e){const[,t,i,n,a,s,r,o]=e;return[bt(t,a,n,i,s,r,o),FixedOffsetZone.utcInstance]}function Rt(e){const[,t,i,n,a,s,r,o]=e;return[bt(t,o,i,n,a,s,r),FixedOffsetZone.utcInstance]}const It=Qe(/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,rt),Dt=Qe(/(\d{4})-?W(\d\d)(?:-?(\d))?/,rt),Tt=Qe(/(\d{4})-?(\d{3})/,rt),Mt=Qe(st),_t=et((function(e,t){return[{year:mt(e,t),month:mt(e,t+1,1),day:mt(e,t+2,1)},null,t+3]}),dt,ht,ft),$t=et(ot,dt,ht,ft),Et=et(lt,dt,ht,ft),Ot=et(dt,ht,ft);const Lt=et(dt);const Pt=Qe(/(\d{4})-(\d\d)-(\d\d)/,ut),Ft=Qe(ct),jt=et(dt,ht,ft);const Ut="Invalid Duration",Nt={weeks:{days:7,hours:168,minutes:10080,seconds:604800,milliseconds:6048e5},days:{hours:24,minutes:1440,seconds:86400,milliseconds:864e5},hours:{minutes:60,seconds:3600,milliseconds:36e5},minutes:{seconds:60,milliseconds:6e4},seconds:{milliseconds:1e3}},Bt={years:{quarters:4,months:12,weeks:52,days:365,hours:8760,minutes:525600,seconds:31536e3,milliseconds:31536e6},quarters:{months:3,weeks:13,days:91,hours:2184,minutes:131040,seconds:7862400,milliseconds:78624e5},months:{weeks:4,days:30,hours:720,minutes:43200,seconds:2592e3,milliseconds:2592e6},...Nt},Wt=365.2425,qt=30.436875,Kt={years:{quarters:4,months:12,weeks:52.1775,days:Wt,hours:8765.82,minutes:525949.2,seconds:525949.2*60,milliseconds:525949.2*60*1e3},quarters:{months:3,weeks:13.044375,days:91.310625,hours:2191.455,minutes:131487.3,seconds:525949.2*60/4,milliseconds:7889237999.999999},months:{weeks:4.3481250000000005,days:qt,hours:730.485,minutes:43829.1,seconds:2629746,milliseconds:2629746e3},...Nt},zt=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],Ht=zt.slice(0).reverse();function Yt(e,t,i=!1){const n={values:i?t.values:{...e.values,...t.values||{}},loc:e.loc.clone(t.loc),conversionAccuracy:t.conversionAccuracy||e.conversionAccuracy,matrix:t.matrix||e.matrix};return new Duration(n)}function Vt(e,t){var i;let n=null!=(i=t.milliseconds)?i:0;for(const i of Ht.slice(1))t[i]&&(n+=t[i]*e[i].milliseconds);return n}function Gt(e,t){const i=Vt(e,t)<0?-1:1;zt.reduceRight(((n,a)=>{if(ue(t[a]))return n;if(n){const s=t[n]*i,r=e[a][n],o=Math.floor(s/r);t[a]+=o*i,t[n]-=o*r*i}return a}),null),zt.reduce(((i,n)=>{if(ue(t[n]))return i;if(i){const a=t[i]%1;t[i]-=a,t[n]+=a*e[i][n]}return n}),null)}class Duration{constructor(e){const t="longterm"===e.conversionAccuracy||!1;let i=t?Kt:Bt;e.matrix&&(i=e.matrix),this.values=e.values,this.loc=e.loc||Locale.create(),this.conversionAccuracy=t?"longterm":"casual",this.invalid=e.invalid||null,this.matrix=i,this.isLuxonDuration=!0}static fromMillis(e,t){return Duration.fromObject({milliseconds:e},t)}static fromObject(e,t={}){if(null==e||"object"!=typeof e)throw new InvalidArgumentError("Duration.fromObject: argument expected to be an object, got "+(null===e?"null":typeof e));return new Duration({values:Oe(e,Duration.normalizeUnit),loc:Locale.fromObject(t),conversionAccuracy:t.conversionAccuracy,matrix:t.matrix})}static fromDurationLike(e){if(me(e))return Duration.fromMillis(e);if(Duration.isDuration(e))return e;if("object"==typeof e)return Duration.fromObject(e);throw new InvalidArgumentError(`Unknown duration argument ${e} of type ${typeof e}`)}static fromISO(e,t){const[i]=function(e){return tt(e,[gt,yt])}(e);return i?Duration.fromObject(i,t):Duration.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static fromISOTime(e,t){const[i]=function(e){return tt(e,[pt,Lt])}(e);return i?Duration.fromObject(i,t):Duration.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static invalid(e,t=null){if(!e)throw new InvalidArgumentError("need to specify a reason the Duration is invalid");const i=e instanceof Invalid?e:new Invalid(e,t);if(Settings.throwOnInvalid)throw new InvalidDurationError(i);return new Duration({invalid:i})}static normalizeUnit(e){const t={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[e?e.toLowerCase():e];if(!t)throw new InvalidUnitError(e);return t}static isDuration(e){return e&&e.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(e,t={}){const i={...t,floor:!1!==t.round&&!1!==t.floor};return this.isValid?Formatter.create(this.loc,i).formatDurationFromString(this,e):Ut}toHuman(e={}){if(!this.isValid)return Ut;const t=zt.map((t=>{const i=this.values[t];return ue(i)?null:this.loc.numberFormatter({style:"unit",unitDisplay:"long",...e,unit:t.slice(0,-1)}).format(i)})).filter((e=>e));return this.loc.listFormatter({type:"conjunction",style:e.listStyle||"narrow",...e}).format(t)}toObject(){return this.isValid?{...this.values}:{}}toISO(){if(!this.isValid)return null;let e="P";return 0!==this.years&&(e+=this.years+"Y"),0===this.months&&0===this.quarters||(e+=this.months+3*this.quarters+"M"),0!==this.weeks&&(e+=this.weeks+"W"),0!==this.days&&(e+=this.days+"D"),0===this.hours&&0===this.minutes&&0===this.seconds&&0===this.milliseconds||(e+="T"),0!==this.hours&&(e+=this.hours+"H"),0!==this.minutes&&(e+=this.minutes+"M"),0===this.seconds&&0===this.milliseconds||(e+=Ce(this.seconds+this.milliseconds/1e3,3)+"S"),"P"===e&&(e+="T0S"),e}toISOTime(e={}){if(!this.isValid)return null;const t=this.toMillis();if(t<0||t>=864e5)return null;e={suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended",...e,includeOffset:!1};return DateTime.fromMillis(t,{zone:"UTC"}).toISOTime(e)}toJSON(){return this.toISO()}toString(){return this.toISO()}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Duration { values: ${JSON.stringify(this.values)} }`:`Duration { Invalid, reason: ${this.invalidReason} }`}toMillis(){return this.isValid?Vt(this.matrix,this.values):NaN}valueOf(){return this.toMillis()}plus(e){if(!this.isValid)return this;const t=Duration.fromDurationLike(e),i={};for(const e of zt)(ge(t.values,e)||ge(this.values,e))&&(i[e]=t.get(e)+this.get(e));return Yt(this,{values:i},!0)}minus(e){if(!this.isValid)return this;const t=Duration.fromDurationLike(e);return this.plus(t.negate())}mapUnits(e){if(!this.isValid)return this;const t={};for(const i of Object.keys(this.values))t[i]=Ee(e(this.values[i],i));return Yt(this,{values:t},!0)}get(e){return this[Duration.normalizeUnit(e)]}set(e){if(!this.isValid)return this;return Yt(this,{values:{...this.values,...Oe(e,Duration.normalizeUnit)}})}reconfigure({locale:e,numberingSystem:t,conversionAccuracy:i,matrix:n}={}){return Yt(this,{loc:this.loc.clone({locale:e,numberingSystem:t}),matrix:n,conversionAccuracy:i})}as(e){return this.isValid?this.shiftTo(e).get(e):NaN}normalize(){if(!this.isValid)return this;const e=this.toObject();return Gt(this.matrix,e),Yt(this,{values:e},!0)}rescale(){if(!this.isValid)return this;return Yt(this,{values:function(e){const t={};for(const[i,n]of Object.entries(e))0!==n&&(t[i]=n);return t}(this.normalize().shiftToAll().toObject())},!0)}shiftTo(...e){if(!this.isValid)return this;if(0===e.length)return this;e=e.map((e=>Duration.normalizeUnit(e)));const t={},i={},n=this.toObject();let a;for(const s of zt)if(e.indexOf(s)>=0){a=s;let e=0;for(const t in i)e+=this.matrix[t][s]*i[t],i[t]=0;me(n[s])&&(e+=n[s]);const r=Math.trunc(e);t[s]=r,i[s]=(1e3*e-1e3*r)/1e3}else me(n[s])&&(i[s]=n[s]);for(const e in i)0!==i[e]&&(t[a]+=e===a?i[e]:i[e]/this.matrix[a][e]);return Gt(this.matrix,t),Yt(this,{values:t},!0)}shiftToAll(){return this.isValid?this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds"):this}negate(){if(!this.isValid)return this;const e={};for(const t of Object.keys(this.values))e[t]=0===this.values[t]?0:-this.values[t];return Yt(this,{values:e},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return null===this.invalid}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(e){if(!this.isValid||!e.isValid)return!1;if(!this.loc.equals(e.loc))return!1;for(const n of zt)if(t=this.values[n],i=e.values[n],!(void 0===t||0===t?void 0===i||0===i:t===i))return!1;var t,i;return!0}}const Zt="Invalid Interval";class Interval{constructor(e){this.s=e.start,this.e=e.end,this.invalid=e.invalid||null,this.isLuxonInterval=!0}static invalid(e,t=null){if(!e)throw new InvalidArgumentError("need to specify a reason the Interval is invalid");const i=e instanceof Invalid?e:new Invalid(e,t);if(Settings.throwOnInvalid)throw new InvalidIntervalError(i);return new Interval({invalid:i})}static fromDateTimes(e,t){const i=Bi(e),n=Bi(t),a=function(e,t){return e&&e.isValid?t&&t.isValid?t<e?Interval.invalid("end before start",`The end of an interval must be after its start, but you had start=${e.toISO()} and end=${t.toISO()}`):null:Interval.invalid("missing or invalid end"):Interval.invalid("missing or invalid start")}(i,n);return null==a?new Interval({start:i,end:n}):a}static after(e,t){const i=Duration.fromDurationLike(t),n=Bi(e);return Interval.fromDateTimes(n,n.plus(i))}static before(e,t){const i=Duration.fromDurationLike(t),n=Bi(e);return Interval.fromDateTimes(n.minus(i),n)}static fromISO(e,t){const[i,n]=(e||"").split("/",2);if(i&&n){let e,a,s,r;try{e=DateTime.fromISO(i,t),a=e.isValid}catch(n){a=!1}try{s=DateTime.fromISO(n,t),r=s.isValid}catch(n){r=!1}if(a&&r)return Interval.fromDateTimes(e,s);if(a){const i=Duration.fromISO(n,t);if(i.isValid)return Interval.after(e,i)}else if(r){const e=Duration.fromISO(i,t);if(e.isValid)return Interval.before(s,e)}}return Interval.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static isInterval(e){return e&&e.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get isValid(){return null===this.invalidReason}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(e="milliseconds"){return this.isValid?this.toDuration(e).get(e):NaN}count(e="milliseconds",t){if(!this.isValid)return NaN;const i=this.start.startOf(e,t);let n;return n=null!=t&&t.useLocaleWeeks?this.end.reconfigure({locale:i.locale}):this.end,n=n.startOf(e,t),Math.floor(n.diff(i,e).get(e))+(n.valueOf()!==this.end.valueOf())}hasSame(e){return!!this.isValid&&(this.isEmpty()||this.e.minus(1).hasSame(this.s,e))}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(e){return!!this.isValid&&this.s>e}isBefore(e){return!!this.isValid&&this.e<=e}contains(e){return!!this.isValid&&(this.s<=e&&this.e>e)}set({start:e,end:t}={}){return this.isValid?Interval.fromDateTimes(e||this.s,t||this.e):this}splitAt(...e){if(!this.isValid)return[];const t=e.map(Bi).filter((e=>this.contains(e))).sort(((e,t)=>e.toMillis()-t.toMillis())),i=[];let{s:n}=this,a=0;for(;n<this.e;){const e=t[a]||this.e,s=+e>+this.e?this.e:e;i.push(Interval.fromDateTimes(n,s)),n=s,a+=1}return i}splitBy(e){const t=Duration.fromDurationLike(e);if(!this.isValid||!t.isValid||0===t.as("milliseconds"))return[];let i,{s:n}=this,a=1;const s=[];for(;n<this.e;){const e=this.start.plus(t.mapUnits((e=>e*a)));i=+e>+this.e?this.e:e,s.push(Interval.fromDateTimes(n,i)),n=i,a+=1}return s}divideEqually(e){return this.isValid?this.splitBy(this.length()/e).slice(0,e):[]}overlaps(e){return this.e>e.s&&this.s<e.e}abutsStart(e){return!!this.isValid&&+this.e==+e.s}abutsEnd(e){return!!this.isValid&&+e.e==+this.s}engulfs(e){return!!this.isValid&&(this.s<=e.s&&this.e>=e.e)}equals(e){return!(!this.isValid||!e.isValid)&&(this.s.equals(e.s)&&this.e.equals(e.e))}intersection(e){if(!this.isValid)return this;const t=this.s>e.s?this.s:e.s,i=this.e<e.e?this.e:e.e;return t>=i?null:Interval.fromDateTimes(t,i)}union(e){if(!this.isValid)return this;const t=this.s<e.s?this.s:e.s,i=this.e>e.e?this.e:e.e;return Interval.fromDateTimes(t,i)}static merge(e){const[t,i]=e.sort(((e,t)=>e.s-t.s)).reduce((([e,t],i)=>t?t.overlaps(i)||t.abutsStart(i)?[e,t.union(i)]:[e.concat([t]),i]:[e,i]),[[],null]);return i&&t.push(i),t}static xor(e){let t=null,i=0;const n=[],a=e.map((e=>[{time:e.s,type:"s"},{time:e.e,type:"e"}])),s=Array.prototype.concat(...a).sort(((e,t)=>e.time-t.time));for(const e of s)i+="s"===e.type?1:-1,1===i?t=e.time:(t&&+t!=+e.time&&n.push(Interval.fromDateTimes(t,e.time)),t=null);return Interval.merge(n)}difference(...e){return Interval.xor([this].concat(e)).map((e=>this.intersection(e))).filter((e=>e&&!e.isEmpty()))}toString(){return this.isValid?`[${this.s.toISO()} – ${this.e.toISO()})`:Zt}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Interval { start: ${this.s.toISO()}, end: ${this.e.toISO()} }`:`Interval { Invalid, reason: ${this.invalidReason} }`}toLocaleString(e=s,t={}){return this.isValid?Formatter.create(this.s.loc.clone(t),e).formatInterval(this):Zt}toISO(e){return this.isValid?`${this.s.toISO(e)}/${this.e.toISO(e)}`:Zt}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:Zt}toISOTime(e){return this.isValid?`${this.s.toISOTime(e)}/${this.e.toISOTime(e)}`:Zt}toFormat(e,{separator:t=" – "}={}){return this.isValid?`${this.s.toFormat(e)}${t}${this.e.toFormat(e)}`:Zt}toDuration(e,t){return this.isValid?this.e.diff(this.s,e,t):Duration.invalid(this.invalidReason)}mapEndpoints(e){return Interval.fromDateTimes(e(this.s),e(this.e))}}class Info{static hasDST(e=Settings.defaultZone){const t=DateTime.now().setZone(e).set({month:12});return!e.isUniversal&&t.offset!==t.set({month:6}).offset}static isValidIANAZone(e){return IANAZone.isValidZone(e)}static normalizeZone(e){return B(e,Settings.defaultZone)}static getStartOfWeek({locale:e=null,locObj:t=null}={}){return(t||Locale.create(e)).getStartOfWeek()}static getMinimumDaysInFirstWeek({locale:e=null,locObj:t=null}={}){return(t||Locale.create(e)).getMinDaysInFirstWeek()}static getWeekendWeekdays({locale:e=null,locObj:t=null}={}){return(t||Locale.create(e)).getWeekendDays().slice()}static months(e="long",{locale:t=null,numberingSystem:i=null,locObj:n=null,outputCalendar:a="gregory"}={}){return(n||Locale.create(t,i,a)).months(e)}static monthsFormat(e="long",{locale:t=null,numberingSystem:i=null,locObj:n=null,outputCalendar:a="gregory"}={}){return(n||Locale.create(t,i,a)).months(e,!0)}static weekdays(e="long",{locale:t=null,numberingSystem:i=null,locObj:n=null}={}){return(n||Locale.create(t,i,null)).weekdays(e)}static weekdaysFormat(e="long",{locale:t=null,numberingSystem:i=null,locObj:n=null}={}){return(n||Locale.create(t,i,null)).weekdays(e,!0)}static meridiems({locale:e=null}={}){return Locale.create(e).meridiems()}static eras(e="short",{locale:t=null}={}){return Locale.create(t,null,"gregory").eras(e)}static features(){return{relative:he(),localeWeek:fe()}}}function Jt(e,t){const i=e=>e.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),n=i(t)-i(e);return Math.floor(Duration.fromMillis(n).as("days"))}function Xt(e,t,i,n){let[a,s,r,o]=function(e,t,i){const n=[["years",(e,t)=>t.year-e.year],["quarters",(e,t)=>t.quarter-e.quarter+4*(t.year-e.year)],["months",(e,t)=>t.month-e.month+12*(t.year-e.year)],["weeks",(e,t)=>{const i=Jt(e,t);return(i-i%7)/7}],["days",Jt]],a={},s=e;let r,o;for(const[l,c]of n)i.indexOf(l)>=0&&(r=l,a[l]=c(e,t),o=s.plus(a),o>t?(a[l]--,(e=s.plus(a))>t&&(o=e,a[l]--,e=s.plus(a))):e=o);return[e,a,o,r]}(e,t,i);const l=t-a,c=i.filter((e=>["hours","minutes","seconds","milliseconds"].indexOf(e)>=0));0===c.length&&(r<t&&(r=a.plus({[o]:1})),r!==a&&(s[o]=(s[o]||0)+l/(r-a)));const u=Duration.fromObject(s,n);return c.length>0?Duration.fromMillis(l,n).shiftTo(...c).plus(u):u}const Qt={arab:"[٠-٩]",arabext:"[۰-۹]",bali:"[᭐-᭙]",beng:"[০-৯]",deva:"[०-९]",fullwide:"[０-９]",gujr:"[૦-૯]",hanidec:"[〇|一|二|三|四|五|六|七|八|九]",khmr:"[០-៩]",knda:"[೦-೯]",laoo:"[໐-໙]",limb:"[᥆-᥏]",mlym:"[൦-൯]",mong:"[᠐-᠙]",mymr:"[၀-၉]",orya:"[୦-୯]",tamldec:"[௦-௯]",telu:"[౦-౯]",thai:"[๐-๙]",tibt:"[༠-༩]",latn:"\\d"},ei={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},ti=Qt.hanidec.replace(/[\[|\]]/g,"").split("");function ii({numberingSystem:e},t=""){return new RegExp(`${Qt[e||"latn"]}${t}`)}const ni="missing Intl.DateTimeFormat.formatToParts support";function ai(e,t=(e=>e)){return{regex:e,deser:([e])=>t(function(e){let t=parseInt(e,10);if(isNaN(t)){t="";for(let i=0;i<e.length;i++){const n=e.charCodeAt(i);if(-1!==e[i].search(Qt.hanidec))t+=ti.indexOf(e[i]);else for(const e in ei){const[i,a]=ei[e];n>=i&&n<=a&&(t+=n-i)}}return parseInt(t,10)}return t}(e))}}const si=`[ ${String.fromCharCode(160)}]`,ri=new RegExp(si,"g");function oi(e){return e.replace(/\./g,"\\.?").replace(ri,si)}function li(e){return e.replace(/\./g,"").replace(ri," ").toLowerCase()}function ci(e,t){return null===e?null:{regex:RegExp(e.map(oi).join("|")),deser:([i])=>e.findIndex((e=>li(i)===li(e)))+t}}function ui(e,t){return{regex:e,deser:([,e,t])=>$e(e,t),groups:t}}function mi(e){return{regex:e,deser:([e])=>e}}const di={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour12:{numeric:"h","2-digit":"hh"},hour24:{numeric:"H","2-digit":"HH"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"},timeZoneName:{long:"ZZZZZ",short:"ZZZ"}};let hi=null;function fi(e,t){return Array.prototype.concat(...e.map((e=>function(e,t){if(e.literal)return e;const i=gi(Formatter.macroTokenToFormatOpts(e.val),t);return null==i||i.includes(void 0)?e:i}(e,t))))}function pi(e,t,i){const n=fi(Formatter.parseFormat(i),e),a=n.map((t=>function(e,t){const i=ii(t),n=ii(t,"{2}"),a=ii(t,"{3}"),s=ii(t,"{4}"),r=ii(t,"{6}"),o=ii(t,"{1,2}"),l=ii(t,"{1,3}"),c=ii(t,"{1,6}"),u=ii(t,"{1,9}"),m=ii(t,"{2,4}"),d=ii(t,"{4,6}"),h=e=>{return{regex:RegExp((t=e.val,t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"))),deser:([e])=>e,literal:!0};var t},f=(f=>{if(e.literal)return h(f);switch(f.val){case"G":return ci(t.eras("short"),0);case"GG":return ci(t.eras("long"),0);case"y":return ai(c);case"yy":case"kk":return ai(m,Me);case"yyyy":case"kkkk":return ai(s);case"yyyyy":return ai(d);case"yyyyyy":return ai(r);case"M":case"L":case"d":case"H":case"h":case"m":case"q":case"s":case"W":return ai(o);case"MM":case"LL":case"dd":case"HH":case"hh":case"mm":case"qq":case"ss":case"WW":return ai(n);case"MMM":return ci(t.months("short",!0),1);case"MMMM":return ci(t.months("long",!0),1);case"LLL":return ci(t.months("short",!1),1);case"LLLL":return ci(t.months("long",!1),1);case"o":case"S":return ai(l);case"ooo":case"SSS":return ai(a);case"u":return mi(u);case"uu":return mi(o);case"uuu":case"E":case"c":return ai(i);case"a":return ci(t.meridiems(),0);case"EEE":return ci(t.weekdays("short",!1),1);case"EEEE":return ci(t.weekdays("long",!1),1);case"ccc":return ci(t.weekdays("short",!0),1);case"cccc":return ci(t.weekdays("long",!0),1);case"Z":case"ZZ":return ui(new RegExp(`([+-]${o.source})(?::(${n.source}))?`),2);case"ZZZ":return ui(new RegExp(`([+-]${o.source})(${n.source})?`),2);case"z":return mi(/[a-z_+-/]{1,256}?/i);case" ":return mi(/[^\S\n\r]/);default:return h(f)}})(e)||{invalidReason:ni};return f.token=e,f}(t,e))),s=a.find((e=>e.invalidReason));if(s)return{input:t,tokens:n,invalidReason:s.invalidReason};{const[e,i]=function(e){return[`^${e.map((e=>e.regex)).reduce(((e,t)=>`${e}(${t.source})`),"")}$`,e]}(a),s=RegExp(e,"i"),[r,o]=function(e,t,i){const n=e.match(t);if(n){const e={};let t=1;for(const a in i)if(ge(i,a)){const s=i[a],r=s.groups?s.groups+1:1;!s.literal&&s.token&&(e[s.token.val[0]]=s.deser(n.slice(t,t+r))),t+=r}return[n,e]}return[n,{}]}(t,s,i),[l,c,u]=o?function(e){let t,i=null;return ue(e.z)||(i=IANAZone.create(e.z)),ue(e.Z)||(i||(i=new FixedOffsetZone(e.Z)),t=e.Z),ue(e.q)||(e.M=3*(e.q-1)+1),ue(e.h)||(e.h<12&&1===e.a?e.h+=12:12===e.h&&0===e.a&&(e.h=0)),0===e.G&&e.y&&(e.y=-e.y),ue(e.u)||(e.S=Se(e.u)),[Object.keys(e).reduce(((t,i)=>{const n=(e=>{switch(e){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}})(i);return n&&(t[n]=e[i]),t}),{}),i,t]}(o):[null,null,void 0];if(ge(o,"a")&&ge(o,"H"))throw new ConflictingSpecificationError("Can't include meridiem when specifying 24-hour format");return{input:t,tokens:n,regex:s,rawMatches:r,matches:o,result:l,zone:c,specificOffset:u}}}function gi(e,t){if(!e)return null;const i=Formatter.create(t,e).dtFormatter((hi||(hi=DateTime.fromMillis(1555555555555)),hi)),n=i.formatToParts(),a=i.resolvedOptions();return n.map((t=>function(e,t,i){const{type:n,value:a}=e;if("literal"===n){const e=/^\s+$/.test(a);return{literal:!e,val:e?" ":a}}const s=t[n];let r=n;"hour"===n&&(r=null!=t.hour12?t.hour12?"hour12":"hour24":null!=t.hourCycle?"h11"===t.hourCycle||"h12"===t.hourCycle?"hour12":"hour24":i.hour12?"hour12":"hour24");let o=di[r];if("object"==typeof o&&(o=o[s]),o)return{literal:!1,val:o}}(t,e,a)))}const yi="Invalid DateTime",vi=864e13;function bi(e){return new Invalid("unsupported zone",`the zone "${e.name}" is not supported`)}function ki(e){return null===e.weekData&&(e.weekData=ne(e.c)),e.weekData}function wi(e){return null===e.localWeekData&&(e.localWeekData=ne(e.c,e.loc.getMinDaysInFirstWeek(),e.loc.getStartOfWeek())),e.localWeekData}function Si(e,t){const i={ts:e.ts,zone:e.zone,c:e.c,o:e.o,loc:e.loc,invalid:e.invalid};return new DateTime({...i,...t,old:i})}function Ci(e,t,i){let n=e-60*t*1e3;const a=i.offset(n);if(t===a)return[n,t];n-=60*(a-t)*1e3;const s=i.offset(n);return a===s?[n,a]:[e-60*Math.min(a,s)*1e3,Math.max(a,s)]}function Ai(e,t){const i=new Date(e+=60*t*1e3);return{year:i.getUTCFullYear(),month:i.getUTCMonth()+1,day:i.getUTCDate(),hour:i.getUTCHours(),minute:i.getUTCMinutes(),second:i.getUTCSeconds(),millisecond:i.getUTCMilliseconds()}}function xi(e,t,i){return Ci(Ie(e),t,i)}function Ri(e,t){const i=e.o,n=e.c.year+Math.trunc(t.years),a=e.c.month+Math.trunc(t.months)+3*Math.trunc(t.quarters),s={...e.c,year:n,month:a,day:Math.min(e.c.day,Re(n,a))+Math.trunc(t.days)+7*Math.trunc(t.weeks)},r=Duration.fromObject({years:t.years-Math.trunc(t.years),quarters:t.quarters-Math.trunc(t.quarters),months:t.months-Math.trunc(t.months),weeks:t.weeks-Math.trunc(t.weeks),days:t.days-Math.trunc(t.days),hours:t.hours,minutes:t.minutes,seconds:t.seconds,milliseconds:t.milliseconds}).as("milliseconds"),o=Ie(s);let[l,c]=Ci(o,i,e.zone);return 0!==r&&(l+=r,c=e.zone.offset(l)),{ts:l,o:c}}function Ii(e,t,i,n,a,s){const{setZone:r,zone:o}=i;if(e&&0!==Object.keys(e).length||t){const n=t||o,a=DateTime.fromObject(e,{...i,zone:n,specificOffset:s});return r?a:a.setZone(o)}return DateTime.invalid(new Invalid("unparsable",`the input "${a}" can't be parsed as ${n}`))}function Di(e,t,i=!0){return e.isValid?Formatter.create(Locale.create("en-US"),{allowZ:i,forceSimple:!0}).formatDateTimeFromString(e,t):null}function Ti(e,t){const i=e.c.year>9999||e.c.year<0;let n="";return i&&e.c.year>=0&&(n+="+"),n+=be(e.c.year,i?6:4),t?(n+="-",n+=be(e.c.month),n+="-",n+=be(e.c.day)):(n+=be(e.c.month),n+=be(e.c.day)),n}function Mi(e,t,i,n,a,s){let r=be(e.c.hour);return t?(r+=":",r+=be(e.c.minute),0===e.c.millisecond&&0===e.c.second&&i||(r+=":")):r+=be(e.c.minute),0===e.c.millisecond&&0===e.c.second&&i||(r+=be(e.c.second),0===e.c.millisecond&&n||(r+=".",r+=be(e.c.millisecond,3))),a&&(e.isOffsetFixed&&0===e.offset&&!s?r+="Z":e.o<0?(r+="-",r+=be(Math.trunc(-e.o/60)),r+=":",r+=be(Math.trunc(-e.o%60))):(r+="+",r+=be(Math.trunc(e.o/60)),r+=":",r+=be(Math.trunc(e.o%60)))),s&&(r+="["+e.zone.ianaName+"]"),r}const _i={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},$i={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},Ei={ordinal:1,hour:0,minute:0,second:0,millisecond:0},Oi=["year","month","day","hour","minute","second","millisecond"],Li=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],Pi=["year","ordinal","hour","minute","second","millisecond"];function Fi(e){switch(e.toLowerCase()){case"localweekday":case"localweekdays":return"localWeekday";case"localweeknumber":case"localweeknumbers":return"localWeekNumber";case"localweekyear":case"localweekyears":return"localWeekYear";default:return function(e){const t={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[e.toLowerCase()];if(!t)throw new InvalidUnitError(e);return t}(e)}}function ji(e,t){const i=B(t.zone,Settings.defaultZone),n=Locale.fromObject(t),a=Settings.now();let s,r;if(ue(e.year))s=a;else{for(const t of Oi)ue(e[t])&&(e[t]=_i[t]);const t=le(e)||ce(e);if(t)return DateTime.invalid(t);const n=i.offset(a);[s,r]=xi(e,n,i)}return new DateTime({ts:s,zone:i,loc:n,o:r})}function Ui(e,t,i){const n=!!ue(i.round)||i.round,a=(e,a)=>{e=Ce(e,n||i.calendary?0:2,!0);return t.loc.clone(i).relFormatter(i).format(e,a)},s=n=>i.calendary?t.hasSame(e,n)?0:t.startOf(n).diff(e.startOf(n),n).get(n):t.diff(e,n).get(n);if(i.unit)return a(s(i.unit),i.unit);for(const e of i.units){const t=s(e);if(Math.abs(t)>=1)return a(t,e)}return a(e>t?-0:0,i.units[i.units.length-1])}function Ni(e){let t,i={};return e.length>0&&"object"==typeof e[e.length-1]?(i=e[e.length-1],t=Array.from(e).slice(0,e.length-1)):t=Array.from(e),[i,t]}class DateTime{constructor(e){const t=e.zone||Settings.defaultZone;let i=e.invalid||(Number.isNaN(e.ts)?new Invalid("invalid input"):null)||(t.isValid?null:bi(t));this.ts=ue(e.ts)?Settings.now():e.ts;let n=null,a=null;if(!i){if(e.old&&e.old.ts===this.ts&&e.old.zone.equals(t))[n,a]=[e.old.c,e.old.o];else{const e=t.offset(this.ts);n=Ai(this.ts,e),i=Number.isNaN(n.year)?new Invalid("invalid input"):null,n=i?null:n,a=i?null:e}}this._zone=t,this.loc=e.loc||Locale.create(),this.invalid=i,this.weekData=null,this.localWeekData=null,this.c=n,this.o=a,this.isLuxonDateTime=!0}static now(){return new DateTime({})}static local(){const[e,t]=Ni(arguments),[i,n,a,s,r,o,l]=t;return ji({year:i,month:n,day:a,hour:s,minute:r,second:o,millisecond:l},e)}static utc(){const[e,t]=Ni(arguments),[i,n,a,s,r,o,l]=t;return e.zone=FixedOffsetZone.utcInstance,ji({year:i,month:n,day:a,hour:s,minute:r,second:o,millisecond:l},e)}static fromJSDate(e,t={}){const i=(n=e,"[object Date]"===Object.prototype.toString.call(n)?e.valueOf():NaN);var n;if(Number.isNaN(i))return DateTime.invalid("invalid input");const a=B(t.zone,Settings.defaultZone);return a.isValid?new DateTime({ts:i,zone:a,loc:Locale.fromObject(t)}):DateTime.invalid(bi(a))}static fromMillis(e,t={}){if(me(e))return e<-vi||e>vi?DateTime.invalid("Timestamp out of range"):new DateTime({ts:e,zone:B(t.zone,Settings.defaultZone),loc:Locale.fromObject(t)});throw new InvalidArgumentError(`fromMillis requires a numerical input, but received a ${typeof e} with value ${e}`)}static fromSeconds(e,t={}){if(me(e))return new DateTime({ts:1e3*e,zone:B(t.zone,Settings.defaultZone),loc:Locale.fromObject(t)});throw new InvalidArgumentError("fromSeconds requires a numerical input")}static fromObject(e,t={}){e=e||{};const i=B(t.zone,Settings.defaultZone);if(!i.isValid)return DateTime.invalid(bi(i));const n=Locale.fromObject(t),a=Oe(e,Fi),{minDaysInFirstWeek:s,startOfWeek:r}=oe(a,n),o=Settings.now(),l=ue(t.specificOffset)?i.offset(o):t.specificOffset,c=!ue(a.ordinal),u=!ue(a.year),m=!ue(a.month)||!ue(a.day),d=u||m,h=a.weekYear||a.weekNumber;if((d||c)&&h)throw new ConflictingSpecificationError("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(m&&c)throw new ConflictingSpecificationError("Can't mix ordinal dates with month/day");const f=h||a.weekday&&!d;let p,g,y=Ai(o,l);f?(p=Li,g=$i,y=ne(y,s,r)):c?(p=Pi,g=Ei,y=se(y)):(p=Oi,g=_i);let v=!1;for(const e of p){ue(a[e])?a[e]=v?g[e]:y[e]:v=!0}const b=f?function(e,t=4,i=1){const n=de(e.weekYear),a=ve(e.weekNumber,1,Te(e.weekYear,t,i)),s=ve(e.weekday,1,7);return n?a?!s&&X("weekday",e.weekday):X("week",e.weekNumber):X("weekYear",e.weekYear)}(a,s,r):c?function(e){const t=de(e.year),i=ve(e.ordinal,1,xe(e.year));return t?!i&&X("ordinal",e.ordinal):X("year",e.year)}(a):le(a),k=b||ce(a);if(k)return DateTime.invalid(k);const w=f?ae(a,s,r):c?re(a):a,[S,C]=xi(w,l,i),A=new DateTime({ts:S,zone:i,o:C,loc:n});return a.weekday&&d&&e.weekday!==A.weekday?DateTime.invalid("mismatched weekday",`you can't specify both a weekday of ${a.weekday} and a date of ${A.toISO()}`):A}static fromISO(e,t={}){const[i,n]=function(e){return tt(e,[It,_t],[Dt,$t],[Tt,Et],[Mt,Ot])}(e);return Ii(i,n,t,"ISO 8601",e)}static fromRFC2822(e,t={}){const[i,n]=function(e){return tt(function(e){return e.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}(e),[kt,wt])}(e);return Ii(i,n,t,"RFC 2822",e)}static fromHTTP(e,t={}){const[i,n]=function(e){return tt(e,[St,xt],[Ct,xt],[At,Rt])}(e);return Ii(i,n,t,"HTTP",t)}static fromFormat(e,t,i={}){if(ue(e)||ue(t))throw new InvalidArgumentError("fromFormat requires an input string and a format");const{locale:n=null,numberingSystem:a=null}=i,s=Locale.fromOpts({locale:n,numberingSystem:a,defaultToEN:!0}),[r,o,l,c]=function(e,t,i){const{result:n,zone:a,specificOffset:s,invalidReason:r}=pi(e,t,i);return[n,a,s,r]}(s,e,t);return c?DateTime.invalid(c):Ii(r,o,i,`format ${t}`,e,l)}static fromString(e,t,i={}){return DateTime.fromFormat(e,t,i)}static fromSQL(e,t={}){const[i,n]=function(e){return tt(e,[Pt,_t],[Ft,jt])}(e);return Ii(i,n,t,"SQL",e)}static invalid(e,t=null){if(!e)throw new InvalidArgumentError("need to specify a reason the DateTime is invalid");const i=e instanceof Invalid?e:new Invalid(e,t);if(Settings.throwOnInvalid)throw new InvalidDateTimeError(i);return new DateTime({invalid:i})}static isDateTime(e){return e&&e.isLuxonDateTime||!1}static parseFormatForOpts(e,t={}){const i=gi(e,Locale.fromObject(t));return i?i.map((e=>e?e.val:null)).join(""):null}static expandFormat(e,t={}){return fi(Formatter.parseFormat(e),Locale.fromObject(t)).map((e=>e.val)).join("")}get(e){return this[e]}get isValid(){return null===this.invalid}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?ki(this).weekYear:NaN}get weekNumber(){return this.isValid?ki(this).weekNumber:NaN}get weekday(){return this.isValid?ki(this).weekday:NaN}get isWeekend(){return this.isValid&&this.loc.getWeekendDays().includes(this.weekday)}get localWeekday(){return this.isValid?wi(this).weekday:NaN}get localWeekNumber(){return this.isValid?wi(this).weekNumber:NaN}get localWeekYear(){return this.isValid?wi(this).weekYear:NaN}get ordinal(){return this.isValid?se(this.c).ordinal:NaN}get monthShort(){return this.isValid?Info.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?Info.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?Info.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?Info.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return!this.isOffsetFixed&&(this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset)}getPossibleOffsets(){if(!this.isValid||this.isOffsetFixed)return[this];const e=864e5,t=6e4,i=Ie(this.c),n=this.zone.offset(i-e),a=this.zone.offset(i+e),s=this.zone.offset(i-n*t),r=this.zone.offset(i-a*t);if(s===r)return[this];const o=i-s*t,l=i-r*t,c=Ai(o,s),u=Ai(l,r);return c.hour===u.hour&&c.minute===u.minute&&c.second===u.second&&c.millisecond===u.millisecond?[Si(this,{ts:o}),Si(this,{ts:l})]:[this]}get isInLeapYear(){return Ae(this.year)}get daysInMonth(){return Re(this.year,this.month)}get daysInYear(){return this.isValid?xe(this.year):NaN}get weeksInWeekYear(){return this.isValid?Te(this.weekYear):NaN}get weeksInLocalWeekYear(){return this.isValid?Te(this.localWeekYear,this.loc.getMinDaysInFirstWeek(),this.loc.getStartOfWeek()):NaN}resolvedLocaleOptions(e={}){const{locale:t,numberingSystem:i,calendar:n}=Formatter.create(this.loc.clone(e),e).resolvedOptions(this);return{locale:t,numberingSystem:i,outputCalendar:n}}toUTC(e=0,t={}){return this.setZone(FixedOffsetZone.instance(e),t)}toLocal(){return this.setZone(Settings.defaultZone)}setZone(e,{keepLocalTime:t=!1,keepCalendarTime:i=!1}={}){if((e=B(e,Settings.defaultZone)).equals(this.zone))return this;if(e.isValid){let n=this.ts;if(t||i){const t=e.offset(this.ts),i=this.toObject();[n]=xi(i,t,e)}return Si(this,{ts:n,zone:e})}return DateTime.invalid(bi(e))}reconfigure({locale:e,numberingSystem:t,outputCalendar:i}={}){return Si(this,{loc:this.loc.clone({locale:e,numberingSystem:t,outputCalendar:i})})}setLocale(e){return this.reconfigure({locale:e})}set(e){if(!this.isValid)return this;const t=Oe(e,Fi),{minDaysInFirstWeek:i,startOfWeek:n}=oe(t,this.loc),a=!ue(t.weekYear)||!ue(t.weekNumber)||!ue(t.weekday),s=!ue(t.ordinal),r=!ue(t.year),o=!ue(t.month)||!ue(t.day),l=r||o,c=t.weekYear||t.weekNumber;if((l||s)&&c)throw new ConflictingSpecificationError("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(o&&s)throw new ConflictingSpecificationError("Can't mix ordinal dates with month/day");let u;a?u=ae({...ne(this.c,i,n),...t},i,n):ue(t.ordinal)?(u={...this.toObject(),...t},ue(t.day)&&(u.day=Math.min(Re(u.year,u.month),u.day))):u=re({...se(this.c),...t});const[m,d]=xi(u,this.o,this.zone);return Si(this,{ts:m,o:d})}plus(e){if(!this.isValid)return this;return Si(this,Ri(this,Duration.fromDurationLike(e)))}minus(e){if(!this.isValid)return this;return Si(this,Ri(this,Duration.fromDurationLike(e).negate()))}startOf(e,{useLocaleWeeks:t=!1}={}){if(!this.isValid)return this;const i={},n=Duration.normalizeUnit(e);switch(n){case"years":i.month=1;case"quarters":case"months":i.day=1;case"weeks":case"days":i.hour=0;case"hours":i.minute=0;case"minutes":i.second=0;case"seconds":i.millisecond=0}if("weeks"===n)if(t){const e=this.loc.getStartOfWeek(),{weekday:t}=this;t<e&&(i.weekNumber=this.weekNumber-1),i.weekday=e}else i.weekday=1;if("quarters"===n){const e=Math.ceil(this.month/3);i.month=3*(e-1)+1}return this.set(i)}endOf(e,t){return this.isValid?this.plus({[e]:1}).startOf(e,t).minus(1):this}toFormat(e,t={}){return this.isValid?Formatter.create(this.loc.redefaultToEN(t)).formatDateTimeFromString(this,e):yi}toLocaleString(e=s,t={}){return this.isValid?Formatter.create(this.loc.clone(t),e).formatDateTime(this):yi}toLocaleParts(e={}){return this.isValid?Formatter.create(this.loc.clone(e),e).formatDateTimeParts(this):[]}toISO({format:e="extended",suppressSeconds:t=!1,suppressMilliseconds:i=!1,includeOffset:n=!0,extendedZone:a=!1}={}){if(!this.isValid)return null;const s="extended"===e;let r=Ti(this,s);return r+="T",r+=Mi(this,s,t,i,n,a),r}toISODate({format:e="extended"}={}){return this.isValid?Ti(this,"extended"===e):null}toISOWeekDate(){return Di(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:e=!1,suppressSeconds:t=!1,includeOffset:i=!0,includePrefix:n=!1,extendedZone:a=!1,format:s="extended"}={}){if(!this.isValid)return null;return(n?"T":"")+Mi(this,"extended"===s,t,e,i,a)}toRFC2822(){return Di(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return Di(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?Ti(this,!0):null}toSQLTime({includeOffset:e=!0,includeZone:t=!1,includeOffsetSpace:i=!0}={}){let n="HH:mm:ss.SSS";return(t||e)&&(i&&(n+=" "),t?n+="z":e&&(n+="ZZ")),Di(this,n,!0)}toSQL(e={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(e)}`:null}toString(){return this.isValid?this.toISO():yi}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`DateTime { ts: ${this.toISO()}, zone: ${this.zone.name}, locale: ${this.locale} }`:`DateTime { Invalid, reason: ${this.invalidReason} }`}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(e={}){if(!this.isValid)return{};const t={...this.c};return e.includeConfig&&(t.outputCalendar=this.outputCalendar,t.numberingSystem=this.loc.numberingSystem,t.locale=this.loc.locale),t}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(e,t="milliseconds",i={}){if(!this.isValid||!e.isValid)return Duration.invalid("created by diffing an invalid DateTime");const n={locale:this.locale,numberingSystem:this.numberingSystem,...i},a=(o=t,Array.isArray(o)?o:[o]).map(Duration.normalizeUnit),s=e.valueOf()>this.valueOf(),r=Xt(s?this:e,s?e:this,a,n);var o;return s?r.negate():r}diffNow(e="milliseconds",t={}){return this.diff(DateTime.now(),e,t)}until(e){return this.isValid?Interval.fromDateTimes(this,e):this}hasSame(e,t,i){if(!this.isValid)return!1;const n=e.valueOf(),a=this.setZone(e.zone,{keepLocalTime:!0});return a.startOf(t,i)<=n&&n<=a.endOf(t,i)}equals(e){return this.isValid&&e.isValid&&this.valueOf()===e.valueOf()&&this.zone.equals(e.zone)&&this.loc.equals(e.loc)}toRelative(e={}){if(!this.isValid)return null;const t=e.base||DateTime.fromObject({},{zone:this.zone}),i=e.padding?this<t?-e.padding:e.padding:0;let n=["years","months","days","hours","minutes","seconds"],a=e.unit;return Array.isArray(e.unit)&&(n=e.unit,a=void 0),Ui(t,this.plus(i),{...e,numeric:"always",units:n,unit:a})}toRelativeCalendar(e={}){return this.isValid?Ui(e.base||DateTime.fromObject({},{zone:this.zone}),this,{...e,numeric:"auto",units:["years","months","days"],calendary:!0}):null}static min(...e){if(!e.every(DateTime.isDateTime))throw new InvalidArgumentError("min requires all arguments be DateTimes");return pe(e,(e=>e.valueOf()),Math.min)}static max(...e){if(!e.every(DateTime.isDateTime))throw new InvalidArgumentError("max requires all arguments be DateTimes");return pe(e,(e=>e.valueOf()),Math.max)}static fromFormatExplain(e,t,i={}){const{locale:n=null,numberingSystem:a=null}=i;return pi(Locale.fromOpts({locale:n,numberingSystem:a,defaultToEN:!0}),e,t)}static fromStringExplain(e,t,i={}){return DateTime.fromFormatExplain(e,t,i)}static get DATE_SHORT(){return s}static get DATE_MED(){return r}static get DATE_MED_WITH_WEEKDAY(){return o}static get DATE_FULL(){return l}static get DATE_HUGE(){return c}static get TIME_SIMPLE(){return u}static get TIME_WITH_SECONDS(){return m}static get TIME_WITH_SHORT_OFFSET(){return d}static get TIME_WITH_LONG_OFFSET(){return h}static get TIME_24_SIMPLE(){return f}static get TIME_24_WITH_SECONDS(){return p}static get TIME_24_WITH_SHORT_OFFSET(){return g}static get TIME_24_WITH_LONG_OFFSET(){return y}static get DATETIME_SHORT(){return v}static get DATETIME_SHORT_WITH_SECONDS(){return b}static get DATETIME_MED(){return k}static get DATETIME_MED_WITH_SECONDS(){return w}static get DATETIME_MED_WITH_WEEKDAY(){return S}static get DATETIME_FULL(){return C}static get DATETIME_FULL_WITH_SECONDS(){return A}static get DATETIME_HUGE(){return x}static get DATETIME_HUGE_WITH_SECONDS(){return R}}function Bi(e){if(DateTime.isDateTime(e))return e;if(e&&e.valueOf&&me(e.valueOf()))return DateTime.fromJSDate(e);if(e&&"object"==typeof e)return DateTime.fromObject(e);throw new InvalidArgumentError(`Unknown datetime argument: ${e}, of type ${typeof e}`)}t.DateTime=DateTime,t.Duration=Duration,t.FixedOffsetZone=FixedOffsetZone,t.IANAZone=IANAZone,t.Info=Info,t.Interval=Interval,t.InvalidZone=InvalidZone,t.Settings=Settings,t.SystemZone=SystemZone,t.VERSION="3.4.4",t.Zone=Zone},4710:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.armyStatisticsByLevel=void 0;t.armyStatisticsByLevel=new Map,[{level:1,scouting:7,standardDC:15,ac:16,highSave:10,lowSave:4,attack:9,maximumTactics:1},{level:2,scouting:8,standardDC:16,ac:18,highSave:11,lowSave:5,attack:11,maximumTactics:1},{level:3,scouting:9,standardDC:18,ac:19,highSave:12,lowSave:6,attack:12,maximumTactics:1},{level:4,scouting:11,standardDC:19,ac:21,highSave:14,lowSave:8,attack:14,maximumTactics:2},{level:5,scouting:12,standardDC:20,ac:22,highSave:15,lowSave:9,attack:15,maximumTactics:2},{level:6,scouting:14,standardDC:22,ac:24,highSave:17,lowSave:11,attack:17,maximumTactics:2},{level:7,scouting:15,standardDC:23,ac:25,highSave:18,lowSave:12,attack:18,maximumTactics:2},{level:8,scouting:16,standardDC:24,ac:27,highSave:19,lowSave:13,attack:20,maximumTactics:3},{level:9,scouting:18,standardDC:26,ac:28,highSave:21,lowSave:15,attack:21,maximumTactics:3},{level:10,scouting:19,standardDC:27,ac:30,highSave:22,lowSave:16,attack:23,maximumTactics:3},{level:11,scouting:21,standardDC:28,ac:31,highSave:24,lowSave:18,attack:24,maximumTactics:3},{level:12,scouting:22,standardDC:30,ac:33,highSave:25,lowSave:19,attack:26,maximumTactics:4},{level:13,scouting:23,standardDC:31,ac:34,highSave:26,lowSave:20,attack:27,maximumTactics:4},{level:14,scouting:25,standardDC:32,ac:36,highSave:28,lowSave:22,attack:29,maximumTactics:4},{level:15,scouting:26,standardDC:34,ac:37,highSave:29,lowSave:23,attack:30,maximumTactics:4},{level:16,scouting:28,standardDC:35,ac:39,highSave:30,lowSave:25,attack:32,maximumTactics:5},{level:17,scouting:29,standardDC:36,ac:40,highSave:32,lowSave:26,attack:33,maximumTactics:5},{level:18,scouting:30,standardDC:38,ac:42,highSave:33,lowSave:27,attack:35,maximumTactics:5},{level:19,scouting:32,standardDC:39,ac:43,highSave:35,lowSave:29,attack:36,maximumTactics:5},{level:20,scouting:33,standardDC:40,ac:45,highSave:36,lowSave:30,attack:38,maximumTactics:6}].forEach((e=>t.armyStatisticsByLevel.set(e.level,e)))},6459:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.armySetupDialog=void 0;const n=i(8593);t.armySetupDialog=function(e){new Dialog({title:`Enable Army: ${e.actor.name}`,content:`\n        <p>Do you want to turn actor ${e.actor.name} into an army? If so, you need \n        to manually create its attacks. After this dialog, change into its inventory and click on the \n        <i class="fa-solid fa-bolt fa-fw"></i> next to its weapon.</p>\n        <form class="simple-dialog-form">\n            <div>\n                <label for="km-army-type">Army Type:</label>\n                <select name="type" id="km-army-type">\n                    <option value="Infantry">Infantry</option>\n                    <option value="Skirmisher">Skirmisher</option>\n                    <option value="Cavalry">Cavalry</option>\n                    <option value="Siege">Siege</option>\n                </select>\n            </div>\n            <div>\n                <label for="km-army-weapon-type-melee">Melee Weapons?</label>\n                <input type="checkbox" name="weapon-type-melee" id="km-army-weapon-type-melee">\n            </div>\n            <div>\n                <label for="km-army-weapon-type-ranged">Ranged Weapons?</label>\n                <input type="checkbox" name="weapon-type-ranged" id="km-army-weapon-type-ranged">\n            </div>\n        </form>\n        `,buttons:{no:{icon:'<i class="fa-solid fa-cancel"></i>',label:"No",callback:async()=>{}},yes:{icon:'<i class="fa-solid fa-check"></i>',label:"Yes",callback:async t=>{const i=t,a=(0,n.parseSelect)(i,"type"),s=(0,n.parseCheckbox)(i,"weapon-type-melee"),r=[...(0,n.parseCheckbox)(i,"weapon-type-ranged")?["Compendium.pf2e-kingmaker-tools.kingmaker-tools-army-gear.Item.osC5Z0FdEU47WAqp","Compendium.pf2e-kingmaker-tools.kingmaker-tools-army-gear.Item.UAYsXm698g1iyC2v"]:[],...s?["Compendium.pf2e-kingmaker-tools.kingmaker-tools-army-gear.Item.hIjD8V24RKLlIV2N"]:[]];await e.onConfirm(r,a)}}},default:"no"},{jQuery:!1,width:250}).render(!0)}},3238:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.disableArmyDialog=void 0,t.disableArmyDialog=function(e){new Dialog({title:`Disable Army: ${e.actor.name}`,content:`\n        <p>Do you want to delete all army data and remove army sync from actor ${e.actor.name}?</p>\n        `,buttons:{no:{icon:'<i class="fa-solid fa-cancel"></i>',label:"No",callback:async()=>{}},yes:{icon:'<i class="fa-solid fa-trash"></i>',label:"Yes",callback:async()=>{await e.onYes()}}},default:"no"},{jQuery:!1,width:250}).render(!0)}},2293:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateAmmunition=t.onPostUpdateArmy=t.onCreateArmyItem=t.onPreUpdateArmy=void 0;const n=i(6812),a=i(8593),s=i(1252);function r({data:e,actor:t,game:i,callback:s}){const r=e?.system?.details?.level?.value,o=(0,n.getArmyAdjustment)(t);return(0,a.isFirstGm)(i)&&"npc"===t.type&&void 0!==o&&void 0!==r&&r>=1&&r<=20?s(t,e,r,o):null}t.onPreUpdateArmy=async function(e,t,i){r({data:i,actor:t,game:e,callback:(e,i,n,a)=>{(0,s.addArmyStats)(t,i,n,a)}})},t.onCreateArmyItem=async function(e,t){const i=t.actor;r({data:{system:{details:{level:{value:i.system.details.level.value}}}},actor:i,game:e,callback:async(e,i,n,a)=>{await(0,s.addAttackModifiers)(e,t,n,a)}})},t.onPostUpdateArmy=async function(e,t,i){await r({data:i,actor:t,game:e,callback:async(e,t,i,n)=>{await(0,s.syncAttackModifiers)(e,i,n)}})},t.updateAmmunition=async function(e,t,i){if(0===t.round&&1===i.round&&(0,a.isFirstGm)(e)){const e=t.combatants.map((e=>e.actor)).filter((e=>null!==e&&"npc"===e.type));for(const t of e){const e=(0,n.getArmyAdjustment)(t);if(void 0!==e){const i=t.itemTypes.equipment.find((e=>"Ammunition"===e.name)),n=(0,s.calculateArmyAdjustments)(t,t.level,e).ammunition;i&&await i.update({"system.quantity":n})}}}}},220:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.editArmyStatistics=void 0;const n=i(1252),a=i(6812),s=i(3238),r=i(6459),o=i(4848);class ArmySheet extends FormApplication{static get defaultOptions(){const e=super.defaultOptions;return e.id="army-app",e.title="Army",e.template="modules/pf2e-kingmaker-tools/templates/army/sheet.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=["kingmaker-tools-app","army-app"],e.width=450,e.height="auto",e.scrollY=[".km-content",".km-sidebar"],e}actor;game;constructor(e,t){super(e,t),this.game=t.game,this.actor=t.actor,this.actor.apps[this.appId]=this}async getData(){const e=(0,a.getArmyAdjustment)(this.actor),t=this.actor.system.details.level.value;return{adjustments:e,actorLevel:t,calculated:(0,n.calculateArmyAdjustments)(this.actor,t,e)}}async _updateObject(e,t){const i=expandObject(t);console.log("form",t);const n={melee:i.adjustments?.melee??0,ac:i.adjustments?.ac??0,maneuver:i.adjustments?.maneuver??0,morale:i.adjustments?.morale??0,scouting:i.adjustments?.scouting??0,ranged:i.adjustments?.ranged??0,recruitmentDC:i.adjustments?.recruitmentDC??0,ammunition:i.adjustments?.ammunition??0,highSave:i.adjustments?.highSave??"maneuver"};await(0,a.saveArmyAdjustment)(this.actor,n)}activateListeners(e){super.activateListeners(e)}_getHeaderButtons(){const e=super._getHeaderButtons();return this.game.user?.isGM&&(e.unshift({label:"Help",class:"something-made-up-help",icon:"fas fa-question",onclick:()=>(0,o.openJournal)("Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.iAQCUYEAq4Dy8uCY.JournalEntryPage.5lizPMtMY3ZILDK6")}),e.unshift({label:"Disable",class:"something-made-up-disable",icon:"fas fa-trash",onclick:()=>(0,s.disableArmyDialog)({actor:this.actor,onYes:async()=>{await this.close(),await this.actor.unsetFlag("pf2e-kingmaker-tools","army-adjustment")}})})),e}}t.editArmyStatistics=async function e(t,i){i&&"npc"===i.type?void 0===(0,a.getArmyAdjustment)(i)?(0,r.armySetupDialog)({actor:i,onConfirm:async(s,r)=>{await async function(e,t,i){const s=(await Promise.all(["Compendium.pf2e-kingmaker-tools.kingmaker-tools-army-actions.Item.59vwuUVFAEs0yfKt","Compendium.pf2e-kingmaker-tools.kingmaker-tools-army-actions.Item.qNxyZfS4Ald098Gy","Compendium.pf2e-kingmaker-tools.kingmaker-tools-army-actions.Item.21aSK6Dh0FpcdWbb","Compendium.pf2e-kingmaker-tools.kingmaker-tools-army-actions.Item.wfy7fmnnhlJ66Gfz","Compendium.pf2e-kingmaker-tools.kingmaker-tools-army-actions.Item.kKnpTt39LwP8uUvf","Compendium.pf2e-kingmaker-tools.kingmaker-tools-army-actions.Item.D680ctCFIpsmz82i","Compendium.pf2e-kingmaker-tools.kingmaker-tools-army-actions.Item.SfLoAnZ1O19OTLQo",...t].map((e=>fromUuid(e))))).map((e=>e.toObject()));return await e.createEmbeddedDocuments("Item",s),await e.update({"system.details.blurb":i}),await(0,a.saveArmyAdjustment)(e,(0,n.getDefaultArmyAdjustment)()),(0,a.getArmyAdjustment)(e)}(i,s,r),await e(t,i)}}):new ArmySheet(null,{game:t,actor:i}).render(!0):ui.notifications?.error("Please select an NPC token")}},6812:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getArmyAdjustment=t.saveArmyAdjustment=void 0;const n=i(1252);function a(e){return e.getFlag("pf2e-kingmaker-tools","army-adjustment")}t.saveArmyAdjustment=async function(e,t){console.info("Saving",t),await e.setFlag("pf2e-kingmaker-tools","army-adjustment",t);const i=a(e),s=e.system.details.level.value,r={};(0,n.addArmyStats)(e,r,s,i),await e.update(r),await(0,n.syncAttackModifiers)(e,s,i)},t.getArmyAdjustment=a},1252:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateTotalArmyConsumption=t.updateKingdomArmyConsumption=t.calculateArmyAdjustments=t.addArmyStats=t.syncAttackModifiers=t.addAttackModifiers=t.getDefaultArmyAdjustment=void 0;const n=i(4710),a=i(6812),s=i(7066),r=i(4310),o=i(8593);function l(e){return"ranged"===e.system?.weaponType?.value}function c(e,t,i){const a=n.armyStatisticsByLevel.get(t)??n.armyStatisticsByLevel.get(1),s="maneuver"===i.highSave?a.highSave:a.lowSave,r="morale"===i.highSave?a.highSave:a.lowSave,o=e.itemTypes.action.filter((e=>e.name.startsWith("Increased Ammunition"))).length;return{ac:a.ac+i.ac,recruitmentDC:a.standardDC+i.recruitmentDC,melee:a.attack+i.melee,ranged:a.attack+i.ranged,maneuver:s+i.maneuver,scouting:a.scouting+i.scouting,morale:r+i.morale,highSave:i.highSave,ammunition:5+i.ammunition+2*o}}function u(e){const t=[],i=[];return e?.scenes?.map((e=>e.tokens))?.forEach((e=>{e.forEach((e=>{const t=e.actor;t&&!e.hidden&&t.hasPlayerOwner&&i.push(t)}))})),(0,o.distinctBy)(i,(e=>e.uuid)).forEach((e=>{"army"===e.type?t.push(e.system.consumption):void 0!==(0,a.getArmyAdjustment)(e)&&t.push(e.abilities.con.mod)})),(0,o.sum)(t)}t.getDefaultArmyAdjustment=function(){return{ac:0,melee:0,morale:0,maneuver:0,scouting:0,recruitmentDC:0,ranged:0,highSave:"maneuver",ammunition:0}},t.addAttackModifiers=async function(e,t,i,n){if("melee"===t.type){const a=c(e,i,n),s={system:{bonus:{value:l(t)?a.ranged:a.melee}}};await t.update(s)}},t.syncAttackModifiers=async function(e,t,i){const n=c(e,t,i),a=e.items.filter((e=>"melee"===e.type)).map((e=>{const t=l(e)?n.ranged:n.melee;return{_id:e.id,"system.bonus.value":t}}));console.log("onactorupdate",a),await e.updateEmbeddedDocuments("Item",a)},t.addArmyStats=function(e,t,i,n){const a=c(e,i,n),s={system:{saves:{reflex:{value:a.maneuver},will:{value:a.morale},fortitude:{value:a.recruitmentDC}},attributes:{ac:{value:a.ac}},perception:{mod:a.scouting}}};foundry.utils.mergeObject(t,s)},t.calculateArmyAdjustments=c,t.updateKingdomArmyConsumption=async function({actor:e=null,kingdomActor:t,game:i,forceUpdate:n=!1}){(0,r.getBooleanSetting)(i,"autoCalculateArmyConsumption")&&t&&(n||function(e){return"npc"===e?.type&&void 0!==(0,a.getArmyAdjustment)(e)||"army"===e?.type}(e))&&await(0,s.saveKingdom)(t,{consumption:{armies:Math.max(u(i),0)}})},t.calculateTotalArmyConsumption=u},2977:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.huntAndGather=t.addIngredientsToActor=t.addToInventory=t.getHuntAndGatherQuantities=t.allCampingActivities=t.allCompanionNames=t.allCampingActivityNames=void 0;const n=i(8063),a=i(8593),s=i(4693),r=i(9540),o=i(1060);async function l(e,t,i){return e===n.DegreeOfSuccess.CRITICAL_SUCCESS?{basicIngredients:2*t,specialIngredients:i>=14?12:i>=7?8:4,rations:0}:e===n.DegreeOfSuccess.SUCCESS?{basicIngredients:t,specialIngredients:await(0,a.roll)((i>=14?3:i>=7?2:1)+"d4","Special Ingredients"),rations:0}:e===n.DegreeOfSuccess.FAILURE?{basicIngredients:t,specialIngredients:0,rations:0}:{basicIngredients:await(0,a.roll)("1d4","Basic Ingredients"),specialIngredients:0,rations:0}}async function c(e,t,i){if(i>0){const n=(await fromUuid(t))?.toObject();if((0,o.isConsumableItem)(n)&&n.system.uses.max>0){const e=n.system.uses.max;n.system.quantity=Math.ceil(i/e),n.system.uses.value=i%e}else n.system.quantity=i;await e.addToInventory(n,void 0,!1)}}t.allCampingActivityNames=["Prepare Campsite","Camouflage Campsite","Cook Meal","Discover Special Meal","Hunt and Gather","Learn from a Companion","Organize Watch","Tell Campfire Story","Blend Into The Night","Bolster Confidence","Camp Management","Dawnflower's Blessing","Enhance Campfire","Enhance Weapons","Intimidating Posture","Maintain Armor","Set Alarms","Set Traps","Undead Guardians","Water Hazards","Wilderness Survival","Influence Amiri","Discover Amiri","Influence Ekundayo","Discover Ekundayo","Influence Jubilost","Discover Jubilost","Influence Linzi","Discover Linzi","Influence Nok-Nok","Discover Nok-Nok","Influence Tristian","Discover Tristian","Influence Valerie","Discover Valerie","Influence Harrim","Discover Harrim","Influence Jaethal","Discover Jaethal","Influence Kalikke","Discover Kalikke","Influence Kanerah","Discover Kanerah","Influence Octavia","Discover Octavia","Influence Regongar","Discover Regongar"],t.allCompanionNames=["Amiri","Ekundayo","Jubilost","Linzi","Nok-Nok","Tristian","Valerie","Harrim","Jaethal","Kalikke","Kanerah","Octavia","Regongar"],t.allCampingActivities=[{name:"Camouflage Campsite",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.mlLCjokti3RXAlUP",isLocked:!1,isSecret:!0,dc:"zone",skillRequirements:[{skill:"stealth",proficiency:"trained"}],skills:["stealth"],criticalSuccess:{message:"Your camouflage attempt exceeds expectation. Increase the Encounter DC for your camp by 2. The first time a flat check would result in an encounter during this camping session, instead treat that result as a failure with no encounter.",modifyRandomEncounterDc:{day:2,night:2}},success:{message:"Your work helps hide your camp from detection. Increase the Encounter DC for your camp by 1.",modifyRandomEncounterDc:{day:1,night:1}},criticalFailure:{message:"You believe you’ve done well at your camouflage attempt but have actually forgotten something important or accidentally did something to make the campsite more noticeable. Decrease the Encounter DC for your camp by 2, and flat checks made to determine encounters result in a critical success on a roll of 19 or 20.",modifyRandomEncounterDc:{day:-2,night:-2}}},{name:"Cook Meal",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.S72BNBTfKfkCjriU",isLocked:!1,isSecret:!1,skillRequirements:[],skills:[],criticalSuccess:{message:"The character gains the recipe’s listed critical success effect."},success:{message:"The character gains the recipe’s listed success effect."},failure:{message:"The character gains no special benefit from the meal, though it still prevents starvation."},criticalFailure:{message:"The character suffers the recipe’s critical failure effect."}},{name:"Discover Special Meal",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.5I8jnFjirbbIUkGy",isLocked:!1,isSecret:!1,dc:"zone",skillRequirements:[{skill:"cooking",proficiency:"trained"}],skills:["cooking"],criticalSuccess:{message:"You discover the special meal and add it to the list of recipes the party knows. In addition, your research was efficient, and you recover half of the ingredients you had to expend to attempt this activity."},success:{message:"As critical success, but you do not recover any ingredients."},failure:{message:"You fail to discover the special meal and do not recover any ingredients."},criticalFailure:{message:"As failure, but you also expose yourself to the special meal’s critical failure effect while performing an unwise taste test."}},{name:"Hunt and Gather",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.RujdVNvLpoQBBdVV",isLocked:!1,isSecret:!1,dc:"zone",skillRequirements:[{skill:"survival",proficiency:"trained"}],skills:["survival","hunting"],criticalSuccess:{message:"You find a number of Basic Ingredients equal to twice the zone’s DC, plus 4 Special Ingredients. If you’re Hunting and Gathering in a zone that’s at least level 7, increase the number of special ingredients found to 8; if you’re doing so in a zone that’s at least level 14, increase it to 12."},success:{message:"You find a number of Basic Ingredients equal to the zone’s DC, plus [[/r 1d4]] Special Ingredients. If you’re Hunting and Gathering in a zone that’s at least level 7, increase the number of special ingredients found to [[/r 2d4]]; if you’re doing so in a zone that’s at least level 14, increase it to [[/r 3d4]]."},failure:{message:"You find a number of Basic Ingredients equal to the zone’s DC."},criticalFailure:{message:"You find [[/r 1d4]] Basic Ingredients (maximum equal to the zone’s DC). In addition, you’ve attracted attention. Make an additional flat check to determine if a random encounter occurs at your campsite following this activity.",checkRandomEncounter:!0}},{name:"Learn from a Companion",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.MyeB2g0yDwEsqfI9",isLocked:!0,isSecret:!1,dc:20,skillRequirements:[],skills:["perception"],criticalSuccess:{message:"You learn the companion’s special activity. Any PC who meets that activity’s requirements (see table above) can now perform that activity even when the companion isn’t in the camp."},success:{message:"You make progress in learning the special activity but require at least one more day to master it. If you attempt to Learn from this Companion the next time you camp, the result of that check is improved by one degree of success from the result rolled."},failure:{message:"You fail to learn anything from the companion."},criticalFailure:{message:"You fail to learn from the companion, who grows frustrated with the party. No further attempts to Learn from this Companion can be attempted during this camping session."}},{name:"Organize Watch",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.wgyPZBRgPjTeK0Ch",isLocked:!1,isSecret:!1,dc:"zone",skillRequirements:[{skill:"perception",proficiency:"expert"}],skills:["perception"],criticalSuccess:{message:"The camp’s watch is efficient. Treat the total time required for rest as if the party size were 1 more, and all characters gain a +2 status bonus to Perception checks made during their shift on watch.",effectUuids:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.010XlkzzjX38BHsO"}]},success:{message:"Characters gain a +1 status bonus to Perception checks made during their shift on watch.",effectUuids:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.MOXWga7l8dsypUPy"}]},failure:{message:"Your attempt to organize the watch doesn’t grant any additional benefits."},criticalFailure:{message:"As failure, but you may have attracted unwanted attention. Attempt a flat check against the zone’s Encounter DC to determine if a random encounter occurs.",checkRandomEncounter:!0}},{name:"Tell Campfire Story",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.XaKD1oGTAgZUjlQ5",isLocked:!1,isSecret:!1,dc:"actorLevel",skillRequirements:[],skills:["performance"],criticalSuccess:{message:"You inspire your allies dramatically. For the remainder of the camping session, your allies gain a +2 status bonus to attack rolls, saving throws, and skill checks during combat at the campsite. The bonuses end as soon as daily preparations begin after resting is concluded. If an ally spent the hour Relaxing, they can also choose to reroll a failed roll at any time once during the remainder of the camping session while the status bonus persists; this is a fortune effect.",effectUuids:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.2vdskbqd0VrWKR9Y",target:"allies"}]},success:{message:"You inspire your allies dramatically. For the remainder of the camping session, your allies gain a +1 status bonus to attack rolls, saving throws, and skill checks during combat at the campsite. The bonuses end as soon as daily preparations begin after resting is concluded. An ally who spent the hour Relaxing receives a +2 status bonus.",effectUuids:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.wT2NzrfgmWmCMRtv",target:"allies"}]},failure:{message:"Your allies are unmoved and receive no benefits."},criticalFailure:{message:"Your story distracts or unsettles your allies. They each take a –1 status penalty to skill checks until they Relax or until they begin daily preparations.",effectUuids:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.y5Jqw40SWNOgcxvC",target:"allies"}]}},...t.allCompanionNames.flatMap((e=>[{name:`Influence ${e}`,journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.D83mNy8bYqKULEnu",isLocked:!0,isSecret:!1,skillRequirements:[],skills:"any",criticalSuccess:{message:`You gain 2 Influence Points with ${e}`},success:{message:`You gain 1 Influence Points with ${e}`},failure:{message:`You gain no Influence Points with ${e}`},criticalFailure:{message:`You lose 1 Influence Points with ${e}`}},{name:`Discover ${e}`,journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.nCwES51tV7FmrfCN",isLocked:!0,isSecret:!0,skillRequirements:[],skills:"any",criticalSuccess:{message:`Choose two of the following: You learn which skill that can Influence ${e} has the lowest DC (skipping any skills that you already know), one of ${e}’s personal biases, one of ${e}’s resistances, or one of ${e}’s weaknesses. you can choose the same option twice to learn two pieces of information from the same category.`},success:{message:`Choose one of the following: You learn which skill that can Influence ${e} has the lowest DC (skipping any skills that you already know), one of ${e}’s personal biases, one of ${e}’s resistances, or one of ${e}’s weaknesses.`},failure:{message:"You learn no information."},criticalFailure:{message:`Choose a piece of information to learn about, as success, but the information is incorrect. For instance, you might think ${e} is susceptible to flattery when actually ${e} is resistant to flattery.`}}])),{name:"Blend Into The Night",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.jz1FI7zSoPLR8iBL",isLocked:!0,isSecret:!1,skillRequirements:[],skills:[],modifyRandomEncounterDc:{day:0,night:2}},{name:"Bolster Confidence",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.pxHYFLK7VYGppCzS",isLocked:!0,isSecret:!1,skillRequirements:[],skills:[],effectUuids:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.mAEvnTqFuLIASQLB"}]},{name:"Camp Management",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.JRScwsFTXTpTwWYA",isLocked:!0,isSecret:!1,dc:"zone",skillRequirements:[],skills:["survival"],criticalSuccess:{message:"During the hour immediately following this critical success, each PC may attempt two Camping activities instead of one. This success does not increase the number of activities companions may attempt."},success:{message:"During the hour immediately following this critical success, one PC may attempt two Camping activities instead of one. This success does not increase the number of activities companions may attempt."},criticalFailure:{message:"All checks made to resolve Camping activities take a –2 circumstance penalty for the remainder of this camping session.",effectUuids:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.vpH13xgAqX4zsU6o"}]}},{name:"Dawnflower's Blessing",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.X4ggcXUe0wPiW4jt",isLocked:!0,isSecret:!1,skillRequirements:[],skills:[],effectUuids:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.eaWmjDOIvUF9aDbq"}]},{name:"Enhance Campfire",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.ytyW9F39m7xf0gx5",isLocked:!0,isSecret:!1,skillRequirements:[],skills:[],effectUuids:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.NFPQHxvpJd2vsKMe"}]},{name:"Enhance Weapons",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.2Dn89HrY7gyvQiOH",isLocked:!0,isSecret:!1,skillRequirements:[],skills:[]},{name:"Intimidating Posture",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.LhhERalHv4QA14fQ",isLocked:!0,isSecret:!1,skillRequirements:[],skills:[]},{name:"Maintain Armor",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.zUaeA8Ud9dv3hhnc",isLocked:!0,isSecret:!1,skillRequirements:[],skills:[]},{name:"Set Alarms",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.vWSQmYLKlrk3rLDE",isLocked:!0,isSecret:!1,skillRequirements:[],skills:[],effectUuids:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.ptjs54eoEX8EAQNq"}]},{name:"Set Traps",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.5ynOh085kwNp75t4",isLocked:!0,isSecret:!1,skillRequirements:[],skills:[]},{name:"Undead Guardians",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.YzOixXzCwfXOBjtx",isLocked:!0,isSecret:!1,skillRequirements:[],skills:[]},{name:"Water Hazards",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.HGcwmsfjVqfLeYhu",isLocked:!0,isSecret:!1,skillRequirements:[],skills:[]},{name:"Wilderness Survival",journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.8PNH77YHVkw9KoAv",isLocked:!0,isSecret:!1,dc:"zone",skillRequirements:[],skills:[],effectUuids:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.v9i9W49PeJ9NkfXX"}]},{name:"Prepare Campsite",dc:"zone",skills:["survival"],skillRequirements:[],isSecret:!1,journalUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.uSTTCqRYCWj7a38F.JournalEntryPage.Iuen7iSvZAlnAJFB",isLocked:!1,criticalSuccess:{message:"Prepare Campsite: You find the perfect spot for a camp. Flat checks to determine encounters at the campsite for the next 24 hours have a DC 2 higher than normal, and the first 2 hours spent performing Camping activities does not incur the usual flat check for random encounters.",modifyRandomEncounterDc:{day:2,night:2}},success:{message:"Prepare Campsite: You find a serviceable spot for a camp and for Camping activities."},failure:{message:"Prepare Campsite: Your campsite will work, but it’s not the best. Campsite activities that require checks take a –2 penalty.",effectUuids:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.X1OvR5j1cAXZ4Lbp"}]},criticalFailure:{message:"Prepare Campsite: Your campsite is a mess. You can use it to rest and to perform daily preparations, but it isn’t good enough to allow for Campsite activities at all. Worse, your attempt to secure a campsite has possibly attracted unwanted attention—attempt a flat check against the zone’s Encounter DC. If successful, a random encounter automatically occurs.",checkRandomEncounter:!0}}],t.getHuntAndGatherQuantities=l,t.addToInventory=c,t.addIngredientsToActor=async function(e,t){await c(e,s.basicIngredientUuid,t.basicIngredients),await c(e,s.specialIngredientUuid,t.specialIngredients),await c(e,s.rationUuid,t.rations)},t.huntAndGather=async function(e,t,i,n){const{zoneDC:a,zoneLevel:s}=(0,r.getRegionInfo)(e,n);return await l(i,a,s)}},1060:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removeActorsEffectsByName=t.removeActorsEffectsByUuid=t.getEffectsByUuid=t.getEffectByUuid=t.getItemsByUuid=t.getItemByUuid=t.getActorsByUuid=t.getActorByUuid=t.hasCookingLore=t.getSkill=t.satisfiesSkillProficiency=t.validateSkillProficiencies=t.NotProficientError=t.proficiencyToRank=t.hasItemByUuid=t.getConsumablesByUuid=t.actorHasEffectByUuid=t.getActorEffectsByUuid=t.isConsumableItem=t.isEffectItem=t.getActorItemsByUuid=void 0;const n=i(8593);function a(e,t,i){return e.itemTypes[t].filter((e=>i.has(e.name)))}async function s(e,t,i){const n=await async function(e){const t=(await Promise.all(Array.from(e).map((e=>fromUuid(e))))).filter((e=>null!==e)).filter((e=>null!=e)).map((e=>e.name));return new Set(t)}(i);return a(e,t,n)}function r(e){return"effect"===e.type}function o(e){return"consumable"===e.type}async function l(e,t){return(await s(e,"effect",t)).filter(r)}function c(e){return"trained"===e?1:"expert"===e?2:"master"===e?3:4}t.getActorItemsByUuid=s,t.isEffectItem=r,t.isConsumableItem=o,t.getActorEffectsByUuid=l,t.actorHasEffectByUuid=async function(e,t){return(await l(e,new Set([t]))).length>0},t.getConsumablesByUuid=async function(e,t){return(await s(e,"consumable",t)).filter(o)},t.hasItemByUuid=async function(e,t,i){return(await s(e,t,i)).length>0},t.proficiencyToRank=c;class NotProficientError extends Error{}async function u(e,t,i){const n=await m(e,t),a=c(i);return!!n&&n.rank>=a}async function m(e,t){const i=e.skills,n=`${t}-lore`;return"perception"===t?e.perception:t in i?i[t]:n in i?i[n]:null}async function d(e){const t=await fromUuid(e);return t instanceof Actor?t:null}async function h(e){const t=await fromUuid(e);return t instanceof Item?t:null}async function f(e){return(await Promise.all(Array.from(e).map((e=>h(e))))).filter((e=>null!==e))}t.NotProficientError=NotProficientError,t.validateSkillProficiencies=async function(e,t){for(const i of t){const t=i.skill,a=i.proficiency;if(!await u(e,t,a)){const i=e.name;throw new NotProficientError(`${i} requires at least ${(0,n.capitalize)(a)} in ${(0,n.unslugify)(t)}`)}}},t.satisfiesSkillProficiency=u,t.getSkill=m,t.hasCookingLore=async function(e){const t=await fromUuid(e);return!!t&&null!==await m(t,"cooking")},t.getActorByUuid=d,t.getActorsByUuid=async function(e){return(await Promise.all(Array.from(e).map((e=>d(e))))).filter((e=>null!==e))},t.getItemByUuid=h,t.getItemsByUuid=f,t.getEffectByUuid=async function(e){const t=await fromUuid(e);return t instanceof Item&&r(t)?t:null},t.getEffectsByUuid=async function(e){return(await f(e)).filter(r)},t.removeActorsEffectsByUuid=async function(e,t){await Promise.all(e.map((e=>async function(e,t){const i=await l(e,t);await e.deleteEmbeddedDocuments("Item",i.map((e=>e.id)))}(e,t))))},t.removeActorsEffectsByName=async function(e,t){await Promise.all(e.map((e=>async function(e,t){const i=a(e,"effect",t);await e.deleteEmbeddedDocuments("Item",i.map((e=>e.id)))}(e,t))))}},2190:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getHuntAndGatherActor=t.getPartyActors=t.getCombatEffects=t.getCampingActivityData=t.rollCampingCheck=t.getDC=t.getDefaultConfiguration=void 0;const n=i(2977),a=i(9540),s=i(8593),r=i(8063),o=i(2784),l=i(1060);function c(e,t,i,n){return"zone"===i?(0,a.getRegionInfo)(e,n).zoneDC:"actorLevel"===i?(0,s.getLevelBasedDC)(t.level):i}t.getDefaultConfiguration=function(e,t){return{actorUuids:[],campingActivities:[],cooking:{chosenMeal:"Basic Meal",actorMeals:[],magicalSubsistenceAmount:0,subsistenceAmount:0,knownRecipes:Array.from(new Set(["Basic Meal","Hearty Meal",...t])),homebrewMeals:[],cookingSkill:"survival",degreeOfSuccess:null},restRollMode:"one",currentRegion:"Rostland Hinterlands",dailyPrepsAtTime:e.time.worldTime,homebrewCampingActivities:[],encounterModifier:0,gunsToClean:0,watchSecondsRemaining:0,actorUuidsNotKeepingWatch:[],increaseWatchActorNumber:0,lockedActivities:n.allCampingActivities.filter((e=>e.isLocked)).map((e=>e.name)),ignoreSkillRequirements:!1}},t.getDC=c,t.rollCampingCheck=async function({game:e,actor:t,dc:i,skill:n,secret:a=!1,isWatch:l=!1,region:u,activity:m}){const d={extraRollOptions:["camping"]};let h;l&&d.extraRollOptions?.push("watch"),m&&d.extraRollOptions?.push("action:"+(0,s.slugify)(m.name)),i&&(d.dc={value:c(e,t,i,u)}),a&&(d.rollMode="blindroll");const f=t.skills,p=`${n}-lore`,g=n in f?n:p in f?p:null;if("perception"===n)h=await t.perception.roll(d);else{if(null===g)return ui.notifications?.error(`${t.name} does not have skill ${(0,s.unslugify)(n)}`),null;h=await f[g].roll(d)}const y=h?.degreeOfSuccess??null;return null!==y&&(await(0,s.postDegreeOfSuccessMessage)({degreeOfSuccess:y,messageConfig:{isPrivate:a,critSuccess:m?.criticalSuccess?.message,success:m?.success?.message,failure:m?.failure?.message,critFailure:m?.criticalFailure?.message}}),void 0!==m&&m[(0,r.degreeToProperty)(y)]?.checkRandomEncounter&&await(0,o.checkRandomEncounterMessage)()),y},t.getCampingActivityData=function(e){const t=e.homebrewCampingActivities,i=new Set(t.map((e=>e.name.toLocaleLowerCase())));return[...n.allCampingActivities.filter((e=>!i.has(e.name.toLocaleLowerCase()))),...t]};const u={"Enhance Weapons":{uuid:"@UUID[Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.ZKJlIqyFgbKDACnG]{Enhance Weapons}",target:"Allies"},"Set Traps":{uuid:"@UUID[Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.PSBOS7ZEl9RGWBqD]{Set Traps}",target:"Enemies"},"Undead Guardians":{uuid:"@UUID[Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.KysTaC245mOnSnmE]{Undead Guardians}",target:"1 Ally"},"Water Hazards":{uuid:"@UUID[Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.LN6mH7Muj4hgvStt]{Water Hazards}",target:"Enemies"},"Maintain Armor":{uuid:"@UUID[Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.wojV4NiAOYsnfFby]{Maintain Armor: Armor}",target:""}};function m(e){return e.actors?.filter((e=>"party"===e.type))??[]}t.getCombatEffects=async function(e){const t={},i=await async function(e){const t=await Promise.all(e.map((e=>fromUuid(e)))),i=Math.max(1,...t.map((e=>e?.system.details.level.value??1)));return i<3?"1 Ally":`${1+Math.floor((i-1)/2)} Allies`}(e.actorUuids);return e.campingActivities.forEach((e=>{const n=e.activity;if(n in u&&e.actorUuid){const e=u[n],a="Maintain Armor"===n?i:e.target;t[n]={...e,target:a}}})),t},t.getPartyActors=m,t.getHuntAndGatherActor=async function(e,t){const i=t.huntAndGatherTargetActorUuid;return i&&(t.actorUuids.includes(i)||m(e).find((e=>e.uuid===i)))?await(0,l.getActorByUuid)(i):null}},2784:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bindCampingChatEventListeners=t.checkRandomEncounterMessage=t.postDiscoverSpecialMealResult=t.postHuntAndGatherResult=t.addIngredients=t.addRecipe=void 0;const n=i(1060),a=i(8593),s=i(1671),r=i(8576),o=i(2761);async function l(e){const t=e.dataset.actorUuid??"",i=parseInt(e.dataset.specialIngredients??"0"),a=parseInt(e.dataset.basicIngredients??"0"),s=await(0,n.getActorByUuid)(t);return s?{specialIngredients:i,basicIngredients:a,actor:s}:null}async function c(e,t){const i=await l(t),n=t.dataset.critFailUuids?.split(",")??[],s=t.dataset.recipe||null;i&&((0,a.isFirstGm)(e)?await(0,o.addDiscoverSpecialMealResult)(e,i,s,n):e.socket?.emit("module.pf2e-kingmaker-tools",{action:"addDiscoverSpecialMealResult",data:{actorUuid:i.actor.uuid,specialIngredients:i.specialIngredients,basicIngredients:i.basicIngredients,critFailUuids:n,recipe:s}}))}async function u(e,t){const i=await l(t);i&&((0,a.isFirstGm)(e)?await(0,o.addHuntAndGatherResult)(e,i):e.socket?.emit("module.pf2e-kingmaker-tools",{action:"addHuntAndGatherResult",data:{actorUuid:i.actor.uuid,specialIngredients:i.specialIngredients,basicIngredients:i.basicIngredients}}))}t.addRecipe=c,t.addIngredients=u,t.postHuntAndGatherResult=async function(e,t){const i=t.basicIngredients,n=t.specialIngredients,a=(0,o.getIngredientList)(i,n),s=`\n        <p><b>${e.name}</b>: Add:</p>\n        <ul>${a}</ul>\n        <button \n            type="button" \n            class="km-add-food" \n            data-actor-uuid="${e.uuid}"\n            data-basic-ingredients="${i}"\n            data-special-ingredients="${n}"\n        >Apply</button>\n    `;await ChatMessage.create({content:s})},t.postDiscoverSpecialMealResult=async function(e,t,i,n){const a=t.basicIngredients,s=t.specialIngredients,r=`\n        <p>${i?`Learn ${i} and remove`:"Remove"}${n.length>0?" and suffer the Critical Failure effect":""}:</p>\n        <ul>${(0,o.getIngredientList)(a,s)}</ul>\n        <button \n            type="button" \n            class="km-add-recipe" \n            data-actor-uuid="${e.uuid}"\n            data-basic-ingredients="${a}"\n            data-special-ingredients="${s}"\n            ${i?`data-recipe="${i}"`:""}\n            data-crit-fail-uuids="${n.join(",")}"\n        >Apply</button>\n    `;await ChatMessage.create({content:r})},t.checkRandomEncounterMessage=async function(){await ChatMessage.create({content:'<button class="km-random-encounter" type="button">Check for Random Encounter</button>',type:CONST.CHAT_MESSAGE_TYPES.ROLL,rollMode:"blindroll"})},t.bindCampingChatEventListeners=function(e){if((0,s.getCampingActor)(e)){const t=$("#chat-log");t.on("click",".km-add-food",(t=>u(e,t.currentTarget))),t.on("click",".km-add-recipe",(t=>c(e,t.currentTarget))),t.on("click",".km-random-encounter",(()=>async function(e){const t=(0,s.getCampingActor)(e);if(t){const i=(0,s.getCamping)(t),n=(0,r.getEncounterDC)(i,e);await(0,r.rollRandomEncounter)(e,i.currentRegion,n,!1)}}(e)))}}},3998:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stopCombat=t.checkBeginCombat=t.showSetSceneCombatPlaylistDialog=void 0;const n=i(8593),a=i(1671),s=i(4310);function r(e){const t=e.getFlag("pf2e-kingmaker-tools","combat-track");return t?.name?t.name:null}t.showSetSceneCombatPlaylistDialog=async function(e,t){await async function(e){const t=e.game.playlists?.map((e=>e.name??"Unknown Playlist Name"))??[];new Dialog({title:`Combat Track: ${e.entityName}`,content:`\n        <form class="simple-dialog-form">\n            <div>\n                <label for="km-playlist">Playlist</label>\n                <select name="playlist">\n                    <option value="">-</option>\n                    ${t.map((t=>{const i=(0,n.escapeHtml)(t);return`<option value="${i}" ${i===e.activePlaylist?"selected":""}>${i}</option>`})).join("")}\n                </select>\n            </div>\n        </form>\n        `,buttons:{save:{icon:'<i class="fa-solid fa-save"></i>',label:"Save",callback:async t=>{const i=t,a=(0,n.parseSelect)(i,"playlist");(0,n.isBlank)(a)?await e.onSubmit(null):await e.onSubmit(a.trim())}}},default:"save"},{jQuery:!1,width:350}).render(!0)}({game:e,activePlaylist:r(t),entityName:t.name??"Unknown Entity",onSubmit:e=>async function(e,t){await e.setFlag("pf2e-kingmaker-tools","combat-track",{name:t})}(t,e)})};const o="The Shrike Hills",l=new Map;function c(e,t){return e.playlists?.find((e=>"7CiwVus60FiuKFhK"===e._source._id))?.sounds?.getName(t)}async function u(e,t,i){if((0,n.isFirstGm)(e)&&(0,s.getBooleanSetting)(e,"enableCombatTracks")){const s=function(e){const t=(0,a.getCampingActor)(e);if(t)return(0,a.getCamping)(t).currentRegion;return"Brevoy"}(e),u=t.map((e=>r(e))).find((e=>!(0,n.isBlank)(e))),m=e.scenes?.active?r(e.scenes.active):void 0,d=function(e,t){const i=e.playlists?.getName(`Kingmaker.${t}`),a=l.get(t);return(0,n.isKingmakerInstalled)(e)&&void 0===i&&a?c(e,a):i}(e,s),h=function(e){const t=e.playlists?.getName("Kingmaker.Default");return(0,n.isKingmakerInstalled)(e)&&void 0===t?c(e,o):t}(e),f=(u?e.playlists?.getName(u):void 0)??(m?e.playlists?.getName(m):void 0)??d??h;console.log("Found Playlist "+f?.name),f&&await i(f)}}l.set("Dunsward","Dunsward"),l.set("Hooktongue","The Narlmarches"),l.set("Kamelands","Glenebon"),l.set("Narlmarches","The Narlmarches"),l.set("Nomen Heights","Dunsward"),l.set("Pitax","Capital Under Attack"),l.set("Sellen Hills","Glenebon"),l.set("Thousand Voices","First World"),l.set("Tor of Levenies","Dunsward"),l.set("Tuskwater","Glenebon"),l.set("Glenebon Lowlands","Glenebon"),l.set("Glenebon Uplands","Glenebon"),l.set("Tiger Lords","Glenebon"),l.set("Drelev","Glenebon"),l.set("Numeria","Glenebon"),l.set("Branthlend Mountains","Glenebon"),t.checkBeginCombat=async function(e,t,i){if(0===t.round&&1===i.round){const i=t.combatants.map((e=>e.actor)).filter((e=>null!==e));await u(e,i,(async t=>{await(e.scenes?.active?.playlist?.stopAll()),t instanceof Playlist?await t.playAll():await t.update({playing:!0})}))}},t.stopCombat=async function(e,t){const i=t?.combatants?.map((e=>e.actor))?.filter((e=>null!==e))??[];await u(e,i,(async t=>{t.playing&&(t instanceof Playlist?await t.stopAll():await t.update({playing:!1}),e.scenes?.active?.playlistSound?await e.scenes.active.playlistSound.update({playing:!0}):await(e.scenes?.active?.playlist?.playAll()))}))}},4693:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.allowedActors=t.rationUuid=t.basicIngredientUuid=t.specialIngredientUuid=void 0,t.specialIngredientUuid="Compendium.pf2e.equipment-srd.Item.OCTireuX60MaPcEi",t.basicIngredientUuid="Compendium.pf2e.equipment-srd.Item.kKnMlymiqZLVEAtI",t.rationUuid="Compendium.pf2e.equipment-srd.Item.L9ZV076913otGtiB",t.allowedActors=new Set(["character","npc","loot","vehicle"])},1865:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addActivityDialog=void 0;const n=i(8593),a=i(1060),s=i(5437),r=i(6013),o=["criticalSuccess","success","failure","criticalFailure"];class AddCampingActivities extends FormApplication{onSubmitCallback;homebrewActivities;activity;originalName;static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-add-camping-activities",e.title="Manage Camping Activities",e.template="modules/pf2e-kingmaker-tools/templates/camping/add-activities.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=[],e.height="auto",e}constructor(e,t){super(e,t),this.onSubmitCallback=t.onSubmit,this.homebrewActivities=deepClone(t.homebrewActivities),this.originalName=t.activity?.name,this.activity=deepClone(t.activity)??{journalUuid:"",isHomebrew:!0,dc:"zone",effectUuids:[],modifyRandomEncounterDc:{night:0,day:0},isLocked:!1,skills:"any",isSecret:!1,name:"",skillRequirements:[],criticalFailure:{checkRandomEncounter:!1,effectUuids:[],modifyRandomEncounterDc:{day:0,night:0},message:""},criticalSuccess:{checkRandomEncounter:!1,effectUuids:[],modifyRandomEncounterDc:{day:0,night:0},message:""},success:{checkRandomEncounter:!1,effectUuids:[],modifyRandomEncounterDc:{day:0,night:0},message:""},failure:{checkRandomEncounter:!1,effectUuids:[],modifyRandomEncounterDc:{day:0,night:0},message:""}}}async getData(){return{outcomes:await Promise.all(o.map((async e=>{const t=this.activity[e];return{id:e,label:(0,n.unslugify)(e),checkRandomEncounter:t?.checkRandomEncounter??!1,message:t?.message??"",modifyRandomEncounterDc:{day:t?.modifyRandomEncounterDc?.day??0,night:t?.modifyRandomEncounterDc?.night??0},effects:await this.getEffects(t?.effectUuids??[],e)}}))),effects:await this.getEffects(this.activity.effectUuids??[],"effect"),dc:this.activity.dc??"",isSecret:this.activity.isSecret??!1,journalUuid:this.activity.journalUuid??"",modifyRandomEncounterDc:{day:this.activity.modifyRandomEncounterDc?.day??0,night:this.activity.modifyRandomEncounterDc?.night??0},name:this.activity.name??"",errors:await this.validate(this.activity),dcs:["actorLevel","zone",...(0,n.range)(0,60)].map((e=>({label:(0,n.deCamelCase)(e.toString()),value:e.toString()}))),skills:"any"===this.activity.skills?[{id:"all",label:"All"}]:this.activity.skills.map((e=>{const t=this.activity.skillRequirements.find((t=>t.skill===e))?.proficiency;return{label:(0,n.unslugify)(e),id:e,proficiency:t}}))}}async getEffects(e,t){return await Promise.all(e?.map((async e=>({key:t,target:e.target?(0,n.capitalize)(e.target):"All",effect:await TextEditor.enrichHTML((0,n.createUUIDLink)(e.uuid))}))))}async _updateObject(e,t){console.log(t),this.activity.journalUuid=t.journal,this.activity.name=t.name,this.activity.isSecret=t.secret,this.activity.isLocked=!1,this.activity.dc=function(e){if(!(0,n.isBlank)(e)){if("zone"===e)return"zone";if("actorLevel"===e)return"actorLevel";{const t=parseInt(e,10);if(!isNaN(t))return t}}return}(t.dc),t["night-encounter-dc"]||t["day-encounter-dc"]?this.activity.modifyRandomEncounterDc={day:t["day-encounter-dc"]??0,night:t["night-encounter-dc"]??0}:this.activity.modifyRandomEncounterDc=void 0,this.activity.isHomebrew=!0,o.forEach((e=>{this.activity[e].message=t[`${e}-message`],this.activity[e].checkRandomEncounter=t[`${e}-roll-encounter`],this.activity[e].modifyRandomEncounterDc.day=t[`${e}-day-modifier`],this.activity[e].modifyRandomEncounterDc.night=t[`${e}-night-modifier`]})),this.render()}activateListeners(e){super.activateListeners(e);const t=e[0];(0,n.listenClick)(t,".save",(async()=>{await this.onSubmitCallback(this.activity),await this.close()})),(0,n.listenClick)(t,".add-effect",(async e=>{const t=e.currentTarget.dataset.type,i={target:"all",uuid:""};l(i,(()=>{"effect"===t?(this.activity.effectUuids=this.activity.effectUuids??[],this.activity.effectUuids.push(i)):(this.activity[t].effectUuids=this.activity[t]?.effectUuids??[],this.activity[t].effectUuids.push(i)),this.render()}))})),(0,n.listenClick)(t,".edit-skills",(async()=>{const e=this.activity.skills,t="any"===e?[]:e.filter((e=>!r.allActorSkills.includes(e))).map((e=>({id:e,proficiency:this.activity.skillRequirements.find((t=>t.skill===e))?.proficiency}))),i="any"===e?[]:e.filter((e=>r.allActorSkills.includes(e))).map((e=>({id:e,proficiency:this.activity.skillRequirements.find((t=>t.skill===e))?.proficiency})));(0,s.skillDialog)({selectedLores:t,selectedSkills:i,atLeastOne:!0,all:"any"===e,onSave:e=>{if(e.all)this.activity.skills="any",this.activity.skillRequirements=[];else{const t=[...e.selectedSkills,...e.selectedLores];this.activity.skills=t.map((e=>e.id)),this.activity.skillRequirements=t.filter((e=>void 0!==e.proficiency)).map((e=>({skill:e.id,proficiency:e.proficiency})))}this.render()},availableSkills:[...r.allActorSkills]})})),(0,n.listenClick)(t,".edit-effect",(async e=>{const t=e.currentTarget,i=t.dataset.type,n=parseInt(t.dataset.id??"0",10);let a;a="effect"===i?this.activity.effectUuids[n]:this.activity[i].effectUuids[n],l(a,(()=>this.render()))})),(0,n.listenClick)(t,".delete-effect",(async e=>{const t=e.currentTarget,i=t.dataset.type,n=parseInt(t.dataset.id??"0",10);"effect"===i?this.activity.effectUuids=this.activity.effectUuids?.filter(((e,t)=>t!==n)):this.activity[i].effectUuids=this.activity[i]?.effectUuids?.filter(((e,t)=>t!==n)),this.render()}))}async validate(e){const t=[];return(0,n.isBlank)(e.name)&&t.push("Name must not be blank"),this.homebrewActivities.find((t=>t.name===e.name&&t.name!==this.originalName))&&t.push(`Homebrew Activity with name ${e.name} already exists`),e.journalUuid&&!await fromUuid(e.journalUuid)&&t.push(`Journal with uuid ${e.journalUuid} does not exist`),t}}function l(e,t=(()=>{})){new Dialog({title:"Add/Edit Effect",content:`\n        <form class="simple-dialog-form">\n           <div>\n                <label for="km-effect">Effect UUID</label>\n                <input type="text" name="effect" id="km-effect" value="${(0,n.escapeHtml)(e.uuid)}">\n            </div>\n            <div>\n                <label for="km-effect-target">Effect Target</label>\n                <select name="effect-target" id="km-effect-target">\n                    <option value="all" ${"all"===e.target?"selected":""}>All</option>\n                    <option value="allies" ${"allies"===e.target?"selected":""}>Allies</option>\n                    <option value="self" ${"self"===e.target?"selected":""}>Self</option>\n                </select>\n            </div>\n        </form>\n        `,buttons:{save:{icon:'<i class="fa-solid fa-save"></i>',label:"Save",callback:async i=>{const s=i,r=(0,n.parseTextInput)(s,"effect"),o=(0,n.parseSelect)(s,"effect-target");null===await(0,a.getEffectByUuid)(r)?ui.notifications?.error(`Can not find effect item with uuid ${r}`):(e.uuid=r,e.target=o,t())}}},default:"save"},{jQuery:!1,width:321}).render(!0)}t.addActivityDialog=function(e){new AddCampingActivities(null,e).render(!0)}},9582:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addRecipeDialog=void 0;const n=i(8593),a=i(1060);async function s(e,t){const i=(0,n.parseTextInput)(e,t+"-effect-uuid")||void 0,s=(0,n.parseCheckbox)(e,t+"-remove-rest")||!1;if(i){if(null!==await(0,a.getEffectByUuid)(i))return[{uuid:i,removeAfterRest:s}];ui.notifications?.error(`Can not find effect item with uuid ${i}`)}return[]}t.addRecipeDialog=function({onSubmit:e,recipes:t}){new Dialog({title:"Add Recipe",content:'\n        <div>\n        <p>Hint: UUIDs can be found in the item\'s <b>Rules</b> tab</p>\n        <form class="simple-dialog-form">\n            <div>\n                <label for="km-recipe-name">Name</label>\n                <input type="text" name="name" id="km-recipe-name" placeholder="Unknown Meal">\n            </div>\n            <div>\n                <label for="km-recipe-uuid">UUID</label>\n                <input type="text" name="uuid" id="km-recipe-uuid">\n            </div>\n            <div>\n                <label for="km-recipe-level">Level</label>\n                <input type="number" name="level" id="km-recipe-level"  placeholder="0">\n            </div>\n            <div>\n                <label for="km-recipe-rarity">Rarity</label>\n                <select name="rarity">\n                    <option value="common">Common</option>\n                    <option value="uncommon">Uncommon</option>\n                    <option value="rare">Rare</option>\n                    <option value="unique">Unique</option>\n                </select>\n            </div>\n            <div>\n                <label for="km-recipe-cooking-lore-dc">Cooking Lore DC</label>\n                <input type="number" name="cooking-lore-dc" id="km-recipe-cooking-lore-dc" placeholder="0">\n            </div>\n            <div>\n                <label for="km-recipe-survival-dc">Survival DC</label>\n                <input type="number" name="survival-dc" id="km-recipe-survival-dc" placeholder="0">\n            </div>\n            <div>\n                <label for="km-recipe-basic">Basic Ingredients</label>\n                <input type="number" name="basic-ingredients" id="km-recipe-basic" placeholder="0">\n            </div>\n            <div>\n                <label for="km-recipe-special">Special Ingredients</label>\n                <input type="number" name="special-ingredients" id="km-recipe-special" placeholder="0">\n            </div>\n            <div>\n                <label for="km-recipe-cost">Cost</label>\n                <input type="text" name="cost" id="km-recipe-cost" placeholder="0 gp">\n            </div>\n            \n            <div>\n                <label for="km-favorite-meal-effect-uuid">Favorite Meal: Effect UUID</label>\n                <input type="text" name="favorite-meal-effect-uuid" id="km-favorite-meal-effect-uuid">\n            </div>\n            <div>\n                <label for="km-favorite-meal-remove-rest">Favorite Meal: Remove Effect after Rest</label>\n                <input type="checkbox" name="favorite-meal-remove-rest" id="km-favorite-meal-remove-rest">\n            </div>\n            \n            <div>\n                <label for="km-critical-success-effect-uuid">Critical Success: Effect UUID</label>\n                <input type="text" name="critical-success-effect-uuid" id="km-critical-success-effect-uuid">\n            </div>\n            <div>\n                <label for="km-critical-success-remove-rest">Critical Success: Remove Effect after Rest</label>\n                <input type="checkbox" name="critical-success-remove-rest" id="km-critical-success-remove-rest">\n            </div>\n            \n            <div>\n                <label for="km-success-effect-uuid">Success: Effect UUID</label>\n                <input type="text" name="success-effect-uuid" id="km-success-effect-uuid">\n            </div>\n            <div>\n                <label for="km-success-remove-rest">Success: Remove Effect after Rest</label>\n                <input type="checkbox" name="success-remove-rest" id="km-success-remove-rest">\n            </div>\n            \n            <div>\n                <label for="km-critical-failure-effect-uuid">Critical Failure: Effect UUID</label>\n                <input type="text" name="critical-failure-effect-uuid" id="km-critical-failure-effect-uuid">\n            </div>\n            <div>\n                <label for="km-critical-failure-remove-rest">Critical Failure: Remove Effect after Rest</label>\n                <input type="checkbox" name="critical-failure-remove-rest" id="km-critical-failure-remove-rest">\n            </div>\n        </form>\n        </div>\n        ',buttons:{add:{icon:'<i class="fa-solid fa-save"></i>',label:"Add",callback:async i=>{const a=i,r=(0,n.parseTextInput)(a,"uuid"),o=await fromUuid(r),l=(0,n.parseTextInput)(a,"name")||"Unknown Meal";if(null===o)ui.notifications?.error(`Can not find item with uuid ${r}`);else if(t.find((e=>e.name===l)))ui.notifications?.error(`Recipe with name ${l} exists already`);else{const t=await s(a,"favorite-meal"),i=await s(a,"critical-success"),o=await s(a,"success"),c=await s(a,"critical-failure");await e({isHomebrew:!0,specialIngredients:(0,n.parseNumberInput)(a,"special-ingredients")||0,level:(0,n.parseNumberInput)(a,"level")||0,name:l,rarity:(0,n.parseSelect)(a,"rarity"),cost:(0,n.parseTextInput)(a,"cost")||"0 gp",uuid:r,survivalDC:(0,n.parseNumberInput)(a,"survival-dc")||0,basicIngredients:(0,n.parseNumberInput)(a,"basic-ingredients")||0,cookingLoreDC:(0,n.parseNumberInput)(a,"cooking-lore-dc")||0,favoriteMeal:{effects:t},criticalSuccess:{effects:i},success:{effects:o},criticalFailure:{effects:c}})}}}},default:"add"},{jQuery:!1,width:510}).render(!0)}},5514:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.askDcDialog=void 0;const n=i(8593);t.askDcDialog=function(e){new Dialog({title:`Set DC: ${e.activity}`,content:'\n        <form class="simple-dialog-form">\n            <div>\n                <label for="km-dc">DC</label>\n                <input type="number" name="dc" id="km-dc">\n            </div>\n        </form>\n        ',buttons:{roll:{icon:'<i class="fa-solid fa-dice-d20"></i>',label:"Roll",callback:async t=>{const i=t;await e.onSubmit((0,n.parseNumberInput)(i,"dc"))}}},default:"roll"},{jQuery:!1,width:250}).render(!0)}},4954:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.campingSettingsDialog=void 0;const n=i(8593),a=i(4310);t.campingSettingsDialog=function({onSubmit:e,data:t,game:i}){new Dialog({title:"Camping Settings",content:`\n        <form class="km-settings-form">\n            <div>\n                <div class="form-elements">\n                    <label for="km-guns-to-clean">Guns To Clean</label>\n                    <input type="number" name="guns-to-clean" id="km-guns-to-clean" value="${t.gunsToClean}">\n                </div>\n            </div>\n            <div>\n                <div class="form-elements">\n                    <label for="km-increase-actor-watch-number">Increase Actors Keeping Watch</label>\n                    <input type="number" name="increase-actor-watch-number" id="km-increase-actor-watch-number" value="${t.increaseWatchActorNumber}">\n                </div>\n            </div>\n            ${t.actorsKeepingWatch.map((e=>`\n                <div>\n                    <div class="form-elements">\n                        <label for="km-actor-uuids-keeping-watch-${e.uuid}">Keep Watch: ${(0,n.escapeHtml)(e.name)}</label>\n                        <input type="checkbox" name="actor-uuids-keeping-watch-${e.uuid}" id="km-actor-uuids-keeping-watch-${e.uuid}" ${e.watchEnabled?"checked":""}>\n                    </div>\n                </div>\n                `)).join("")}\n            <div>\n                <div class="form-elements">\n                    <label for="km-rest-roll-mode">Rest Random Encounter Roll Mode</label>\n                    <select name="rest-roll-mode" id="km-rest-roll-mode">\n                        <option value="none" ${"none"===t.restRollMode?"selected":""}>Don't Roll Encounter Check</option>\n                        <option value="one" ${"one"===t.restRollMode?"selected":""}>Roll 1 Encounter Check</option>\n                        <option value="one-every-4-hours" ${"one-every-4-hours"===t.restRollMode?"selected":""}>Roll 1 Encounter Check Every 4 Hours</option>\n                    </select>\n                </div>\n            </div>\n            <div>\n                <div class="form-elements">\n                    <label for="km-proxy-random-encounter-table">Proxy Random Encounter Table</label>\n                    <input type="text" name="proxy-random-encounter-table" id="km-proxy-random-encounter-table" value="${t.proxyRandomEncounterTable}">\n                </div>\n                <div class="help">\n                    <p>Name of the in world roll table that is rolled first to check what kind of encounter is rolled. Use the string "Creature" to roll on the region roll table in the proxy roll table or link another roll table of your choice. Leave blank to always roll on the region random encounter tables.</p>\n                </div>\n            </div>\n            <div>\n                <div class="form-elements">\n                    <label for="km-random-encounter-roll-mode">Random Encounter Roll Mode</label>\n                    <select name="random-encounter-roll-mode" id="km-random-encounter-roll-mode">\n                        ${Object.entries(n.rollModeChoices).map((([e,i])=>`<option value="${e}" ${e===t.randomEncounterRollMode?"selected":""}>${i}</option>`)).join("")}\n                    </select>\n                </div>\n            </div>\n            <div>\n                <div class="form-elements">\n                    <label for="km-hunt-and-gather-actor">Add Ingredients from Hunt and Gather To</label>\n                    <select name="hunt-and-gather-actor" id="km-hunt-and-gather-actor">\n                        <option value="">Actor performing Hunt and Gather</option>\n                        ${t.actors.map((e=>`\n                            <option value="${e.uuid}" ${e.uuid===t.huntAndGatherTargetActorUuid?"selected":""}>${e.name}</option>\n                            `)).join("")}\n                    </select>\n                </div>\n            </div>\n            <div>\n                <div class="form-elements">\n                    <label for="km-ignore-skill-requirements">Do not validate Activity Skill Proficiency</label>\n                    <input type="checkbox" name="ignore-skill-requirements" id="km-ignore-skill-requirements" ${t.ignoreSkillRequirements?"checked":""}>\n                </div>\n            </div>\n        </form>\n        `,buttons:{save:{icon:'<i class="fa-solid fa-save"></i>',label:"Save",callback:async s=>{const r=s,o=(0,n.parseNumberInput)(r,"guns-to-clean"),l=(0,n.parseNumberInput)(r,"increase-actor-watch-number")||0,c=(0,n.parseSelect)(r,"rest-roll-mode"),u=(0,n.parseSelect)(r,"hunt-and-gather-actor")||null,m=(0,n.parseCheckbox)(r,"ignore-skill-requirements")||!1,d=t.actorsKeepingWatch.filter((e=>!(0,n.parseCheckbox)(r,`actor-uuids-keeping-watch-${e.uuid}`))).map((e=>e.uuid)),h=(0,n.parseSelect)(r,"random-encounter-roll-mode")||"publicroll",f=(0,n.parseTextInput)(r,"proxy-random-encounter-table");await(0,a.setSetting)(i,"proxyEncounterTable",f),await(0,a.setSetting)(i,"randomEncounterRollMode",h),await e({gunsToClean:o,restRollMode:c,increaseWatchActorNumber:l,actorUuidsNotKeepingWatch:d,huntAndGatherTargetActorUuid:u,ignoreSkillRequirements:m})}}},default:"save"},{jQuery:!1,width:550}).render(!0)}},74:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.discoverSpecialMeal=void 0;const n=i(3018),a=i(8593);function s(e,t){const i=e.map((e=>({...e,disabled:t.specialIngredients<2*e.specialIngredients||t.basicIngredients<2*e.basicIngredients}))),n=i.findIndex((e=>!e.disabled));return`\n    <form>\n        <h1>Recipes Learnable in Zone</h1>\n        <p><b>Available Basic Ingredients</b>: ${t.basicIngredients}</p>\n        <p><b>Available Special Ingredients</b>: ${t.specialIngredients}</p>\n        <table class="km-table">\n            <thead>\n            <tr>\n                <th>Recipe</th>\n                <th>DC</th>\n                <th>Cost</th>\n                <th>Learn</th>\n            </tr>\n            </thead>\n            <tbody>\n            ${i.map(((e,t)=>{const i=n===t;return`<tr>\n                    <td>${e.recipe}</td>\n                    <td>${e.cookingLoreDC}</td>\n                    <td>${(0,a.escapeHtml)(e.learningCost)}</td>\n                    <td><input type="radio" name="recipe" value="${(0,a.escapeHtml)(e.name)}" ${i?"checked":""} ${e.disabled?"disabled":""}></td>\n                </tr>`})).join("")}\n            </tbody>\n        </table>\n    </form>\n`}t.discoverSpecialMeal=async function(e){const t=await Promise.all(e.availableRecipes.map((e=>(0,n.toTemplateRecipe)(e,new Set))));new Dialog({title:"Discover Special Meal",content:s(t,e.availableFood),buttons:{learn:{icon:'<i class="fa-solid fa-dice-d20"></i>',label:"Learn",callback:async t=>{const i=t,n=(0,a.parseRadio)(i,"recipe");await e.onSubmit(n)}}},default:"learn"},{jQuery:!1,width:510}).render(!0)}},6948:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.manageActivitiesDialog=void 0;const n=i(8593),a=i(2190),s=i(1671),r=i(1865);class ManageCampingActivities extends FormApplication{game;actor;static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-manage-camping-activities",e.title="Manage Camping Activities",e.template="modules/pf2e-kingmaker-tools/templates/camping/manage-activities.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=[],e.height="auto",e}constructor(e,t){super(e,t),this.game=t.game,this.actor=t.actor}async getData(){const e=(0,s.getCamping)(this.actor),t=(0,a.getCampingActivityData)(e),i=new Set(e.lockedActivities);return{activities:t.sort(((e,t)=>e.name.localeCompare(t.name))).map((e=>({name:e.name,isHomebrew:!!e.isHomebrew,enabled:!i.has(e.name)})))}}async _updateObject(e,t){console.log(t),await(0,s.saveCamping)(this.game,this.actor,{lockedActivities:Object.entries(t).filter((([,e])=>!e)).map((([e])=>e))}),this.render()}activateListeners(e){super.activateListeners(e);const t=e[0];(0,n.listenClick)(t,".add-activity",(async()=>{const e=(0,s.getCamping)(this.actor);await(0,r.addActivityDialog)({homebrewActivities:e.homebrewCampingActivities,onSubmit:async t=>{await(0,s.saveCamping)(this.game,this.actor,{homebrewCampingActivities:[...e.homebrewCampingActivities,t]}),this.render()}})})),(0,n.listenClick)(t,".edit-activity",(async e=>{const t=e.currentTarget.dataset.name,i=(0,s.getCamping)(this.actor);await(0,r.addActivityDialog)({activity:i.homebrewCampingActivities.find((e=>e.name===t)),homebrewActivities:i.homebrewCampingActivities,onSubmit:async e=>{await(0,s.saveCamping)(this.game,this.actor,{homebrewCampingActivities:[...i.homebrewCampingActivities.filter((e=>e.name!==t)),e]}),this.render()}})})),(0,n.listenClick)(t,".delete-activity",(async e=>{const t=e.currentTarget.dataset.name,i=(0,s.getCamping)(this.actor);await(0,s.saveCamping)(this.game,this.actor,{homebrewCampingActivities:i.homebrewCampingActivities.filter((e=>e.name!==t))}),this.render()}))}}t.manageActivitiesDialog=async function(e){new ManageCampingActivities(null,e).render(!0)}},3018:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.manageRecipesDialog=t.toTemplateRecipe=void 0;const n=i(8593);function a(e,t){const i=[];return e>0&&i.push(`Basic: ${e}`),t>0&&i.push(`Special: ${t}`),i.join(", ")}async function s(e,t){return{learned:t.has(e.name),name:e.name,recipe:await TextEditor.enrichHTML((0,n.createUUIDLink)(e.uuid,e.name)),recipeName:e.name,cookingLoreDC:e.cookingLoreDC,cookingCost:a(e.basicIngredients,e.specialIngredients),learningCost:a(2*e.basicIngredients,2*e.specialIngredients),basicIngredients:e.basicIngredients,specialIngredients:e.specialIngredients,price:e.cost,rarity:e.rarity,level:e.level,isHomebrew:e.isHomebrew??!1}}function r(e,t){return`\n        <form class="camping-dialog">\n            <table class="km-table">\n                <tr>\n                    <th>Name</th>\n                    <th>Rarity</th>\n                    <th>Level</th>\n                    <th>DC</th>\n                    <th>Cooking Cost</th>\n                    <th>Learning Cost</th>\n                    <th>Purchase Cost</th>\n                    <th>Learned</th>\n                    <th>Delete</th>\n                </tr>\n                ${e.map(((e,i)=>`<tr>\n                        <td>${e.recipe}</td>\n                        <td>${(0,n.escapeHtml)(e.rarity)}</td>\n                        <td>${e.level}</td>\n                        <td>${e.cookingLoreDC}</td>\n                        <td>${(0,n.escapeHtml)(e.cookingCost)}</td>\n                        <td>${(0,n.escapeHtml)(e.learningCost)}</td>\n                        <td>${(0,n.escapeHtml)(e.price)}</td>\n                        <td><input type="checkbox" name="add-${i}" ${e.learned?"checked":""} ${"Basic Meal"===e.name||"Hearty Meal"===e.name?"disabled":""}></td>\n                        <td><input type="checkbox" name="delete-${i}" ${e.isHomebrew&&t?"":"disabled"}></td>\n                    </tr>`)).join("\n")}\n            </table>\n        </form>\n        `}t.toTemplateRecipe=s,t.manageRecipesDialog=async function(e){const t=[...e.recipes];t.sort(((e,t)=>e.level-t.level||e.name.localeCompare(t.name)));const i=await Promise.all(t.map((t=>s(t,e.learnedRecipes))));new Dialog({title:"Manage Recipes",content:r(i,e.isGM),buttons:{save:{icon:'<i class="fa-solid fa-save"></i>',label:"Save",callback:async t=>{const a=t,s=i.map(((e,t)=>({enabled:(0,n.parseCheckbox)(a,`add-${t}`),name:e.name}))).filter((e=>e.enabled)).map((e=>e.name)),r=i.map(((e,t)=>({enabled:(0,n.parseCheckbox)(a,`delete-${t}`),name:e.name}))).filter((e=>e.enabled)).map((e=>e.name));await e.onSubmit(new Set(s),new Set(r))}}},default:"save"},{jQuery:!1,width:900,height:600}).render(!0)}},2761:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.subsist=t.getRecipeData=t.getChosenMealData=t.getCookingActorByUuid=t.getCookingActorUuid=t.addHuntAndGatherResult=t.addDiscoverSpecialMealResult=t.getIngredientList=t.addFood=t.removeFood=t.calculateConsumedFood=t.canCook=t.getActorConsumables=t.getConsumableFromUuid=void 0;const n=i(1060),a=i(4693),s=i(2977),r=i(5942),o=i(2190),l=i(9540),c=i(8593),u=i(1671);async function m(e){const t=await fromUuid(e);return t&&(0,n.isConsumableItem)(t)?t:null}async function d(e,t,i){let a=t;for(const t of e)if(a>0){const e=[],s=await(0,n.getConsumablesByUuid)(t,new Set([i]));for(const t of s)if(a>0){const i=t.quantity;if(a>=i)await t.delete(),a-=i;else{const n=i-a;e.push({_id:t.id,"system.quantity":n}),a=0}}e.length>0&&await t.updateEmbeddedDocuments("Item",e)}}async function h(e,t){await async function(e,t){let i=t;for(const t of e)if(i>0){const e=[],s=await(0,n.getConsumablesByUuid)(t,new Set([a.rationUuid]));for(const t of s)if(i>0){const n=t.system,a=t.quantity,s=n.uses.value,r=n.uses.max,o=Math.max(0,a-1)*r+s;if(i>=o)await t.delete(),i-=o;else{const n=o-i,a=n%r,s=Math.ceil(n/r);e.push({_id:t.id,"system.quantity":s,"system.uses.value":0===a?r:a}),i=0}}e.length>0&&await t.updateEmbeddedDocuments("Item",e)}}(e,t.rations),await d(e,t.basicIngredients,a.basicIngredientUuid),await d(e,t.specialIngredients,a.specialIngredientUuid)}async function f(e,t){await Promise.all(e.map((e=>(0,s.addIngredientsToActor)(e,t))))}function p(e,t){const i=[];return e&&i.push(`<b>Basic Ingredients</b>: ${e}`),t&&i.push(`<b>Special Ingredients</b>: ${t}`),i.map((e=>`<li>${e}</li>`)).join("")}function g(e){return e.campingActivities.find((e=>"Cook Meal"===e.activity))?.actorUuid??null}function y(e){return r.allRecipes.concat(e.cooking.homebrewMeals)}t.getConsumableFromUuid=m,t.getActorConsumables=async function(e){const t=(await m(a.rationUuid))?.sourceId,i=(await m(a.specialIngredientUuid))?.sourceId,n=(await m(a.basicIngredientUuid))?.sourceId,s={rations:0,specialIngredients:0,basicIngredients:0};for(const a of e){const e=a.itemTypes.consumable,r=e.find((e=>e.sourceId===t&&void 0!==t)),o=e.find((e=>e.sourceId===i&&void 0!==i)),l=e.find((e=>e.sourceId===n&&void 0!==n));s.rations+=r?r.system.uses.value+Math.max(0,r.quantity-1)*r.system.uses.max:0,s.basicIngredients+=l?l.quantity:0,s.specialIngredients+=o?o.quantity:0}return s},t.canCook=function(e){const t=void 0!==e.campingActivities.find((e=>"Prepare Campsite"===e.activity&&("success"===e.result||"criticalSuccess"===e.result||"failure"===e.result))),i=void 0!==e.campingActivities.find((e=>"Cook Meal"===e.activity&&e.actorUuid));return t&&i},t.calculateConsumedFood=function(e,t,i){const n=t.basicIngredients,a=t.specialIngredients,s=t.rations,{availableMagicalSubsistence:r,availableSubsistence:o,actorsConsumingRations:l,actorsConsumingMeals:c}=i,u=e?i.recipeSpecialIngredientCost:0,m=e?i.recipeBasicIngredientCost:0,d=c+l,h=s+o+r,f=Math.max(0,d-o-r),p=Math.max(0,d-f-r);return{magicalSubsistence:Math.max(0,d-p-f),subsistence:p,rations:{value:f,warning:h-d<0},specialIngredients:{value:u*c,warning:u*c>a},basicIngredients:{value:m*c,warning:m*c>n}}},t.removeFood=h,t.addFood=f,t.getIngredientList=p,t.addDiscoverSpecialMealResult=async function(e,t,i,a){const s=(0,u.getCampingActor)(e);if(s){const r=(0,u.getCamping)(s),o=await(0,n.getActorsByUuid)(new Set(r.actorUuids)),l=t.actor,c=t.basicIngredients,m=t.specialIngredients;await h(o,{specialIngredients:m,basicIngredients:c,rations:0});const d=(await(0,n.getItemsByUuid)(new Set(a))).map((e=>e.toObject()));d.length>0&&await l.createEmbeddedDocuments("Item",d);const f=`<p>Removed:</p>\n        <ul>${p(c,m)}</ul>\n        ${i||d.length>0?`\n            <p>Added:</p>\n            <ul>\n                ${i?`<li><b>Recipe</b>: ${i}</li>`:""}\n                ${0===d.length?"":`<li><b>Meal Effects</b>: ${d.map((e=>e.name)).join(", ")}</li>`}\n            </ul>\n        `:""}\n        `;i&&(r.cooking.knownRecipes=Array.from(new Set([...r.cooking.knownRecipes,i])),await(0,u.saveCamping)(e,s,r)),await ChatMessage.create({content:f})}},t.addHuntAndGatherResult=async function(e,t){const i=(0,u.getCampingActor)(e);if(i){const n=(0,u.getCamping)(i),a=await(0,o.getHuntAndGatherActor)(e,n)||t.actor,s=t.specialIngredients,r=t.basicIngredients;await f([a],{specialIngredients:s,basicIngredients:r,rations:0});const l=`<p>Added to ${(0,c.addOf)(a.name??a.uuid)} inventory:</p>\n        <ul>\n            <li><b>Basic Ingredients</b>: ${r}</li>\n            <li><b>Special Ingredients</b>: ${s}</li>\n        </ul>\n        `;await ChatMessage.create({content:l})}},t.getCookingActorUuid=g,t.getCookingActorByUuid=async function(e){const t=g(e);return t?await fromUuid(t):null},t.getChosenMealData=function(e){const t=(0,r.getKnownRecipes)(e).includes(e.cooking.chosenMeal)?e.cooking.chosenMeal:"Basic Meal",i=y(e);return i.find((e=>e.name===t))??i.find((e=>"Basic Meal"===e.name))},t.getRecipeData=y,t.subsist=async function(e,t,i){const{zoneDC:n}=(0,l.getRegionInfo)(e,i);e.pf2e.actions.subsist({actors:[t],skill:"survival",difficultyClass:{value:n}})}},695:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getDiffListeners=t.eat=t.ClearCampingActivitiesListener=t.CampingActivitiesListener=t.DiffListener=t.syncActorsCampingEffects=t.getAllCampingEffectUuids=t.getCampingEffectUuids=t.syncActorMealEffects=void 0;const n=i(5942),a=i(8593),s=i(1060),r=i(2190),o=i(1671),l=i(2761);async function c(e){const t=(0,n.getAllMealEffectUuids)(e.recipes);await(0,s.removeActorsEffectsByUuid)(e.actors,new Set(t)),await Promise.all(e.actors.filter((t=>e.actorUuidsEatingMeal.has(t.uuid))).map((t=>async function(e,t,i,a){const r=(0,n.getMealEffectUuids)(t,a,i),o=await(0,s.getItemsByUuid)(new Set(r));await e.createEmbeddedDocuments("Item",o.map((e=>e.toObject())))}(t,e.recipe,e.degree,e.actorUuidAndFavoriteMeal.get(t.uuid)))))}function u(e){return void 0!==e&&void 0!==e.effectUuids?e.effectUuids.map((e=>e.uuid)):[]}function m(e){return[...u(e.criticalSuccess),...u(e.success),...u(e.failure),...u(e.criticalFailure),...void 0===e.effectUuids?[]:e.effectUuids.map((e=>e.uuid))]}function d(e){return e.flatMap((e=>m(e)))}async function h(e){const t=new Set(d(e.campingActivities)),i=function(e){const t=(0,a.groupBySingle)(e.campingActivities,(e=>e.name)),i=Array.from(e.actorCampingActivities.values()).map((e=>{const i=(n=t.get(e.activityName),a=e.result,[...n?.effectUuids??[],...null===a?[]:n?.[a]?.effectUuids??[]]);var n,a;return{actor:e.actor,effects:i}})),n=new Map,s=e.actors,r=s.map((e=>e.uuid));return i.forEach((e=>{e.effects.forEach((t=>{r.forEach((i=>{if("all"===t.target||void 0===t.target||"self"===t.target&&i===e.actor.uuid||"allies"===t.target&&i!==e.actor.uuid){const e=n.get(i)??[];e.push(t.uuid),n.set(i,e)}}))}))})),s.map((e=>({actor:e,effectUuids:[...n.get(e.uuid)??[]]})))}(e);await Promise.all(i.filter((e=>"npc"===e.actor.type||"character"===e.actor.type)).map((async e=>{const i=await(0,s.getEffectsByUuid)(new Set(e.effectUuids));await async function(e,t,i){const n=new Set(t.map((e=>e.name))),a=await(0,s.getActorEffectsByUuid)(e,i),r=new Set(a.map((e=>e.name))),o=t.filter((e=>!r.has(e.name))),l=a.filter((e=>!n.has(e.name))).map((e=>e.id));await Promise.all([e.createEmbeddedDocuments("Item",o.map((e=>e.toObject()))),e.deleteEmbeddedDocuments("Item",l)])}(e.actor,i,t)})))}t.syncActorMealEffects=c,t.getCampingEffectUuids=m,t.getAllCampingEffectUuids=d,t.syncActorsCampingEffects=h;class DiffListener{action;game;constructor(e,t){this.action=e,this.game=t}async testFireChange(e,t){this.shouldFireChange(e,t)&&(console.log("Firing Sync Event: "+this.action,e,t),await this.fireChange())}async fireChange(){if((0,a.isFirstGm)(this.game)){const e=this.getCurrent();e&&await this.onReceive(e)}else this.game.socket?.emit("module.pf2e-kingmaker-tools",{action:this.action})}getCurrent(){const e=(0,o.getCampingActor)(this.game);return e?(0,o.getCamping)(e):null}canHandle(e){return this.action===e}async onReceive(e){console.log("Receiving update event: "+this.action,e)}}t.DiffListener=DiffListener;class CampingActivitiesListener extends DiffListener{constructor(e){super("syncCampingEffects",e)}shouldFireChange(e,t){return"campingActivities"in diffObject(e,t)&&void 0!==t?.campingActivities?.find((e=>"Prepare Campsite"===e.activity&&null!==e.result&&"criticalFailure"!==e.result))}async onReceive(e){await super.onReceive(e);const t=(await Promise.all(e.campingActivities.filter((e=>null!==e.actorUuid)).map((async e=>{const t={result:e.result,activityName:e.activity,actor:await(0,s.getActorByUuid)(e.actorUuid)};return[e.activity,t]})))).filter((([,e])=>null!==e.actor)),i=new Map(t);await h({actors:await(0,s.getActorsByUuid)(new Set(e.actorUuids)),campingActivities:(0,r.getCampingActivityData)(e),actorCampingActivities:i})}}t.CampingActivitiesListener=CampingActivitiesListener;class ClearCampingActivitiesListener extends DiffListener{constructor(e){super("clearCampingEffects",e)}shouldFireChange(e,t){return"campingActivities"in diffObject(e,t)&&void 0!==t?.campingActivities?.find((e=>"Prepare Campsite"===e.activity&&(null===e.result||"criticalFailure"===e.result)))}async onReceive(e){await super.onReceive(e);const t=await(0,s.getActorsByUuid)(new Set(e.actorUuids)),i=d((0,r.getCampingActivityData)(e));await(0,s.removeActorsEffectsByUuid)(t,new Set(i))}}t.ClearCampingActivitiesListener=ClearCampingActivitiesListener,t.eat=async function(e,t){const i=(0,a.groupBySingle)(t.cooking.actorMeals,(e=>e.actorUuid)),r=new Map;Array.from(i.values()).filter((e=>null!==e.favoriteMeal)).forEach((e=>r.set(e.actorUuid,e.favoriteMeal)));const o=(0,l.getRecipeData)(t),u=o.find((e=>e.name===t.cooking.chosenMeal)),m=t.cooking.degreeOfSuccess,d=await(0,s.getActorsByUuid)(new Set(t.actorUuids));if(null!==m&&void 0!==u){const e=new Set(t.cooking.actorMeals.filter((e=>"meal"===e.chosenMeal)).map((e=>e.actorUuid)));await c({actors:d,degree:m,recipe:u,recipes:o,actorUuidAndFavoriteMeal:r,actorUuidsEatingMeal:e})}else{const e=(0,n.getAllMealEffectUuids)(o);await(0,s.removeActorsEffectsByUuid)(d,new Set(e))}},t.getDiffListeners=function(e){return[new ClearCampingActivitiesListener(e),new CampingActivitiesListener(e)]}},8576:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getEncounterDC=t.getActivityModifier=t.rollRandomEncounter=void 0;const n=i(4310),a=i(9609),s=i(8063),r=i(9540),o=i(2190),l=i(1631),c=i(8593);function u(e,t){if(e.modifyRandomEncounterDc)return{day:e.modifyRandomEncounterDc.day,night:e.modifyRandomEncounterDc.night};if(null!==t){const i=e[t]?.modifyRandomEncounterDc;return{day:i?.day??0,night:i?.night??0}}return{day:0,night:0}}t.rollRandomEncounter=async function(e,t,i,o=!1){const l=await async function(e,t){const i=(0,c.isKingmakerInstalled)(e)?(0,r.toOfficialKingmakerRollTableName)(t,r.regions.get(t)):t;return await(0,a.findRollTableUuidWithFallback)(e,i,"pf2e-kingmaker-tools.kingmaker-tools-random-encounters")}(e,t),u=(0,n.getStringSetting)(e,"proxyEncounterTable")?.trim(),m=(0,a.findWorldTableUuid)(e,u),d={rollMode:(0,n.getStringSetting)(e,"randomEncounterRollMode")};if(o||await async function(e,t){const i=`Rolling Random Encounter for terrain ${e} with Flat DC ${t.total}`,n=await new Roll("1d20").evaluate();await n.toMessage({flavor:i},{rollMode:"gmroll"});const a=(0,s.determineDegreeOfSuccess)(n.total,n.total,t.total);return a===s.DegreeOfSuccess.CRITICAL_SUCCESS||a===s.DegreeOfSuccess.SUCCESS}(t,i)){if(null==m||""===m.trim())console.log("Rolling on creature table "+l),await(0,a.rollRollTable)(e,l,d);else{const t=(await(0,a.rollRollTable)(e,m,d)).draw.results[0];"Creature"===t?.text?.trim()&&(console.log("Rolling on creature table "+l),await(0,a.rollRollTable)(e,l,d))}return!0}return!1},t.getActivityModifier=u,t.getEncounterDC=function(e,t){const i=r.regions.get(e.currentRegion),n=e.encounterModifier,a=(0,o.getCampingActivityData)(e).map((i=>{const n=e.campingActivities.find((e=>e.activity===i.name)),a=n?.result??null;if(null===(n?.actorUuid??null)||null===a&&0!==i.skills.length)return 0;return u(i,a)[(0,l.isDayOrNight)((0,l.getWorldTime)(t))]})).reduce(((e,t)=>e+t),0),s=i?.encounterDC??0;return{modifier:n,activityModifier:a,dc:s,total:n+s+a}}},5942:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getKnownRecipes=t.getMealEffectUuids=t.getAllExpiringMealEffectUuids=t.getAllMealEffectUuids=t.getExpiringOutcomeEffects=t.getOutcomeEffects=t.getRecipesKnownInRegion=t.allRecipes=void 0;const n=i(9540),a=i(2761),s={strength:{criticalSuccessUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.69VWFB5UNLau1Rzt",successUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.iV22sORhjIhWZMKw"},dexterity:{criticalSuccessUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.OAxcELiLh04BLVvP",successUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.CQGJi8WiBq0T8Kc6"},constitution:{criticalSuccessUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.WVRQf9SLX0iRh3Ur",successUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.L8HdDXKrfa3gDakt"},wisdom:{criticalSuccessUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.69MQw1WMMlN4hEzb",successUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.6CjFExnLSe9qij9z"},intelligence:{criticalSuccessUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.yLf2n65zVocqsl6r",successUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.Af25wacbdYDnFKwM"},charisma:{criticalSuccessUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.sd45BQ4P7BtsYEuP",successUuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.VhzUKWFVrZ7tgcEQ"}};function r(e,t){const i=e?.effects?.flatMap((e=>e.uuid))??[];if(!t&&e?.chooseRandomly&&i.length>0){return[i[Math.floor(Math.random()*(i.length-1))]]}return i}function o(e){return e?.effects?.filter((e=>e.removeAfterRest))?.flatMap((e=>e.uuid))??[]}t.allRecipes=[{name:"Basic Meal",basicIngredients:2,specialIngredients:0,cookingLoreDC:18,survivalDC:22,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.J5nci1DS7i1wDph4",level:0,cost:"0 gp",rarity:"common",criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.2DLTsWVdUnjewzhQ",removeAfterRest:!0}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.6IguL0ipdLTiVthS",removeAfterRest:!0}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.gqy7D2LEWSak1pzM",removeAfterRest:!0}]}},{name:"Hearty Meal",basicIngredients:4,specialIngredients:0,cookingLoreDC:14,survivalDC:16,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.K5l6QZci2mCofOBg",level:0,cost:"0 gp",rarity:"common",criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.7aBiVefiVDXS2XmV"}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.KeiNZDcAiGZjyzhn",removeAfterRest:!0}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.LbW38wFmd1JSBPK6",removeAfterRest:!0}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.uI4ZsdIGx7Yoy2rI"}]}},{name:"Jeweled Rice",basicIngredients:1,specialIngredients:0,cookingLoreDC:14,survivalDC:16,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.N3k7OGUKHn4kTu59",level:0,cost:"5 sp",rarity:"common",criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.MGFPIxwSgRLvkV71"}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.OxEApkXu0hw34Ci5"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.Sc5N6l1oCY1oiTfA"}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.d8xr0i8GHY4195sa"}]}},{name:"Fish-On-A-Stick",basicIngredients:2,specialIngredients:0,cookingLoreDC:17,survivalDC:19,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.b59ro2GHvRvBOko8",level:1,cost:"1 gp",rarity:"common",success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.8eIGJPWFlg4L94wY"}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.L5sACVlUjYP6lJ7q"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.c9qgXgiAJikyTM0p"}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.dZTQ5rfedrpLUTxE"}]}},{name:"Haggis",basicIngredients:2,specialIngredients:0,cookingLoreDC:15,survivalDC:17,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.tKcKHaxGW48w5UMj",level:1,cost:"1 gp",rarity:"common",criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.1CIuG1XTo4R8fmeL"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.ISeHA2sG6wwJyV6I"}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.RttWd7ZJNbsFsQjE"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.k0BWf8aF5plRvhyk",removeAfterRest:!0}]}},{name:"Rice-N-Nut Pudding",basicIngredients:2,specialIngredients:1,cookingLoreDC:16,survivalDC:18,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.IrrRh2yttdTDU1A5",level:2,cost:"2 gp",rarity:"common",criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.3Gj0AaUzqwN0CdTi"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.AI1hYVSAMmKgEO9u"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.GzZYeBB1UGMAykXc",removeAfterRest:!0}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.IRTWUl4HjRa82A1B"}]}},{name:"Shepherd's Pie",basicIngredients:4,specialIngredients:0,cookingLoreDC:18,survivalDC:20,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.GsPVSA1GNm4tvmcR",level:2,cost:"2 gp",rarity:"uncommon",criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.3a5uIGu77TLQE9ZB"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.84dIJjkOdLeHWkx2"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.COa19ug1vjTGHy04"}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.RL8zdU7YyoiduDva"}]}},{name:"Broiled Tuskwater Oysters",basicIngredients:2,specialIngredients:1,cookingLoreDC:20,survivalDC:22,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.aXmbLuQMQOMAlls3",level:3,cost:"3 gp",rarity:"uncommon",favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.57461QLkB8M3S0AS"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.BlKsZq6anCMSEshB",removeAfterRest:!0}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.X8sGtdz4yfVl2pKJ"}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.ebP1xWOh7vGZmmlz"}]}},{name:"Succulent Sausages",basicIngredients:3,specialIngredients:1,cookingLoreDC:18,survivalDC:20,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.IZoPx6QH5NRY1HBi",level:3,cost:"3 gp",rarity:"common",favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.EULsp9VffKbWpD0b"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.G0qnixpCakGeHTp1",removeAfterRest:!0}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.WDJQpYYx0N91mkO0",removeAfterRest:!0}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.jseoPPvbPg4Vr7MI"}]}},{name:"Chocolate Ice Cream",basicIngredients:2,specialIngredients:1,cookingLoreDC:19,survivalDC:21,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.xfIwKyG1pNFp8JbN",level:4,cost:"5 gp",rarity:"common",favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.0QmbpFYAoyzUu1gi"}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.9brr5UKBsZcboAOx"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.KqktmooFbYLQQ2S1"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.L85BNpJEFAozA9kW",removeAfterRest:!0}]}},{name:"Galt Ragout",basicIngredients:4,specialIngredients:0,cookingLoreDC:20,survivalDC:22,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.agI35cH4peI3aIX5",level:4,cost:"5 gp",rarity:"uncommon",criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.MADgm2doEOSlNe7u"},{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.JqxNxAVZzAdCAoCZ"}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.Uh9fQWIE0Nc2hwLi"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.bH9QjKt6LybagxcR",removeAfterRest:!0}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.x1lKNowlbhotDu0q"}]}},{name:"Baked Spider Legs",basicIngredients:4,specialIngredients:1,survivalDC:22,cookingLoreDC:20,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.OXKHrajfyBjEBLTM",level:5,cost:"8 gp",rarity:"common",criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.0faDj5jOYlPTwB21"}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.M2gTzsYSnmcq7Lho"}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.MVrKXXHzxzyfy3mi"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.kmHHmbR283uOoDK9"}]}},{name:"Cheese Crostata",basicIngredients:4,specialIngredients:0,cookingLoreDC:22,survivalDC:24,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.GAf8W01ppdseIGbq",level:5,cost:"8 gp",rarity:"uncommon",success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.1VchCdA1LMBhYENe"}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.2c2nrlkL2XJXXQIA"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.EBa9BjdANCMLKMEy",removeAfterRest:!0}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.MI6MF3R5OswdGBUd"},{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.X7fTfenq4TukJJM4"}]}},{name:"Grilled Silver Eel",basicIngredients:4,specialIngredients:1,cookingLoreDC:24,survivalDC:26,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.UMgvKT6nNTPvp28R",level:6,cost:"13 gp",rarity:"uncommon",favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.Dj9026jn8dI7oP0j"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.Vb39DIJ5OfWpN2ig",removeAfterRest:!0}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.Zw8I0G3RqDfNHuCl"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.ta81jwzhkNsN88EZ"}]}},{name:"Hunter's Roast",basicIngredients:4,specialIngredients:0,cookingLoreDC:22,survivalDC:24,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.5QyW0eFSJRgmyRzU",level:6,cost:"13 gp",rarity:"common",success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.0un8LMe7iv59He25",removeAfterRest:!0}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.LiXnKWPOkDBZRpLE"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.RzOGQxp3VHlpYtWJ",removeAfterRest:!0}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.zuPWMtCTzuD96Ykz"}]}},{name:"Owlbear Omelet",basicIngredients:4,specialIngredients:1,cookingLoreDC:25,survivalDC:27,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.3ak0XG0Xf66q2ApV",level:7,cost:"18 gp",rarity:"uncommon",criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.JY3TBLbVAbQHtmtu"}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.O4XVtCWn4Hq5QKUP"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.RLJuUa9tzPrC6PqP",removeAfterRest:!0}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.kyzTn0AUN4Q8G6TH"}]}},{name:"Sweet Pancakes",basicIngredients:2,specialIngredients:2,cookingLoreDC:23,survivalDC:25,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.WrDLx0FVkaglg1hh",level:7,cost:"18 gp",rarity:"common",success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.BXTnX9xhnYvolrFk"}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.Lpo0XSUVmGDQaXtz"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.ovbBMpOBtB1CrLOv"}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.q5JHZeJeAIscA1ky"}]}},{name:"Smoked Trout And Hydra Pate",basicIngredients:6,specialIngredients:2,cookingLoreDC:26,survivalDC:28,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.t5pXd39gRgNkPoiu",level:8,cost:"25 gp",rarity:"uncommon",criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.4d6roHW75xe52o7A"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.LBzsqdKb182lO5Fm",removeAfterRest:!0}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.miTcZbTcQLJu2NKR",removeAfterRest:!0}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.ve7NrzeHMwLsmbl3"}]}},{name:"Onion Soup",basicIngredients:2,specialIngredients:1,cookingLoreDC:24,survivalDC:26,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.laM0IfTV8eviU1vm",level:8,cost:"25 gp",rarity:"common",criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.6Vu7Ts4p79O6JsD2"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.8IzlPm2joulb5r0p",removeAfterRest:!0}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.hHTMldJIDoqpCF7U"}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.pIgoUydEo8wU2Avm"}]}},{name:"Whiterose Oysters",basicIngredients:3,specialIngredients:2,cookingLoreDC:26,survivalDC:28,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.p08orFcjqQzA7KdE",level:9,cost:"35 gp",rarity:"common",favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.E3tZfxCJ5GQoIbei"},{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.cCKgpxIsFevgENf2",removeAfterRest:!0}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.ZDDZz5ynEOR20LUC"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.uw5M3YfEJs23RmX5",removeAfterRest:!0}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.yMsjuwLmbF8h1jVt"}]}},{name:"Kameberry Pie",basicIngredients:3,specialIngredients:2,cookingLoreDC:27,survivalDC:29,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.zX4S7wsOxB8CcVWw",level:10,cost:"50 gp",rarity:"common",success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.elsXArG4GqGin6LB",removeAfterRest:!0}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.lWy7BZYGab0uNf9H"}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.n6ykp8NjXDFcvqXM",removeAfterRest:!0}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.sQz8ugumjOMSHiYt"}]}},{name:"Monster Casserole",basicIngredients:7,specialIngredients:2,cookingLoreDC:28,survivalDC:30,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.gqT2VQGYgDQIMYsW",level:11,cost:"70 gp",rarity:"common",success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.5GT0JeRjYJc8e5ZA",removeAfterRest:!0}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.af6hFeUUfsF1GiX8"}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.gNGXKMmJdNQJZode"}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.qad6gIwEpQQIkZwQ"}]}},{name:"Seasoned Wings And Thighs",basicIngredients:4,specialIngredients:2,cookingLoreDC:30,survivalDC:32,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.BTKN1IgANoof0tfB",level:12,cost:"100 gp",rarity:"common",criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.uchgkN3hm1T51zfM",removeAfterRest:!0},{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.JqKhpMXiQCEsDSCw"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.JqKhpMXiQCEsDSCw"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.q3vnRHRBn3HmRhkV",removeAfterRest:!0}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.xF0K40VzyjIbbRMA"}]}},{name:"Giant Scrambled Egg With Shambletus",basicIngredients:6,specialIngredients:2,cookingLoreDC:33,survivalDC:35,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.IiV8wHXKZS1HbLLW",level:13,cost:"150 gp",rarity:"uncommon",favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.Q1Qg8K9G7R9wU4rI"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.TLxckltEWbHKCXDi"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.pTjrRRqxUJnbDRIB"}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.f2yKkelj374SNszb"}]}},{name:"Mastodon Steak",basicIngredients:4,specialIngredients:3,cookingLoreDC:34,survivalDC:36,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.SfNeVcYxBD4uCfrT",level:14,cost:"225 gp",rarity:"uncommon",criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.0yH2V9UFRyGwXIRn"}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.Ln9Q3cH6NzGZAJUs"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.M6jcQsHsPEkigTTG",removeAfterRest:!0}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.xq4qNyrsL5wVYkcQ",removeAfterRest:!0}]}},{name:"Hearty Purple Soup",basicIngredients:6,specialIngredients:3,cookingLoreDC:40,survivalDC:42,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.yAB0s5JgzCZpf0dT",level:16,cost:"500 gp",rarity:"rare",favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.6RjaP1s58ITIVn6u"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.Zn0CB7bL7vHrMNTU"}]},criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.hLGCjXajAYEcII9J"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.o6F8QZbTvt9os8Ni"},{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.TQXXVzD1ZZHnouTI"},{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.SJvEGeMryIekwIKk"}]}},{name:"Black Linnorm Stew",basicIngredients:8,specialIngredients:3,cookingLoreDC:43,survivalDC:45,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.V6uIWe6BVFV9Ewo3",level:18,cost:"1200 gp",rarity:"rare",criticalSuccess:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.I2LiwNjrowS5u4UG"}]},success:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.m3FgRCWbVupkaORL"}]},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.s1DfJpXFkJorHsuu"}]},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.sxr0BsJJGeLyNBgq"}]}},{name:"First World Mince Pie",basicIngredients:8,specialIngredients:4,cookingLoreDC:45,survivalDC:47,uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.RmMZWrzgd8Wh8z5H",level:20,cost:"3500 gp",rarity:"rare",criticalSuccess:{effects:Object.values(s).map((e=>({uuid:e.criticalSuccessUuid}))),chooseRandomly:!0},criticalFailure:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.72N0nZAAo2iuCGBd"}]},success:{effects:Object.values(s).map((e=>({uuid:e.successUuid}))),chooseRandomly:!0},favoriteMeal:{effects:[{uuid:"Compendium.pf2e-kingmaker-tools.kingmaker-tools-meal-effects.Item.Wfmt1NvfIqF3gFav"}]}}],t.getRecipesKnownInRegion=function(e,t,i){const{zoneLevel:a}=(0,n.getRegionInfo)(e,t);return i.filter((e=>"common"===e.rarity&&e.level<=a))},t.getOutcomeEffects=r,t.getExpiringOutcomeEffects=o,t.getAllMealEffectUuids=function(e){return e.flatMap((e=>[...r(e.criticalFailure,!0),...r(e.success,!0),...r(e.criticalSuccess,!0),...r(e.favoriteMeal,!0)]))},t.getAllExpiringMealEffectUuids=function(e){return e.flatMap((e=>[...o(e.criticalFailure),...o(e.success),...o(e.criticalSuccess),...o(e.favoriteMeal)]))},t.getMealEffectUuids=function(e,t,i){const n=e.name===t?r(e.favoriteMeal,!1):[],a="criticalSuccess"===i||"success"===i||"criticalFailure"===i?r(e[i],!1):[];return"criticalSuccess"===i||"success"===i?[...a,...n]:a},t.getKnownRecipes=function(e){const t=new Set((0,a.getRecipeData)(e).map((e=>e.name)));return e.cooking.knownRecipes.filter((e=>t.has(e)))}},9540:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eventLevels=t.getSeason=t.golarionMonths=t.getRegionInfo=t.toOfficialKingmakerRollTableName=t.regions=void 0,t.regions=new Map,t.regions.set("Brevoy",{zoneDC:14,encounterDC:12,level:0}),t.regions.set("Rostland Hinterlands",{zoneDC:15,encounterDC:12,level:1}),t.regions.set("Greenbelt",{zoneDC:16,encounterDC:14,level:2}),t.regions.set("Tuskwater",{zoneDC:18,encounterDC:12,level:3}),t.regions.set("Kamelands",{zoneDC:19,encounterDC:12,level:4}),t.regions.set("Narlmarches",{zoneDC:20,encounterDC:14,level:5}),t.regions.set("Sellen Hills",{zoneDC:20,encounterDC:12,level:6}),t.regions.set("Dunsward",{zoneDC:18,encounterDC:12,level:7}),t.regions.set("Nomen Heights",{zoneDC:24,encounterDC:12,level:8}),t.regions.set("Tors of Levenies",{zoneDC:28,encounterDC:16,level:9}),t.regions.set("Hooktongue",{zoneDC:32,encounterDC:14,level:10}),t.regions.set("Drelev",{zoneDC:28,encounterDC:12,level:11}),t.regions.set("Tiger Lords",{zoneDC:28,encounterDC:12,level:12}),t.regions.set("Rushlight",{zoneDC:26,encounterDC:12,level:13}),t.regions.set("Glenebon Lowlands",{zoneDC:30,encounterDC:12,level:14}),t.regions.set("Pitax",{zoneDC:29,encounterDC:12,level:15}),t.regions.set("Glenebon Uplands",{zoneDC:35,encounterDC:12,level:16}),t.regions.set("Numeria",{zoneDC:36,encounterDC:12,level:17}),t.regions.set("Thousand Voices",{zoneDC:43,encounterDC:14,level:18}),t.regions.set("Branthlend Mountains",{zoneDC:41,encounterDC:16,level:19}),t.toOfficialKingmakerRollTableName=function(e,t){return`Zone ${`${t.level}`.padStart(2,"0")}: ${e}`},t.getRegionInfo=function(e,i){const n=t.regions.get(i);return{zoneDC:n?.zoneDC??14,zoneLevel:n?.level??0}},t.golarionMonths=new Map,t.golarionMonths.set(1,"Abadius"),t.golarionMonths.set(2,"Calistril"),t.golarionMonths.set(3,"Pharast"),t.golarionMonths.set(4,"Gozran"),t.golarionMonths.set(5,"Desnus"),t.golarionMonths.set(6,"Sarenith"),t.golarionMonths.set(7,"Erastus"),t.golarionMonths.set(8,"Arodus"),t.golarionMonths.set(9,"Rova"),t.golarionMonths.set(10,"Lamashan"),t.golarionMonths.set(11,"Neth"),t.golarionMonths.set(12,"Kuthona");const i=new Map;i.set("Abadius",{coldDC:16,precipitationDC:8,season:"winter"}),i.set("Calistril",{coldDC:18,precipitationDC:8,season:"winter"}),i.set("Pharast",{precipitationDC:15,season:"spring"}),i.set("Gozran",{precipitationDC:15,season:"spring"}),i.set("Desnus",{precipitationDC:15,season:"spring"}),i.set("Sarenith",{precipitationDC:20,season:"summer"}),i.set("Erastus",{precipitationDC:20,season:"summer"}),i.set("Arodus",{precipitationDC:20,season:"summer"}),i.set("Rova",{precipitationDC:15,season:"fall"}),i.set("Lamashan",{precipitationDC:15,season:"fall"}),i.set("Neth",{precipitationDC:15,season:"fall"}),i.set("Kuthona",{coldDC:18,precipitationDC:8,season:"winter"}),t.getSeason=function(e){return i.get(e)},t.eventLevels=new Map,t.eventLevels.set("Fog",0),t.eventLevels.set("Heavy downpour",0),t.eventLevels.set("Cold snap",1),t.eventLevels.set("Windstorm",1),t.eventLevels.set("Hailstorm, severe",2),t.eventLevels.set("Blizzard",6),t.eventLevels.set("Supernatural storm",6),t.eventLevels.set("Flash flood",7),t.eventLevels.set("Wildfire",4),t.eventLevels.set("Subsidence",5),t.eventLevels.set("Thunderstorm",7),t.eventLevels.set("Tornado",12)},2686:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rest=t.getWatchRandomEncounterData=t.getRestHours=t.getWatchSecondsDuration=t.getActorsKeepingWatch=t.calculateDailyPreparationsSeconds=void 0;const n=i(1060),a=i(2190),s=i(1671),r=i(5942),o=i(2761),l=i(8576),c=i(2816);function u(e){return 0===e?1800:3600*Math.ceil(e/4)}function m(e,t){const i=e.campingActivities.find((e=>"Organize Watch"===e.activity&&"criticalSuccess"===e.result)),n=t.length>1&&i?1:0,a=e.actorUuidsNotKeepingWatch.filter((t=>e.actorUuids.includes(t))).length;return t.length+n+e.increaseWatchActorNumber-a}async function d(e,t,i){const n=u(t.gunsToClean),a=t.restRollMode,s=(0,l.getEncounterDC)(t,e),r=i+n,o=t.currentRegion;if("one"===a){if(await(0,l.rollRandomEncounter)(e,o,s)){const e=Math.floor(Math.random()*i);return{encounter:!0,remainingSeconds:r-e,advanceToSeconds:e}}}else if("one-every-4-hours"===a){const t=Math.floor(i/14400),n=Math.floor(4*Math.random()*3600);for(let i=0;i<t;i+=1)if(await(0,l.rollRandomEncounter)(e,o,s)){const e=3600*i*4+n;return{advanceToSeconds:e,remainingSeconds:r-e,encounter:!0}}}return{advanceToSeconds:r,remainingSeconds:0,encounter:!1}}t.calculateDailyPreparationsSeconds=u,t.getActorsKeepingWatch=m,t.getWatchSecondsDuration=async function(e,t){return function(e,t){if(e<2)return t;{let i=t+Math.floor(t/(e-1));return i%60!=0&&(i+=60-i%60),i}}(m(t,e),await async function(e){const t=(0,o.getRecipeData)(e).find((e=>"Fish-On-A-Stick"===e.name)),i=t.favoriteMeal.effects[0].uuid,a=t.criticalFailure.effects[0].uuid,s=await(0,n.getActorsByUuid)(new Set(e.actorUuids)),r=(await Promise.all(s.map((async e=>await(0,n.actorHasEffectByUuid)(e,i)?1:0)))).reduce(((e,t)=>e+t),0),l=(await Promise.all(s.map((async e=>await(0,n.actorHasEffectByUuid)(e,a)?1:0)))).reduce(((e,t)=>e+t),0),c=s.length-(l+r);return Math.floor((28800*c+25200*r+32400*l)/s.length)}(t))},t.getRestHours=function(e,t,i){const n=e+t,a=i>0?Math.max(0,n-i):0;return{currentRestHours:(0,c.formatHours)(a),restHours:(0,c.formatHours)(n)}},t.getWatchRandomEncounterData=d,t.rest=async function(e){const{game:t,camping:i,watchDurationSeconds:l,sheetActor:c}=e,u=await(0,n.getActorsByUuid)(new Set(i.actorUuids));0===i.watchSecondsRemaining?(await async function(e){const t=e.playlists?.getName("Kingmaker.Resting");t&&await Promise.all(t.sounds.map((e=>e.update({playing:!0}))))}(t),i.watchSecondsRemaining=await async function(e,t,i,n){const{advanceToSeconds:s,remainingSeconds:r,encounter:o}=await d(e,t,i);if(await e.time.advance(s),o){const i=n.filter((e=>!t.actorUuidsNotKeepingWatch.includes(e.uuid)&&("character"===e.type||"npc"===e.type)));if(i.length>0){const n=Math.floor(Math.random()*i.length);await(0,a.rollCampingCheck)({game:e,isWatch:!0,secret:!0,region:t.currentRegion,actor:i[n],skill:"perception"})}}return r}(t,i,l,u)):(await t.time.advance(i.watchSecondsRemaining),i.watchSecondsRemaining=0),await(0,s.saveCamping)(t,c,i),0===i.watchSecondsRemaining&&await async function(e,t,i,l){await Promise.all(i.map((async e=>await async function(e,t){if(await(0,n.hasItemByUuid)(e,"effect",new Set([(0,o.getRecipeData)(t).find((e=>"Basic Meal"===e.name)).criticalSuccess.effects[0].uuid,(0,a.getCampingActivityData)(t).find((e=>"Dawnflower's Blessing"===e.name)).effectUuids[0].uuid]))){const t=e.attributes.hp.value,i=e.attributes.hp.max,n=e.abilities.con.mod,a=e.level,s=Math.max(n,1)*a,r=i-t,o=r>=s?s:r;o>0&&await e.update({"system.attributes.hp.value":t+o})}}(e,l)))),l.cooking.degreeOfSuccess=null,l.campingActivities.forEach((e=>e.result=null)),l.dailyPrepsAtTime=e.time.worldTime,await(0,n.removeActorsEffectsByName)(i,new Set(["Undead Guardians (Aided)","Undead Guardians (Defended)"])),await(0,n.removeActorsEffectsByUuid)(i,new Set(["Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.ZKJlIqyFgbKDACnG","Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.pbhKANmDOvwuuchk","Compendium.pf2e-kingmaker-tools.kingmaker-tools-camping-effects.Item.tERAC9KHwBjoUt5u"])),await async function(e,t){const i=(0,o.getRecipeData)(t),a=(0,r.getAllExpiringMealEffectUuids)(i);await(0,n.removeActorsEffectsByUuid)(e,new Set(a))}(i,l),await(0,s.saveCamping)(e,t,l),await e.pf2e.actions.restForTheNight({actors:i,skipDialog:!0})}(t,c,u,i)}},518:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.openCampingSheet=t.CampingSheet=void 0;const n=i(9470),a=i(2816),s=i(8576),r=i(9540),o=i(2977),l=i(2190),c=i(6948),u=i(3018),m=i(5942),d=i(9582),h=i(4954),f=i(8063),p=i(1631),g=i(1917),y=i(8593),v=i(1060),b=i(5514),k=i(74),w=i(282),S=i(1671),C=i(2784),A=i(695),x=i(2686),R=i(2761),I=i(4693),D=i(4848),T=i(4310);class CampingSheet extends FormApplication{diffListeners;static get defaultOptions(){const e=super.defaultOptions;return e.id="camping-app",e.title="Camping Sheet",e.template="modules/pf2e-kingmaker-tools/templates/camping/sheet.hbs",e.classes=["kingmaker-tools-app","camping-app"],e.scrollY=[".camping-sidebar",".camping-content"],e.width=862,e.height="auto",e.dragDrop=[{dropSelector:".new-camping-actor, .camping-activity, .camping-actor, .eating-actor",dragSelector:".camping-actor, .content-link[data-type=Item]"}],e.closeOnSubmit=!1,e.submitOnChange=!0,e.submitOnClose=!1,e.editable=!0,e}isGM;game;actor;constructor(e){super(null,e),this.game=e.game,this.isGM=this.game.user?.isGM??!1,this.actor=e.actor,this.actor.apps[this.appId]=this,this.diffListeners=(0,A.getDiffListeners)(this.game)}async getData(){const e=await this.read(),t=this.game.time.worldTime,i=e.currentRegion,o=Math.abs(t-e.dailyPrepsAtTime),c=(0,l.getCampingActivityData)(e),u=await this.getActors(e),d=await(0,x.getWatchSecondsDuration)(u,e),h=(0,x.getActorsKeepingWatch)(e,u),{total:f,modifier:y}=(0,s.getEncounterDC)(e,this.game),v=await(0,R.getActorConsumables)([...u,...(0,l.getPartyActors)(this.game)]),b=(0,m.getKnownRecipes)(e),k=(0,R.getChosenMealData)(e),w=k.name,S=!this.isGM,C=await(0,n.toViewActors)(e.actorUuids,e.campingActivities,(0,l.getCampingActivityData)(e),S),A=(0,x.calculateDailyPreparationsSeconds)(e.gunsToClean);return{isGM:this.isGM,isUser:S,...v,currentEncounterDCModifier:y,encounterDC:f,watchEnabled:C.length>0,adventuringSince:(0,a.formatHours)(o,e.dailyPrepsAtTime>t),regions:Array.from(r.regions.keys()),currentRegion:i,actors:C,campingActivities:await(0,n.toViewCampingActivities)(e.campingActivities,c,new Set(e.lockedActivities)),watchSecondsDuration:d,dailyPrepsDuration:(0,a.formatHours)(A),watchDuration:(0,a.formatHours)(d),subsistenceAmount:e.cooking.subsistenceAmount,magicalSubsistenceAmount:e.cooking.magicalSubsistenceAmount,chosenMeal:w,knownRecipes:b,knownFavoriteRecipes:b.filter((e=>"Basic Meal"!==e)),degreesOfSuccesses:(0,n.toViewDegrees)(),mealDegreeOfSuccess:e.cooking.degreeOfSuccess,time:(0,g.formatWorldTime)((0,p.getWorldTime)(this.game)),timeMarkerPositionPx:Math.floor(8.46*(0,p.getTimeOfDayPercent)((0,p.getWorldTime)(this.game)))-4,hasCookingActor:(0,R.canCook)(e),consumedFood:(0,R.calculateConsumedFood)((0,R.canCook)(e),v,{actorsConsumingRations:e.cooking.actorMeals.filter((e=>"rationsOrSubsistence"===e.chosenMeal)).length,actorsConsumingMeals:e.cooking.actorMeals.filter((e=>"meal"===e.chosenMeal)).length,availableSubsistence:e.cooking.subsistenceAmount,availableMagicalSubsistence:e.cooking.magicalSubsistenceAmount,recipeBasicIngredientCost:k?.basicIngredients??0,recipeSpecialIngredientCost:k?.specialIngredients??0}),actorMeals:await(0,n.toViewActorMeals)(e.actorUuids,e.cooking.actorMeals,(0,R.getRecipeData)(e)),...await this.getCookingSkillData(e),chosenMealDc:await this.getMealDc(e,k),showContinueRest:0!==e.watchSecondsRemaining,...(0,x.getRestHours)(d,A,e.watchSecondsRemaining),actorsKeepingWatch:h}}async getCookingSkillData(e){const t=await this.cookingActorHasCookingLore(e);return{cookingSkills:[...t?[{value:"cooking",label:"Cooking"}]:[],{value:"survival",label:"Survival"}],cookingSkill:t?e.cooking.cookingSkill:"survival"}}_canDragDrop(){return!0}_canDragStart(){return!0}async getMealDc(e,t){return"survival"===(await this.getCookingSkillData(e)).cookingSkill?t.survivalDC:t.cookingLoreDC}async cookingActorHasCookingLore(e){const t=(0,R.getCookingActorUuid)(e);return!!t&&await(0,v.hasCookingLore)(t)}async getActors(e){return await(0,v.getActorsByUuid)(new Set(e.actorUuids))}_getHeaderButtons(){const e=super._getHeaderButtons();return e.unshift({label:"Help",class:"pf2e-kingmaker-tools-hb1",icon:"fas fa-question",onclick:()=>(0,D.openJournal)("Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.iAQCUYEAq4Dy8uCY.JournalEntryPage.bmKVD2uzBK6Qu8QS")}),this.game.user?.isGM&&e.unshift({label:"Show Players",class:"pf2e-kingmaker-tools-hb2",icon:"fas fa-eye",onclick:()=>this.emit({action:"openCampingSheet"})}),e}emit(e){this.game.socket.emit("module.pf2e-kingmaker-tools",e)}reRender(){this.render()}activateListeners(e){Hooks.on("updateWorldTime",this.reRender.bind(this)),Hooks.on("updateItem",this.reRender.bind(this)),Hooks.on("createItem",this.reRender.bind(this)),Hooks.on("deleteItem",this.reRender.bind(this)),super.activateListeners(e);const t=e[0];(0,y.listenClick)(t,".remove-actor",(async e=>{const t=e.currentTarget,i=t.dataset.uuid,n=t.dataset.type;void 0!==i&&void 0!==n&&await this.removeActor(i,n)})),(0,y.listenClick)(t,".post-combat-effects",(async()=>{const e=await this.read();await(0,n.combatEffectsToChat)(e)})),(0,y.listenClick)(t,".advance-hours",(async e=>{const t=e.currentTarget.dataset.hours??"0";await this.advanceHours(parseInt(t,10))})),(0,y.listenClick)(t,".manage-recipes",(async()=>{const e=await this.read();await(0,u.manageRecipesDialog)({isGM:this.isGM,recipes:(0,R.getRecipeData)(e),learnedRecipes:new Set((0,m.getKnownRecipes)(e)),onSubmit:async(t,i)=>{e.cooking.knownRecipes=Array.from(t),e.cooking.homebrewMeals=e.cooking.homebrewMeals.filter((e=>!i.has(e.name))),await this.update({cooking:e.cooking})}})})),(0,y.listenClick)(t,".add-recipes",(async()=>{const e=await this.read();await(0,d.addRecipeDialog)({recipes:(0,R.getRecipeData)(e),onSubmit:async t=>{e.cooking.homebrewMeals.push(t),await this.update({cooking:e.cooking})}})})),(0,y.listenClick)(t,".manage-activities",(async()=>{await(0,c.manageActivitiesDialog)({game:this.game,actor:this.actor})})),(0,y.listenClick)(t,".subsist",(async e=>{const t=e.currentTarget.dataset.uuid,i=await this.read(),n=await fromUuid(t);n&&await(0,R.subsist)(this.game,n,i.currentRegion)})),(0,y.listenClick)(t,".roll-encounter",(async()=>await this.rollRandomEncounter(!0))),(0,y.listenClick)(t,".check-encounter",(async()=>await this.rollRandomEncounter())),(0,y.listenClick)(t,".consume-food",(async()=>await this.consumeFood())),(0,y.listenClick)(t,".decrease-zone-dc-modifier",(async()=>{const e=await this.read();await this.update({encounterModifier:e.encounterModifier-1})})),(0,y.listenClick)(t,".reset-adventuring-time",(async()=>await this.resetAdventuringSince())),(0,y.listenClick)(t,".eat-food",(async()=>await(0,A.eat)(this.game,await this.read()))),(0,y.listenClick)(t,".increase-zone-dc-modifier",(async()=>{const e=await this.read();await this.update({encounterModifier:e.encounterModifier+1})})),(0,y.listenClick)(t,".reset-zone-dc-modifier",(async()=>await this.update({encounterModifier:0}))),(0,y.listenClick)(t,".cook-food",(async()=>{const e=await this.read(),t=await(0,R.getCookingActorByUuid)(e);if(t){const{cookingSkill:i}=await this.getCookingSkillData(e),n=(0,R.getChosenMealData)(e),a=await this.getMealDc(e,n),s=(0,l.getCampingActivityData)(e).find((e=>"Cook Meal"===e.name)),r=await(0,l.rollCampingCheck)({game:this.game,actor:t,activity:s,dc:a,skill:i,region:e.currentRegion});null!==r&&(e.cooking.degreeOfSuccess=(0,f.degreeToProperty)(r),await this.update({cooking:e.cooking}))}})),(0,y.listenClick)(t,".rest",(async()=>{const e=await this.read(),t=await this.getActors(e);await(0,x.rest)({camping:e,sheetActor:this.actor,game:this.game,watchDurationSeconds:await(0,x.getWatchSecondsDuration)(t,e)})})),(0,y.listenClick)(t,".roll-check",(async e=>{const t=e.currentTarget,i=t.dataset.activity,n=t.dataset.skill;await this.rollCheck(i,n)})),(0,y.listenClick)(t,".recipe-info",(async()=>{const e=await this.read(),t=(0,R.getChosenMealData)(e),i=await fromUuid(t.uuid);i?.sheet?.render(!0)})),(0,y.listenClick)(t,".camping-settings",(async()=>{const e=await this.read(),t=await(0,v.getActorsByUuid)(new Set(e.actorUuids)),i=(0,l.getPartyActors)(this.game);(0,h.campingSettingsDialog)({data:{actors:[...t,...i],huntAndGatherTargetActorUuid:e.huntAndGatherTargetActorUuid,restRollMode:e.restRollMode,gunsToClean:e.gunsToClean,increaseWatchActorNumber:e.increaseWatchActorNumber,ignoreSkillRequirements:e.ignoreSkillRequirements,proxyRandomEncounterTable:(0,T.getStringSetting)(this.game,"proxyEncounterTable"),randomEncounterRollMode:(0,T.getStringSetting)(this.game,"randomEncounterRollMode"),actorsKeepingWatch:t.map((t=>({uuid:t.uuid,name:t.name??"Unknown Actor",watchEnabled:!e.actorUuidsNotKeepingWatch.includes(t.uuid)})))},game:this.game,onSubmit:async e=>await this.update(e)})})),(0,y.listenClick)(t,".camping-actors .actor-image",(async e=>{const t=e.currentTarget.dataset.uuid;void 0!==t&&await this.openUuidSheet(t)})),(0,y.listenClick)(t,".camping-actors .actor-header",(async e=>{const t=e.currentTarget.dataset.uuid;void 0!==t&&await(0,D.openJournal)(t)}))}async rollCheck(e,t){const i=await this.read(),n=(0,l.getCampingActivityData)(i).find((t=>t.name===e)),a=i.campingActivities.find((t=>t.activity===e))?.actorUuid,s=a?await fromUuid(a):null;n&&s&&("Discover Special Meal"===e?await this.discoverSpecialMeal(n,t,s,(0,R.getRecipeData)(i),i.currentRegion):"Hunt and Gather"===e?await this.huntAndGather(n,t,s,i.currentRegion):await this.rollStandardCheck(n,t,s,i.currentRegion))}async rollStandardCheck(e,t,i,n){const a=e.dc,s={skill:t,secret:e.isSecret,activity:e,actor:i,game:this.game,region:n},r=e.name;a?(s.dc=a,await this.setActivityResult(r,await(0,l.rollCampingCheck)(s))):(0,b.askDcDialog)({activity:r,onSubmit:async e=>{s.dc=e,await this.setActivityResult(r,await(0,l.rollCampingCheck)(s))}})}async rollRandomEncounter(e=!1){const t=await this.read(),i=(0,s.getEncounterDC)(t,this.game);await(0,s.rollRandomEncounter)(this.game,t.currentRegion,i,e)}close(e){return Hooks.off("updateWorldTime",this.render),Hooks.off("updateItem",this.render),Hooks.off("createItem",this.render),Hooks.off("deleteItem",this.render),super.close(e)}async advanceHours(e){await this.game.time.advance(3600*e)}async removeActor(e,t){const i=await this.read();if("camping-actors"===t)await this.update({actorUuids:i.actorUuids.filter((t=>t!==e)),campingActivities:i.campingActivities.filter((t=>t.actorUuid!==e))});else{const e=await this.read(),i=e.campingActivities.find((e=>e.activity===t));i&&(i.actorUuid=null,await this.update({campingActivities:e.campingActivities}))}}_onDragStart(e){super._onDragStart(e);const t=e.currentTarget.dataset.uuid;e?.dataTransfer?.setData("text/plain",JSON.stringify({type:"Actor",uuid:t}))}async _onDrop(e){const t=e.currentTarget,i=await this.parseDropData(e);if(i){const e=await this.read();if(!t.classList.contains("camping-activity")||"character"!==i.type&&"npc"!==i.type)t.classList.contains("new-camping-actor")&&!e.actorUuids.includes(i.uuid)?await this.update({actorUuids:[...e.actorUuids,i.uuid]}):(t.classList.contains("camping-actor")&&i instanceof Item||t.classList.contains("eating-actor")&&i instanceof Item)&&await this.handleItemDrop(i,t.dataset.actorUuid);else{const n=t.dataset.name,a=await this.read(),s=(0,l.getCampingActivityData)(a),r=s.find((e=>e.name===n))?.skillRequirements??[];if(i instanceof Actor)try{a.ignoreSkillRequirements||await(0,v.validateSkillProficiencies)(i,r),await this.setActivityActor(e,n,i.uuid)}catch(e){if(!(e instanceof v.NotProficientError))throw e;ui.notifications?.error(e.message)}else await this.handleItemDrop(i,t.dataset.actorUuid)}}}async setActivityActor(e,t,i){const n=e.campingActivities.find((e=>e.activity===t));n?n.actorUuid=i:e.campingActivities.push({activity:t,actorUuid:i,result:null,selectedSkill:null}),await this.update({campingActivities:e.campingActivities})}async parseDropData(e){const t=e.dataTransfer?.getData("text/plain");if(!t)return null;try{const e=JSON.parse(t).uuid;if("string"!=typeof e)return console.error("No uuid found on drop data: "+t),null;const i=await fromUuid(e);if(i){const e=i?.type;return i instanceof Actor&&I.allowedActors.has(e)||i instanceof Item?i:(console.error("No character or item document type, instead found: "+e),null)}}catch(e){console.error(e),console.info(t)}return null}async update(e){await(0,S.saveCamping)(this.game,this.actor,e)}async read(){return(0,S.getCamping)(this.actor)}async openUuidSheet(e){const t=await fromUuid(e);t?.sheet?.render(!0)}async _updateObject(e,t){console.log("formdata",t);const i=await this.read(),n=this.parseNullableSelect(t.mealDegreeOfSuccess),a={currentRegion:t.currentRegion,campingActivities:(0,l.getCampingActivityData)(i).map((e=>{const n=t,a=`actorActivityDegreeOfSuccess.${e.name}`,s=`selectedSkill.${e.name}`;return{activity:e.name,selectedSkill:this.parseNullableSelect(n[s]),result:this.parseNullableSelect(n[a]),actorUuid:i.campingActivities.find((t=>t.activity===e.name))?.actorUuid??null}})),cooking:{magicalSubsistenceAmount:t.magicalSubsistenceAmount,subsistenceAmount:t.subsistenceAmount,chosenMeal:t.chosenMeal,homebrewMeals:i.cooking.homebrewMeals,knownRecipes:(0,m.getKnownRecipes)(i),degreeOfSuccess:n,actorMeals:await this.parseActorMeals(t),cookingSkill:t.cookingSkill}};await this.update(a),this.render()}parseNullableSelect(e){return null==e||0===e.length||"-"===e?null:e}async consumeFood(){const e=await this.read(),t=[...await this.getActors(e),...(0,l.getPartyActors)(this.game)],i=await(0,R.getActorConsumables)(t),n=(0,R.getRecipeData)(e).find((t=>t.name===e.cooking.chosenMeal)),a=(0,R.calculateConsumedFood)((0,R.canCook)(e),i,{actorsConsumingRations:e.cooking.actorMeals.filter((e=>"rationsOrSubsistence"===e.chosenMeal)).length,actorsConsumingMeals:e.cooking.actorMeals.filter((e=>"meal"===e.chosenMeal)).length,availableSubsistence:e.cooking.subsistenceAmount,availableMagicalSubsistence:e.cooking.magicalSubsistenceAmount,recipeBasicIngredientCost:n?.basicIngredients??0,recipeSpecialIngredientCost:n?.specialIngredients??0}),s={rations:a.rations.value,specialIngredients:a.specialIngredients.value,basicIngredients:a.basicIngredients.value};await(0,R.removeFood)(t,s),await ChatMessage.create({content:`Removed up to the following amounts from actor inventories\n                <ul>\n                    <li><b>Rations</b>: ${s.rations}</li>\n                    <li><b>Basic Ingredients</b>: ${s.basicIngredients}</li>\n                    <li><b>Special Ingredients</b>: ${s.specialIngredients}</li>\n                </ul>\n            `})}async parseActorMeals(e){const t=await this.read(),i=e;return t.actorUuids.map((e=>({actorUuid:e,favoriteMeal:this.parseNullableSelect(i["actorFavoriteMeal."+e]),chosenMeal:i["actorChosenMeal."+e]})))}async setActivityResult(e,t){const i=await this.read(),n=i.campingActivities.find((t=>t.activity===e));null!==t&&n&&(n.result=(0,f.degreeToProperty)(t),await this.update({campingActivities:i.campingActivities}))}async handleItemDrop(e,t){const i=await fromUuid(t);i&&await i.createEmbeddedDocuments("Item",[e.toObject()])}async discoverSpecialMeal(e,t,i,n,a){const s=await this.read(),r=await(0,R.getActorConsumables)(await this.getActors(s)),o=(0,m.getRecipesKnownInRegion)(this.game,a,n).filter((e=>!(0,m.getKnownRecipes)(s).includes(e.name)));await(0,k.discoverSpecialMeal)({actor:i,availableFood:r,availableRecipes:o,onSubmit:async n=>{const s=o.find((e=>e.name===n));if(null!==n&&s){const n=await this.read(),r=await(0,l.rollCampingCheck)({game:this.game,actor:i,dc:s.cookingLoreDC,skill:t,activity:e,region:a});if(null!==r){const e=r===f.DegreeOfSuccess.CRITICAL_SUCCESS,t=r===f.DegreeOfSuccess.SUCCESS,a=r===f.DegreeOfSuccess.CRITICAL_FAILURE,o={specialIngredients:e?s.specialIngredients:2*s.specialIngredients,basicIngredients:e?s.basicIngredients:2*s.basicIngredients,rations:2},l=t||e?s.name:null,c=a?s.criticalFailure.effects?.map((e=>e.uuid))??[]:[];await(0,C.postDiscoverSpecialMealResult)(i,o,l,c),await this.persistActivityDegreeOfSuccess(n,r,"Discover Special Meal")}}}})}async persistActivityDegreeOfSuccess(e,t,i){e.campingActivities.forEach((e=>{e.activity===i&&(e.result=(0,f.degreeToProperty)(t))})),await this.update({campingActivities:e.campingActivities})}async huntAndGather(e,t,i,n){const a=await this.read(),s=await(0,l.rollCampingCheck)({game:this.game,actor:i,region:n,skill:t,activity:e,dc:e.dc});if(null!==s){const t=await(0,o.huntAndGather)(this.game,i,s,n);await(0,C.postHuntAndGatherResult)(i,t),await this.persistActivityDegreeOfSuccess(a,s,e.name)}}async resetAdventuringSince(){await(0,S.saveCamping)(this.game,this.actor,{dailyPrepsAtTime:this.game.time.worldTime})}}t.CampingSheet=CampingSheet,t.openCampingSheet=function e(t){const i=t?.actors?.find((e=>"Camping Sheet"===e.name));i?new CampingSheet({game:t,actor:i}).render(!0):(0,w.setupDialog)(t,"Camping","ggZCKHx8DdqAVVP8",(async()=>{const i=t?.actors?.find((e=>"Camping Sheet"===e.name)),n=t?.actors?.filter((e=>"character"===e.type))?.flatMap((e=>{const t=e.getFlag("pf2e-kingmaker-tools","knownRecipes");return Array.isArray(t)?t:[]}))??[];await(i?.setFlag("pf2e-kingmaker-tools","camping-sheet",(0,l.getDefaultConfiguration)(t,n))),await e(t)}))}},1671:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getCampingActor=t.getCamping=t.saveCamping=void 0;const n=i(695);function a(e){const t=e.getFlag("pf2e-kingmaker-tools","camping-sheet");return console.log("Reading",t),deepClone(t)}t.saveCamping=async function(e,t,i){const s=a(t);console.info("Saving",i),await t.setFlag("pf2e-kingmaker-tools","camping-sheet",i),console.log("diff",diffObject(s,i));for(const t of(0,n.getDiffListeners)(e))await t.testFireChange(s,i)},t.getCamping=a,t.getCampingActor=function(e){return e?.actors?.find((e=>"Camping Sheet"===e.name&&e instanceof Actor))??null}},9470:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.combatEffectsToChat=t.toViewActorMeals=t.toViewDegrees=t.toViewCampingActivities=t.toViewActors=t.toViewActor=void 0;const n=i(2190),a=i(8593);async function s(e){const t=await fromUuid(e);return{image:t?.img??"modules/pf2e-kingmaker-tools/static/img/add-actor.webp",uuid:e}}t.toViewActor=s,t.toViewActors=async function(e,t,i,n){return(await Promise.all(e.map((e=>s(e))))).filter((e=>null!==e)).map((e=>{const a=t.filter((e=>"Prepare Campsite"!==e.activity)).find((t=>t.actorUuid===e.uuid)),s=(i.find((e=>e.name===a?.activity&&void 0!==a.activity))?.skills??[]).length>0,r=function(e,t,i){const n=e?.result;return t?null!=n?i?"secret":n:null:"criticalSuccess"}(a,s,n);return{...e,noActivityChosen:!a,activity:a?.activity??null,cssClass:r}}))},t.toViewCampingActivities=async function(e,t,i){const n=e.find((e=>"Prepare Campsite"===e.activity)),r=n?.result??null,o="criticalFailure"!==r&&null!==r,l=await Promise.all(t.map((t=>{const n=(i.has(t.name)||!o)&&"Prepare Campsite"!==t.name;return async function(e,t,i){const n=[],r=t.skills;if("any"===r&&e?.actorUuid){const t=await fromUuid(e.actorUuid);t&&Object.keys(t.skills).forEach((e=>n.push(e)))}else Array.isArray(r)&&r.forEach((e=>n.push(e)));return{name:t.name,actor:e?.actorUuid?await s(e.actorUuid):null,journalUuid:t.journalUuid??null,isSkillCheck:n.length>0,skills:n.map((e=>({value:e,label:(0,a.unslugify)(e)}))),degreeOfSuccess:e?.result??null,slug:(0,a.escapeHtml)(t.name),isSecret:t.isSecret,selectedSkill:e?.selectedSkill??(r.length>0?r[0]:null),isHidden:i,askDc:void 0===t.dc}}(e.find((e=>e.activity===t.name)),t,n)})));return l.sort(((e,t)=>("Prepare Campsite"===e.name?-1:0)-("Prepare Campsite"===t.name?-1:0)||e.name.localeCompare(t.name))),l},t.toViewDegrees=function(){return[{value:"criticalSuccess",label:"Critical Success"},{value:"success",label:"Success"},{value:"failure",label:"Failure"},{value:"criticalFailure",label:"Critical Failure"}]},t.toViewActorMeals=async function(e,t,i){return await Promise.all(e.map((async e=>{const n=t.find((t=>t.actorUuid===e))?.favoriteMeal??null,a=n?i.find((e=>e.name===n))?.uuid??null:null;return{...await s(e),favoriteMeal:n,favoriteMealUuid:a,chosenMeal:t.find((t=>t.actorUuid===e))?.chosenMeal??"meal"}})))},t.combatEffectsToChat=async function(e){const t=await(0,n.getCombatEffects)(e);if(Object.keys(t).length>0){const e=Object.entries(t).map((([e,t])=>`<b>${e} (${t.target})<b>: ${t.uuid}`)).join("<br>");await ChatMessage.create({content:e})}}},5437:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.skillDialog=void 0;const n=i(8593),a=i(6013);class SkillDialog extends FormApplication{onOk;skills;selectedSkills;selectedLores;showLores;all;allProficiency;showAll;atLeastOne;static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-skills-dialog",e.title="Choose Skills",e.template="modules/pf2e-kingmaker-tools/templates/common/skills-dialog.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=[],e.height="auto",e.width=250,e}constructor(e,t){super(e,t),this.skills=t.availableSkills,this.selectedSkills=t.selectedSkills??[],this.selectedLores=t.selectedLores??[],this.showLores=void 0!==t.selectedLores,this.onOk=t.onSave,this.all=t.all??!1,this.showAll=void 0!==t.all,this.allProficiency=t.allProficiency,this.atLeastOne=t.atLeastOne??!1}getData(){return{skills:this.skills.map((e=>{const t=this.selectedSkills.find((t=>t.id===e));return{id:e,label:(0,n.unslugify)(e),selected:void 0!==t,proficiency:t?.proficiency}})),lores:[...this.selectedLores.map((e=>({id:e.id,label:(0,n.unslugify)(e.id),proficiency:e?.proficiency}))),{id:"",label:""}],showLores:this.showLores,proficiencies:a.allTrainedSkillRanks.map((e=>({label:(0,n.capitalize)(e),value:e}))),showAll:this.showAll,all:this.all,allProficiency:this.allProficiency,errors:this.validate()}}async _updateObject(e,t){console.log(t),this.selectedSkills=this.skills.filter((e=>t[e])).map((e=>{const i=t[`${e}-proficiency`];return{id:e,proficiency:"-"===i?void 0:i}}));const i=Object.entries(t).filter((([e,t])=>e.endsWith("-lore")&&!(0,n.isBlank)(t)&&(0,n.slugifyable)(t.trim()))).map((([,e])=>{const i=(0,n.loreToLoreSkill)(e);return{id:i,proficiency:t[i+"-lore-proficiency"]}}));this.selectedLores=(0,n.distinctBy)(i,(e=>e.id)),this.all=t.all,this.allProficiency=t["all-proficiency"],this.render()}activateListeners(e){super.activateListeners(e);const t=e[0];(0,n.listenClick)(t,".save",(async()=>{this.onOk({selectedSkills:this.selectedSkills,selectedLores:this.selectedLores,all:this.all,allProficiency:this.allProficiency}),await this.close()}))}validate(){const e=[];return this.atLeastOne&&0===this.selectedSkills.length&&0===this.selectedLores.length&&!this.all&&e.push("Must select at least one skill"),e}}t.skillDialog=function(e){new SkillDialog(null,e).render(!0)}},8063:(e,t)=>{"use strict";var i;function n(e,t){return 1===e?Math.max(0,t-1):20===e?Math.min(3,t+1):t}Object.defineProperty(t,"__esModule",{value:!0}),t.determineDegreeOfSuccess=t.degreeToProperty=t.allDegreesOfSuccesses=t.DegreeOfSuccess=void 0,function(e){e[e.CRITICAL_FAILURE=0]="CRITICAL_FAILURE",e[e.FAILURE=1]="FAILURE",e[e.SUCCESS=2]="SUCCESS",e[e.CRITICAL_SUCCESS=3]="CRITICAL_SUCCESS"}(i||(t.DegreeOfSuccess=i={})),t.allDegreesOfSuccesses=["criticalSuccess","success","failure","criticalFailure"],t.degreeToProperty=function(e){return e===i.CRITICAL_SUCCESS?"criticalSuccess":e===i.SUCCESS?"success":e===i.FAILURE?"failure":"criticalFailure"},t.determineDegreeOfSuccess=function(e,t,a){return n(e,t<=a-10?i.CRITICAL_FAILURE:t>=a+10?i.CRITICAL_SUCCESS:t>=a?i.SUCCESS:i.FAILURE)}},4848:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.openJournal=void 0,t.openJournal=async function(e){const t=await fromUuid(e);t instanceof JournalEntryPage?t?.parent?.sheet?.render(!0,{pageId:t.id}):t.sheet.render(!0)}},4024:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rollCultEvent=t.rollKingdomEvent=void 0;const n=i(9609),a=i(4310);async function s(e,t){const i=await(0,n.findRollTableUuidWithFallback)(e,t,"pf2e-kingmaker-tools.kingmaker-tools-rolltables"),s={rollMode:(0,a.getStringSetting)(e,"kingdomEventRollMode")};await(0,n.rollRollTable)(e,i,s)}t.rollKingdomEvent=async function(e){const t=(0,a.getStringSetting)(e,"kingdomEventsTable").trim();await s(e,t)},t.rollCultEvent=async function(e){const t=(0,a.getStringSetting)(e,"kingdomCultTable").trim();await s(e,t)}},1573:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.kingdomChatButtons=void 0;const n=i(7066),a=i(943),s=i(357),r=i(447),o=i(3951);t.kingdomChatButtons=[{selector:".km-pay-structure",callback:async(e,t,i)=>{i.preventDefault();const n=i.currentTarget,a=(0,o.parsePayButton)(n);await(0,o.payStructure)(t,a)}},{selector:".km-gain-fame-button",callback:async(e,t,i)=>{i.preventDefault();const a=(0,r.gainFame)((0,n.getKingdom)(t),1);await(0,n.saveKingdom)(t,a)}},{selector:".km-gain-lose",callback:async(e,t,i)=>{i.preventDefault();const n=i.currentTarget;await(0,s.updateResources)(e,t,n)}},{selector:".km-apply-modifier-effect",callback:async(e,t,i)=>{i.preventDefault();const s=i.currentTarget,r=s.dataset.activity,o=s.dataset.degree,l=parseInt(s.dataset.index??"0",10),c=(0,n.getKingdom)(t),u=(0,a.getKingdomActivitiesById)(c.homebrewActivities),m=u[r]?.[o]?.modifiers?.(c)?.[l];if(void 0!==m){const e={...m};void 0!==e.consumeId&&(e.consumeId=crypto.randomUUID());const i=[...c.modifiers,e];await(0,n.saveKingdom)(t,{modifiers:i})}else console.error(`Can not find modifier ${r}.${o}.modifiers.${l}`)}}]},2596:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateAbilityModifier=t.allAbilities=void 0,t.allAbilities=["culture","economy","loyalty","stability"],t.calculateAbilityModifier=function(e){return Math.floor((e-10)/2)}},1154:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getPerformableActivities=t.createActivityLabel=t.enableCompanionActivities=t.groupKingdomActivities=t.getActivitySkills=t.allKingdomPhases=void 0;const n=i(943),a=i(4710);t.allKingdomPhases=["army","civic","commerce","event","leadership","region","upkeep"],t.getActivitySkills=function(e,t){return t?Object.entries(e).filter((([e,i])=>i<=t[e])).map((([e])=>e)):Object.keys(e)},t.groupKingdomActivities=function(e){const t={untrained:new Set,trained:new Set,expert:new Set,master:new Set,legendary:new Set,oncePerRound:new Set,leadership:new Set,region:new Set,event:new Set,army:new Set,commerce:new Set,upkeep:new Set,civic:new Set,companion:new Set};return Object.entries(e).forEach((([e,i])=>{if(t[i.phase].add(e),i.oncePerRound&&t.oncePerRound.add(e),i.companion&&t.companion.add(e),Object.values(i.skills).every((e=>0===e)))t.untrained.add(e);else if(Object.values(i.skills).every((e=>1===e)))t.trained.add(e);else if(Object.values(i.skills).every((e=>2===e)))t.expert.add(e);else if(Object.values(i.skills).every((e=>3===e)))t.master.add(e);else if(Object.values(i.skills).every((e=>4===e)))return t.legendary.add(e),t})),t},t.enableCompanionActivities=function(e,t,i){return Array.from(i[e]).filter((e=>!i.companion.has(e)||t.has(e)))},t.createActivityLabel=function(e,t,i){const s=i.level,r=(0,n.getKingdomActivitiesById)(i.homebrewActivities)[t],o=r.title,l=[];if("claim-hex"===t)s>=9?l.push("three times per turn"):s>=4?l.push("twice per turn"):l.push("once per turn");else if("train-army"===t){const e=a.armyStatisticsByLevel.get(i.level)?.maximumTactics??6;l.push(`Max ${e} per Army`)}return e.trained.has(t)?l.push("trained"):e.expert.has(t)?l.push("expert"):e.master.has(t)&&l.push("master"),e.oncePerRound.has(t)&&l.push("once per turn"),r.hint&&l.push(r.hint),o+(l.length>0?` (${l.join(", ")})`:"")},t.getPerformableActivities=function(e,t,i,n){return Object.fromEntries(Object.values(n).map((n=>{const a=n.skills,s="capital-investment"!==n.id||t,r=i||Object.entries(a).some((([t,i])=>e[t]>=i))&&s;return[n.id,r]})))}},943:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getKingdomActivities=t.getKingdomActivitiesById=t.createResourceButton=t.gainSolution=t.loseUnrest=t.gainUnrest=t.loseRP=t.gainRP=t.loseRolledRD=t.gainRolledRD=t.loseRuin=t.gainRuin=t.loseCommodities=t.gainCommodities=t.loseFame=t.gainFame=t.gainXp=void 0;const n=i(6013),a=i(1155),s=i(8593);function r(e,t=0){return e.map((e=>({[e]:t}))).reduce(((e,t)=>Object.assign(e,t)),{})}const o={"abandon-hex":{title:"Abandon Hex",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:"After careful consideration, you decide that you would rather not hold onto a particular hex as part of your claimed territory. You renounce your claim to it and pull back any settlers or explorers. Attempt a basic Exploration or Wilderness check. You can abandon more than one hex at a time, but each additional hex you abandon increases the DC of this check by 1.",requirement:"The hex to be abandoned must be controlled.",skills:r(["exploration","wilderness"]),criticalSuccess:{msg:`You abandon the hex or hexes, decreasing your kingdom's Size by 1 per hex abandoned (this affects all statistics determined by Size; see page 532). Settlers and explorers return and resettle elsewhere in your kingdom, bringing with them bits of salvage from the abandoned hexes. ${g(1)} per abandoned hex.`},success:{msg:`You abandon the hex or hexes, decreasing your kingdom's Size by 1 per hex abandoned (this affects all statistics determined by Size; see page 532). Settlers and explorers return and resettle elsewhere in your kingdom, bringing with them bits of salvage from the abandoned hexes. ${v(1)}`},failure:{msg:`You abandon the hex or hexes, decreasing your kingdom's Size by 1 per hex abandoned (this affects all statistics determined by Size; see page 532). Some citizens become disgruntled refugees who refuse to leave the hex. ${v(2)} and then attempt a @Check[type:flat|dc:6]. If you fail, the refugees become bandits, and during your next Event phase, your kingdom experiences a Squatters kingdom event automatically in addition to any other event that might occur.`},criticalFailure:{msg:`You abandon the hex or hexes, decreasing your kingdom's Size by 1 per hex abandoned (this affects all statistics determined by Size; see page 532). Some citizens become disgruntled refugees who refuse to leave the hex. ${v(3)} and automatically experience a Bandit Activity kingdom event.`},special:"The Unrest gained from abandoning a hex doubles if it includes a settlement. A settlement in an abandoned hex becomes a Freehold (page 536)."},"build-roads":{title:"Build Roads",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:`<p>You order your kingdom’s engineers to construct a network of robust roads through the hex. Travel along roads uses a terrain type one step better than the surrounding terrain; for example, roads through forest hexes—normally difficult terrain—allow travel as if it were open terrain.</p>\n<p>Spend RP as determined by the hex’s most inhospitable terrain (if the hex includes any rivers that cross the hex from one hex side to any other, you must spend double the normal RP cost to also build bridges; this adds the Bridge structure to that hex):</p>\n<ul>\n<li><b>Mountains</b>: ${y(12)}</li>\n<li><b>Swamps</b>: ${y(8)}</li>\n<li><b>Forests</b>: ${y(4)}</li>\n<li><b>Hills</b>: ${y(2)}</li>\n<li><b>Plains</b>: ${y(1)}</li>\n</ul>\n<p>Then attempt a basic check. Work with the GM to determine where your roads appear on the map.</p>`,requirement:"The hex in which you seek to build roads must be claimed by your kingdom.",skills:r(["engineering"]),criticalSuccess:{msg:"You build roads into the target hex and, if possible, one adjacent claimed hex that doesn’t yet have roads and whose terrain features are at least as hospitable as those of the target hex"},success:{msg:"You build roads in the hex."},failure:{msg:"You fail to build roads in the hex."},criticalFailure:{msg:"Your attempt to build roads ends in disaster. Not only do you fail to build roads, but you lose several workers to an accident, banditry, a vicious monster, or some other unforeseen occurrence. "+v(1)}},"build-structure":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"civic",dc:"custom",title:"Build Structure",description:"You attempt to build a structure in the settlement that’s granting the Civic activity. You may choose any structure for which you meet the requirements. Select the appropriate number of contiguous buildable lots in a single block as specified by the structure’s entry and spend the specified RP and Commodity cost. Then attempt the structure’s skill check.\n\nYou can also use this activity to attempt to repair a structure that was damaged as the result of an event but hasn’t been replaced by Rubble. To do this, first spend half the structure’s listed RP and Commodity cost, and then attempt the specified check. The existing structure gives you a +2 item bonus to the check.\n\nOn a success, record the new construction on the Urban Grid. Unless the structure’s entry states otherwise, its effects are immediate; if the structure adjusts a Ruin’s point total, adjust it upon construction.\n",skills:r([...n.allSkills]),criticalSuccess:{msg:"You construct or repair the structure with great efficiency and get back half of the Commodities spent in construction or repair."},success:{msg:"You construct or repair the structure."},failure:{msg:"You fail to construct or repair the structure. You can try to complete it next Kingdom turn; if you do so, you do not need to re-pay the RP and Commodity cost."},criticalFailure:{msg:"You fail to construct the structure; if you were attempting to repair a damaged structure, it is reduced to Rubble. In either event, Rubble now fills the structure’s lots, which must be cleared with the Demolish activity before you can attempt to Build a Structure in them again."}},"capital-investment":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Capital Investment",description:"You contribute funds from your personal wealth for the good of the kingdom, including coinage, gems, jewelry, weapons and armor salvaged from enemies, magical or alchemical items, and so on. Your contribution generates economic activity in the form of RP that can be used during your current Kingdom turn or on the next Kingdom turn (your choice).\n\nYou can use Capital Investment to repay funds from Tap Treasury (page 528). In this case, no roll is needed and you simply deduct the appropriate amount of funds from your personal wealth to pay back that which was borrowed. When you use Capital Investment to generate RP, the amount of gp required to make an investment is set by your kingdom’s level. Investments below this amount cause your attempt at Capital Investment to suffer an automatic critical failure, while investments above this amount are lost. The investment required is equal to the value listed on Table 10–9: Party Treasure by Level @UUID[Compendium.pf2e.journals.S55aqwWIzpQRFhcq.JournalEntryPage.Ly8l2GT6dbvuY3A2]{Treasure}; use the value for your kingdom’s level under the “Currency per Additional PC” as the required investment value. This is a basic check.",requirement:"You must be within the influence of a settlement that contains at least one Bank.",skills:r(["trade"]),criticalSuccess:{msg:`Success Your kingdom reaps the benefits of your investment. ${f(4)}`},success:{msg:`Your investment helps the economy. ${f(2)}`},failure:{msg:`Your investment ends up being used to shore up shortfalls elsewhere. ${g("1d4")}`},criticalFailure:{msg:`Your investment is embezzled, lost, or otherwise misappropriated. Choose one of the following: either ${f(1)} and also increase your Crime by an equal amount, or gain 0 RP and ${d("crime",1)}`}},"celebrate-holiday":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Celebrate Holiday",description:"You declare a day of celebration. Holidays may be religious, historical, martial, or simply festive, but all relieve your citizens from their labors and give them a chance to make merry at the kingdom’s expense. Attempt a basic check, but if your kingdom Celebrated a Holiday the previous turn, the DC increases by 4, as your kingdom hasn’t had a chance to recover from the previous gala.",skills:r(["folklore"]),criticalSuccess:{msg:"Your holidays are a delight to your people. The event is expensive, but incidental income from the celebrants covers the cost. You gain a +2 circumstance bonus to Loyalty-based checks until the end of your next Kingdom turn.",modifiers:()=>[{turns:2,enabled:!0,abilities:["loyalty"],value:2,name:"Celebrate Holiday: Critical Success",type:"circumstance"}]},success:{msg:`Your holidays are a success, but they’re also expensive. You gain a +1 circumstance bonus to Loyalty-based checks until the end of your next Kingdom turn. ${p(1)}. If you can’t afford this cost, treat this result as a Critical Failure instead.`,modifiers:()=>[{turns:2,enabled:!0,abilities:["loyalty"],value:1,name:"Celebrate Holiday: Success",type:"circumstance"}]},failure:{msg:`The holiday passes with little enthusiasm, but is still expensive. ${p(1)}. If you can’t afford this cost, treat this result as a Critical Failure instead.`},criticalFailure:{msg:`Your festival days are poorly organized, and the citizens actively mock your failed attempt to celebrate. ${w({turn:"next",value:"4",mode:"lose",type:"resource-dice"})}. The failure also causes you to take a –1 circumstance penalty to Loyalty-based checks until the end of the next Kingdom turn.`,modifiers:()=>[{turns:2,enabled:!0,abilities:["loyalty"],value:-1,name:"Celebrate Holiday: Critical Failure",type:"circumstance"}]}},"claim-hex":{title:"Claim Hex",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",requirement:"You have Reconnoitered the hex to be claimed during hexploration. This hex must be adjacent to at least one hex that’s already part of your kingdom. If the hex to be claimed contains dangerous hazards or monsters, they must first be cleared out—either via standard adventuring or the Clear Hex activity.",description:`Your surveyors fully explore the hex and attempt to add it into your kingdom’s domain. ${y(1)} and then attempt a basic Exploration, Intrigue, Magic, or Wilderness check.`,skills:r(["exploration","intrigue","magic","wilderness"]),criticalSuccess:{msg:"You claim the hex and immediately add it to your territory, increasing your kingdom's Size by 1 (this affects all statistics determined by Size; see page 532). Your occupation of the hex goes so smoothly that you can immediately attempt another Region activity."},success:{msg:"You claim the hex and add it to your territory, increasing your kingdom's Size by 1 (this affects all statistics determined by Size; see page 532)."},failure:{msg:"You fail to claim the hex."},criticalFailure:{msg:"You fail to claim the hex, and a number of early settlers and explorers are lost, causing you to take a –1 circumstance penalty to Stability-based checks until the end of your next Kingdom turn.",modifiers:()=>[{turns:2,enabled:!0,abilities:["stability"],value:-1,name:"Claim Hex: Critical Failure",type:"circumstance"}]},special:"At 1st level, when selecting the three activities you take during the Region Activities step of the Activity phase of the Kingdom turn, you may select this activity no more than once. Once your kingdom reaches 4th level, you may select it up to twice per turn, and after reaching 9th level you may select it up to three times per turn. When you successfully claim a hex, gain kingdom XP (see page 540). Many hexes have terrain features that grant benefits to your kingdom when claimed; see Terrain Features on page 535."},"clandestine-business":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Clandestine Business",description:"You know there are criminals in your kingdom, and they know you know. You encourage them to send kickbacks in the form of resources and Commodities to the government, but the common citizens will be more than upset if they find out! This starts as a basic check against your Control DC, but every subsequent Kingdom turn you pursue Clandestine Business, the DC increases by 2. Every Kingdom turn that passes without Clandestine Business reduces the DC by 1 (until you reach your Control DC).",skills:r(["intrigue"],1),criticalSuccess:{msg:`${f(2)}. In addition, you ${u("luxuries","1d4")}. The public is none the wiser.`},success:{msg:`Either ${f(2)}, or gain ${u("luxuries","1d4")}. Regardless of your choice, rumors spread about where the government is getting these “gifts.” ${v(1)}.`},failure:{msg:`${f(1)}. Rumors are backed up with eyewitness accounts. ${v(1)} and ${d("corruption",1)}.`},criticalFailure:{msg:`You gain nothing from the Clandestine Business but angry citizens. ${v("1d6")}, ${d("corruption",2)}, and one other Ruin of your choice by 1.`}},"clear-hex":{oncePerRound:!1,fortune:!1,enabled:!0,title:"Clear Hex",phase:"region",dc:"custom",description:`<p>Engineers and mercenaries attempt to prepare a hex to serve as the site for a settlement, or they work to remove an existing improvement, a dangerous hazard, or an encounter.</p>\n<p>If you’re trying to prepare a hex for a settlement or demolish an improvement you previously built (or that was already present in the hex), spend RP as determined by the hex’s most inhospitable terrain feature:</p>\n<ul>\n<li><b>Mountains</b>: ${y(12)}</li>\n<li><b>Swamps</b>: ${y(8)}</li>\n<li><b>Forests</b>: ${y(4)}</li>\n<li><b>Hills</b>: ${y(2)}</li>\n<li><b>Plains</b>: ${y(1)}</li>\n</ul>\n<p>Then attempt a basic Engineering check. If you’re trying to remove a hazard or encounter, instead attempt an Exploration check. The DC of this check is set by the highest level creature or hazard in the hex (as set by Table 10–5: DCs by Level, on page 503 of the Pathfinder Core Rulebook).</p>\n\n<p>If the hex you’re attempting to Clear has existing Ruins or an existing Structure, your action doesn’t physically remove the buildings from the area and you can later incorporate these buildings (or repair ruined ones) into a Settlement you build here later (see page 542). Regardless of the skill used, increase the basic DC by 2 if the hex to be cleared is not yet part of your kingdom.</p>`,skills:r(["engineering","exploration"]),criticalSuccess:{msg:`You successfully clear the hex. If you spent RP to attempt this activity, you’re refunded half of the RP cost. If you were removing dangerous creatures (but not hazards) from the hex, your explorers and mercenaries recover 2 Luxury Commodities as treasure. ${u("luxuries",2)}`},success:{msg:"You successfully clear the hex."},failure:{msg:"You fail to clear the hex."},criticalFailure:{msg:`You catastrophically fail to clear the hex and several workers lose their lives. ${v(1)}`}},"collect-taxes":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"commerce",dc:"control",title:"Collect Taxes",description:"Tax collectors travel through the lands to collect funds for the betterment of the kingdom. Attempt a basic check.",skills:r(["trade"],1),criticalSuccess:{msg:"Your tax collectors are wildly successful! For the remainder of the Kingdom turn, gain a +2 circumstance bonus to Economy-based checks.",modifiers:()=>[{turns:1,enabled:!0,abilities:["economy"],value:2,name:"Collect Taxes: Critical Success",type:"circumstance"}]},success:{msg:`Your tax collectors gather enough to grant you a +1 circumstance bonus to Economy-based checks for the remainder of the Kingdom turn. If you attempted to Collect Taxes during the previous turn, ${v(1)}`,modifiers:()=>[{turns:1,enabled:!0,abilities:["economy"],value:1,name:"Collect Taxes: Success",type:"circumstance"}]},failure:{msg:`Your tax collectors gather enough to grant you a +1 circumstance bonus to Economy-based checks for the remainder of the Kingdom turn. In addition, people are unhappy about taxes—${v(1)} (or ${v(2)} if you attempted to Collect Taxes the previous turn).`,modifiers:()=>[{turns:1,enabled:!0,abilities:["economy"],value:1,name:"Collect Taxes: Failure",type:"circumstance"}]},criticalFailure:{msg:`Your tax collectors encounter resistance from the citizens and their attempts to gather taxes are rebuffed. While the tax collectors still manage to gather enough taxes to support essential government, they have angered the kingdom's citizens and encouraged rebellious acts. ${v(2)}, and choose one Ruin to increase by 1.`}},"craft-luxuries":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Craft Luxuries",description:`You encourage your artisans to craft luxury goods and may even aid them in this pursuit. ${p(1)}. Then attempt a basic check.`,skills:r(["arts"]),criticalSuccess:{msg:`Your artisans exceed expectations and craft extravagant goods. ${u("luxuries","1d4")}`},success:{msg:`Your artisans produce some delightful goods. ${u("luxuries",1)}`},failure:{msg:"Your artisans fail to produce anything noteworthy."},criticalFailure:{msg:"Your artisans not only fail to produce anything noteworthy, but some took advantage of the opportunity to push their own agendas or earn more for themselves by selling to underground markets. Increase one of your Ruins by 1."}},"create-a-masterpiece":{oncePerRound:!0,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Create a Masterpiece",description:"You encourage your kingdom’s artists to create and display a masterful work of art to bolster your kingdom’s reputation. Attempt a basic check; the result affects either Fame or Infamy (depending on the type of kingdom you’re running). Create a Masterpiece may be attempted only once per Kingdom turn regardless of the number of leaders pursuing activities.",skills:r(["arts"],1),criticalSuccess:{msg:`${l(1)}, and ${w({turn:"next",type:"fame",value:"1"})}. ${f(2)}`},success:{msg:l(1)},failure:{msg:"Your attempt to create a masterpiece fails."},criticalFailure:{msg:`Not only does your attempt to create a masterpiece fail, it does so in a dramatic and humiliating way. ${c(1)}; if you have no Fame or Infamy points to lose, instead ${v("1d4")}`}},"creative-solution":{enabled:!0,oncePerRound:!1,fortune:!0,phase:"leadership",dc:"control",title:"Creative Solution",description:"You work with your kingdom’s scholars, thinkers, and practitioners of magical and mundane experimentation to come up with new ways to resolve issues when business as usual is just not working. Attempt a basic check.",skills:r(["scholarship"]),criticalSuccess:{msg:`You can call upon the solution to aid in resolving any Kingdom skill check made during the remainder of this Kingdom turn ${k("creative-solution")}. Do so when a Kingdom skill check is rolled, but before you learn the result. Immediately reroll that check with a +2 circumstance bonus; you must take the new result. If you don’t use your Creative Solution by the end of this turn, you lose this benefit and gain 10XP instead.`,modifiers:()=>[{turns:1,enabled:!1,value:2,name:"Creative Solution: Critical Success",type:"circumstance",consumeId:""}]},success:{msg:`You can call upon the solution to aid in resolving any Kingdom skill check made during the remainder of this Kingdom turn ${k("creative-solution")}. Do so when a Kingdom skill check is rolled, but before you learn the result. Immediately reroll that check with a +2 circumstance bonus; you must take the new result. If you don’t use your Creative Solution by the end of this turn, you lose this benefit and gain 10XP instead. In addition, ${y("1d4")} to research the solution. This cost is paid now, whether or not you use your Creative Solution.`,modifiers:()=>[{turns:1,enabled:!1,value:2,name:"Creative Solution: Success",type:"circumstance",consumeId:""}]},failure:{msg:`Your attempt at researching is a failure and you ${y("2d6")}. It provides no advantage.`},criticalFailure:{msg:`Your attempt at researching is a failure and you ${y("2d6")}. It provides no advantage. In addition, your scholars and thinkers are so frustrated that you take a –1 circumstance penalty to Culture-based checks until the end of the next Kingdom turn.`,modifiers:()=>[{turns:2,enabled:!0,value:-1,name:"Creative Solution: Critical Failure",type:"circumstance",abilities:["culture"]}]},special:"You cannot influence a check with Supernatural Solution and Creative Solution simultaneously."},"decadent-feasts":{companion:"Jaethal",oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Decadent Feasts",description:`Urgathoa is more than just the goddess of undeath— she’s also the goddess of gluttony. And Jaethal is no fool; she understands the fear her goddess inspires in the living and knows that focusing on other aspects of her worship are more likely to result in positive growth for the nation. In order to distract the populace, she arranges for decadent feasts for the people, simultaneously feeding the hungry while camouflaging some of her faith’s more sinister aspects. ${m("food","1d8")} and ${m("luxuries",1)}, then attempt a basic Agriculture or Trade check to determine how effective the feasts are.`,skills:r(["agriculture"]),criticalSuccess:{msg:`The people rejoice and glut themselves on the repast! ${b("1d6")}, and the next time this Kingdom turn you suffer an effect that increases Unrest, do not increase your Unrest.`},success:{msg:`The people enjoy the meal, but no longer than it takes to gulp it down. ${b("1d3")}`},failure:{msg:`The meal is appreciated, but the people remain suspicious. ${b(1)}.`},criticalFailure:{msg:`The people are too suspicious of the feast to enjoy it. Worse, rumors that Jaethal is trying to distract the citizens from an evil ritual spread. ${v("1d4")} and ${d("corruption",1)}`}},"deliberate-planning":{companion:"Kalikke",oncePerRound:!1,fortune:!0,enabled:!1,phase:"leadership",dc:"custom",title:"Deliberate Planning",description:"Kalikke takes time and weighs all options when faced with decisions, regardless of their importance. While this can sometimes lead her to taking too long to make choices, her theoretical analysis can be quite helpful in navigating continuous events. Choose a single continuous event that will affect your kingdom on this turn’s Event Phase, then attempt a Scholarship check against that event’s DC.",skills:r([...n.allSkills]),criticalSuccess:{msg:"Kalikke’s aid has been monumentally helpful. When you roll to resolve the continuous event you chose, you can roll twice and choose which result to apply. You gain a +1 circumstance bonus to each roll. This is a Fortune effect.",modifiers:()=>[{turns:1,enabled:!1,value:1,name:"Deliberate Planning: Critical Success",type:"circumstance",phases:["event"]}]},success:{msg:"Kalikke’s suggestions are useful, granting you a +1 circumstance bonus to rolls to resolve the chosen continuous event.",modifiers:()=>[{turns:1,enabled:!1,value:1,name:"Deliberate Planning: Success",type:"circumstance",phases:["event"]}]},failure:{msg:"Kalikke’s advice isn’t helpful, but neither does it hinder your ability to handle the event."},criticalFailure:{msg:"You got too caught up in Kalikke’s theoretical analysis and spent too much time preparing. When you roll to resolve the continuous event you tried to plan for, roll twice and take the worse result."}},demolish:{oncePerRound:!1,fortune:!1,enabled:!0,phase:"civic",dc:"control",title:"Demolish",description:"Choose a single occupied lot in one of your settlements and attempt a basic check to reduce it to Rubble and then clear the Rubble away to make ready for a new structure. For multiple-lot structures, you’ll need to perform multiple Demolish activities (or critically succeed at the activity) to fully clear all of the lots. As soon as you begin Demolishing a multiple-lot structure, all of the lots occupied by that structure no longer function.",skills:r(["engineering"]),criticalSuccess:{msg:"Choose one of the following effects: you demolish an entire multiple-lot structure all at once and clear all of the lots it occupied, or you recover [[/r 1d6#Commodities]] Commodities (chosen from lumber, stone, and ore) from the Rubble of a single-lot demolition."},success:{msg:"You demolish the lot successfully."},failure:{msg:"You fail to demolish the lot. It remains in Rubble and cannot be used for further construction until you successfully Demolish it."},criticalFailure:{msg:`You fail to demolish the lot. It remains in Rubble and cannot be used for further construction until you successfully Demolish it. In addition, accidents during the demolition cost you the lives of some of your workers. ${v(1)}`}},"deploy-army":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",title:"Deploy Army",description:"The army moves through your kingdom or beyond. Since this travel occurs over the course of the entire month that preceded the Kingdom turn, the ground an army covers when it deploys can be quite extensive. You can Deploy an Army with an Exploration, Boating, or Magic check.\n\nWhen you use an Exploration check, choose a location within 20 hexes of the army’s current hex. If the army’s starting point and ending point are connected by a road, increase the result one degree of success. Count roadless hexes that contain swamps or mountains, or each hex where you must cross a river or lake without the aid of a bridge, as two hexes. You can issue orders to force march. Doing so grants a +4 circumstance bonus on the check, but causes the army to increase its weary condition by 1 (or by 2, if you fail the check).\n\nWhen you use a Boating check, the army’s starting point and ending point must be connected by a body of water; choose any location within 20 hexes along this route.\n\nYou must be at least master in Magic to attempt a Magic check. When you do so, choose any location within 30 hexes of the army’s current hex, then roll your check. If the army’s deployment causes it to cross your kingdom’s border, the DC increases by 5. If the army’s deployment causes it to cross an enemy kingdom’s border, the DC instead increases by 10.",skills:{warfare:0,boating:0,magic:3},criticalSuccess:{msg:"The army arrives much more quickly than you anticipated; it arrives at its destination and then becomes efficient."},success:{msg:"The army arrives at its destination. "},failure:{msg:"The army arrives at its destination, but ran into some sort of trouble along the way. Increase the army’s weary condition by 1 and attempt a @Check[type:flat|dc:6]; on a failure, reduce the army’s HP by 1."},criticalFailure:{msg:`Rather than arriving at its destination, the army becomes lost until it recovers from this condition. ${v("1d4")}, and attempt a @Check[type:flat|dc:11]; on a failure, reduce the army’s HP by 1.`}},"disband-army":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"none",title:"Disband Army",description:"You can choose to disband an army with no check needed. If the army consisted of conscripts from your kingdom, the soldiers revert to being citizens. If the army was recruited from creatures encountered in the wilds, they return to their homes. A disbanded army no longer contributes to your kingdom’s Consumption.",skills:r([...n.allSkills])},"establish-farmland":{title:"Establish Farmland",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:`You plant crops and establish livestock in permanent farms, ranches, and other growing operations to create Farmland (page 535). If you’re attempting to Establish Farmland in a hex that is predominantly plains, you must ${y(1)} and the check is against your Control DC. If you’re targeting a hex that is predominantly hills, you must spend ${y(2)} and the check is against your Control DC + 5.`,requirement:"Plains or hills are the predominant terrain feature in the hex; the hex is in the influence of one of your settlements.",skills:r(["agriculture"]),criticalSuccess:{msg:"You establish two adjacent Farmland hexes instead of one. If your target hex was a hills hex, the additional hex may be a hills hex or a plains hex; otherwise, the additional hex must be a plains hex. If no appropriate hex is available, treat this result as a regular success instead."},success:{msg:"You establish one Farmland hex."},failure:{msg:"You fail to establish a Farmland hex."},criticalFailure:{msg:"You fail to establish a Farmland hex, and your attempt potentially causes the spread of a blight. At the start of each of the next two Event phases, attempt a @Check[type:flat|dc:6|showDC:all]; on a failure, your kingdom experiences a Crop Failure event in this and all adjacent hexes."}},"establish-settlement":{title:"Establish Settlement",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:"You draw up plans, gather resources, entice citizens, and establish boundaries to found a brand new settlement in the hex. Attempt a basic Engineering, Industry, Politics, or Scholarship check. If you cannot pay the RP required by the result of this check, treat your result as a critical failure. A settlement always starts as a village. See page 540 for further details about building settlements.",requirement:"The hex in which you’re establishing the settlement has been Cleared and doesn’t currently have a settlement (including a Freehold) in it.",skills:r(["engineering","industry","politics","scholarship"]),criticalSuccess:{msg:`You establish the settlement largely with the aid of enthusiastic volunteers. ${y("1d6")}`},success:{msg:`You establish the settlement. ${y("3d6")}`},failure:{msg:`You establish the settlement, but inefficiently and at great expense. ${y("6d6")}`},criticalFailure:{msg:"You fail to establish the settlement."}},"establish-trade-agreement":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"custom",title:"Establish Trade Agreement",description:"You send a band of merchants out to establish a trade agreement between your kingdom and a group with whom you’ve established diplomatic relations. If a navigable river connects your kingdom with the other group’s territory, you can attempt a Boating check to Establish the Trade Agreement. If your kingdom’s proficiency rank in Magic is Master or higher, you can attempt a Magic check. Otherwise, attempt a Trade check.\n\nThe check’s DC is either the group’s Negotiation DC (see sidebar) or your kingdom’s Control DC, whichever is higher.",requirement:"You have diplomatic relations with the group you wish to establish an agreement with.",skills:{boating:0,trade:0,magic:3},criticalSuccess:{msg:`You successfully establish a trade agreement with your target, and your merchants return with gifts! ${f(2)}`},success:{msg:"You successfully establish a trade agreement."},failure:{msg:`Your traders reach their destination but need to sweeten the deal to secure the trade agreement. ${p(2)}. If you do so, you successfully establish a trade agreement, otherwise the attempt fails.`},criticalFailure:{msg:`Your trade agreement is a total loss and your traders do not return. ${v(1)}, and until the end of the next Kingdom turn, take a –1 circumstance penalty to all Economy-related checks.`,modifiers:()=>[{turns:2,enabled:!1,value:-1,name:"Establish Trade Agreement: Critical Failure",type:"circumstance",abilities:["economy"]}]}},"establish-work-site-lumber":{title:"Establish Work Site Lumber",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:`<p>Your hire a crew of workers to travel to a hex that contains Lumber, Ore, or Stone to be harvested. Spend RP as determined by the hex’s most inhospitable terrain:</p>\n<ul>\n<li><b>Mountains</b>: ${y(12)}</li>\n<li><b>Swamps</b>: ${y(8)}</li>\n<li><b>Forests</b>: ${y(4)}</li>\n<li><b>Hills</b>: ${y(2)}</li>\n<li><b>Plains</b>: ${y(1)}</li>\n</ul>\n<p>Then attempt a basic check. Lumber camps can be established in any hex that contains a significant amount of forest terrain. Mines and quarries can be established in any hex that contains a significant amount of hill or mountain terrain.</p>`,skills:r(["engineering"]),criticalSuccess:{msg:"You establish a Work Site in the hex and proceed to discover an unexpectedly rich supply of high quality Commodities. All Commodity yields granted by this site are doubled until the end of the next Kingdom turn."},success:{msg:"You establish a Work Site in the hex."},failure:{msg:"You fail to establish a Work Site in the hex."},criticalFailure:{msg:`Not only do you fail to establish a Work Site, but you lose several workers to an accident, banditry, a vicious monster, or some other unforeseen occurrence. ${v(1)}`}},"establish-work-site-mine":{title:"Establish Work Site Mine",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:`<p>Your hire a crew of workers to travel to a hex that contains Lumber, Ore, or Stone to be harvested. Spend RP as determined by the hex’s most inhospitable terrain:</p>\n<ul>\n<li><b>Mountains</b>: ${y(12)}</li>\n<li><b>Swamps</b>: ${y(8)}</li>\n<li><b>Forests</b>: ${y(4)}</li>\n<li><b>Hills</b>: ${y(2)}</li>\n<li><b>Plains</b>: ${y(1)}</li>\n</ul>\n<p>Then attempt a basic check. Lumber camps can be established in any hex that contains a significant amount of forest terrain. Mines and quarries can be established in any hex that contains a significant amount of hill or mountain terrain.</p>`,skills:r(["engineering"]),criticalSuccess:{msg:"You establish a Work Site in the hex and proceed to discover an unexpectedly rich supply of high quality Commodities. All Commodity yields granted by this site are doubled until the end of the next Kingdom turn."},success:{msg:"You establish a Work Site in the hex."},failure:{msg:"You fail to establish a Work Site in the hex."},criticalFailure:{msg:`Not only do you fail to establish a Work Site, but you lose several workers to an accident, banditry, a vicious monster, or some other unforeseen occurrence. ${v(1)}`}},"establish-work-site-quarry":{title:"Establish Work Site Quarry",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:`<p>Your hire a crew of workers to travel to a hex that contains Lumber, Ore, or Stone to be harvested. Spend RP as determined by the hex’s most inhospitable terrain:</p>\n<ul>\n<li><b>Mountains</b>: ${y(12)}</li>\n<li><b>Swamps</b>: ${y(8)}</li>\n<li><b>Forests</b>: ${y(4)}</li>\n<li><b>Hills</b>: ${y(2)}</li>\n<li><b>Plains</b>: ${y(1)}</li>\n</ul>\n<p>Then attempt a basic check. Lumber camps can be established in any hex that contains a significant amount of forest terrain. Mines and quarries can be established in any hex that contains a significant amount of hill or mountain terrain.</p>`,skills:r(["engineering"]),criticalSuccess:{msg:"You establish a Work Site in the hex and proceed to discover an unexpectedly rich supply of high quality Commodities. All Commodity yields granted by this site are doubled until the end of the next Kingdom turn."},success:{msg:"You establish a Work Site in the hex."},failure:{msg:"You fail to establish a Work Site in the hex."},criticalFailure:{msg:`Not only do you fail to establish a Work Site, but you lose several workers to an accident, banditry, a vicious monster, or some other unforeseen occurrence. ${v(1)}`}},"evangelize-the-dead":{companion:"Harrim",oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Evangelize the Dead",description:"Harrim spends time preaching the End Times. While his sermons certainly aren’t for everyone, his methods avoid deliberately antagonizing those who see hope in the world while simultaneously providing ease and calm to the more desperate among the kingdom’s citizens. Attempt a basic Folklore check to determine how effective his sermons are.",skills:r(["folklore"]),criticalSuccess:{msg:`Harrim’s prayers soothe and calm the more criminal-minded citizens for the time being. ${b("1d4")}, and either ${h("crime",2)} or ${h("corruption",1)} or ${h("strife",1)}.`},success:{msg:`Harrim’s prayers serve to redirect and calm discord. ${b("1d3")}`},failure:{msg:`Harrim’s prayers serve to redirect and calm discord. ${b("1")}`},criticalFailure:{msg:`Harrim’s prayers have unsettled some of your citizens. ${v("1d4")} and ${d("decay",1)} `}},"false-victory":{companion:"Kanerah",oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"False Victory",description:"Kanerah’s contacts with the criminal underworld and her knack for dodging punishment and claiming responsibility for victories she had no direct role in can be harnessed to engineer false victories to trick the kingdom’s citizens into thinking their leaders are doing more than they actually are to create a safe place to live. Such attempts are not without risks, though, for if things backfire, you can cause problems where none existed in the first place. When setting up a false victory, attempt a basic Intrigue check.",skills:r(["intrigue"]),criticalSuccess:{msg:`At the end of this Kingdom turn’s Event Phase, roll again on the random kingdom events table. Rumors of this event being resolved spread throughout your kingdom. You don’t gain any of the benefits of resolving this false victory, but instead ${b("1d6")} and one Ruin of your choice by 1. If you randomly roll that same random kingdom event at any time during the next four kingdom turns, you can attempt an Intrigue check with a +1 circumstance bonus to resolve it rather than the normal check to resolve it.`,modifiers:()=>[{turns:5,enabled:!1,value:1,name:"False Victory: Critical Success",type:"circumstance",phases:["event"],skills:["intrigue"]}]},success:{msg:`Vague rumors of the kingdom’s leaders attaining victories over vague threats spread through the kingdom. ${b("1d3")}`},failure:{msg:`The false event fails to manifest, and rumors of the truth spread throughout the kingdom. ${v(1)}. You cannot attempt False Victory on your next Kingdom turn.`},criticalFailure:{msg:"The truth comes out, and the citizens revolt against this attempt to manipulate them. A Public Scandal event takes place during this kingdom’s event phase, in addition to any other events that would normally take place. Attempt a DC @Check[type:flat|dc:11|showDC:all] check. On a success, the Public Scandal involves a randomly determined leader, but on a failure, the blame falls on Kanerah. Regardless of how the Public Scandal plays out, you cannot attempt False Victory again for 6 Kingdom turns."}},"focused-attention":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:20,title:"Focused Attention",description:"You set aside time to focus attention on aiding another leader in an activity. Choose another leader and a Kingdom skill, then attempt a DC 20 check using the chosen skill. On a success, you grant that leader a +2 circumstance bonus to one kingdom check using that skill, provided that leader attempts the skill check during the same Kingdom turn.\n\nThe Cooperative Leadership Kingdom feat (page 531) increases the efficiency of this activity.",skills:r([...n.allSkills]),criticalSuccess:{msg:"You grant that leader a +2 circumstance bonus to one kingdom check using that skill, provided that leader attempts the skill check during the same Kingdom turn",modifiers:e=>[{turns:1,enabled:!1,consumeId:"",value:(0,a.hasFeat)(e,"Cooperative Leadership")?3:2,name:"Focused Attention: Critical Success",type:"circumstance",rollOptions:["focused-attention"]}]},success:{msg:"You grant that leader a +2 circumstance bonus to one kingdom check using that skill, provided that leader attempts the skill check during the same Kingdom turn",modifiers:e=>[{turns:1,enabled:!1,consumeId:"",value:(0,a.hasFeat)(e,"Cooperative Leadership")?3:2,name:"Focused Attention: Success",type:"circumstance",rollOptions:["focused-attention"]}]}},"fortify-hex":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",title:"Fortify Hex",description:`<p>Your command your engineers to construct a protected encampment, such as a fort or barbican, to serve as a defensive post in the hex. Spend RP as determined by the hex’s most inhospitable terrain:</p>\n<ul>\n<li><b>Mountains</b>: ${y(12)}</li>\n<li><b>Swamps</b>: ${y(8)}</li>\n<li><b>Forests</b>: ${y(4)}</li>\n<li><b>Hills</b>: ${y(2)}</li>\n<li><b>Plains</b>: ${y(1)}</li>\n</ul>\n<p>Then attempt a basic check. A fortified hex grants an additional bonus in warfare (see Appendix 3), but also gives traveling PCs a place to rest that prevents wandering monsters from interrupting their rest.</p>`,requirement:"The target hex must be claimed by your kingdom and must not have a settlement in it.",skills:r(["defense"]),criticalSuccess:{msg:`You find a defensible position for your fortification and finish construction efficiently. Gain a refund of half the RP you spent to build in the hex, then ${b(1)}`},success:{msg:`You establish your fortification in the hex. ${b(1)}`},failure:{msg:"You fail to fortify the hex."},criticalFailure:{msg:`Your attempt ends in disaster. Not only do you fail to build a structure, but you lose several workers to an accident, banditry, a vicious monster, or some other unforeseen occurrence. ${v(1)}`}},"garrison-army":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",title:"Garrison Army",description:"You move an army into a fortification and assign them to guard it. In order to garrison, the army must be located in a hex that contains a Refuge, Settlement, or Work Site. If you’re garrisoning the army in a Refuge hex, attempt a basic Defense check. If you’re garrisoning the army in a settlement, attempt a basic Politics check. If you’re garrisoning the army in a Work Site hex, attempt a basic Engineering check. This check’s DC increases by 5 if the hex is not part of your kingdom, or by 10 if the location is part of an enemy kingdom.",requirement:"The army is in the same hex as a Refuge, Settlement, or Work Site.",skills:r(["defense","politics","engineering"]),criticalSuccess:{msg:"The army becomes fortified until it is deployed. Additionally, the efficiency of the garrisoning reduces this army’s Consumption by 2 (to a minimum of 1) until it is deployed."},success:{msg:"The army becomes fortified until it is deployed."},failure:{msg:"The army becomes fortified until the next Kingdom turn begins, at which point you must use this activity again to maintain the fortified condition."},criticalFailure:{msg:`Your army clashes with local citizens, abuses their authority, lets their watchful readiness slack, and/or provokes confrontations where they are not needed. It does not become fortified, and you cannot attempt to garrison that army at this location again for 4 Kingdom turns. ${v(1)}`}},"gather-livestock":{title:"Gather Livestock",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:"Attempt a basic check to gather excess livestock from local wildlife, ranches, and farms. This generates a number of Food commodities.",skills:r(["wilderness"]),criticalSuccess:{msg:u("food","1d4")},success:{msg:u("food",1)},failure:{msg:"Gain no Food commodities."},criticalFailure:{msg:`${m("food","1d4")} to spoilage. If you have no Food to lose, you instead ${v(1)}`}},"go-fishing":{title:"Go Fishing",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:"Attempt a basic check to fish for food from the rivers and lakes in your kingdom.",requirement:"Must have at least one claimed hex that includes river or lake terrain.",skills:r(["boating"]),criticalSuccess:{msg:u("food","1d4")},success:{msg:u("food",1)},failure:{msg:"Gain no Food commodities."},criticalFailure:{msg:`You lose some fishers to tragic accidents; ${v(1)}`}},"harvest-azure-lily-pollen":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"region",dc:"control",title:"Harvest Azure Lily Pollen",description:"You or a small group of trained herbalists or naturalists work to harvest and process azure lily pollen in hopes of creating a few doses of the poison (detailed on page 584). Attempt a DC 30 Agriculture check. You must then wait 1 Kingdom turn before attempting this activity again, to give the lilies time to recover.",skills:r(["agriculture"],3),criticalSuccess:{msg:"You create 2 doses of azure lily pollen."},success:{msg:`You create 1 dose of azure lily pollen but must also attempt a @Check[type:basic|dc:11|showDC:all]. On a failure, some of the poison makes its way into criminal hands; ${d("crime",1)}`},failure:{msg:`You fail to harvest any azure lily pollen, in part because many of the resources make their way into the kingdom’s criminal underworld. ${d("crime",1)}`},criticalFailure:{msg:`Not only do you fail to harvest any pollen, and not only do resources make their way into the hands of criminals, but whispers and rumors that you allowed this to happen on purpose spread through the kingdom. ${v("1d4")}, ${d("corruption",1)}, and ${d("crime",2)}`}},"harvest-crops":{title:"Harvest Crops",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:"Attempt a basic check to forage for wild edibles or gather excess crops from farms.",skills:r(["agriculture"]),criticalSuccess:{msg:u("food","1d4")},success:{msg:u("food",1)},failure:{msg:"Gain no Food commodities."},criticalFailure:{msg:`${m("food","1d4")} to spoilage; if you have no Food to lose, you instead ${v(1)}`}},"hire-adventurers":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"custom",title:"Hire Adventurers",description:`While the PCs can strike out themselves to deal with ongoing events, it’s often more efficient to Hire Adventurers. When you Hire Adventurers to help end an ongoing event, the DC is equal to your Control DC adjusted by the event’s level modifier. ${p(1)} each time you attempt this activity.`,skills:r(["exploration"]),criticalSuccess:{msg:"You end the continuous event."},success:{msg:"The continuous event doesn’t end, but you gain a +2 circumstance bonus to resolve the event during the next Event phase.",modifiers:()=>[{turns:2,enabled:!1,phases:["event"],value:2,name:"Hire Adventurers: Success",type:"circumstance"}]},failure:{msg:"You fail to end the continuous event. If you try to end the continuous event again, the cost in RP increases to 2 Resource Dice."},criticalFailure:{msg:"You fail to end the continuous event. If you try to end the continuous event again, the cost in RP increases to 2 Resource Dice. In addition, word spreads quickly through the region—you can no longer attempt to end this continuous event by Hiring Adventurers."}},"improve-lifestyle":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"commerce",dc:"control",title:"Improve Lifestyle",description:"Attempt a basic check to draw upon your kingdom’s treasury to enhance the quality of life for your citizens. This activity can be taken only during the Commerce phase of a Kingdom turn",skills:r(["politics"]),criticalSuccess:{msg:"Your push to Improve Lifestyles affords your citizens significant free time to pursue recreational activities. For the remainder of the Kingdom turn, you gain a +2 circumstance bonus to Culture-based checks.",modifiers:()=>[{turns:1,enabled:!0,abilities:["culture"],value:2,name:"Improve Lifestyle: Critical Success",type:"circumstance"}]},success:{msg:"Your push to Improve Lifestyles helps your citizens enjoy life. For the remainder of the Kingdom turn, you gain a +1 circumstance bonus to Culture-based checks.",modifiers:()=>[{turns:1,enabled:!0,abilities:["culture"],value:1,name:"Improve Lifestyle: Success",type:"circumstance"}]},failure:{msg:"Your push to Improve Lifestyles helps your citizens enjoy life. For the remainder of the Kingdom turn, you gain a +1 circumstance bonus to Culture-based checks. In addition, you’ve strained your treasury. Take a –1 circumstance penalty to Economy-based checks for the remainder of this Kingdom turn.",modifiers:()=>[{turns:1,enabled:!0,abilities:["economy"],value:-1,name:"Improve Lifestyle: Failure",type:"circumstance"},{turns:1,enabled:!0,abilities:["culture"],value:1,name:"Improve Lifestyle: Failure",type:"circumstance"}]},criticalFailure:{msg:`Your attempt to Improve Lifestyles backfires horribly as criminal elements in your kingdom abuse your generosity. You take a –1 circumstance penalty to Economy-based checks for the remainder of the Kingdom turn, ${v(1)}, and add 1 to a Ruin of your choice.`,modifiers:()=>[{turns:1,enabled:!0,abilities:["economy"],value:-1,name:"Improve Lifestyle: Critical Failure",type:"circumstance"}]}},infiltration:{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Infiltration",description:"You send spies out to gather intelligence on a neighboring nation, a cult or thieves’ guild within your borders, an unclaimed Freehold, or even an unexplored adventure site. Alternately, you can simply send your spies out to investigate the current health of your kingdom. Attempt a basic check.",skills:r(["intrigue"]),criticalSuccess:{msg:`You learn something valuable or helpful. If you were infiltrating a specific target, the GM decides what is learned, but the information is exact and precise. For example, if you were infiltrating an unexplored ruin, you might learn that the site is infested with web lurkers and spider swarms. If you were investigating your kingdom’s health, your spies reveal easy methods to address citizen dissatisfaction, allowing you to choose one of the following: ${b("1d4")} or reduce a Ruin of your choice by 1.`},success:{msg:`You learn something helpful about the target, but the information is vague and imprecise. For example, if you were infiltrating the same ruin mentioned in the critical success above, you might learn that some sort of aberration uses the ruins as its lair. If you were investigating your kingdom’s health, your spies learn enough that you can take action. ${b(1)}`},failure:{msg:"Your spies fail to learn anything of import, but they are not themselves compromised."},criticalFailure:{msg:"You never hear from your spies again, but someone certainly does! You take a –2 circumstance penalty on all kingdom checks until the end of the next Kingdom turn as counter-infiltration from an unknown enemy tampers with your kingdom’s inner workings.",modifiers:()=>[{turns:2,enabled:!0,value:-2,name:"Infiltration: Critical Failure",type:"circumstance"}]}},irrigation:{oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",title:"Irrigation",description:`<p>You send excavators to build waterways, canals, or drainage systems to convey water from areas that have natural access to a river or lake. Spend RP as determined by the hex’s most inhospitable terrain feature:</p>\n<ul>\n<li><b>Mountains</b>: ${y(12)}</li>\n<li><b>Swamps</b>: ${y(8)}</li>\n<li><b>Forests</b>: ${y(4)}</li>\n<li><b>Hills</b>: ${y(2)}</li>\n<li><b>Plains</b>: ${y(1)}</li>\n</ul>\n<p>Then attempt a basic check.</p>`,requirement:"You control a hex adjacent to a river or lake that itself does not contain a river or lake.",skills:r(["engineering"],1),criticalSuccess:{msg:"The hex gains a river or lake terrain feature (or you change the effects of a previous critical failure at Irrigation in this hex into a failure); work with your GM to determine where these features appear in the hex. In addition, your workers were efficient and quick, and you regain half the RP you spent building the waterways."},success:{msg:"The hex gains a river or lake terrain feature (or you change the effects of a previous critical failure at Irrigation in this hex into a failure); work with your GM to determine where these features appear in the hex."},failure:{msg:"You fail to build workable systems or to restore a previous critical failure, and the hex does not gain the river or lake terrain feature."},criticalFailure:{msg:`You fail to build workable systems or to restore a previous critical failure, and the hex does not gain the river or lake terrain feature. Your attempts at Irrigation are so completely useless that they become breeding grounds for disease. ${v(1)}. From this point onward, at the start of your Kingdom turn’s Event phase, attempt a @Check[type:flat|dc:4]. This flat check’s DC increases by 1 for each hex in your kingdom that contains a critically failed attempt at Irrigation. If you fail this flat check, your kingdom suffers a Plague event in addition to any other event it might have. You can attempt this activity again in a later Kingdom turn to undo a critically failed Irrigation attempt.`}},"manage-trade-agreements":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"commerce",dc:"control",title:"Manage Trade Agreements",description:`You send agents out to attend to established trade agreements. ${y(2)} per Trade Agreement you wish to manage. Then attempt a basic check. If you Managed Trade Agreements on the previous turn, increase this DC by 5.`,skills:r(["trade"]),criticalSuccess:{msg:`${w({value:"1",turn:"next",type:"resource-dice"})} per trade agreement, and 1 Commodity of your choice per trade agreement (no more than half of these Commodities may be Luxuries).`},success:{msg:`${w({value:"1",turn:"next",type:"resource-dice"})} per trade agreement, or 1 Commodity of your choice per trade agreement (no more than half of these Commodities may be Luxuries).`},failure:{msg:`${w({value:"1",turn:"next",type:"resource-points"})} per trade agreement`},criticalFailure:{msg:"You gain no benefit, as your traders and merchants met with bad luck on the road. You can’t Manage Trade Agreements for 1 Kingdom turn."}},"new-leadership":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"upkeep",dc:"control",title:"New Leadership",description:`<p>You announce the promotion of a character into a leadership role, whether they’re a newly appointed leader or just shifting from one leadership role to another. You normally perform this activity at the start of a Kingdom turn, but if unexpected events (such as the death of the character) remove a leader from a leadership role, you may immediately use the New Leadership activity to attempt to assign a new leader to that role, even outside of a Kingdom turn (applying the vacancy penalty for that role as appropriate). Attempt a basic Intrigue, Politics, Statecraft, or Warfare skill check—while any of these skills can be used, each skill is particularly suited to assigning two specific leadership roles.</p>\n<ul>\n<li><b>Intrigue</b>: Grants a +2 circumstance bonus to checks to assign Emissaries and Treasurers.</li>\n<li><b>Politics</b>: Grants a +2 circumstance bonus to checks to assign Counselors and Rulers.</li>\n<li><b>Statecraft</b>: Grants a +2 circumstance bonus to checks to assign Magisters and Viceroys.</li>\n<li><b>Warfare</b>: Grants a +2 circumstance bonus to checks to assign Generals and Wardens.</li>\n</ul>\n\n<p>Rulers are particularly difficult to assign; when you take this activity to assign a new Ruler, you take a –4 circumstance penalty to the skill check, and unless you achieve a critical success, you ${v(1)}. Whether or not you are simultaneously assigning a leader, you may also use this activity to attempt to reselect the four leadership roles that you have invested. Any result other than a critical failure allows this.</p>`,skills:r(["intrigue","politics","statecraft","warfare"]),criticalSuccess:{msg:"The people love the new leader. The leader immediately provides the benefits tied to occupying the new role and gains a +1 circumstance bonus to all Kingdom skill checks they attempt before the end of the next Kingdom turn.",modifiers:()=>[{turns:2,enabled:!1,value:1,name:"New Leadership: Critical Success",type:"circumstance"}]},success:{msg:`The people accept the new leader. The leader immediately provides the benefits tied to occupying the new role. ${v(1)}`},failure:{msg:`The people are unsure about the new leader. The leader takes a –1 circumstance penalty to all checks they attempt as part of their activities during the Activity phase of each Kingdom turn. At the end of the next Kingdom turn, the leader can attempt any Loyalty-based basic skill check to ingratiate themselves with the populace. The leader may attempt this check at the end of each Kingdom turn until they succeed. Success removes this penalty, but a critical failure results in the development detailed in Critical Failure below. ${v(1)}`,modifiers:()=>[{enabled:!1,value:-1,name:"New Leadership: Failure",type:"circumstance"}]},criticalFailure:{msg:`The people reject the new leader. The leadership role is treated as vacant and you must attempt to reassign it using the New Leadership activity at the start of the next Kingdom turn. ${v(1)}`}},"offensive-gambit":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"custom",title:"Offensive Gambit",description:"You order an attack against an enemy army, causing a war encounter to begin after this Kingdom turn ends. No check is necessary if you wish to engage the enemy without attempting to gain an advantage in initiative. If you want to gain an advantage by surprising the enemy, attempt an Intrigue check. If you want to gain an advantage by intimidating the enemy, attempt a Warfare check. In either case, the DC is equal to the enemy army’s Scouting DC.",requirement:"You have at least one army in the same hex as an enemy army.",skills:r(["intrigue"]),criticalSuccess:{msg:"Your approach surprises or intimidates the enemy. Your armies in this hex gain a +2 circumstance bonus on their initiative checks, and one enemy army of the party’s choice in this hex becomes shaken 1."},success:{msg:"Your approach gives you an advantage. Your armies in this hex gain a +2 circumstance bonus on their initiative checks."},failure:{msg:"You gain no advantage in the battle."},criticalFailure:{msg:"Not only do you fail to gain advantage, but the enemy forces have anticipated the attack. Enemy armies in this hex at the time of the Offensive"}},"outfit-army":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",title:"Outfit Army",description:"You provide your army with better gear. Choose what sort of gear you wish to provide your army with from the list beginning on page 67. The level of the gear chosen must be equal to or less than the army’s level. If you’re crafting or purchasing gear, the level of the gear chosen must be equal to or less than your kingdom level. If you’re distributing resources gained from battle, the level of the gear chosen must be equal to or less than the highest level of an enemy army defeated in that battle. \n\nIf you’re purchasing the gear, this activity requires a basic Trade check and costs the standard amount of RP for the gear; you cannot purchase magic gear unless your kingdom is at least expert rank in Magic. \n\nIf you’re distributing gear gained from battle, this activity requires a basic Warfare check and does not cost RP.",skills:r(["trade","warfare"]),criticalSuccess:{msg:"The gear proved particularly easy to outfit, and the army becomes efficient."},success:{msg:"The gear is sufficient, and your army becomes outfitted with it immediately."},failure:{msg:"The gear proves to be unusable and the attempt to outfit the army fails. If you spent RP on the check, it is refunded."},criticalFailure:{msg:"The gear proves to be unusable and the attempt to outfit the army fails."}},"pledge-of-fealty":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Pledge of Fealty",description:"When your representatives encounter freeholders, refugees, independent groups, or other bands of individuals gathered in the wilderness who aren’t already part of a nation, you can offer them a place in your kingdom, granting them the benefits of protection, security, and prosperity in exchange for their fealty. The benefits granted to your kingdom can vary wildly, but often manifest as one-time boons to your commodities or unique bonuses against certain types of events. The adventure text in this campaign offers numerous examples of groups who could accept a Pledge of Fealty.\n\nYou can attempt this skill check with Intrigue, Statecraft, or Warfare; however, certain groups will respond better (or worse) to specific skills. The DC is the group’s Negotiation DC (see the sidebar on page 519).",skills:r(["intrigue","statecraft","warfare"],1),criticalSuccess:{msg:"The group becomes part of your kingdom, granting the specific boon or advantage listed in that group’s entry. If you haven’t already claimed the hex in which the group dwells, you immediately do so, gain 10XP and increasing your kingdom's Size by 1 (this affects all statistics determined by Size; see page 532). If the hex doesn’t share a border with your kingdom, it becomes a secondary territory and checks involving this location take a Control penalty."},success:{msg:`The group becomes part of your kingdom, granting the specific boon or advantage listed in that group’s entry. If the hex doesn’t share a border with your kingdom, it becomes a secondary territory and checks involving this location take a Control penalty. ${p(1)} to the result to integrate the group into your kingdom.`},failure:{msg:`The group refuses to pledge to you at this time. You can attempt to get them to Pledge Fealty next turn. ${v(1)}`},criticalFailure:{msg:`The group refuses to pledge to you—furthermore, it will never Pledge Fealty to your kingdom, barring significant in-play changes or actions by the PCs (subject to the GM’s approval). The group’s potentially violent rebuff of your offer ${v(2)} and increases a Ruin of your choice by 1.`}},"preventative-measures":{companion:"Tristian",oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Preventative Measures",description:"Tristian helps to organize magical defenses and resources to combat potential upcoming disasters or dangers to the kingdom. Attempt a basic Magic check to determine how effective the magical preparations are.",skills:r(["magic"]),criticalSuccess:{msg:"The next time during this Kingdom turn that you attempt a Kingdom skill check to resolve a dangerous event, you gain a +2 circumstance bonus to the check and, unless you roll a critical failure, the result is improved one degree. If you reach the end of this Kingdom turn and haven’t had a dangerous event, you may decrease one Ruin of your choice by 1.",modifiers:()=>[{turns:1,consumeId:"",phases:["event"],enabled:!1,value:2,name:"Preventative Measures: Critical Success",type:"circumstance"}]},success:{msg:"The next time during this Kingdom turn that you attempt a Kingdom skill check to resolve a dangerous event, you gain a +2 circumstance bonus to the check.",modifiers:()=>[{turns:1,consumeId:"",phases:["event"],enabled:!1,value:2,name:"Preventative Measures: Success",type:"circumstance"}]},criticalFailure:{msg:`The attempt to put preventative measures in place has resulted in significant waste of resources. You can’t use Preventative Measures again on your next Kingdom turn, and ${w({turn:"next",value:"2",type:"resource-dice",mode:"lose"})}`}},"process-hidden-fees":{companion:"Jubilost",oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Process Hidden Fees",description:"With Jubilost’s aid, you can process additional taxes, fees, and payments. Attempt a basic Trade check to determine what sorts of additional resources you gather.",skills:r(["trade"]),criticalSuccess:{msg:w({turn:"next",value:"2",type:"resource-dice"})},success:{msg:`${w({turn:"next",value:"1",type:"resource-dice"})}, but the citizens suspect something is going on: if you attempt to Process Hidden Fees on the next Kingdom turn, the result is worsened one degree.`},failure:{msg:`${w({turn:"next",value:"1",type:"resource-dice"})}, but the citizens catch wind of the fees and grow unhappy. ${v(1)}, and you cannot Process Hidden Fees on your next Kingdom turn.`},criticalFailure:{msg:`${w({turn:"next",value:"1",type:"resource-dice"})}, but the citizens catch wind of the fees and grow unhappy. ${v("1d6")}, and you cannot Process Hidden Fees on your next Kingdom turn.`}},prognostication:{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Prognostication",description:"Your kingdom’s spellcasters read the omens and provide advice on how best to prepare for near-future events. Attempt a basic check.",skills:r(["magic"],1),criticalSuccess:{msg:"If you have a random kingdom event this turn, roll twice to determine the event that takes place. The players choose which of the two results occurs, and the kingdom gains a +2 circumstance bonus to the check to resolve the event.",modifiers:()=>[{turns:1,consumeId:"",phases:["event"],enabled:!0,value:2,name:"Prognostication: Critical Success",type:"circumstance"}]},success:{msg:"Gain a +1 circumstance bonus to checks made to resolve random kingdom events this turn.",modifiers:()=>[{turns:1,consumeId:"",phases:["event"],enabled:!0,value:1,name:"Prognostication: Critical Success",type:"circumstance"}]},failure:{msg:"Your spellcasters divine no aid."},criticalFailure:{msg:"Your spellcasters provide inaccurate readings of the future. You automatically have a random kingdom event this turn. Roll twice to determine the event that takes place; the GM decides which of the two results occurs."}},"provide-care":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Provide Care",description:"Attempt a basic check to organize and encourage your settlements’ healers, apothecaries, medics, and other caregivers to provide care and support for citizens in need.",skills:r(["defense"]),criticalSuccess:{msg:`You provide unexpectedly compassionate support for the people. ${b(1)} and reduce one Ruin of your choice by 1.`},success:{msg:`Your care soothes the worries and fears of the populace; ${b(1)}.`},failure:{msg:"You don’t provide any notable care for the citizens, but at least you don’t make things worse."},criticalFailure:{msg:`Your attempt to provide care backfires. ${v(1)} or a Ruin of your choice by 1.`}},"purchase-commodities":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Purchase Commodities",description:`You can spend RP to Purchase Commodities, but doing so is more expensive than gathering them or relying upon trade agreements. When you Purchase Commodities, select the Commodity you wish to purchase (Food, Lumber, Luxuries, Ore, or Stone). ${y(8)} if you’re purchasing Luxuries or ${y(4)} if you’re purchasing any other Commodity. Then attempt a basic check.`,skills:r(["trade"]),criticalSuccess:{msg:`<p>You immediately gain 4 Commodities of the chosen type:</p> <ul>\n<li>${u("food","4")}</li>\n<li>${u("ore","4")}</li>\n<li>${u("lumber","4")}</li>\n<li>${u("stone","4")}</li>\n<li>${u("luxuries","4")}</li>\n</ul><p>and 2 Commodities of any other type (except Luxuries):</p> <ul>\n<li>${u("food","2")}</li>\n<li>${u("ore","2")}</li>\n<li>${u("lumber","2")}</li>\n<li>${u("stone","2")}</li>\n</ul>`},success:{msg:`<p>You gain 2 Commodities of the chosen type.<p> <ul>\n<li>${u("food","2")}</li>\n<li>${u("ore","2")}</li>\n<li>${u("lumber","2")}</li>\n<li>${u("stone","2")}</li>\n<li>${u("luxuries","2")}</li>\n</ul>`},failure:{msg:`<p>You gain 1 Commodity of the chosen type.</p> <ul>\n<li>${u("food","1")}</li>\n<li>${u("ore","1")}</li>\n<li>${u("lumber","1")}</li>\n<li>${u("stone","1")}</li>\n<li>${u("luxuries","1")}</li>\n</ul>`},criticalFailure:{msg:"Failure You gain no Commodities."}},"quell-unrest":{oncePerRound:!0,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Quell Unrest",description:"You send your agents among the citizenry with the charge of suppressing dissent and calming unrest. You can attempt a basic Arts, Folklore, Intrigue, Magic, Politics, or Warfare check to Quell Unrest, but you can never use the same skill for this activity in consecutive Kingdom turns. This activity cannot be attempted more than once per Kingdom turn.",skills:r(["arts","folklore","intrigue","magic","politics","warfare"]),criticalSuccess:{msg:b("1d6")},success:{msg:b(1)},failure:{msg:"You fail to reduce Unrest."},criticalFailure:{msg:`You not only fail to reduce Unrest, but actually incite further anger among the citizenry. Choose one of the following: ${v("1d4")} or increase two Ruins of your choice by 1.`}},"read-all-about-it":{companion:"Linzi",oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Read All About It",description:"You take advantage of your nation’s paper to print an extra edition, a bonus-sized issue, or something to spread news to the citizens of the nation so that they are more prepared for upcoming events or more informed on how to deal with ongoing events. Attempt a basic Scholarship check to determine how helpful the information proves to be.",requirement:"You have built a Printing Press",skills:r(["scholarship"]),criticalSuccess:{msg:"Your kingdom becomes particularly prepared. The next time you attempt a skill check to resolve any event during this Kingdom turn, you gain a +4 circumstance bonus to the roll.",modifiers:()=>[{turns:1,consumeId:"",phases:["event"],enabled:!0,value:4,name:"Read All About It: Critical Success",type:"circumstance"}]},success:{msg:"The information is helpful, but only against ongoing events. The next time you attempt a skill check to resolve an ongoing event during this Kingdom turn, you gain a +2 circumstance bonus to the roll.",modifiers:()=>[{turns:1,consumeId:"",phases:["event"],enabled:!1,value:2,name:"Read All About It: Success",type:"circumstance"}]},failure:{msg:"You fail to prepare your people for the worst."},criticalFailure:{msg:"Critical parts of the information you published are false. You take a –2 circumstance penalty to all skill checks made to resolve Kingdom events for the remainder of this Kingdom turn",modifiers:()=>[{turns:1,phases:["event"],enabled:!0,value:-2,name:"Read All About It: Critical Failure",type:"circumstance"}]}},"recover-army":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",title:"Recover Army",description:"\n        When an army endures ill fortune, it can become afflicted by negative conditions. You can use the Recover Army activity to work at removing an affliction with a basic skill check (this DC increases by 5 if you are attempting to Recover from the defeated condition); the skill required for the check depends on the affliction:\n        <table>\n        <tr>\n        <th>Condition</th>\n        <th>Skill Check to Recover</th>\n        </tr>\n        <tr>\n            <td>Damaged</td>\n            <td>Defense or Folklore (expert)</td>\n        </tr>\n        <tr>\n            <td>Defeated</td>\n            <td>Politics (master) or Warfare (expert)</td>\n        </tr>\n        <tr>\n            <td>Lost</td>\n            <td>Exploration or Wilderness (expert)</td>\n        </tr>\n        <tr>\n            <td>Mired or Pinned</td>\n            <td>Engineering or Magic (expert)</td>\n        </tr>\n        <tr>\n            <td>Shaken</td>\n            <td>Arts or Warfare (expert)</td>\n        </tr>\n        <tr>\n            <td>Weary</td>\n            <td>Arts (expert) or Defense</td>\n        </tr>                \n        </table>\n        ",skills:{defense:0,folklore:2,politics:3,warfare:2,exploration:0,wilderness:2,engineering:0,magic:2,arts:2},criticalSuccess:{msg:"You reduce the affliction’s value by 2 (or in the case of a damaged army, increase its HP by 2 up to its maximum). If the affliction does not have a value, it is removed."},success:{msg:"As critical success but you reduce the affliction’s value by 1 (or in the case of a damaged army, increase its HP by 1 up to its maximum)."},failure:{msg:"You fail to remove the affliction. "},criticalFailure:{msg:"You fail to remove the affliction and your soldier’s lowered morale spreads discontent; "+v(1)+". If you were attempting to recover a defeated army, the army is destroyed."}},"recruit-army":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"custom",title:"Recruit Army",description:"Either you recruit an army from your kingdom’s citizens, or you secure the allegiance of a specialized army you encountered in the Stolen Lands. If you’re recruiting an army from your kingdom’s citizens, choose one of the basic armies listed at the start of page 570 and attempt a Warfare check against the army’s Recruitment DC. If you’re securing a specialized army, you must attempt a Statecraft check against the Recruitment DC;",skills:r(["warfare","statecraft"]),criticalSuccess:{msg:"You recruit the army; it becomes efficient."},success:{msg:"You recruit the army."},failure:{msg:"You fail to recruit the army."},criticalFailure:{msg:`Many of the individuals in the army you attempted to recruit took offense at the attempt. ${v(1)}, and you cannot attempt to recruit an army again until the next Kingdom turn.`}},"recruit-monsters":{companion:"Nok-Nok",oncePerRound:!1,fortune:!1,enabled:!1,phase:"region",dc:"control",title:"Recruit Monsters",description:"While Nok-Nok is quick to suggest that most of the monsters the party encounters during their adventures deserve killing, he also understands that there can be exceptions. Some can be bribed or allied with, while others can be trusted to act on their instincts—a canny person can capitalize on these instincts or alliances to bolster a kingdom’s defenses. Attempt a basic Intrigue check.",skills:r(["intrigue"]),criticalSuccess:{msg:"You manage to locate a monster’s lair and take steps to incorporate it into your kingdom’s defense. The next time your kingdom suffers a Bandit Activity, Monster Activity, Sacrifices, or Undead Uprising random event, you can use your recruited monster to help resolve the event. Doing so removes the Recruited Monster from your kingdom (you can attempt to recruit a new monster on a future kingdom turn though) but allows you to roll a skill check twice when resolving the Dangerous Hex event, taking the better of the two results as your actual result. This is a fortune effect.\n\nYour kingdom can support 1 Recruited Monster at a time. If your kingdom is master in Intrigue, you can support up to 2 Recruited Monsters at a time, and if your kingdom is legendary in Intrigue, you can support up to 3 Recruited Monsters at a time."},success:{msg:"You locate a monster’s lair but can’t recruit it into your kingdom’s defense just yet. If you attempt this activity on your next kingdom turn; the result of that check is improved one degree as you continue to build a rapport with the monster."},failure:{msg:"You fail to locate a monster, or if you were recruiting a monster you didn’t succeed at recruiting on the previous turn, that monster moves on and you must start the recruitment procedure from scratch in the future."},criticalFailure:{msg:"You found a monster, but it proves impossible to recruit. Worse, you’ve attracted its attention. A Monster Activity event occurs during the kingdom’s next Event Phase, in addition to any other potential random events."}},"relocate-capital":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Relocate Capital",description:"One of your settlements that is not your current capital must contain a Castle, Palace, or Town Hall. All leaders must spend all of their leadership activities during the Activity phase of a Kingdom turn on this activity. The kingdom leaders announce that they are uprooting the seat of government from its current home and reestablishing it in another settlement. Attempt a check with a DC equal to the kingdom’s Control DC + 5. You cannot Relocate your Capital again for at least 3 Kingdom turns.",skills:r(["industry"],1),criticalSuccess:{msg:"The move goes off splendidly, with people excited about the new capital and celebrating the leadership’s wisdom."},success:{msg:`The move goes smoothly and with minimal disruption, but some folks are upset or homesick. ${v(1)}`},failure:{msg:`The move causes unhappiness. ${v(1)} and increase two Ruins of your choice by 1.`},criticalFailure:{msg:`The people reject the idea of the new capital and demand you move it back. The move is unsuccessful, and your capital remains unchanged. ${v("1d4")}. Increase three Ruins of your choice by 1 and the fourth Ruin by 3.`}},"repair-reputation-corruption":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",dcAdjustment:2,title:"Repair Reputation Corruption",description:"When things have gotten out of hand in the kingdom and the nation’s reputation has become damaged, you can focus efforts on a campaign to reassure the citizens and bring them closer together, stamp down crime, organize repairs and maintenance of public structures, or strive to adjust poor public opinions.\n\nThe skill used to Repair Reputation depends on which Ruin total you wish to reduce. If you wish to reduce your Corruption, you attempt an Arts check. If you wish to reduce your Crime, you attempt a Trade check. If you wish to reduce your Decay, you attempt an Engineering check. If you wish to reduce your Strife, you attempt an Intrigue check. In all cases, the DC is your Control DC + 2.",skills:r(["arts"],1),criticalSuccess:{msg:`${h("corruption",2)} and reduce its current ruin penalty by 1 to a minimum of 0.`},success:{msg:h("corruption",1)},failure:{msg:"You fail to reduce the targeted Ruin. You cannot attempt to Repair Reputation on this Ruin for 1 Kingdom turn."},criticalFailure:{msg:`You fail to reduce the targeted Ruin in a particularly public and embarrassing way. ${v("1d4")}, and you cannot attempt to Repair Reputation for 3 Kingdom turns.`}},"repair-reputation-crime":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",dcAdjustment:2,title:"Repair Reputation Crime",description:"When things have gotten out of hand in the kingdom and the nation’s reputation has become damaged, you can focus efforts on a campaign to reassure the citizens and bring them closer together, stamp down crime, organize repairs and maintenance of public structures, or strive to adjust poor public opinions.\n\nThe skill used to Repair Reputation depends on which Ruin total you wish to reduce. If you wish to reduce your Corruption, you attempt an Arts check. If you wish to reduce your Crime, you attempt a Trade check. If you wish to reduce your Decay, you attempt an Engineering check. If you wish to reduce your Strife, you attempt an Intrigue check. In all cases, the DC is your Control DC + 2.",skills:r(["trade"],1),criticalSuccess:{msg:`${h("crime",2)} and reduce its current ruin penalty by 1 to a minimum of 0.`},success:{msg:h("crime",1)},failure:{msg:"You fail to reduce the targeted Ruin. You cannot attempt to Repair Reputation on this Ruin for 1 Kingdom turn."},criticalFailure:{msg:`You fail to reduce the targeted Ruin in a particularly public and embarrassing way. ${v("1d4")}, and you cannot attempt to Repair Reputation for 3 Kingdom turns.`}},"repair-reputation-decay":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",dcAdjustment:2,title:"Repair Reputation Decay",description:"When things have gotten out of hand in the kingdom and the nation’s reputation has become damaged, you can focus efforts on a campaign to reassure the citizens and bring them closer together, stamp down crime, organize repairs and maintenance of public structures, or strive to adjust poor public opinions.\n\nThe skill used to Repair Reputation depends on which Ruin total you wish to reduce. If you wish to reduce your Corruption, you attempt an Arts check. If you wish to reduce your Crime, you attempt a Trade check. If you wish to reduce your Decay, you attempt an Engineering check. If you wish to reduce your Strife, you attempt an Intrigue check. In all cases, the DC is your Control DC + 2.",skills:r(["engineering"],1),criticalSuccess:{msg:`${h("decay",2)} and reduce its current ruin penalty by 1 to a minimum of 0.`},success:{msg:h("decay",1)},failure:{msg:"You fail to reduce the targeted Ruin. You cannot attempt to Repair Reputation on this Ruin for 1 Kingdom turn."},criticalFailure:{msg:`You fail to reduce the targeted Ruin in a particularly public and embarrassing way. ${v("1d4")}, and you cannot attempt to Repair Reputation for 3 Kingdom turns.`}},"repair-reputation-strife":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",dcAdjustment:2,title:"Repair Reputation Strife",description:"When things have gotten out of hand in the kingdom and the nation’s reputation has become damaged, you can focus efforts on a campaign to reassure the citizens and bring them closer together, stamp down crime, organize repairs and maintenance of public structures, or strive to adjust poor public opinions.\n\nThe skill used to Repair Reputation depends on which Ruin total you wish to reduce. If you wish to reduce your Corruption, you attempt an Arts check. If you wish to reduce your Crime, you attempt a Trade check. If you wish to reduce your Decay, you attempt an Engineering check. If you wish to reduce your Strife, you attempt an Intrigue check. In all cases, the DC is your Control DC + 2.",skills:r(["intrigue"],1),criticalSuccess:{msg:`${h("strife",2)} and reduce its current ruin penalty by 1 to a minimum of 0.`},success:{msg:h("strife",1)},failure:{msg:"You fail to reduce the targeted Ruin. You cannot attempt to Repair Reputation on this Ruin for 1 Kingdom turn."},criticalFailure:{msg:`You fail to reduce the targeted Ruin in a particularly public and embarrassing way. ${v("1d4")}, and you cannot attempt to Repair Reputation for 3 Kingdom turns.`}},"repair-the-flooded-mine":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:32,title:"Repair the Flooded Mine",description:`A group of engineers work to drain the flooded mine, shore up its damaged section, and establish the mine as a functional Work Site. ${y(20)}, then attempt a DC 32 Engineering check.`,skills:r(["engineering"],3),criticalSuccess:{msg:"The mine is repaired, and as a bonus, your workers Establish a Work Site at the mine immediately. This mine produces 2 Ore Commodities per Kingdom turn."},success:{msg:"The mine is repaired. This mine produces 2 Ore Commodities per Kingdom turn."},failure:{msg:"Work on repairing the mine proceeds, but at a much slower (and more expensive) pace than you’d hoped. The mine remains flooded, but you can attempt this check again on the next Kingdom turn."},criticalFailure:{msg:`Work on repairing the mine proceeds, but at a much slower (and more expensive) pace than you’d hoped. The mine remains flooded, but you can attempt this check again on the next Kingdom turn. In addition, a catastrophic failure costs the lives of several workers. ${v(2)} and ${d("decay",1)}. The next time you attempt to Repair the Flooded Mine, it costs 40 RP.`}},"request-foreign-aid":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"custom",title:"Request Foreign Aid",description:"When disaster strikes, you send out a call for help to another nation with whom you have diplomatic relations. The DC of this check is equal to the other group’s Negotiation DC +2 (see the sidebar on page 519).",requirement:"You have diplomatic relations with the group you are requesting aid from.",skills:r(["statecraft"],1),criticalSuccess:{msg:`Your ally’s aid grants a +4 circumstance bonus to any one Kingdom skill check attempted during the remainder of this Kingdom turn. You can choose to apply this bonus to any Kingdom skill check after the die is rolled, but must do so before the result is known. In addition, ${f(2)}; this RP does not accrue into XP at the end of the turn if you don’t spend it.`,modifiers:()=>[{turns:1,consumeId:"",enabled:!1,value:4,name:"Request Foreign Aid: Critical Success",type:"circumstance"}]},success:{msg:`Your ally’s aid grants you either a +2 circumstance bonus to any one Kingdom skill check attempted during the remainder of this Kingdom turn or ${f(1)}. This RP does not accrue into XP at the end of the turn if you don’t spend it. You can choose to apply the bonus to any Kingdom skill check after the die is rolled, but must do so before the result is known.`,modifiers:()=>[{turns:1,consumeId:"",enabled:!1,value:2,name:"Request Foreign Aid: Success",type:"circumstance"}]},failure:{msg:`Your ally marshals its resources but cannot get aid to you in time to deal with your current situation. ${w({turn:"next",value:"1d4",type:"resource-points"})}`},criticalFailure:{msg:`Your ally is tangled up in its own problems and is unable to assist you, is insulted by your request for aid, or might even have an interest in seeing your kingdom struggle against one of your ongoing events. Whatever the case, your pleas for aid make your kingdom look desperate. You gain no aid, but you do ${v("1d4")}.`}},"rest-and-relax":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Rest and Relax",description:"Working non-stop can burn out even the most devoted and dedicated individual. As such, it’s important to take time for yourself, and thus set a good example for the nation.\n\nYou take time to relax, and you extend the chance to unwind to your citizens as well. The Kingdom skill you use to determine the effectiveness of your time off depends on how you want to spend it: Use a basic Arts check to spend the time engaged in entertainment or the pursuit of a hobby. Use a basic Boating check to enjoy trips on the lakes and rivers of your kingdom. Use a basic Scholarship check to spend the time reading or studying a topic of personal interest beyond your daily duties. Use a basic Trade check to spend your time shopping or feasting. Use a basic Wilderness check to get away from the bustle and relax in the countryside. If your kingdom Rested and Relaxed the previous Kingdom turn, the DC increases by 4, as your kingdom’s production and output hasn’t had a chance to catch up to all those vacation days.",skills:r(["arts","boating","scholarship","trade","wilderness"]),criticalSuccess:{msg:"The citizens enjoy the time off and are ready to get back to work. "+b(1)+", and the next Leadership activity you take gains a +2 circumstance bonus.",modifiers:()=>[{turns:1,consumeId:"",phases:["leadership"],enabled:!0,value:2,name:"Rest and Relax: Success",type:"circumstance"}]},success:{msg:`The time spent relaxing has calmed nerves; ${b(1)}.`},failure:{msg:"The rest is welcome, but not particularly beneficial in the long term."},criticalFailure:{msg:"The time is wasted, and when you get back to work, you have to spend extra time catching up. Take a –2 circumstance penalty to your next skill check made as a Leadership activity.",modifiers:()=>[{turns:1,consumeId:"",phases:["leadership"],enabled:!0,value:-2,name:"Rest and Relax: Critical Failure",type:"circumstance"}]}},"restore-the-temple-of-the-elk":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:25,title:"Restore the Temple of the Elk",description:`You work with several worshippers of Erastil, gifted masons, and skilled laborers to restore the temple and once more consecrate it as a sacred place devoted to the worship of Erastil. ${y("1d6")}, then attempt a DC 25 Folklore check.`,skills:r(["folklore"]),criticalSuccess:{msg:"The temple is restored and can now serve as a Refuge terrain feature. If you later build a settlement here, the temple instead functions as a free Shrine in the settlement. In addition, your work was so excellent that you’ve attracted Erastil’s attention! The PC who rolled the Folklore check is granted Erastil’s minor boon: whenever that PC critically fails a check to Subsist in the wild, they gain a failure instead. @UUID[Compendium.pf2e.boons-and-curses.hrTl9kfSNrOQeNze]{Erastil - Minor Boon}"},success:{msg:"The temple is restored and can now serve as a Refuge terrain feature. If you later build a settlement here, the temple instead functions as a free Shrine in the settlement."},failure:{msg:"Work proceeds but is not yet complete; you can attempt to restore the temple again on the next Kingdom turn."},criticalFailure:{msg:`Disaster strikes as the temple’s cavern collapses and rubble spills out to bury and destroy much of the temple’s plaza. ${d("decay",1)} and ${v("1d4")}. You can still attempt to Restore the Temple, but the DC for success increases by 4. This increase is cumulative with successive critical failures.`}},"send-diplomatic-envoy":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"custom",title:"Send Diplomatic Envoy",description:"You send emissaries to another group to foster positive relations and communication. The DC of this check is the group’s Negotiation DC (see the sidebar on page 519). Attempts to Send a Diplomatic Envoy to a nation with which your kingdom is at war take a –4 circumstance penalty to the check and have the result worsened one degree. At the GM’s option, some wars might be so heated that this activity has no chance of success.",skills:r(["statecraft"],1),criticalSuccess:{msg:"Your envoys are received quite warmly and make a good first impression. You establish diplomatic relations with the group (see page 534 for more information) and gain a +2 circumstance bonus to all checks made with that group until the next Kingdom turn.",modifiers:()=>[{turns:1,enabled:!1,value:2,name:"Send Diplomatic Envoy: Critical Success",type:"circumstance"}]},success:{msg:"You establish diplomatic relations."},failure:{msg:"Your envoys are received, but the target organization isn’t ready to engage in diplomatic relations. If you attempt to Send a Diplomatic Envoy to the group next Kingdom turn, you gain a +2 circumstance bonus to that check.",modifiers:()=>[{turns:2,enabled:!1,value:2,activities:["send-diplomatic-envoy"],name:"Send Diplomatic Envoy: Success",type:"circumstance"}]},criticalFailure:{msg:`Disaster! Your envoy fails to reach their destination, is turned back at the border, or is taken prisoner or executed, at the GM’s discretion. The repercussions on your kingdom’s morale and reputation are significant. Choose one of the following results: ${v("1d4")}, add 1 to a Ruin of your choice, or ${p(2)}. In any event, you cannot attempt to Send a Diplomatic Envoy to this same target for the next 3 Kingdom Turns.`}},"show-of-force":{companion:"Regongar",oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Show of Force",description:"Using Regongar’s advice, a public show of force is performed in an attempt to curtail criminal activity or subversive activity in the kingdom. Attempt a basic Warfare check to determine how effective the Show of Force is.",skills:r(["warfare"]),criticalSuccess:{msg:`The kingdom’s criminals are cowed by the show of force. ${h("crime",2)} and reduce one other Ruin of your choice by 1.`},success:{msg:`The kingdom’s criminals take note of the show of force. ${h("crime",1)}`},failure:{msg:`The show of force fails to impress criminals but unsettles the rest of the citizens. ${v(1)}.`},criticalFailure:{msg:`The criminals are emboldened by the failed show of force. ${v("1d4")} and ${d("crime",1)}.`}},"spread-the-legend":{companion:"Linzi",oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Spread the Legend",description:"Linzi works to spread the word of the party’s heroics and achievements, both through word of mouth and by distributing chapbooks or one-sheets detailing their exploits. Attempt a basic Arts check to determine the success of Linzi’s efforts. If she has secured a printing press for the kingdom after the PCs help with her quest (see To Ask for Forgiveness, below), the Arts check gains a +2 item bonus.",skills:r(["arts"]),criticalSuccess:{msg:`Not only do Linzi’s stories bring pride and patriotism to the nation, but they also help increase its glory. ${b("1d6")}, and ${w({type:"fame",turn:"next",value:"1"})}. In addition, if the kingdom experiences a dangerous random event during this turn’s Event Phase, reduce that event’s level modifier by 1.`},success:{msg:`The rousing and inspiring stories Linzi spreads about the PCs helps to bring the nation together. ${b("1d6")}`},failure:{msg:`Linzi avoids spreading unfortunate news, but only just barely. The citizens are only slightly entertained by their leaders’ exploits. ${b(1)}.`},criticalFailure:{msg:`Linzi accidentally spreads news of a humiliating or embarrassing nature, causing the people of the kingdom to lose respect for their leaders. ${v("1d4")}.`}},"supernatural-solution":{enabled:!0,phase:"leadership",dc:"control",title:"Supernatural Solution",description:"Your spellcasters try to resolve issues when mundane solutions just aren’t enough. Attempt a basic check.",oncePerRound:!1,fortune:!0,skills:r(["magic"]),criticalSuccess:{msg:`You can call upon your spellcasters’ supernatural solution to aid in resolving any Kingdom skill check made during the remainder of this Kingdom turn ${k("supernatural-solution")}. Do so just before a Kingdom skill check is rolled (by yourself or any other PC). Attempt a Magic check against the same DC in addition to the Kingdom skill check, and take whichever of the two results you prefer. If you don’t use your Supernatural Solution by the end of this Kingdom turn, this benefit ends and you gain 10XP instead.`},success:{msg:`You can call upon your spellcasters’ supernatural solution to aid in resolving any Kingdom skill check made during the remainder of this Kingdom turn ${k("supernatural-solution")}. Do so just before a Kingdom skill check is rolled (by yourself or any other PC). Attempt a Magic check against the same DC in addition to the Kingdom skill check, and take whichever of the two results you prefer. If you don’t use your Supernatural Solution by the end of this Kingdom turn, this benefit ends and you gain 10XP instead. However, you ${y("1d4")} to research the solution. This cost is paid now, whether or not you use your supernatural solution.`},failure:{msg:`Your attempt at researching a supernatural solution costs additional RP to research, but is ultimately a failure, providing no advantage. ${y("2d6")}`},criticalFailure:{msg:`Your attempt at researching a supernatural solution costs additional RP to research, but is ultimately a failure, providing no advantage. ${y("2d6")}. In addition, your spellcasters’ resources and morale are impacted such that you cannot attempt a Supernatural Solution again for 2 Kingdom turns.`},special:"You cannot influence a check with Supernatural Solution and Creative Solution simultaneously."},"supplementary-hunting":{companion:"Ekundayo",oncePerRound:!1,fortune:!1,enabled:!1,phase:"region",dc:"control",title:"Supplementary Hunting",description:"Following Ekundayo’s advice, rural-dwelling citizens work to supplement stores of food and resources through hunting and trapping. Attempt a basic Wilderness check to gather excess livestock from the local wildlife, ranches, and farms to generate food commodities.",skills:r(["wilderness"]),criticalSuccess:{msg:`${u("food","1d4")}, ${u("luxuries",1)}, and ${w({type:"resource-dice",turn:"next",value:"1"})}`},success:{msg:`Choose one: ${u("food","1d4")}, ${u("luxuries",1)}, or ${w({type:"resource-dice",turn:"next",value:"1"})}`},failure:{msg:"Your hunters and trappers fail to supplement your stores and must spend time resupplying and setting new traps; you cannot attempt Supplementary Hunting on the next Kingdom turn."},criticalFailure:{msg:`Your hunters and trappers fail to supplement your stores and must spend time resupplying and setting new traps; you cannot attempt Supplementary Hunting on the next Kingdom turn. In addition, your hunters and trappers have accidentally attracted the attention of dangerous wildlife. Either ${v("1d4")} or increase a Ruin of your choice by 1.`}},"tap-treasury":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"commerce",dc:"control",title:"Tap Treasury",description:"You tap into the cash reserves of your kingdom for the PCs’ personal use or to provide emergency funding for an event. This is a basic check, but after you succeed or critically succeed at this activity, all future attempts to Tap Treasury have their results worsened two degrees. This penalty persists until funds equal to those taken from the treasury are repaid via Capital Investment",skills:r(["statecraft"]),criticalSuccess:{msg:"You withdraw funds equal to the Currency per Additional PC column on Table 10–9: Party Treasure By Level @UUID[Compendium.pf2e.journals.S55aqwWIzpQRFhcq.JournalEntryPage.Ly8l2GT6dbvuY3A2]{Treasure}, or you successfully fund the unexpected event that required you to Tap your Treasury."},success:{msg:"You withdraw funds equal to the Currency per Additional PC column on Table 10–9: Party Treasure By Level @UUID[Compendium.pf2e.journals.S55aqwWIzpQRFhcq.JournalEntryPage.Ly8l2GT6dbvuY3A2]{Treasure}, or you successfully fund the unexpected event that required you to Tap your Treasury. In addition, you overdraw your treasury in the attempt. You take a –1 circumstance penalty to all Economy-based checks until the end of your next Kingdom turn.",modifiers:()=>[{value:-1,name:"Tap Treasury: Success",abilities:["economy"],turns:2,enabled:!0,type:"circumstance"}]},failure:{msg:"You fail to secure the funds you need, and rumors about the kingdom’s potential shortfall of cash cause you to take a –1 circumstance penalty to all Loyalty- and Economy-based checks until the end of your next Kingdom turn.",modifiers:()=>[{value:-1,name:"Tap Treasury: Success",abilities:["economy","loyalty"],turns:2,enabled:!0,type:"circumstance"}]},criticalFailure:{msg:`You fail to secure the funds you need, and rumors about the kingdom’s potential shortfall of cash cause you to take a –1 circumstance penalty to all Loyalty- and Economy-based checks until the end of your next Kingdom turn. In addition, rumors spiral out of control. ${v(1)} and add 1 to a Ruin of your choice.`,modifiers:()=>[{value:-1,name:"Tap Treasury: Success",abilities:["economy","loyalty"],turns:2,enabled:!0,type:"circumstance"}]}},"trade-commodities":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"commerce",dc:"control",title:"Trade Commodities",description:"There are five different categories of Commodities: Food, Lumber, Luxuries, Ore, and Stone. When you Trade Commodities, select one Commodity that your kingdom currently stockpiles and reduce that Commodity’s stockpile by up to 4. Then attempt a basic check. If you trade with a group that you’ve established diplomatic relations with, you gain a +1 circumstance bonus to the check.",skills:r(["industry"]),criticalSuccess:{msg:`${w({type:"resource-dice",turn:"next",value:"2"})} per point of stockpile expended from your Commodity now.`},success:{msg:`${w({type:"resource-dice",turn:"next",value:"1"})} per point of stockpile expended from your Commodity now.`},failure:{msg:w({type:"resource-dice",turn:"next",value:"1"})},criticalFailure:{msg:`You gain no bonus Resource Dice (though the Commodity remains depleted). If you Traded Commodities the previous turn, ${v(1)}`}},"train-army":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",title:"Train Army",description:"You train an army in the use of a tactic. Choose one of the tactics from those listed starting on page 68, then attempt a Scholarship or Warfare check against the tactic’s Training DC. If your army has already learned its maximum number of tactics, the newly learned tactic replaces a previously learned tactic of your choice. ",skills:r(["scholarship","warfare"]),criticalSuccess:{msg:"The army learns the tactic and then becomes efficient."},success:{msg:"The army learns the tactic."},failure:{msg:"The army fails to learn the tactic."},criticalFailure:{msg:"The army not only fails to learn the tactic but becomes frustrated and exhausted from the training; increase the army’s weary condition by 1."}},"warfare-exercises":{companion:"Valerie",oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Warfare Exercises",description:"Valerie spends time studying the nation’s armies, speaking with its commanders, researching historical records of battles, and running simulations in war rooms to help predict the best ways to prepare for upcoming conflicts. Attempt a basic Warfare check to determine the success of these exercises.",skills:r(["warfare"]),criticalSuccess:{msg:"The exercises reveal a wide range of suggestions for the PCs to use during that month’s military exercises. All Army activities taken during this Kingdom turn’s Activity Phase gain a +1 circumstance bonus. This bonus increases to +2 at Kingdom level 9 and +3 at Kingdom level 15. In addition, the next time this Kingdom turn that you roll a critical failure on an Army activity, the result is improved to a regular failure instead.",modifiers:e=>[{turns:1,consumeId:"",enabled:!0,phases:["army"],value:e.level<9?1:e.level<15?2:3,name:"Warfare Exercises: Critical Success",type:"circumstance"}]},success:{msg:"The exercises grant a +1 circumstance bonus to your first Army activity taken during the Kingdom turn’s Activity Phase. This bonus increases to +2 at Kingdom level 9 and +3 at Kingdom level 15.",modifiers:e=>[{turns:1,consumeId:"",enabled:!0,phases:["army"],value:e.level<9?1:e.level<15?2:3,name:"Warfare Exercises: Critical Success",type:"circumstance"}]},failure:{msg:"The warfare exercises provide no insight this turn."},criticalFailure:{msg:"You accidentally form incorrect assumptions about your military tactics. The next time you roll a failure on an Army activity this Kingdom turn, it becomes a critical failure instead."}},"reconnoiter-hex":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Reconnoiter Hex",description:`You send a team to spend time surveying and exploring a specific hex, getting the lay of the land and looking for unusual features and specific sites. ${y(1)} and then attempt a Basic check.`,skills:r(["wilderness"]),criticalSuccess:{msg:"Your team successfully explores the hex and it is now Reconnoitered for the purpose of Claim Hex. Your team automatically finds one Special or Hidden feature if the hex contains one. If the hex contains multiple Special or Hidden Features the GM chooses one. If the hex contains an Encounter or Hazard, the team avoids it and reports back useful and detailed information on it. In addition, your team's reconnaissance of the hex goes so smoothly you may immediately attempt an additional Reconnoiter Hex activity on an adjacent hex. Treat a Critical Success on this additional check as a Success instead."},success:{msg:"Your team successfully explores the hex and it is now Reconnoitered for the purpose of Claim Hex. If the hex contains a Special feature your team may find it if your GM wishes. If the hex contains an Encounter or Hazard, the team avoids it and reports basic information on it."},failure:{msg:"Your team fails to explore the hex sufficiently. If the hex contains an Encounter or Hazard, the team escapes it and reports basic information on it."},criticalFailure:{msg:"Your team fails to explore the hex sufficiently and a number of the team are lost, causing you to take a -1 circumstance penalty to Loyalty-based checks until the end of your next Kingdom turn. If the hex contains an Encounter or Hazard, the team members were lost to it and the survivors can report back basic information on it.",modifiers:()=>[{turns:2,enabled:!0,abilities:["loyalty"],value:-1,name:"Reconnoiter Hex: Critical Failure",type:"circumstance"}]}},"take-charge":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Take Charge",description:"You spend some time getting directly involved in helping your kingdom. Choose a skill that your Kingdom is at least Trained in, then attempt a basic check. You can never use the same skill for this activity twice in the same Kingdom turn.",skills:r([...n.allSkills],1),criticalSuccess:{msg:`${g(1)}. In addition you get a +1 Circumstance Bonus to the next Check you make this turn with the chosen skill. `,modifiers:()=>[{turns:1,consumeId:"",enabled:!1,value:1,name:"Take Charge: Critical Success",type:"circumstance"}]},success:{msg:g(1)},failure:{msg:"You fail to generate RP."},criticalFailure:{msg:"You take a -1 Circumstance Penalty to the next Check you make this turn with the chosen skill.",modifiers:()=>[{turns:1,consumeId:"",enabled:!1,value:-1,name:"Take Charge: Critical Failure",type:"circumstance"}]}}};function l(e){return w({value:`${e}`,type:"fame"})}function c(e){return w({value:`${e}`,type:"fame",mode:"lose"})}function u(e,t){return w({value:`${t}`,type:e})}function m(e,t){return w({value:`${t}`,type:e,mode:"lose"})}function d(e,t){return w({value:`${t}`,type:e})}function h(e,t){return w({value:`${t}`,type:e,mode:"lose"})}function f(e){return w({value:`${e}`,type:"rolled-resource-dice"})}function p(e){return w({value:`${e}`,type:"rolled-resource-dice",mode:"lose"})}function g(e){return w({value:`${e}`,type:"resource-points"})}function y(e){return w({value:`${e}`,type:"resource-points",mode:"lose"})}function v(e){return w({value:`${e}`,type:"unrest"})}function b(e){return w({value:`${e}`,type:"unrest",mode:"lose"})}function k(e){return w({value:"1",type:e,mode:"gain"})}function w({turn:e="now",value:t,mode:i="gain",type:n,hints:a}){const r="now"===e?"":" Next Turn";return`<button type="button" class="km-gain-lose" \n        data-type="${n}"\n        data-mode="${i}"\n        data-turn="${e}"\n        ${void 0!==t?`data-value="${t}"`:""}\n        >${`${"gain"===i?"Gain":"Lose"} ${t} ${(0,s.unslugify)(n)}${r}`}${void 0!==a?`(${a})`:""}</button>`}function S(e){const t=new Set(e.map((e=>e.id)));return Array.from(Object.entries(o)).filter((([e])=>!t.has(e))).map((([e,t])=>({id:e,...t}))).concat(e)}t.gainXp=function(e){return w({value:`${e}`,type:"xp"})},t.gainFame=l,t.loseFame=c,t.gainCommodities=u,t.loseCommodities=m,t.gainRuin=d,t.loseRuin=h,t.gainRolledRD=f,t.loseRolledRD=p,t.gainRP=g,t.loseRP=y,t.gainUnrest=v,t.loseUnrest=b,t.gainSolution=k,t.createResourceButton=w,t.getKingdomActivitiesById=function(e){return Object.fromEntries(S(e).map((e=>[e.id,e])))},t.getKingdomActivities=S},8166:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOverrideUnlockCompanionNames=t.getCompanionSkillUnlocks=t.getCompanionUnlockActivities=t.applyLeaderCompanionRules=t.companionActivityUnlocks=t.isCompanionName=t.allCompanions=void 0;const n=i(8593),a=i(4310);function s(e){return t.allCompanions.includes(e)}function r(e,i){const n=i.name,a=n in t.companionActivityUnlocks?t.companionActivityUnlocks[n]:void 0;return"companion"===i.type&&a?.roles?.has(e)?a:void 0}function o(e,i){const n=Array.from(i).map((e=>t.companionActivityUnlocks[e]));return[...Object.entries(e).flatMap((([e,t])=>{const n=r(e,t),a=t.name;return!(s(a)&&i.has(a))&&n?n:[]})),...n]}function l(e,t){return"companion"===t.type?void 0!==r(e,t):t.invested}t.allCompanions=["Amiri","Ekundayo","Harrim","Jaethal","Jubilost","Kalikke","Kanerah","Linzi","Nok-Nok","Octavia","Regongar","Tristian","Valerie"],t.isCompanionName=s,t.companionActivityUnlocks={Harrim:{activities:["evangelize-the-dead"],actionSkills:{},roles:new Set(["magister"])},Jaethal:{activities:["decadent-feasts"],actionSkills:{},roles:new Set(["emissary"])},Kalikke:{activities:["deliberate-planning"],actionSkills:{},roles:new Set(["counselor"])},Kanerah:{activities:["false-victory"],actionSkills:{},roles:new Set(["emissary"])},Regongar:{activities:["show-of-force"],actionSkills:{},roles:new Set(["general"])},Valerie:{activities:["warfare-exercises"],actionSkills:{},roles:new Set(["general"])},Tristian:{activities:["preventative-measures"],actionSkills:{},roles:new Set(["magister"])},Linzi:{activities:["spread-the-legend"],actionSkills:{},roles:new Set(["counselor"])},Jubilost:{activities:["process-hidden-fees"],actionSkills:{},roles:new Set(["treasurer"])},"Nok-Nok":{activities:["recruit-monsters"],actionSkills:{},roles:new Set(["emissary"])},Ekundayo:{activities:["supplementary-hunting"],actionSkills:{},roles:new Set(["general","warden"])},Amiri:{activities:[],actionSkills:{},roles:new Set(["warden"])},Octavia:{activities:[],actionSkills:{magic:["celebrate-holiday","craft-luxuries","create-a-masterpiece","rest-and-relax"]},roles:new Set(["magister"])}},t.applyLeaderCompanionRules=function(e){return{counselor:{...e.counselor,invested:l("counselor",e.counselor)},emissary:{...e.emissary,invested:l("emissary",e.emissary)},general:{...e.general,invested:l("general",e.general)},magister:{...e.magister,invested:l("magister",e.magister)},ruler:{...e.ruler,invested:l("ruler",e.ruler)},treasurer:{...e.treasurer,invested:l("treasurer",e.treasurer)},viceroy:{...e.viceroy,invested:l("viceroy",e.viceroy)},warden:{...e.warden,invested:l("warden",e.warden)}}},t.getCompanionUnlockActivities=function(e,t){return o(e,t).flatMap((e=>e.activities))},t.getCompanionSkillUnlocks=function(e,t){return o(e,t).map((e=>e.actionSkills)).reduce(((e,t)=>(0,n.mergeObjects)(e,t,((e,t)=>[...e,...t]))),{})},t.getOverrideUnlockCompanionNames=function(e){const t=(0,a.getStringArraySetting)(e,"forceEnabledCompanionLeadershipBenefits").filter(s);return new Set(t)}},4431:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.allFeatsByName=t.allFeats=void 0;const n=i(8593),a=i(6013);function s(e){return a.allSkills.map((t=>({...e,name:`${e.name} (${(0,n.capitalize)(t)})`})))}t.allFeats=[{name:"-",level:0,text:""},{automationNotes:"Vacancy role penalty removal is not automated",name:"Civil Service",level:1,text:"Everyone has a place and a role, and as long as those roles are filled, the government functions. When you\nselect this feat, choose one leadership role; that role is now supported by your efficient civil servants, so its vacancy penalty is no longer applicable. If you wish to change the leadership role to which Civil Service applies, you can do so using the New Leadership activity at the start of a Kingdom turn. You gain a +2 circumstance bonus to New Leadership checks.",modifiers:[{name:"Swapping Civil Service",enabled:!1,value:2,type:"circumstance",activities:["new-leadership"]}]},{name:"Cooperative Leadership",level:1,text:"Your leaders are skilled at working with one another. When a leader uses the Focused Attention kingdom\nactivity to aid another leader’s kingdom check, the circumstance bonus granted by a success is increased to +3.\nAt 11th level, your leaders’ collaborative style leads them to ever greater successes when they work together. When a leader uses the Focused Attention kingdom activity to aid another leader’s check, treat a critical failure on the aided check as a failure. If your kingdom has at least the expert rank in the skill used in the aided check, treat a failure on the check as a success. (This\ndoes not allow you to ever improve a critical failure to a success.)"},{name:"Crush Dissent",level:1,prerequisites:"Trained in Warfare",text:"Your rule brooks no dissent and stamps out traitors, making harsh examples of them. Once per Kingdom\nturn when you gain Unrest, you can attempt to crush the dissent by attempting a basic Warfare check. On a success, the Unrest increase is canceled, but on a critical failure, the Unrest increase is doubled. In addition, you gain a +1 circumstance bonus to checks to resolve dangerous kingdom events that involve internal bickering, such as Feud.",modifiers:[{name:"Dangerous Kingdom Event involving internal bickering",enabled:!1,value:1,type:"circumstance",phases:["event"]}]},{name:"Fortified Fiefs",level:1,prerequisites:"Trained in Defense",text:"Your vassals take their duty to protect those under their stewardship seriously, and your engineers emphasize\nthe value of a strong defense when it comes to building settlements and fortifications. You gain a +2 circumstance bonus to checks attempted as part of the Fortify Hex activity and on activities to build or repair a Barracks, Castle, Garrison, Keep, Stone Wall, or Wooden Wall. In addition, you gain a +1 circumstance bonus to all kingdom checks attempted during dangerous events that directly impact\nyour settlements’ defenses.",modifiers:[{name:"Fortified Fiefs",type:"circumstance",activities:["fortify-hex"],enabled:!0,value:2},{name:"Build or repair a Barracks, Castle, Garrison, Keep, Stone Wall, or Wooden Wall",type:"circumstance",activities:["build-structure"],enabled:!1,value:2},{name:"Dangerous Event impacting settlement defenses",type:"circumstance",phases:["event"],enabled:!1,value:1}]},{name:"Insider Trading",level:1,prerequisites:"Trained in Industry",text:"Your leading citizens share valuable business information with one another and with associates in\nother lands, and they hire one another’s workers to supply the labor they need to fuel their production. You gain a +1 circumstance bonus to Establish Work Site, Establish Trade Agreement, and Trade Commodities activities. In addition, gain 1 bonus Resource Die at the start of each Kingdom turn.",modifiers:[{name:"Insider Trading",type:"circumstance",activities:["establish-work-site-quarry","establish-work-site-lumber","establish-work-site-mine","establish-trade-agreement","trade-commodities"],enabled:!0,value:1}]},{automationNotes:"You need to manually increase the ruin thresholds",name:"Muddle Through",level:1,prerequisites:"Trained in Wilderness",text:"Your people are independent-minded and take care of the small things around the kingdom, not letting them pile up into bigger problems. Increase two of your Ruin thresholds by 1 and one of them by 2."},{automationNotes:"Hire Adventurers RP reduction is not implemented",name:"Practical Magic",level:1,prerequisites:"Trained in Magic",text:"Magic has an honored place in your society, and your people incorporate it into their everyday work to make\nlife easier. You gain a +1 circumstance bonus to Magic checks, and you can use Magic checks in place of Engineering checks. In addition, as magic-wielding NPCs find your nation a comfortable place to live and work, you reduce the cost of using the Hire Adventurers activity to 1 RP.",modifiers:[{name:"Practical Magic",type:"circumstance",skills:["magic"],enabled:!0,value:1}]},{automationNotes:"Nothing automated",name:"Pull Together",level:1,prerequisites:"Trained in Politics",text:"Your people are very reliable, and their swift decision‑making keeps most projects from getting too\nfar off track. Once per Kingdom turn when you roll a critical failure on a Kingdom skill check, attempt a DC 11 flat check. If this succeeds, your citizens heed the call to put in extra work to mitigate the disaster; treat the Kingdom skill check result as failure instead. The DC of this flat check increases by 5 each time you subsequently use it, but it decreases by 1 (to a minimum of 11) for each Kingdom turn that passes when you do not use it."},...s({automationNotes:"You need to manually increase the skill proficiency",name:"Skill Training",level:1,text:"Your kingdom receives the trained proficiency rank in a Kingdom skill of your choice. You can select this feat\nmultiple times, choosing a new skill each time."}),{automationNotes:"If your kingdom’s Unrest is 6 or higher and you use a kingdom activity that decreases Unrest, decrease the Unrest by an additional 1 is not automated.",name:"Endure Anarchy",level:3,prerequisites:"Loyalty 14",text:"Your kingdom holds together even in the midst of extreme peril. If your kingdom’s Unrest is 6 or higher and you use a kingdom activity that decreases Unrest, decrease the Unrest by an additional 1. You do not fall into anarchy unless your kingdom’s Unrest reaches 24"},{name:"Inspiring Entertainment",level:3,prerequisites:"Culture 14",text:"Your kingdom’s artists and entertainers are talented and prolific, and there’s never a shortage of new plays, operas, novels, music, sculptures, paintings, or other forms of distraction to entertain the citizens, even during\ntimes of upheaval. Your kingdom gains a +2 circumstance bonus to all Culture-based skill checks whenever your kingdom has at least 1 Unrest.",modifiers:[{name:"Inspiring Entertainment",type:"circumstance",enabled:!0,abilities:["culture"],value:2}]},...s({name:"Kingdom Assurance",automationNotes:"You need to manually choose Assurance in the modifier popup",level:1,text:"Even when things go poorly in other areas, you can count on consistency in carrying out kingdom activities\nwith a chosen skill. Choose one Kingdom skill in which your kingdom is trained. Once per Kingdom turn, when you would attempt a skill check for that skill, you can forgo rolling and instead take a result equal to 10 + your proficiency bonus; do not apply any other bonuses, penalties, or modifiers to this result. Special You can select this feat multiple times. Each time, choose a different skill and gain the benefits of this feat for that skill."}),{automationNotes:"Not automated",name:"Liquidate Resources",level:3,prerequisites:"Economy 14",text:"Your kingdom’s economy can liquidate resources in an emergency when funding runs out. The first time during\na Kingdom turn in which you are forced to spend RP as the result of a failed skill check or a dangerous event, and that expense reduces you to 0 RP, you may instead reduce your RP to 1 and treat the expense as if it were paid in full. At the start of your next Kingdom turn, roll 4 fewer Resource Dice than normal."},{name:"Quick Recovery",level:3,prerequisites:"Stability 14",text:"Your kingdom recovers more quickly from danger and disaster. Whenever you attempt a skill check to end an ongoing harmful kingdom event, you gain a +4 circumstance bonus to the check.",modifiers:[{name:"Ongoing Harmful Event",type:"circumstance",enabled:!1,phases:["event"],value:4}]},{automationNotes:"Re-rolling a failure or crit failure for 2 RP is not automated",name:"Free and Fair",level:7,text:"Your reputation for transparency and fairness in conducting elections, appointments, and other changes in government inspires tremendous public trust. You gain a +2 circumstance bonus to Loyalty-based checks attempted as part of the New Leadership and Pledge of Fealty activities. If you fail or critically fail such a check, you can spend 2 RP to reroll the check (but without the +2 circumstance bonus); attempting this adds the Fortune trait. You must take the result of the second roll, even if it is worse than the original roll.",modifiers:[{name:"Loyalty Based Skill",type:"circumstance",abilities:["loyalty"],activities:["new-leadership"],enabled:!0,value:2},{name:"Loyalty Based Skill",type:"circumstance",abilities:["loyalty"],activities:["pledge-of-fealty"],enabled:!0,value:2}]},{automationNotes:"First time you get luxuries is not automated",name:"Quality of Life",level:7,text:"Your kingdom’s robust economy makes the creature comforts of civilization more readily available to all, and even finer luxuries are more easily had. The first time you gain Luxury Commodities in a Kingdom turn, increase the total gained by 1. All of your settlements are treated as 1 level higher than their actual level for the purposes of determining what sorts of magic items might be offered for sale at their markets and shops."},{automationNotes:"You do not get 1 extra RP at the start of your next turn on a critical success",name:"Fame and Fortune",level:11,text:"Your kingdom’s reputation has spread far and wide, bringing in visitors to behold the spectacle of your greatness and pay their respects. Whenever you achieve a critical success on any Kingdom skill check during the Activity phase of a Kingdom turn, gain 1 bonus Resource Die at the start of your next Kingdom turn."}],t.allFeatsByName=Object.fromEntries(t.allFeats.map((e=>[e.name,e])))},6079:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uniqueFeatures=t.featuresByLevel=t.features=void 0;const n=i(8593);function a(e){return{level:e,name:"Kingdom Feat",description:"At 2nd level, and then every 2 levels thereafter, the kingdom gains a Kingdom feat."}}function s(e){return{level:e,name:"Skill Increase",description:"your kingdom gains a skill increase. You can use this to increase your rank to trained in one skill in which your kingdom is untrained, or to increase your rank to expert in one skill in which your kingdom is trained. Starting at 7th level, you can use your skill increases to increase your kingdom’s proficiency to master in a skill in which your kingdom is already an expert. Beginning at 15th level, you can use them to increase your proficiency to legendary in a skill in which your kingdom is already a master."}}function r(e){return{level:e,name:"Ability Boosts",description:"At 5th level and every 5 levels thereafter, you boost two different kingdom ability scores. You can use these ability boosts to increase your kingdom’s ability scores above 18. Boosting an ability score increases it by 2 if it starts out below 18, or by 1 if it’s already 18 or above."}}function o(e,t){return{level:e,name:`Settlement Construction (${t})`,description:"You can establish villages in your kingdom immediately. At 3rd level, you can expand villages into towns. At 9th level, you can expand towns into cities. expand towns into cities. And at 15th level, you can expand cities into metropolises. As villages grow into larger settlements, you not only gain more room to build, but the maximum item bonus you can gain from that settlement’s structures increases as well"}}function l(e){return{level:e,name:"Ruin Resistance",description:"At 5th level and every 3 levels thereafter, your kingdom becomes more resistant to Ruin. Choose one of the four Ruin categories and increase its threshold by 2. When you do so, reset that Ruin’s penalty to 0. See page 38 for more information about Ruin."}}function c(e,t){return{level:e,name:`Expansion Expert (+${t})`,description:"Your kingdom is better at expanding its territory. You gain a +2 circumstance bonus to skill checks made to Claim Hex and can attempt to Claim Hex up to twice during a Kingdom turn. At 9th level, you can attempt to Claim Hex up to three times during a Kingdom turn."}}function u(e,t){return{level:e,name:`Experienced Leadership (+${t})`,description:"Invested leadership roles in your kingdom now grant a +2 status bonus to kingdom checks associated with their leadership role’s key ability. At 16th level, this increases to a +3 status bonus."}}t.features=[{level:1,name:"Charter",description:"Your kingdom gains the benefits of your selected charter"},{level:1,name:"Government",description:"Your kingdom gains the benefits of your selected government"},{level:1,name:"Government",description:"Your kingdom gains the benefits of your selected heartland"},{level:1,name:"Initial Proficiencies",description:"At 1st level, a kingdom receives the trained proficiency rank in two Kingdom skills gained from your initial choice of government and in up to four additional Kingdom skills determined by your invested leaders, giving you a proficiency bonus to checks using these skills equal to your kingdom level plus 2. Proficiencies cannot be changed, even if the kingdom’s government or leaders later change."},{level:1,name:"Favored Land",description:"Your heartland’s terrain becomes your kingdom’s favored land—the wilderness terrain that your people feel the strongest emotional ties to and to which your resource gatherers tend to flock. Once per Kingdom turn, during the Region Activities step of the Activity phase, you can attempt two Region activities simultaneously as long as both activities take place in the same hex and that hex contains the same terrain as your heartland. You take a –2 penalty to Kingdom skill checks made during these two activities."},o(1,"Village"),a(2),o(3,"Town"),s(3),c(4,2),{level:4,name:"Fine Living",description:"Your people celebrate by indulging you with feasts and finery. All PCs associated with the kingdom enjoy a Fine standard of living at no cost whenever they’re in the kingdom. Any PCs in hostile wilderness, a monster‑filled dungeon, or otherwise cut off from their citizens must provide their own sustenance as usual even if they are within the boundaries of their kingdom. You gain a +1 circumstance bonus to all checks made to Craft or Earn Income while in your kingdom."},a(4),r(5),l(5),s(5),a(6),s(7),u(8,2),a(8),l(8),c(9,3),o(9,"City"),s(9),r(10),a(10),{level:10,name:"Life of Luxury",description:"Your people lavish you with every creature comfort. This is identical to Fine Living, but all PC leaders enjoy an Extravagant standard of living at no cost whenever they’re in the kingdom. You gain a +2 circumstance bonus to all checks made to Craft or Earn Income while in your kingdom."},l(11),s(11),{level:12,name:"Civic Planning",description:"During the Civic Activities step of the Activities phase of a Kingdom turn, one settlement of the party’s choice can attempt two Civic activities rather than one. The second Civic activity occurs after all other settlements have taken their individual Civic activities."},a(12),s(13),a(14),l(14),r(15),o(15,"Metropolis"),s(15),u(16,3),a(16),l(17),s(17),a(18),s(19),r(20),{level:20,name:"Envy of the World",description:"Your kingdom is one of the world’s prominent nations. The first time in a Kingdom turn when your kingdom would gain Unrest or Ruin, ignore that increase. You can ignore additional increases to Unrest or Ruin later in the same turn as well, but you must spend a Fame or Infamy point each time you do so. Your maximum Fame or Infamy point total increases by 1."},a(20),l(20)],t.featuresByLevel=(0,n.groupBy)(t.features,(e=>e.level)),t.uniqueFeatures=(0,n.distinctBy)(t.features,(e=>e.name))},1155:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasFeat=t.getDefaultKingdomData=t.getCultEventMilestones=t.getControlDC=t.getSizeData=t.kingdomSizeData=t.getLevelData=t.allFameTypes=t.allHeartlands=void 0;const n=i(943);function a(e){return t.kingdomSizeData.find((t=>e>=t.sizeFrom&&e<=(t.sizeTo??Number.MAX_SAFE_INTEGER)))}function s(){return[{name:"Cult Event (Chapter 5): Cult Activity",xp:80,completed:!1,homebrew:!1},{name:"Cult Event (Chapter 5): Public Outburst",xp:80,completed:!1,homebrew:!1},{name:"Cult Event (Chapter 5): Too Close to Home",xp:80,completed:!1,homebrew:!1},{name:"Cult Event (Chapter 5): Urban Outburst",xp:80,completed:!1,homebrew:!1}]}t.allHeartlands=["forest-or-swamp","hill-or-plain","lake-or-river","mountain-or-ruins"],t.allFameTypes=["famous","infamous"],t.getLevelData=function(e){return{claimHexAttempts:e<4?1:e<9?2:3,claimHexCircumstanceBonus:e<4?0:2,investedLeadershipBonus:e<8?1:e<16?2:3,resourceDice:e+4}},t.kingdomSizeData=[{sizeFrom:0,sizeTo:9,type:"territory",resourceDieSize:"d4",controlDCModifier:0,commodityCapacity:4},{sizeFrom:10,sizeTo:24,type:"province",resourceDieSize:"d6",controlDCModifier:1,commodityCapacity:8},{sizeFrom:25,sizeTo:49,type:"state",resourceDieSize:"d8",controlDCModifier:2,commodityCapacity:12},{sizeFrom:50,sizeTo:99,type:"country",resourceDieSize:"d10",controlDCModifier:3,commodityCapacity:16},{sizeFrom:100,type:"dominion",resourceDieSize:"d12",controlDCModifier:4,commodityCapacity:20}],t.getSizeData=a,t.getControlDC=function(e,t,i){const n=a(t).controlDCModifier,s=e<5?e-1:e,r=i?2:0;return 14+s+Math.floor(s/3)+n+r},t.getCultEventMilestones=s,t.getDefaultKingdomData=function(){return{turnsWithoutEvent:0,turnsWithoutCultEvent:0,name:"",atWar:!1,charter:"",government:"",activeSettlement:"",notes:{public:"",gm:""},fame:{type:"famous",now:0,next:0},supernaturalSolutions:0,creativeSolutions:0,level:1,xpThreshold:1e3,xp:0,size:1,unrest:0,settlements:[],feats:[],bonusFeats:[],ongoingEvents:[],groups:[],milestones:[{name:"Build Roads for the first time",xp:20,completed:!1,homebrew:!0},{name:"Build your first Famous/Infamous Structure",xp:20,completed:!1,homebrew:!0},{name:"Build your first seat of government (Town Hall, Castle, or Palace)",xp:20,completed:!1,homebrew:!0},{name:"Build your first Structure requiring Expert in a Kingdom Skill",xp:20,completed:!1,homebrew:!0},{name:"Celebrate your first successful Holiday",xp:20,completed:!1,homebrew:!0},{name:"Claim your first new Hex (2nd hex overall)",xp:20,completed:!1,homebrew:!0},{name:"Complete your First successful Infiltration",xp:20,completed:!1,homebrew:!0},{name:"Create your first Masterpiece",xp:20,completed:!1,homebrew:!0},{name:"Establish your first Farmland",xp:20,completed:!1,homebrew:!0},{name:"Establish your first Lumber Camp",xp:20,completed:!1,homebrew:!0},{name:"Establish your first Mine",xp:20,completed:!1,homebrew:!0},{name:"Establish your first Quarry",xp:20,completed:!1,homebrew:!0},{name:"Fortify your first hex",xp:20,completed:!1,homebrew:!0},{name:"Successfully use your first Creative Solution",xp:20,completed:!1,homebrew:!0},{name:"Successfully use your first Supernatural Solution",xp:20,completed:!1,homebrew:!0},{name:"Claim your first Landmark",xp:40,completed:!1,homebrew:!1},{name:"Claim your first Refuge",xp:40,completed:!1,homebrew:!1},{name:"Establish your first village",xp:40,completed:!1,homebrew:!1},{name:"Establish your second Village",xp:40,completed:!1,homebrew:!0},{name:"Reach kingdom Size 10",xp:40,completed:!1,homebrew:!1},{name:"Recruit your first regular Army",xp:40,completed:!1,homebrew:!0},{name:"Successfully resolve a random Kingdom Event",xp:40,completed:!1,homebrew:!0},{name:"Achieve your first successful Pledge of Fealty",xp:60,completed:!1,homebrew:!0},{name:"All eight leadership roles are assigned",xp:60,completed:!1,homebrew:!1},{name:"Build your first Structure requiring Master in a Kingdom Skill",xp:60,completed:!1,homebrew:!0},{name:"Establish diplomatic relations for the first time",xp:60,completed:!1,homebrew:!1},{name:"Expand a village into your first town",xp:60,completed:!1,homebrew:!1},{name:"Reach kingdom Size 25",xp:60,completed:!1,homebrew:!1},{name:"Recruit your first Specialized Army",xp:60,completed:!1,homebrew:!0},{name:"Win your first War Encounter",xp:60,completed:!1,homebrew:!0},{name:"Establish your first trade agreement",xp:80,completed:!1,homebrew:!1},{name:"Expand a town into your first city",xp:80,completed:!1,homebrew:!1},{name:"Reach kingdom Size 50",xp:80,completed:!1,homebrew:!1},{name:"Spend 100 RP during a Kingdom turn",xp:80,completed:!1,homebrew:!1},{name:"Cult Event (Chapter 5): Cult Activity",xp:80,completed:!1,homebrew:!1},{name:"Cult Event (Chapter 5): Public Outburst",xp:80,completed:!1,homebrew:!1},{name:"Cult Event (Chapter 5): Too Close to Home",xp:80,completed:!1,homebrew:!1},{name:"Cult Event (Chapter 5): Urban Outburst",xp:80,completed:!1,homebrew:!1},{name:"Expand a city into your first metropolis",xp:120,completed:!1,homebrew:!1},{name:"Reach kingdom Size 100",xp:120,completed:!1,homebrew:!1}],realmSceneId:null,workSites:{farmlands:{quantity:0,resources:0},quarries:{quantity:0,resources:0},lumberCamps:{quantity:0,resources:0},mines:{quantity:0,resources:0},luxurySources:{quantity:0,resources:0}},commodities:{now:{food:0,ore:0,lumber:0,stone:0,luxuries:0},next:{food:0,ore:0,lumber:0,stone:0,luxuries:0}},resourceDice:{now:0,next:0},resourcePoints:{next:0,now:0},heartland:"hill-or-plain",consumption:{armies:0,now:0,next:0},leaders:{ruler:{invested:!1,type:"pc",vacant:!1,name:""},counselor:{invested:!1,type:"pc",vacant:!1,name:""},general:{invested:!1,type:"pc",vacant:!1,name:""},emissary:{invested:!1,type:"pc",vacant:!1,name:""},magister:{invested:!1,type:"pc",vacant:!1,name:""},treasurer:{invested:!1,type:"pc",vacant:!1,name:""},viceroy:{invested:!1,type:"pc",vacant:!1,name:""},warden:{invested:!1,type:"pc",vacant:!1,name:""}},skillRanks:{agriculture:0,arts:0,boating:0,defense:0,engineering:0,exploration:0,folklore:0,industry:0,intrigue:0,magic:0,politics:0,scholarship:0,statecraft:0,trade:0,warfare:0,wilderness:0},abilityScores:{culture:10,economy:10,loyalty:10,stability:10},ruin:{corruption:{penalty:0,threshold:10,value:0},crime:{penalty:0,threshold:10,value:0},decay:{penalty:0,threshold:10,value:0},strife:{penalty:0,threshold:10,value:0}},activityBlacklist:(0,n.getKingdomActivities)([]).filter((e=>!e.enabled&&!e.companion)).map((e=>e.id)),modifiers:[],homebrewActivities:[]}},t.hasFeat=function(e,t){return[...e.feats,...e.bonusFeats].map((e=>e.id)).includes(t)}},324:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateInvestedBonus=t.isInvested=t.abilityLeaders=t.leaderAbilities=t.allLeaders=void 0;const n=i(1155);function a(e,i){const n=t.abilityLeaders[e];return i[n[0]].invested||i[n[1]].invested}t.allLeaders=["ruler","counselor","general","emissary","magister","treasurer","viceroy","warden"],t.leaderAbilities={ruler:"loyalty",counselor:"culture",general:"stability",emissary:"loyalty",magister:"culture",treasurer:"economy",viceroy:"economy",warden:"stability"},t.abilityLeaders={loyalty:["ruler","emissary"],culture:["counselor","magister"],stability:["general","warden"],economy:["treasurer","viceroy"]},t.isInvested=a,t.calculateInvestedBonus=function(e,t,i){const s=(0,n.getLevelData)(e);return a(t,i)?s.investedLeadershipBonus:0}},6334:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.abilityRuins=t.ruinAbilities=t.allRuins=void 0,t.allRuins=["corruption","crime","decay","strife"],t.ruinAbilities={corruption:"culture",crime:"economy",decay:"stability",strife:"loyalty"},t.abilityRuins={culture:"corruption",economy:"crime",stability:"decay",loyalty:"strife"}},6013:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.allActorSkills=t.allTrainedSkillRanks=t.allSkillRanks=t.skillAbilities=t.allSkills=void 0,t.allSkills=["agriculture","arts","boating","defense","engineering","exploration","folklore","industry","intrigue","magic","politics","scholarship","statecraft","trade","warfare","wilderness"],t.skillAbilities={agriculture:"stability",arts:"culture",boating:"economy",defense:"stability",engineering:"stability",exploration:"economy",folklore:"culture",industry:"economy",intrigue:"loyalty",magic:"culture",politics:"loyalty",scholarship:"culture",statecraft:"loyalty",trade:"economy",warfare:"loyalty",wilderness:"stability"},t.allSkillRanks=["untrained","trained","expert","master","legendary"],t.allTrainedSkillRanks=["trained","expert","master","legendary"],t.allActorSkills=["perception","acrobatics","athletics","arcana","crafting","deception","diplomacy","intimidation","medicine","nature","occultism","performance","religion","society","stealth","survival","thievery"]},949:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.structuresByName=t.itemGroups=t.mundaneItemGroups=t.magicalItemGroups=t.allBuildingTraits=void 0,t.allBuildingTraits=["edifice","yard","building","famous","infamous","residential","infrastructure"],t.magicalItemGroups=["magical","divine","occult","primal","arcane"],t.mundaneItemGroups=["alchemical","luxury","other"],t.itemGroups=t.mundaneItemGroups.concat(t.magicalItemGroups);t.structuresByName=new Map,[{name:"Academy",activityBonusRules:[{value:2,activity:"creative-solution"}],notes:"While in a settlement with an Academy, you gain a +2 item bonus to Lore checks made to Recall Knowledge while Investigate, to all checks made while Researching, and to Decipher Writing.",traits:["building","edifice"],affectsDowntime:!0,level:10,upgradeFrom:["Library"],construction:{skills:[{skill:"scholarship",proficiencyRank:2}],dc:27,rp:52,lumber:12,luxuries:6,stone:12}},{name:"Alchemy Laboratory",activityBonusRules:[{value:1,activity:"demolish"}],availableItemsRules:[{value:1,group:"alchemical",maximumStacks:3}],notes:"Checks attempted to Identify Alchemy in any settlement with at least one alchemy laboratory gain a +1 item bonus.",traits:["building"],affectsDowntime:!0,level:3,construction:{skills:[{skill:"industry",proficiencyRank:1}],rp:18,ore:2,stone:5,dc:16}},{name:"Arcanist's Tower",skillBonusRules:[{value:1,skill:"magic",activity:"quell-unrest"}],availableItemsRules:[{value:1,group:"arcane",maximumStacks:3}],notes:"While in a settlement with an arcanist's tower, you gain a +1 item bonus to checks made to Borrow an Arcane Spell or Learn a Spell.",traits:["building"],affectsDowntime:!0,level:5,construction:{skills:[{skill:"magic",proficiencyRank:1}],rp:30,stone:6,dc:20}},{name:"Arena",activityBonusRules:[{value:2,activity:"celebrate-holiday"}],skillBonusRules:[{value:1,skill:"warfare",activity:"quell-unrest"}],notes:"An arena lets you to retrain combat-themed feats more efficiently while in the settlement; doing so takes only 5 days rather than a week of downtime.",traits:["edifice","yard"],affectsDowntime:!0,level:9,construction:{skills:[{skill:"warfare",proficiencyRank:2}],dc:26,rp:40,lumber:6,stone:12}},{name:"Bank",activityBonusRules:[{value:1,activity:"tap-treasury"}],enableCapitalInvestment:!0,traits:["building"],level:5,construction:{skills:[{skill:"trade",proficiencyRank:1}],dc:20,rp:28,ore:4,stone:6}},{name:"Barracks",activityBonusRules:[{value:1,activity:"garrison-army"},{value:1,activity:"recover-army"},{value:1,activity:"recruit-army"}],traits:["building","residential"],reducesUnrest:!0,level:3,construction:{skills:[{skill:"defense"}],dc:16,rp:6,lumber:2,stone:1}},{name:"Brewery",activityBonusRules:[{value:1,activity:"establish-trade-agreement"}],traits:["building"],reducesUnrest:!0,level:1,construction:{skills:[{skill:"agriculture"}],dc:15,rp:6,lumber:2}},{name:"Bridge",isBridge:!0,traits:["infrastructure"],lots:0,affectsDowntime:!1,reducesUnrest:!1,level:2,construction:{skills:[{skill:"engineering"}],dc:16,rp:6,lumber:1}},{name:"Bridge, Stone",isBridge:!0,traits:["infrastructure"],lots:0,affectsDowntime:!1,reducesUnrest:!1,level:2,construction:{skills:[{skill:"engineering"}],dc:16,rp:6,stone:1}},{name:"Castle",activityBonusRules:[{value:2,activity:"new-leadership"},{value:2,activity:"pledge-of-fealty"},{value:2,activity:"send-diplomatic-envoy"},{value:2,activity:"garrison-army"},{value:2,activity:"recruit-army"},{value:2,activity:"recover-army"}],increaseLeadershipActivities:!0,traits:["building","edifice","famous","infamous"],affectsDowntime:!1,reducesUnrest:!0,level:9,upgradeFrom:["Town Hall"],construction:{skills:[{skill:"defense",proficiencyRank:2},{skill:"industry",proficiencyRank:2},{skill:"magic",proficiencyRank:2},{skill:"statecraft",proficiencyRank:2}],rp:54,dc:26,lumber:12,stone:12}},{name:"Cathedral",activityBonusRules:[{value:3,activity:"celebrate-holiday"},{value:3,activity:"provide-care"},{value:3,activity:"repair-reputation-corruption"}],availableItemsRules:[{value:3,group:"divine",maximumStacks:3}],notes:"While in a settlement with a cathedral, you gain a +3 item bonus to Lore and Religion checks made to Recall Knowledge while Investigating, and to all faith-themed checks made while Researching.",traits:["building","edifice","famous","infamous"],affectsDowntime:!0,reducesUnrest:!0,level:15,upgradeFrom:["Temple"],construction:{skills:[{skill:"folklore",proficiencyRank:3}],rp:58,dc:34,lumber:20,stone:20}},{name:"Cemetery",traits:["yard"],affectsEvents:!0,affectsDowntime:!1,reducesUnrest:!0,level:1,construction:{skills:[{skill:"folklore"}],dc:15,rp:4,stone:1}},{name:"Construction Yard",activityBonusRules:[{value:1,activity:"build-structure"},{value:1,activity:"repair-reputation-decay"}],traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:10,construction:{skills:[{skill:"engineering"}],dc:27,rp:40,lumber:10,stone:10}},{name:"Dump",activityBonusRules:[{value:1,activity:"demolish"}],traits:["yard"],affectsEvents:!0,affectsDowntime:!1,reducesUnrest:!1,level:2,construction:{skills:[{skill:"industry"}],dc:16,rp:4}},{name:"Embassy",activityBonusRules:[{value:1,activity:"send-diplomatic-envoy"},{value:1,activity:"request-foreign-aid"}],traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:8,construction:{skills:[{skill:"politics"}],dc:24,rp:26,lumber:10,stone:4,luxuries:6}},{name:"Festival Hall",activityBonusRules:[{value:1,activity:"celebrate-holiday"}],traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{skills:[{skill:"arts"}],dc:18,rp:7,lumber:3}},{name:"Foundry",activityBonusRules:[{value:1,activity:"establish-work-site-mine"}],storage:{ore:1},traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{skills:[{skill:"industry",proficiencyRank:1}],dc:18,rp:16,lumber:5,stone:3,ore:2}},{name:"Garrison",activityBonusRules:[{value:1,activity:"outfit-army"},{value:1,activity:"train-army"}],traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!0,level:5,upgradeFrom:["Barracks"],construction:{skills:[{skill:"warfare",proficiencyRank:1}],dc:20,rp:28,lumber:6,stone:3}},{name:"General Store",preventItemLevelPenalty:!0,traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:1,construction:{skills:[{skill:"trade"}],dc:15,rp:8,lumber:1}},{name:"Gladiatorial Arena",activityBonusRules:[{value:3,activity:"celebrate-holiday"},{value:3,activity:"hire-adventurers"}],skillBonusRules:[{value:3,skill:"warfare",activity:"quell-unrest"}],notes:"A gladiatorial arena allows a PC in the settlement to retrain combat-themed feats (at the GM's discretion) more efficiently; doing so takes only 4 days rather than a week of downtime.",traits:["edifice","famous","infamous","yard"],affectsDowntime:!0,reducesUnrest:!1,level:15,construction:{rp:58,lumber:10,stone:30,skills:[{skill:"warfare",proficiencyRank:3}],dc:34}},{name:"Houses",traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!1,level:1,upgradeFrom:["Tenement"],construction:{rp:3,lumber:1,skills:[{skill:"industry"}],dc:15}},{name:"Granary",storage:{food:1},traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:1,construction:{rp:12,lumber:2,skills:[{skill:"agriculture"}],dc:15}},{name:"Guildhall",notes:"While in a settlement with a guildhall, you gain a +1 item bonus to all related skill checks to Earn Income or to Repair.",traits:["building"],affectsDowntime:!0,reducesUnrest:!1,level:5,construction:{rp:34,lumber:8,skills:[{skill:"trade",proficiencyRank:2}],dc:20},upgradeFrom:["Trade Shop"]},{name:"Herbalist",activityBonusRules:[{value:1,activity:"provide-care"}],traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:1,construction:{rp:10,lumber:1,skills:[{skill:"wilderness"}],dc:15}},{name:"Hospital",activityBonusRules:[{value:1,activity:"provide-care"},{value:1,activity:"quell-unrest"}],notes:"While in a settlement with a hospital, you gain a +2 item bonus to Medicine checks to Treat Disease and Treat Wounds.",traits:["building"],affectsDowntime:!0,reducesUnrest:!1,level:9,upgradeFrom:["Herbalist"],construction:{rp:30,lumber:10,stone:6,skills:[{skill:"defense",proficiencyRank:2}],dc:26}},{name:"Illicit Market",activityBonusRules:[{value:1,activity:"clandestine-business"}],availableItemsRules:[{value:1,maximumStacks:3}],traits:["building","infamous"],affectsDowntime:!1,reducesUnrest:!1,level:6,construction:{rp:50,lumber:5,skills:[{skill:"intrigue",proficiencyRank:1}],dc:22}},{name:"Inn",activityBonusRules:[{value:1,activity:"hire-adventurers"}],traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!1,level:1,construction:{rp:10,lumber:2,skills:[{skill:"trade"}],dc:15}},{name:"Jail",skillBonusRules:[{value:1,skill:"intrigue",activity:"quell-unrest"}],traits:["building"],affectsDowntime:!1,reducesUnrest:!0,level:2,construction:{rp:14,lumber:4,stone:4,ore:2,skills:[{skill:"defense"}],dc:16}},{name:"Keep",activityBonusRules:[{value:1,activity:"deploy-army"},{value:1,activity:"garrison-army"},{value:1,activity:"train-army"}],traits:["building","edifice"],affectsDowntime:!1,reducesUnrest:!0,level:3,construction:{rp:32,lumber:8,stone:8,skills:[{skill:"defense",proficiencyRank:1}],dc:18}},{name:"Library",skillBonusRules:[{value:1,skill:"scholarship",activity:"rest-and-relax"}],notes:"While in a settlement with a library, you gain a +1 item bonus to Lore checks made to Recall Knowledge while Investigating, as well as to Researching checks, and to Decipher Writing checks.",traits:["building"],affectsDowntime:!0,reducesUnrest:!1,level:2,construction:{rp:6,lumber:4,stone:2,skills:[{skill:"scholarship",proficiencyRank:1}],dc:16}},{name:"Lumberyard",activityBonusRules:[{value:1,activity:"establish-work-site-lumber"}],storage:{lumber:1},traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{rp:16,lumber:5,ore:1,skills:[{skill:"industry",proficiencyRank:1}],dc:18}},{name:"Luxury Store",activityBonusRules:[{value:1,activity:"establish-trade-agreement"}],availableItemsRules:[{value:1,group:"luxury",maximumStacks:3}],traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:6,upgradeFrom:["General Store"],construction:{rp:28,lumber:10,luxuries:6,skills:[{skill:"trade",proficiencyRank:2}],dc:22}},{name:"Magic Shop",activityBonusRules:[{value:1,activity:"supernatural-solution"}],availableItemsRules:[{value:1,group:"magical",maximumStacks:3}],traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:8,upgradeFrom:["Luxury Store"],construction:{rp:44,lumber:8,stone:6,luxuries:6,skills:[{skill:"magic",proficiencyRank:2}],dc:24}},{name:"Magical Streetlamps",traits:["infrastructure"],lots:0,affectsDowntime:!1,reducesRuin:!0,level:5,construction:{rp:20,skills:[{skill:"magic",proficiencyRank:2}],dc:20}},{name:"Mansion",activityBonusRules:[{value:1,activity:"improve-lifestyle"}],traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!1,level:5,upgradeFrom:["Houses"],construction:{rp:10,lumber:6,stone:3,luxuries:6,skills:[{skill:"industry",proficiencyRank:1}],dc:20}},{name:"Marketplace",activityBonusRules:[{value:1,activity:"establish-trade-agreement"}],preventItemLevelPenalty:!0,traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!1,level:4,upgradeFrom:["General Store"],construction:{rp:48,lumber:4,skills:[{skill:"trade",proficiencyRank:1}],dc:19}},{name:"Menagerie",skillBonusRules:[{value:2,skill:"wilderness",activity:"rest-and-relax"}],notes:"A menagerie typically contains a selection of level 5 or lower animals. If your party captures a living creature of level 6 or higher and can transport the creature back to a settlement with a menagerie, you can add that creature to the menagerie as long as your kingdom level is at least 4 higher than the creature's level. Each time such a creature is added to a menagerie, gain 1 Fame or Infamy point (as appropriate) or reduce one Ruin of your choice by 1.\nOnly creatures with Intelligence modifiers of –4 or –5 are appropriate to place in a menagerie. A kingdom gains 1 Unrest at the start of a Kingdom turn for each sapient creature (anything with an Intelligence modifier of –3 or higher) on display in a menagerie.",traits:["building","edifice"],affectsDowntime:!1,reducesUnrest:!1,reducesRuin:!0,level:12,upgradeFrom:["Park"],construction:{rp:26,lumber:14,stone:10,ore:10,skills:[{skill:"wilderness",proficiencyRank:2}],dc:30}},{name:"Military Academy",activityBonusRules:[{value:2,activity:"train-army"}],skillBonusRules:[{value:2,skill:"warfare",activity:"pledge-of-fealty"}],traits:["building","edifice"],affectsDowntime:!1,reducesUnrest:!1,level:12,upgradeFrom:["Academy"],construction:{rp:36,lumber:12,stone:10,ore:6,skills:[{skill:"warfare",proficiencyRank:2}],dc:30}},{name:"Mill",activityBonusRules:[{value:1,activity:"harvest-crops"}],consumptionReduction:1,traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:2,construction:{rp:6,lumber:2,stone:1,skills:[{skill:"industry",proficiencyRank:1}],dc:16}},{name:"Mint",activityBonusRules:[{value:3,activity:"capital-investment"},{value:3,activity:"collect-taxes"},{value:3,activity:"repair-reputation-crime"}],traits:["building","edifice"],affectsDowntime:!1,reducesUnrest:!1,level:15,construction:{rp:30,lumber:12,stone:16,ore:20,skills:[{skill:"trade",proficiencyRank:3}],dc:34}},{name:"Monument",traits:["building","edifice"],affectsDowntime:!1,reducesUnrest:!0,level:3,construction:{rp:6,stone:1,skills:[{skill:"arts",proficiencyRank:1}],dc:18}},{name:"Museum",skillBonusRules:[{value:1,skill:"arts",activity:"rest-and-relax"}],notes:"A magic item of level 6 or higher that has a particular import or bears significant historical or regional value (at the GM's discretion) can be donated to a museum. Each time such an item is donated, reduce Unrest by 1. If that item is later removed from display, increase Unrest by 1.",traits:["building","edifice"],affectsDowntime:!1,reducesUnrest:!0,level:5,construction:{rp:30,lumber:6,stone:2,skills:[{skill:"exploration",proficiencyRank:1}],dc:20}},{name:"Noble Villa",activityBonusRules:[{value:1,activity:"improve-lifestyle"}],skillBonusRules:[{value:1,skill:"politics",activity:"quell-unrest"}],traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!0,level:9,upgradeFrom:["Mansion"],construction:{rp:24,lumber:10,stone:8,luxuries:6,skills:[{skill:"politics",proficiencyRank:2}],dc:19}},{name:"Occult Shop",activityBonusRules:[{value:2,activity:"prognostication"}],availableItemsRules:[{value:1,group:"occult",maximumStacks:3}],notes:"While in a settlement with an occult shop, you gain a +2 item bonus to all checks made to Research esoteric subjects or to Recall Knowledge about the same.",traits:["building"],affectsDowntime:!0,reducesUnrest:!1,level:13,construction:{rp:68,lumber:12,stone:6,luxuries:12,skills:[{skill:"magic",proficiencyRank:3}],dc:32}},{name:"Opera House",activityBonusRules:[{value:3,activity:"celebrate-holiday"},{value:3,activity:"create-a-masterpiece"}],notes:"While in a settlement with an opera house, you gain a +3 item bonus to Performance checks made to Earn Income.",traits:["building","edifice","famous","infamous"],affectsDowntime:!0,reducesUnrest:!0,level:15,upgradeFrom:["Theater"],construction:{rp:40,lumber:20,stone:16,luxuries:18,skills:[{skill:"arts",proficiencyRank:3}],dc:34}},{name:"Orphanage",traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!0,level:2,upgradeFrom:["Houses"],construction:{rp:6,lumber:2,skills:[{skill:"industry"}],dc:16}},{name:"Palace",activityBonusRules:[{value:3,activity:"new-leadership"},{value:3,activity:"pledge-of-fealty"},{value:3,activity:"send-diplomatic-envoy"},{value:3,activity:"garrison-army"},{value:3,activity:"recover-army"},{value:3,activity:"recruit-army"}],leadershipActivityRules:[{value:3}],increaseLeadershipActivities:!0,traits:["building","edifice","famous","infamous"],affectsDowntime:!1,reducesUnrest:!0,level:15,upgradeFrom:["Castle"],construction:{rp:108,lumber:20,stone:20,ore:15,luxuries:12,skills:[{skill:"defense",proficiencyRank:3},{skill:"industry",proficiencyRank:3},{skill:"magic",proficiencyRank:3},{skill:"statecraft",proficiencyRank:3}],dc:34}},{name:"Park",skillBonusRules:[{value:1,skill:"wilderness",activity:"rest-and-relax"}],traits:["yard"],affectsDowntime:!1,reducesUnrest:!0,level:3,construction:{rp:5,skills:[{skill:"wilderness"}],dc:18}},{name:"Paved Streets",traits:["infrastructure"],lots:0,affectsDowntime:!1,reducesUnrest:!1,level:4,construction:{rp:12,stone:6,skills:[{skill:"industry",proficiencyRank:1}],dc:19}},{name:"Pier",activityBonusRules:[{value:1,activity:"go-fishing"}],traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{rp:16,lumber:2,skills:[{skill:"boating"}],dc:18}},{name:"Rubble",traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:0},{name:"Printing House",activityBonusRules:[{value:2,activity:"improve-lifestyle"},{value:2,activity:"quell-unrest"}],notes:"A PC in a settlement with a printing house gains a +2 item bonus to checks to Gather Information or to Research any topic in a library or similar structure.",unlockActivities:["read-all-about-it"],traits:["building","edifice"],affectsDowntime:!0,reducesUnrest:!1,level:10,construction:{rp:48,lumber:14,luxuries:12,skills:[{skill:"industry",proficiencyRank:3}],dc:27}},{name:"Sacred Grove",skillBonusRules:[{value:1,skill:"folklore",activity:"quell-unrest"}],availableItemsRules:[{value:1,group:"primal",maximumStacks:3}],traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:5,construction:{rp:36,skills:[{skill:"wilderness",proficiencyRank:1}],dc:20}},{name:"Secure Warehouse",activityBonusRules:[{value:1,activity:"craft-luxuries"}],storage:{luxuries:1},traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:6,construction:{rp:24,lumber:6,stone:6,ore:4,skills:[{skill:"industry",proficiencyRank:2}],dc:22}},{name:"Sewer System",activityBonusRules:[{value:1,activity:"clandestine-business"}],consumptionReduction:1,traits:["infrastructure"],lots:0,affectsEvents:!0,affectsDowntime:!1,reducesUnrest:!1,level:7,construction:{rp:24,lumber:8,stone:8,skills:[{skill:"engineering",proficiencyRank:2}],dc:23}},{name:"Shrine",activityBonusRules:[{value:1,activity:"celebrate-holiday"}],availableItemsRules:[{value:1,group:"divine",maximumStacks:3}],traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:1,construction:{rp:8,lumber:2,stone:1,skills:[{skill:"folklore",proficiencyRank:1}],dc:15}},{name:"Smithy",activityBonusRules:[{value:1,activity:"trade-commodities"},{value:1,activity:"outfit-army"}],notes:"While in a settlement with a smithy, you gain a +1 item bonus to Craft checks made to work with metal.",traits:["building"],affectsDowntime:!0,reducesUnrest:!1,level:3,construction:{rp:8,lumber:2,stone:1,ore:1,skills:[{skill:"industry",proficiencyRank:1}],dc:18}},{name:"Specialized Artisan",activityBonusRules:[{value:1,activity:"craft-luxuries"}],notes:"While in a settlement with a specialized artisan, you gain a +1 item bonus to Craft checks made to craft specialized goods like jewelry.",traits:["building"],affectsDowntime:!0,reducesUnrest:!1,level:4,construction:{rp:10,lumber:4,luxuries:1,skills:[{skill:"trade",proficiencyRank:2}],dc:19}},{name:"Stable",activityBonusRules:[{value:1,activity:"establish-trade-agreement"}],traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{rp:10,lumber:2,skills:[{skill:"wilderness",proficiencyRank:1}],dc:18}},{name:"Stockyard",activityBonusRules:[{value:1,activity:"gather-livestock"}],consumptionReduction:1,traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{rp:20,lumber:4,skills:[{skill:"industry"}],dc:18}},{name:"Stonemason",activityBonusRules:[{value:1,activity:"establish-work-site-quarry"}],storage:{stone:1},traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{rp:16,lumber:2,skills:[{skill:"industry",proficiencyRank:1}],dc:18}},{name:"Tannery",activityBonusRules:[{value:1,activity:"trade-commodities"}],traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{rp:6,lumber:2,skills:[{skill:"industry",proficiencyRank:1}],dc:18}},{name:"Tavern, Dive",traits:["building"],affectsDowntime:!1,reducesUnrest:!0,level:1,construction:{rp:12,lumber:1,skills:[{skill:"trade",proficiencyRank:1}],dc:15}},{name:"Tavern, Luxury",activityBonusRules:[{value:2,activity:"hire-adventurers"}],skillBonusRules:[{value:2,skill:"trade",activity:"rest-and-relax"}],notes:"If attempt a Performance check to Earn Income in a settlement with a luxury tavern, you gain a +2 item bonus to the check. All checks made to Gather Information in a settlement with at least one luxury tavern gain a +2 item bonus.",traits:["building","famous"],affectsDowntime:!0,reducesUnrest:!0,level:9,upgradeFrom:["Tavern, Popular"],construction:{rp:48,lumber:10,stone:8,luxuries:8,skills:[{skill:"trade",proficiencyRank:3}],dc:26}},{name:"Tavern, Popular",activityBonusRules:[{value:1,activity:"hire-adventurers"}],skillBonusRules:[{value:1,skill:"trade",activity:"rest-and-relax"}],notes:"If you attempt a Performance check to Earn Income in a settlement with a popular tavern, you gain a +1 item bonus to the check. All checks made to Gather Information in a settlement with at least one popular tavern gain a +1 item bonus.",traits:["building"],affectsDowntime:!0,reducesUnrest:!0,level:3,upgradeFrom:["Tavern, Dive"],construction:{rp:24,lumber:6,stone:2,skills:[{skill:"trade",proficiencyRank:2}],dc:18}},{name:"Tavern, World-Class",activityBonusRules:[{value:3,activity:"hire-adventurers"},{value:3,activity:"repair-reputation-strife"}],skillBonusRules:[{value:3,skill:"trade",activity:"rest-and-relax"}],notes:"If you attempt a Performance check to Earn Income in a settlement with a world-class tavern, you gain a +3 item bonus to the check. All checks made to Gather Information in a settlement with a world-class tavern gain a +3 item bonus.",traits:["building","edifice","famous"],affectsDowntime:!0,reducesUnrest:!0,level:15,upgradeFrom:["Tavern, Luxury"],construction:{rp:64,lumber:18,stone:15,luxuries:15,skills:[{skill:"trade",proficiencyRank:3}],dc:34}},{name:"Temple",activityBonusRules:[{value:1,activity:"celebrate-holiday"},{value:1,activity:"provide-care"}],availableItemsRules:[{value:1,group:"divine",maximumStacks:3}],traits:["building","famous","infamous"],affectsDowntime:!1,reducesUnrest:!0,level:7,upgradeFrom:["Shrine"],construction:{rp:32,lumber:6,stone:6,skills:[{skill:"folklore",proficiencyRank:1}],dc:23}},{name:"Tenement",traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!0,level:0,construction:{rp:1,lumber:1,skills:[{skill:"industry"}],dc:14}},{name:"Theater",activityBonusRules:[{value:2,activity:"celebrate-holiday"}],notes:"While in a settlement with a theater, you gain a +2 item bonus to Performance checks made to Earn Income.",traits:["building"],affectsDowntime:!0,reducesUnrest:!0,level:9,upgradeFrom:["Festival Hall"],construction:{rp:24,lumber:8,stone:3,skills:[{skill:"arts",proficiencyRank:2}],dc:26}},{name:"Thieves' Guild",activityBonusRules:[{value:1,activity:"infiltration"}],notes:"While in a settlement with a thieves' guild, you gain a +1 item bonus to Create Forgeries.",traits:["building","infamous"],affectsDowntime:!0,reducesUnrest:!1,level:5,construction:{rp:25,lumber:4,skills:[{skill:"intrigue",proficiencyRank:1}],dc:20}},{name:"Town Hall",increaseLeadershipActivities:!0,traits:["building","edifice"],affectsDowntime:!1,reducesUnrest:!0,level:2,construction:{rp:22,lumber:4,stone:4,skills:[{skill:"defense",proficiencyRank:1},{skill:"industry",proficiencyRank:1},{skill:"magic",proficiencyRank:1},{skill:"statecraft",proficiencyRank:1}],dc:16}},{name:"Trade Shop",activityBonusRules:[{value:1,activity:"purchase-commodities"}],notes:"When you build a trade shop, indicate the kind of shop it is, such as a bakery, carpenter, tailor, and so on. While in a settlement with a trade shop, you gain a +1 item bonus to all associated Crafting checks.",traits:["building"],affectsDowntime:!0,reducesUnrest:!1,level:3,construction:{rp:10,lumber:2,skills:[{skill:"trade",proficiencyRank:1}],dc:18}},{name:"University",activityBonusRules:[{value:3,activity:"creative-solution"}],notes:"While in a settlement with a university, you gain a +3 item bonus to Lore checks made to Recall Knowledge while Investigating, to Research checks (Gamemastery Guide 154), and to Decipher Writing.",traits:["building","edifice","famous"],affectsDowntime:!0,reducesUnrest:!1,level:15,upgradeFrom:["Academy"],construction:{rp:78,lumber:18,stone:18,luxuries:18,skills:[{skill:"scholarship",proficiencyRank:3}],dc:34}},{name:"Wall, Stone",traits:["infrastructure"],lots:0,affectsDowntime:!1,reducesUnrest:!0,level:5,upgradeFrom:["Wall, Wooden"],construction:{rp:4,stone:8,skills:[{skill:"defense",proficiencyRank:1}],dc:20}},{name:"Wall, Wooden",traits:["infrastructure"],lots:0,affectsDowntime:!1,reducesUnrest:!0,level:1,construction:{rp:2,lumber:4,skills:[{skill:"defense"}],dc:15}},{name:"Watchtower",settlementEventRules:[{value:1}],traits:["building"],affectsDowntime:!1,reducesUnrest:!0,level:3,construction:{rp:12,lumber:4,skills:[{skill:"defense",proficiencyRank:1}],dc:18}},{name:"Watchtower, Stone",stacksWith:"Watchtower",settlementEventRules:[{value:1}],traits:["building"],affectsDowntime:!1,reducesUnrest:!0,level:3,construction:{rp:12,stone:4,skills:[{skill:"defense",proficiencyRank:1}],dc:18}},{name:"Waterfront",activityBonusRules:[{value:1,activity:"go-fishing"},{value:1,activity:"establish-trade-agreement"}],availableItemsRules:[{value:1,maximumStacks:1}],traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:8,upgradeFrom:["Pier"],construction:{rp:90,lumber:10,skills:[{skill:"boating",proficiencyRank:2}],dc:24}}].forEach((e=>t.structuresByName.set(e.name,e)));Array.from(Object.entries({Bank:{activityBonusRules:[{value:1,activity:"capital-investment"},{value:1,activity:"collect-taxes"}]},Castle:{activityBonusRules:[{value:2,activity:"manage-trade-agreements"},{value:2,activity:"relocate-capital"}]},"Construction Yard":{activityBonusRules:[{value:1,activity:"build-roads"},{value:1,activity:"irrigation"}]},"Festival Hall":{skillBonusRules:[{activity:"quell-unrest",skill:"arts",value:1}]},Garrison:{activityBonusRules:[{value:1,activity:"fortify-hex"}]},Granary:{activityBonusRules:[{value:1,activity:"establish-farmland"}]},Inn:{skillBonusRules:[{value:1,activity:"clear-hex",skill:"exploration"}]},Library:{activityBonusRules:[{value:1,activity:"creative-solution"}]},"Magic Shop":{activityBonusRules:[{value:1,activity:"prognostication"}]},Monument:{activityBonusRules:[{value:1,activity:"create-a-masterpiece"}]},"Occult Shop":{activityBonusRules:[{value:2,activity:"supernatural-solution"}]},Palace:{activityBonusRules:[{value:3,activity:"manage-trade-agreements"},{value:3,activity:"relocate-capital"}]},Smithy:{skillBonusRules:[{value:1,activity:"clear-hex",skill:"engineering"}]},"Tavern, Dive":{skillBonusRules:[{value:1,activity:"clear-hex",skill:"exploration"}]},"Tavern, Luxury":{activityBonusRules:[{value:2,activity:"reconnoiter-hex"}]},"Tavern, Popular":{activityBonusRules:[{value:1,activity:"reconnoiter-hex"}]},"Tavern, World-Class":{activityBonusRules:[{value:3,activity:"reconnoiter-hex"}]},"Town Hall":{activityBonusRules:[{value:1,activity:"manage-trade-agreements"}]}})).forEach((([e,i])=>{const n=t.structuresByName.get(e);if(void 0===n)throw new Error(`VK Adjustment typo: ${e}`);const a=JSON.parse(JSON.stringify(n));"Granary"===e&&(a.construction.skills[0].proficiencyRank=1),i.skillBonusRules?.forEach((e=>{void 0===a.skillBonusRules&&(a.skillBonusRules=[]),a.skillBonusRules?.push(e)})),i.activityBonusRules?.forEach((e=>{void 0===a.activityBonusRules&&(a.activityBonusRules=[]),a.activityBonusRules?.push(e)})),a.name=`${a.name} (V&K)`,t.structuresByName.set(a.name,a)}))},9329:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateUnrestPenalty=void 0,t.calculateUnrestPenalty=function(e){return e<1?0:e<5?1:e<10?2:e<15?3:4}},2468:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.manageKingdomActivitiesDialog=void 0;const n=i(8593),a=i(7066),s=i(943),r=i(7178);class ManageKingdomActivitiesDialog extends FormApplication{game;actor;static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-manage-kingdom-activities",e.title="Manage Kingdom Activities",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/manage-activities.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=[],e.height="auto",e}constructor(e,t){super(e,t),this.game=t.game,this.actor=t.actor}getData(){const e=(0,a.getKingdom)(this.actor);return{activities:this.buildActivities(e)}}async _updateObject(e,t){await(0,a.saveKingdom)(this.actor,{activityBlacklist:Object.entries(t).filter((([,e])=>!e)).map((([e])=>e))}),this.render()}activateListeners(e){super.activateListeners(e);const t=e[0];(0,n.listenClick)(t,".add-activity",(async()=>{const e=(0,a.getKingdom)(this.actor);(0,r.addActivityDialog)({onOk:this.onSave.bind(this),homebrewActivities:e.homebrewActivities})})),(0,n.listenClick)(t,".edit-activity",(async e=>{const t=(0,a.getKingdom)(this.actor),i=e.currentTarget.dataset.id,n=t.homebrewActivities.find((e=>e.id===i));(0,r.addActivityDialog)({onOk:this.onSave.bind(this),activity:n,homebrewActivities:t.homebrewActivities})})),(0,n.listenClick)(t,".delete-activity",(async e=>{const t=e.currentTarget.dataset.id,i=(0,a.getKingdom)(this.actor);await(0,a.saveKingdom)(this.actor,{homebrewActivities:i.homebrewActivities.filter((e=>e.id!==t))}),this.render()}))}async onSave(e){const t=[...(0,a.getKingdom)(this.actor).homebrewActivities.filter((t=>t.id!==e.id)),e];await(0,a.saveKingdom)(this.actor,{homebrewActivities:t}),this.render()}buildActivities(e){const t=new Set(e.activityBlacklist),i=new Set(e.homebrewActivities.map((e=>e.id)));return(0,s.getKingdomActivities)(e.homebrewActivities).map((e=>({enabled:!t.has(e.id),title:e.title,id:e.id,isHomebrew:i.has(e.id)}))).sort(((e,t)=>e.title.localeCompare(t.title)))}}t.manageKingdomActivitiesDialog=function(e,t){new ManageKingdomActivitiesDialog(null,{game:e,actor:t}).render(!0)}},7178:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addActivityDialog=void 0;const n=i(8593),a=i(6013),s=i(5437),r=i(6362);function o(e){return(0,n.isBlank)(e)?void 0:{msg:e}}class AddKingdomActivities extends FormApplication{onSubmitCallback;activity;edit;homebrewActivities;static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-add-kingdom-activities",e.title="Manage Kingdom Activities",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/add-activity-dialog.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=[],e.height="auto",e.width=400,e}constructor(e,t){super(e,t),this.onSubmitCallback=t.onOk,this.edit=void 0!==t.activity,this.activity={special:t.activity?.special??"",requirement:t.activity?.requirement??"",description:t.activity?.description??"",dcAdjustment:t.activity?.dcAdjustment??0,fortune:t.activity?.fortune??!1,failure:{msg:t.activity?.failure?.msg??""},success:{msg:t.activity?.success?.msg??""},criticalFailure:{msg:t.activity?.criticalFailure?.msg??""},criticalSuccess:{msg:t.activity?.criticalSuccess?.msg??""},dc:t.activity?.dc??"control",title:t.activity?.title??"",hint:t.activity?.hint??"",id:t.activity?.id??"",skills:t.activity?.skills??{agriculture:0},phase:t.activity?.phase??"leadership",oncePerRound:t.activity?.oncePerRound??!1,enabled:t.activity?.enabled??!0},this.homebrewActivities=t.homebrewActivities}async getData(){return{phases:["army","leadership","region"].map((e=>({label:(0,n.capitalize)(e),value:e}))),phase:this.activity.phase,dc:this.activity.dc,fortune:this.activity.fortune,edit:this.edit,hint:this.activity.hint??"",id:this.activity.id,title:this.activity.title,special:this.activity.special??"",requirement:this.activity.requirement??"",description:this.activity.description,oncePerRound:this.activity.oncePerRound,dcAdjustment:this.activity.dcAdjustment??0,criticalSuccess:this.activity.criticalSuccess?.msg??"",success:this.activity.success?.msg??"",failure:this.activity.failure?.msg??"",criticalFailure:this.activity.criticalFailure?.msg??"",dcs:["none","control","custom",...(0,n.range)(14,51).map((e=>e.toString()))].map((e=>({value:e,label:(0,n.capitalize)(e)}))),skills:Array.from(Object.entries(this.activity.skills)).map((([e,t])=>({proficiency:(0,r.rankToProficiency)(t),id:e,label:(0,n.capitalize)(e)}))),errors:await this.validate(this.activity)}}async _updateObject(e,t){var i;console.log(t),this.edit||(this.activity.id=t.id),this.activity.title=t.title,this.activity.description=t.description,this.activity.hint=(0,n.blankToUndefined)(t.hint),this.activity.special=(0,n.blankToUndefined)(t.special),this.activity.requirement=(0,n.blankToUndefined)(t.requirement),this.activity.phase=t.phase,this.activity.dc="control"===(i=t.dc)||"custom"===i||"none"===i?i:parseInt(i,10)||0,this.activity.dcAdjustment=t.dcAdjustment,this.activity.oncePerRound=t.oncePerRound,this.activity.fortune=t.fortune,this.activity.criticalSuccess=o(t.criticalSuccess),this.activity.success=o(t.success),this.activity.failure=o(t.failure),this.activity.criticalFailure=o(t.criticalFailure),this.render()}activateListeners(e){super.activateListeners(e);const t=e[0];(0,n.listenClick)(t,".save",(async()=>{await this.onSubmitCallback(this.activity),await this.close()})),(0,n.listenClick)(t,".edit-skills",(async()=>{const e=this.activity.skills,t=Object.entries(e).map((([e,t])=>({id:e,proficiency:(0,r.rankToProficiency)(t)})))||void 0;(0,s.skillDialog)({selectedSkills:t,atLeastOne:!0,onSave:e=>{this.activity.skills=Object.fromEntries(e.selectedSkills.map((e=>[e.id,(0,r.proficiencyToRank)(e.proficiency)]))),this.render()},availableSkills:[...a.allSkills]})}))}async validate(e){const t=[];return/^[a-z\\-]+$/.test(e.id)||t.push("ID must only contain lower case English letters and hyphens!"),this.homebrewActivities.find((t=>e.id===t.id))&&!this.edit&&t.push(`Homebrew activity with id ${e.id} exists already, can not add another one`),(0,n.isBlank)(e.title)&&t.push("Title must not be blank"),t}}t.addActivityDialog=function(e){new AddKingdomActivities(null,e).render(!0)}},5516:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AddBonusFeatDialog=void 0;class AddBonusFeatDialog extends FormApplication{feats;onOk;selected="-";static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-add-bonus-feat",e.title="Kingdom",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/add-bonus-feat.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=[],e.height="auto",e}constructor(e,t){super(e,t),this.feats=t.feats,this.onOk=t.onOk}getData(e){return{feats:this.feats,selected:this.selected,feat:this.feats.find((e=>e.name===this.selected)),...super.getData(e)}}async _updateObject(e,t){this.selected=t.selected,this.render()}activateListeners(e){super.activateListeners(e);const t=e[0];t.querySelector("button")?.addEventListener("click",(async()=>{const e=this.feats.find((e=>e.name===this.selected));this.onOk({id:e.name}),await this.close()}))}}t.AddBonusFeatDialog=AddBonusFeatDialog},4757:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addEffectDialog=void 0;const n=i(1154),a=i(6362),s=i(8593),r=i(6013),o=i(2596),l=a.allModifierTypes.flatMap((e=>"vacancy"===e?[{label:(0,s.capitalize)(e)+" Penalty",value:`${e}-penalty`}]:[{label:(0,s.capitalize)(e)+" Bonus",value:`${e}-bonus`},{label:(0,s.capitalize)(e)+" Penalty",value:`${e}-penalty`}])),c=(0,s.createLabels)(n.allKingdomPhases),u=(0,s.createLabels)(r.allSkills),m=(0,s.createLabels)(o.allAbilities);function d(e){const t=(0,s.createLabels)(e,!0);return`\n        <form class="simple-dialog-form">\n            <div>\n                <label for="km-effect-name">Name</label>\n                <input type="text" name="name" id="km-effect-name">\n            </div>\n            <div>\n                <label for="km-effect-type"></label>\n                <select name="type" id="km-effect-type">\n                    ${l.map((e=>`<option value="${e.value}">${e.label}</option>`))}\n                </select>\n            </div>\n            <div>\n                <label for="km-effect-value">Value</label>\n                <input type="number" name="value" id="km-effect-value">\n            </div>\n            <div>\n                <label for="km-effect-phase">Phase</label>\n                <select name="phase" id="km-effect-phase">\n                    <option value="-">-</option>\n                    ${c.map((e=>`<option value="${e.value}">${e.label}</option>`))}\n                </select>\n            </div>\n            <div>\n                <label for="km-effect-activity">Activity</label>\n                <select name="activity" id="km-effect-activity">\n                    <option value="-">-</option>\n                    ${t.map((e=>`<option value="${e.value}">${e.label}</option>`))}\n                </select>\n            </div>\n            <div>\n                <label for="km-effect-ability">Ability</label>\n                <select name="ability" id="km-effect-ability">\n                    <option value="-">-</option>\n                    ${m.map((e=>`<option value="${e.value}">${e.label}</option>`))}\n                </select>\n            </div>\n            <div>\n                <label for="km-effect-skill">Skill</label>\n                <select name="skill" id="km-effect-skill">\n                    <option value="-">-</option>\n                    ${u.map((e=>`<option value="${e.value}">${e.label}</option>`))}\n                </select>\n            </div>\n            <div>\n                <label for="km-effect-enabled">Enabled</label>\n                <input type="checkbox" name="enabled" id="km-effect-enabled" checked>\n            </div>\n            <div>\n                <label for="km-effect-turns">Turns (0 for indefinite)</label>\n                <input type="number" name="turns" id="km-effect-turns" value="1">\n            </div>\n            <div>\n                <label for="km-effect-consumable">Consume after Use</label>\n                <input type="checkbox" name="consumable" id="km-effect-consumable">\n            </div>\n        </form>\n        `}function h(e,t){const i=(0,s.parseSelect)(e,t);return"-"===i?void 0:[i]}t.addEffectDialog=function(e,t){new Dialog({title:"Add Effect",content:d(e),buttons:{add:{icon:'<i class="fa-solid fa-plus"></i>',label:"Add",callback:async e=>{const i=e,n=(0,s.parseNumberInput)(i,"turns"),{type:a,value:r}=function(e,t){const[i,n]=e.split("-");return"penalty"===n?{type:i,value:-Math.abs(t)}:{type:i,value:Math.abs(t)}}((0,s.parseSelect)(i,"type"),(0,s.parseNumberInput)(i,"value")),o=h(i,"phase"),l=h(i,"activity"),c=h(i,"skill"),u=h(i,"ability");t({name:(0,s.parseTextInput)(i,"name"),type:a,value:r,enabled:(0,s.parseCheckbox)(i,"enabled"),consumeId:(0,s.parseCheckbox)(i,"consumable")?crypto.randomUUID():void 0,phases:o,activities:l,skills:c,abilities:u,turns:0===n?void 0:n})}}},default:"add"},{jQuery:!1,width:400}).render(!0)}},7079:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addGroupDialog=void 0,t.addGroupDialog=function(e){new Dialog({title:"Add Group",content:'\n        <form class="simple-dialog-form">\n            <div>\n                <label>Name</label> \n                <input name="name" type="text">\n            </div>\n            <div>\n                <label>Negotiation DC</label>\n                <input name="negotiationDC" type="number">\n            </div>\n        </form>\n        ',buttons:{add:{icon:'<i class="fa-solid fa-plus"></i>',label:"Add",callback:async t=>{const i=t,n=i.querySelector("input[name=name]"),a=i.querySelector("input[name=negotiationDC]"),s=parseInt(a.value,10),r={name:n.value,negotiationDC:isNaN(s)?0:s,atWar:!1,relations:"none"};e(r)}}},default:"add"},{jQuery:!1,width:380}).render(!0)}},7226:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addOngoingEventDialog=void 0,t.addOngoingEventDialog=function(e){new Dialog({title:"Add Ongoing Event",content:'\n        <form class="simple-dialog-form">\n            <div>\n                <label>Name</label> \n                <input name="name" type="text">\n            </div>\n        </form>\n        ',buttons:{add:{icon:'<i class="fa-solid fa-plus"></i>',label:"Add",callback:async t=>{const i=t.querySelector("input[name=name]");e(i.value)}}},default:"add"},{jQuery:!1,width:380}).render(!0)}},3012:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CheckDialog=void 0;const n=i(6362),a=i(1154),s=i(6013),r=i(5351),o=i(1155),l=i(8166),c=i(8593),u=i(943),m=i(6623),d=i(3483),h=i(4310);function f(e){return e.modifiers.filter((e=>e.enabled)).map((e=>({type:e.type,value:e.value,name:e.name})))}class CheckDialog extends FormApplication{type;activity;skill;game;kingdom;selectedSkill;dc;phase;customModifiers={item:{bonus:0,penalty:0},circumstance:{bonus:0,penalty:0},status:{bonus:0,penalty:0},untyped:{bonus:0,penalty:0}};modifierOverrides={};consumeModifiers=new Set;onRoll;actor;overrideSkills;afterRoll;rollOptions=[];static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-check",e.title="Skill Check",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/check.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=[],e.height="auto",e}constructor(e,t){super(e,t),this.type=t.type,this.activity=t.activity,this.skill=t.skill,this.game=t.game,this.kingdom=t.kingdom,this.actor=t.actor,this.onRoll=t.onRoll,this.afterRoll=t.afterRoll??(async()=>{}),this.overrideSkills=t.overrideSkills;const i=(0,h.getStringSetting)(this.game,"automateResources"),{size:n}=(0,d.getStolenLandsData)(this.game,i,this.kingdom),a=(0,o.getControlDC)(this.kingdom.level,n,this.kingdom.leaders.ruler.vacant);if("skill"===this.type)this.selectedSkill=t.skill,this.dc=t.dc??a;else{const e=(0,u.getKingdomActivitiesById)(this.kingdom.homebrewActivities);this.phase=e[this.activity].phase,this.selectedSkill=this.getActivitySkills(t.kingdom.skillRanks,e)[0];const i=e[this.activity],n=i.dc;if(void 0!==t.dc)this.dc=t.dc;else if("control"===n)this.dc=a;else if("custom"===n)this.dc=0;else{if("none"===n)throw Error("Can not perform activity with no DC");this.dc=n}this.dc=this.dc+(i.dcAdjustment??0)}}getActivitySkills(e,t){const i=this.activity,n=(0,l.getCompanionSkillUnlocks)(this.kingdom.leaders,(0,l.getOverrideUnlockCompanionNames)(this.game)),s=Object.entries(n).filter((([,e])=>e.includes(i))).map((([e])=>e)),r=(0,h.getBooleanSetting)(this.game,"kingdomIgnoreSkillRequirements")?void 0:e,c=(0,a.getActivitySkills)(this.overrideSkills??t[i].skills,r),u=c.includes("engineering")&&(0,o.hasFeat)(this.kingdom,"Practical Magic")?["magic"]:[];return Array.from(new Set([...c,...s,...u]))}getData(e){const t=(0,d.getActiveSettlementStructureResult)(this.game,this.kingdom),i=(0,d.getSettlement)(this.game,this.kingdom,this.kingdom.activeSettlement),a=(0,u.getKingdomActivitiesById)(this.kingdom.homebrewActivities),s="skill"===this.type?[this.skill]:this.getActivitySkills(this.kingdom.skillRanks,a),r=(0,n.createActiveSettlementModifiers)(this.kingdom,i?.settlement,t,(0,d.getSettlementsWithoutLandBorders)(this.game,this.kingdom)),o=this.createCustomModifiers(this.customModifiers),l=this.calculateModifiers(s,t,r,o,a),m=this.calculateModifiers(s,t,[...r,{enabled:!0,type:"circumstance",value:2,name:"Creative Solution"}],o,a)[this.selectedSkill],h=this.calculateModifiers(["magic"],t,r,o,a).magic,p=l[this.selectedSkill];this.rollOptions=p.total.rollOptions,this.consumeModifiers=new Set(p.modifiers.filter((e=>e.enabled&&void 0!==e.consumeId)).map((e=>e.consumeId)));const g=(0,c.encodeJson)({creativeSolution:f(m),supernaturalSolution:f(h),selected:f(p)});return{...super.getData(e),invalid:void 0===this.selectedSkill,dc:this.dc,title:this.activity?(0,c.unslugify)(this.activity):(0,c.capitalize)(this.skill),activity:this.activity,selectableSkills:this.createSelectableSkills(l),selectedSkill:this.selectedSkill,modifiers:this.createModifiers(p),phase:this.phase,customModifiers:this.customModifiers,creativeSolutionModifier:m.total.value,supernaturalSolutionModifier:h.total.value,modifierBreakdown:g}}calculateModifiers(e,t,i,a,o){return Object.fromEntries(e.map((e=>{const l=(0,r.createSkillModifiers)({ruin:this.kingdom.ruin,unrest:this.kingdom.unrest,skillRank:this.kingdom.skillRanks[e],abilityScores:this.kingdom.abilityScores,leaders:this.kingdom.leaders,kingdomLevel:this.kingdom.level,untrainedProficiencyMode:(0,n.getUntrainedProficiencyMode)(this.game),ability:s.skillAbilities[e],skillItemBonus:t?.merged?.skillBonuses?.[e],additionalModifiers:[...i,...a],activity:this.activity,phase:this.phase,skill:e,overrides:this.modifierOverrides,activities:o});return[e,{total:(0,n.calculateModifiers)(l),modifiers:l}]})))}async _updateObject(e,t){const i=expandObject(t);console.log(i),this.selectedSkill=i.selectedSkill,this.dc=i.dc,this.phase="-"===i.phase?void 0:i.phase,this.customModifiers=this.homogenize(i.customModifiers),this.modifierOverrides=Object.entries(i.overrideModifiers??{}).filter((([,e])=>"-"!==e)).map((([e,t])=>({[e]:"enabled"===t}))).reduce(((e,t)=>Object.assign(e,t)),{}),this.render()}activateListeners(e){super.activateListeners(e);const t=e[0];t.querySelector("#km-roll-skill-assurance")?.addEventListener("click",(async e=>{const t=e.currentTarget,i=parseInt(t.dataset.dc??"0",10),n=parseInt(t.dataset.modifier??"0",10),a=parseInt(t.dataset.creativeSolutionModifier??"0",10),s=parseInt(t.dataset.supernaturalSolutionModifier??"0",10),r=t.dataset.activity,l=t.dataset.type,c=t.dataset.skill,d=`${n}`,h=await(0,m.rollCheck)({formula:d,label:l,activity:r?(0,u.getKingdomActivitiesById)(this.kingdom.homebrewActivities)[r]:void 0,dc:i,skill:c,modifier:n,actor:this.actor,adjustDegreeOfSuccess:(0,m.cooperativeLeadership)((0,o.hasFeat)(this.kingdom,"Cooperative Leadership"),this.kingdom.level,this.kingdom.skillRanks[c],[...this.rollOptions]),rollOptions:this.rollOptions,creativeSolutionModifier:a,supernaturalSolutionModifier:s,rollType:"selected"});await this.onRoll(this.consumeModifiers),await this.afterRoll(h),await this.close()})),t.querySelector("#km-roll-skill")?.addEventListener("click",(async e=>{const t=e.currentTarget,i=parseInt(t.dataset.dc??"0",10),n=parseInt(t.dataset.modifier??"0",10),a=t.dataset.activity,s=t.dataset.type,r=t.dataset.modifierBreakdown,l=t.dataset.skill,c=parseInt(t.dataset.creativeSolutionModifier??"0",10),d=parseInt(t.dataset.supernaturalSolutionModifier??"0",10),h=`1d20+${n}`,f=await(0,m.rollCheck)({formula:h,label:s,activity:a?(0,u.getKingdomActivitiesById)(this.kingdom.homebrewActivities)[a]:void 0,dc:i,skill:l,modifier:n,modifierBreakdown:r,actor:this.actor,adjustDegreeOfSuccess:(0,m.cooperativeLeadership)((0,o.hasFeat)(this.kingdom,"Cooperative Leadership"),this.kingdom.level,this.kingdom.skillRanks[l],[...this.rollOptions]),rollOptions:this.rollOptions,creativeSolutionModifier:c,supernaturalSolutionModifier:d,rollType:"selected"});await this.onRoll(this.consumeModifiers),await this.afterRoll(f),await this.close()}))}createSelectableSkills(e){return Object.entries(e).map((([e,t])=>{const i=t.total.value,n=i>=0?`+${i}`:i;return{label:`${(0,c.capitalize)(e)} ${n}`,value:e}}))}createCustomModifiers(e){return Object.entries(e).flatMap((([e,t])=>[{value:t.bonus,type:e,name:(0,c.capitalize)(e)+" Bonus",enabled:!0},{value:-t.penalty,type:e,name:(0,c.capitalize)(e)+" Penalty",enabled:!0}]))}createModifiers(e){if(e){const t=e.total.value;return{total:t,totalLabel:t>=0?`+${t}`:t,assurance:e.total.assurance,modifiers:e.modifiers.map((e=>{const t=(0,c.capitalize)(e.type),i=this.modifierOverrides[e.id];return{name:e.name,type:e.value<0?`${t} Penalty`:`${t} Bonus`,value:e.value,enabled:e.enabled,override:void 0===i?"-":i?"enabled":"disabled",id:e.id,consumable:void 0!==e.consumeId&&this.consumeModifiers.has(e.consumeId)}}))}}}homogenize(e){return Object.fromEntries(Object.entries(e).map((([e,t])=>[e,{bonus:Math.abs(t.bonus),penalty:Math.abs(t.penalty)}])))}}t.CheckDialog=CheckDialog},7516:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.editSettlementDialog=void 0;const n=i(8593);t.editSettlementDialog=function(e,t,i,a){const s=!0===i.manualSettlementLevel||!e;new Dialog({title:`Edit Settlement: ${t}`,content:`\n        <form class="simple-dialog-form">\n            <div>\n                <label>Type</label>\n                <select name="type">\n                    <option value="capital" ${"capital"===i.type?"selected":""}>Capital</option>\n                    <option value="settlement" ${"settlement"===i.type?"selected":""}>Settlement</option>\n                </select>\n            </div>\n            <div ${s?"":"hidden"}>\n                <label>Occupied Blocks</label>\n                <input name="lots" type="number" value="${i.lots}">\n            </div>\n            <div ${s?"":"hidden"}>\n                <label>Level</label>\n                <input name="level" type="number" value="${i.level}">\n            </div>\n            <div>\n                <label>Water Borders</label>\n                <input name="waterBorders" type="number" value="${i.waterBorders}">\n            </div>\n            <div>\n                <label>Secondary Territory</label>\n                <input name="secondaryTerritory" type="checkbox" ${i.secondaryTerritory?"checked":""}>\n            </div>\n            <div>\n                <label>Manual Settlement Level (reopen dialog after saving)</label>\n                <input name="manualSettlementLevel" type="checkbox" ${!0===i.manualSettlementLevel?"checked":""}>\n            </div>\n        </form>\n        `,buttons:{save:{icon:'<i class="fa-solid fa-save"></i>',label:"Save",callback:async e=>{const t=e;a({level:(0,n.parseNumberInput)(t,"level"),secondaryTerritory:(0,n.parseCheckbox)(t,"secondaryTerritory"),type:(0,n.parseSelect)(t,"type"),lots:(0,n.parseNumberInput)(t,"lots"),waterBorders:(0,n.parseNumberInput)(t,"waterBorders"),sceneId:i.sceneId,manualSettlementLevel:(0,n.parseCheckbox)(t,"manualSettlementLevel")})}}},default:"save"},{jQuery:!1,width:580}).render(!0)}},1949:(e,t)=>{"use strict";function i(e){const t=document.createElement("form"),i=document.createElement("textarea");return i.name="json",i.innerHTML=e?JSON.stringify(e,null,2):"",t.appendChild(i),t.outerHTML}Object.defineProperty(t,"__esModule",{value:!0}),t.showStructureEditDialog=void 0,t.showStructureEditDialog=async function(e,t){const n=t.getFlag("pf2e-kingmaker-tools","structureData")??void 0;new Dialog({title:"Edit Structure Data",content:i(n),buttons:{roll:{icon:'<i class="fa-solid fa-save"></i>',label:"Save",callback:async e=>{const i=e.querySelector("textarea[name=json]"),n=""===i.value.trim()?null:JSON.parse(i.value);await t.unsetFlag("pf2e-kingmaker-tools","structureData"),await t.setFlag("pf2e-kingmaker-tools","structureData",n)}}},default:"roll"},{jQuery:!1}).render(!0,{width:400,classes:["edit-structure-json","kingmaker-tools-app"]})}},7732:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showKingdomSettings=void 0;const n=i(4310),a=i(8166),s=i(1252);class KingdomSettings extends FormApplication{game;onSave;data;actor;constructor(e){super(null,e),this.game=e.game,this.onSave=e.onSave,this.actor=e.sheetActor,this.data={companions:this.getCompanionBenefits(),allStructuresItemBonusesStack:(0,n.getBooleanSetting)(this.game,"kingdomAllStructureItemBonusesStack"),ignoreSkillRequirements:(0,n.getBooleanSetting)(this.game,"kingdomIgnoreSkillRequirements"),automaticallyCalculateArmyConsumption:(0,n.getBooleanSetting)(this.game,"autoCalculateArmyConsumption"),doubleSkillIncreases:(0,n.getBooleanSetting)(this.game,"kingdomSkillIncreaseEveryLevel"),rpToXpConversionLimit:(0,n.getNumberSetting)(this.game,"rpToXpConversionLimit"),rpToXPConversionRate:(0,n.getNumberSetting)(this.game,"rpToXpConversionRate"),untrainedSkillProficiency:this.getUntrainedProficiency(),vkXpRules:(0,n.getBooleanSetting)(this.game,"vanceAndKerensharaXP"),xpPerClaimedHex:(0,n.getNumberSetting)(this.game,"xpPerClaimedHex"),cultOfTheBloomEvents:(0,n.getBooleanSetting)(this.game,"cultOfTheBloomEvents"),autoCalculateSettlementLevel:(0,n.getBooleanSetting)(this.game,"autoCalculateSettlementLevel"),kingdomEventsTable:(0,n.getStringSetting)(this.game,"kingdomEventsTable"),kingdomCultTable:(0,n.getStringSetting)(this.game,"kingdomCultTable"),kingdomEventRollMode:(0,n.getStringSetting)(this.game,"kingdomEventRollMode"),capitalInvestmentInCapital:(0,n.getBooleanSetting)(this.game,"capitalInvestmentInCapital"),reduceDCToBuildLumberStructures:(0,n.getBooleanSetting)(this.game,"reduceDCToBuildLumberStructures"),automateResources:(0,n.getStringSetting)(this.game,"automateResources")}}getUntrainedProficiency(){return(0,n.getBooleanSetting)(this.game,"kingdomAlwaysAddLevel")?"level":(0,n.getBooleanSetting)(this.game,"kingdomAlwaysAddHalfLevel")?"halfLevel":"none"}static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-settings",e.title="Kingdom Settings",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/settings.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=[],e.height="auto",e.width=600,e}getData(){return this.data}getCompanionBenefits(){const e=new Set((0,n.getStringArraySetting)(this.game,"forceEnabledCompanionLeadershipBenefits").filter(a.isCompanionName));return{amiri:e.has("Amiri"),ekunday:e.has("Ekundayo"),harrim:e.has("Harrim"),jaethal:e.has("Jaethal"),jubilost:e.has("Jubilost"),kalikke:e.has("Kalikke"),kanerah:e.has("Kanerah"),linzi:e.has("Linzi"),noknok:e.has("Nok-Nok"),octavia:e.has("Octavia"),regongar:e.has("Regongar"),tristian:e.has("Tristian"),valerie:e.has("Valerie")}}async _updateObject(e,t){this.data={...this.data,...expandObject(t)},this.render(),console.log(this.data)}activateListeners(e){super.activateListeners(e);const t=e[0];t.querySelector(".save")?.addEventListener("click",(async()=>{await this.save(),await this.close(),this.onSave()}))}async save(){await(0,n.setSetting)(this.game,"forceEnabledCompanionLeadershipBenefits",[...this.data.companions.amiri?["Amiri"]:[],...this.data.companions.ekunday?["Ekundayo"]:[],...this.data.companions.harrim?["Harrim"]:[],...this.data.companions.jaethal?["Jaethal"]:[],...this.data.companions.jubilost?["Jubilost"]:[],...this.data.companions.kalikke?["Kalikke"]:[],...this.data.companions.kanerah?["Kanerah"]:[],...this.data.companions.linzi?["Linzi"]:[],...this.data.companions.noknok?["Nok-Nok"]:[],...this.data.companions.octavia?["Octavia"]:[],...this.data.companions.regongar?["Regongar"]:[],...this.data.companions.tristian?["Tristian"]:[],...this.data.companions.valerie?["Valerie"]:[]]),await(0,n.setSetting)(this.game,"kingdomAllStructureItemBonusesStack",this.data.allStructuresItemBonusesStack),await(0,n.setSetting)(this.game,"autoCalculateArmyConsumption",this.data.automaticallyCalculateArmyConsumption),await(0,n.setSetting)(this.game,"kingdomSkillIncreaseEveryLevel",this.data.doubleSkillIncreases),await(0,n.setSetting)(this.game,"rpToXpConversionLimit",this.data.rpToXpConversionLimit),await(0,n.setSetting)(this.game,"rpToXpConversionRate",this.data.rpToXPConversionRate),await(0,n.setSetting)(this.game,"vanceAndKerensharaXP",this.data.vkXpRules),await(0,n.setSetting)(this.game,"xpPerClaimedHex",this.data.xpPerClaimedHex),await(0,n.setSetting)(this.game,"cultOfTheBloomEvents",this.data.cultOfTheBloomEvents),await(0,n.setSetting)(this.game,"kingdomEventsTable",this.data.kingdomEventsTable),await(0,n.setSetting)(this.game,"kingdomCultTable",this.data.kingdomCultTable),await(0,n.setSetting)(this.game,"kingdomEventRollMode",this.data.kingdomEventRollMode),await(0,n.setSetting)(this.game,"kingdomIgnoreSkillRequirements",this.data.ignoreSkillRequirements),await(0,n.setSetting)(this.game,"autoCalculateSettlementLevel",this.data.autoCalculateSettlementLevel),await(0,n.setSetting)(this.game,"capitalInvestmentInCapital",this.data.capitalInvestmentInCapital),await(0,n.setSetting)(this.game,"reduceDCToBuildLumberStructures",this.data.reduceDCToBuildLumberStructures),await(0,n.setSetting)(this.game,"automateResources",this.data.automateResources),"level"===this.data.untrainedSkillProficiency?(await(0,n.setSetting)(this.game,"kingdomAlwaysAddLevel",!0),await(0,n.setSetting)(this.game,"kingdomAlwaysAddHalfLevel",!1)):"halfLevel"===this.data.untrainedSkillProficiency?(await(0,n.setSetting)(this.game,"kingdomAlwaysAddLevel",!1),await(0,n.setSetting)(this.game,"kingdomAlwaysAddHalfLevel",!0)):(await(0,n.setSetting)(this.game,"kingdomAlwaysAddLevel",!1),await(0,n.setSetting)(this.game,"kingdomAlwaysAddHalfLevel",!1)),this.data.automaticallyCalculateArmyConsumption&&await(0,s.updateKingdomArmyConsumption)({kingdomActor:this.actor,game:this.game,forceUpdate:!0})}}t.showKingdomSettings=function(e){new KingdomSettings(e).render(!0)}},267:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.kingdomSizeDialog=void 0;const n=i(1155),a=i(8593);class KingdomSizeDialog extends Application{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"modules/pf2e-kingmaker-tools/templates/kingdom/kingdom-size-help.hbs",classes:["dialog"],width:"auto",jQuery:!1})}getData(){return{data:n.kingdomSizeData.map((e=>({size:e.sizeFrom+(e.sizeTo?"-"+e.sizeTo:""),type:(0,a.capitalize)(e.type),dice:"1"+e.resourceDieSize,modifier:"+"+e.controlDCModifier,storage:e.commodityCapacity})))}}}t.kingdomSizeDialog=function(){(new KingdomSizeDialog).render(!0)}},5814:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.realmTileDialog=void 0;const n=i(8593);t.realmTileDialog=function(e){const t=e.canvas.drawings?.controlled?.map((e=>e.document))??[],i=e.canvas.tiles?.controlled?.map((e=>e.document))??[];if(0===t.length&&0===i.length)ui.notifications?.error("Please select drawings or tiles!");else{const e=t[0]?.getFlag("pf2e-kingmaker-tools","realmTile")??i[0]?.getFlag("pf2e-kingmaker-tools","realmTile");new Dialog({title:"Edit Selected Realm Tiles/Drawings",content:`\n        <form class="simple-dialog-form">\n            <div>\n                <label>Realm Tile Type</label>\n                <select name="type">\n                    <option value="-">-</option>\n                    <option value="mine" ${"mine"===e?.type?"selected":""}>Mine</option>\n                    <option value="ore" ${"ore"===e?.type?"selected":""}>Ore</option>\n                    <option value="lumber" ${"lumber"===e?.type?"selected":""}>Lumber</option>\n                    <option value="lumberCamp" ${"lumberCamp"===e?.type?"selected":""}>Lumber Camp</option>\n                    <option value="quarry" ${"quarry"===e?.type?"selected":""}>Quarry</option>\n                    <option value="stone" ${"stone"===e?.type?"selected":""}>Stone</option>\n                    <option value="luxury" ${"luxury"===e?.type?"selected":""}>Luxuries</option>\n                    <option value="luxuryWorksite" ${"luxuryWorksite"===e?.type?"selected":""}>Luxuries Worksite</option>\n                    <option value="farmland" ${"farmland"===e?.type?"selected":""}>Farmland</option>\n                    <option value="food" ${"food"===e?.type?"selected":""}>Food</option>\n                    <option value="claimed" ${"claimed"===e?.type?"selected":""}>Claimed Hex</option>\n                </select>\n            </div>\n        </form>\n        `,buttons:{save:{icon:'<i class="fa-solid fa-save"></i>',label:"Save",callback:async e=>{const a=e,s=(0,n.parseNullableSelect)(a,"type");void 0===s?(await Promise.all(t.map((e=>e.unsetFlag("pf2e-kingmaker-tools","realmTile")))),await Promise.all(i.map((e=>e.unsetFlag("pf2e-kingmaker-tools","realmTile"))))):(await Promise.all(t.map((e=>e.setFlag("pf2e-kingmaker-tools","realmTile",{type:s})))),await Promise.all(i.map((e=>e.setFlag("pf2e-kingmaker-tools","realmTile",{type:s})))))}}},default:"save"},{jQuery:!1,width:300}).render(!0)}}},3599:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.settlementSizeDialog=void 0;const n=i(9423);class SettlementSizeDialog extends Application{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"modules/pf2e-kingmaker-tools/templates/kingdom/settlement-size-help.hbs",classes:["dialog"],width:"auto",jQuery:!1})}getData(){return{data:n.settlementTypeData.map((e=>({type:e.type,blocks:e.maximumLots,population:e.population,level:e.levelFrom&&e.levelTo?e.levelFrom!==e.levelTo?e.levelFrom+"-"+e.levelTo:e.levelFrom:e.levelFrom+"+",consumption:e.consumption,maxItemBonus:"+"+e.maxItemBonus,influence:1===e.influence?"1 hex":e.influence+" hexes"})))}}}t.settlementSizeDialog=function(){(new SettlementSizeDialog).render(!0)}},6717:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showSettlement=void 0;const n=i(8593),a=i(9423),s=i(1155),r=i(3483),o=i(4310),l=i(943);class SettlementApp extends Application{kingdom;static get defaultOptions(){const e=super.defaultOptions;return e.id="settlement-app",e.title="Settlement",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/settlement.hbs",e.classes=["kingmaker-tools-app","settlement-app"],e.width=400,e.height="auto",e}game;settlementId;nav="status";constructor(e){super(e),this.game=e.game,this.settlementId=e.settlementId,this.kingdom=e.kingdom}async getData(){const e=(0,r.getSettlement)(this.game,this.kingdom,this.settlementId),t=(0,r.getCapitalSettlement)(this.game,this.kingdom),i=(0,r.getStructureStackMode)(this.game),a=(0,o.getBooleanSetting)(this.game,"autoCalculateSettlementLevel"),s=(0,l.getKingdomActivitiesById)(this.kingdom.homebrewActivities),c=(0,r.getStructureResult)(i,a,s,e,t),u=await this.getBuiltStructures(e),m=this.getStorage(c),d=(0,r.getSettlementInfo)(e,a),h=this.getSkillBonuses(c.skillBonuses),f=c.notes.length>0,p=Object.keys(m).length>0,g=h.map((e=>e.value>0||e.actions.some((e=>e.value>0)))),y=u.length>0;return"effects"!==this.nav||f||(this.nav="status"),"storage"!==this.nav||p||(this.nav="status"),"bonuses"!==this.nav||g||(this.nav="status"),"buildings"!==this.nav||y||(this.nav="status"),{name:e.scene.name,type:(0,n.capitalize)(e.settlement.type),secondaryTerritory:e.settlement.secondaryTerritory,hasBridge:c.hasBridge,waterBorders:e.settlement.waterBorders,...d,...this.getActiveTabs(),config:c.config,builtStructures:u,hasStorage:p,hasEffects:f,hasBonuses:g,hasBuildings:y,overcrowded:d.lots>c.residentialLots,residentialLots:c.residentialLots,consumption:c.consumption,consumptionSurplus:c.consumptionSurplus,capitalInvestmentPossible:c.allowCapitalInvestment?"yes":"no",settlementEventBonus:c.settlementEventBonus,leadershipActivityBonus:c.leadershipActivityBonus,notes:c.notes,leadershipActivities:c.increaseLeadershipActivities?3:2,availableItems:this.getAvailableItems(d.level,c.itemLevelBonuses),storage:m,skillItemBonuses:h}}sceneChange(){this.render()}activateListeners(e){super.activateListeners(e),Hooks.on("createToken",this.sceneChange.bind(this)),Hooks.on("sightRefresh",this.sceneChange.bind(this)),Hooks.on("deleteToken",this.sceneChange.bind(this));const t=e[0];t.querySelectorAll(".km-nav a")?.forEach((e=>{e.addEventListener("click",(e=>{const t=e.currentTarget;this.nav=t.dataset.tab,this.render()}))}))}close(e){return Hooks.off("createToken",this.sceneChange),Hooks.off("sightRefresh",this.sceneChange),Hooks.off("deleteToken",this.sceneChange),super.close(e)}getAvailableItems(e,t){const i=(0,s.hasFeat)(this.kingdom,"Quality of Life")?1:0,n=(0,a.calculateAvailableItems)(t,e,i),r=(0,a.groupAvailableItems)(n);return Array.from(Object.entries(r)).map((([e,t])=>({label:c[e],value:t})))}getStorage(e){return Object.entries(e.storage).filter((([,e])=>e>0)).map((([e,t])=>({label:(0,n.capitalize)(e),value:t})))}getSkillBonuses(e){return Object.entries(e).filter((([,e])=>e.value>0||e.activities&&Object.keys(e.activities).length>0)).map((([e,t])=>({label:(0,n.capitalize)(e),value:t.value,actions:Object.entries(t.activities).map((([e,t])=>({label:(0,n.unslugify)(e),value:t})))})))}async getBuiltStructures(e){const t=(0,r.getSceneActorStructures)(e.scene),i=(0,a.countStructureOccurrences)(t);return await Promise.all(Array.from(i.entries()).sort((([e],[t])=>e.localeCompare(t))).map((([,e])=>[e.item,e.count])).map((async([e,t])=>({link:await TextEditor.enrichHTML((0,n.createUUIDLink)(e.actor.uuid,e.name)),occurrences:t}))))}getActiveTabs(){return{statusTab:"status"===this.nav,bonusesTab:"bonuses"===this.nav,effectsTab:"effects"===this.nav,shoppingTab:"shopping"===this.nav,buildingsTab:"buildings"===this.nav,storageTab:"storage"===this.nav}}}t.showSettlement=async function(e,t,i){new SettlementApp({game:e,settlementId:t,kingdom:i}).render(!0)};const c={alchemical:"Alchemical",magical:"Magical",luxuryMagical:"Magical (Luxury)",arcane:"Arcane",luxuryArcane:"Arcane (Luxury)",divine:"Divine",luxuryDivine:"Divine (Luxury)",occult:"Occult",luxuryOccult:"Occult (Luxury)",primal:"Primal",luxuryPrimal:"Primal (Luxury)",other:"Other"}},282:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupDialog=void 0,t.setupDialog=function(e,t,i,n){new Dialog({title:`${t} Sheet Setup`,content:`\n        <p>No ${t} Sheet found! Click "Import" which creates an NPC actor called "${t} Sheet" which will be used to store your data. Adjust permissions as usual to give your players access</p>\n        `,buttons:{importSheet:{icon:'<i class="fa-solid fa-plus"></i>',label:"Import",callback:async()=>{const t=e.packs.get("pf2e-kingmaker-tools.kingmaker-tools-sheets");await(e?.actors?.importFromCompendium(t,i)),n()}}},default:"importSheet"},{jQuery:!1,width:380}).render(!0)}},5849:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showHelpDialog=void 0;const n=i(943),a=i(8593),s=i(6362),r=i(357),o=i(7066);class HelpApplication extends Application{activity;game;actor;static get defaultOptions(){const e=super.defaultOptions;return e.id="help-app",e.title="Help",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/help.hbs",e.classes=["kingmaker-tools-app","help-app"],e.width=500,e.height="auto",e}constructor(e){super(e),this.activity=e.activity,this.game=e.game,this.actor=e.actor}async getData(){const e=(0,o.getKingdom)(this.actor),t=(0,n.getKingdomActivitiesById)(e.homebrewActivities)[this.activity],i=(t.fortune?[(0,a.capitalize)(t.phase),"Downtime","Fortune"]:[(0,a.capitalize)(t.phase),"Downtime"]).join(", "),r=Object.entries(t.skills).map((([e,t])=>0===t?(0,a.capitalize)(e):`${(0,a.capitalize)(e)}: ${(0,s.rankToLabel)(t)}`)).join(", ");return{...t,criticalSuccess:await this.enrichIfDefined(t.criticalSuccess?.msg),success:await this.enrichIfDefined(t.success?.msg),failure:await this.enrichIfDefined(t.failure?.msg),criticalFailure:await this.enrichIfDefined(t.criticalFailure?.msg),description:await this.enrichIfDefined(t.description),requirement:await this.enrichIfDefined(t.requirement),companion:await this.enrichIfDefined(t.companion),title:t.title,special:t.special,traits:i,skills:r}}activateListeners(e){super.activateListeners(e);const t=e[0];t.querySelector("#km-close-help")?.addEventListener("click",(async()=>{await this.close()})),t.querySelectorAll(".km-gain-lose")?.forEach((e=>{e.addEventListener("click",(async e=>{e.preventDefault();const t=e.currentTarget;await(0,r.updateResources)(this.game,this.actor,t)}))})),t.querySelectorAll("[data-pf2-check]")?.forEach((e=>{e.addEventListener("click",(async e=>{e.preventDefault();const t=e.currentTarget.dataset.pf2Dc??1,i=this.game,n=new i.pf2e.CheckModifier("Flat Check",{modifiers:[]});await i.pf2e.Check.roll(n,{type:"flat-check",dc:{value:t}})}))}))}async enrichIfDefined(e){if(e){const t={async:!0};return await TextEditor.enrichHTML(e,t)}}}t.showHelpDialog=async function(e,t,i){new HelpApplication({activity:i,actor:t,game:e}).render(!0)}},3951:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showStructureBrowser=t.payStructure=t.parsePayButton=void 0;const n=i(8593),a=i(6362),s=i(3012),r=i(4310),o=i(7066),l=i(8063),c=i(3483);function u(e,t){return void 0===e.construction?.skills||0===e.construction.skills.length||e.construction.skills.some((e=>t.skillRanks[e.skill]>=(e.proficiencyRank??0)))}function m(e,t){return(e.construction?.rp??0)<=t.resourcePoints.now}function d(e,t){return(e.construction?.lumber??0)<=t.commodities.now.lumber}function h(e,t){return(e.construction?.ore??0)<=t.commodities.now.ore}function f(e,t){return(e.construction?.stone??0)<=t.commodities.now.stone}function p(e,t){return(e.construction?.luxuries??0)<=t.commodities.now.luxuries}class StructureBrowserApp extends FormApplication{level;structureActors;kingdom;static get defaultOptions(){const e=super.defaultOptions;return e.id="structure-browser-app",e.title="Structure Browser",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/structure-browser.hbs",e.classes=["kingmaker-tools-app","structure-browser-app"],e.width=960,e.height=600,e.height="auto",e.submitOnChange=!0,e.closeOnSubmit=!1,e.scrollY=["#km-structure-browser-content","#km-structure-browser-sidebar"],e}game;filters;sheetActor;onRoll;constructor(e){super(null,e),this.game=e.game,this.level=e.kingdom.level,this.structureActors=e.structureActors,this.kingdom=e.kingdom,this.sheetActor=e.sheetActor,this.onRoll=e.onRoll}async resetFilters(){const e=function(e){return Array.from(new Set(e.flatMap((e=>Array.from(g(e)))))).sort(((e,t)=>e.localeCompare(t)))}((0,c.getStructuresFromActors)(this.structureActors));return{search:"",reducesUnrest:!1,housing:!1,affectsDowntime:!1,affectsEvents:!1,items:!1,storage:!1,consumption:!1,reducesRuin:!1,upgradeFrom:!1,upgradeTo:!1,infrastructure:!1,ignoreProficiencyRequirements:!1,ignoreStructureCost:!1,lots:4,activities:Object.fromEntries(e.map((e=>[e,{name:(0,n.unslugify)(e),enabled:!1}]))),level:this.level}}async getData(){this.kingdom=(0,o.getKingdom)(this.sheetActor),void 0===this.filters&&(this.filters=await this.resetFilters());const e=(0,c.getStructuresFromActors)(this.structureActors).filter((e=>"Rubble"!==e.name)),t=this.filterStructures(e,this.filters),i=await this.toViewStructures(t);return{...this.filters,structures:i,activities:this.filters.activities,noStructures:0===e.length}}activateListeners(e){super.activateListeners(e);const t=e[0];(0,n.listenClick)(t,"#km-structure-browser-clear",(async()=>{this.filters=void 0,this.render()})),t.querySelectorAll(".km-structure-link").forEach((e=>e.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const t=e.currentTarget.dataset.uuid,i=await fromUuid(t);i?.sheet?.render(!0)})))),t.querySelectorAll(".km-build-structure-dialog").forEach((e=>e.addEventListener("click",(e=>this.buildStructure(e)))))}filterStructures(e,t){const i=[];return t.storage&&i.push((e=>void 0!==e.storage)),t.affectsEvents&&i.push((e=>!0===e.affectsEvents)),t.affectsDowntime&&i.push((e=>!0===e.affectsDowntime)),t.housing&&i.push((e=>!0===e.traits?.includes("residential"))),t.infrastructure&&i.push((e=>!0===e.traits?.includes("infrastructure"))),t.reducesUnrest&&i.push((e=>!0===e.reducesUnrest)),t.reducesRuin&&i.push((e=>!0===e.reducesRuin)),t.consumption&&i.push((e=>void 0!==e.consumptionReduction&&e.consumptionReduction>0)),t.items&&i.push((e=>void 0!==e.availableItemsRules&&e.availableItemsRules.length>0)),t.upgradeFrom&&i.push((e=>void 0!==e.upgradeFrom&&e.upgradeFrom.length>0)),t.upgradeTo&&i.push((t=>this.hasUpgradeTo(t,e))),t.ignoreProficiencyRequirements||i.push((e=>u(e,this.kingdom))),t.ignoreStructureCost||i.push((e=>{return t=e,i=this.kingdom,d(t,i)&&m(t,i)&&p(t,i)&&h(t,i)&&f(t,i);var t,i})),(0,n.isBlank)(t.search)||i.push((e=>e.name.toLowerCase().includes(t.search.trim().toLowerCase()))),i.push((e=>function(e,t){const i=g(e),n=Array.from(Object.entries(t)).filter((([,e])=>e?.enabled)).map((([e])=>e));return 0===n.length||n.every((e=>i.has(e)))}(e,t.activities))),i.push((e=>(e.level??0)<=t.level)),i.push((e=>(e.lots??0)<=t.lots)),e.filter((e=>i.every((t=>t(e))))).sort(((e,t)=>e.name.localeCompare(t.name)))}async toViewStructures(e){return await Promise.all(e.map((async e=>{const t=await TextEditor.enrichHTML((0,n.createUUIDLink)(e.actor.uuid,e.name)),i=!u(e,this.kingdom);return{link:t,name:e.name,uuid:e.actor.uuid,dc:this.getStructureDC(e),skills:e.construction?.skills.map((e=>{const t=e.proficiencyRank?" ("+(0,a.rankToLabel)(e.proficiencyRank)+")":"";return(0,n.unslugify)(e.skill)+t}))??[],lacksProficiency:i,disableBuild:i&&!(0,r.getBooleanSetting)(this.game,"kingdomIgnoreSkillRequirements"),lumber:e.construction?.lumber,ore:e.construction?.ore,stone:e.construction?.stone,luxuries:e.construction?.luxuries,rp:e.construction?.rp,insufficientStone:!f(e,this.kingdom),insufficientLumber:!d(e,this.kingdom),insufficientRp:!m(e,this.kingdom),insufficientLuxuries:!p(e,this.kingdom),insufficientOre:!h(e,this.kingdom),lots:0===e.lots?void 0:e.lots,id:e.actor.id,img:e.actor.img}})))}getStructureDC(e){const t=(0,r.getBooleanSetting)(this.game,"reduceDCToBuildLumberStructures")&&(e.construction?.lumber??0)>0?-2:0,i=e.construction?.dc;return void 0===i?void 0:i+t}async _updateObject(e,t){console.log(t),this.filters={search:t.search,housing:t.housing,affectsDowntime:t.affectsDowntime,affectsEvents:t.affectsEvents,items:t.items,storage:t.storage,consumption:t.consumption,reducesRuin:t.reducesRuin,reducesUnrest:t.reducesUnrest,infrastructure:t.infrastructure,upgradeFrom:t.upgradeFrom,upgradeTo:t.upgradeTo,ignoreStructureCost:t.ignoreStructureCost,ignoreProficiencyRequirements:t.ignoreProficiencyRequirements,level:t.level,lots:t.lots,activities:Object.fromEntries(Object.keys(t).filter((e=>e.startsWith("activity-"))).map((e=>e.replace("activity-",""))).map((e=>[e,{name:(0,n.unslugify)(e),enabled:t["activity-"+e]}])))},this.render()}async buildStructure(e){const t=e.currentTarget.dataset.id,i=(0,c.getStructuresFromActors)(this.structureActors).find((e=>e.actor.id===t));if(i){const e=i.construction?.skills?.map((e=>[e.skill,e.proficiencyRank??0]));new s.CheckDialog(null,{activity:"build-structure",kingdom:this.kingdom,dc:this.getStructureDC(i),overrideSkills:void 0===e?void 0:Object.fromEntries(e),game:this.game,type:"activity",onRoll:this.onRoll,actor:this.sheetActor,afterRoll:async e=>{await this.payStructure(i,e),await this.close()}}).render(!0)}}async getPaymentChatData(e,t){const i=(0,c.getStructuresFromActors)(this.structureActors),a=e.upgradeFrom?.map((e=>i.find((t=>t.actor.name===e))))?.filter((e=>(0,n.isNonNullable)(e)))??[],s=t===l.DegreeOfSuccess.CRITICAL_SUCCESS?"half":"full",r=a.map((t=>{const i={rp:Math.max(0,(e.construction?.rp??0)-(t.construction?.rp??0)),lumber:Math.max(0,(e.construction?.lumber??0)-(t.construction?.lumber??0)),stone:Math.max(0,(e.construction?.stone??0)-(t.construction?.stone??0)),ore:Math.max(0,(e.construction?.ore??0)-(t.construction?.ore??0)),luxuries:Math.max(0,(e.construction?.luxuries??0)-(t.construction?.luxuries??0))};return{name:t.name,costs:v(i,s)}})),o=v(e.construction??{},s),u=t===l.DegreeOfSuccess.CRITICAL_FAILURE?i.find((e=>"Rubble"===e.actor.name))?.actor:e?.actor;return{structureLink:u?await TextEditor.enrichHTML((0,n.createUUIDLink)(u.uuid,u.name)):void 0,costs:o,upgradeCosts:r}}async payStructure(e,t){const{structureLink:i,costs:a,upgradeCosts:s}=await this.getPaymentChatData(e,t),r=s.map((e=>`<p><b>Upgrade from ${(0,n.escapeHtml)(e.name)}:</b></p>`+y(e.costs))).join(""),o=`<h3>Constructing ${(0,n.escapeHtml)(e.name)}</h3>`,c="<p><b>Build Directly:</b></p>"+y(a),u=t===l.DegreeOfSuccess.FAILURE?" and apply the @UUID[Compendium.pf2e.conditionitems.Item.xYTAsEpcJE1Ccni3]{Slowed} condition to signal that the structure is under construction":"",m=i?`<p><b>Drag onto scene to build${u}:</b></p><p>${i}</p>`:"";await ChatMessage.create({content:o+r+c+m})}hasUpgradeTo(e,t){return t.some((t=>t.upgradeFrom?.includes(e.name)??!1))}}function g(e){const t=e.activityBonusRules?.map((e=>e.activity))??[],i=e.skillBonusRules?.filter((e=>void 0!==e.activity))?.map((e=>e.activity))??[];return new Set([...t,...i])}function y(e){return`<button type="button" \n                data-rp="${e.rp}" \n                data-lumber="${e.lumber}"\n                data-luxuries="${e.luxuries}"\n                data-stone="${e.stone}"\n                data-ore="${e.ore}"\n                class="km-pay-structure"><b>Pay</b>: ${b(e)}</button>`}function v(e,t){const i={rp:e.rp??0,ore:e.ore??0,lumber:e.lumber??0,luxuries:e.luxuries??0,stone:e.stone??0};return"full"===t?i:{rp:i.rp,ore:Math.ceil(i.ore/2),lumber:Math.ceil(i.lumber/2),luxuries:Math.ceil(i.luxuries/2),stone:Math.ceil(i.stone/2)}}function b(e){return Object.entries(e).filter((([,e])=>e>0)).map((([e,t])=>`${(0,n.capitalize)(e)}: ${t}`)).join(", ")}t.parsePayButton=function(e){return{rp:parseInt(e.dataset.rp??"0",10),lumber:parseInt(e.dataset.lumber??"0",10),luxuries:parseInt(e.dataset.luxuries??"0",10),stone:parseInt(e.dataset.stone??"0",10),ore:parseInt(e.dataset.ore??"0",10)}},t.payStructure=async function(e,t){const i=(0,o.getKingdom)(e);await(0,o.saveKingdom)(e,{commodities:{...i.commodities,now:{...i.commodities.now,ore:Math.max(0,i.commodities.now.ore-t.ore),lumber:Math.max(0,i.commodities.now.lumber-t.lumber),luxuries:Math.max(0,i.commodities.now.luxuries-t.luxuries),stone:Math.max(0,i.commodities.now.stone-t.stone)}},resourcePoints:{...i.resourcePoints,now:Math.max(0,i.resourcePoints.now-t.rp)}}),await ChatMessage.create({content:`<b>Paid:</b> ${b(t)}`})},t.showStructureBrowser=async function(e,t,i,n,a){new StructureBrowserApp({game:e,structureActors:t,kingdom:i,sheetActor:n,onRoll:a}).render(!0)}},6326:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.structureTokenMappingDialog=void 0;const n=i(3483),a=i(8593),s=[{name:"Academy",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/academy.webp"},{name:"Alchemy Laboratory",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/alchemy-laboratory.webp"},{name:"Arcanist's Tower",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/arcanists-tower.webp"},{name:"Arena",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/arena.webp"},{name:"Bank",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/bank.webp"},{name:"Bank (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/bank.webp"},{name:"Barracks",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/barracks.webp"},{name:"Brewery",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/brewery.webp"},{name:"Bridge",img:"pf2e-kingmaker-tools-tokens/structures/Bridge.webp"},{name:"Bridge, Stone",img:"pf2e-kingmaker-tools-tokens/structures/Bridge.webp"},{name:"Castle",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/castle.webp"},{name:"Castle (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/castle.webp"},{name:"Cathedral",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/cathedral.webp"},{name:"Cemetary",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/cemetery.webp"},{name:"Construction Yard",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/construction-yard.webp"},{name:"Construction Yard (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/construction-yard.webp"},{name:"Dump",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/dump.webp"},{name:"Embassy",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/embassy.webp"},{name:"Festival Hall",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/festival-hall.webp"},{name:"Festival Hall (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/festival-hall.webp"},{name:"Foundry",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/foundry.webp"},{name:"Garrison",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/garrison.webp"},{name:"Garrison (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/garrison.webp"},{name:"General Store",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/general-store.webp"},{name:"Gladiatorial Arena",img:"pf2e-kingmaker-tools-tokens/structures/Gladiatorial%20Arena.webp"},{name:"Granary",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/granary.webp"},{name:"Granary (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/granary.webp"},{name:"Guildhall",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/guildhall.webp"},{name:"Herbalist",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/herbalist.webp"},{name:"Hospital",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/hospital.webp"},{name:"Houses",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/houses.webp"},{name:"Illicit Market",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/illicit-market.webp"},{name:"Inn",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/inn.webp"},{name:"Inn (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/inn.webp"},{name:"Jail",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/jail.webp"},{name:"Keep",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/keep.webp"},{name:"Library",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/library.webp"},{name:"Library (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/library.webp"},{name:"Lumberyard",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/lumberyard.webp"},{name:"Luxury Store",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/luxury-store.webp"},{name:"Magic Shop",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/magic-shop.webp"},{name:"Magic Shop (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/magic-shop.webp"},{name:"Magical Streetlamps",img:"pf2e-kingmaker-tools-tokens/structures/Magical%20Streetlamps.webp"},{name:"Mansion",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/mansion.webp"},{name:"Marketplace",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/marketplace.webp"},{name:"Menagerie",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/menagerie.webp"},{name:"Military Academy",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/military-academy.webp"},{name:"Mill",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/mill.webp"},{name:"Mint",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/mint.webp"},{name:"Monument",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/monument.webp"},{name:"Monument (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/monument.webp"},{name:"Museum",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/museum.webp"},{name:"Noble Villa",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/noble-villa.webp"},{name:"Occult Shop",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/occult-shop.webp"},{name:"Occult Shop (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/occult-shop.webp"},{name:"Opera House",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/opera-house.webp"},{name:"Orphanage",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/orphanage.webp"},{name:"Palace",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/palace.webp"},{name:"Palace (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/palace.webp"},{name:"Park",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/park.webp"},{name:"Paved Streets",img:"pf2e-kingmaker-tools-tokens/structures/Paved%20Streets.webp"},{name:"Pier",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/pier.webp"},{name:"Printing House",img:"pf2e-kingmaker-tools-tokens/structures/Printing%20Press.webp"},{name:"Rubble",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/rubble.webp"},{name:"Sacred Grove",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/sacred-grove.webp"},{name:"Secure Warehouse",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/secure-warehouse.webp"},{name:"Sewer System",img:"pf2e-kingmaker-tools-tokens/structures/Sewer%20System.webp"},{name:"Shrine",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/shrine.webp"},{name:"Smithy",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/smithy.webp"},{name:"Smithy (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/smithy.webp"},{name:"Specialized Artisan",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/special-artisan.webp"},{name:"Stable",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/stable.webp"},{name:"Stockyard",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/stockyard.webp"},{name:"Stonemason",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/stonemason.webp"},{name:"Tannery",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tannery.webp"},{name:"Tavern, Dive",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-dive.webp"},{name:"Tavern, Dive (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-dive.webp"},{name:"Tavern, Luxury",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-luxury.webp"},{name:"Tavern, Luxury (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-luxury.webp"},{name:"Tavern, Popular",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-popular.webp"},{name:"Tavern, Popular (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-popular.webp"},{name:"Tavern, World-Class",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-worldclass.webp"},{name:"Tavern, World-Class (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-worldclass.webp"},{name:"Temple",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/temple.webp"},{name:"Tenement",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tenement.webp"},{name:"Theater",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/theatre.webp"},{name:"Thieves' Guild",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/thieves-guild.webp"},{name:"Town Hall",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/town-hall.webp"},{name:"Town Hall (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/town-hall.webp"},{name:"Trade Shop",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/trade-shop.webp"},{name:"University",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/university.webp"},{name:"Wall, Stone",img:"pf2e-kingmaker-tools-tokens/structures/Wall%2C%20Stone.webp"},{name:"Wall, Wooden",img:"pf2e-kingmaker-tools-tokens/structures/Wall%2C%20Wooden.webp"},{name:"Watchtower",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/watchtower.webp"},{name:"Watchtower, Stone",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/watchtower.webp"},{name:"Waterfront (Corner)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/waterfront.webp"},{name:"Waterfront (Side)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/waterfront-2.webp"}],r=[{name:"Academy",img:"structures/Academy.webp"},{name:"Alchemy Laboratory",img:"structures/Alchemy%20Laboratory.webp"},{name:"Arcanist's Tower",img:"structures/Arcanist%20Tower.webp"},{name:"Arena",img:"structures/Arena.webp"},{name:"Bank",img:"structures/Bank.webp"},{name:"Bank (V&K)",img:"structures/Bank.webp"},{name:"Barracks",img:"structures/Barracks.webp"},{name:"Brewery",img:"structures/Brewery.webp"},{name:"Bridge",img:"structures/Bridge.webp"},{name:"Bridge, Stone",img:"structures/Bridge.webp"},{name:"Castle",img:"structures/Castle.webp"},{name:"Castle (V&K)",img:"structures/Castle.webp"},{name:"Cathedral",img:"structures/Cathedral.webp"},{name:"Cemetary",img:"structures/Cemetery.webp"},{name:"Construction Yard",img:"structures/Construction%20Yard.webp"},{name:"Construction Yard (V&K)",img:"structures/Construction%20Yard.webp"},{name:"Dump",img:"structures/Dump.webp"},{name:"Embassy",img:"structures/Embassy.webp"},{name:"Festival Hall",img:"structures/Festival%20Hall.webp"},{name:"Festival Hall (V&K)",img:"structures/Festival%20Hall.webp"},{name:"Foundry",img:"structures/Foundry.webp"},{name:"Garrison",img:"structures/Garrison.webp"},{name:"Garrison (V&K)",img:"structures/Garrison.webp"},{name:"General Store",img:"structures/General%20Store.webp"},{name:"Gladiatorial Arena",img:"structures/Gladiatorial%20Arena.webp"},{name:"Granary",img:"structures/Granary.webp"},{name:"Granary (V&K)",img:"structures/Granary.webp"},{name:"Guildhall",img:"structures/Guildhall.webp"},{name:"Herbalist",img:"structures/Herbalist.webp"},{name:"Hospital",img:"structures/Hospital.webp"},{name:"Houses",img:"structures/Houses.webp"},{name:"Illicit Market",img:"structures/Illicit%20Market.webp"},{name:"Inn",img:"structures/Inn.webp"},{name:"Inn (V&K)",img:"structures/Inn.webp"},{name:"Jail",img:"structures/Jail.webp"},{name:"Keep",img:"structures/Keep.webp"},{name:"Library",img:"structures/Library.webp"},{name:"Library (V&K)",img:"structures/Library.webp"},{name:"Lumberyard",img:"structures/Lumberyard.webp"},{name:"Luxury Store",img:"structures/Luxury%20Store.webp"},{name:"Magic Shop",img:"structures/Magic%20Shop.webp"},{name:"Magic Shop (V&K)",img:"structures/Magic%20Shop.webp"},{name:"Magical Streetlamps",img:"structures/Magical%20Streetlamps.webp"},{name:"Mansion",img:"structures/Mansion.webp"},{name:"Marketplace",img:"structures/Marketplace.webp"},{name:"Menagerie",img:"structures/Menagerie.webp"},{name:"Military Academy",img:"structures/Military%20Academy.webp"},{name:"Mill",img:"structures/Mill.webp"},{name:"Mint",img:"structures/Mint.webp"},{name:"Monument",img:"structures/Monument.webp"},{name:"Monument (V&K)",img:"structures/Monument.webp"},{name:"Museum",img:"structures/Museum.webp"},{name:"Noble Villa",img:"structures/Noble%20Villa.webp"},{name:"Occult Shop",img:"structures/Occult%20Shop.webp"},{name:"Occult Shop (V&K)",img:"structures/Occult%20Shop.webp"},{name:"Opera House",img:"structures/Opera%20House.webp"},{name:"Orphanage",img:"structures/Orphanage.webp"},{name:"Palace",img:"structures/Palace.webp"},{name:"Palace (V&K)",img:"structures/Palace.webp"},{name:"Park",img:"structures/Park.webp"},{name:"Paved Streets",img:"structures/Paved%20Streets.webp"},{name:"Pier",img:"structures/Pier.webp"},{name:"Printing House",img:"structures/Printing%20Press.webp"},{name:"Rubble",img:"structures/Rubble.webp"},{name:"Sacred Grove",img:"structures/Sacred%20Grove.webp"},{name:"Secure Warehouse",img:"structures/Secure%20Warehouse.webp"},{name:"Sewer System",img:"structures/Sewer%20System.webp"},{name:"Shrine",img:"structures/Shrine.webp"},{name:"Smithy",img:"structures/Smithy.webp"},{name:"Smithy (V&K)",img:"structures/Smithy.webp"},{name:"Specialized Artisan",img:"structures/Special%20Artisan.webp"},{name:"Stable",img:"structures/Stable.webp"},{name:"Stockyard",img:"structures/Stockyard.webp"},{name:"Stonemason",img:"structures/Stonemason.webp"},{name:"Tannery",img:"structures/Tannery.webp"},{name:"Tavern, Dive",img:"structures/Tavern%2C%20Dive.webp"},{name:"Tavern, Dive (V&K)",img:"structures/Tavern%2C%20Dive.webp"},{name:"Tavern, Luxury",img:"structures/Tavern%2C%20Luxury.webp"},{name:"Tavern, Luxury (V&K)",img:"structures/Tavern%2C%20Luxury.webp"},{name:"Tavern, Popular",img:"structures/Tavern%2C%20Popular.webp"},{name:"Tavern, Popular (V&K)",img:"structures/Tavern%2C%20Popular.webp"},{name:"Tavern, World-Class",img:"structures/Tavern%2C%20World%20Class.webp"},{name:"Tavern, World-Class (V&K)",img:"structures/Tavern%2C%20World%20Class.webp"},{name:"Temple",img:"structures/Temple.webp"},{name:"Tenement",img:"structures/Tenement.webp"},{name:"Theater",img:"structures/Theater.webp"},{name:"Thieves' Guild",img:"structures/Thieves%20Guild.webp"},{name:"Town Hall",img:"structures/Town%20Hall.webp"},{name:"Town Hall (V&K)",img:"structures/Town%20Hall.webp"},{name:"Trade Shop",img:"structures/Trade%20Shop.webp"},{name:"University",img:"structures/University.webp"},{name:"Wall, Stone",img:"structures/Wall%2C%20Stone.webp"},{name:"Wall, Wooden",img:"structures/Wall%2C%20Wooden.webp"},{name:"Watchtower",img:"structures/Watchtower.webp"},{name:"Watchtower, Stone",img:"structures/Watchtower.webp"},{name:"Waterfront (Corner)",img:"structures/Waterfront%20(Corner).webp"},{name:"Waterfront (Side)",img:"structures/Waterfront%20(Side).webp"}];async function o(e,t){const i=(0,a.groupBy)(t,(e=>e.name));await Promise.all(e.map((async e=>{const t=i.get(e.name??"")?.[0];if(t){const i=t.img;await e.update({"prototypeToken.texture.src":i,img:i})}})))}function l(e="pf2e-kingmaker-tools-tokens/"){return r.map((t=>({name:t.name,img:e+t.img})))}t.structureTokenMappingDialog=async function(e){const t=e.actors?.filter((e=>(0,n.isStructureActor)(e)))??[],i=await TextEditor.enrichHTML((0,a.createUUIDLink)("Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.iAQCUYEAq4Dy8uCY","Kingmaker Tools Manual"));new Dialog({title:"Change Structure Token Images",content:`\n        <p>Run this macro to change all images of imported structures. The <b>Unofficial Module</b> mapping will use the folder structure described in the ${i} Tokens section.</p> \n        <p>You can change the base directory from <b>pf2e-kingmaker-tools-tokens/</b> to a different folder by adding a different value in the Custom Directory input. That way you can make use of token modules which offers tokens organized in the same folder structure as the Unofficial Module.</p>\n        <form class="simple-dialog-form">\n            <div>\n                <label for="km-token-mapping-official">Official Module</label>\n                <input type="radio" value="official" name="mapping" id="km-token-mapping-official" checked>\n            </div>\n            <div>\n                <label for="km-token-mapping-unofficial">Unofficial Module</label>\n                <input type="radio" value="unofficial" name="mapping" id="km-token-mapping-unofficial">\n            </div>\n            <div>\n                <label for="km-token-mapping-custom">Custom</label>\n                <input type="radio" value="custom" name="mapping" id="km-token-mapping-custom">\n            </div>\n            <div>\n                <label for="km-token-mapping-custom">Custom Directory</label>\n                <input type="text" name="customDirectory" placeholder="modules/token-module/img/">\n            </div>\n        </form>\n        `,buttons:{migrate:{icon:'<i class="fa-solid fa-save"></i>',label:"Migrate",callback:async e=>{const i=e,n=(0,a.parseRadio)(i,"mapping"),r=(0,a.parseTextInput)(i,"customDirectory");if("custom"===n)if((0,a.isBlank)(r))ui.notifications?.error("Custom Directory can not be empty!");else{const e=r.replace(/\/$/,"")+"/";await o(t,l(e))}else"official"===n?await o(t,s):"unofficial"===n&&await o(t,l())}}},default:"migrate"},{jQuery:!1,width:380}).render(!0)}},447:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gainFame=t.getConsumption=t.getCapacity=void 0;const n=i(1155),a=i(3483),s=i(8593),r=i(4310);t.getCapacity=function(e,t){const i=(0,r.getStringSetting)(e,"automateResources"),{size:s}=(0,a.getStolenLandsData)(e,i,t),o=(0,n.getSizeData)(s).commodityCapacity,{storage:l}=(0,a.getAllMergedSettlements)(e,t);return function(e,t){return{food:e+t.food,ore:e+t.ore,luxuries:e+t.luxuries,lumber:e+t.lumber,stone:e+t.stone}}(o,l)},t.getConsumption=function(e,t){const i=(0,a.getAllMergedSettlements)(e,t).settlementConsumption,n=(0,r.getStringSetting)(e,"automateResources"),s=(0,a.getStolenLandsData)(e,n,t).workSites.farmlands,o=s.resources+s.quantity,l=t.consumption.armies+t.consumption.now+i;return{current:Math.max(0,l-o),surplus:Math.max(0,o-l)}},t.gainFame=function(e,t){return{fame:{...e.fame,now:(0,s.clamped)(e.fame.now+t,0,3)}}}},6362:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createStructureModifiers=t.createRuinModifier=t.createUnrestModifier=t.createProficiencyModifier=t.proficiencyToRank=t.rankToProficiency=t.rankToLabel=t.createAbilityModifier=t.createInvestedModifier=t.createVacancyModifiers=t.processModifiers=t.createActiveSettlementModifiers=t.calculateModifiers=t.removeLowestModifiers=t.removePredicatedModifiers=t.removeUninterestingZeroModifiers=t.modifierToLabel=t.allModifierTypes=t.getUntrainedProficiencyMode=void 0;const n=i(8593),a=i(1155),s=i(4431),r=i(6013),o=i(2596),l=i(8166),c=i(324),u=i(9329),m=i(6334),d=i(4310);function h(e,t){return e?`${t}: ${e.map((e=>(0,n.unslugify)(e))).join(", ")}`:void 0}function f(e){return e.filter((e=>0!==e.value))}function p(e,t,i,n,a,s){return e.filter((e=>{const o=[];e.abilities&&o.push((e=>!0===e.abilities?.includes(r.skillAbilities[n]))),e.skills&&o.push((e=>!0===e.skills?.includes(n))),t&&e.phases&&o.push((e=>!0===e.phases?.includes(t))),i&&e.activities&&o.push((e=>!0===e.activities?.includes(i))),e.activities&&o.push((e=>e.activities.some((e=>{const t=s[e].skills[n];return void 0!==t&&t<=a}))));let l=!0;for(const t of o)l=l&&t(e);return l})).map((e=>{let n=e.enabled;return!t&&e.phases&&(n=!1),!i&&e.activities&&(n=!1),{...e,enabled:n}}))}function g(e){const t=(0,n.groupBy)(e,(e=>e.value>0?e.type:e.type+"-penalty")),i=[];for(const[e,n]of t.entries())if("untyped"===e||"untyped-penalty"===e)n.forEach((e=>i.push(e)));else{const e=Math.max(0,...n.filter((e=>e.enabled)).map((e=>Math.abs(e.value))));if(n.some((e=>e.enabled))){const t=n.find((t=>t.enabled&&Math.abs(t.value)===e));n.forEach((e=>{e.id!==t.id?i.push({...e,enabled:!1}):i.push(e)}))}else n.forEach((e=>i.push(e)))}return i}function y(e,t,i,n){return{name:t,value:-(i?e+1:e),phases:n?[n]:void 0,type:"vacancy",enabled:!0}}function v(e){return 0===e?"Untrained":1===e?"Trained":2===e?"Expert":3===e?"Master":"Legendary"}t.getUntrainedProficiencyMode=function(e){return(0,d.getBooleanSetting)(e,"kingdomAlwaysAddLevel")?"full":(0,d.getBooleanSetting)(e,"kingdomAlwaysAddHalfLevel")?"half":"none"},t.allModifierTypes=["ability","proficiency","item","status","circumstance","vacancy","untyped"],t.modifierToLabel=function(e){return`${e.value>=0?`+${e.value}`:`${e.value}`} ${e.value>=0?(0,n.capitalize)(e.type)+" Bonus":(0,n.capitalize)(e.type)+" Penalty"}${e.skills||e.abilities||e.activities||e.phases?" to: ":""}${[h(e.phases,"Phases"),h(e.activities,"Activities"),h(e.abilities,"Abilities"),h(e.skills,"Skills")].filter((e=>void 0!==e)).join("; ")}`},t.removeUninterestingZeroModifiers=f,t.removePredicatedModifiers=p,t.removeLowestModifiers=g,t.calculateModifiers=function(e){const t={item:{bonus:0,penalty:0},circumstance:{bonus:0,penalty:0},status:{bonus:0,penalty:0},ability:{bonus:0,penalty:0},proficiency:{bonus:0,penalty:0},untyped:{bonus:0,penalty:0},vacancyPenalty:0,value:0,assurance:10,rollOptions:[]},i=e.filter((e=>e.enabled&&0!==e.value));for(const e of i)if(e.rollOptions?.forEach((e=>t.rollOptions.push(e))),"vacancy"===e.type)t.vacancyPenalty=e.value;else{const i=t[e.type],n=e.value>0?"bonus":"penalty";"untyped"===e.type?i[n]+=e.value:i[n]=e.value}return t.assurance=10+i.filter((e=>"proficiency"===e.type&&(e.value>0||e.value<0))).map((e=>e.value)).reduce(((e,t)=>e+t),0),t.value=i.map((e=>e.value)).reduce(((e,t)=>e+t),0),t},t.createActiveSettlementModifiers=function(e,t,i,n){const r=(0,a.getLevelData)(e.level),o=new Set([...e.feats.map((e=>e.id)),...e.feats.map((e=>e.id))]),l=Array.from(o).flatMap((e=>s.allFeatsByName[e]?.modifiers??[]));e.modifiers.forEach((e=>l.push(e)));const c=t?.secondaryTerritory;n>0&&l.push({name:"Settlements Without Land Borders",value:-1*n,type:"item",skills:["trade"],enabled:!0}),c&&l.push({name:"Check in Secondary Territory",type:"circumstance",value:-4,enabled:!0}),e.level>=4&&l.push({name:"Expansion Expert",type:"circumstance",activities:["claim-hex"],value:2,enabled:!0});const u=i?.active.settlementEventBonus??0;u>0&&l.push({name:"Event Phase Structure Bonus",type:"circumstance",value:u,enabled:!0,phases:["event"]});const m=i?.merged.leadershipActivityBonus??0;return m>0&&l.push({name:"Ruler performs Leadership Activity",type:"item",value:m,enabled:!1,phases:["leadership"]}),l.push({name:"Invested, Non-Vacant Leader Handles Event",type:"circumstance",value:r.investedLeadershipBonus,enabled:!1,phases:["event"]}),l},t.processModifiers=function({modifiers:e,skill:t,rank:i,phase:n,activity:a,overrides:s={},activities:r}){return g(p(f(e.map(((e,t)=>({...deepClone(e),id:`${t}`})))),n,a,t,i,r).map((e=>{const t=s[e.id];return void 0===t?e:{...e,enabled:t}})))},t.createVacancyModifiers=function(e,t){const i=[],n=t.ruler.vacant;return t.counselor.vacant&&"culture"===e&&i.push(y(1,"Vacancy: Counselor",n)),t.general.vacant&&i.push(y(4,"Vacancy: General",n,"army")),t.emissary.vacant&&"loyalty"===e&&i.push(y(1,"Vacancy: Emissary",n)),t.magister.vacant&&i.push(y(4,"Vacancy: Magister",n,"army")),t.treasurer.vacant&&"economy"===e&&i.push(y(1,"Vacancy: Treasurer",n)),t.viceroy.vacant&&"stability"===e&&i.push(y(1,"Vacancy: Viceroy",n)),t.warden.vacant&&i.push(y(4,"Vacancy: Warden",n,"region")),n&&i.push(y(0,"Vacancy: Ruler",n)),i},t.createInvestedModifier=function(e,t,i){const n=(0,l.applyLeaderCompanionRules)(i);if((0,c.isInvested)(t,n))return{value:(0,a.getLevelData)(e).investedLeadershipBonus,enabled:!0,name:"Invested Leadership Role",type:"status"}},t.createAbilityModifier=function(e,t){return{type:"ability",name:(0,n.capitalize)(e),enabled:!0,value:(0,o.calculateAbilityModifier)(t[e])}},t.rankToLabel=v,t.rankToProficiency=function(e){return 1===e?"trained":2===e?"expert":3===e?"master":4===e?"legendary":void 0},t.proficiencyToRank=function(e){return"trained"===e?1:"expert"===e?2:"master"===e?3:"legendary"===e?4:0},t.createProficiencyModifier=function(e,t,i){return{value:function(e,t,i){return e>0?t+2*e:"full"===i?t:"half"===i?Math.floor(t/2):0}(e,i,t),enabled:!0,name:e>0?v(e):"Kingdom Level",type:"proficiency"}},t.createUnrestModifier=function(e){const t=(0,u.calculateUnrestPenalty)(e);if(t>0)return{type:"status",name:"Unrest",enabled:!0,value:-t}},t.createRuinModifier=function(e,t){const i=t[m.abilityRuins[e]].penalty;if(i>0)return{value:-i,enabled:!0,name:"Ruin",type:"item"}},t.createStructureModifiers=function(e,t){const i=function(e,t){return Object.entries(e).map((([e,i])=>{const a=[t[e].phase];return{type:"item",enabled:!0,value:i,name:`Structure - ${(0,n.unslugify)(e)}`,activities:[e],phases:a}}))}(e.activities,t),a=function(e){if(e>0)return{value:e,enabled:!0,name:"Structure",type:"item"}}(e.value);return a&&i.push(a),i}},357:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateResources=t.parseResourceButton=t.createUpdate=t.evaluateValue=t.getLimit=t.getCurrentValue=t.calculateNewValue=void 0;const n=i(8593),a=i(1155),s=i(7066),r=i(447),o=i(4310),l=i(3483);function c({currentValue:e,newValue:t,type:i,turn:a,mode:s,limit:r}){const o="gain"===s?e+t:e-t,l=o<0?Math.abs(o):0,c=void 0===r?o:Math.min(r,o),u="rolled-resource-dice"===i?"Resource Points":(0,n.unslugify)(i),m="now"===a?"this turn":"next turn",d=`${"gain"===s?"Gaining":"Losing"} ${Math.abs(t)} ${u} ${m}`,h=l>0&&"now"===a?`Missing ${l} ${u}`:"";return{value:"now"===a?Math.max(0,c):c,message:d,missingMessage:h}}function u(e,t,i){if("food"===t||"luxuries"===t||"ore"===t||"lumber"===t||"stone"===t)return e.commodities[i][t];if("unrest"===t)return e.unrest;if("resource-dice"===t)return e.resourceDice[i];if("resource-points"===t||"rolled-resource-dice"===t)return e.resourcePoints[i];if("crime"===t||"decay"===t||"strife"===t||"corruption"===t)return e.ruin[t].value;if("xp"===t)return e.xp;if("fame"===t)return e.fame[i];if("supernatural-solution"===t)return e.supernaturalSolutions;if("creative-solution"===t)return e.creativeSolutions;throw Error(`Unhandled type ${t}`)}function m(e,t,i,n){return"now"!==n||"food"!==i&&"luxuries"!==i&&"lumber"!==i&&"ore"!==i&&"stone"!==i?"fame"===i?3:void 0:(0,r.getCapacity)(e,t)[i]}async function d(e,t,i,s){if("rolled-resource-dice"===i){const i=s.includes("d")?`(${s})`:s,n=(0,o.getStringSetting)(e,"automateResources"),{size:r}=(0,l.getStolenLandsData)(e,n,t),c=(0,a.getSizeData)(r).resourceDieSize,u=await new Roll(`${i}${c}`).roll();return await u.toMessage({flavor:"Rolling Resource Dice"}),u.total}if(s.includes("d")){const e=await new Roll(s).roll();return await e.toMessage({flavor:`Rolling ${(0,n.unslugify)(i)}`}),e.total}return parseInt(s,10)}function h(e,t,i,n){if("rolled-resource-dice"===t||"resource-points"===t)return{resourcePoints:{...e.resourcePoints,[i]:n}};if("xp"===t)return{xp:n};if("fame"===t)return{fame:{...e.fame,[i]:n}};if("supernatural-solution"===t)return{supernaturalSolutions:n};if("creative-solution"===t)return{creativeSolutions:n};if("resource-dice"===t)return{resourceDice:{...e.resourceDice,[i]:n}};if("unrest"===t)return{unrest:n};if("strife"===t||"crime"===t||"decay"===t||"corruption"===t)return{ruin:{...e.ruin,[t]:{...e.ruin[t],value:n}}};if("lumber"===t||"ore"===t||"stone"===t||"food"===t||"luxuries"===t)return{commodities:{...e.commodities,[i]:{...e.commodities[i],[t]:n}}};throw Error(`Unhandled type ${t}`)}function f(e){return{type:e.dataset.type,mode:e.dataset.mode,turn:e.dataset.turn,value:e.dataset.value}}t.calculateNewValue=c,t.getCurrentValue=u,t.getLimit=m,t.evaluateValue=d,t.createUpdate=h,t.parseResourceButton=f,t.updateResources=async function(e,t,i){const{type:n,mode:a,turn:r,value:o}=f(i),l=(0,s.getKingdom)(t),p=await d(e,l,n,o),g=u(l,n,r),y=m(e,l,n,r),{missingMessage:v,message:b,value:k}=c({mode:a,limit:y,turn:r,newValue:p,type:n,currentValue:g});await ChatMessage.create({content:`${b}`}),v&&await ChatMessage.create({content:`${v}`});const w=h(l,n,r,k);await(0,s.saveKingdom)(t,w)}},6623:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addOngoingEvent=t.rollCheck=t.changeDegree=t.reRoll=t.cooperativeLeadership=t.parseUpgradeMeta=t.parseMeta=void 0;const n=i(8063),a=i(8593),s=i(943),r=i(6362),o=i(7066),l=i(447),c=i(1155);function u(e){const t=e.querySelector(".km-roll-meta"),i=t.dataset.rollOptions;return{total:parseInt(t.dataset.total??"0",10),dc:parseInt(t.dataset.dc??"0",10),activity:t.dataset.activity??void 0,skill:t.dataset.skill,degree:t.dataset.degree,formula:t.dataset.formula,modifier:parseInt(t.dataset.modifier??"0",10),rollType:t.dataset.rollType,rollOptions:(0,a.isNotBlank)(i)?JSON.parse(atob(i)):[],creativeSolutionModifier:parseInt(t.dataset.creativeSolutionModifier??"0",10),supernaturalSolutionModifier:parseInt(t.dataset.supernaturalSolutionModifier??"0",10),modifierBreakdown:(0,a.isNotBlank)(t.dataset.modifierBreakdown)?t.dataset.modifierBreakdown:void 0}}function m(e){const t=e.querySelector(".km-upgrade-result");return{activity:t.dataset.activity,degree:t.dataset.degree}}function d(e,t,i,a){return s=>(e&&a.includes("focused-attention")&&t>=11&&(s===n.DegreeOfSuccess.CRITICAL_FAILURE?s=n.DegreeOfSuccess.FAILURE:s===n.DegreeOfSuccess.FAILURE&&i>=2&&(s=n.DegreeOfSuccess.SUCCESS)),s)}async function h({formula:e,label:t,activity:i,dc:s,skill:r,modifier:o,actor:l,adjustDegreeOfSuccess:c=(e=>e),rollOptions:u,modifierBreakdown:m,supernaturalSolutionModifier:d,creativeSolutionModifier:h,rollType:p}){const y=await new Roll(e).roll(),v=y.total,b=v-o,k=(0,n.determineDegreeOfSuccess)(b,v,s),w=c(k),S=`\n        <div class="km-roll-meta" hidden \n            data-formula="${e}" \n            ${void 0===i?"":`data-activity="${i.id}"`}\n            data-degree="${(0,n.degreeToProperty)(w)}"\n            data-skill="${r}"\n            data-roll-options="${u?btoa(JSON.stringify(u)):""}"\n            data-dc="${s}"\n            data-total="${v}"\n            data-modifier-breakdown="${m??""}"\n            data-modifier="${o}"\n            data-roll-type="${p}"\n            data-creative-solution-modifier="${h}"\n            data-supernatural-solution-modifier="${d}"\n        ></div>`,C=function(e,t){if((0,a.isNotBlank)(e)){const i=(0,a.decodeJson)(e),n=function(e,t){return"supernatural-solution"===t?e.supernaturalSolution:"creative-solution"===t?e.creativeSolution:e.selected}(i,t);return console.log(i,n),`<div class="km-modifier-breakdown">${n.map((e=>{const t=e.value;return`<span class="km-modifier-pill">${(0,a.unslugify)(e.name)} ${t>=0?`+${t}`:t}</span>`})).join("")}</div>`}return""}(m,p);return await y.toMessage({flavor:`<span class="km-skill-check-header">Skill Check: ${t}, DC ${s}</span>${S}<hr>${C}`}),await async function(e,t,i,n){t?await g(e,t,i,n):await f(i,n)}(l,i,k,w===k?void 0:w),w}async function f(e,t){await(0,a.postDegreeOfSuccessMessage)({degreeOfSuccess:e,upgradedDegreeOfSuccess:t,messageConfig:{critSuccess:`${p([],"criticalSuccess")}`}})}function p(e,t,i){return e.length>0||"criticalSuccess"===t?`\n        <div class="km-chat-buttons">\n            ${"criticalSuccess"===t?'<button type="button" class="km-gain-fame-button">Gain 1 Fame</button>':""}\n            ${e.map(((e,n)=>{const a=(0,r.modifierToLabel)(e);return`<button class="km-apply-modifier-effect" \n                        data-activity="${i}" \n                        data-degree="${t}" \n                        data-index="${n}">Apply Effect: ${a}</button>`})).join("")}    \n        </div>`:""}async function g(e,t,i,s){const r=function(e){return e===n.DegreeOfSuccess.CRITICAL_SUCCESS?"criticalSuccess":e===n.DegreeOfSuccess.SUCCESS?"success":e===n.DegreeOfSuccess.FAILURE?"failure":"criticalFailure"}(s??i),l=t[r];if(l){const n=(0,o.getKingdom)(e),c=l.modifiers,u=l.msg,m=(void 0===c?p([],r):p(c(n),r,t.id))+`<div class="km-upgrade-result" data-activity="${t.id}" data-degree="${r}"></div>`,d=`<h3>${t.title}</h3>${t.description.trimEnd()}<hr>`;await(0,a.postDegreeOfSuccessMessage)({degreeOfSuccess:i,upgradedDegreeOfSuccess:s,beforeHeader:d,messageConfig:{critSuccess:`${u}${m}`,success:`${u}${m}`,failure:`${u}${m}`,critFailure:`${u}${m}`}})}else await f(i,s)}t.parseMeta=u,t.parseUpgradeMeta=m,t.cooperativeLeadership=d,t.reRoll=async function(e,t,i){const{total:n,formula:r,activity:m,skill:f,dc:p,modifier:g,rollOptions:y,creativeSolutionModifier:v,supernaturalSolutionModifier:b,modifierBreakdown:k,rollType:w}=u(t),S=m?(0,a.unslugify)(m):(0,a.unslugify)(f);let C=r;const A=(0,o.getKingdom)(e);let x;"fame"===i?await(0,o.saveKingdom)(e,(0,l.gainFame)(A,-1)):"creative-solution"===i?(C=`1d20+${v}`,x="creative-solution",await(0,o.saveKingdom)(e,{creativeSolutions:A.creativeSolutions-1})):"supernatural-solution"===i?(x="supernatural-solution",C=`1d20+${b}`,await(0,o.saveKingdom)(e,{supernaturalSolutions:A.supernaturalSolutions-1})):"keep-higher"===i?C=`{${r},${n}}kh`:"keep-lower"===i&&(C=`{${r},${n}}kl`),await h({formula:C,label:S,activity:m?(0,s.getKingdomActivitiesById)(A.homebrewActivities)[m]:void 0,dc:p,skill:f,modifier:g,modifierBreakdown:k,actor:e,adjustDegreeOfSuccess:d((0,c.hasFeat)(A,"Cooperative Leadership"),A.level,A.skillRanks[f],y),rollOptions:y,rollType:x??w,supernaturalSolutionModifier:b,creativeSolutionModifier:v})},t.changeDegree=async function(e,t,i){const{activity:a,degree:r}=m(t),l=(0,o.getKingdom)(e),c=(0,s.getKingdomActivitiesById)(l.homebrewActivities)[a],u="upgrade"===i?function(e){return"success"===e?"criticalSuccess":"failure"===e?"success":"criticalFailure"===e?"failure":e}(r):function(e){return"criticalSuccess"===e?"success":"success"===e?"failure":"failure"===e?"criticalFailure":e}(r),d="criticalSuccess"===(h=u)?n.DegreeOfSuccess.CRITICAL_SUCCESS:"success"===h?n.DegreeOfSuccess.SUCCESS:"failure"===h?n.DegreeOfSuccess.FAILURE:n.DegreeOfSuccess.CRITICAL_FAILURE;var h;await g(e,c,d,d)},t.rollCheck=h,t.addOngoingEvent=async function(e,t,i){const n=(0,o.getKingdom)(e),a=`@UUID[${t}]{${i}}`;await(0,o.saveKingdom)(e,{ongoingEvents:[...n.ongoingEvents,{name:a}]})}},3483:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.makeResourceDrawing=t.makeResourceTileOrDrawing=t.getStolenLandsData=t.parseSceneTiles=t.parseKingmaker=t.getSettlementsWithoutLandBorders=t.getActiveSettlementStructureResult=t.getAllMergedSettlements=t.getStructureStackMode=t.getStructureResult=t.getAllSettlements=t.getSettlement=t.getCapitalSettlement=t.getCurrentScene=t.getScene=t.getSceneStructures=t.getSettlementInfo=t.isStructureActorActive=t.isStructureActor=t.getStructuresFromActors=t.getSceneActorStructures=void 0;const n=i(9423),a=i(5278),s=i(949),r=i(4310),o=i(8593),l=i(6013),c=i(943);class StructureError extends Error{}function u(e,t,i){return void 0!==e.lots?e:{...e,lots:t*i}}function m(e,t,i,n,r){if(null!=t){if("object"==typeof t&&"ref"in t){const a=t,r=s.structuresByName.get(a.ref);if(void 0===r)throw console.log(a,s.structuresByName),new StructureError(`No predefined structure data found for actor with name ${e}, aborting`);return u(r,i,n)}if((0,o.isNonNullable)(e)&&(0,o.isNonNullable)(r)){const s={name:e,level:r,construction:{skills:l.allSkills.map((e=>({skill:e}))),dc:0,rp:0},...t},o=a.ruleSchema.validate(s);if(o.error)throw console.error(`Failed to validate structure with name ${e}`,t),console.error("Validation Error",o.error),new StructureError(`Structure with name ${e} failed to validate, aborting. See console log (F12) for more details`);return u(s,i,n)}return u(t,i,n)}}function d(e){return e.map((e=>{const t=e.token?.width??e.prototypeToken?.width??0,i=e.token?.height??e.prototypeToken?.height??0,n=m(e.name,e.getFlag("pf2e-kingmaker-tools","structureData"),t,i,e.level);return n?{...n,actor:e}:null})).filter((e=>null!==e))}function h(e){return(0,o.isNonNullable)(e.getFlag("pf2e-kingmaker-tools","structureData"))}function f(e){return void 0===e.itemTypes.condition?.find((e=>"condition"===e.type&&e.name.startsWith("Slowed")))}function p(e){return null!==e.actor&&void 0!==e.actor&&h(e.actor)&&f(e.actor)}function g(e,t,i){return t.xStart>=e.xStart-i&&t.xEnd<=e.xEnd+i&&t.yStart>=e.yStart-i&&t.yEnd<=e.yEnd+i}function y(e){const t=e.grid.size,i=Math.floor(.1*t),n=e.tokens.filter(p).map((e=>({xStart:e.x,yStart:e.y,xEnd:e.x+e.width*t,yEnd:e.y+e.height*t})));return function(e){return e.tiles.filter((e=>(0,o.isNonNullable)(e.getFlag("pf2e-kingmaker-tools","settlementBlockDrawing"))))}(e).filter((e=>function(e,t,i){return t.some((t=>g(e,t,i)))}({xStart:e.x,xEnd:e.x+e.width,yStart:e.y,yEnd:e.y+e.height},n,i))).length||1}function v(e,t){if(t&&!e.settlement.manualSettlementLevel){const t=y(e.scene);return{level:Math.min(20,t),lots:t}}return{level:e.settlement.level,lots:e.settlement.lots}}function b(e){try{return e.tokens.filter(p).map((e=>[e.actor,e.width??1,e.height??1])).map((([e,t,i])=>m(e.name,e.getFlag("pf2e-kingmaker-tools","structureData"),t,i,e.level))).filter((e=>void 0!==e))??[]}catch(e){if(!(e instanceof StructureError))throw e;ui.notifications?.error(e.message)}return[]}function k(e,t){return e?.scenes?.find((e=>e.id===t))}function w(e,t){const i=t.settlements.find((e=>"capital"===e.type)),n=i?k(e,i.sceneId):void 0;if(n&&i)return{scene:n,settlement:i}}function S(e,t,i){const n=t.settlements.find((e=>e.sceneId===i)),a=k(e,i);if(a&&n)return{settlement:n,scene:a}}function C(e,t){return e.scenes?.map((i=>S(e,t,i.id)))?.filter((e=>void 0!==e))??[]}function A(e,t,i,a){const s=b(e.scene),r=v(e,i).level;return(0,n.evaluateStructures)(s,r,t,a)}function x(e,t,i,a,s){return s&&s.scene.id!==a.scene.id?(0,n.includeCapital)(A(s,e,t,i),A(a,e,t,i)):A(a,e,t,i)}function R(e){return(0,r.getBooleanSetting)(e,"kingdomAllStructureItemBonusesStack")?"all-structures-stack":"same-structures-stack"}function I(e,t,i){return e.filter((e=>e.camp===t)).reduce(((e,n)=>{const a=n.commodity===i?1:0,s="mine"===t&&"luxuries"===n.commodity?0:1;return"luxuries"===i?{quantity:e.quantity+a,resources:e.resources}:{quantity:e.quantity+s,resources:e.resources+a}}),{quantity:0,resources:0})}function D(e){const t=Object.values(e.hexes).filter((e=>e.claimed)),i=t.filter((e=>e.features?.some((e=>"farmland"===e.type)))),n=t.filter((e=>"food"===e.commodity));return{size:t.length,workSites:{farmlands:{quantity:i.length,resources:n.length},quarries:I(t,"quarry","stone"),mines:I(t,"mine","ore"),lumberCamps:I(t,"lumber","lumber"),luxurySources:I(t,"mine","luxuries")}}}function T(e,t){const i=e.getFlag("pf2e-kingmaker-tools","realmTile");if(i){const{width:n,height:a}=t(e);return{...i,xStart:e.x,xEnd:e.x+n,yStart:e.y,yEnd:e.y+a}}}function M(e,t){const i={lumberCamp:"lumber",mine:"ore",quarry:"stone",luxuryWorksite:"luxury"}[e],n=t.filter((t=>t.type===e)).length;return{quantity:n,resources:n>0?t.filter((e=>e.type===i)).length:0}}function _(e,t){return{luxurySources:{resources:e.luxurySources.resources+t.luxurySources.resources,quantity:e.luxurySources.quantity+t.luxurySources.quantity},lumberCamps:{resources:e.lumberCamps.resources+t.lumberCamps.resources,quantity:e.lumberCamps.quantity+t.lumberCamps.quantity},quarries:{resources:e.quarries.resources+t.quarries.resources,quantity:e.quarries.quantity+t.quarries.quantity},farmlands:{resources:e.farmlands.resources+t.farmlands.resources,quantity:e.farmlands.quantity+t.farmlands.quantity},mines:{resources:e.mines.resources+t.mines.resources,quantity:e.mines.quantity+t.mines.quantity}}}function $(e,t){const i=e.filter((e=>"claimed"===e.type)),n=new Set(e.filter((e=>"claimed"!==e.type))),a=i.map((e=>{const i=Array.from(n).filter((i=>g(e,i,t)));i.forEach((e=>n.delete(e)));return{farmlands:{quantity:i.filter((e=>"farmland"===e.type)).length,resources:i.filter((e=>"food"===e.type)).length},lumberCamps:M("lumberCamp",i),mines:M("mine",i),quarries:M("quarry",i),luxurySources:M("luxuryWorksite",i)}})).reduce(_,{luxurySources:{resources:0,quantity:0},lumberCamps:{resources:0,quantity:0},quarries:{resources:0,quantity:0},farmlands:{resources:0,quantity:0},mines:{resources:0,quantity:0}});return{size:i.length,workSites:a}}function E(e,t){const i=function(e,t){if((0,o.isNonNullable)(t))return e.scenes?.find((e=>e.id===t))}(e,t);if(i){const e=Math.floor(.1*i.grid.size);return $([...i.tiles.filter((e=>e.visible)).map((e=>T(e,(e=>({width:e.width,height:e.height}))))).filter((e=>(0,o.isNonNullable)(e))),...i.drawings.filter((e=>e.visible)).map((e=>T(e,(e=>({width:e.shape.width,height:e.shape.height}))))).filter((e=>(0,o.isNonNullable)(e)))],e)}return{workSites:{luxurySources:{resources:0,quantity:0},lumberCamps:{resources:0,quantity:0},quarries:{resources:0,quantity:0},farmlands:{resources:0,quantity:0},mines:{resources:0,quantity:0}},size:0}}t.getSceneActorStructures=function(e){return d(e.tokens.map((e=>e.actor)).filter((e=>(0,o.isNonNullable)(e))))},t.getStructuresFromActors=d,t.isStructureActor=h,t.isStructureActorActive=f,t.getSettlementInfo=v,t.getSceneStructures=b,t.getScene=k,t.getCurrentScene=function(e){return e.scenes?.viewed},t.getCapitalSettlement=w,t.getSettlement=S,t.getAllSettlements=C,t.getStructureResult=x,t.getStructureStackMode=R,t.getAllMergedSettlements=function(e,t){const i=R(e),n=(0,c.getKingdomActivitiesById)(t.homebrewActivities),a=(0,r.getBooleanSetting)(e,"autoCalculateSettlementLevel");return C(e,t).map((e=>{const t=A(e,i,a,n);return{leadershipActivityNumber:t.increaseLeadershipActivities?3:2,settlementConsumption:t.consumption,storage:t.storage,unlockedActivities:new Set(t.unlockActivities)}})).reduce(((e,t)=>({leadershipActivityNumber:Math.max(e.leadershipActivityNumber,t.leadershipActivityNumber),settlementConsumption:e.settlementConsumption+t.settlementConsumption,storage:{ore:e.storage.ore+t.storage.ore,stone:e.storage.stone+t.storage.stone,luxuries:e.storage.luxuries+t.storage.luxuries,lumber:e.storage.lumber+t.storage.lumber,food:e.storage.food+t.storage.food},unlockedActivities:new Set([...e.unlockedActivities,...t.unlockedActivities])})),{leadershipActivityNumber:2,settlementConsumption:0,storage:{ore:0,stone:0,luxuries:0,lumber:0,food:0},unlockedActivities:new Set})},t.getActiveSettlementStructureResult=function(e,t){const i=S(e,t,t.activeSettlement),n=w(e,t),a=(0,c.getKingdomActivitiesById)(t.homebrewActivities),s=(0,r.getBooleanSetting)(e,"autoCalculateSettlementLevel");if(i){const t=R(e);return{active:x(t,s,a,i),merged:x(t,s,a,i,n)}}},t.getSettlementsWithoutLandBorders=function(e,t){const i=R(e),n=(0,r.getBooleanSetting)(e,"autoCalculateSettlementLevel"),a=(0,c.getKingdomActivitiesById)(t.homebrewActivities);return C(e,t).filter((e=>{const t=x(i,n,a,e);return(e.settlement?.waterBorders??0)>=4&&!t.hasBridge})).length},t.parseKingmaker=D,t.parseSceneTiles=$,t.getStolenLandsData=function(e,t,i){return"kingmaker"===t&&(0,o.isKingmakerInstalled)(e)?D(kingmaker.state):"tileBased"===t?E(e,i.realmSceneId):{size:i.size,workSites:i.workSites}},t.makeResourceTileOrDrawing=async function(e,t){await e.setFlag("pf2e-kingmaker-tools","realmTile",{type:t})},t.makeResourceDrawing=async function(e,t){await e.setFlag("pf2e-kingmaker-tools","realmTile",{type:t})}},5278:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ruleSchema=t.refSchema=void 0;const a=n(i(2705)),s=i(6013),r=i(949),o=r.structuresByName.keys();t.refSchema=a.default.object({ref:a.default.string().valid(...o)}),t.ruleSchema=a.default.object({name:a.default.string().required(),notes:a.default.string().optional(),preventItemLevelPenalty:a.default.boolean().optional(),enableCapitalInvestment:a.default.boolean().optional(),increaseLeadershipActivities:a.default.boolean().optional(),consumptionReduction:a.default.number().optional(),activityBonusRules:a.default.array().items(a.default.object({value:a.default.number().required(),activity:a.default.string().required()})).optional(),skillBonusRules:a.default.array().items(a.default.object({value:a.default.number().required(),skill:a.default.string().valid(...s.allSkills).required(),activity:a.default.string().optional()})).optional(),availableItemsRules:a.default.array().items(a.default.object({value:a.default.number().required(),group:a.default.string().valid(...r.itemGroups).optional(),maximumStacks:a.default.number().optional()})).optional(),settlementEventRules:a.default.array().items(a.default.object({value:a.default.number().required()})).optional(),leadershipActivityRules:a.default.array().items(a.default.object({value:a.default.number().required()})).optional(),storage:a.default.object({ore:a.default.number().optional(),food:a.default.number().optional(),lumber:a.default.number().optional(),stone:a.default.number().optional(),luxuries:a.default.number().optional()}).optional(),unlockActivities:a.default.array().items(a.default.string()).optional(),traits:a.default.array().items(a.default.string().valid(...r.allBuildingTraits)).optional(),isBridge:a.default.boolean().optional(),stacksWith:a.default.string().optional(),lots:a.default.number().optional(),level:a.default.number().optional(),affectsEvents:a.default.boolean().optional(),upgradeFrom:a.default.array().items(a.default.string()).optional(),affectsDowntime:a.default.boolean().optional(),reducesUnrest:a.default.boolean().optional(),reducesRuin:a.default.boolean().optional(),construction:a.default.object({skills:a.default.array().items(a.default.object({skill:a.default.array().valid(...s.allSkills),proficiencyRank:a.default.number().valid(0,1,2,3,4).optional()})),lumber:a.default.number().optional(),luxuries:a.default.number().optional(),ore:a.default.number().optional(),stone:a.default.number().optional(),rp:a.default.number(),dc:a.default.number()})})},5682:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showKingdom=void 0;const n=i(4310),a=i(1155),s=i(8593),r=i(3483),o=i(4431),l=i(7079),c=i(5516),u=i(7226),m=i(4024),d=i(5897),h=i(282),f=i(6079),p=i(8166),g=i(1154),y=i(2596),v=i(5351),b=i(324),k=i(3012),w=i(5849),S=i(6717),C=i(6362),A=i(4757),x=i(7066),R=i(447),I=i(9329),D=i(7516),T=i(7732),M=i(4848),_=i(3951),$=i(943),E=i(2468),O=i(267),L=i(3599),P=[...Array.from(Array(20).keys()).map((e=>e+1))];class KingdomApp extends FormApplication{static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-app",e.title="Kingdom",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/sheet.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=["kingmaker-tools-app","kingdom-app"],e.width=850,e.height="auto",e.scrollY=[".km-content",".km-sidebar"],e}sheetActor;game;nav="turn";constructor(e,t){super(e,t),this.game=t.game,this.sheetActor=t.sheetActor,this.sheetActor.apps[this.appId]=this}async getData(){const e=this.game.user?.isGM??!1,t=this.getKingdom(),i=(0,n.getStringSetting)(this.game,"automateResources"),{size:o,workSites:l}=(0,r.getStolenLandsData)(this.game,i,t),c=(0,a.getSizeData)(o),u=(0,n.getBooleanSetting)(this.game,"autoCalculateSettlementLevel"),{leadershipActivityNumber:m,settlementConsumption:d,unlockedActivities:h}=(0,r.getAllMergedSettlements)(this.game,t),{current:y,surplus:b}=(0,R.getConsumption)(this.game,t),k=(0,n.getBooleanSetting)(this.game,"vanceAndKerensharaXP"),w=(0,n.getBooleanSetting)(this.game,"kingdomSkillIncreaseEveryLevel"),S=(0,r.getActiveSettlementStructureResult)(this.game,t),A=(0,r.getSettlement)(this.game,t,t.activeSettlement),x=new Set([...h,...(0,p.getCompanionUnlockActivities)(t.leaders,(0,p.getOverrideUnlockCompanionNames)(this.game))]),D=t.activityBlacklist.map((e=>({[e]:!0}))).reduce(((e,t)=>Object.assign(e,t)),{}),T=(0,n.getBooleanSetting)(this.game,"kingdomIgnoreSkillRequirements"),M=(0,$.getKingdomActivitiesById)(t.homebrewActivities),_=(0,g.getPerformableActivities)(t.skillRanks,!0===S?.active?.allowCapitalInvestment||"capital"===A?.settlement.type&&(0,n.getBooleanSetting)(this.game,"capitalInvestmentInCapital"),T,M),E=(0,g.groupKingdomActivities)(M),O=(0,r.getCurrentScene)(this.game)?.id,L=void 0===t.settlements.find((e=>e.sceneId===O)),F=(0,s.isNonNullable)(O)&&O!==t.realmSceneId,j=(0,r.getStructureStackMode)(this.game),U="manual"!==i,N=e&&"tileBased"===i,B="kingmaker"===i||"manual"===i||(0,s.isNonNullable)(t.realmSceneId)&&void 0!==this.game.scenes?.find((e=>e.id===t.realmSceneId));return{notes:{gm:await TextEditor.enrichHTML(t.notes.gm),public:await TextEditor.enrichHTML(t.notes.public)},hideActivities:D,isGM:e,isUser:!e,enabledActivities:_,leadershipActivityNumber:m,name:t.name,size:o,xp:t.xp,xpThreshold:t.xpThreshold,level:t.level,fame:t.fame,charter:t.charter,heartland:t.heartland,heartlandLabel:(0,s.unslugify)(t.heartland),government:t.government,type:(0,s.capitalize)(c.type),controlDC:(0,a.getControlDC)(t.level,o,t.leaders.ruler.vacant),atWar:t.atWar,unrest:t.unrest,unrestPenalty:(0,I.calculateUnrestPenalty)(t.unrest),anarchyAt:this.calculateAnarchy(t.feats,t.bonusFeats),resourceDieSize:c.resourceDieSize,resourceDiceNum:this.getResourceDiceNum(t),resourceDice:t.resourceDice,resourcePoints:t.resourcePoints,consumption:t.consumption,activeSettlement:t.activeSettlement,supernaturalSolutions:t.supernaturalSolutions,creativeSolutions:t.creativeSolutions,levels:P,settlementConsumption:d,totalConsumption:y,farmSurplus:b,ruin:this.getRuin(t.ruin),commodities:this.getCommodities(t),workSites:this.getWorkSites(l),farmlands:l.farmlands.quantity,food:l.farmlands.resources,...this.getActiveTabs(),skills:(0,v.calculateSkills)({ruin:t.ruin,skillRanks:t.skillRanks,leaders:t.leaders,abilityScores:t.abilityScores,unrest:t.unrest,kingdomLevel:t.level,untrainedProficiencyMode:(0,C.getUntrainedProficiencyMode)(this.game),skillItemBonuses:S?.merged?.skillBonuses,additionalModifiers:(0,C.createActiveSettlementModifiers)(t,A?.settlement,S,(0,r.getSettlementsWithoutLandBorders)(this.game,t)),activities:M}),leaders:this.getLeaders(t.leaders),abilities:this.getAbilities(t.abilityScores,t.leaders,t.level),fameTypes:a.allFameTypes,fameLabel:this.getFameLabel(t.fame.type),groups:t.groups,...this.getFeats(t.feats,t.bonusFeats,t.level),tradeAgreementsSize:t.groups.filter((e=>"trade-agreement"===e.relations)).length,ranks:[{label:"Untrained",value:0},{label:"Trained",value:1},{label:"Expert",value:2},{label:"Master",value:3},{label:"Legendary",value:4}],heartlands:a.allHeartlands.map((e=>({label:(0,s.unslugify)(e),value:e}))),actorTypes:[{label:"PC",value:"pc"},{label:"NPC",value:"npc"},{label:"Companion",value:"companion"}],companions:p.allCompanions,settlements:t.settlements.map((e=>(0,r.getSettlement)(this.game,t,e.sceneId))).filter((e=>void 0!==e)).map((e=>{const t=e,i=t.settlement.waterBorders??0;return{...t.settlement,...(0,r.getSettlementInfo)(t,u),waterBorders:i,overcrowded:this.isOvercrowded(t),lacksBridge:i>=4&&!(0,r.getStructureResult)(j,u,M,t).hasBridge,isCapital:"capital"===e?.settlement.type,name:t.scene.name??void 0}})),groupRelationTypes:[{label:"None",value:"none"},{label:"Diplomatic Relations",value:"diplomatic-relations"},{label:"Trade Agreement",value:"trade-agreement"}],ongoingEvents:await Promise.all(t.ongoingEvents.map((e=>TextEditor.enrichHTML(e.name)))),milestones:t.milestones.map((t=>({...t,display:(k||!t.homebrew)&&(e||!t.name.startsWith("Cult Event"))}))),leadershipActivities:(0,g.enableCompanionActivities)("leadership",x,E).map((e=>({label:(0,g.createActivityLabel)(E,e,t),value:e}))).sort(((e,t)=>e.label.localeCompare(t.label))),regionActivities:(0,g.enableCompanionActivities)("region",x,E).map((e=>({label:(0,g.createActivityLabel)(E,e,t),value:e}))),armyActivities:(0,g.enableCompanionActivities)("army",x,E).map((e=>({label:(0,g.createActivityLabel)(E,e,t),value:e}))),featuresByLevel:Array.from(f.featuresByLevel.entries()).map((([e,t])=>{const i=t.map((e=>e.name));return w&&e%2==0&&i.push("Skill Increase"),{level:e,features:i.join(", ")}})),uniqueFeatures:f.uniqueFeatures,canLevelUp:t.xp>=t.xpThreshold&&t.level<20,turnsWithoutEvent:t.turnsWithoutEvent,eventDC:this.calculateEventDC(t.turnsWithoutEvent),turnsWithoutCultEvent:t.turnsWithoutCultEvent,cultEventDC:this.calculateCultEventDC(t.turnsWithoutCultEvent),civicPlanning:t.level>=12,useXpHomebrew:k,canAddSettlement:L,effects:(W=t.modifiers,W.map((e=>({name:e.name,effect:(0,C.modifierToLabel)(e),turns:void 0===e.turns?"indefinite":`${e.turns}`,consumable:void 0!==e.consumeId})))),cultOfTheBloomEvents:(0,n.getBooleanSetting)(this.game,"cultOfTheBloomEvents")&&e,automateResources:U,canAddRealm:F,showRealmData:B,showAddRealmButton:N};var W}getFameLabel(e){return"famous"===e?"Fame":"Infamy"}getActiveTabs(){return{statusTab:"status"===this.nav,skillsTab:"skills"===this.nav,turnTab:"turn"===this.nav,groupsTab:"groups"===this.nav,featsTab:"feats"===this.nav,notesTab:"notes"===this.nav,settlementsTab:"settlements"===this.nav,effectsTab:"effects"===this.nav}}_getHeaderButtons(){const e=super._getHeaderButtons();return e.unshift({label:"Help",class:"pf2e-kingmaker-tools-hb1",icon:"fas fa-question",onclick:()=>(0,M.openJournal)("Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.iAQCUYEAq4Dy8uCY.JournalEntryPage.ty6BS5eSI7ScfVBk")}),this.game.user?.isGM&&e.unshift({label:"Show Players",class:"something-made-up",icon:"fas fa-eye",onclick:()=>this.game.socket.emit("module.pf2e-kingmaker-tools",{action:"openKingdomSheet"})}),e}async _updateObject(e,t){console.log(t);const i=this.getKingdom().milestones,n=expandObject(t);n.groups=(0,s.unpackFormArray)(n.groups),n.feats=(0,s.unpackFormArray)(n.feats),n.bonusFeats=(0,s.unpackFormArray)(n.bonusFeats),n.milestones=(0,s.unpackFormArray)(n.milestones).map(((e,t)=>({...i[t],completed:e.completed}))),await this.saveKingdom(n)}sceneChange(){this.render()}activateListeners(e){super.activateListeners(e),Hooks.on("closeKingmakerHexEdit",this.sceneChange.bind(this)),Hooks.on("deleteScene",this.sceneChange.bind(this)),Hooks.on("canvasReady",this.sceneChange.bind(this)),Hooks.on("createToken",this.sceneChange.bind(this)),Hooks.on("deleteToken",this.sceneChange.bind(this)),Hooks.on("sightRefresh",this.sceneChange.bind(this)),Hooks.on("applyTokenStatusEffect",this.sceneChange.bind(this)),Hooks.on("createTile",this.sceneChange.bind(this)),Hooks.on("updateTile",this.sceneChange.bind(this)),Hooks.on("deleteTile",this.sceneChange.bind(this)),Hooks.on("createDrawing",this.sceneChange.bind(this)),Hooks.on("updateDrawing",this.sceneChange.bind(this)),Hooks.on("deleteDrawing",this.sceneChange.bind(this));const t=e[0];t.querySelectorAll(".km-nav a")?.forEach((e=>{e.addEventListener("click",(e=>{const t=e.currentTarget;this.nav=t.dataset.tab,this.render()}))})),t.querySelectorAll(".km-reduce-ruin").forEach((e=>e.addEventListener("click",(async e=>await this.reduceRuin(e))))),t.querySelector("#km-kingdom-size-help")?.addEventListener("click",(async e=>{e.stopPropagation(),e.preventDefault(),(0,O.kingdomSizeDialog)()})),t.querySelector("#km-settlement-size-help")?.addEventListener("click",(async e=>{e.stopPropagation(),e.preventDefault(),(0,L.settlementSizeDialog)()})),t.querySelector("#km-gain-fame")?.addEventListener("click",(async()=>await this.upkeepGainFame())),t.querySelector("#km-adjust-unrest")?.addEventListener("click",(async()=>await this.adjustUnrest())),t.querySelector("#km-collect-resources")?.addEventListener("click",(async()=>await this.collectResources())),t.querySelector("#km-reduce-unrest")?.addEventListener("click",(async()=>await this.reduceUnrest())),t.querySelector("#km-pay-consumption")?.addEventListener("click",(async()=>await this.payConsumption())),t.querySelector("#km-check-event")?.addEventListener("click",(async()=>await this.checkForEvent())),t.querySelector("#km-check-cult-event")?.addEventListener("click",(async()=>await this.checkForCultEvent())),t.querySelector("#km-roll-event")?.addEventListener("click",(async()=>await(0,m.rollKingdomEvent)(this.game))),t.querySelector("#km-roll-cult-event")?.addEventListener("click",(async()=>await(0,m.rollCultEvent)(this.game))),t.querySelector("#claimed-refuge")?.addEventListener("click",(async()=>await this.claimedHexFeature("refuge"))),t.querySelector("#km-open-structure-browser")?.addEventListener("click",(async()=>await this.showStructureBrowser())),t.querySelectorAll(".km-view-settlement-scene")?.forEach((e=>{e.addEventListener("click",(async e=>{await this.viewSettlementScene(e)}))})),t.querySelector("#claimed-landmark")?.addEventListener("click",(async()=>await this.claimedHexFeature("landmark"))),t.querySelector("#km-add-event")?.addEventListener("click",(async()=>(0,u.addOngoingEventDialog)((e=>{const t=this.getKingdom();this.saveKingdom({ongoingEvents:[...t.ongoingEvents,{name:e}]})})))),t.querySelectorAll(".km-remove-event")?.forEach((e=>{e.addEventListener("click",(async e=>await this.deleteKingdomPropertyAtIndex(e,"ongoingEvents")))})),t.querySelectorAll(".km-event-xp")?.forEach((e=>{e.addEventListener("click",(async e=>{const t=e.currentTarget,i=parseInt(t.dataset.modifier??"0",10);await this.increaseXP((0,d.calculateEventXP)(i))}))})),t.querySelectorAll(".km-claimed-hexes-xp")?.forEach((e=>{e.addEventListener("click",(async e=>{const t=e.currentTarget,i=parseInt(t.dataset.hexes??"0",10),a=this.getKingdom(),s=(0,n.getStringSetting)(this.game,"automateResources"),{size:o}=(0,r.getStolenLandsData)(this.game,s,a),l=(0,n.getBooleanSetting)(this.game,"vanceAndKerensharaXP");await this.increaseXP((0,d.calculateHexXP)({hexes:i,kingdomSize:o,useVK:l,xpPerClaimedHex:(0,n.getNumberSetting)(this.game,"xpPerClaimedHex")}))}))})),t.querySelector("#km-rp-to-xp")?.addEventListener("click",(async()=>{const e=this.getKingdom(),t=(0,n.getBooleanSetting)(this.game,"vanceAndKerensharaXP");await this.increaseXP((0,d.calculateRpXP)({useVK:t,kingdomLevel:e.level,rpToXpConversionLimit:(0,n.getNumberSetting)(this.game,"rpToXpConversionLimit"),rpToXpConversionRate:(0,n.getNumberSetting)(this.game,"rpToXpConversionRate"),rp:e.resourcePoints.now}))})),t.querySelector("#solutions-to-xp")?.addEventListener("click",(async()=>{const e=this.getKingdom();await this.increaseXP(10*(e.supernaturalSolutions+e.creativeSolutions))})),t.querySelector("#km-level-up")?.addEventListener("click",(async()=>{const e=this.getKingdom();e.xp>=e.xpThreshold?await this.saveKingdom({level:e.level+1,xp:e.xp-e.xpThreshold}):ui.notifications?.error("Can not level up, not enough XP")})),t.querySelector("#km-add-group")?.addEventListener("click",(async()=>{(0,l.addGroupDialog)((e=>this.saveKingdom({groups:[...this.getKingdom().groups,e]})))})),t.querySelectorAll(".km-delete-group")?.forEach((e=>{e.addEventListener("click",(async e=>await this.deleteKingdomPropertyAtIndex(e,"groups")))})),t.querySelector("#km-add-bonus-feat")?.addEventListener("click",(async()=>{new c.AddBonusFeatDialog(null,{feats:o.allFeats,onOk:e=>this.saveKingdom({bonusFeats:[...this.getKingdom().bonusFeats,e]})}).render(!0)})),t.querySelector("#manage-kingdom-activities")?.addEventListener("click",(async()=>{(0,E.manageKingdomActivitiesDialog)(this.game,this.sheetActor)})),t.querySelectorAll(".km-delete-bonus-feat")?.forEach((e=>{e.addEventListener("click",(async e=>await this.deleteKingdomPropertyAtIndex(e,"bonusFeats")))})),t.querySelectorAll(".kingdom-activity")?.forEach((e=>{e.addEventListener("click",(async e=>{const t=e.currentTarget.dataset.activity,i=this.getKingdom();"none"===(0,$.getKingdomActivitiesById)(i.homebrewActivities)[t].dc?await(0,w.showHelpDialog)(this.game,this.sheetActor,t):new k.CheckDialog(null,{activity:t,kingdom:i,game:this.game,type:"activity",onRoll:this.consumeModifiers.bind(this),actor:this.sheetActor}).render(!0)}))})),t.querySelectorAll(".kingdom-skill")?.forEach((e=>{e.addEventListener("click",(async e=>{const t=e.currentTarget.dataset.skill;new k.CheckDialog(null,{kingdom:this.getKingdom(),game:this.game,skill:t,type:"skill",onRoll:this.consumeModifiers.bind(this),actor:this.sheetActor}).render(!0)}))})),t.querySelector("#km-end-turn")?.addEventListener("click",(async()=>await this.endTurn())),t.querySelectorAll(".show-help")?.forEach((e=>{e.addEventListener("click",(async e=>{const t=e.currentTarget.dataset.help;t&&await(0,w.showHelpDialog)(this.game,this.sheetActor,t)}))})),t.querySelector("#make-current-scene-realm")?.addEventListener("click",(async()=>{const e=(0,r.getCurrentScene)(this.game),t=e?.id;t&&await this.saveKingdom({realmSceneId:t})})),t.querySelector("#make-current-scene-settlement")?.addEventListener("click",(async()=>{const e=(0,r.getCurrentScene)(this.game),t=e?.id;if(t){const e={sceneId:t,level:0,type:"settlement",lots:0,secondaryTerritory:!1,waterBorders:0},i=this.getKingdom();await this.saveKingdom({settlements:[...i.settlements,e]})}})),t.querySelectorAll(".km-delete-settlement")?.forEach((e=>{e.addEventListener("click",(async e=>await this.deleteKingdomPropertyAtIndex(e,"settlements")))})),t.querySelectorAll(".inspect-settlement")?.forEach((e=>{e.addEventListener("click",(async e=>{const t=this.getKingdom(),i=e.currentTarget.dataset.id;await(0,S.showSettlement)(this.game,i,t)}))})),t.querySelector("#km-add-effect")?.addEventListener("click",(async()=>{const e=Object.keys((0,$.getKingdomActivitiesById)(this.getKingdom().homebrewActivities));(0,A.addEffectDialog)(e,(async e=>{const t=this.getKingdom();t.modifiers.push(e),await this.saveKingdom(t)}))})),t.querySelectorAll(".km-delete-effect")?.forEach((e=>{e.addEventListener("click",(async e=>await this.deleteKingdomPropertyAtIndex(e,"modifiers")))})),t.querySelector(".kingdom-settings")?.addEventListener("click",(()=>(0,T.showKingdomSettings)({game:this.game,sheetActor:this.sheetActor,onSave:()=>{this.render()}}))),t.querySelectorAll(".edit-settlement")?.forEach((e=>{e.addEventListener("click",(async e=>{const t=e?.currentTarget,i=parseInt(t?.dataset?.index,10),a=this.getKingdom(),s=a.settlements[i],o=(0,r.getScene)(this.game,s.sceneId)?.name,l=(0,n.getBooleanSetting)(this.game,"autoCalculateSettlementLevel");(0,D.editSettlementDialog)(l,o,s,(e=>{a.settlements[i]=e,this.saveKingdom({settlements:a.settlements})}))}))}))}async upkeepGainFame(){await ChatMessage.create({content:"Gaining 1 Fame"}),await this.saveKingdom((0,R.gainFame)(this.getKingdom(),1))}async consumeModifiers(e){const t=this.getKingdom();await this.saveKingdom({modifiers:t.modifiers.filter((t=>{const i=t.consumeId;return null==i||!e.has(i)}))})}async reduceRuin(e){const t=e.currentTarget.dataset.ruin,i=await new Roll("1d20").roll();if(await i.toMessage({flavor:`Reducing ${(0,s.capitalize)(t)} on a 16 or higher`}),i.total>=16){const e=this.getKingdom();await this.saveKingdom({ruin:{...e.ruin,[t]:{...e.ruin[t],penalty:Math.max(0,e.ruin[t].penalty-1)}}})}}async increaseXP(e){await ChatMessage.create({content:`Gained ${e} Kingdom XP`}),await this.saveKingdom({xp:this.getKingdom().xp+e})}async endTurn(){const e=this.getKingdom(),t=(0,R.getCapacity)(this.game,e);await ChatMessage.create({content:"<h2>Ending Turn</h2>\n            <ul>\n                <li>Setting Resource Points to 0</li>\n                <li>Reducing Effects' Turns by 1</li>\n                <li>Setting available Supernatural and Creative Solutions to 0</li>\n                <li>Adding values from the <b>next</b> columns to the <b>now</b> columns respecting their resource limits</li>\n            </ul>\n            "});const i=e.modifiers.map((e=>{const t=void 0===e.turns?void 0:e.turns-1;return{...e,turns:t}})).filter((e=>(e?.turns??1)>0));await this.saveKingdom({modifiers:i,fame:{...e.fame,now:(0,s.clamped)(e.fame.next,0,3),next:0},resourceDice:{now:e.resourceDice.next,next:0},supernaturalSolutions:0,creativeSolutions:0,resourcePoints:{now:e.resourcePoints.next,next:0},consumption:{now:e.consumption.next,next:0,armies:e.consumption.armies},commodities:{now:{food:Math.min(t.food,e.commodities.now.food+e.commodities.next.food),luxuries:Math.min(t.luxuries,e.commodities.now.luxuries+e.commodities.next.luxuries),stone:Math.min(t.stone,e.commodities.now.stone+e.commodities.next.stone),lumber:Math.min(t.lumber,e.commodities.now.lumber+e.commodities.next.lumber),ore:Math.min(t.ore,e.commodities.now.ore+e.commodities.next.ore)},next:{food:0,luxuries:0,stone:0,lumber:0,ore:0}}})}isOvercrowded(e){const t=(0,r.getStructureStackMode)(this.game),i=(0,n.getBooleanSetting)(this.game,"autoCalculateSettlementLevel"),a=(0,$.getKingdomActivitiesById)(this.getKingdom().homebrewActivities),s=(0,r.getStructureResult)(t,i,a,e);return(0,r.getSettlementInfo)(e,i).lots>s.residentialLots}async adjustUnrest(){const e=this.getKingdom(),t=(0,r.getAllSettlements)(this.game,e),i=t.filter((e=>this.isOvercrowded(e))).length,n=t.some((e=>e.settlement.secondaryTerritory))?1:0,a=e.atWar?1:0;let s=0;if(e.leaders.ruler.vacant){const e=await new Roll("1d4").roll();await e.toMessage({flavor:"Gaining Unrest because Leader is vacant"}),s=e.total}const o=a+i+n+s;let l=o+e.unrest;if(e.level>=20&&l>0?(l=0,await ChatMessage.create({content:'Ignoring any Unrest increase due to "Envy of the World" Kingdom Feature'})):await ChatMessage.create({content:`<h2>Gaining Unrest</h2> \n                <ul>\n                    <li><b>Overcrowded Settlements</b>: ${i}</li>\n                    <li><b>Secondary Territories</b>: ${n}</li>\n                    <li><b>Kingdom At War</b>: ${a}</li>\n                    <li><b>Ruler Vacancy Penalty</b>: ${s}</li>\n                    <li><b>Total</b>: ${o}</li>\n                </ul>\n                `}),l>=10){const e=await new Roll("1d10").roll();await e.toMessage({flavor:"Gaining points to Ruin (distribute as you wish)"});const t=await new Roll("1d20").roll();await t.toMessage({flavor:"Check if losing a hex on DC 11"}),t.total>=11&&await ChatMessage.create({content:"You lose one hex of your choice"})}l>=this.calculateAnarchy(e.feats,e.bonusFeats)&&await ChatMessage.create({content:"Kingdom falls into anarchy, unless you spend all fame/infamy points. Only Quell Unrest leadership activities can be performed and all checks are worsened by a degree"}),await this.saveKingdom({unrest:l})}async checkForEvent(){const e=(0,n.getStringSetting)(this.game,"kingdomEventRollMode"),t=this.getKingdom().turnsWithoutEvent,i=this.calculateEventDC(t),a=await new Roll("1d20").roll();await a.toMessage({flavor:`Checking for Event on DC ${i}`},{rollMode:e}),a.total>=i?(await ChatMessage.create({type:CONST.CHAT_MESSAGE_TYPES.ROLL,content:"An event occurs, roll a Kingdom Event!",rollMode:e}),await this.saveKingdom({turnsWithoutEvent:0})):await this.saveKingdom({turnsWithoutEvent:t+1})}async checkForCultEvent(){const e=(0,n.getStringSetting)(this.game,"kingdomEventRollMode"),t=this.getKingdom().turnsWithoutCultEvent,i=this.calculateCultEventDC(t),a=await new Roll("1d20").roll();await a.toMessage({flavor:`Checking for Cult Event on DC ${i}`},{rollMode:e}),a.total>=i?(await ChatMessage.create({type:CONST.CHAT_MESSAGE_TYPES.ROLL,content:"An event occurs, roll a Cult Event!",rollMode:e}),await this.saveKingdom({turnsWithoutCultEvent:0})):await this.saveKingdom({turnsWithoutCultEvent:t+1})}async deleteKingdomPropertyAtIndex(e,t){const i=e.currentTarget.dataset.deleteIndex;if(i){const e=parseInt(i,10),n=[...this.getKingdom()[t]];n.splice(e,1),await this.saveKingdom({[t]:n})}}async collectResources(){const e=this.getKingdom(),t=(0,n.getStringSetting)(this.game,"automateResources"),{size:i,workSites:s}=(0,r.getStolenLandsData)(this.game,t,e),o=(0,a.getSizeData)(i),l=(0,R.getCapacity)(this.game,e),c=this.getResourceDiceNum(e),u=await this.rollResourceDice(o.resourceDieSize,c),m=this.calculateCommoditiesThisTurn(s);await ChatMessage.create({content:`\n        <h2>Collecting Resources</h2>\n        <ul>\n            <li><b>Resource Points</b>: ${u}</li>\n            <li><b>Ore</b>: ${m.ore}</li>\n            <li><b>Lumber</b>: ${m.lumber}</li>\n            <li><b>Stone</b>: ${m.stone}</li>\n            <li><b>Luxuries</b>: ${m.luxuries}</li>\n        </ul>\n        `}),await this.saveKingdom({resourcePoints:{now:e.resourcePoints.now+u,next:e.resourcePoints.next},resourceDice:{now:0,next:e.resourceDice.next},commodities:{now:{ore:Math.min(l.ore,e.commodities.now.ore+m.ore),lumber:Math.min(l.lumber,e.commodities.now.lumber+m.lumber),luxuries:Math.min(l.luxuries,e.commodities.now.luxuries+m.luxuries),stone:Math.min(l.stone,e.commodities.now.stone+m.stone),food:e.commodities.now.food},next:e.commodities.next}})}getResourceDiceNum(e){const t=(0,a.hasFeat)(e,"Insider Trading")?1:0,i=(0,a.getLevelData)(e.level);return Math.max(0,i.resourceDice+e.resourceDice.now+t)}calculateCommoditiesThisTurn(e){return{ore:e.mines.quantity+e.mines.resources,lumber:e.lumberCamps.quantity+e.lumberCamps.resources,luxuries:e.luxurySources.quantity+e.luxurySources.resources,stone:e.quarries.quantity+e.quarries.resources}}close(e){return Hooks.off("closeKingmakerHexEdit",this.sceneChange),Hooks.off("deleteScene",this.sceneChange),Hooks.off("canvasReady",this.sceneChange),Hooks.off("createToken",this.sceneChange),Hooks.off("sightRefresh",this.sceneChange),Hooks.off("deleteToken",this.sceneChange),Hooks.off("applyTokenStatusEffect",this.sceneChange),Hooks.off("createTile",this.sceneChange),Hooks.off("updateTile",this.sceneChange),Hooks.off("deleteTile",this.sceneChange),Hooks.off("createDrawing",this.sceneChange),Hooks.off("updateDrawing",this.sceneChange),Hooks.off("deleteDrawing",this.sceneChange),super.close(e)}getRuin(e){return Object.fromEntries(Object.entries(e).map((([e,t])=>[e,{label:(0,s.capitalize)(e),...t,canReduce:0===t.value&&t.penalty>0}])))}getWorkSites(e){return{lumberCamps:{label:"Lumber",total:e.lumberCamps.quantity+e.lumberCamps.resources,...e.lumberCamps},mines:{label:"Ore",total:e.mines.quantity+e.mines.resources,...e.mines},quarries:{label:"Stone",total:e.quarries.quantity+e.quarries.resources,...e.quarries},luxurySources:{label:"Luxuries",total:e.luxurySources.quantity+e.luxurySources.resources,...e.luxurySources}}}getCommodities(e){const t=e.commodities.now,i=e.commodities.next,n=(0,R.getCapacity)(this.game,e);return Object.fromEntries(Object.entries(t).map((([e,t])=>[e,{label:(0,s.capitalize)(e),value:t,capacity:n[e],next:i[e]}])))}getLeaders(e){const t=(0,p.applyLeaderCompanionRules)(e);return Object.fromEntries(Object.entries(t).map((([e,t])=>[e,{label:(0,s.capitalize)(e),isCompanion:"companion"===t.type,...t}])))}getAbilities(e,t,i){return Object.fromEntries(Object.entries(e).map((([e,n])=>[e,{label:(0,s.capitalize)(e),score:n,modifier:(0,y.calculateAbilityModifier)(n),invested:(0,b.isInvested)(e,t),investedBonus:(0,b.calculateInvestedBonus)(i,e,t)}])))}getFeats(e,t,i){const n=[],a=Object.fromEntries(e.map((e=>[e.level,e]))),s=o.allFeatsByName["-"];for(let e=2;e<=i;e+=2){const t=a[e];t&&t.id in o.allFeatsByName?n.push({...o.allFeatsByName[t.id],takenAt:e}):n.push({...s,takenAt:e})}return{featIds:Object.keys(o.allFeatsByName),levelFeats:n,bonusFeats:t.filter((e=>e.id in o.allFeatsByName)).map((e=>o.allFeatsByName[e.id]))}}async rollResourceDice(e,t){const i=await new Roll(t+e).roll();return await i.toMessage({flavor:"Rolling Resource Dice"}),i.total}async reduceUnrest(){const e=await new Roll("1d20").roll();await e.toMessage({flavor:"Reducing Unrest by 1 on an 11 or higher"}),e.total>10&&await this.saveKingdom({unrest:Math.max(0,this.getKingdom().unrest-1)})}calculateEventDC(e){return Math.max(1,16-5*e)}calculateCultEventDC(e){return Math.max(1,20-2*e)}calculateAnarchy(e,t){return e.some((e=>"Endure Anarchy"===e.id))||t.some((e=>"Endure Anarchy"===e.id))?24:20}async payConsumption(){const e=this.getKingdom(),t=(0,R.getConsumption)(this.game,e).current,i=e.commodities.now.food,n=t-i,a=5*n;t>0&&(await ChatMessage.create({content:`<h2>Paying Consumption</h2>\n            <ul>\n                <li>Reducing food commodities by ${Math.min(i,t)}</li>\n                ${n>0?`<li>Missing ${n} food commodities. Either pay ${(0,$.loseRP)(a)} or gain ${(0,$.gainUnrest)("1d4")}</li>`:""}\n            </ul>\n            `}),await this.saveKingdom({commodities:{now:{...e.commodities.now,food:Math.max(0,i-t)},next:e.commodities.next}}))}async saveKingdom(e){await(0,x.saveKingdom)(this.sheetActor,e)}getKingdom(){return(0,x.getKingdom)(this.sheetActor)}async claimedHexFeature(e){const t=this.getKingdom();if("refuge"===e)await ChatMessage.create({content:"Claimed a Refuge, please reduce a Ruin of your choice by 1"}),await this.saveKingdom({modifiers:[...t.modifiers,{name:"Claimed Refuge",enabled:!0,value:2,type:"circumstance",abilities:["loyalty","stability"],turns:2}]});else{const e=await new Roll("1d4").roll();await e.toMessage({flavor:"Claimed a Landmark, reducing Unrest by:"}),await this.saveKingdom({unrest:Math.max(0,t.unrest-e.total),modifiers:[...t.modifiers,{name:"Claimed Landmark",enabled:!0,value:2,type:"circumstance",abilities:["culture","economy"],turns:2}]})}}async viewSettlementScene(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget.dataset.id,i=this.game.scenes?.filter((e=>e.id===t))?.[0];i&&(e.ctrlKey?await i.activate():await i.view())}async showStructureBrowser(){const e=this.game.actors?.filter((e=>"npc"===e.type&&(0,s.isNonNullable)(e.getFlag("pf2e-kingmaker-tools","structureData"))))??[];await(0,_.showStructureBrowser)(this.game,e,this.getKingdom(),this.sheetActor,this.consumeModifiers.bind(this))}}t.showKingdom=async function e(t){const i=t?.actors?.find((e=>"Kingdom Sheet"===e.name));i?new KingdomApp(null,{game:t,sheetActor:i}).render(!0):(0,h.setupDialog)(t,"Kingdom","dI12fgPwX9il8Fzu",(async()=>{const i=t?.actors?.find((e=>"Kingdom Sheet"===e.name));await(i?.setFlag("pf2e-kingmaker-tools","kingdom-sheet",(0,a.getDefaultKingdomData)())),await e(t)}))}},5351:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateSkills=t.createSkillModifiers=void 0;const n=i(8593),a=i(6013),s=i(6362);function r({skill:e,ruin:t,unrest:i,skillRank:n,abilityScores:a,leaders:r,kingdomLevel:o,untrainedProficiencyMode:l,skillItemBonus:c,ability:u,activity:m,phase:d,additionalModifiers:h=[],overrides:f={},activities:p}){const g=(0,s.createAbilityModifier)(u,a),y=(0,s.createProficiencyModifier)(n,l,o),v=(0,s.createVacancyModifiers)(u,r),b=(0,s.createInvestedModifier)(o,u,r),k=c?(0,s.createStructureModifiers)(c,p):[],w=(0,s.createUnrestModifier)(i),S=(0,s.createRuinModifier)(u,t),C=[g,y,...v,...k,...h];return S&&C.push(S),w&&C.push(w),b&&C.push(b),(0,s.processModifiers)({modifiers:C,skill:e,rank:n,phase:d,activity:m,overrides:f,activities:p})}t.createSkillModifiers=r,t.calculateSkills=function({ruin:e,unrest:t,skillRanks:i,abilityScores:o,leaders:l,kingdomLevel:c,untrainedProficiencyMode:u,skillItemBonuses:m,additionalModifiers:d,activities:h}){return a.allSkills.map((f=>{const p=a.skillAbilities[f],g=r({ruin:e,unrest:t,skillRank:i[f],abilityScores:o,leaders:l,kingdomLevel:c,untrainedProficiencyMode:u,ability:p,skillItemBonus:m?.[f],skill:f,additionalModifiers:d,activities:h}),y=(0,s.calculateModifiers)(g);return{skill:f,rank:i[f],ability:p,skillLabel:(0,n.capitalize)(f),abilityLabel:(0,n.capitalize)(p),total:y}}))}},7066:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.saveKingdom=t.getKingdom=void 0;const n=i(8593);function a(e){const t=e.getFlag("pf2e-kingmaker-tools","kingdom-sheet");return console.log(t),t}t.getKingdom=a,t.saveKingdom=async function(e,t){const i=a(e);!function(e){const t=e.ruin;void 0!==t&&(t.corruption.penalty=Math.abs(t.corruption.penalty),t.crime.penalty=Math.abs(t.crime.penalty),t.decay.penalty=Math.abs(t.decay.penalty),t.strife.penalty=Math.abs(t.strife.penalty))}(t),await async function(e,t){const i=e.milestones;if(void 0!==i){const a=t.milestones,s=(0,n.groupBy)(a,(e=>e.name)),r=(0,n.groupBy)(i,(e=>e.name));for(const i of s.keys()){const n=s.get(i)?.[0],a=r.get(i)?.[0];if(void 0!==a&&void 0!==n&&a.completed!==n.completed){const i=a.completed?a.xp:-a.xp,n=a.completed?"Gained":"Lost";await ChatMessage.create({content:`${n} ${Math.abs(i)} Kingdom XP`}),e.xp=t.xp+i}}}}(t,i),console.info("Saving",t),await e.setFlag("pf2e-kingmaker-tools","kingdom-sheet",t)}},9423:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.groupAvailableItems=t.calculateAvailableItems=t.evaluateStructures=t.includeCapital=t.getSettlementConfig=t.settlementTypeData=t.groupStructures=t.countStructureOccurrences=void 0;const n=i(8593),a=i(1154);function s(e){return t=e=>e.stacksWith??e.name,e.reduce(((e,i)=>{const n=t(i),a=(e.get(n)?.count??0)+1;return e.set(n,{count:a,item:i})}),new Map);var t}function r(e,t){const i=s(e);return Array.from(i.values()).map((e=>{const i=e.item,n={...i,skillBonusRules:i?.skillBonusRules?.map((i=>({...i,value:Math.min(i.value*e.count,t)}))),availableItemsRules:i?.availableItemsRules?.map((t=>{const i=void 0===t.maximumStacks?e.count:Math.min(e.count,t.maximumStacks),n=t.value*i;return{...t,value:n}})),settlementEventRules:i?.settlementEventRules?.map((i=>({...i,value:Math.min(i.value*e.count,t)}))),leadershipActivityRules:i?.leadershipActivityRules?.map((i=>({...i,value:Math.min(i.value*e.count,t)})))};return n}))}function o(e,t,i="never-stack"){const a=e.flatMap((e=>e.availableItemsRules??[])).filter((e=>e.group===t)).map((e=>e.value));return"always-stack"===i?(0,n.sum)(a):Math.max(...a,0)}function l(e,t){return e.map((e=>{const i=function(e,t){return e.flatMap((e=>{const i=e.activity;return(0,a.getActivitySkills)(t[i].skills).map((t=>({value:e.value,skill:t,activity:i})))}))}(e.activityBonusRules??[],t);return{...e,skillBonusRules:[...e.skillBonusRules??[],...i]}}))}function c(e){return{...t.settlementTypeData.find((t=>e>=t.levelFrom&&e<=(t.levelTo??Number.MAX_SAFE_INTEGER))),level:e}}function u(e,t){const i=e.value>t.value?e.value:t.value,a=(0,n.mergePartialObjects)(e.activities,t.activities,((e,t)=>Math.max(e??0,t??0))),s=Object.fromEntries(Object.entries(a).filter((([,e])=>(e??0)>i)));return{value:i,activities:s}}function m(e,t,i){const n={},a=e[t];return i.forEach((t=>{const i=e[t];i!==a&&(n[t]=i)})),n}t.countStructureOccurrences=s,t.groupStructures=r,t.settlementTypeData=[{type:"Village",consumption:1,influence:0,maximumLots:"1",requiredKingdomLevel:1,levelFrom:1,levelTo:1,maxItemBonus:1,population:"400 or less"},{type:"Town",consumption:2,influence:1,requiredKingdomLevel:3,maximumLots:"4",levelFrom:2,levelTo:4,maxItemBonus:1,population:"401-2000"},{type:"City",consumption:4,influence:2,requiredKingdomLevel:9,maximumLots:"9",levelFrom:5,levelTo:9,maxItemBonus:2,population:"2001–25000"},{type:"Metropolis",consumption:6,influence:3,maximumLots:"10+",requiredKingdomLevel:15,levelFrom:10,maxItemBonus:3,population:"25001+"}],t.getSettlementConfig=c,t.includeCapital=function(e,t){return{...t,increaseLeadershipActivities:e.increaseLeadershipActivities,unlockActivities:e.unlockActivities.concat(t.unlockActivities),leadershipActivityBonus:Math.max(e.leadershipActivityBonus,t.leadershipActivityBonus),skillBonuses:(0,n.mergeObjects)(e.skillBonuses,t.skillBonuses,u)}},t.evaluateStructures=function(e,t,i,n){const a=c(t),s=a.maxItemBonus,u=e.some((e=>!0===e.enableCapitalInvestment)),m=Array.from(new Set(e.flatMap((e=>e.notes??[])))),d=function(e){const t=new Map;return e.filter((e=>e.consumptionReduction)).forEach((e=>{const i=e.name,n=t.get(i),a=e?.consumptionReduction??0;(void 0===n||n<a)&&t.set(i,a)})),Array.from(t.values()).reduce(((e,t)=>e+t),0)}(e),h={config:a,allowCapitalInvestment:u,notes:m,skillBonuses:{agriculture:{value:0,activities:{}},arts:{value:0,activities:{}},boating:{value:0,activities:{}},defense:{value:0,activities:{}},engineering:{value:0,activities:{}},exploration:{value:0,activities:{}},folklore:{value:0,activities:{}},industry:{value:0,activities:{}},intrigue:{value:0,activities:{}},magic:{value:0,activities:{}},politics:{value:0,activities:{}},scholarship:{value:0,activities:{}},statecraft:{value:0,activities:{}},trade:{value:0,activities:{}},warfare:{value:0,activities:{}},wilderness:{value:0,activities:{}}},itemLevelBonuses:{divine:0,alchemical:0,primal:0,occult:0,arcane:0,magical:0,other:0,luxuryOccult:0,luxuryArcane:0,luxuryDivine:0,luxuryMagical:0,luxuryPrimal:0},settlementEventBonus:0,leadershipActivityBonus:0,storage:{ore:0,food:0,lumber:0,luxuries:0,stone:0},increaseLeadershipActivities:e.some((e=>!0===e.increaseLeadershipActivities)),consumptionReduction:d,consumption:Math.max(0,a.consumption-d),consumptionSurplus:Math.max(0,d-a.consumption),unlockActivities:[],residentialLots:e.filter((e=>e?.traits?.includes("residential"))).map((e=>e.lots??1)).reduce(((e,t)=>e+t),0),lots:e.map((e=>e.lots??1)).reduce(((e,t)=>e+t),0),hasBridge:e.some((e=>e.isBridge))},f=l(e,n);!function(e,t){t.filter((e=>e.storage)).forEach((t=>{["ore","lumber","food","stone","luxuries"].forEach((i=>{const n=t.storage;n&&i in n&&(e[i]+=n[i]??0)}))}))}(h.storage,e);const p=r(f,s),g="all-structures-stack"===i?function(e,t){const i=e.flatMap((e=>e.skillBonusRules??[])),n=i.filter((e=>e.activity)),a=i.filter((e=>!e.activity)),s=new Map;a.forEach((e=>{const i=s.get(e.skill)??0;s.set(e.skill,Math.min(t,i+e.value))}));const r=new Map;return n.forEach((e=>{const i=e.skill;r.set(i,r.get(i)??new Map);const n=e.activity,a=r.get(i)?.get(n)??0,s=Math.min(t,a+e.value);r.get(i)?.set(n,s)})),Array.from(r.keys()).forEach((e=>{const i=r.get(e)??new Map;Array.from(i.keys()).forEach((n=>{const a=i.get(n)??0,o=Math.min(t,a+(s.get(e)??0));r.get(e)?.set(n,o)}))})),e.map((e=>({...e,skillBonusRules:e.skillBonusRules?.map((e=>{const t=e.activity?r.get(e.skill)?.get(e.activity):s.get(e.skill);return{...e,value:t??0}}))})))}(p,s):p;return function(e,t){t.flatMap((e=>e?.unlockActivities??[])).forEach((t=>{e.push(t)}))}(h.unlockActivities,g),function(e,t){t.forEach((t=>{t.settlementEventRules?.forEach((t=>{t.value>e.settlementEventBonus&&(e.settlementEventBonus=t.value)}))}))}(h,g),function(e,t){t.forEach((t=>{t.leadershipActivityRules?.forEach((t=>{t.value>e.leadershipActivityBonus&&(e.leadershipActivityBonus=t.value)}))}))}(h,g),function(e,t){t.forEach((t=>{t.skillBonusRules?.forEach((t=>{const i=e[t.skill];t.activity||t.value>i.value&&(i.value=t.value)}))})),t.forEach((t=>{t.skillBonusRules?.forEach((t=>{const i=e[t.skill],n=t.activity;n&&t.value>i.value&&t.value>(i.activities[n]??0)&&(i.activities[n]=t.value)}))}))}(h.skillBonuses,g),function(e,t){const i=t.some((e=>!0===e.preventItemLevelPenalty))?0:-2,n=o(t,void 0,"always-stack"),a=o(t,"alchemical"),s=o(t,"luxury"),r=o(t,"magical"),l=o(t,"divine"),c=o(t,"primal"),u=o(t,"arcane"),m=o(t,"occult");e.other=n+i,e.alchemical=a+e.other,e.magical=r+e.other,e.divine=e.magical+l,e.primal=e.magical+c,e.arcane=e.magical+u,e.occult=e.magical+m,e.luxuryMagical=e.magical+s,e.luxuryOccult=e.occult+s,e.luxuryArcane=e.arcane+s,e.luxuryPrimal=e.primal+s,e.luxuryDivine=e.divine+s}(h.itemLevelBonuses,g),h},t.calculateAvailableItems=function(e,t,i=0){return{alchemical:e.alchemical+t,magical:e.magical+i+t,luxuryMagical:e.luxuryMagical+i+t,arcane:e.arcane+i+t,luxuryArcane:e.luxuryArcane+i+t,divine:e.divine+i+t,luxuryDivine:e.luxuryDivine+i+t,occult:e.occult+i+t,luxuryOccult:e.luxuryOccult+i+t,primal:e.primal+i+t,luxuryPrimal:e.luxuryPrimal+i+t,other:e.other+t}},t.groupAvailableItems=function(e){return{other:e.other,...m(e,"luxuryMagical",["luxuryArcane","luxuryDivine","luxuryOccult","luxuryPrimal"]),...m(e,"magical",["arcane","divine","occult","primal","luxuryMagical"]),...m(e,"other",["magical","alchemical"])}}},5897:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateEventXP=t.calculateRpXP=t.calculateHexXP=void 0,t.calculateHexXP=function({hexes:e,kingdomSize:t,useVK:i,xpPerClaimedHex:n}){return i?t<10?100*e:t<25?50*e:t<50?25*e:t<100?10*e:5*e:e*n},t.calculateRpXP=function({rp:e,kingdomLevel:t,rpToXpConversionRate:i,rpToXpConversionLimit:n,useVK:a}){let s=0;return a?t<5?s=10*e:t<9?s=7*e:t<13?s=5*e:t<17&&(s=2*e):s=e*i,Math.min(n,s)},t.calculateEventXP=function(e){const t={"-4":10,"-3":15,"-2":20,"-1":30,0:40,1:60,2:80,3:120,4:160},i=`${e}`;return i in t?t[i]:0}},6484:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showAwardXPDialog=t.resetHeroPoints=t.awardHeroPoints=void 0;const n=i(8593);async function a(e,t){new Dialog({title:"Award Party XP",content:'\n     <form>\n      <div class="form-group">\n       <label>Amount</label>\n       <input type="number" name="amount">\n      </div>\n     </form>\n     ',buttons:{cancel:{icon:'<i class="fas fa-times"></i>',label:"Cancel"},confirm:{icon:'<i class="fas fa-check"></i>',label:"Confirm",callback:async i=>{const a=i,s=(0,n.parseNumberInput)(a,"amount")||0;await async function(e,t,i){for(const e of t){const t=e.system.details.xp.value,n=e.system.details.xp.max,a=e.system.details.level.value,s=Math.floor((t+i)/n),r=(t+i)%n;await e.update({"system.details.xp.value":r,"system.details.level.value":a+s})}await ChatMessage.create({user:e?.user?.id,speaker:ChatMessage.getSpeaker(),content:`Players gained ${i} XP!`,type:CONST.CHAT_MESSAGE_TYPES.OTHER})}(e,t,s)}}},default:"confirm"}).render(!0,{jQuery:!1})}t.awardHeroPoints=async function(e){const t=e.actors?.contents?.filter((e=>"character"===e.type&&e.hasPlayerOwner))??[];new Dialog({title:"Award Hero Points",content:`<form class="simple-dialog-form">\n                <div>\n                    <label for="km-award-all">All</label>\n                    <input type="number" value="0" name="award-all" id="km-award-all">\n                </div>\n            ${t.map((e=>`<div>\n                    <label for="km-award-hero-point-${e.uuid}">${e.name}</label>\n                    <input type="number" value="0" name="${e.uuid}" id="km-award-hero-point-${e.uuid}">\n                </div>`)).join("\n")}\n        </form>`,buttons:{confirm:{icon:'<i class="fas fa-check"></i>',label:"Award",callback:async i=>{const a=i,s=(0,n.parseNumberInput)(a,"award-all"),r=t.map((e=>({actor:e,points:(0,n.parseNumberInput)(a,e.uuid)+s}))).filter((e=>e.points>0));r.length>0&&await async function(e,t){for(const e of t){const t=e.actor;await t.update({"system.resources.heroPoints.value":t.system.resources.heroPoints.value+e.points})}const i=`<p>Awarded Hero Points:</p><ul>${t.map((e=>`<li><b>${e.actor.name}</b>: ${e.points}</li>`)).join("\n")}</ul>`;await ChatMessage.create({user:e?.user?.id,speaker:ChatMessage.getSpeaker(),content:i,type:CONST.CHAT_MESSAGE_TYPES.OTHER})}(e,r)}}},default:"confirm"}).render(!0,{jQuery:!1,width:300})},t.resetHeroPoints=async function(e){const t=e.actors?.contents?.filter((e=>"character"===e.type&&e.hasPlayerOwner))??[];new Dialog({title:"Reset Hero Points to 1?",content:"",buttons:{cancel:{icon:'<i class="fas fa-times"></i>',label:"Cancel"},confirm:{icon:'<i class="fas fa-check"></i>',label:"Confirm",callback:async()=>{await async function(e,t){for(const e of t)await e.update({"system.resources.heroPoints.value":1});await ChatMessage.create({user:e?.user?.id,speaker:ChatMessage.getSpeaker(),content:"Reset hero point values to 1",type:CONST.CHAT_MESSAGE_TYPES.OTHER})}(e,t)}}},default:"confirm"}).render(!0,{jQuery:!1})},t.showAwardXPDialog=async function(e){const t=e?.actors?.contents?.filter((e=>"character"===e.type&&e.hasPlayerOwner))??[];await a(e,t)}},206:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.migrate=void 0;const n=i(7066),a=i(4310),s=i(1671),r=i(8593),o=i(9328),l=i(1687),c=i(1691),u=i(1048),m=i(5519),d=i(8049),h=i(8985),f=[new o.Migration2,new l.Migration3,new c.Migration4,new u.Migration5,new m.Migration6,new d.Migration7,new h.Migration8];t.migrate=async function(e,t,i){const o=(0,a.getNumberSetting)(e,"schemaVersion"),l=Math.max(1,...f.map((e=>e.version)));if((0,r.isFirstGm)(e)&&o<l){ui.notifications?.info("Running Kingmaker Tools Migrations, please do not close the window"),await async function(e){const t={version:e.currentVersion,camping:e.campingActor?(0,s.getCamping)(e.campingActor):null,kingdom:e.kingdomActor?(0,n.getKingdom)(e.kingdomActor):null};await(0,a.setSetting)(e.game,"latestMigrationBackup",JSON.stringify(t))}({game:e,kingdomActor:t,campingActor:i,currentVersion:o});const r=f.filter((e=>e.version>o));if(t){const i=(0,n.getKingdom)(t);for(const t of r)await t.migrateKingdom(e,i);await(0,n.saveKingdom)(t,i)}if(i){const t=(0,s.getCamping)(i);for(const i of r)await i.migrateCamping(e,t);await(0,s.saveCamping)(e,i,t)}for(const t of r)await t.migrateOther(e);await(0,a.setSetting)(e,"schemaVersion",l),ui.notifications?.info("Successfully migrated Kingmaker tools")}}},3026:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Migration=void 0;t.Migration=class Migration{version;constructor(e){this.version=e}async migrateKingdom(e,t){}async migrateCamping(e,t){}async migrateOther(e){}}},9328:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Migration2=void 0;const n=i(1155),a=i(3026);class Migration2 extends a.Migration{constructor(){super(2)}async migrateKingdom(e,t){if("number"==typeof t.fame&&"fameNext"in t&&"fameType"in t){const e=t;t.fame={now:e.fame,next:e?.fameNext??0,type:e?.fameType??"famous"}}t.milestones.some((e=>e.name.startsWith("Cult Event")))||(0,n.getCultEventMilestones)().forEach((e=>t.milestones.push(e))),void 0===t.supernaturalSolutions&&(t.supernaturalSolutions=0),void 0===t.turnsWithoutCultEvent&&(t.turnsWithoutCultEvent=0),void 0===t.creativeSolutions&&(t.creativeSolutions=0),void 0===t.modifiers&&(t.modifiers=[]),void 0===t.settlements&&(t.settlements=[],t.activeSettlement=""),t.settlements.forEach((e=>{e.level=parseInt(`${e.level}`,10),e.lots=parseInt(`${e.lots}`,10),e.waterBorders=parseInt(`${e.waterBorders}`,10)}))}async migrateCamping(e,t){void 0===t.increaseWatchActorNumber&&(t.increaseWatchActorNumber=0),void 0===t.actorUuidsNotKeepingWatch&&(t.actorUuidsNotKeepingWatch=[]),void 0===t.ignoreSkillRequirements&&(t.ignoreSkillRequirements=!1)}}t.Migration2=Migration2},1687:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Migration3=void 0;const n=i(3026),a=i(4310);class Migration3 extends n.Migration{constructor(){super(3)}async migrateOther(e){await(0,a.setSetting)(e,"kingdomEventsTable","Random Kingdom Events")}}t.Migration3=Migration3},1691:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Migration4=void 0;const n=i(3026);class Migration4 extends n.Migration{constructor(){super(4)}async migrateKingdom(e,t){t.activityBlacklist.push("take-charge"),t.activityBlacklist.push("reconnoiter-hex")}}t.Migration4=Migration4},1048:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Migration5=void 0;const n=i(3026);class Migration5 extends n.Migration{constructor(){super(5)}async migrateCamping(e,t){t.homebrewCampingActivities.forEach((e=>{e.criticalSuccess&&e.criticalSuccess.effectUuids&&this.migrateActivity(e.criticalSuccess.effectUuids),e.success&&e.success.effectUuids&&this.migrateActivity(e.success.effectUuids),e.failure&&e.failure.effectUuids&&this.migrateActivity(e.failure.effectUuids),e.criticalFailure&&e.criticalFailure.effectUuids&&this.migrateActivity(e.criticalFailure.effectUuids),e.effectUuids&&this.migrateActivity(e.effectUuids)}))}migrateActivity(e){e.forEach((e=>{"targetAll"in e&&(!1===e.targetAll?e.target="self":e.target="all",delete e.targetAll)}))}}t.Migration5=Migration5},5519:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Migration6=void 0;const n=i(3026),a=i(8593);class Migration6 extends n.Migration{constructor(){super(6)}async migrateKingdom(e,t){(0,a.isNullable)(t.homebrewActivities)&&(t.homebrewActivities=[])}}t.Migration6=Migration6},8049:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Migration7=void 0;const n=i(3026),a=i(8593);class Migration7 extends n.Migration{constructor(){super(7)}async migrateKingdom(e,t){(0,a.isNullable)(t.notes)&&(t.notes={public:"",gm:""})}}t.Migration7=Migration7},8985:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Migration8=void 0;const n=i(3026),a=i(8593);class Migration8 extends n.Migration{constructor(){super(8)}async migrateKingdom(e,t){(0,a.isNullable)(t.realmSceneId)&&(t.realmSceneId=null)}}t.Migration8=Migration8},9609:(e,t)=>{"use strict";function i(e){return e?.tables?.map((e=>e))??[]}function n(e){const t=i(e);return Object.fromEntries(t.map((e=>[`RollTable.${e.id}`,e.name])))}function a(e,t){return Object.entries(n(e)).filter((([e,i])=>i===t)).map((([e])=>e))[0]}async function s(e,t,i="pf2e-kingmaker-tools.kingmaker-tools-rolltables"){return(await r(e,i))[t]}async function r(e,t="pf2e-kingmaker-tools.kingmaker-tools-rolltables"){const i=await e.packs.get(t,{strict:!0}),n=await i.getDocuments({});return Object.fromEntries(n.map((e=>[e.name,`Compendium.${t}.${e.id}`])))}Object.defineProperty(t,"__esModule",{value:!0}),t.buildUuids=t.rollRollTable=t.findCompendiumTableUuid=t.findWorldTableUuid=t.getWorldTableUuidMappings=t.getWorldTables=t.findRollTableUuidWithFallback=void 0,t.findRollTableUuidWithFallback=async function(e,t,i="pf2e-kingmaker-tools.kingmaker-tools-rolltables"){const n=a(e,t),r=await s(e,t,i);return console.log(`Looking up ${t} in ${i}, world: ${n}, compendium: ${r}`),n??r},t.getWorldTables=i,t.getWorldTableUuidMappings=n,t.findWorldTableUuid=a,t.findCompendiumTableUuid=s,t.rollRollTable=async function(e,t,i){const n=await fromUuid(t);if(n&&n instanceof RollTable)return{table:n,draw:await n.draw(i)};throw new Error(`Could not find table with uuid ${t}`)},t.buildUuids=r},4310:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setSetting=t.getBooleanSetting=t.getStringArraySetting=t.getStringSetting=t.getNumberSetting=t.getRollMode=void 0;const i="pf2e-kingmaker-tools";function n(e,t){return e.settings.get(i,t)??""}t.getRollMode=function(e,t){return n(e,t)??"publicroll"},t.getNumberSetting=function(e,t){return e.settings.get(i,t)??0},t.getStringSetting=n,t.getStringArraySetting=function(e,t){return e.settings.get(i,t)??[]},t.getBooleanSetting=function(e,t){return e.settings.get(i,t)??!1},t.setSetting=async function(e,t,n){await e.settings.set(i,t,n)}},8659:(e,t)=>{"use strict";async function i(e,t,i=void 0){const n=void 0===i?void 0:{value:i};for(const i of e){const e="perception"===t?i.perception:i.skills[t];await e.roll({rollMode:"gmroll",dc:n})}}Object.defineProperty(t,"__esModule",{value:!0}),t.rollSkillDialog=t.rollExplorationSkillCheck=void 0,t.rollExplorationSkillCheck=async function(e,t,n,a=void 0){const s=e.actors?.filter((e=>("character"===e.type||"familiar"===e.type)&&e.hasPlayerOwner&&function(e){const t=(e.system.exploration??[]).map((t=>e.items.get(t)?.name)).filter((e=>null!=e));return new Set(t)}(e).has(n)))??[];"Search"===n&&"perception"===t?e.pf2e.actions.get("seek")?.use({actors:s}):"Avoid Notice"===n&&"stealth"===t?e.pf2e.actions.get("avoid-notice")?.use({actors:s}):await i(s,t,a)},t.rollSkillDialog=async function(e){new Dialog({title:"Roll Skill for PCs",content:'\n    <div style="display: table; border-spacing: 10px">\n        <div style="display: table-row">\n            <label style="display: table-cell">Skill</label> \n            <select name="skill" style="display: table-cell">\n                <option value="perception">Perception</option>\n                <option value="nature">Nature</option>\n                <option value="survival">Survival</option>\n            </select>\n        </div>\n        <div style="display: table-row">\n            <label style="display: table-cell">DC</label>\n            <input name="dc" type="number" value="0" style="display: table-cell">\n        </div>\n    </div>\n    ',buttons:{roll:{icon:'<i class="fa-solid fa-dice-d20"></i>',label:"Roll",callback:async t=>{const n=t,a=n.querySelector("select[name=skill]"),s=n.querySelector("input[name=dc]"),r=a.value,o=parseInt(s.value,10);await i(e,r,o)}}},default:"roll"},{jQuery:!1}).render(!0,{width:200})}},2816:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.formatHours=t.toTimeOfDayMacro=void 0;const n=i(1631),a=i(8565);function s(e){return`<form>\n        <input type="time" value="${e}">\n    </form>`}async function r(e,t,i){const s=t.querySelector("input[type=time]"),r=a.DateTime.fromFormat(s.value,"HH:mm"),o=(0,n.getWorldTime)(e),l=new n.TimeOfDay({hour:r.hour,minute:r.minute,second:r.second}).diffSeconds(o,i);await e.time.advance(l),localStorage.setItem("kingmaker-tools.time-input",s.value)}t.toTimeOfDayMacro=async function(e){const t=localStorage.getItem("kingmaker-tools.time-input")??"00:00";new Dialog({title:"Advance/Retract to Time of Day",content:s(t),buttons:{retract:{icon:'<i class="fa-solid fa-backward"></i>',label:"Retract",callback:async t=>{await r(e,t,n.TimeChangeMode.RETRACT)}},advance:{icon:'<i class="fa-solid fa-forward"></i>',label:"Advance",callback:async t=>{await r(e,t,n.TimeChangeMode.ADVANCE)}}},default:"yes"},{jQuery:!1}).render(!0)},t.formatHours=function(e,t=!1){const i=e=>`${e}`.padStart(2,"0"),n=Math.floor(e/3600),a=Math.floor(e%3600/60);return`${t?"-":""}${i(n)}:${i(a)}`}},1631:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDayOrNight=t.getTimeOfDayPercent=t.TimeOfDay=t.TimeOfYear=t.TimeUnit=t.getWorldTime=t.TimeChangeMode=void 0;const n=i(8565);var a;!function(e){e[e.ADVANCE=0]="ADVANCE",e[e.RETRACT=1]="RETRACT"}(a||(t.TimeChangeMode=a={})),t.getWorldTime=function(e){const t=e.settings.get("pf2e","worldClock.worldCreatedOn");return n.DateTime.fromISO(t).toUTC().plus({seconds:e.time.worldTime})};t.TimeUnit=class TimeUnit{unit;constructor(e){this.unit=e}diffSeconds(e,t){return(t==a.ADVANCE?e.plus(this.unit):e.minus(this.unit)).diff(e,"seconds").seconds}};t.TimeOfYear=class TimeOfYear{year;month;day;hour;minute;second;constructor({year:e,month:t,day:i,hour:n=0,minute:a=0,second:s=0}){this.year=e,this.month=t,this.day=i,this.hour=n,this.minute=a,this.second=s}diffSeconds(e){return n.DateTime.fromObject({year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}).diff(e,"seconds").seconds}};class TimeOfDay{hour;minute;second;constructor({hour:e=0,minute:t=0,second:i=0}){this.hour=e,this.minute=t,this.second=i}static DAWN=new TimeOfDay({hour:4,minute:58,second:54});static NOON=new TimeOfDay({hour:12,minute:0,second:0});static DUSK=new TimeOfDay({hour:18,minute:34,second:6});static MIDNIGHT=new TimeOfDay({hour:0,minute:0,second:0});diffSeconds(e,t){const i=e.set({hour:this.hour,minute:this.minute,second:this.second}),n=TimeOfDay.diffDays(e,i,t);return e.plus({day:n}).set(this).diff(e,"seconds").seconds}static diffDays(e,t,i){return e>=t&&i===a.ADVANCE?1:e<=t&&i===a.RETRACT?-1:0}}t.TimeOfDay=TimeOfDay,t.getTimeOfDayPercent=function(e){const t=e.second+30*e.minute+3600*e.hour;return Math.floor(t/864)},t.isDayOrNight=function(e){return e.hour>=6&&e.hour<18?"day":"night"}},1917:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.formatWorldTime=t.formatWorldDateTime=t.calculateYear=void 0;const n=i(8565),a={AR:{yearOffset:2700,Era:"AR",Months:{January:"Abadius",February:"Calistril",March:"Pharast",April:"Gozran",May:"Desnus",June:"Sarenith",July:"Erastus",August:"Arodus",September:"Rova",October:"Lamashan",November:"Neth",December:"Kuthona"},Weekdays:{Monday:"Moonday",Tuesday:"Toilday",Wednesday:"Wealday",Thursday:"Oathday",Friday:"Fireday",Saturday:"Starday",Sunday:"Sunday"}}},s=new Intl.PluralRules("en-US",{type:"ordinal"}),r=new Map([["one","st"],["two","nd"],["few","rd"],["other","th"]]);function o(e,t){return e.year+a[t].yearOffset}t.calculateYear=o,t.formatWorldDateTime=function(e,t){const i=a[t],n=new Map(Object.entries(i.Weekdays)).get(e.weekdayLong),l=new Map(Object.entries(i.Months)).get(e.monthLong),c=o(e,t),u=e.toFormat("hh:mm:ss"),m=i.Era;return`${n}, ${function(e){const t=s.select(e);return`${e}${r.get(t)}`}(e.day)} of ${l}, ${c} ${m} (${u})`},t.formatWorldTime=function(e){return e.toLocaleString({...n.DateTime.TIME_24_SIMPLE})}},8593:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rollModeChoices=t.decodeJson=t.encodeJson=t.splitByWhitespace=t.isNullable=t.isNonNullable=t.sum=t.isKingmakerInstalled=t.blankToUndefined=t.isBlank=t.isNotBlank=t.slugifyable=t.usableInForms=t.deCamelCase=t.camelCase=t.clamped=t.parseCheckbox=t.parseRadio=t.parseSelect=t.parseNullableSelect=t.parseNumberSelect=t.parseTextArea=t.parseTextInput=t.parseNumberInput=t.createLabels=t.listenClick=t.createLabel=t.distinctBy=t.groupBySingle=t.groupBy=t.range=t.mergePartialObjects=t.mergeObjects=t.unslugify=t.loreToLoreSkill=t.slugify=t.isSlug=t.unpackFormArray=t.uncapitalize=t.capitalize=t.postDegreeOfSuccessMessage=t.roll=t.createUUIDLink=t.getSelectedCharacter=t.getLevelBasedDC=t.isFirstGm=t.escapeHtml=t.addOf=void 0;const n=i(8063);function a(e,t=!1){return e===n.DegreeOfSuccess.CRITICAL_SUCCESS?`<span class="${t?"strike-through":""}">Critical Success</span>`:e===n.DegreeOfSuccess.SUCCESS?`<span class="${t?"strike-through":""}">Success</span>`:e===n.DegreeOfSuccess.FAILURE?`<span class="${t?"strike-through":""}">Failure</span>`:`<span class="${t?"strike-through":""}">Critical Failure</span>`}function s(e){return e[0].toUpperCase()+e.substring(1)}function r(e){return e[0].toLowerCase()+e.substring(1)}function o(e){return e.trim().replaceAll(" ","-").toLowerCase()}function l(e){return e.replaceAll("action:","").split("-").map((e=>s(e))).join(" ")}function c(e,t=!1){return{label:t?l(e):s(e),value:e}}function u(e,t){return e.querySelector(`select[name="${t}"]`).value}function m(e){return!d(e)}function d(e){return null==e||0===e.trim().length}function h(e){return null!=e}t.addOf=function(e){return e.endsWith("s")?e+"'":e+"'s"},t.escapeHtml=function(e){const t=document.createTextNode(e),i=document.createElement("p");return i.appendChild(t),i.innerHTML},t.isFirstGm=function(e){return e?.user?.id===e.users?.find((e=>e.isGM&&e.active))?.id},t.getLevelBasedDC=function(e){return 14+e+Math.floor(e/3)},t.getSelectedCharacter=function(e){return e.user?.character},t.createUUIDLink=function(e,t){return void 0===t?`@UUID[${e}]`:`@UUID[${e}]{${t}}`},t.roll=async function(e,t){const i=await new Roll(e).evaluate();return await i.toMessage({flavor:t}),i.total},t.postDegreeOfSuccessMessage=async function({degreeOfSuccess:e,upgradedDegreeOfSuccess:t,messageConfig:i,beforeHeader:s}){const r=function(e,t){return void 0===t?`<b>${a(e)}</b>`:`<b>${a(e,!0)} ${a(t)}</b>`}(e,t),o=t??e;let l="";o===n.DegreeOfSuccess.CRITICAL_SUCCESS&&void 0!==i.critSuccess?l=`${i.critSuccess}`:o===n.DegreeOfSuccess.SUCCESS&&void 0!==i.success?l=`${i.success}`:o===n.DegreeOfSuccess.FAILURE&&void 0!==i.failure?l=`${i.failure}`:o===n.DegreeOfSuccess.CRITICAL_FAILURE&&void 0!==i.critFailure&&(l=`${i.critFailure}`);const c=(s??"")+[r,l].filter((e=>m(e))).join(": ");m(c)&&await ChatMessage.create({type:CONST.CHAT_MESSAGE_TYPES.ROLL,content:c.trimEnd(),rollMode:i.isPrivate?"blindroll":"publicroll"})},t.capitalize=s,t.uncapitalize=r,t.unpackFormArray=function(e){return e?Object.keys(e).map((e=>parseInt(e,10))).sort(((e,t)=>e-t)).map((e=>`${e}`)).map((t=>e[t])):[]},t.isSlug=function(e){return/^([a-zA-Z0-9]+)(-[a-zA-Z0-9]+)*$/.test(e)},t.slugify=o,t.loreToLoreSkill=function(e){return o(e.replace(/\s[lL]ore$/,""))},t.unslugify=l,t.mergeObjects=function(e,t,i){const n=[];for(const a of[...Object.keys(e),...Object.keys(t)])a in e&&a in t?n.push([a,i(e[a],t[a])]):a in e?n.push([a,e[a]]):a in t&&n.push([a,t[a]]);return Object.fromEntries(n)},t.mergePartialObjects=function(e,t,i){const n=[];for(const a of[...Object.keys(e),...Object.keys(t)])a in e&&a in t?n.push([a,i(e[a],t[a])]):a in e?n.push([a,e[a]]):a in t&&n.push([a,t[a]]);return Object.fromEntries(n)},t.range=function(e,t){const i=[];for(let n=e;n<t;n+=1)i.push(n);return i},t.groupBy=function(e,t){const i=new Map;for(const n of e){const e=t(n),a=i.get(e);a?a.push(n):i.set(e,[n])}return i},t.groupBySingle=function(e,t){return new Map(e.map((e=>[t(e),e])))},t.distinctBy=function(e,t){const i=new Set,n=[];for(const a of e){const e=t(a);i.has(e)||(n.push(a),i.add(e))}return n},t.createLabel=c,t.listenClick=function(e,t,i){e.querySelectorAll(t).forEach((e=>{e.addEventListener("click",(async e=>await i(e)))}))},t.createLabels=function(e,t=!1){return e.map((e=>c(e,t)))},t.parseNumberInput=function(e,t){const i=e.querySelector(`input[name="${t}"]`);return parseInt(i.value,10)},t.parseTextInput=function(e,t){const i=e.querySelector(`input[name="${t}"]`);return i.value?.trim()},t.parseTextArea=function(e,t){const i=e.querySelector(`textarea[name="${t}"]`);return i.value?.trim()},t.parseNumberSelect=function(e,t){const i=e.querySelector(`select[name="${t}"]`);return parseInt(i.value,10)},t.parseNullableSelect=function(e,t){const i=u(e,t);return"-"===i?void 0:i},t.parseSelect=u,t.parseRadio=function(e,t){const i=Array.from(e.querySelectorAll(`input[name="${t}"]`));return i.find((e=>e.checked))?.value??null},t.parseCheckbox=function(e,t){return e.querySelector(`input[name="${t}"]`).checked},t.clamped=function(e,t,i){return Math.min(Math.max(e,t),i)},t.camelCase=function(e){return r(e.trim().split(" ").map((e=>s(e))).join(""))},t.deCamelCase=function(e){const t=e.trim();return""===t?"":t.replace(/([a-z])([A-Z])/g,"$1 $2").split(" ").map(s).join(" ")},t.usableInForms=function(e){return/^[^'"<>\\]+$/.test(e)},t.slugifyable=function(e){return/^([a-zA-Z0-9]*)(\s[a-zA-Z0-9]*)*$/.test(e)},t.isNotBlank=m,t.isBlank=d,t.blankToUndefined=function(e){if(!d(e))return e},t.isKingmakerInstalled=function(e){return!0===e.modules.get("pf2e-kingmaker")?.active},t.sum=function(e){return e.reduce(((e,t)=>e+t),0)},t.isNonNullable=h,t.isNullable=function(e){return!h(e)},t.splitByWhitespace=function(e){return e.split(/\s+/)},t.encodeJson=function(e){return btoa(JSON.stringify(e))},t.decodeJson=function(e){return JSON.parse(atob(e))},t.rollModeChoices={publicroll:"Public Roll",gmroll:"Private GM Roll",blindroll:"Blind GM Roll",selfroll:"Self Roll"}},6063:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setWeatherSettings=t.getWeatherSettings=t.allWeatherNames=void 0,t.allWeatherNames=["snow","rain","sunny","leaves","rainStorm","fog","blizzard",""],t.getWeatherSettings=function(e){const t=e.getFlag("pf2e-kingmaker-tools","weather");return{syncWeather:t?.syncWeather??!0,syncWeatherPlaylist:t?.syncWeatherPlaylist??!0}},t.setWeatherSettings=async function(e,t){await e.setFlag("pf2e-kingmaker-tools","weather",t)}},4687:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sceneWeatherSettingsDialog=void 0;const n=i(8593),a=i(6063);t.sceneWeatherSettingsDialog=function(e,t){const{syncWeather:i,syncWeatherPlaylist:s}=(0,a.getWeatherSettings)(t);new Dialog({title:"Scene Weather Settings",content:`\n        <form class="simple-dialog-form">\n            <div>\n                <label for="km-sync-weather">Sync Weather</label>\n                <input type="checkbox" name="sync-weather" id="km-sync-weather" ${i?"checked":""}>\n            </div>\n            <div>\n                <label for="km-sync-weather-playlist">Sync Weather Playlist</label>\n                <input type="checkbox" name="sync-weather-playlist" id="km-sync-weather-playlist" ${s?"checked":""}>\n            </div>\n        </form>\n        `,buttons:{save:{icon:'<i class="fa-solid fa-save"></i>',label:"Save",callback:async e=>{const i=e,s=(0,n.parseCheckbox)(i,"sync-weather"),r=(0,n.parseCheckbox)(i,"sync-weather-playlist");await(0,a.setWeatherSettings)(t,{syncWeather:s,syncWeatherPlaylist:r})}}},default:"save"},{jQuery:!1,width:250}).render(!0)}},6993:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setCurrentWeatherDialog=void 0;const n=i(4310),a=i(8593),s=i(4533),r=i(6063);t.setCurrentWeatherDialog=function(e){const t=(0,n.getStringSetting)(e,"currentWeatherFx"),i=r.allWeatherNames.map((e=>({label:(0,a.deCamelCase)(e),value:e})));new Dialog({title:"Set Weather",content:`\n        <form class="simple-dialog-form">\n            <div>\n                <label for="km-weather">Weather</label>\n                <select name="weather" id="km-weather">\n                    ${i.map((e=>`<option value="${e.value}" ${t===e.value?"selected":""}>${e.label}</option>`)).join("")}                \n                </select>\n            </div>\n        </form>\n        `,buttons:{save:{icon:'<i class="fa-solid fa-save"></i>',label:"Save",callback:async t=>{const i=t,n=(0,a.parseSelect)(i,"weather");await(0,s.setWeather)(e,n)}}},default:"save"},{jQuery:!1,width:250}).render(!0)}},7458:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rollKingmakerWeather=void 0;const n=i(4310),a=i(9609),s=i(4533),r=i(9540);async function o(e,t,i,n,s){const l=await(0,a.buildUuids)(e),{table:u,draw:m}=await(0,a.rollRollTable)(e,l["Weather Events"],{rollMode:n,displayChat:!1}),{results:d}=m,h=d[0].text;(Array.from(r.eventLevels.entries()).filter((([e])=>h.startsWith(e))).map((([e,t])=>t))[0]??0)>t+i?(console.info(`Re-rolling event, level ${h.level} is more than ${i} levels higher than party level ${t}`),await o(e,t,i,n,s)):(await u.toMessage(d,{roll:m.roll,messageOptions:{rollMode:n}}),s&&await c("Choose a second weather event!",n))}async function l(e,t,i){const n=await new Roll("1d20").evaluate({async:!0}),a=n.total>=e;return await n.toMessage({flavor:t},{rollMode:i}),{isSuccess:a,total:n.total}}async function c(e,t){await ChatMessage.create({content:e,type:CONST.CHAT_MESSAGE_TYPES.ROLL,rollMode:t})}t.rollKingmakerWeather=async function(e){const t=(0,n.getRollMode)(e,"weatherRollMode"),i=e?.actors?.find((e=>"party"===e.type))?.members?.filter((e=>"character"===e.type))?.map((e=>e.level))??[],a=Math.max(...i,1),u=(0,n.getNumberSetting)(e,"weatherHazardRange");await async function(e,t,i,n){const a=r.golarionMonths.get(e.pf2e.worldClock.worldTime.month),{precipitationDC:u,coldDC:m}=(0,r.getSeason)(a),d=(await l(u,`Checking for precipitation in ${a} on a DC of ${u}`,n)).isSuccess;let h;if(void 0!==m){const t=(await l(m,`Checking for mild cold in ${a} on a DC of ${m}`,n)).isSuccess;t&&d?(await(0,s.setWeather)(e,"snow"),h="Weather: Cold & Snowing"):t?(await(0,s.setWeather)(e,"sunny"),h="Weather: Cold"):d?(await(0,s.setWeather)(e,"rain"),h="Weather: Rainy"):(await(0,s.setWeather)(e,"sunny"),h="Weather: Sunny")}else d?(await(0,s.setWeather)(e,"rain"),h="Weather: Rainy"):(await(0,s.setWeather)(e,"sunny"),h="Weather: Sunny");await async function(e,t,i,n){const{isSuccess:a,total:s}=await l(17,"Rolling for weather event with DC 17",n);20===s?await o(e,t,i,n,!0):a&&await o(e,t,i,n,!1)}(e,t,i,n),await c(h,n)}(e,a,u,t)}},4533:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onRenderScene=t.onUpdateScene=t.onPreUpdateScene=t.toggleWeather=t.toggleSheltered=t.setWeather=t.dayHasChanged=void 0;const n=i(4310),a=i(6063),s=i(8593),r=new Map;function o(e,t){const i=e.playlists?.getName(`weather.${t}`),n=r.get(t);return(0,s.isKingmakerInstalled)(e)&&void 0===i&&void 0!==n?e?.playlists?.filter((e=>e._source._id===n.playlistSourceId))?.map((e=>e.sounds.getName(n.soundName)))?.[0]:i}async function l(e,t){await async function(e,t){const i=a.allWeatherNames.filter((e=>""!==e&&e!==t)).map((t=>o(e,t))).filter((e=>void 0!==e&&e.playing));for(const e of i)e instanceof Playlist?await e.stopAll():await(e?.update({playing:!1}))}(e,t),await async function(e,t){if(""!==t){const i=o(e,t);void 0===i||i.playing||(i instanceof Playlist?await i.playAll():await i.update({playing:!0}))}}(e,t)}function c(e,t){if(t&&(0,a.getWeatherSettings)(t).syncWeather){const t=(0,n.getBooleanSetting)(e,"enableSheltered")?"":(0,n.getStringSetting)(e,"currentWeatherFx");if("sunny"===t)return"";if(a.allWeatherNames.includes(t))return t}return null}async function u(e,t){const i=await c(e,t);t&&null!==i&&(console.info(`Setting scene ${t.name} weather to '${i}'`),await(t?.update({weather:i})))}async function m(e,t){const i=function(e,t){return t&&(0,a.getWeatherSettings)(t).syncWeatherPlaylist?t.weather||((0,n.getBooleanSetting)(e,"enableSheltered")?"":"sunny"):""}(e,t);console.info(`Setting weather playlist to to ${i}`),(0,n.getBooleanSetting)(e,"enableWeatherSoundFx")&&await l(e,i)}async function d(e){if((0,s.isFirstGm)(e)&&(0,n.getBooleanSetting)(e,"enableWeather")){const t=e.scenes?.current,i=e.scenes?.active;i&&t&&i.id===t.id||await u(e,t),await u(e,i),await m(e,i)}}r.set("rain",{playlistSourceId:"c6WJzHWMM72zP19H",soundName:"Rain"}),r.set("snow",{playlistSourceId:"c6WJzHWMM72zP19H",soundName:"Cold Wind"}),r.set("blizzard",{playlistSourceId:"c6WJzHWMM72zP19H",soundName:"Colder Wind"}),r.set("rainStorm",{playlistSourceId:"c6WJzHWMM72zP19H",soundName:"Thunderstorm"}),t.dayHasChanged=function(e,t){const i=e.pf2e.worldClock.worldTime,n=i.minus({second:t});return i.day!==n.day||i.month!==n.month||i.year!==n.year},t.setWeather=async function(e,t){await e.settings.set("pf2e-kingmaker-tools","currentWeatherFx",t),await d(e)},t.toggleSheltered=async function(e){const t=!(0,n.getBooleanSetting)(e,"enableSheltered");await e.settings.set("pf2e-kingmaker-tools","enableSheltered",t),await d(e)},t.toggleWeather=async function(e){const t=!(0,n.getBooleanSetting)(e,"enableWeather");await e.settings.set("pf2e-kingmaker-tools","enableWeather",t),await d(e)},t.onPreUpdateScene=async function(e,t,i){if((0,s.isFirstGm)(e)&&(0,n.getBooleanSetting)(e,"enableWeather")&&i?.active){const n=c(e,t);null!==n&&(i.weather=n)}},t.onUpdateScene=async function(e,t,i){(0,s.isFirstGm)(e)&&(0,n.getBooleanSetting)(e,"enableWeather")&&i?.active&&await m(e,t)},t.onRenderScene=async function(e){}}},t={};function i(n){var a=t[n];if(void 0!==a)return a.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,i),s.exports}(()=>{"use strict";const e=i(4533),t=i(4687),n=i(6993),a=i(8593),s=i(2816),r=i(4310),o=i(7458),l=i(8659),c=i(4024),u=i(5682),m=i(1949),d=i(7066),h=i(6623),f=i(1573),p=i(220),g=i(518),y=i(2784),v=i(695),b=i(1671),k=i(6484),w=i(2761),S=i(1060),C=i(3998),A=i(206),x=i(2293),R=i(1252),I=i(4848),D=i(6326),T=i(5814);function M(e){return e?.actors?.find((e=>"Kingdom Sheet"===e.name))}function _(e,t,i){const n=M(e);n?i(n):ui.notifications?.error("Could not find actor with name Kingdom Sheet")}Hooks.on("ready",(async()=>{if(game instanceof Game){const i=game;i.pf2eKingmakerTools={macros:{toggleWeatherMacro:e.toggleWeather.bind(null,game),realmTileDialogMacro:T.realmTileDialog.bind(null,game),toggleShelteredMacro:e.toggleSheltered.bind(null,game),setCurrentWeatherMacro:n.setCurrentWeatherDialog.bind(null,game),structureTokenMappingMacro:D.structureTokenMappingDialog.bind(null,game),sceneWeatherSettingsMacro:()=>{const e=i?.scenes?.current;e&&(0,t.sceneWeatherSettingsDialog)(i,e)},toTimeOfDayMacro:s.toTimeOfDayMacro.bind(null,game),toggleCombatTracksMacro:async()=>{const e=(0,r.getBooleanSetting)(i,"enableCombatTracks");await(0,C.stopCombat)(i,i.combat),await(0,r.setSetting)(i,"enableCombatTracks",!e)},setSceneCombatPlaylistDialogMacro:async e=>{const t=i.scenes?.current;e?await(0,C.showSetSceneCombatPlaylistDialog)(i,e):t&&await(0,C.showSetSceneCombatPlaylistDialog)(i,t)},kingdomEventsMacro:c.rollKingdomEvent.bind(null,game),rollKingmakerWeatherMacro:o.rollKingmakerWeather.bind(null,game),viewKingdomMacro:u.showKingdom.bind(null,game),awardXpMacro:k.showAwardXPDialog.bind(null,game),resetHeroPointsMacro:k.resetHeroPoints.bind(null,game),awardHeroPointsMacro:k.awardHeroPoints.bind(null,game),editArmyStatisticsMacro:e=>(0,p.editArmyStatistics)(i,e),openCampingSheet:()=>(0,g.openCampingSheet)(i),rollExplorationSkillCheck:async(e,t)=>{await(0,l.rollExplorationSkillCheck)(i,e,t)},rollSkillDialog:async()=>{const e=(0,r.getStringSetting)(i,"skillCheckMacroCharacterNames")?.split("||")?.map((e=>e.trim()))?.filter((e=>""!==e))??[];if(0===e.length)ui?.notifications?.error("No actor names configured! Configure actor names first in settings");else{const t=new Set(e),n=i?.actors?.filter((e=>("character"===e.type||"familiar"===e.type)&&null!==e.name&&t.has(e.name)))??[];await(0,l.rollSkillDialog)(n)}},editStructureMacro:async e=>{void 0===e?ui.notifications?.error("Please select an actor"):(console.log(e),await(0,m.showStructureEditDialog)(i,e.token.baseActor))}}},i.settings.register("pf2e-kingmaker-tools","showManual",{name:"Show Manual",scope:"world",config:!1,default:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","enableCombatTracks",{name:"Enable Combat Tracks",hint:'If enabled, starts a combat track depending on the current region, actor or scene. Region combat tracks have to be named after the region, e.g. "Kingmaker.Rostland Hinterlands"; "Kingmaker.Default" is played if no region playlist is found instead',scope:"world",config:!0,default:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","enableWeather",{name:"Enable Weather",default:!0,config:!0,type:Boolean,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","enableWeatherSoundFx",{name:"Enable Weather Sound Effects",default:!0,config:!0,type:Boolean,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","enableSheltered",{name:"Enabled Sheltered",default:!1,config:!1,type:Boolean,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","autoRollWeather",{name:"Automatically roll Weather",hint:"When a new day begins (00:00), automatically roll weather",default:!0,config:!0,type:Boolean,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","weatherRollMode",{name:"Weather Roll Mode",scope:"world",config:!0,default:"gmroll",type:String,choices:a.rollModeChoices}),i.settings.register("pf2e-kingmaker-tools","forceEnabledCompanionLeadershipBenefits",{name:"Force Enabled Companion Leadership Benefits",scope:"world",config:!1,default:[],type:Array}),i.settings.register("pf2e-kingmaker-tools","weatherHazardRange",{name:"Weather Hazard Range",hint:"Maximum Level of Weather Event that can occur. Added to Average Party Level.",default:4,config:!0,type:Number,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","rpToXpConversionRate",{default:1,config:!1,type:Number,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","rpToXpConversionLimit",{default:120,config:!1,type:Number,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","xpPerClaimedHex",{default:10,config:!1,type:Number,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","cultOfTheBloomEvents",{default:!0,config:!1,type:Boolean,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","autoCalculateSettlementLevel",{default:!0,config:!1,type:Boolean,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","currentWeatherFx",{name:"Current Weather FX",hint:"Based on the current value of the roll table",scope:"world",config:!1,default:"sunny",type:String}),i.settings.register("pf2e-kingmaker-tools","proxyEncounterTable",{name:"Proxy Random Encounter Table",hint:'Name of the in world roll table that is rolled first to check what kind of encounter is rolled. Use the string "Creature" to roll on the region roll table in the proxy roll table or link another roll table of your choice. Leave blank to always roll on the region random encounter tables.',scope:"world",config:!1,default:"",type:String}),i.settings.register("pf2e-kingmaker-tools","randomEncounterRollMode",{name:"Random Encounter Roll Mode",scope:"world",config:!1,default:"gmroll",type:String,choices:a.rollModeChoices}),i.settings.register("pf2e-kingmaker-tools","skillCheckMacroCharacterNames",{name:"Skill Check Macro Character Names",hint:"A string of character names separated by ||, e.g. Jake||John||The Undertaker",scope:"world",config:!0,default:"",type:String}),i.settings.register("pf2e-kingmaker-tools","kingdomEventRollMode",{name:"Kingdom Events Roll Mode",scope:"world",config:!1,default:"gmroll",type:String,choices:a.rollModeChoices}),i.settings.register("pf2e-kingmaker-tools","kingdomEventsTable",{name:"Kingdom Events Table Name",scope:"world",config:!1,default:"Random Kingdom Events",type:String}),i.settings.register("pf2e-kingmaker-tools","kingdomCultTable",{name:"Kingdom Cult Events Table Name",scope:"world",config:!1,default:"Random Cult Events",type:String}),i.settings.register("pf2e-kingmaker-tools","vanceAndKerensharaXP",{name:"Enable Vance and Kerenshara XP rules",hint:"Adds additional Milestone Events, more XP for claiming hexes and RP",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","capitalInvestmentInCapital",{name:"Enable Capital Investment without Bank in Capital",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","reduceDCToBuildLumberStructures",{name:"Reduce DC to Build Lumber Structures",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","automateResources",{name:"Automatically sum worksites and farmlands",scope:"world",config:!1,default:"kingmaker",requiresReload:!0,type:String,choices:{kingmaker:"Kingmaker",tileBased:"Tile Based",manual:"Manual"}}),i.settings.register("pf2e-kingmaker-tools","kingdomAlwaysAddHalfLevel",{name:"Always add half Level to Skill",hint:"If enabled, always adds half of the kingdom's level to a skill, even if it is untrained",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","kingdomAlwaysAddLevel",{name:"Always add Level to Skill",hint:"If enabled, always adds the kingdom's level to a skill, even if it is untrained. Overrides Always add half Level to Skill",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","kingdomSkillIncreaseEveryLevel",{name:"Double Skill Increases",hint:"If enabled, adds Skill Increases for all even levels from level 2 onwards",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","kingdomAllStructureItemBonusesStack",{name:"All Structure Item Bonuses Stack",hint:"If enabled, groups item bonuses from all structures, regardless of if they are same building type",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","kingdomIgnoreSkillRequirements",{name:"Ignore Skill Proficiency Requirements for Kingdom Activities",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","autoCalculateArmyConsumption",{name:"Automatically Calculate Army Consumption",hint:"If enabled, gets all visible army tokens on all scenes and sums up their consumption",scope:"world",config:!1,default:!0,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","schemaVersion",{name:"Schema Version",default:1,config:!1,type:Number,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","latestMigrationBackup",{name:"Schema Version",default:"",config:!1,type:String,scope:"world"}),await(0,A.migrate)(game,M(game),(0,b.getCampingActor)(game)),Hooks.on("updateWorldTime",(async(t,n)=>{(0,r.getBooleanSetting)(i,"autoRollWeather")&&(0,a.isFirstGm)(i)&&(0,e.dayHasChanged)(i,n)&&await(0,o.rollKingmakerWeather)(i)})),Hooks.on("canvasReady",(async()=>{await(0,e.onRenderScene)(i)})),Hooks.on("preUpdateScene",(async(t,n)=>{await(0,e.onPreUpdateScene)(i,t,n)})),Hooks.on("updateScene",(async(t,n)=>{await(0,e.onUpdateScene)(i,t,n)})),Hooks.on("preUpdateCombat",((e,t)=>(0,C.checkBeginCombat)(i,e,t))),Hooks.on("deleteCombat",(e=>(0,C.stopCombat)(i,e))),Hooks.on("preUpdateActor",((e,t)=>(0,x.onPreUpdateArmy)(i,e,t))),Hooks.on("updateActor",((e,t)=>(0,x.onPostUpdateArmy)(i,e,t))),Hooks.on("createItem",(e=>(0,x.onCreateArmyItem)(i,e))),Hooks.on("preUpdateCombat",((e,t)=>(0,x.updateAmmunition)(i,e,t)));const d=async e=>{await(0,R.updateKingdomArmyConsumption)({actor:e,kingdomActor:M(i),game:i})},h=async()=>{await(0,R.updateKingdomArmyConsumption)({forceUpdate:!0,kingdomActor:M(i),game:i})};Hooks.on("createToken",(e=>d(e.actor))),Hooks.on("updateToken",(e=>d(e.actor))),Hooks.on("deleteToken",(e=>d(e.actor))),Hooks.on("updateActor",(e=>d(e))),Hooks.on("updateItem",(e=>d(e.actor))),Hooks.on("createItem",(e=>d(e.actor))),Hooks.on("deleteItem",(e=>d(e.actor))),Hooks.on("deleteScene",(()=>h())),function(e){const t=M(e);t&&!t.getFlag("pf2e-kingmaker-tools","kingdom-sheet")&&ui.notifications?.error('Found an Actor with name "Kingdom Sheet" that has not been imported using the "View Kingdom" Macro! Please delete the actor and re-import it.')}(i),function(e){const t=(0,b.getCampingActor)(e);t&&!t.getFlag("pf2e-kingmaker-tools","camping-sheet")&&ui.notifications?.error('Found an Actor with name "Camping Sheet" that has not been imported using the "Camping" Macro! Please delete the actor and re-import it.')}(i);const f=(0,v.getDiffListeners)(i);i.socket.on("module.pf2e-kingmaker-tools",(async e=>{if("openCampingSheet"===e.action)(0,g.openCampingSheet)(i);else if("openKingdomSheet"===e.action)await(0,u.showKingdom)(i);else if("addDiscoverSpecialMealResult"===e.action&&(0,a.isFirstGm)(i)){const t=e.data.recipe,n=e.data.critFailUuids,a=await(0,S.getActorByUuid)(e.data.actorUuid),{specialIngredients:s,basicIngredients:r}=e.data;if(a){const e={actor:a,specialIngredients:s,basicIngredients:r};await(0,w.addDiscoverSpecialMealResult)(i,e,t,n)}}else if("addHuntAndGatherResult"===e.action&&(0,a.isFirstGm)(i)){const t=await(0,S.getActorByUuid)(e.data.actorUuid),{specialIngredients:n,basicIngredients:a}=e.data;t&&await(0,w.addHuntAndGatherResult)(i,{actor:t,basicIngredients:a,specialIngredients:n})}else{const t=(0,b.getCampingActor)(i);if(t&&(0,a.isFirstGm)(i)){const i=(0,b.getCamping)(t);for(const t of f)t.canHandle(e.action)&&t.onReceive(i)}}})),(0,a.isFirstGm)(i)&&(0,r.getBooleanSetting)(i,"showManual")&&(await(0,r.setSetting)(i,"showManual",!1),await(0,I.openJournal)("Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.iAQCUYEAq4Dy8uCY"))}})),Hooks.on("init",(async()=>{await loadTemplates(["modules/pf2e-kingmaker-tools/templates/common/skills.partial.hbs","modules/pf2e-kingmaker-tools/templates/camping/activity.partial.hbs","modules/pf2e-kingmaker-tools/templates/camping/eating.partial.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/sidebar.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/status.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/skills.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/turn.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/groups.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/feats.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/notes.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/settlements.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/settlement.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/effects.hbs"]),game instanceof Game&&(game.modules.get("pf2e-kingmaker")?.active||game.modules.get("pf2e-kingmaker-tools")?.updateSource({flags:{"pf2e-kingmaker-tools":{"pf2e-art":"modules/pf2e-kingmaker-tools/token-map.json"}}}))})),Hooks.on("renderChatLog",(()=>{if(game instanceof Game){const e=game,t=M(e);if(t){const i=$("#chat-log");for(const n of f.kingdomChatButtons)i.on("click",n.selector,(i=>n.callback(e,t,i)))}(0,y.bindCampingChatEventListeners)(e)}})),Hooks.on("getChatLogEntryContext",((e,t)=>{if(game instanceof Game){const e=game,i=()=>void 0!==M(e),n=e=>i()&&null!==e[0].querySelector(".content-link"),a=e=>i()&&null!==e[0].querySelector(".km-roll-meta"),s=(e,t)=>{const n="upgrade"===t?"criticalSuccess":"criticalFailure",a=e.querySelector(".km-upgrade-result");return i()&&null!==a&&(0,h.parseUpgradeMeta)(e).degree!==n},r=t=>{const i=M(e);return!!i&&((0,d.getKingdom)(i).fame.now>0&&a(t))},o=t=>{const i=M(e);return!!i&&((0,d.getKingdom)(i).creativeSolutions>0&&a(t))},l=t=>{const i=M(e);return!!i&&((0,d.getKingdom)(i).supernaturalSolutions>0&&a(t))};t.push({name:"Re-Roll Using Fame/Infamy",icon:'<i class="fa-solid fa-dice-d20"></i>',condition:r,callback:t=>_(e,t[0],(e=>(0,h.reRoll)(e,t[0],"fame")))},{name:"Re-Roll Using Creative Solution",icon:'<i class="fa-solid fa-dice-d20"></i>',condition:o,callback:t=>_(e,t[0],(e=>(0,h.reRoll)(e,t[0],"creative-solution")))},{name:"Re-Roll Using Supernatural Solution",icon:'<i class="fa-solid fa-dice-d20"></i>',condition:l,callback:t=>_(e,t[0],(e=>(0,h.reRoll)(e,t[0],"supernatural-solution")))},{name:"Re-Roll",condition:a,icon:'<i class="fa-solid fa-dice-d20"></i>',callback:t=>_(e,t[0],(e=>(0,h.reRoll)(e,t[0],"re-roll")))},{name:"Re-Roll Keep Higher",condition:a,icon:'<i class="fa-solid fa-dice-d20"></i>',callback:t=>_(e,t[0],(e=>(0,h.reRoll)(e,t[0],"keep-higher")))},{name:"Re-Roll Keep Lower",condition:a,icon:'<i class="fa-solid fa-dice-d20"></i>',callback:t=>_(e,t[0],(e=>(0,h.reRoll)(e,t[0],"keep-lower")))},{name:"Upgrade Degree of Success",condition:e=>s(e[0],"upgrade"),icon:'<i class="fa-solid fa-arrow-up"></i>',callback:t=>_(e,t[0],(e=>(0,h.changeDegree)(e,t[0],"upgrade")))},{name:"Downgrade Degree of Success",condition:e=>s(e[0],"downgrade"),icon:'<i class="fa-solid fa-arrow-down"></i>',callback:t=>_(e,t[0],(e=>(0,h.changeDegree)(e,t[0],"downgrade")))},{name:"Add to Ongoing Events",icon:'<i class="fa-solid fa-plus"></i>',condition:n,callback:async t=>{_(e,t[0],(async e=>{const i=t[0].querySelector(".content-link"),n=i?.dataset?.uuid,a=i?.innerText;n&&a&&await(0,h.addOngoingEvent)(e,n,a)}))}})}}))})()})();
//# sourceMappingURL=main.js.map